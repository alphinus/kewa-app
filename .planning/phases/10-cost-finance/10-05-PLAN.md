---
phase: 10
plan: 05
name: CSV Export for Accounting
scope: medium
wave: 2
depends_on: [01, 02]
files_modified:
  - package.json
  - src/app/api/costs/export/route.ts
  - src/components/costs/ExportModal.tsx
  - src/app/dashboard/kosten/export/page.tsx
  - src/lib/costs/csv-export.ts
autonomous: true
requirements:
  - COST-06
---

# Plan 10-05: CSV Export for Accounting

## Objective

Implement configurable CSV export for invoices and expenses with Swiss formatting (CHF, DD.MM.YYYY dates, semicolon delimiter) suitable for Excel and accounting software.

## Context

Per context decisions: Excel-friendly CSV with Swiss formatting. User selects export type (invoices, expenses, or all), date range, and optionally project. VAT breakdown included where available.

Key decisions from 10-CONTEXT.md:
- Excel-friendly CSV with Swiss formatting
- Configurable: user selects invoices, expenses, date range
- VAT breakdown (Netto, MwSt, Brutto) included
- On-demand export button

<tasks>

1. Install papaparse library
   - npm install papaparse
   - npm install -D @types/papaparse
   - Add to package.json dependencies

2. Create CSV export utilities (src/lib/costs/csv-export.ts)
   - formatSwissDate(date) - DD.MM.YYYY
   - formatSwissNumber(num) - comma as decimal separator
   - translateInvoiceStatus(status) - German translations
   - translateExpenseCategory(category) - German translations
   - EXPORT_COLUMNS constant with German headers
   - generateCSV(rows, options) - using Papa Parse

3. Create export API route (src/app/api/costs/export/route.ts)
   - POST: Generate and return CSV file
   - Body: { type: 'invoices' | 'expenses' | 'all', projectId?, dateFrom?, dateTo?, status[]? }
   - Fetch invoices with partner/project relations
   - Fetch expenses with project/unit relations
   - Map to export rows with German column headers
   - CSV columns: Datum, Typ, Belegnummer, Partner, Projekt, Netto, MwSt, Brutto, Status, Bezahlt
   - Use semicolon delimiter (Swiss/German Excel default)
   - UTF-8 BOM for Excel compatibility
   - Return with Content-Disposition header for download

4. Create ExportModal component (src/components/costs/ExportModal.tsx)
   - Trigger: "Export" button on cost pages
   - Type selection: Rechnungen, Ausgaben, Alle
   - Project filter dropdown (optional)
   - Date range picker: Von - Bis
   - Status filter (for invoices): multiselect
   - Preview row count before export
   - Download button triggers API and file download
   - Loading state during generation

5. Create export page (src/app/dashboard/kosten/export/page.tsx)
   - Full-page export configuration
   - ExportModal content as main form
   - Help text explaining export format
   - Recent exports history (optional enhancement)

6. Add export button to cost pages
   - Add to /dashboard/kosten header
   - Add to /dashboard/kosten/rechnungen header
   - Add to /dashboard/kosten/ausgaben header
   - Opens ExportModal on click

</tasks>

## Verification

- [ ] POST /api/costs/export returns valid CSV file
- [ ] CSV opens correctly in Swiss Excel (semicolon delimiter, UTF-8)
- [ ] Dates formatted as DD.MM.YYYY
- [ ] Numbers use comma as decimal separator
- [ ] VAT columns (Netto, MwSt, Brutto) populated for invoices
- [ ] Status values translated to German
- [ ] File downloads with appropriate filename
- [ ] Filters (date range, project, status) work correctly

<must_haves>

- CSV export with Swiss formatting (COST-06)
- Configurable filters: type, project, date range
- German column headers
- Excel-compatible format (semicolon, UTF-8 BOM)
- VAT breakdown included

</must_haves>
