---
phase: 10
plan: 06
name: Unit Investment View and Rent Entry
scope: medium
wave: 2
depends_on: [04]
files_modified:
  - src/app/api/costs/unit/[id]/route.ts
  - src/app/api/units/[id]/rent/route.ts
  - src/components/costs/UnitInvestmentCard.tsx
  - src/components/costs/RentEditModal.tsx
  - src/components/costs/InvestmentOverview.tsx
  - src/app/dashboard/kosten/wohnungen/page.tsx
  - src/app/dashboard/kosten/wohnungen/[id]/page.tsx
  - src/lib/costs/unit-cost-queries.ts
autonomous: true
requirements:
  - RENT-01
  - RENT-02
  - RENT-03
---

# Plan 10-06: Unit Investment View and Rent Entry

## Objective

Implement unit investment dashboard showing rent vs renovation costs with amortization calculation, plus ability to enter/edit monthly rent amounts.

## Context

The unit_costs view exists (migration 021) with rent_amount, total_investment, and years_to_recover calculation. Units table already has rent_amount field (migration 009). This plan adds UI for viewing and editing.

Key decisions from 10-CONTEXT.md:
- Mietzins pro Unit speicherbar (RENT-01)
- Dashboard shows Miete vs Renovationskosten (RENT-02)
- Investment-Uebersicht pro Unit (RENT-03)

<tasks>

1. Create unit cost queries (src/lib/costs/unit-cost-queries.ts)
   - getUnitCostSummary(unitId) - from unit_costs view
   - getAllUnitCosts() - all units with costs for overview
   - calculatePaybackPeriod(investment, monthlyRent) - helper

2. Create unit cost API route (src/app/api/costs/unit/[id]/route.ts)
   - GET: Returns unit cost data from unit_costs view
   - Includes: rent_amount, total_project_costs, direct_expenses, total_investment, years_to_recover
   - Also returns list of projects with individual costs

3. Create rent update API route (src/app/api/units/[id]/rent/route.ts)
   - PATCH: Update unit rent_amount
   - Body: { rent_amount: number }
   - Validates: positive number or null
   - Creates audit log entry
   - Role check: only kewa, admin, accounting can update

4. Create RentEditModal component (src/components/costs/RentEditModal.tsx)
   - Input for monthly rent in CHF
   - Current value pre-filled
   - Save and Cancel buttons
   - Validation: positive number
   - Toast on success
   - Refreshes parent data after save

5. Create UnitInvestmentCard component (src/components/costs/UnitInvestmentCard.tsx)
   - Card displaying unit investment summary
   - Header: Unit name with edit rent button (pencil icon)
   - Sections: Mietzins (monatlich/jaehrlich), Renovationskosten, Amortisation
   - Grid layout for metrics
   - Payback years highlighted if calculated
   - Empty state if no rent entered
   - formatCHF for all amounts

6. Create InvestmentOverview component (src/components/costs/InvestmentOverview.tsx)
   - Grid of UnitInvestmentCard for all units
   - Summary row: Total invested, Average payback
   - Filter by building (optional)
   - Sort options: by name, by investment, by payback years
   - Empty state for buildings with no units

7. Create units investment list page (src/app/dashboard/kosten/wohnungen/page.tsx)
   - Server component fetching all unit costs
   - InvestmentOverview component
   - Link to individual unit views
   - Building filter dropdown

8. Create unit investment detail page (src/app/dashboard/kosten/wohnungen/[id]/page.tsx)
   - Server component for single unit
   - UnitInvestmentCard (full size)
   - List of renovation projects for this unit
   - List of direct expenses for this unit
   - RentEditModal integration
   - Breadcrumb navigation

</tasks>

## Verification

- [ ] Unit cost API returns accurate data from view
- [ ] Rent can be entered and updated via modal
- [ ] Amortization (years_to_recover) calculates correctly
- [ ] Investment overview shows all units
- [ ] Rent vs renovation comparison visible
- [ ] Edit rent button opens modal
- [ ] Audit log created on rent update
- [ ] All amounts formatted in CHF

<must_haves>

- Rent entry per unit (RENT-01)
- Dashboard: Miete vs Renovationskosten comparison (RENT-02)
- Investment overview per unit with amortization (RENT-03)
- German labels throughout
- Swiss currency formatting

</must_haves>
