---
phase: 10
plan: 01
name: Invoice Approval Workflow
scope: medium
wave: 1
depends_on: []
files_modified:
  - src/app/api/invoices/route.ts
  - src/app/api/invoices/[id]/route.ts
  - src/app/api/invoices/[id]/approve/route.ts
  - src/app/api/invoices/[id]/dispute/route.ts
  - src/components/costs/InvoiceList.tsx
  - src/components/costs/InvoiceDetail.tsx
  - src/components/costs/InvoiceApprovalActions.tsx
  - src/app/dashboard/kosten/rechnungen/page.tsx
  - src/app/dashboard/kosten/rechnungen/[id]/page.tsx
  - src/lib/costs/invoice-queries.ts
autonomous: true
requirements:
  - COST-01
  - COST-04
  - COST-05
---

# Plan 10-01: Invoice Approval Workflow

## Objective

Implement the complete invoice approval workflow from received through approved status, with side-by-side offer/invoice comparison and PDF document viewing.

## Context

The invoices table already exists (migration 018) with full status workflow: received -> under_review -> approved -> disputed -> paid. The database triggers handle amount calculations automatically. This plan adds the API routes and UI for KEWA staff to review and approve invoices.

Key decisions from 10-CONTEXT.md:
- Single approval step (Admin/Manager approves -> ready for payment)
- Offer amount and Invoice amount shown side-by-side
- Contractor submits their own invoice (PDF upload via portal)

<tasks>

1. Create invoice queries library (src/lib/costs/invoice-queries.ts)
   - getInvoiceWithRelations(id) - fetches invoice with partner, offer, work_order, project
   - getInvoicesByStatus(status) - list by status with pagination
   - getInvoicesByProject(projectId) - all invoices for a project
   - Include variance calculation (invoice - offer)

2. Create invoices CRUD API routes (src/app/api/invoices/route.ts)
   - GET: List invoices with filters (status, project, partner, date range)
   - POST: Create invoice (for contractor portal usage)
   - Supports pagination with offset/limit
   - Returns invoice with relations

3. Create single invoice API route (src/app/api/invoices/[id]/route.ts)
   - GET: Single invoice with all relations
   - PATCH: Update invoice fields (internal_notes, status for under_review)
   - DELETE: Only draft/received invoices can be deleted

4. Create invoice approve API route (src/app/api/invoices/[id]/approve/route.ts)
   - POST: Sets status to 'approved', approved_at = now, approved_by = user
   - Validates: must be in 'under_review' status
   - Role check: only kewa, admin, manager can approve
   - Creates audit log entry

5. Create invoice dispute API route (src/app/api/invoices/[id]/dispute/route.ts)
   - POST: Sets status to 'disputed' with dispute notes
   - Body: { dispute_reason: string }
   - Validates: must be in 'under_review' status
   - Creates audit log entry

6. Create InvoiceList component (src/components/costs/InvoiceList.tsx)
   - Table view with columns: Datum, Nr., Partner, Projekt, Betrag, Status
   - Status badge with color coding
   - Filters: status dropdown, project select, date range
   - Click row to navigate to detail
   - Empty state for no invoices

7. Create InvoiceDetail component (src/components/costs/InvoiceDetail.tsx)
   - Header: invoice number, partner, date
   - Side-by-side comparison: Offerte vs Rechnung amounts
   - Document viewer: embedded PDF or download link
   - Internal notes textarea (editable)
   - Status timeline showing workflow progression
   - Actions section (InvoiceApprovalActions)

8. Create InvoiceApprovalActions component (src/components/costs/InvoiceApprovalActions.tsx)
   - Shown when status is 'under_review'
   - "Freigeben" button (approve)
   - "Beanstanden" button opens modal for dispute reason
   - Confirmation dialog before action
   - Loading states during API calls

9. Create invoices list page (src/app/dashboard/kosten/rechnungen/page.tsx)
   - Server component fetching invoices
   - InvoiceList with filters
   - Stats cards: Offen, In Pruefung, Freigegeben, Beanstandet

10. Create invoice detail page (src/app/dashboard/kosten/rechnungen/[id]/page.tsx)
    - Server component fetching single invoice
    - InvoiceDetail component
    - Breadcrumb navigation back to list

</tasks>

## Verification

- [ ] GET /api/invoices returns filtered list with pagination
- [ ] GET /api/invoices/[id] returns invoice with offer comparison data
- [ ] POST /api/invoices/[id]/approve changes status to 'approved'
- [ ] POST /api/invoices/[id]/dispute changes status to 'disputed'
- [ ] Invoice list shows status badges correctly
- [ ] Invoice detail shows offer vs invoice amounts side-by-side
- [ ] PDF document is viewable/downloadable
- [ ] Only authorized roles can approve/dispute

<must_haves>

- Invoice status workflow: received -> under_review -> approved (COST-01)
- Variance display: offer vs invoice side-by-side (COST-04)
- Document attachment viewing (COST-05)
- Audit logging for status changes
- German labels throughout UI

</must_haves>
