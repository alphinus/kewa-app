---
phase: 10
plan: 02
name: Manual Expense Entry with Receipt Upload
scope: medium
wave: 1
depends_on: []
files_modified:
  - src/app/api/expenses/route.ts
  - src/app/api/expenses/[id]/route.ts
  - src/components/costs/ExpenseForm.tsx
  - src/components/costs/ExpenseList.tsx
  - src/components/costs/ExpenseDetail.tsx
  - src/app/dashboard/kosten/ausgaben/page.tsx
  - src/app/dashboard/kosten/ausgaben/neu/page.tsx
  - src/app/dashboard/kosten/ausgaben/[id]/page.tsx
  - src/lib/costs/expense-queries.ts
  - src/lib/costs/expense-constants.ts
autonomous: true
requirements:
  - COST-02
  - COST-05
---

# Plan 10-02: Manual Expense Entry with Receipt Upload

## Objective

Implement manual expense entry for cash payments and other out-of-pocket costs with required receipt upload, supporting links to projects or units.

## Context

The expenses table exists (migration 019) with categories, payment methods, and entity linking validation (must link to at least one of: project, work_order, unit, room). Receipt upload uses existing storage infrastructure.

Key decisions from 10-CONTEXT.md:
- Can link to Project OR directly to Unit (for non-project costs)
- Receipt upload required for each expense
- All internal roles can create expenses (Admin, Manager, Accounting)

<tasks>

1. Create expense constants (src/lib/costs/expense-constants.ts)
   - EXPENSE_CATEGORIES with German labels
   - EXPENSE_PAYMENT_METHODS with German labels
   - formatExpenseCategory helper
   - formatPaymentMethod helper

2. Create expense queries library (src/lib/costs/expense-queries.ts)
   - getExpenseWithRelations(id) - includes project, unit, room
   - getExpensesByProject(projectId) - all expenses for project
   - getExpensesByUnit(unitId) - all expenses for unit
   - getRecentExpenses(limit) - recent expenses for dashboard

3. Create expenses CRUD API route (src/app/api/expenses/route.ts)
   - GET: List expenses with filters (project, unit, category, date range)
   - POST: Create expense with validation
   - Validates: at least one entity link (project/unit/room/work_order)
   - Validates: receipt_storage_path required
   - Sets paid_at to now if not provided
   - Sets created_by and paid_by from session

4. Create single expense API route (src/app/api/expenses/[id]/route.ts)
   - GET: Single expense with relations
   - PATCH: Update expense fields
   - DELETE: Delete expense (soft delete or check for constraints)

5. Create ExpenseForm component (src/components/costs/ExpenseForm.tsx)
   - Title input (required)
   - Amount input with CHF formatting
   - Category select from EXPENSE_CATEGORIES
   - Payment method select from EXPENSE_PAYMENT_METHODS
   - Entity selection: Project OR Unit dropdown (mutually exclusive UI)
   - Vendor name input (optional)
   - Receipt upload using FileUploader component (required)
   - Receipt number input (optional)
   - Notes textarea
   - Submit creates expense then uploads receipt

6. Create ExpenseList component (src/components/costs/ExpenseList.tsx)
   - Table: Datum, Bezeichnung, Kategorie, Betrag, Projekt/Einheit
   - Category badge with color coding
   - Filters: category, project, date range
   - Click row to navigate to detail
   - Total at bottom of list

7. Create ExpenseDetail component (src/components/costs/ExpenseDetail.tsx)
   - Full expense information display
   - Receipt image/PDF viewer
   - Edit button (opens form in edit mode)
   - Delete button with confirmation

8. Create expenses list page (src/app/dashboard/kosten/ausgaben/page.tsx)
   - Server component with ExpenseList
   - "Ausgabe erfassen" button linking to /neu
   - Summary stats: Total, by category breakdown

9. Create new expense page (src/app/dashboard/kosten/ausgaben/neu/page.tsx)
   - ExpenseForm component
   - Optional: pre-select project/unit from query params
   - Redirect to list after success

10. Create expense detail page (src/app/dashboard/kosten/ausgaben/[id]/page.tsx)
    - ExpenseDetail component
    - Breadcrumb navigation

</tasks>

## Verification

- [ ] POST /api/expenses creates expense with all required fields
- [ ] Receipt upload is required (form validation)
- [ ] Entity linking validation works (error if no project/unit)
- [ ] Expense list shows all expenses with filters
- [ ] Receipt viewer displays uploaded image/PDF
- [ ] Categories display in German
- [ ] Expense can be edited and deleted

<must_haves>

- Manual expense creation with all categories (COST-02)
- Required receipt upload for each expense (COST-02)
- Link to Project OR Unit (COST-02)
- Receipt document viewing (COST-05)
- German UI labels

</must_haves>
