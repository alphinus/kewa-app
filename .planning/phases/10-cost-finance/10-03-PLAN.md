---
phase: 10
plan: 03
name: Payment Recording (Mark as Paid)
scope: small
wave: 1
depends_on: []
files_modified:
  - src/app/api/payments/route.ts
  - src/app/api/payments/[id]/route.ts
  - src/components/costs/PaymentModal.tsx
  - src/components/costs/PaymentHistory.tsx
  - src/lib/costs/payment-helpers.ts
autonomous: true
requirements:
  - COST-01
---

# Plan 10-03: Payment Recording (Mark as Paid)

## Objective

Implement the "Mark as Paid" functionality for approved invoices, creating payment records that trigger automatic invoice status updates.

## Context

The payments table exists (migration 020) with a trigger that automatically updates invoice.amount_paid and status when payments are inserted. Per context decisions: simple "Mark as Paid" with today's date, no bank sync, full payment (no partials for MVP).

Key decisions from 10-CONTEXT.md:
- "Mark as Paid" button with today's date
- Simple, no bank sync
- Full payment amount (no partial payments for MVP)

<tasks>

1. Create payment helpers (src/lib/costs/payment-helpers.ts)
   - formatPaymentMethod(method) - German labels
   - formatPaymentStatus(status) - German labels
   - getDefaultPaymentDate() - today's date in ISO format
   - validatePaymentAmount(amount, outstanding) - check not overpaying

2. Create payments API route (src/app/api/payments/route.ts)
   - GET: List payments with filters (invoice_id, date range)
   - POST: Create payment
   - Validates: invoice exists and is 'approved'
   - Validates: amount not exceeding outstanding
   - Defaults: payment_date = today, payment_method = 'bank_transfer', status = 'completed'
   - Trigger handles invoice status update automatically

3. Create single payment API route (src/app/api/payments/[id]/route.ts)
   - GET: Single payment with invoice relation
   - DELETE: Only pending/failed payments can be deleted
   - No PATCH - payments are immutable once completed

4. Create PaymentModal component (src/components/costs/PaymentModal.tsx)
   - Trigger: "Als bezahlt markieren" button on approved invoices
   - Shows invoice summary (number, partner, total)
   - Pre-filled: amount = outstanding, date = today
   - Payment method select (default: Bankueberweisung)
   - Optional notes field
   - Confirm button creates payment
   - Success: close modal, refresh invoice data
   - Toast notification on success

5. Create PaymentHistory component (src/components/costs/PaymentHistory.tsx)
   - Shows on invoice detail for paid/partially_paid invoices
   - Table: Datum, Betrag, Methode, Referenz
   - Total paid vs outstanding display
   - For MVP: single payment per invoice expected

6. Integrate PaymentModal into InvoiceDetail
   - Import and render PaymentModal
   - Show button only when status = 'approved'
   - After payment, status changes to 'paid' (via trigger)
   - Disable button when already fully paid

</tasks>

## Verification

- [ ] POST /api/payments creates payment record
- [ ] Invoice.amount_paid updates automatically (trigger)
- [ ] Invoice.status changes to 'paid' when fully paid (trigger)
- [ ] Invoice.paid_at timestamp is set
- [ ] PaymentModal shows correct defaults
- [ ] PaymentHistory displays after payment recorded
- [ ] Cannot pay more than outstanding amount
- [ ] Cannot pay non-approved invoices

<must_haves>

- Payment recording completes workflow (COST-01)
- Automatic invoice status update to 'paid'
- Today's date as default payment date
- Bank transfer as default method
- Audit trail via payment record

</must_haves>
