---
phase: 10
plan: 04
name: Project Cost Dashboard
scope: medium
wave: 2
depends_on: [01, 02, 03]
files_modified:
  - src/app/api/costs/project/[id]/route.ts
  - src/components/costs/ProjectCostDashboard.tsx
  - src/components/costs/WorkOrderCostRow.tsx
  - src/components/costs/ProjectCostSummary.tsx
  - src/app/dashboard/kosten/page.tsx
  - src/app/dashboard/kosten/projekte/[id]/page.tsx
  - src/lib/costs/project-cost-queries.ts
  - src/lib/costs/formatters.ts
autonomous: true
requirements:
  - COST-01
  - COST-03
  - COST-04
---

# Plan 10-04: Project Cost Dashboard

## Objective

Implement the project cost dashboard showing all costs for a renovation at a glance, with work orders as line items displaying offer vs invoice amounts side-by-side.

## Context

The project_costs view already exists (migration 021) with aggregated totals. This plan builds the UI layer consuming that view plus detailed work order breakdown.

Key decisions from 10-CONTEXT.md:
- Primary view: By Project - see all costs at a glance
- Breakdown by work order (each contractor's work as line item)
- Each work order shows: Offer amount, Invoice amount side-by-side
- No highlighted variance, just side-by-side display

<tasks>

1. Create cost formatters (src/lib/costs/formatters.ts)
   - formatCHF(amount) - Swiss currency format with CHF prefix
   - formatVariance(variance) - positive/negative with sign
   - formatSwissDate(date) - DD.MM.YYYY format
   - formatSwissNumber(num) - comma as decimal separator

2. Create project cost queries (src/lib/costs/project-cost-queries.ts)
   - getProjectCostSummary(projectId) - from project_costs view
   - getProjectWorkOrdersWithCosts(projectId) - work orders with offers/invoices
   - getProjectExpenses(projectId) - expenses linked to project

3. Create project cost API route (src/app/api/costs/project/[id]/route.ts)
   - GET: Returns aggregated cost data for project
   - Includes: summary from view, work orders with costs, expenses
   - Joined data for single request efficiency

4. Create WorkOrderCostRow component (src/components/costs/WorkOrderCostRow.tsx)
   - Displays single work order as table row
   - Columns: Auftrag, Raum, Offerte, Rechnung, Status
   - Room name shown in gray text
   - Offer amount from accepted offer
   - Invoice amount from linked invoice
   - Status badge (invoice status or work order status)
   - Click navigates to work order detail

5. Create ProjectCostSummary component (src/components/costs/ProjectCostSummary.tsx)
   - Summary cards grid: Budget, Offerten, Rechnungen, Bezahlt
   - Uses formatCHF for all amounts
   - Budget from project.estimated_cost
   - Shows variance from budget if applicable
   - Total expenses separate card

6. Create ProjectCostDashboard component (src/components/costs/ProjectCostDashboard.tsx)
   - Combines summary and detail views
   - ProjectCostSummary at top
   - "Arbeitsauftraege" section with WorkOrderCostRow table
   - "Ausgaben" section with expense list
   - Total row at bottom of each section
   - Empty states for no data

7. Create cost overview page (src/app/dashboard/kosten/page.tsx)
   - List of all projects with cost summary cards
   - Quick stats: Total invoiced, total paid, total outstanding
   - Links to individual project cost views
   - Link to invoices and expenses lists

8. Create project cost detail page (src/app/dashboard/kosten/projekte/[id]/page.tsx)
   - Server component fetching project costs
   - ProjectCostDashboard component
   - Breadcrumb navigation
   - Link to project detail page

</tasks>

## Verification

- [ ] Project cost API returns aggregated data correctly
- [ ] Summary cards show accurate totals
- [ ] Work orders displayed as line items
- [ ] Offer and invoice amounts shown side-by-side
- [ ] Expenses listed separately with totals
- [ ] All amounts formatted in CHF
- [ ] Navigation to related entities works

<must_haves>

- Complete workflow visibility: Offer -> Invoice -> Payment (COST-01)
- Aggregation by Project with work order breakdown (COST-03)
- Variance display: offer vs invoice (COST-04)
- German labels and Swiss formatting

</must_haves>
