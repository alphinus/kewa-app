---
phase: 27-pwa-foundation
plan: 03
type: execute
wave: 2
depends_on: ["27-02"]
files_modified:
  - src/contexts/ConnectivityContext.tsx
  - src/components/navigation/header.tsx
  - src/app/dashboard/layout.tsx
autonomous: true

must_haves:
  truths:
    - "Header displays a visual indicator showing current online/offline connectivity state"
    - "Toast notification fires when going offline ('Verbindung verloren') and coming back online ('Wieder verbunden')"
    - "Offline indicator only visible when offline; no indicator clutter when connected"
  artifacts:
    - path: "src/contexts/ConnectivityContext.tsx"
      provides: "React context providing isOnline boolean, with online/offline event listeners and toast notifications"
      exports: ["ConnectivityProvider", "useConnectivity"]
    - path: "src/components/navigation/header.tsx"
      provides: "Header with offline indicator badge"
      contains: "Offline"
    - path: "src/app/dashboard/layout.tsx"
      provides: "Dashboard layout wrapping children with ConnectivityProvider"
      contains: "ConnectivityProvider"
  key_links:
    - from: "src/contexts/ConnectivityContext.tsx"
      to: "navigator.onLine"
      via: "online/offline window events"
      pattern: "navigator\\.onLine"
    - from: "src/contexts/ConnectivityContext.tsx"
      to: "sonner"
      via: "toast.warning and toast.success calls"
      pattern: "toast\\.(warning|success)"
    - from: "src/components/navigation/header.tsx"
      to: "src/contexts/ConnectivityContext.tsx"
      via: "useConnectivity hook"
      pattern: "useConnectivity"
    - from: "src/app/dashboard/layout.tsx"
      to: "src/contexts/ConnectivityContext.tsx"
      via: "ConnectivityProvider wrapper"
      pattern: "ConnectivityProvider"
---

<objective>
Create a connectivity context that tracks online/offline status, fires toast notifications on state changes, and displays an offline indicator badge in the operator header.

Purpose: Users see clear visual feedback about their connectivity state. Going offline shows a warning toast and header badge; coming back online shows a success toast and badge disappears.
Output: ConnectivityContext, updated Header with offline badge, updated dashboard layout with provider
</objective>

<execution_context>
@C:\Users\Mario Giacchino\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\Mario Giacchino\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/27-pwa-foundation/27-CONTEXT.md
@.planning/phases/27-pwa-foundation/27-RESEARCH.md
@src/components/navigation/header.tsx
@src/app/dashboard/layout.tsx
@src/contexts/PushContext.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Connectivity context with toast notifications</name>
  <files>src/contexts/ConnectivityContext.tsx</files>
  <action>
Create `src/contexts/ConnectivityContext.tsx` following the same pattern as PushContext.tsx:

```typescript
'use client'

/**
 * Connectivity Context
 *
 * Tracks online/offline status using navigator.onLine and window events.
 * Shows Sonner toasts on connectivity state changes.
 * Phase: 27-pwa-foundation
 */

import React, { createContext, useContext, useState, useEffect, useRef } from 'react'
import { toast } from 'sonner'
```

**Context value interface:**
```typescript
interface ConnectivityContextValue {
  isOnline: boolean
}
```

**ConnectivityProvider component:**
1. Initialize `isOnline` state from `typeof navigator !== 'undefined' ? navigator.onLine : true` (SSR-safe default to true).
2. Use a `useRef` for `isInitialMount` to prevent toasts on first render.
3. Add `useEffect` that:
   - Sets `isInitialMount.current = false` (skip toasts on initial mount)
   - Adds `online` and `offline` event listeners on `window`
   - `handleOnline`: sets `isOnline(true)`, if not initial mount: `toast.success('Wieder verbunden', { duration: 4000 })`
   - `handleOffline`: sets `isOnline(false)`, if not initial mount: `toast.warning('Verbindung verloren', { duration: 4000 })`
   - Cleanup: removes both listeners
4. After a short delay (100ms in a second useEffect), set `isInitialMount.current = false`. This ensures no toast fires for the initial browser state, only for transitions.

**useConnectivity hook:**
```typescript
export function useConnectivity() {
  const context = useContext(ConnectivityContext)
  if (context === undefined) {
    throw new Error('useConnectivity must be used within a ConnectivityProvider')
  }
  return context
}
```

Exports: `ConnectivityProvider`, `useConnectivity`
  </action>
  <verify>
    - File exists at `src/contexts/ConnectivityContext.tsx`
    - Exports ConnectivityProvider and useConnectivity
    - Contains navigator.onLine check
    - Contains 'Verbindung verloren' and 'Wieder verbunden' toast messages
    - `npx next build` succeeds
  </verify>
  <done>
    - ConnectivityContext tracks isOnline boolean
    - Toast fires on going offline (warning) and coming back online (success)
    - No toast on initial page load (only on transitions)
    - SSR-safe (defaults to true when navigator undefined)
  </done>
</task>

<task type="auto">
  <name>Task 2: Header offline badge and layout provider integration</name>
  <files>
    src/components/navigation/header.tsx
    src/app/dashboard/layout.tsx
  </files>
  <action>
1. Update `src/components/navigation/header.tsx`:
   - Import `useConnectivity` from `@/contexts/ConnectivityContext`
   - Import `WifiOff` from `lucide-react` (already using lucide-react for LogOut icon)
   - Call `const { isOnline } = useConnectivity()` at the top of the Header component
   - Add offline indicator between the spacer div and the user info div. Only render when `!isOnline`:
     ```tsx
     {/* Offline indicator */}
     {!isOnline && (
       <div className="flex items-center gap-1.5 px-2.5 py-1 bg-amber-100 dark:bg-amber-900/30 text-amber-700 dark:text-amber-400 rounded-full text-xs font-medium">
         <WifiOff className="h-3.5 w-3.5" />
         <span>Offline</span>
       </div>
     )}
     ```
   - Place this BEFORE the `{/* User role, notifications, and logout */}` div, AFTER the `{/* Spacer */}` div.
   - The indicator uses amber/warning colors with a pill shape, matching the app's design language.

2. Update `src/app/dashboard/layout.tsx`:
   - Import `ConnectivityProvider` from `@/contexts/ConnectivityContext`
   - Wrap the DashboardLayoutInner return content with `<ConnectivityProvider>`:
     ```tsx
     return (
       <BuildingProvider>
         <ConnectivityProvider>
           <DashboardLayoutInner user={session.user}>
             {children}
           </DashboardLayoutInner>
         </ConnectivityProvider>
       </BuildingProvider>
     )
     ```
   - The ConnectivityProvider must be INSIDE DashboardLayout (after session loads) so it only activates for authenticated operator users, not on login pages.
   - Place it inside BuildingProvider (order with BuildingProvider doesn't matter, but nesting inside keeps the provider tree clean).

Note: The portal layout (`src/app/portal/layout.tsx`) does NOT get ConnectivityProvider. Per CONTEXT.md, offline features are operator-app only. Tenant portal users are home Wi-Fi users.
  </action>
  <verify>
    - `grep "useConnectivity" src/components/navigation/header.tsx` finds the import
    - `grep "WifiOff" src/components/navigation/header.tsx` finds the icon import
    - `grep "Offline" src/components/navigation/header.tsx` finds the badge text
    - `grep "ConnectivityProvider" src/app/dashboard/layout.tsx` finds the provider
    - `npx next build` succeeds
  </verify>
  <done>
    - Header shows amber "Offline" pill badge with WifiOff icon when offline
    - Badge disappears when connectivity returns
    - ConnectivityProvider wraps dashboard layout (operator app only)
    - Portal layout unchanged (no offline features for tenants)
  </done>
</task>

</tasks>

<verification>
1. `npx next build` succeeds
2. ConnectivityContext exports ConnectivityProvider and useConnectivity
3. Header shows offline badge only when !isOnline
4. Dashboard layout wraps with ConnectivityProvider
5. Toast messages fire on connectivity transitions (not on initial load)
6. Portal layout NOT modified
</verification>

<success_criteria>
- Header displays amber "Offline" badge with WifiOff icon when navigator.onLine is false
- Badge disappears immediately when connection returns
- Warning toast "Verbindung verloren" fires when going offline
- Success toast "Wieder verbunden" fires when coming back online
- No toast fires on initial page load
- Connectivity detection is operator-app only (dashboard layout), not in portal
</success_criteria>

<output>
After completion, create `.planning/phases/27-pwa-foundation/27-03-SUMMARY.md`
</output>
