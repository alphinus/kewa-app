---
phase: 27-pwa-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/app/manifest.ts
  - public/icons/icon-192.png
  - public/icons/icon-512.png
  - public/icons/icon-192-maskable.png
  - public/icons/icon-512-maskable.png
  - src/hooks/useInstallPrompt.ts
  - src/app/dashboard/settings/page.tsx
autonomous: true

must_haves:
  truths:
    - "App can be installed to home screen via manifest and launches in standalone display mode"
    - "App shows install prompt via Sonner toast after login"
    - "Settings page has manual 'App installieren' button when browser supports install"
  artifacts:
    - path: "src/app/manifest.ts"
      provides: "Dynamic PWA manifest with name, icons, standalone display"
      exports: ["default"]
    - path: "public/icons/icon-192.png"
      provides: "192x192 app icon"
    - path: "public/icons/icon-512.png"
      provides: "512x512 app icon"
    - path: "public/icons/icon-192-maskable.png"
      provides: "192x192 maskable app icon"
    - path: "public/icons/icon-512-maskable.png"
      provides: "512x512 maskable app icon"
    - path: "src/hooks/useInstallPrompt.ts"
      provides: "Install prompt hook managing beforeinstallprompt event and dismissal tracking"
      exports: ["useInstallPrompt"]
    - path: "src/app/dashboard/settings/page.tsx"
      provides: "Settings page with App installieren button"
      contains: "App installieren"
  key_links:
    - from: "src/app/manifest.ts"
      to: "Next.js metadata API"
      via: "default export MetadataRoute.Manifest"
      pattern: "MetadataRoute\\.Manifest"
    - from: "src/hooks/useInstallPrompt.ts"
      to: "beforeinstallprompt event"
      via: "window event listener"
      pattern: "beforeinstallprompt"
    - from: "src/app/dashboard/settings/page.tsx"
      to: "src/hooks/useInstallPrompt.ts"
      via: "useInstallPrompt hook"
      pattern: "useInstallPrompt"
---

<objective>
Create the PWA manifest with icons, implement the install prompt experience via Sonner toast, and add a manual install button to the settings page.

Purpose: Makes the app installable as a standalone PWA on supported devices. Users see an install toast after login and can always install from settings.
Output: manifest.ts, 4 icon files, useInstallPrompt hook, updated settings page
</objective>

<execution_context>
@C:\Users\Mario Giacchino\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\Mario Giacchino\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/27-pwa-foundation/27-CONTEXT.md
@.planning/phases/27-pwa-foundation/27-RESEARCH.md
@src/app/layout.tsx
@src/app/dashboard/settings/page.tsx
@src/hooks/useInstallPrompt.ts
@next.config.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: PWA manifest and icons</name>
  <files>
    src/app/manifest.ts
    public/icons/icon-192.png
    public/icons/icon-512.png
    public/icons/icon-192-maskable.png
    public/icons/icon-512-maskable.png
    next.config.ts
  </files>
  <action>
1. Create `public/icons/` directory.

2. Generate 4 PNG icon files programmatically. Use a Node.js script (run via `node -e "..."` or a temp script) that creates simple branded icons:
   - Use the `canvas` npm package if available, otherwise create minimal valid PNG files with a solid brand color (#0f172a slate-900) background and white "K" letter centered.
   - Sizes: 192x192, 512x512 for both standard and maskable variants.
   - For maskable variants: keep content within the inner 80% safe zone (the "K" should be slightly smaller/more centered).
   - If canvas is not available, use an alternative approach: download placeholder icons from a public source OR create the icons using `sharp` if installed OR create minimal PNG buffers manually. The icons must be valid PNG files.
   - Name them: icon-192.png, icon-512.png, icon-192-maskable.png, icon-512-maskable.png

3. Create `src/app/manifest.ts` using Next.js 16 metadata API:
   ```typescript
   import type { MetadataRoute } from 'next'

   export default function manifest(): MetadataRoute.Manifest {
     return {
       name: 'KEWA',
       short_name: 'KEWA',
       description: 'KEWA AG Immobilienverwaltung',
       start_url: '/dashboard',
       display: 'standalone',
       background_color: '#ffffff',
       theme_color: '#0f172a',
       orientation: 'portrait-primary',
       icons: [
         {
           src: '/icons/icon-192.png',
           sizes: '192x192',
           type: 'image/png',
           purpose: 'any',
         },
         {
           src: '/icons/icon-512.png',
           sizes: '512x512',
           type: 'image/png',
           purpose: 'any',
         },
         {
           src: '/icons/icon-192-maskable.png',
           sizes: '192x192',
           type: 'image/png',
           purpose: 'maskable',
         },
         {
           src: '/icons/icon-512-maskable.png',
           sizes: '512x512',
           type: 'image/png',
           purpose: 'maskable',
         },
       ],
     }
   }
   ```
   Note: Do NOT set purpose to "any maskable" on a single icon. Use separate icon entries with separate purpose values. This is a documented anti-pattern.

4. Update `next.config.ts` headers to also set Cache-Control for `sw-cache.js` (needed by Plan 02). Add a second entry:
   ```typescript
   {
     source: '/sw-cache.js',
     headers: [
       {
         key: 'Cache-Control',
         value: 'no-cache, no-store, must-revalidate',
       },
     ],
   },
   ```
  </action>
  <verify>
    - `ls public/icons/` shows 4 PNG files
    - `npx next build` succeeds (manifest.ts compiles)
    - Visit `/manifest.webmanifest` in browser returns valid JSON with icons array
  </verify>
  <done>
    - manifest.ts exports valid PWA manifest with 4 icons, standalone display, correct theme color
    - 4 icon PNG files exist in public/icons/ at correct sizes
    - next.config.ts has cache headers for both sw.js and sw-cache.js
  </done>
</task>

<task type="auto">
  <name>Task 2: Install prompt hook and settings button</name>
  <files>
    src/hooks/useInstallPrompt.ts
    src/app/dashboard/settings/page.tsx
  </files>
  <action>
1. Create `src/hooks/useInstallPrompt.ts`:
   - Captures the `beforeinstallprompt` event on window and stores it in a ref.
   - Exposes `canInstall` boolean (true when event captured and not yet installed).
   - Exposes `promptInstall()` async function that calls `deferredPrompt.prompt()` and returns the user's choice.
   - Exposes `showInstallToast()` function that shows a Sonner toast with an "Installieren" action button. Toast text: "KEWA als App installieren" with description "Fuer schnelleren Zugriff auf dem Startbildschirm hinzufuegen". On action button click, call `promptInstall()`.
   - Tracks dismissal in localStorage under key `kewa_install_dismissed`. When dismissed, stores the current session identifier (use `Date.now()` rounded to the day as session ID, so re-prompt happens on next day/session).
   - `shouldShowToast` computed: `canInstall && (no dismissal in localStorage for current session)`.
   - Listens for `appinstalled` event to clear state (set canInstall=false).
   - Import `toast` from 'sonner' for the toast.
   - Hook signature: `export function useInstallPrompt(): { canInstall: boolean; promptInstall: () => Promise<void>; showInstallToast: () => void }`
   - The hook does NOT auto-show the toast. It provides `shouldShowToast` and `showInstallToast` for the consumer to call.

2. Update `src/app/dashboard/settings/page.tsx`:
   - Import `useInstallPrompt` from `@/hooks/useInstallPrompt`.
   - After the "App-Informationen" card, add an "App Installation" card (before the Logout button):
     ```tsx
     {canInstall && (
       <div className="bg-white dark:bg-gray-900 rounded-xl border border-gray-200 dark:border-gray-800 p-4">
         <h2 className="text-lg font-semibold text-gray-900 dark:text-gray-100 mb-4 flex items-center gap-2">
           <DownloadIcon className="w-5 h-5" />
           App Installation
         </h2>
         <p className="text-sm text-gray-600 dark:text-gray-400 mb-4">
           Installieren Sie KEWA als App fuer schnelleren Zugriff.
         </p>
         <Button variant="primary" onClick={promptInstall}>
           App installieren
         </Button>
       </div>
     )}
     ```
   - Add a DownloadIcon SVG component (download/arrow-down icon, same pattern as existing icons in the file).
   - The card only renders when `canInstall` is true (browser supports install and app not yet installed).

3. The install toast trigger: The toast should be shown after login. The dashboard layout already renders after authentication. Add a `useEffect` in the dashboard layout (`src/app/dashboard/layout.tsx`) that calls `showInstallToast()` when `shouldShowToast` is true. BUT -- do NOT modify the layout in this plan. Instead, expose `shouldShowToast` from the hook, and Plan 03 will integrate the toast trigger into the connectivity provider which wraps the dashboard. For now, the hook is self-contained and the settings button works independently.

   Actually, to keep this plan self-contained: Add the auto-toast logic directly inside `useInstallPrompt`. Add a `useEffect` inside the hook that, after a 2-second delay (to let the page settle after login), calls `showInstallToast()` if `shouldShowToast` is true. This way any component using the hook gets the toast behavior. The settings page import of the hook triggers the toast on that page visit.

   Better approach for simplicity: Create a small `InstallPromptProvider` component that simply calls `useInstallPrompt()` and renders nothing. Add it to `src/app/dashboard/layout.tsx` inside the BuildingProvider. This fires the auto-toast on dashboard mount.

   Final approach (simplest): Make the hook self-triggering. Inside the hook, add a `useEffect` that calls `showInstallToast()` after 2 seconds when `shouldShowToast` is true. This means any page importing the hook will trigger it. The settings page already imports it for the button, and separately we need it in the dashboard. Just add a one-liner `useInstallPrompt()` call in the DashboardLayoutInner component. Modify `src/app/dashboard/layout.tsx`:
   - Import `useInstallPrompt` from `@/hooks/useInstallPrompt`
   - Call `useInstallPrompt()` at the top of `DashboardLayoutInner` (it's already a 'use client' component). The hook self-triggers the toast.
  </action>
  <verify>
    - `npx next build` succeeds
    - `grep -r "useInstallPrompt" src/` shows hook in hooks file, dashboard layout, and settings page
    - `grep -r "beforeinstallprompt" src/` shows event listener in hook
    - `grep "App installieren" src/app/dashboard/settings/page.tsx` shows install button
  </verify>
  <done>
    - useInstallPrompt hook captures beforeinstallprompt, tracks dismissal, shows Sonner toast
    - Settings page shows "App installieren" button when browser supports install
    - Dashboard layout imports hook to trigger auto-toast after login
    - Toast shows "KEWA als App installieren" with action button
  </done>
</task>

</tasks>

<verification>
1. `npx next build` completes without errors
2. manifest.ts generates valid manifest at /manifest.webmanifest
3. 4 icon files exist in public/icons/
4. useInstallPrompt hook handles beforeinstallprompt event lifecycle
5. Settings page conditionally shows install button
6. Dashboard layout triggers install toast via hook
</verification>

<success_criteria>
- PWA manifest serves at /manifest.webmanifest with name "KEWA", display "standalone", theme_color "#0f172a", and 4 icon references
- 4 PNG icon files exist at public/icons/ (192 + 512 in standard and maskable variants)
- Install prompt appears as Sonner toast after dashboard loads (on supported browsers)
- Settings page shows "App installieren" button when beforeinstallprompt event is available
- Dismissing the toast prevents re-show until next session
</success_criteria>

<output>
After completion, create `.planning/phases/27-pwa-foundation/27-01-SUMMARY.md`
</output>
