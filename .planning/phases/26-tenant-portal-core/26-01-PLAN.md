---
phase: 26-tenant-portal-core
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/062_tenant_portal.sql
  - src/types/portal.ts
  - src/types/index.ts
  - src/types/database.ts
  - src/lib/portal/tenant-isolation.ts
  - src/lib/portal/ticket-queries.ts
  - src/lib/portal/message-queries.ts
  - src/lib/settings/queries.ts
autonomous: true

must_haves:
  truths:
    - "Ticket tables exist in database (tickets, ticket_messages, ticket_attachments, ticket_categories, app_settings)"
    - "Ticket status enum has 3 values: offen, in_bearbeitung, geschlossen"
    - "Ticket urgency enum has 3 values: notfall, dringend, normal"
    - "ticket_categories table has 4 default rows: Heizung, Wasser/Sanitaer, Elektrik, Allgemein"
    - "app_settings table has company_name default 'KEWA AG'"
    - "TypeScript types match database schema for all new tables"
    - "Tenant isolation helper scopes queries by user_id from session"
    - "Query helpers for tickets, messages, and settings are typed and functional"
  artifacts:
    - path: "supabase/migrations/062_tenant_portal.sql"
      provides: "All portal tables, enums, indexes, triggers, default seed data"
      contains: "CREATE TABLE tickets"
    - path: "src/types/portal.ts"
      provides: "TypeScript types for tickets, messages, attachments, categories, settings"
      exports: ["Ticket", "TicketMessage", "TicketAttachment", "TicketCategory", "AppSetting", "TicketStatus", "TicketUrgency", "CreateTicketInput", "CreateMessageInput"]
    - path: "src/lib/portal/tenant-isolation.ts"
      provides: "Tenant context helper that scopes all queries by session user_id"
      exports: ["getTenantContext", "TenantContext"]
    - path: "src/lib/portal/ticket-queries.ts"
      provides: "CRUD query helpers for tickets scoped by tenant"
      exports: ["getTickets", "getTicketById", "createTicket", "cancelTicket", "getTicketCategories"]
    - path: "src/lib/portal/message-queries.ts"
      provides: "Query helpers for ticket messages and read receipts"
      exports: ["getTicketMessages", "createMessage", "markMessagesAsRead"]
    - path: "src/lib/settings/queries.ts"
      provides: "Key-value settings access helpers"
      exports: ["getSetting", "getAllSettings", "updateSetting"]
  key_links:
    - from: "src/lib/portal/ticket-queries.ts"
      to: "src/lib/portal/tenant-isolation.ts"
      via: "getTenantContext called before every query"
      pattern: "getTenantContext"
    - from: "src/types/portal.ts"
      to: "supabase/migrations/062_tenant_portal.sql"
      via: "Types mirror database schema"
      pattern: "TicketStatus"
---

<objective>
Create the database schema for the tenant portal (tickets, messages, attachments, categories, app_settings) and all TypeScript types and query helpers.

Purpose: Foundation layer for the entire tenant portal. Plans 02-04 depend on these tables, types, and query functions. Tenant data isolation is enforced at the query layer.
Output: Migration 062 with all portal tables + seed data, types file, tenant isolation helper, ticket/message/settings query modules.
</objective>

<execution_context>
@C:\Users\Mario Giacchino\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\Mario Giacchino\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/26-tenant-portal-core/26-CONTEXT.md
@.planning/phases/26-tenant-portal-core/26-RESEARCH.md
@supabase/migrations/061_notifications.sql
@supabase/migrations/023_users_auth.sql
@supabase/migrations/022_rbac.sql
@src/types/database.ts
@src/types/index.ts
@src/types/auth.ts
@src/lib/supabase/server.ts
@src/lib/supabase/client.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Database migration 062_tenant_portal.sql</name>
  <files>supabase/migrations/062_tenant_portal.sql</files>
  <action>
Create migration `062_tenant_portal.sql` following the idempotent DO/EXCEPTION pattern from 061.

**Header comment:**
```sql
-- KEWA Renovations Operations System
-- Migration: 062_tenant_portal.sql
-- Purpose: Tenant portal schema - tickets, messages, attachments, categories, app settings
-- Phase: 26-tenant-portal-core, Plan: 01
```

**Enums (DO/EXCEPTION idempotent pattern):**
- `ticket_status`: `'offen'`, `'in_bearbeitung'`, `'geschlossen'`, `'storniert'`
- `ticket_urgency`: `'notfall'`, `'dringend'`, `'normal'`
- `message_sender_type`: `'tenant'`, `'operator'`

**Table: app_settings** (key-value settings)
- key TEXT PRIMARY KEY
- value TEXT NOT NULL
- value_type TEXT NOT NULL CHECK (value_type IN ('string', 'number', 'boolean', 'json'))
- description TEXT
- updated_at TIMESTAMPTZ DEFAULT NOW()
- updated_by UUID REFERENCES users(id)

Seed defaults:
```sql
INSERT INTO app_settings (key, value, value_type, description) VALUES
  ('company_name', 'KEWA AG', 'string', 'Firmenname im Mieterportal'),
  ('support_email', 'info@kewa.ch', 'string', 'Support-Email'),
  ('notfall_phone', '+41 XX XXX XX XX', 'string', 'Notfall-Telefonnummer')
ON CONFLICT (key) DO NOTHING;
```

**Table: ticket_categories** (admin-configurable)
- id UUID PRIMARY KEY DEFAULT gen_random_uuid()
- name TEXT NOT NULL UNIQUE
- display_name TEXT NOT NULL
- description TEXT
- sort_order INTEGER DEFAULT 0
- is_active BOOLEAN DEFAULT true
- created_at TIMESTAMPTZ DEFAULT NOW()
- updated_at TIMESTAMPTZ DEFAULT NOW()

Seed defaults:
```sql
INSERT INTO ticket_categories (name, display_name, sort_order) VALUES
  ('heizung', 'Heizung', 1),
  ('wasser_sanitaer', 'Wasser/Sanitaer', 2),
  ('elektrik', 'Elektrik', 3),
  ('allgemein', 'Allgemein', 4)
ON CONFLICT (name) DO NOTHING;
```

**Table: tickets**
- id UUID PRIMARY KEY DEFAULT gen_random_uuid()
- ticket_number TEXT NOT NULL UNIQUE -- Auto-generated: T-YYYYMMDD-XXXX
- category_id UUID NOT NULL REFERENCES ticket_categories(id)
- unit_id UUID NOT NULL REFERENCES units(id)
- created_by UUID NOT NULL REFERENCES users(id) -- Tenant who created
- title TEXT NOT NULL
- description TEXT NOT NULL
- urgency ticket_urgency NOT NULL DEFAULT 'normal'
- status ticket_status NOT NULL DEFAULT 'offen'
- assigned_to UUID REFERENCES users(id) -- KEWA operator handling ticket
- closed_at TIMESTAMPTZ
- closed_by UUID REFERENCES users(id)
- cancelled_at TIMESTAMPTZ
- last_message_at TIMESTAMPTZ -- Denormalized for fast sorting
- created_at TIMESTAMPTZ DEFAULT NOW()
- updated_at TIMESTAMPTZ DEFAULT NOW()

**Table: ticket_messages**
- id UUID PRIMARY KEY DEFAULT gen_random_uuid()
- ticket_id UUID NOT NULL REFERENCES tickets(id) ON DELETE CASCADE
- sender_type message_sender_type NOT NULL
- created_by UUID NOT NULL REFERENCES users(id)
- content TEXT NOT NULL
- read_at TIMESTAMPTZ
- read_by UUID REFERENCES users(id)
- created_at TIMESTAMPTZ DEFAULT NOW()

**Table: ticket_attachments**
- id UUID PRIMARY KEY DEFAULT gen_random_uuid()
- ticket_id UUID NOT NULL REFERENCES tickets(id) ON DELETE CASCADE
- message_id UUID REFERENCES ticket_messages(id) ON DELETE CASCADE -- NULL = ticket-level attachment
- uploaded_by UUID NOT NULL REFERENCES users(id)
- storage_path TEXT NOT NULL
- file_name TEXT NOT NULL
- file_size INTEGER
- mime_type TEXT
- created_at TIMESTAMPTZ DEFAULT NOW()

**Indexes:**
- idx_tickets_created_by ON tickets(created_by)
- idx_tickets_unit ON tickets(unit_id)
- idx_tickets_status ON tickets(status) WHERE status != 'geschlossen'
- idx_tickets_urgency ON tickets(urgency) WHERE urgency = 'notfall'
- idx_ticket_messages_ticket ON ticket_messages(ticket_id)
- idx_ticket_messages_unread ON ticket_messages(ticket_id) WHERE read_at IS NULL
- idx_ticket_attachments_ticket ON ticket_attachments(ticket_id)
- idx_ticket_attachments_message ON ticket_attachments(message_id)
- idx_ticket_categories_active ON ticket_categories(is_active, sort_order)
- idx_app_settings_key ON app_settings(key) -- already PK but explicit

**Function: generate_ticket_number()**
Returns TEXT. Format: `T-YYYYMMDD-XXXX` where XXXX is a zero-padded sequence reset daily.
Implementation: SELECT COUNT(*) + 1 from tickets where created_at::date = CURRENT_DATE, then format with LPAD.

**Trigger: set_ticket_number**
BEFORE INSERT ON tickets, call generate_ticket_number() and set NEW.ticket_number.

**Trigger: update_ticket_last_message**
AFTER INSERT ON ticket_messages, UPDATE tickets SET last_message_at = NEW.created_at, updated_at = NOW() WHERE id = NEW.ticket_id.

**Trigger: auto_transition_in_bearbeitung**
AFTER INSERT ON ticket_messages, IF NEW.sender_type = 'operator' THEN UPDATE tickets SET status = 'in_bearbeitung', updated_at = NOW() WHERE id = NEW.ticket_id AND status = 'offen'.

**Trigger: update_updated_at** on tickets and ticket_categories (reuse existing update_updated_at_column function from 001).

**COMMENT ON** for all tables and non-obvious columns. Follow comment style from 061_notifications.sql.
  </action>
  <verify>
Run: `npx supabase db reset` -- migration applies without errors.
Check: SELECT * FROM ticket_categories returns 4 rows.
Check: SELECT * FROM app_settings returns 3 rows.
Check: Enum types ticket_status, ticket_urgency, message_sender_type exist.
  </verify>
  <done>Migration 062 creates all portal tables with correct columns, enums, indexes, triggers, functions, seed data, and comments. Ticket number auto-generation works. Status auto-transition trigger fires on operator messages.</done>
</task>

<task type="auto">
  <name>Task 2: TypeScript types for portal entities</name>
  <files>
    src/types/portal.ts
    src/types/index.ts
    src/types/database.ts
  </files>
  <action>
**src/types/portal.ts** - Follow pattern from src/types/auth.ts (grouped sections with clear headers):

Type unions:
- TicketStatus: 'offen' | 'in_bearbeitung' | 'geschlossen' | 'storniert'
- TicketUrgency: 'notfall' | 'dringend' | 'normal'
- MessageSenderType: 'tenant' | 'operator'

Interfaces:
- AppSetting: { key, value, value_type: 'string' | 'number' | 'boolean' | 'json', description: string | null, updated_at, updated_by: string | null }
- TicketCategory: { id, name, display_name, description: string | null, sort_order, is_active, created_at, updated_at }
- Ticket: { id, ticket_number, category_id, unit_id, created_by, title, description, urgency: TicketUrgency, status: TicketStatus, assigned_to: string | null, closed_at: string | null, closed_by: string | null, cancelled_at: string | null, last_message_at: string | null, created_at, updated_at }
- TicketWithCategory: Ticket extended with `category: { id, name, display_name }`
- TicketWithDetails: TicketWithCategory extended with `unit: { id, name, building_id }`, `message_count: number`, `unread_count: number`
- TicketMessage: { id, ticket_id, sender_type: MessageSenderType, created_by, content, read_at: string | null, read_by: string | null, created_at }
- TicketMessageWithSender: TicketMessage extended with `sender: { id, display_name }`
- TicketMessageWithAttachments: TicketMessageWithSender extended with `attachments: TicketAttachment[]`
- TicketAttachment: { id, ticket_id, message_id: string | null, uploaded_by, storage_path, file_name, file_size: number | null, mime_type: string | null, created_at }
- TicketAttachmentWithUrl: TicketAttachment extended with `url: string`

Input types:
- CreateTicketInput: { category_id, title, description, urgency?: TicketUrgency }
- CreateMessageInput: { content: string }
- UpdateTicketStatusInput: { status: TicketStatus }
- CreateCategoryInput: { name, display_name, description?: string, sort_order?: number }
- UpdateCategoryInput: Partial of CreateCategoryInput + { is_active?: boolean }
- UpdateSettingInput: { value: string }

Response types:
- TicketsResponse: { tickets: TicketWithDetails[] }
- TicketResponse: { ticket: TicketWithDetails }
- TicketMessagesResponse: { messages: TicketMessageWithAttachments[] }
- TicketCategoriesResponse: { categories: TicketCategory[] }
- SettingsResponse: { settings: AppSetting[] }

Constants:
```typescript
export const TICKET_STATUS_LABELS: Record<TicketStatus, string> = {
  offen: 'Offen',
  in_bearbeitung: 'In Bearbeitung',
  geschlossen: 'Geschlossen',
  storniert: 'Storniert',
}

export const TICKET_URGENCY_LABELS: Record<TicketUrgency, string> = {
  notfall: 'Notfall',
  dringend: 'Dringend',
  normal: 'Normal',
}

export const TICKET_URGENCY_COLORS: Record<TicketUrgency, string> = {
  notfall: 'text-red-700 bg-red-100',
  dringend: 'text-orange-700 bg-orange-100',
  normal: 'text-blue-700 bg-blue-100',
}

export const TICKET_STATUS_COLORS: Record<TicketStatus, string> = {
  offen: 'text-yellow-700 bg-yellow-100',
  in_bearbeitung: 'text-blue-700 bg-blue-100',
  geschlossen: 'text-green-700 bg-green-100',
  storniert: 'text-gray-700 bg-gray-100',
}
```

**src/types/index.ts** - Add re-exports at the bottom of the file:
```typescript
// Portal types (Phase 26)
export type { TicketStatus, TicketUrgency, MessageSenderType } from './portal'
```

**src/types/database.ts** - Add re-exports at the bottom of the file:
```typescript
// Portal types (Phase 26)
export type {
  Ticket,
  TicketWithCategory,
  TicketWithDetails,
  TicketMessage,
  TicketMessageWithSender,
  TicketMessageWithAttachments,
  TicketAttachment,
  TicketAttachmentWithUrl,
  TicketCategory,
  AppSetting,
  CreateTicketInput,
  CreateMessageInput,
  UpdateTicketStatusInput,
  CreateCategoryInput,
  UpdateCategoryInput,
  UpdateSettingInput,
  TicketsResponse,
  TicketResponse,
  TicketMessagesResponse,
  TicketCategoriesResponse,
  SettingsResponse,
} from './portal'
```
  </action>
  <verify>
Run: `npx tsc --noEmit` -- no TypeScript errors.
Check: All exported types are accessible from `@/types/portal`, `@/types/index`, `@/types/database`.
  </verify>
  <done>Portal types file exports all ticket/message/attachment/category/settings interfaces. Type unions match database enums exactly. Constants provide German labels and Tailwind color classes for status/urgency badges.</done>
</task>

<task type="auto">
  <name>Task 3: Query helpers and tenant isolation</name>
  <files>
    src/lib/portal/tenant-isolation.ts
    src/lib/portal/ticket-queries.ts
    src/lib/portal/message-queries.ts
    src/lib/settings/queries.ts
  </files>
  <action>
**src/lib/portal/tenant-isolation.ts** - Tenant context helper:

```typescript
import { createClient } from '@/lib/supabase/server'

export interface TenantContext {
  userId: string
  unitId: string
  isPrimary: boolean
}

export async function getTenantContext(userId: string): Promise<TenantContext> {
  const supabase = await createClient()
  const { data, error } = await supabase
    .from('tenant_users')
    .select('unit_id, is_primary')
    .eq('user_id', userId)
    .is('move_out_date', null)
    .single()

  if (error || !data) {
    throw new Error('Mieter ist keiner Einheit zugeordnet')
  }

  return { userId, unitId: data.unit_id, isPrimary: data.is_primary }
}
```

Also export `verifyTicketOwnership(userId, ticketId)` that confirms the ticket was created_by the user. Returns the ticket or throws.

**src/lib/portal/ticket-queries.ts** - Ticket CRUD with tenant scoping. All functions take userId as first parameter and call getTenantContext or verifyTicketOwnership:

- `getTickets(userId)`: Get tenant context, SELECT from tickets WHERE created_by = userId, JOIN ticket_categories for category info, ORDER BY created_at DESC. Return TicketWithDetails[].
- `getTicketById(userId, ticketId)`: verifyTicketOwnership, then SELECT with full joins (category, unit). Return TicketWithDetails.
- `createTicket(userId, input: CreateTicketInput)`: Get tenant context for unit_id. INSERT into tickets with { ...input, unit_id, created_by: userId }. Return Ticket.
- `cancelTicket(userId, ticketId)`: verifyTicketOwnership. Check status is 'offen'. UPDATE status = 'storniert', cancelled_at = NOW(). Return updated ticket.
- `getTicketCategories()`: SELECT from ticket_categories WHERE is_active = true ORDER BY sort_order. No tenant scoping needed (public data).
- `getOpenTicketCount(userId)`: SELECT COUNT from tickets WHERE created_by = userId AND status IN ('offen', 'in_bearbeitung').
- `getRecentTickets(userId, limit = 5)`: Like getTickets but with limit.

**src/lib/portal/message-queries.ts** - Message thread queries:

- `getTicketMessages(userId, ticketId)`: verifyTicketOwnership first. SELECT from ticket_messages WHERE ticket_id, JOIN users for sender display_name, LEFT JOIN ticket_attachments. ORDER BY created_at ASC. Return TicketMessageWithAttachments[].
- `createMessage(userId, ticketId, input: CreateMessageInput)`: verifyTicketOwnership. INSERT into ticket_messages with { ticket_id: ticketId, created_by: userId, sender_type: 'tenant', content: input.content }. Return TicketMessage.
- `markMessagesAsRead(userId, ticketId)`: verifyTicketOwnership. UPDATE ticket_messages SET read_at = NOW(), read_by = userId WHERE ticket_id = ticketId AND sender_type = 'operator' AND read_at IS NULL. Mark only operator messages as read (tenant reads operator's messages).
- `getUnreadMessageCount(userId)`: SELECT COUNT from ticket_messages tm JOIN tickets t ON tm.ticket_id = t.id WHERE t.created_by = userId AND tm.sender_type = 'operator' AND tm.read_at IS NULL.

**src/lib/settings/queries.ts** - App settings access (used by both portal and admin):

- `getSetting(key)`: SELECT value FROM app_settings WHERE key. Return string | null.
- `getAllSettings()`: SELECT key, value FROM app_settings. Return Record<string, string>.
- `getSettingsFull()`: SELECT * FROM app_settings ORDER BY key. Return AppSetting[].
- `updateSetting(key, value, updatedBy)`: UPDATE app_settings SET value, updated_at = NOW(), updated_by WHERE key. Return AppSetting.

All functions use `createClient` from `@/lib/supabase/server`. Follow existing query patterns (error handling, null coalescing, typed returns).
  </action>
  <verify>
Run: `npx tsc --noEmit` -- no TypeScript errors.
Check: All query functions are importable from their respective modules.
Check: getTenantContext throws for non-tenant users.
Check: verifyTicketOwnership throws for tickets not owned by user.
  </verify>
  <done>Tenant isolation helper enforces user scoping at query layer. Ticket and message query helpers provide full CRUD with ownership verification. Settings queries provide admin-configurable key-value access. Zero cross-tenant data exposure possible through these functions.</done>
</task>

</tasks>

<verification>
1. `npx supabase db reset` succeeds -- migration 062 applies cleanly
2. `npx tsc --noEmit` passes -- all types resolve
3. SELECT * FROM ticket_categories returns 4 rows (Heizung, Wasser/Sanitaer, Elektrik, Allgemein)
4. SELECT * FROM app_settings returns 3 rows (company_name, support_email, notfall_phone)
5. Ticket number trigger generates T-YYYYMMDD-XXXX format
6. Auto-transition trigger changes status to in_bearbeitung on operator message
7. All query functions are typed and importable
8. Tenant isolation scopes all queries by session user_id
</verification>

<success_criteria>
- Migration creates tickets, ticket_messages, ticket_attachments, ticket_categories, app_settings with all columns, enums, indexes, triggers
- Default categories and settings are seeded
- TypeScript types match database schema exactly
- Tenant isolation helper prevents cross-tenant data access
- Query helpers provide full CRUD for tickets and messages
- Settings queries allow admin configuration
</success_criteria>

<output>
After completion, create `.planning/phases/26-tenant-portal-core/26-01-SUMMARY.md`
</output>
