---
phase: 26-tenant-portal-core
plan: 04
type: execute
wave: 3
depends_on: [26-02, 26-03]
files_modified:
  - src/app/portal/page.tsx
  - src/app/portal/tickets/page.tsx
  - src/app/portal/tickets/new/page.tsx
  - src/app/portal/tickets/[id]/page.tsx
  - src/app/portal/settings/page.tsx
  - src/app/portal/layout.tsx
  - src/components/portal/PortalHeader.tsx
  - src/components/portal/PortalNav.tsx
  - src/components/portal/TicketCard.tsx
  - src/components/portal/TicketStatusBadge.tsx
  - src/components/portal/UrgencyBadge.tsx
  - src/components/portal/MessageList.tsx
  - src/components/portal/MessageBubble.tsx
  - src/components/portal/MessageInput.tsx
  - src/components/portal/QRLoginCode.tsx
  - src/hooks/useTicketMessages.ts
  - src/app/portal/qr-login/page.tsx
  - src/app/dashboard/settings/page.tsx
  - supabase/migrations/063_seed_tenant_portal.sql
autonomous: true

must_haves:
  truths:
    - "Tenant sees a dashboard with open ticket count, unread messages, unit info, and recent tickets"
    - "Tenant can view a list of all their tickets sorted by last activity"
    - "Tenant can create a new ticket selecting category and urgency with optional photos"
    - "Tenant can view a ticket detail with WhatsApp-style message thread"
    - "Messages grouped by date (Heute, Gestern, DD.MM.YYYY) with HH:MM timestamps"
    - "Chat bubbles: tenant on right (blue), operator on left (white)"
    - "Read indicators: single check for sent, double check for read"
    - "Portal renders in German, mobile-responsive, portrait-first"
    - "QR code displayed in tenant settings for multi-device login"
    - "Admin settings page allows configuring company name and ticket categories"
    - "Seed data includes tenant users, tickets, messages, and attachments"
  artifacts:
    - path: "src/app/portal/page.tsx"
      provides: "Tenant dashboard with open tickets, unread messages, unit info"
    - path: "src/app/portal/tickets/page.tsx"
      provides: "Ticket list view with status badges and last update"
    - path: "src/app/portal/tickets/new/page.tsx"
      provides: "New ticket form with category, urgency, description, photo upload"
    - path: "src/app/portal/tickets/[id]/page.tsx"
      provides: "Ticket detail with message thread and send input"
    - path: "src/components/portal/MessageList.tsx"
      provides: "WhatsApp-style message list with date grouping"
    - path: "src/components/portal/MessageBubble.tsx"
      provides: "Chat bubble with read indicators and timestamps"
    - path: "src/components/portal/QRLoginCode.tsx"
      provides: "QR code component for multi-device login"
    - path: "src/app/portal/settings/page.tsx"
      provides: "Tenant settings with QR code display"
    - path: "src/app/dashboard/settings/page.tsx"
      provides: "Admin settings page with company name and category management"
    - path: "supabase/migrations/063_seed_tenant_portal.sql"
      provides: "Seed data for tenant users, tickets, messages, attachments"
  key_links:
    - from: "src/app/portal/tickets/[id]/page.tsx"
      to: "src/hooks/useTicketMessages.ts"
      via: "useTicketMessages hook with Supabase Realtime subscription"
      pattern: "useTicketMessages"
    - from: "src/components/portal/MessageList.tsx"
      to: "src/components/portal/MessageBubble.tsx"
      via: "Renders MessageBubble for each message with date grouping"
      pattern: "MessageBubble"
    - from: "src/components/portal/QRLoginCode.tsx"
      to: "/api/portal/auth/qr-token"
      via: "Fetches short-lived QR token for multi-device"
      pattern: "qr-token"
---

<objective>
Build the tenant portal UI pages and components: dashboard, ticket list, ticket creation form, ticket detail with chat-style messages, tenant settings with QR code, admin settings page, and seed data.

Purpose: Complete user-facing portal experience. Tenants interact with their tickets through a mobile-first, German-language interface. Admin configures portal settings. Seed data validates the full stack.
Output: All portal pages, reusable portal components, message thread hook, admin settings page, seed migration.
</objective>

<execution_context>
@C:\Users\Mario Giacchino\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\Mario Giacchino\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/26-tenant-portal-core/26-CONTEXT.md
@.planning/phases/26-tenant-portal-core/26-RESEARCH.md
@src/types/portal.ts
@src/lib/portal/ticket-queries.ts
@src/lib/portal/message-queries.ts
@src/lib/portal/session.ts
@src/lib/portal/attachment-upload.ts
@src/lib/settings/queries.ts
@src/app/portal/layout.tsx
@src/app/portal/login/page.tsx
@src/components/ui/button.tsx
@src/components/navigation/Header.tsx
@src/app/dashboard/layout.tsx
@src/lib/supabase/client.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Portal layout, header, navigation, dashboard, and ticket list pages</name>
  <files>
    src/app/portal/layout.tsx
    src/app/portal/page.tsx
    src/app/portal/tickets/page.tsx
    src/components/portal/PortalHeader.tsx
    src/components/portal/PortalNav.tsx
    src/components/portal/TicketCard.tsx
    src/components/portal/TicketStatusBadge.tsx
    src/components/portal/UrgencyBadge.tsx
  </files>
  <action>
Install qrcode.react for QR code support (used in Task 3):
```bash
npm install qrcode.react@^4.1.0
```

**src/components/portal/PortalHeader.tsx** - Client component:
- Props: { companyName: string }
- Fixed top header bar: bg-blue-900 text-white
- Left: company name + "Mieterportal" subtitle
- Right: User icon button linking to /portal/settings
- Height: h-14 (56px)
- Mobile-first: full width, no max-width constraint on header

**src/components/portal/PortalNav.tsx** - Client component:
- Fixed bottom navigation bar (mobile tab bar pattern)
- 3 tabs: Dashboard (Home icon), Tickets (Ticket icon), Einstellungen (Settings icon)
- Active tab highlighted with blue color
- Uses usePathname() to determine active tab
- 48px touch targets per tab
- bg-white border-t shadow

**src/app/portal/layout.tsx** - UPDATE the existing layout:
- Fetch company name server-side: `const companyName = await getSetting('company_name') || 'KEWA AG'`
- Render PortalHeader with companyName
- Main content area: pb-20 (account for bottom nav), pt-14 (account for fixed header)
- Render PortalNav at bottom
- Keep Toaster with position top-center

**src/app/portal/page.tsx** - Server component (dashboard):
- Get portal user via getPortalUser().
- If no user, redirect to /portal/login.
- Fetch dashboard data via fetch('/api/portal/dashboard') with cookie forwarding. OR call query functions directly (server component can call server functions).
- Better: call query functions directly since this is a server component:
  - getOpenTicketCount(userId)
  - getUnreadMessageCount(userId)
  - getRecentTickets(userId, 5)
  - getTenantContext(userId) for unit info
  - getSetting('company_name')
- Look up unit details (name, building name) from supabase.
- Render:
  - Greeting: "Willkommen" + unit name
  - Stats cards: "Offene Tickets" count, "Ungelesene Nachrichten" count
  - "Neues Ticket" primary action button linking to /portal/tickets/new
  - "Letzte Tickets" section with TicketCard list
  - If no tickets, show empty state: "Keine Tickets vorhanden"

**src/app/portal/tickets/page.tsx** - Server component (ticket list):
- Get portal user. Redirect if not authenticated.
- Call getTickets(userId).
- Render: Page title "Meine Tickets", + button "Neues Ticket" linking to /portal/tickets/new.
- List of TicketCard components.
- Empty state if no tickets.

**src/components/portal/TicketCard.tsx** - Client component:
- Props: { ticket: TicketWithDetails }
- Card layout: rounded-lg shadow-sm bg-white p-4
- Top row: ticket_number (gray, small), urgency badge
- Title: font-semibold, truncated to 2 lines
- Category name as gray text
- Bottom row: status badge, timestamp (relative using date-fns: "vor 2 Stunden", "Gestern", etc.)
- Unread message indicator (blue dot) if unread_count > 0
- Entire card is clickable, links to /portal/tickets/[id]
- 48px min-height for touch target

**src/components/portal/TicketStatusBadge.tsx** - Display component:
- Props: { status: TicketStatus }
- Uses TICKET_STATUS_LABELS and TICKET_STATUS_COLORS from types/portal.ts
- Render: inline pill badge with colored text and background

**src/components/portal/UrgencyBadge.tsx** - Display component:
- Props: { urgency: TicketUrgency }
- Uses TICKET_URGENCY_LABELS and TICKET_URGENCY_COLORS from types/portal.ts
- Render: inline pill badge. Notfall gets red pulsing dot.
  </action>
  <verify>
Run: `npx tsc --noEmit` -- no TypeScript errors.
Check: /portal renders dashboard with stats and recent tickets.
Check: /portal/tickets renders ticket list with status/urgency badges.
Check: Bottom navigation highlights active tab.
Check: All text is German.
  </verify>
  <done>Portal has complete navigation shell (fixed header + bottom tabs). Dashboard shows open ticket count, unread messages, unit info, and recent tickets. Ticket list displays all tickets with status/urgency badges and unread indicators. All UI is German and mobile-first.</done>
</task>

<task type="auto">
  <name>Task 2: Ticket creation form, ticket detail with message thread</name>
  <files>
    src/app/portal/tickets/new/page.tsx
    src/app/portal/tickets/[id]/page.tsx
    src/components/portal/MessageList.tsx
    src/components/portal/MessageBubble.tsx
    src/components/portal/MessageInput.tsx
    src/hooks/useTicketMessages.ts
  </files>
  <action>
**src/app/portal/tickets/new/page.tsx** - Client component:
- 'use client' directive.
- Fetch categories on mount: GET /api/portal/categories.
- Form fields:
  - Kategorie: dropdown/select with categories from API. Required.
  - Dringlichkeit: radio buttons or segmented control with 3 options (Normal, Dringend, Notfall). Default: Normal. Notfall has red highlight.
  - Titel: text input, required, maxLength 200.
  - Beschreibung: textarea, required, maxLength 2000, rows 4.
  - Fotos: file input for multiple images (max 5). Show preview thumbnails. Accept: image/jpeg,image/png,image/webp.
- Submit: POST to /api/portal/tickets with { category_id, title, description, urgency }.
  - On success, if photos selected, upload via POST to /api/portal/tickets/[newId]/attachments (FormData).
  - Then router.push('/portal/tickets/[newId]').
- Cancel button: router.back().
- All labels in German. 48px touch targets for inputs and buttons.
- toast() for success/error feedback.

**src/hooks/useTicketMessages.ts** - Custom hook with Supabase Realtime:

```typescript
'use client'
import { useEffect, useState, useCallback } from 'react'
import { createClient } from '@/lib/supabase/client'
import type { TicketMessageWithAttachments } from '@/types/portal'

export function useTicketMessages(ticketId: string) {
  const [messages, setMessages] = useState<TicketMessageWithAttachments[]>([])
  const [loading, setLoading] = useState(true)

  // Initial fetch
  const fetchMessages = useCallback(async () => {
    const res = await fetch(`/api/portal/tickets/${ticketId}/messages`)
    if (res.ok) {
      const data = await res.json()
      setMessages(data.messages)
    }
    setLoading(false)
  }, [ticketId])

  useEffect(() => {
    fetchMessages()

    // Subscribe to new messages via Supabase Realtime
    const supabase = createClient()
    const channel = supabase
      .channel(`ticket-${ticketId}`)
      .on(
        'postgres_changes',
        {
          event: 'INSERT',
          schema: 'public',
          table: 'ticket_messages',
          filter: `ticket_id=eq.${ticketId}`
        },
        () => {
          // Refetch all messages on new insert (simpler than merging)
          fetchMessages()
        }
      )
      .subscribe()

    return () => { channel.unsubscribe() }
  }, [ticketId, fetchMessages])

  return { messages, loading, refetch: fetchMessages }
}
```

**src/app/portal/tickets/[id]/page.tsx** - Client component:
- 'use client' directive.
- Fetch ticket detail on mount: GET /api/portal/tickets/[id].
- Use useTicketMessages(id) hook for real-time messages.
- Layout (mobile-optimized chat):
  - Top: ticket info bar with ticket_number, category, status badge, urgency badge.
  - If status === 'offen': "Stornieren" button (calls POST /api/portal/tickets/[id]/cancel, confirm with dialog).
  - Middle: MessageList component (scrollable, takes remaining height).
  - Bottom: MessageInput component (fixed at bottom, above nav bar).
- Auto-scroll to bottom on new messages.
- Mark messages as read on mount: POST /api/portal/tickets/[id]/messages/read.
- If ticket is geschlossen or storniert, show disabled input with "Ticket geschlossen" message.

**src/components/portal/MessageList.tsx** - Client component:
- Props: { messages: TicketMessageWithAttachments[] }
- Group messages by date using date-fns (isToday, isYesterday, format with de locale).
- Date labels: "Heute", "Gestern", "DD.MM.YYYY".
- Date separator: centered pill badge (gray bg).
- Render MessageBubble for each message.
- Empty state: "Noch keine Nachrichten".
- Ref forwarding for scroll-to-bottom.

**src/components/portal/MessageBubble.tsx** - Client component:
- Props: { message: TicketMessageWithAttachments }
- Tenant messages (sender_type = 'tenant'): right-aligned, blue bg, white text, rounded-tr-sm.
- Operator messages (sender_type = 'operator'): left-aligned, white bg, gray border, dark text, rounded-tl-sm.
- Content: text with word-break.
- Attachments: inline image thumbnails (clickable to expand).
- Bottom row: HH:MM timestamp + read indicator.
- Read indicators (tenant messages only):
  - Single check (Check icon from lucide): message sent but not read.
  - Double check (CheckCheck icon): message read (read_at is not null).
- Max width: 80% of container.

**src/components/portal/MessageInput.tsx** - Client component:
- Props: { ticketId: string, disabled?: boolean, onSent?: () => void }
- Sticky bottom bar: bg-white border-t px-4 py-2.
- Input: text input with placeholder "Nachricht schreiben...".
- Attachment button: camera/paperclip icon to select photos.
- Send button: arrow-up icon (blue, 48px touch target).
- On send:
  1. POST /api/portal/tickets/[id]/messages with { content }.
  2. If attachments selected, POST to /api/portal/tickets/[id]/attachments with FormData + message_id.
  3. Clear input and attachments.
  4. Call onSent().
- Disabled state: gray bg, "Ticket geschlossen" text.
  </action>
  <verify>
Run: `npx tsc --noEmit` -- no TypeScript errors.
Check: /portal/tickets/new renders form with category/urgency selection.
Check: /portal/tickets/[id] renders chat-style message thread.
Check: Messages grouped by date with German labels.
Check: Tenant messages on right (blue), operator on left (white).
Check: Read indicators show single/double checkmarks.
Check: New messages appear in real-time via Supabase Realtime.
  </verify>
  <done>Ticket creation form captures category, urgency, description, and photos. Ticket detail shows WhatsApp-style message thread with date grouping, read indicators, and real-time updates. Message input supports text and photo attachments. All UI is German and mobile-optimized.</done>
</task>

<task type="auto">
  <name>Task 3: Tenant settings with QR code, admin settings page, and seed data</name>
  <files>
    src/app/portal/settings/page.tsx
    src/components/portal/QRLoginCode.tsx
    src/app/dashboard/settings/page.tsx
    supabase/migrations/063_seed_tenant_portal.sql
  </files>
  <action>
**src/components/portal/QRLoginCode.tsx** - Client component:
- Props: { userId: string }
- On mount, fetch QR token: POST /api/portal/auth/qr-token.
- Display QRCodeSVG from qrcode.react with the login URL.
- QR value: `{window.location.origin}/portal/qr-login?token={token}`
- Size: 200x200px, level: 'M', includeMargin.
- Show expiration text: "Gueltig fuer 5 Minuten".
- "Neuen Code generieren" button to refresh.
- Loading state while fetching token.
- Error state if generation fails.

**src/app/portal/settings/page.tsx** - Client component:
- 'use client' directive.
- Fetch portal session: GET /api/portal/auth/session.
- Display:
  - Section: "Konto" -- user email (read-only), display name.
  - Section: "Auf anderem Geraet anmelden" -- QRLoginCode component.
  - Section: "Abmelden" -- logout button (calls POST /api/portal/auth/logout, then router.push('/portal/login')).
- Mobile-first layout, card sections.

Also add a `/portal/qr-login` page (simple):

**src/app/portal/qr-login/page.tsx** - Client component:
- Read token from URL search params.
- On mount, POST to /api/portal/auth/qr-login with { token }.
- On success, redirect to /portal.
- On failure, show error and link to /portal/login.
- Loading state: "Anmeldung laeuft..."

**src/app/dashboard/settings/page.tsx** - Admin settings page (operator dashboard):

Check if a settings page already exists at this path. If it does, extend it. If not, create it.

Create a new admin settings page under the existing dashboard layout:
- Server component that fetches current settings and categories.
- Two sections:
  1. "Portal-Einstellungen":
     - Company name: editable text field. Save via PUT /api/settings with { key: 'company_name', value }.
     - Support email: editable text field.
     - Notfall phone: editable text field.
  2. "Ticket-Kategorien":
     - List of categories with display_name, sort_order, active status.
     - "Neue Kategorie" button to add.
     - Edit button per category (inline editing or modal).
     - Deactivate toggle per category.
     - Uses /api/settings/categories endpoints.
- German labels. Standard dashboard UI patterns (same card/button styles as other dashboard pages).

**supabase/migrations/063_seed_tenant_portal.sql** - Seed data:

```sql
-- KEWA Renovations Operations System
-- Migration: 063_seed_tenant_portal.sql
-- Purpose: Seed data for tenant portal (demo/testing)
-- Phase: 26-tenant-portal-core, Plan: 04
```

Create realistic German-language seed data:

1. **Tenant users** (2-3 tenants):
   - Create users with auth_method='email_password', role_id pointing to 'tenant' role.
   - Use pre-hashed passwords (bcrypt hash of 'test1234').
   - Assign to existing units via tenant_users table.
   - Example: Anna Mueller (anna@example.com), Peter Schmidt (peter@example.com).

2. **Tickets** (4-6 tickets across tenants):
   - Mix of statuses: offen, in_bearbeitung, geschlossen, storniert.
   - Mix of urgencies: normal, dringend, notfall.
   - Mix of categories.
   - Example: "Heizung funktioniert nicht" (notfall), "Wasserhahn tropft" (normal), "Klingel defekt" (dringend).
   - Realistic ticket_numbers will be auto-generated by trigger.

3. **Messages** (3-5 per ticket with conversation):
   - Mix of tenant and operator messages.
   - Some with read_at set (read by other party).
   - Realistic conversation flow (tenant reports, operator responds, tenant confirms).

4. **Attachments** (1-2 per ticket):
   - Reference dummy storage paths (actual files not needed for seed).
   - Realistic file names like "heizung_foto.jpg", "wasserhahn.png".

Important: Use existing unit IDs from the database. Query for them dynamically:
```sql
-- Get existing unit IDs
WITH first_unit AS (
  SELECT id FROM units WHERE unit_type = 'apartment' LIMIT 1
),
second_unit AS (
  SELECT id FROM units WHERE unit_type = 'apartment' OFFSET 1 LIMIT 1
)
...
```

Use the tenant role ID:
```sql
WITH tenant_role AS (
  SELECT id FROM roles WHERE name = 'tenant'
)
```
  </action>
  <verify>
Run: `npx supabase db reset` -- all migrations apply cleanly including seed.
Run: `npx tsc --noEmit` -- no TypeScript errors.
Run: `npm run build` -- build succeeds.
Check: /portal/settings displays QR code for logged-in tenant.
Check: /portal/qr-login processes QR token and redirects.
Check: /dashboard/settings shows portal settings and category management.
Check: Seed data creates tenants, tickets, messages visible in portal.
  </verify>
  <done>Tenant settings page shows QR code for multi-device login. Admin settings page allows company name and category configuration. Seed data provides realistic German-language test data for tenants, tickets, messages, and attachments. Full portal experience is testable end-to-end.</done>
</task>

</tasks>

<verification>
1. `npx supabase db reset` succeeds -- seed data applies cleanly
2. `npx tsc --noEmit` passes -- all types resolve
3. `npm run build` succeeds -- no build errors
4. /portal renders dashboard with stats, recent tickets, unit info
5. /portal/tickets shows ticket list with status/urgency badges
6. /portal/tickets/new creates ticket with category, urgency, photos
7. /portal/tickets/[id] shows WhatsApp-style message thread
8. Messages grouped by date (Heute, Gestern, DD.MM.YYYY) with HH:MM times
9. Chat bubbles correctly positioned (tenant right, operator left)
10. Read indicators (single check, double check) display correctly
11. Real-time message updates via Supabase Realtime
12. QR code generates and displays in settings page
13. Admin settings page manages company name and categories
14. All portal UI is German-language and mobile-responsive
15. Bottom navigation shows 3 tabs with active state
</verification>

<success_criteria>
- Tenant dashboard shows open tickets, unread messages, and unit info
- Ticket list displays all tenant tickets with sortable badges
- Ticket creation captures category, urgency, description, and up to 5 photos
- Message thread renders as WhatsApp-style chat with date grouping and read indicators
- Real-time message delivery via Supabase Realtime
- QR code enables multi-device login with 5-minute token
- Admin can configure company name and ticket categories
- Seed data provides end-to-end testable portal experience
- All UI renders in German, mobile-first, portrait-optimized
</success_criteria>

<output>
After completion, create `.planning/phases/26-tenant-portal-core/26-04-SUMMARY.md`
</output>
