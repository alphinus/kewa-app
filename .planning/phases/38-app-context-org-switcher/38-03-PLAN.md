---
phase: 38-app-context-org-switcher
plan: 03
type: execute
wave: 3
depends_on: [38-01, 38-02]
files_modified:
  - src/components/navigation/OrgSwitcher.tsx
  - src/components/navigation/CombinedSelector.tsx
  - src/components/navigation/header.tsx
  - src/app/dashboard/layout.tsx
autonomous: true
requirements: [CTX-01, CTX-02, CTX-03, CTX-04]

must_haves:
  truths:
    - "Multi-org users see org badge with dropdown left of the context selector in the header"
    - "Single-org users see no org element at all in the header"
    - "Combined selector shows hierarchical mandate > property > building dropdown"
    - "Single-mandate orgs skip mandate grouping level — dropdown shows properties directly (D3)"
    - "Trigger button shows current selection (e.g. 'Seefeld / Gebaeude 1')"
    - "Dashboard layout wraps children in OrganizationProvider > MandateProvider > BuildingProvider > ConnectivityProvider"
    - "Switching building in the selector persists to cookie and refreshes dashboard data"
  artifacts:
    - path: "src/components/navigation/OrgSwitcher.tsx"
      provides: "Org badge + dropdown for multi-org users"
      exports: ["OrgSwitcher"]
    - path: "src/components/navigation/CombinedSelector.tsx"
      provides: "Hierarchical mandate > property > building dropdown"
      exports: ["CombinedSelector"]
    - path: "src/components/navigation/header.tsx"
      provides: "Updated header with OrgSwitcher + CombinedSelector"
      exports: ["Header"]
    - path: "src/app/dashboard/layout.tsx"
      provides: "Dashboard layout with full provider stack"
      contains: "OrganizationProvider"
  key_links:
    - from: "src/components/navigation/OrgSwitcher.tsx"
      to: "src/contexts/OrganizationContext.tsx"
      via: "useOrganization() hook"
      pattern: "useOrganization"
    - from: "src/components/navigation/CombinedSelector.tsx"
      to: "/api/properties"
      via: "fetch in useEffect"
      pattern: "fetch.*api/properties"
    - from: "src/components/navigation/CombinedSelector.tsx"
      to: "src/contexts/MandateContext.tsx"
      via: "useMandate() hook for mandate grouping and switch"
      pattern: "useMandate"
    - from: "src/components/navigation/CombinedSelector.tsx"
      to: "src/contexts/BuildingContext.tsx"
      via: "useBuilding() hook for building selection"
      pattern: "useBuilding"
    - from: "src/app/dashboard/layout.tsx"
      to: "src/contexts/OrganizationContext.tsx"
      via: "OrganizationProvider wrapping"
      pattern: "OrganizationProvider"
    - from: "src/components/navigation/header.tsx"
      to: "src/components/navigation/OrgSwitcher.tsx"
      via: "OrgSwitcher component import"
      pattern: "OrgSwitcher"
---

<objective>
Create the OrgSwitcher and CombinedSelector UI components, wire them into the header, and wrap the dashboard layout with the full provider stack.

Purpose: This is the user-facing plan — the combined selector replaces PropertySelector with mandate-aware hierarchy (D1), the org switcher appears for multi-org users (D2), and the layout ties everything together.
Output: Two new components, updated header, updated layout.
</objective>

<execution_context>
@C:/Users/Mario Giacchino/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Mario Giacchino/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/38-app-context-org-switcher/38-CONTEXT.md
@.planning/phases/38-app-context-org-switcher/38-RESEARCH.md
@.planning/phases/38-app-context-org-switcher/38-01-SUMMARY.md
@.planning/phases/38-app-context-org-switcher/38-02-SUMMARY.md

@src/components/navigation/PropertySelector.tsx
@src/components/navigation/header.tsx
@src/app/dashboard/layout.tsx
@src/contexts/OrganizationContext.tsx
@src/contexts/MandateContext.tsx
@src/contexts/BuildingContext.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create OrgSwitcher and CombinedSelector components</name>
  <files>src/components/navigation/OrgSwitcher.tsx, src/components/navigation/CombinedSelector.tsx</files>
  <action>
**src/components/navigation/OrgSwitcher.tsx** — Create new file. Per D2:

'use client' directive. Imports: useState from 'react'; Check icon from 'lucide-react'; useOrganization from contexts.

`OrgSwitcher` component:
- Consume `useOrganization()` for `currentOrg`, `availableOrgs`, `switchOrg`, `isMultiOrg`, `isLoading`
- If `isLoading` or `!isMultiOrg`: return `null` (single-org users see nothing at all per D2)
- Render a clickable badge (pill-shaped button) showing `currentOrg.name` with a chevron-down icon
- On click, toggle a dropdown (same pattern as PropertySelector: fixed backdrop + absolute dropdown)
- Dropdown is a simple list of available orgs with radio-style selection:
  - Each org name as a button
  - Current org highlighted with blue background and Check icon
  - Click another org calls `switchOrg(org.id)` — this triggers full page navigation per D5
- Styling: text-sm font-semibold, rounded-full or rounded-lg badge, compact appearance
- The badge sits left of the CombinedSelector in the header per D2 layout diagram

**src/components/navigation/CombinedSelector.tsx** — Create new file. Per D1, D3, D6:

'use client' directive. Imports: useState, useEffect, useRef from 'react'; ChevronDown, Building2, Layers, Check from 'lucide-react'; useMandate from contexts; useBuilding from contexts; Property and Building types from '@/types/database'.

Interface for local state:
```typescript
interface PropertyWithBuildings extends Property {
  buildings: Building[]
}
```

`CombinedSelector` component:
1. Consume `useMandate()` for `currentMandateId`, `availableMandates`, `switchMandate`, `isSingleMandate`, mandate `isLoading`
2. Consume `useBuilding()` for `selectedBuildingId`, `selectBuilding`
3. Local state: `properties: PropertyWithBuildings[]`, `loading: boolean`, `isOpen: boolean`

4. **Data fetching**: useEffect depending on `currentMandateId`. Fetch `GET /api/properties` (no mandate_id param — get all properties, group client-side). This matches existing PropertySelector behavior and avoids re-fetching when mandate changes (properties are already RLS-scoped to org via middleware).

5. **Grouping logic**: Group properties by `mandate_id` using `availableMandates`:
   ```
   mandateGroups = availableMandates.map(m => ({
     mandate: m,
     properties: properties.filter(p => p.mandate_id === m.id)
   }))
   ```

6. **Initial selection**: On first load (ref guard like PropertySelector), if `selectedBuildingId` is null, auto-select first building from first property. Use building_id cookie value restored by BuildingProvider if available.

7. **Validation**: If selectedBuildingId points to a building not in the current property list (stale after mandate switch), reset to 'all' or first building in the current scope.

8. **Trigger button**: Shows current selection context:
   - If 'all' mandate + 'all' building: "Alle Mandate" (or "Alle Liegenschaften" if single mandate per D3)
   - If specific mandate + 'all' building: mandate name
   - If specific building: "{property.name} / {building.name}" per D1

9. **Dropdown structure** — two modes based on `isSingleMandate`:

   **Multi-mandate mode (isSingleMandate=false)**:
   ```
   ● Alle Mandate                    ← radio button, calls switchMandate('all') + selectBuilding('all')

   MANDAT A                          ← group header (uppercase, non-clickable)
     Liegenschaft Seefeld            ← property header (non-clickable)
       ○ Gebaude 1                   ← building radio, calls switchMandate(mandateId) + selectBuilding(buildingId)
       ○ Gebaude 2

   MANDAT B
     Liegenschaft Wipkingen
       ○ Gebaude 1
   ```

   **Single-mandate mode (isSingleMandate=true, D3)**:
   ```
   ● Alle Liegenschaften             ← radio button, calls selectBuilding('all')

   Liegenschaft Seefeld              ← property header (non-clickable)
     ○ Gebaude 1                     ← building radio, calls selectBuilding(buildingId)
     ○ Gebaude 2
   ```

10. **Selection handling**:
    - Click "Alle Mandate": `switchMandate('all')`, `selectBuilding('all')`
    - Click "Alle Liegenschaften" (single-mandate): `selectBuilding('all')`
    - Click a building: if in a different mandate than current, call `switchMandate(mandateId)` first, then `selectBuilding(buildingId)`. Close dropdown.
    - Building cookie is written by BuildingProvider automatically when selectBuilding is called.

11. **Dropdown UI**: Same pattern as PropertySelector — button trigger, fixed backdrop overlay (z-40), absolute-positioned content (z-50), max-h-96 overflow-y-auto. Width w-80 (slightly wider than PropertySelector's w-72 to accommodate mandate names).

12. **Loading/error states**: Loading spinner like PropertySelector. Error message if fetch fails. Return null if no properties.
  </action>
  <verify>Run `npx tsc --noEmit` to confirm no type errors. Verify exports: `grep -n 'export' src/components/navigation/OrgSwitcher.tsx src/components/navigation/CombinedSelector.tsx`</verify>
  <done>OrgSwitcher renders as badge for multi-org users (null for single-org). CombinedSelector shows hierarchical mandate > property > building dropdown, handles D1 (combined hierarchy), D3 (single-mandate optimization), D6 (in-place switching).</done>
</task>

<task type="auto">
  <name>Task 2: Wire header and dashboard layout with new components and provider stack</name>
  <files>src/components/navigation/header.tsx, src/app/dashboard/layout.tsx</files>
  <action>
**src/components/navigation/header.tsx** — Replace PropertySelector with OrgSwitcher + CombinedSelector.

Changes:
1. Remove import of `PropertySelector` from `./PropertySelector`
2. Remove import of `BuildingSelectionId` from `@/contexts/BuildingContext`
3. Add import of `OrgSwitcher` from `./OrgSwitcher`
4. Add import of `CombinedSelector` from `./CombinedSelector`

5. Remove `selectedBuildingId` and `onBuildingSelect` from HeaderProps interface. The new components read from context directly — no prop drilling needed.

6. Update HeaderProps to just:
   ```typescript
   interface HeaderProps {
     user?: User
   }
   ```

7. Remove `handleBuildingSelect` function (no longer needed)

8. Replace the PropertySelector JSX block (the `{user?.isInternal && (...)}` section) with:
   ```tsx
   {user?.isInternal && (
     <div className="flex items-center gap-2 flex-shrink-0">
       <OrgSwitcher />
       <CombinedSelector />
     </div>
   )}
   ```

   OrgSwitcher renders null for single-org users — so no visual change for KEWA-only users.

**src/app/dashboard/layout.tsx** — Wrap with full provider stack per CONTEXT.md target.

Changes:
1. Add imports:
   - `OrganizationProvider` from `@/contexts/OrganizationContext`
   - `MandateProvider` from `@/contexts/MandateContext`

2. Remove `useBuilding` import (no longer needed in layout — CombinedSelector handles it)
3. Remove `selectedBuildingId` and `selectBuilding` destructuring from `DashboardLayoutInner`

4. Update `DashboardLayoutInner` to NOT pass `selectedBuildingId` and `onBuildingSelect` to Header. Header now takes only `user` prop.

5. Update the provider nesting in the return of `DashboardLayout`:
   ```tsx
   return (
     <OrganizationProvider>
       <MandateProvider>
         <BuildingProvider>
           <ConnectivityProvider>
             <DashboardLayoutInner user={session.user}>
               {children}
             </DashboardLayoutInner>
           </ConnectivityProvider>
         </BuildingProvider>
       </MandateProvider>
     </OrganizationProvider>
   )
   ```

6. DashboardLayoutInner simplifies to just rendering Header, main, and MobileNav without BuildingContext destructuring:
   ```tsx
   function DashboardLayoutInner({
     children,
     user
   }: {
     children: React.ReactNode
     user: User | undefined
   }) {
     useInstallPrompt()

     return (
       <div className="min-h-screen bg-gray-50 dark:bg-gray-950">
         <Header user={user} />
         <main className="pb-20 pt-4 px-4">
           {children}
         </main>
         <MobileNav isInternal={user?.isInternal} />
       </div>
     )
   }
   ```

7. Remove the `useBuilding` import since DashboardLayoutInner no longer uses it.
  </action>
  <verify>
Run `npx tsc --noEmit` to confirm no type errors across the entire project.
Verify provider nesting: `grep -A5 'OrganizationProvider' src/app/dashboard/layout.tsx`
Verify header uses new components: `grep 'OrgSwitcher\|CombinedSelector' src/components/navigation/header.tsx`
Verify PropertySelector is NOT imported in header: `grep -c 'PropertySelector' src/components/navigation/header.tsx` should return 0.
  </verify>
  <done>Header renders OrgSwitcher + CombinedSelector for internal users (replacing PropertySelector). Dashboard layout wraps children in OrganizationProvider > MandateProvider > BuildingProvider > ConnectivityProvider. No prop drilling for building selection — components read from context directly.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with zero errors
2. PropertySelector is no longer imported in header.tsx
3. Dashboard layout has four nested providers: Organization > Mandate > Building > Connectivity
4. OrgSwitcher renders null for single-org users (KEWA-only shows CombinedSelector only)
5. CombinedSelector handles both multi-mandate and single-mandate modes
6. Header no longer accepts selectedBuildingId or onBuildingSelect props
7. All existing useBuilding() consumers still compile (interface unchanged from Plan 02)
</verification>

<success_criteria>
- Dashboard layout wraps children in OrganizationProvider > MandateProvider > BuildingProvider hierarchy (Success Criteria 1)
- Header displays current organization name for multi-org users, nothing for single-org (Success Criteria 2)
- OrgSwitcher triggers full page navigation on org switch (Success Criteria 3)
- CombinedSelector shows buildings filtered by mandate selection (Success Criteria 4)
- Single-mandate optimization shows flat property > building list without mandate headers (D3)
- TypeScript compilation passes across entire project
</success_criteria>

<output>
After completion, create `.planning/phases/38-app-context-org-switcher/38-03-SUMMARY.md`
</output>
