---
phase: 34-german-umlaut-correction
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - .editorconfig
  - scripts/verify-encoding.ts
  - scripts/check-db-collation.sql
autonomous: true

must_haves:
  truths:
    - "Git displays UTF-8 filenames correctly (no escape sequences)"
    - "All source files verified as UTF-8 or ASCII encoding"
    - "Database encoding confirmed as UTF-8"
    - "EditorConfig enforces UTF-8 for all new files"
  artifacts:
    - path: ".editorconfig"
      provides: "UTF-8 charset enforcement for all editors"
      contains: "charset = utf-8"
    - path: "scripts/verify-encoding.ts"
      provides: "Encoding verification script"
      min_lines: 40
    - path: "scripts/check-db-collation.sql"
      provides: "Database collation verification queries"
      contains: "pg_encoding_to_char"
  key_links:
    - from: "scripts/verify-encoding.ts"
      to: "chardet"
      via: "npm dependency"
      pattern: "import.*chardet"
---

<objective>
Set up UTF-8 infrastructure: EditorConfig for editor enforcement, git configuration for proper UTF-8 display, encoding verification script, and database collation validation.

Purpose: Ensures all tooling supports UTF-8 before making umlaut corrections, preventing encoding corruption.
Output: EditorConfig file, encoding verification script, database collation SQL, and configured git settings.
</objective>

<execution_context>
@C:\Users\Mario Giacchino\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\Mario Giacchino\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/34-german-umlaut-correction/34-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Git and EditorConfig setup</name>
  <files>.editorconfig</files>
  <action>
1. Set git config for proper UTF-8 display:
   ```bash
   git config core.quotepath false
   ```

2. Create `.editorconfig` at project root with UTF-8 charset enforcement:
   ```ini
   root = true

   [*]
   charset = utf-8
   end_of_line = lf
   insert_final_newline = true
   trim_trailing_whitespace = true

   [*.{ts,tsx,js,jsx,json,sql}]
   charset = utf-8
   indent_style = space
   indent_size = 2

   [*.md]
   trim_trailing_whitespace = false
   ```

3. Verify git config was set correctly.
  </action>
  <verify>
- `git config --get core.quotepath` returns `false`
- `.editorconfig` file exists with `charset = utf-8` content
  </verify>
  <done>Git configured for UTF-8 display, EditorConfig enforces UTF-8 charset for all editors</done>
</task>

<task type="auto">
  <name>Task 2: Encoding verification script</name>
  <files>scripts/verify-encoding.ts</files>
  <action>
1. Install chardet dev dependency:
   ```bash
   npm install --save-dev chardet
   ```

2. Create `scripts/verify-encoding.ts` that:
   - Uses chardet to detect file encoding
   - Scans all source files: `src/**/*.{ts,tsx}`, `supabase/**/*.sql`, `scripts/**/*.ts`
   - Ignores node_modules, .next, dist
   - Reports each file's detected encoding
   - Exits with code 0 if all files are UTF-8 or ASCII (ASCII is valid subset)
   - Exits with code 1 if any file has non-UTF-8 encoding
   - Prints summary: total files checked, valid count, invalid count

3. Add npm script to package.json: `"verify:encoding": "npx tsx scripts/verify-encoding.ts"`

4. Run the script to verify current codebase encoding.
  </action>
  <verify>
- `npm run verify:encoding` runs without errors
- Script output shows all files are UTF-8 or ASCII
- Exit code is 0
  </verify>
  <done>Encoding verification script confirms all source files are UTF-8/ASCII compatible</done>
</task>

<task type="auto">
  <name>Task 3: Database collation verification</name>
  <files>scripts/check-db-collation.sql</files>
  <action>
1. Create `scripts/check-db-collation.sql` with queries to:
   - Check database encoding (should be UTF8)
   - Check database collation (lc_collate, lc_ctype)
   - List available German collations (de_DE or ICU equivalents)
   - Test German sort order with sample data (Apfel, Aerger, Zucker, Aenderung)
   - Check if any text columns use non-default collation

2. Run the SQL against the Supabase database:
   ```bash
   npx supabase db dump --db-url "$DATABASE_URL" --schema information_schema -f /dev/null 2>/dev/null
   # If connection works, run the collation check
   psql "$DATABASE_URL" -f scripts/check-db-collation.sql
   ```

   Note: If DATABASE_URL not available locally, use Supabase dashboard SQL editor or document for manual verification.

3. Document results in output - especially:
   - Is encoding UTF8? (required)
   - What is the default collation?
   - Is de_DE collation available?
   - How does German text sort with current collation?
  </action>
  <verify>
- `scripts/check-db-collation.sql` exists with proper queries
- Database encoding confirmed as UTF8 (via SQL execution or documented for manual check)
- German sorting behavior documented
  </verify>
  <done>Database collation verified as UTF-8, German sorting behavior documented</done>
</task>

</tasks>

<verification>
All three infrastructure pieces in place:
1. Git config: `git config --get core.quotepath` returns `false`
2. EditorConfig: `.editorconfig` exists with `charset = utf-8`
3. Encoding script: `npm run verify:encoding` passes with exit code 0
4. Database SQL: `scripts/check-db-collation.sql` exists with collation queries
</verification>

<success_criteria>
- Git displays umlauts correctly (no \nnn escape sequences in diffs)
- All 400+ source files verified as UTF-8/ASCII compatible
- Database confirmed as UTF-8 encoded
- Future files will have UTF-8 enforced by EditorConfig
</success_criteria>

<output>
After completion, create `.planning/phases/34-german-umlaut-correction/34-01-SUMMARY.md`
</output>
