---
phase: 13-partner-modul
plan: 03
type: execute
wave: 2
depends_on: ["13-01"]
files_modified:
  - src/components/partners/PartnerForm.tsx
  - src/app/dashboard/partner/page.tsx
autonomous: true

must_haves:
  truths:
    - "Admin can create new partner with all required fields"
    - "Admin can edit existing partner data"
    - "Form validates company name is required"
    - "Form validates email format for contractors"
    - "Form allows selecting multiple trade categories"
    - "Form changes persist to database"
  artifacts:
    - path: "src/components/partners/PartnerForm.tsx"
      provides: "Partner create/edit form component"
      min_lines: 150
    - path: "src/app/dashboard/partner/page.tsx"
      provides: "Partner page with form modal integration"
      contains: "PartnerForm"
  key_links:
    - from: "src/components/partners/PartnerForm.tsx"
      to: "/api/partners"
      via: "fetch POST for create, PATCH for update"
      pattern: "fetch.*api/partners"
    - from: "src/app/dashboard/partner/page.tsx"
      to: "PartnerForm"
      via: "modal rendering"
      pattern: "showForm.*PartnerForm"
---

<objective>
Build Partner create/edit form with validation for all required fields.

Purpose: Fulfill PART-02 and PART-03 requirements - "Admin kann neuen Partner erstellen" and "Admin kann Partner-Daten bearbeiten." The form handles both create and edit modes with proper validation.

Output: PartnerForm component with validation, integrated into Partner dashboard page as modal.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/13-partner-modul/13-RESEARCH.md

# API routes
@.planning/phases/13-partner-modul/13-01-SUMMARY.md

# Existing form patterns
@src/components/work-orders/WorkOrderForm.tsx

# Type definitions
@src/types/database.ts (Partner, TradeCategory)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create PartnerForm component</name>
  <files>src/components/partners/PartnerForm.tsx</files>
  <action>
Create PartnerForm component following WorkOrderForm.tsx pattern exactly:

```typescript
'use client'

import { useState } from 'react'
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card'
import { Button } from '@/components/ui/button'
import { Input } from '@/components/ui/input'
import type { Partner, PartnerType, TradeCategory } from '@/types'

// Trade category options with German labels
const TRADE_CATEGORIES: { value: TradeCategory; label: string }[] = [
  { value: 'general', label: 'Allgemein' },
  { value: 'plumbing', label: 'Sanitaer' },
  { value: 'electrical', label: 'Elektro' },
  { value: 'hvac', label: 'Heizung/Lueftung' },
  { value: 'painting', label: 'Malerarbeiten' },
  { value: 'flooring', label: 'Bodenbelaege' },
  { value: 'carpentry', label: 'Schreinerei' },
  { value: 'roofing', label: 'Dachdecker' },
  { value: 'masonry', label: 'Maurer' },
  { value: 'glazing', label: 'Glaser' },
  { value: 'landscaping', label: 'Gartenbau' },
  { value: 'cleaning', label: 'Reinigung' },
  { value: 'demolition', label: 'Abbruch' },
  { value: 'other', label: 'Sonstige' },
]

interface PartnerFormProps {
  mode: 'create' | 'edit'
  partner?: Partner
  onSave: (partner: Partner) => void
  onCancel: () => void
}
```

**Form state (all as individual useState):**
- partnerType: PartnerType (default 'contractor')
- companyName: string
- contactName: string
- email: string
- phone: string
- address: string
- tradeCategories: TradeCategory[]
- isActive: boolean (default true for create)
- notes: string
- saving: boolean
- errors: Record<string, string>

**Validation function:**
```typescript
function validate(): boolean {
  const newErrors: Record<string, string> = {}

  if (!companyName.trim()) {
    newErrors.companyName = 'Bitte geben Sie einen Firmennamen ein'
  }

  // Email required for contractors
  if (partnerType === 'contractor') {
    if (!email.trim()) {
      newErrors.email = 'E-Mail ist fuer Handwerker erforderlich'
    } else if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
      newErrors.email = 'Bitte geben Sie eine gueltige E-Mail-Adresse ein'
    }
  } else if (email.trim() && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
    newErrors.email = 'Bitte geben Sie eine gueltige E-Mail-Adresse ein'
  }

  if (partnerType === 'contractor' && tradeCategories.length === 0) {
    newErrors.tradeCategories = 'Bitte waehlen Sie mindestens ein Gewerk'
  }

  setErrors(newErrors)
  return Object.keys(newErrors).length === 0
}
```

**Submit handler:**
- Prevent default, call validate()
- Build input object with all fields
- POST to /api/partners for create, PATCH to /api/partners/{id} for edit
- Handle response errors, show in errors.submit
- Call onSave(partner) on success

**Form fields:**
1. Partner type: Radio buttons (Handwerker / Lieferant)
2. Company name: Input (required)
3. Contact name: Input
4. Email: Input type="email" (required for contractors)
5. Phone: Input type="tel"
6. Address: Textarea
7. Trade categories: Checkbox grid (2 columns) - only show for contractors
8. Notes: Textarea
9. Active status: Checkbox (only in edit mode)

**Error display:**
- Show field-level errors below each input
- Show submit error at bottom

**Buttons:**
- Cancel button (calls onCancel)
- Save button (submits form, shows loading state)
  </action>
  <verify>
```bash
# Check TypeScript compilation
npx tsc --noEmit src/components/partners/PartnerForm.tsx

# Verify component structure
grep -n "useState\|validate\|handleSubmit" src/components/partners/PartnerForm.tsx
```
  </verify>
  <done>PartnerForm component handles create/edit with validation for all fields.</done>
</task>

<task type="auto">
  <name>Task 2: Integrate PartnerForm into Partner page</name>
  <files>src/app/dashboard/partner/page.tsx</files>
  <action>
Update Partner dashboard page to include PartnerForm modal:

**Add imports:**
```typescript
import { PartnerForm } from '@/components/partners/PartnerForm'
```

**Update state:**
```typescript
const [showForm, setShowForm] = useState(false)
const [editingPartner, setEditingPartner] = useState<Partner | null>(null)
const [refreshKey, setRefreshKey] = useState(0) // For forcing list refresh
```

**Handlers:**
```typescript
function handleCreate() {
  setEditingPartner(null)
  setShowForm(true)
}

function handleEdit(partner: Partner) {
  setEditingPartner(partner)
  setShowForm(true)
}

function handleSave(partner: Partner) {
  setShowForm(false)
  setEditingPartner(null)
  setRefreshKey(prev => prev + 1) // Trigger list refresh
}

function handleCancel() {
  setShowForm(false)
  setEditingPartner(null)
}
```

**Update PartnerList:**
- Pass refreshKey as key prop to force remount on save
- Pass onEdit={handleEdit}

**Modal overlay:**
```tsx
{showForm && (
  <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
    <div className="bg-white dark:bg-gray-900 rounded-lg shadow-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
      <PartnerForm
        mode={editingPartner ? 'edit' : 'create'}
        partner={editingPartner || undefined}
        onSave={handleSave}
        onCancel={handleCancel}
      />
    </div>
  </div>
)}
```

**Header button:**
- Update "Neuer Partner" button to call handleCreate()
  </action>
  <verify>
```bash
# Check TypeScript compilation
npx tsc --noEmit src/app/dashboard/partner/page.tsx

# Verify PartnerForm integration
grep -n "PartnerForm\|showForm\|handleCreate\|handleEdit" src/app/dashboard/partner/page.tsx
```
  </verify>
  <done>Partner page shows form modal for create/edit, list refreshes on save.</done>
</task>

</tasks>

<verification>
After all tasks complete:

1. **Create flow:**
   - Visit /dashboard/partner
   - Click "Neuer Partner"
   - Fill form: partner type, company name, email, trades
   - Submit and verify partner appears in list

2. **Validation:**
   - Try submitting empty form - should show errors
   - Select contractor, leave email empty - should require email
   - Select supplier, leave email empty - should allow

3. **Edit flow:**
   - Click edit on existing partner
   - Change company name
   - Save and verify change persists

4. **Trade categories:**
   - Select multiple trades
   - Save and verify all trades saved
   - Edit and verify trades pre-selected

5. **TypeScript:** `npx tsc --noEmit` passes
</verification>

<success_criteria>
- [ ] PartnerForm renders in modal
- [ ] Create mode works with all fields
- [ ] Edit mode pre-fills existing data
- [ ] Company name validation works
- [ ] Email required for contractors, optional for suppliers
- [ ] Email format validation works
- [ ] Trade categories multi-select works
- [ ] Form submission creates/updates partner
- [ ] List refreshes after save
- [ ] Cancel closes modal without saving
- [ ] TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/13-partner-modul/13-03-SUMMARY.md`
</output>
