---
phase: 13-partner-modul
plan: 04
type: execute
wave: 2
depends_on: ["13-01"]
files_modified:
  - src/components/work-orders/WorkOrderForm.tsx
autonomous: true

must_haves:
  truths:
    - "WorkOrderForm partner dropdown shows active contractors only"
    - "Selected partner is saved when work order is created"
    - "Partner dropdown filters by trade category when task is selected"
    - "Dropdown shows company name for each partner"
  artifacts:
    - path: "src/components/work-orders/WorkOrderForm.tsx"
      provides: "Work order form with functional partner dropdown"
      contains: "partnerId"
  key_links:
    - from: "src/components/work-orders/WorkOrderForm.tsx"
      to: "/api/partners?type=contractor&is_active=true"
      via: "fetch in loadData"
      pattern: "fetch.*api/partners.*is_active=true"
---

<objective>
Integrate partner dropdown into WorkOrderForm to complete the partner-workorder connection.

Purpose: Fulfill PART-05 requirement - "Partner-Dropdown in WorkOrderForm zeigt verfuegbare Partner." WorkOrderForm already has partner loading logic (lines 156-162) but the API route didn't exist. Now that /api/partners exists, verify and enhance the integration.

Output: Functional partner dropdown in WorkOrderForm that loads active contractors and saves selection.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/13-partner-modul/13-RESEARCH.md

# API routes
@.planning/phases/13-partner-modul/13-01-SUMMARY.md

# Existing form to update
@src/components/work-orders/WorkOrderForm.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Verify and enhance partner dropdown in WorkOrderForm</name>
  <files>src/components/work-orders/WorkOrderForm.tsx</files>
  <action>
Review and update WorkOrderForm.tsx partner integration:

**1. Verify partner fetch (lines 156-162):**
The existing code fetches from `/api/partners?type=contractor`. Update to also filter by active status:

```typescript
// Load partners (active contractors only)
const partnersRes = await fetch('/api/partners?type=contractor&is_active=true')
if (partnersRes.ok) {
  const data = await partnersRes.json()
  setPartners(data.partners || [])
  setFilteredPartners(data.partners || [])
}
```

**2. Verify partner dropdown renders:**
Check that the partner select element exists and displays partner.company_name as the label. If not present, add:

```tsx
<div className="w-full">
  <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
    Handwerker *
  </label>
  <select
    value={partnerId}
    onChange={(e) => setPartnerId(e.target.value)}
    className="w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded-lg bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-blue-500 focus:border-transparent"
    required
  >
    <option value="">Handwerker auswaehlen...</option>
    {filteredPartners.map((partner) => (
      <option key={partner.id} value={partner.id}>
        {partner.company_name}
        {partner.trade_categories?.length > 0 && ` (${partner.trade_categories.join(', ')})`}
      </option>
    ))}
  </select>
  {errors.partner && (
    <p className="mt-1 text-sm text-red-500">{errors.partner}</p>
  )}
</div>
```

**3. Verify trade category filtering:**
If a task is selected and has a trade_category, filter partners to those with matching trade:

```typescript
// Filter partners by selected task's trade category
useEffect(() => {
  if (taskId && tasks.length > 0) {
    const selectedTask = tasks.find(t => t.id === taskId)
    if (selectedTask?.trade_category) {
      const filtered = partners.filter(p =>
        p.trade_categories?.includes(selectedTask.trade_category)
      )
      setFilteredPartners(filtered.length > 0 ? filtered : partners)
    } else {
      setFilteredPartners(partners)
    }
  } else {
    setFilteredPartners(partners)
  }
}, [taskId, tasks, partners])
```

**4. Verify partnerId is included in submission:**
Check that the form submission includes partner_id in the request body:

```typescript
const workOrderData = {
  // ... other fields
  partner_id: partnerId,
  // ...
}
```

**5. Verify validation:**
Ensure partnerId is validated as required in the validate() function:

```typescript
if (!partnerId) {
  newErrors.partner = 'Bitte waehlen Sie einen Handwerker'
}
```

**Important:** Do NOT restructure the entire form. Only verify and fix the partner-related code. The form already works, we just need to ensure partner integration is complete now that the API exists.
  </action>
  <verify>
```bash
# Check TypeScript compilation
npx tsc --noEmit src/components/work-orders/WorkOrderForm.tsx

# Verify partner integration points
grep -n "partnerId\|partner_id\|partners\|filteredPartners" src/components/work-orders/WorkOrderForm.tsx

# Test the form manually:
# 1. Visit /dashboard/auftraege/neu
# 2. Verify partner dropdown loads options
# 3. Select a partner and create work order
# 4. Verify partner_id is saved
```
  </verify>
  <done>WorkOrderForm loads active contractors in dropdown and saves selected partner to work order.</done>
</task>

</tasks>

<verification>
After task completes:

1. **Partner dropdown loads:**
   - Visit /dashboard/auftraege/neu
   - Verify partner dropdown shows active contractors
   - Check browser network tab: GET /api/partners?type=contractor&is_active=true returns data

2. **Trade filtering (if applicable):**
   - Select a task with a trade_category
   - Verify partner dropdown filters to matching trades (or shows all if no matches)

3. **Work order creation:**
   - Fill out complete work order form
   - Select a partner
   - Submit form
   - Verify work order is created with correct partner_id

4. **Validation:**
   - Try submitting without selecting partner
   - Should show validation error

5. **TypeScript:** `npx tsc --noEmit` passes
</verification>

<success_criteria>
- [ ] GET /api/partners?type=contractor&is_active=true called on form load
- [ ] Partner dropdown shows company names
- [ ] Inactive partners are NOT shown
- [ ] Suppliers are NOT shown (only contractors)
- [ ] Selected partner_id included in work order submission
- [ ] Validation requires partner selection
- [ ] Work order saves with correct partner_id
- [ ] TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/13-partner-modul/13-04-SUMMARY.md`
</output>
