---
phase: 18-knowledge-base
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/048_knowledge_base.sql
  - src/types/knowledge-base.ts
  - src/app/api/knowledge/route.ts
  - src/app/api/knowledge/[id]/route.ts
  - src/app/api/knowledge/categories/route.ts
autonomous: true

must_haves:
  truths:
    - "Database has kb_articles table with all required fields"
    - "Database has kb_categories table with two-level hierarchy enforcement"
    - "TypeScript types exist for articles, categories, and API operations"
    - "API endpoints accept and return properly typed data"
  artifacts:
    - path: "supabase/migrations/048_knowledge_base.sql"
      provides: "Knowledge base schema with FTS, versioning triggers, workflow validation"
      contains: "CREATE TABLE kb_articles"
    - path: "src/types/knowledge-base.ts"
      provides: "TypeScript types for KB entities and API"
      exports: ["KBArticle", "KBCategory", "KBArticleInput", "KBArticleStatus"]
    - path: "src/app/api/knowledge/route.ts"
      provides: "Article list and create endpoints"
      exports: ["GET", "POST"]
    - path: "src/app/api/knowledge/[id]/route.ts"
      provides: "Article read, update, delete endpoints"
      exports: ["GET", "PUT", "DELETE"]
    - path: "src/app/api/knowledge/categories/route.ts"
      provides: "Category list and create endpoints"
      exports: ["GET", "POST"]
  key_links:
    - from: "src/app/api/knowledge/route.ts"
      to: "kb_articles table"
      via: "Supabase client insert/select"
      pattern: "supabase.*kb_articles"
    - from: "src/types/knowledge-base.ts"
      to: "048_knowledge_base.sql"
      via: "Type definitions mirror schema"
      pattern: "KBArticle.*status.*KBArticleStatus"
---

<objective>
Create the database foundation for the knowledge base: schema with full-text search indexes, version history triggers, workflow state machine, and two-level category hierarchy. Establish TypeScript types and basic API scaffolding.

Purpose: Foundation layer that all subsequent KB plans depend on. Without schema and types, no UI or business logic can be built.
Output: Migration file, type definitions, and working API endpoints for basic CRUD.
</objective>

<execution_context>
@C:\Users\Mario Giacchino\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\Mario Giacchino\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/18-knowledge-base/18-CONTEXT.md
@.planning/phases/18-knowledge-base/18-RESEARCH.md
@supabase/migrations/015_media.sql
@src/types/database.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create knowledge base database schema</name>
  <files>supabase/migrations/048_knowledge_base.sql</files>
  <action>
Create migration file with:

1. **Enable pg_trgm extension** for fuzzy search:
   ```sql
   CREATE EXTENSION IF NOT EXISTS pg_trgm;
   ```

2. **Article status enum**:
   ```sql
   CREATE TYPE kb_article_status AS ENUM ('draft', 'review', 'published', 'archived');
   CREATE TYPE kb_article_visibility AS ENUM ('internal', 'contractors', 'both');
   CREATE TYPE kb_article_template AS ENUM ('faq', 'howto', 'policy');
   ```

3. **Categories table** with two-level hierarchy:
   - id (UUID PK)
   - name (TEXT NOT NULL)
   - description (TEXT)
   - icon (TEXT) -- lucide-react icon name
   - parent_id (UUID FK to self, NULL for top-level)
   - path (TEXT NOT NULL) -- materialized path
   - level (INTEGER CHECK IN (1,2))
   - sort_order (INTEGER DEFAULT 0)
   - created_at (TIMESTAMPTZ)
   - Add trigger `enforce_category_depth` to validate max 2 levels and auto-set path/level

4. **Articles table**:
   - id (UUID PK)
   - title (TEXT NOT NULL)
   - content (JSONB NOT NULL) -- Tiptap JSON
   - template (kb_article_template NOT NULL)
   - status (kb_article_status DEFAULT 'draft')
   - visibility (kb_article_visibility DEFAULT 'internal')
   - category_id (UUID FK to kb_categories)
   - tags (TEXT[])
   - author_id (UUID FK to users NOT NULL)
   - last_reviewed_at (TIMESTAMPTZ)
   - expiry_date (DATE)
   - view_count (INTEGER DEFAULT 0)
   - version (INTEGER DEFAULT 1)
   - created_at, updated_at (TIMESTAMPTZ)
   - updated_by (UUID FK to users)
   - search_vector (tsvector GENERATED ALWAYS AS weighted combination of title/content/tags)
   - GIN index on search_vector

5. **Article history table** for versioning:
   - history_id (UUID PK)
   - article_id (UUID FK)
   - version (INTEGER)
   - title, content, status (snapshots)
   - changed_at (TIMESTAMPTZ)
   - changed_by (UUID FK)
   - change_type (TEXT: INSERT, UPDATE, DELETE)

6. **Version trigger** `kb_articles_version_trigger`:
   - On INSERT: create history record with change_type='INSERT'
   - On UPDATE: create history record with OLD values, increment version

7. **Workflow transition table**:
   - id, article_id, from_status, to_status, transitioned_by, transitioned_at, comment

8. **Workflow validation trigger** `validate_article_transition`:
   - Enforce: draft->review, review->published, review->draft, published->archived, draft->archived
   - Log transition in kb_workflow_transitions

9. **Dashboard shortcuts table** (for pinning):
   - id (UUID PK)
   - user_id (UUID FK)
   - article_id (UUID FK)
   - created_at (TIMESTAMPTZ)
   - UNIQUE(user_id, article_id)

10. **Indexes**:
    - GIN on search_vector (CONCURRENTLY if possible, else standard)
    - GIN on tags
    - btree on category_id
    - btree on status
    - btree on visibility

11. **Seed default category** "General" with path='/general', level=1

Follow existing migration patterns from 015_media.sql for style consistency.
  </action>
  <verify>
Run `npm run type-check` to ensure no TypeScript errors.
Verify migration syntax by reading the file and checking for SQL syntax issues.
  </verify>
  <done>
Migration file exists with all tables, triggers, and indexes. Schema supports FTS, version history, workflow validation, and two-level categories.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create TypeScript types for knowledge base</name>
  <files>src/types/knowledge-base.ts</files>
  <action>
Create type definitions mirroring the database schema:

```typescript
// Status and visibility enums
export type KBArticleStatus = 'draft' | 'review' | 'published' | 'archived'
export type KBArticleVisibility = 'internal' | 'contractors' | 'both'
export type KBArticleTemplate = 'faq' | 'howto' | 'policy'

// Category types
export interface KBCategory {
  id: string
  name: string
  description: string | null
  icon: string | null
  parent_id: string | null
  path: string
  level: number
  sort_order: number
  created_at: string
}

export interface KBCategoryWithCount extends KBCategory {
  article_count: number
  children?: KBCategoryWithCount[]
}

// Article types
export interface KBArticle {
  id: string
  title: string
  content: Record<string, unknown> // Tiptap JSON
  template: KBArticleTemplate
  status: KBArticleStatus
  visibility: KBArticleVisibility
  category_id: string | null
  tags: string[]
  author_id: string
  last_reviewed_at: string | null
  expiry_date: string | null
  view_count: number
  version: number
  created_at: string
  updated_at: string
  updated_by: string | null
}

export interface KBArticleWithMeta extends KBArticle {
  author_name: string
  category_name: string | null
}

export interface KBArticleHistory {
  history_id: string
  article_id: string
  version: number
  title: string
  content: Record<string, unknown>
  status: KBArticleStatus
  changed_at: string
  changed_by: string
  change_type: 'INSERT' | 'UPDATE' | 'DELETE'
  changed_by_name?: string
}

// API input types
export interface CreateKBArticleInput {
  title: string
  content: Record<string, unknown>
  template: KBArticleTemplate
  category_id?: string
  tags?: string[]
  visibility?: KBArticleVisibility
}

export interface UpdateKBArticleInput {
  title?: string
  content?: Record<string, unknown>
  category_id?: string | null
  tags?: string[]
  visibility?: KBArticleVisibility
  status?: KBArticleStatus
  last_reviewed_at?: string
  expiry_date?: string | null
}

export interface CreateKBCategoryInput {
  name: string
  description?: string
  icon?: string
  parent_id?: string
  sort_order?: number
}

// Search types
export interface KBSearchResult {
  id: string
  title: string
  snippet: string
  rank: number
  category_id: string | null
  category_name: string | null
  updated_at: string
  author_name: string
}

export interface KBSearchFilters {
  categoryId?: string
  audience?: KBArticleVisibility
  author?: string
  dateFrom?: string
  dateTo?: string
}

// Dashboard shortcut
export interface KBDashboardShortcut {
  id: string
  user_id: string
  article_id: string
  created_at: string
  article?: KBArticleWithMeta
}

// API response types
export interface KBArticlesResponse {
  articles: KBArticleWithMeta[]
}

export interface KBArticleResponse {
  article: KBArticleWithMeta
}

export interface KBCategoriesResponse {
  categories: KBCategoryWithCount[]
}

export interface KBSearchResponse {
  results: KBSearchResult[]
  total: number
}
```

Follow existing type patterns from src/types/database.ts.
  </action>
  <verify>
Run `npm run type-check` - should pass with no errors.
  </verify>
  <done>
Type file exists with all entity types, input types, and response types properly defined.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create API routes for articles and categories</name>
  <files>
    src/app/api/knowledge/route.ts
    src/app/api/knowledge/[id]/route.ts
    src/app/api/knowledge/categories/route.ts
  </files>
  <action>
Create API routes following existing patterns from src/app/api/tasks/route.ts:

**src/app/api/knowledge/route.ts** (list + create articles):
```typescript
// GET /api/knowledge
// Query params: ?status=draft|review|published, ?category_id=uuid, ?visibility=internal|contractors|both
// Returns: { articles: KBArticleWithMeta[] }
// Auth: x-user-id, x-user-role headers

// POST /api/knowledge
// Body: CreateKBArticleInput
// Returns: { article: KBArticle }
// Sets author_id from x-user-id header
```

**src/app/api/knowledge/[id]/route.ts** (single article CRUD):
```typescript
// GET /api/knowledge/[id]
// Returns: { article: KBArticleWithMeta }
// Increments view_count

// PUT /api/knowledge/[id]
// Body: UpdateKBArticleInput
// Returns: { article: KBArticle }
// Sets updated_by from x-user-id header

// DELETE /api/knowledge/[id]
// Returns: { success: true }
// Only allowed for draft articles or by admin
```

**src/app/api/knowledge/categories/route.ts**:
```typescript
// GET /api/knowledge/categories
// Query params: ?include_empty=true (for admin)
// Returns: { categories: KBCategoryWithCount[] } as tree structure

// POST /api/knowledge/categories (admin only)
// Body: CreateKBCategoryInput
// Returns: { category: KBCategory }
```

For each route:
1. Validate auth headers (401 if missing)
2. Use createClient from @/lib/supabase/server
3. Join with users table for author_name
4. Join with kb_categories for category_name
5. Return typed responses with proper error handling
6. Log errors with context: console.error('Error in GET /api/knowledge:', error)
  </action>
  <verify>
Run `npm run type-check` - should pass.
Run `npm run lint` - should pass with no errors.
  </verify>
  <done>
Three API route files exist with GET/POST/PUT/DELETE handlers, proper auth validation, and typed responses.
  </done>
</task>

</tasks>

<verification>
- [ ] Migration file contains all tables (kb_articles, kb_categories, kb_articles_history, kb_workflow_transitions, kb_dashboard_shortcuts)
- [ ] Migration includes version trigger and workflow validation trigger
- [ ] Migration includes GIN index on search_vector
- [ ] Types file exports all required interfaces
- [ ] API routes return proper TypeScript types
- [ ] `npm run type-check` passes
- [ ] `npm run lint` passes
</verification>

<success_criteria>
1. Database migration is valid SQL and creates all required structures
2. TypeScript types are complete and match schema
3. API endpoints compile without type errors
4. Foundation is ready for UI layer in Plan 02
</success_criteria>

<output>
After completion, create `.planning/phases/18-knowledge-base/18-01-SUMMARY.md`
</output>
