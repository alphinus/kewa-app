---
phase: 18-knowledge-base
plan: 05
type: execute
wave: 3
depends_on: ["18-02", "18-03"]
files_modified:
  - src/components/knowledge/VersionHistory.tsx
  - src/components/knowledge/RelatedArticles.tsx
  - src/components/knowledge/DashboardShortcuts.tsx
  - src/app/api/knowledge/[id]/history/route.ts
  - src/app/api/knowledge/[id]/pin/route.ts
  - src/app/api/knowledge/related/route.ts
  - src/app/contractor/[token]/knowledge/page.tsx
  - src/app/contractor/[token]/knowledge/[id]/page.tsx
  - src/app/dashboard/page.tsx
autonomous: true

must_haves:
  truths:
    - "User can view article version history"
    - "User can see who last updated an article"
    - "User can pin articles to dashboard shortcuts"
    - "Contractor can view contractor-visible articles in portal"
    - "Related articles appear automatically based on content similarity"
  artifacts:
    - path: "src/components/knowledge/VersionHistory.tsx"
      provides: "Version history list with diff view"
      min_lines: 50
    - path: "src/app/contractor/[token]/knowledge/page.tsx"
      provides: "Contractor portal KB page"
      exports: ["default"]
    - path: "src/app/api/knowledge/[id]/history/route.ts"
      provides: "Version history API"
      exports: ["GET"]
    - path: "src/app/api/knowledge/[id]/pin/route.ts"
      provides: "Dashboard pin/unpin API"
      exports: ["POST", "DELETE"]
  key_links:
    - from: "src/components/knowledge/VersionHistory.tsx"
      to: "/api/knowledge/[id]/history"
      via: "fetch GET"
      pattern: "fetch.*history"
    - from: "src/app/contractor/[token]/knowledge/page.tsx"
      to: "/api/knowledge"
      via: "fetch with visibility filter"
      pattern: "visibility.*contractors"
    - from: "src/app/dashboard/page.tsx"
      to: "kb_dashboard_shortcuts"
      via: "fetch pinned articles"
      pattern: "shortcuts|pinned"
---

<objective>
Complete the knowledge base with version history viewing, automatic related articles, contractor portal access, and dashboard shortcuts. Users can track changes, contractors can access FAQs, and users can pin important articles to their dashboard.

Purpose: Final features for complete KB functionality - auditability (version history), discoverability (related articles), external access (contractor portal), and quick access (dashboard shortcuts).
Output: Version history UI, related articles component, contractor portal pages, dashboard shortcuts widget.
</objective>

<execution_context>
@C:\Users\Mario Giacchino\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\Mario Giacchino\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/18-knowledge-base/18-CONTEXT.md
@.planning/phases/18-knowledge-base/18-RESEARCH.md
@.planning/phases/18-knowledge-base/18-01-SUMMARY.md
@.planning/phases/18-knowledge-base/18-02-SUMMARY.md
@.planning/phases/18-knowledge-base/18-03-SUMMARY.md
@src/types/knowledge-base.ts
@src/app/contractor/[token]/page.tsx
@src/app/dashboard/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create version history UI and API</name>
  <files>
    src/components/knowledge/VersionHistory.tsx
    src/app/api/knowledge/[id]/history/route.ts
  </files>
  <action>
**src/components/knowledge/VersionHistory.tsx**:
```typescript
'use client'

import { useState, useEffect } from 'react'
import { Clock, User, ChevronDown, ChevronRight } from 'lucide-react'
import { formatSwissDate } from '@/lib/utils'
import type { KBArticleHistory } from '@/types/knowledge-base'

interface VersionHistoryProps {
  articleId: string
}

export function VersionHistory({ articleId }: VersionHistoryProps) {
  const [history, setHistory] = useState<KBArticleHistory[]>([])
  const [loading, setLoading] = useState(true)
  const [expandedVersion, setExpandedVersion] = useState<number | null>(null)

  useEffect(() => {
    fetch(`/api/knowledge/${articleId}/history`)
      .then(res => res.json())
      .then(data => setHistory(data.history || []))
      .finally(() => setLoading(false))
  }, [articleId])

  // Display list of versions (most recent first)
  // Each version shows: version number, changed_by name, changed_at date, change_type
  // Expandable to show title at that version
  // Optional: simple diff view comparing to current (highlight changes)

  return (
    <div className="space-y-2">
      <h3 className="font-semibold text-sm flex items-center gap-2">
        <Clock className="w-4 h-4" />
        Versionshistorie
      </h3>

      {loading ? (
        <p className="text-sm text-gray-500">Laden...</p>
      ) : history.length === 0 ? (
        <p className="text-sm text-gray-500">Keine Aenderungen</p>
      ) : (
        <ul className="space-y-1">
          {history.map(entry => (
            <li key={entry.history_id} className="text-sm">
              <button
                onClick={() => setExpandedVersion(
                  expandedVersion === entry.version ? null : entry.version
                )}
                className="flex items-center gap-2 w-full text-left hover:bg-gray-50 dark:hover:bg-gray-800 p-2 rounded"
              >
                {expandedVersion === entry.version ? (
                  <ChevronDown className="w-3 h-3" />
                ) : (
                  <ChevronRight className="w-3 h-3" />
                )}
                <span className="font-mono">v{entry.version}</span>
                <span className="text-gray-500">
                  {entry.changed_by_name} - {formatSwissDate(entry.changed_at)}
                </span>
                <span className={cn(
                  'text-xs px-1 rounded',
                  entry.change_type === 'INSERT' && 'bg-green-100 text-green-800',
                  entry.change_type === 'UPDATE' && 'bg-blue-100 text-blue-800',
                )}>
                  {entry.change_type === 'INSERT' ? 'Erstellt' : 'Bearbeitet'}
                </span>
              </button>
              {expandedVersion === entry.version && (
                <div className="ml-6 p-2 bg-gray-50 dark:bg-gray-800 rounded text-xs">
                  <p><strong>Titel:</strong> {entry.title}</p>
                  <p><strong>Status:</strong> {entry.status}</p>
                </div>
              )}
            </li>
          ))}
        </ul>
      )}
    </div>
  )
}
```

**src/app/api/knowledge/[id]/history/route.ts**:
```typescript
// GET /api/knowledge/[id]/history
// Returns: { history: KBArticleHistory[] }

// Validate auth
// Query kb_articles_history for article_id
// Join with users for changed_by_name
// Order by version DESC
// Return history array
```

Add VersionHistory component to article view page (in sidebar or expandable section).
  </action>
  <verify>
Run `npm run type-check` - should pass.
Run `npm run lint` - should pass.
  </verify>
  <done>
VersionHistory displays version list with expandable details. History API returns versions with user names.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create related articles and dashboard shortcuts</name>
  <files>
    src/components/knowledge/RelatedArticles.tsx
    src/components/knowledge/DashboardShortcuts.tsx
    src/app/api/knowledge/related/route.ts
    src/app/api/knowledge/[id]/pin/route.ts
    src/app/dashboard/page.tsx
  </files>
  <action>
**src/components/knowledge/RelatedArticles.tsx**:
```typescript
'use client'

import { useState, useEffect } from 'react'
import Link from 'next/link'
import { FileText } from 'lucide-react'

interface RelatedArticlesProps {
  articleId: string
  limit?: number
}

export function RelatedArticles({ articleId, limit = 5 }: RelatedArticlesProps) {
  const [related, setRelated] = useState<Array<{
    id: string
    title: string
    category_name: string | null
  }>>([])
  const [loading, setLoading] = useState(true)

  useEffect(() => {
    fetch(`/api/knowledge/related?article_id=${articleId}&limit=${limit}`)
      .then(res => res.json())
      .then(data => setRelated(data.articles || []))
      .finally(() => setLoading(false))
  }, [articleId, limit])

  // Display list of related article links
  // Show title and category
  // Empty state: "Keine verwandten Artikel"

  return (
    <div className="space-y-2">
      <h3 className="font-semibold text-sm">Verwandte Artikel</h3>
      {/* Article links */}
    </div>
  )
}
```

**src/app/api/knowledge/related/route.ts**:
```typescript
// GET /api/knowledge/related?article_id=uuid&limit=5
// Returns: { articles: [{ id, title, category_name, similarity_score }] }

// Use tsvector overlap for similarity (simplified approach from RESEARCH.md)
// Query articles with same category first, then by content similarity
// Exclude the current article
// Filter to published status
// Limit results
```

**src/components/knowledge/DashboardShortcuts.tsx**:
```typescript
'use client'

import { useState, useEffect } from 'react'
import Link from 'next/link'
import { FileText, X, Pin } from 'lucide-react'
import { Button } from '@/components/ui/button'

export function DashboardShortcuts() {
  const [shortcuts, setShortcuts] = useState<Array<{
    id: string
    article_id: string
    article: { id: string; title: string; category_name: string }
  }>>([])

  useEffect(() => {
    fetch('/api/knowledge/shortcuts')
      .then(res => res.json())
      .then(data => setShortcuts(data.shortcuts || []))
  }, [])

  const removeShortcut = async (shortcutId: string, articleId: string) => {
    await fetch(`/api/knowledge/${articleId}/pin`, { method: 'DELETE' })
    setShortcuts(shortcuts.filter(s => s.id !== shortcutId))
  }

  if (shortcuts.length === 0) return null

  return (
    <div className="space-y-2">
      <h3 className="font-semibold text-sm flex items-center gap-2">
        <Pin className="w-4 h-4" />
        Angepinnte Artikel
      </h3>
      <ul className="space-y-1">
        {shortcuts.map(shortcut => (
          <li key={shortcut.id} className="flex items-center gap-2">
            <Link
              href={`/dashboard/knowledge/${shortcut.article_id}`}
              className="text-sm text-blue-600 hover:underline flex-1"
            >
              {shortcut.article.title}
            </Link>
            <button
              onClick={() => removeShortcut(shortcut.id, shortcut.article_id)}
              className="text-gray-400 hover:text-gray-600"
            >
              <X className="w-3 h-3" />
            </button>
          </li>
        ))}
      </ul>
    </div>
  )
}
```

**src/app/api/knowledge/[id]/pin/route.ts**:
```typescript
// POST /api/knowledge/[id]/pin
// Creates kb_dashboard_shortcuts record for user + article
// Returns: { shortcut: KBDashboardShortcut }

// DELETE /api/knowledge/[id]/pin
// Removes kb_dashboard_shortcuts record
// Returns: { success: true }
```

**Update src/app/dashboard/page.tsx**:
- Add DashboardShortcuts widget to dashboard
- Position in sidebar or card grid
- Only show if user has shortcuts

Add pin/unpin button to article view page header.
  </action>
  <verify>
Run `npm run type-check` - should pass.
Run `npm run lint` - should pass.
  </verify>
  <done>
RelatedArticles shows similar articles based on content. DashboardShortcuts displays pinned articles on dashboard. Pin/unpin API and UI work correctly.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create contractor portal knowledge base pages</name>
  <files>
    src/app/contractor/[token]/knowledge/page.tsx
    src/app/contractor/[token]/knowledge/[id]/page.tsx
  </files>
  <action>
**src/app/contractor/[token]/knowledge/page.tsx**:
```typescript
// Contractor KB home page
// List articles where visibility IN ('contractors', 'both') AND status = 'published'
// Use CategoryTree component (filtered to contractor-visible categories)
// Use SearchBar (search filters to contractor-visible only)
// German UI: "Wissensdatenbank", "FAQ", "Anleitungen"
// No author, dates, or internal metadata shown (per CONTEXT.md decision)

// Layout similar to internal KB but simpler:
// - Category sidebar
// - Search bar
// - Article list (title + category only)

export default async function ContractorKnowledgePage({
  params,
}: {
  params: Promise<{ token: string }>
}) {
  const { token } = await params

  // Validate contractor token (use existing validateContractorAccess)
  // Fetch contractor-visible articles
  // Render KB list

  return (
    <div className="container mx-auto px-4 py-8">
      <h1 className="text-2xl font-bold mb-6">Wissensdatenbank</h1>
      {/* Search bar */}
      {/* Category filter */}
      {/* Article list */}
    </div>
  )
}
```

**src/app/contractor/[token]/knowledge/[id]/page.tsx**:
```typescript
// Contractor article view page
// Fetch article by ID, validate visibility allows contractors
// Use ArticleViewer component
// Hide internal metadata (author, dates, view count)
// Show only: title, content, category, attachments
// No edit button, no version history, no related articles (simpler view)

export default async function ContractorArticlePage({
  params,
}: {
  params: Promise<{ token: string; id: string }>
}) {
  const { token, id } = await params

  // Validate contractor token
  // Fetch article (ensure visibility allows contractors)
  // Render article view

  return (
    <div className="container mx-auto px-4 py-8">
      {/* Article content */}
      {/* Attachments list */}
      {/* Back link */}
    </div>
  )
}
```

Update contractor portal navigation (if exists) to include "Wissensdatenbank" link.

**API updates needed**:
- GET /api/knowledge should filter by visibility when contractor role detected
- GET /api/knowledge/search should filter by visibility for contractors
- Create /api/contractor/knowledge/route.ts if needed for contractor-specific queries

Follow existing contractor portal patterns from src/app/contractor/[token]/.
  </action>
  <verify>
Run `npm run type-check` - should pass.
Run `npm run lint` - should pass.
Access contractor portal via magic link and verify KB is accessible.
  </verify>
  <done>
Contractor portal has KB home page and article view page. Only contractor-visible articles shown. Simplified UI without internal metadata.
  </done>
</task>

</tasks>

<verification>
- [ ] VersionHistory shows version list with user names
- [ ] RelatedArticles appears on article view page
- [ ] DashboardShortcuts appears on main dashboard
- [ ] Pin/unpin buttons work on article view
- [ ] Contractor portal KB page lists contractor-visible articles only
- [ ] Contractor article view shows content without internal metadata
- [ ] Search in contractor portal filters to contractor-visible
- [ ] `npm run type-check` passes
- [ ] `npm run lint` passes
</verification>

<success_criteria>
1. User can view version history and see who made changes
2. User can pin articles to dashboard and see shortcuts
3. Related articles appear automatically on article view
4. Contractor can access KB via portal
5. Contractor only sees contractor-visible articles
6. Contractor view hides internal metadata (author, dates, version)
</success_criteria>

<output>
After completion, create `.planning/phases/18-knowledge-base/18-05-SUMMARY.md`
</output>
