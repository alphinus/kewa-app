---
phase: 21-change-orders
plan: 03
type: execute
wave: 2
depends_on: ["21-01"]
files_modified:
  - src/app/api/change-orders/[id]/photos/route.ts
  - src/app/api/change-orders/[id]/pdf/route.ts
  - src/app/api/projects/[id]/change-orders/analytics/route.ts
  - src/lib/pdf/change-order-pdf.tsx
  - src/components/change-orders/PhotoEvidenceUpload.tsx
  - src/components/change-orders/PhotoGallery.tsx
  - src/components/change-orders/BudgetImpactChart.tsx
  - src/components/change-orders/BudgetSummaryCards.tsx
  - src/components/change-orders/ChangeOrderPDF.tsx
  - src/app/dashboard/projekte/[id]/aenderungsauftraege/page.tsx
autonomous: true

must_haves:
  truths:
    - "User can upload and view photo evidence attached to change orders"
    - "User can generate and download a PDF document from a change order"
    - "Dashboard shows cumulative change orders per project with net budget impact"
    - "Waterfall chart visualizes budget flow: original -> +CO1 -> +CO2 -> current"
    - "Summary cards display Original Budget, Approved COs Total, Net Budget, Pending COs"
  artifacts:
    - path: "src/app/api/change-orders/[id]/photos/route.ts"
      provides: "Photo upload and listing API"
      exports: ["GET", "POST"]
    - path: "src/app/api/change-orders/[id]/pdf/route.ts"
      provides: "PDF download endpoint"
      exports: ["GET"]
    - path: "src/lib/pdf/change-order-pdf.tsx"
      provides: "PDF template with @react-pdf/renderer"
      exports: ["generateChangeOrderPDF"]
    - path: "src/app/api/projects/[id]/change-orders/analytics/route.ts"
      provides: "Budget impact analytics API"
      exports: ["GET"]
    - path: "src/components/change-orders/BudgetImpactChart.tsx"
      provides: "Recharts waterfall chart for budget visualization"
    - path: "src/app/dashboard/projekte/[id]/aenderungsauftraege/page.tsx"
      provides: "Per-project change order analytics page"
  key_links:
    - from: "src/app/api/change-orders/[id]/photos/route.ts"
      to: "supabase storage"
      via: "upload to media bucket at change_orders/{id}/photos/"
      pattern: "storage.*upload"
    - from: "src/app/api/change-orders/[id]/pdf/route.ts"
      to: "src/lib/pdf/change-order-pdf.tsx"
      via: "generateChangeOrderPDF function"
      pattern: "generateChangeOrderPDF"
    - from: "src/components/change-orders/BudgetImpactChart.tsx"
      to: "recharts"
      via: "ComposedChart with stacked bars for waterfall"
      pattern: "ComposedChart"
    - from: "src/app/dashboard/projekte/[id]/aenderungsauftraege/page.tsx"
      to: "/api/projects/[id]/change-orders/analytics"
      via: "fetch analytics data"
      pattern: "fetch.*analytics"
---

<objective>
Implement photo evidence upload/gallery, PDF generation, and budget impact dashboard with waterfall chart analytics.

Purpose: Completes the evidence and documentation capabilities (photos, PDF) and provides the financial visibility dashboard showing cumulative change order impact on project budgets.

Output: Photo upload/gallery API and components, PDF generation endpoint and template, budget analytics API, waterfall chart, summary cards, and per-project analytics page.
</objective>

<execution_context>
@C:\Users\Mario Giacchino\.claude\get-shit-done\workflows\execute-plan.md
@C:\Users\Mario Giacchino\.claude\get-shit-done\templates\summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/21-change-orders/21-CONTEXT.md
@.planning/phases/21-change-orders/21-RESEARCH.md
@.planning/phases/21-change-orders/21-01-SUMMARY.md

Key reference files:
@src/lib/pdf/work-order-pdf.tsx — PDF template pattern with @react-pdf/renderer
@src/components/suppliers/PriceHistoryChart.tsx — recharts chart component pattern
@supabase/migrations/050_kb_attachments.sql — attachment storage pattern
</context>

<tasks>

<task type="auto">
  <name>Task 1: Photo evidence API and PDF generation</name>
  <files>
    src/app/api/change-orders/[id]/photos/route.ts
    src/app/api/change-orders/[id]/pdf/route.ts
    src/lib/pdf/change-order-pdf.tsx
    src/components/change-orders/ChangeOrderPDF.tsx
    src/components/change-orders/PhotoEvidenceUpload.tsx
    src/components/change-orders/PhotoGallery.tsx
  </files>
  <action>
**1. Photo API `src/app/api/change-orders/[id]/photos/route.ts`:**
- GET: List photos for a change order. Query change_order_photos table by change_order_id. For each photo, generate signed URL using supabase.storage.from('media').createSignedUrl(storage_path, 3600) (1-hour expiry). Return array of photos with signedUrl.
- POST: Upload photo. Accept FormData with file and optional caption. Upload to `media` bucket at path `change_orders/{co_id}/photos/{timestamp}-{filename}`. Insert record into change_order_photos. Return photo record with signed URL.
- Auth: internal roles only.
- Validate change order exists before operations.

**2. PDF template `src/lib/pdf/change-order-pdf.tsx`** (follow work-order-pdf.tsx pattern exactly):
- Import from '@react-pdf/renderer': Document, Page, Text, View, StyleSheet, renderToBuffer
- Import format from date-fns with de locale
- Define `ChangeOrderPDFData` interface
- Styles: page padding 40, Helvetica font, 11px base size (same as work order PDF)
- Sections:
  - Header: "KEWA AG" logo text + "Aenderungsauftrag" document type + CO number + date
  - Meta section: Work order reference, reason category (German), schedule impact days, status
  - Description section
  - Line items table: flexbox row layout with columns Description (40%), Menge (15%), Einzelpreis (20%), Total (25%). Negative totals shown in red.
  - Summary: Gesamtbetrag (total), Terminauswirkung (schedule impact)
  - Signature area: Genehmigt durch / Datum lines
- Export `generateChangeOrderPDF(data: ChangeOrderPDFData): Promise<Buffer>`

**3. PDF endpoint `src/app/api/change-orders/[id]/pdf/route.ts`:**
- GET: Fetch change order with joins, transform to ChangeOrderPDFData, call generateChangeOrderPDF, return PDF buffer with headers:
  - Content-Type: application/pdf
  - Content-Disposition: attachment; filename="CO-YYYY-NNNNN.pdf"
- Auth: internal roles only.

**4. `PhotoEvidenceUpload.tsx`** — Client component. Drag-and-drop or click-to-upload. Accepts image/* files. Shows upload progress. Calls POST /api/change-orders/[id]/photos with FormData. On success, adds to gallery. Max file size validation (10MB).

**5. `PhotoGallery.tsx`** — Grid of photo thumbnails. Click to expand (lightbox-style overlay with larger image). Shows caption below each photo. Delete button per photo (calls DELETE endpoint — add DELETE handler to photos API).

**6. `ChangeOrderPDF.tsx`** — Simple download button component. Calls GET /api/change-orders/[id]/pdf and triggers browser download. Shows loading spinner during generation.
  </action>
  <verify>
TypeScript compiles. PDF generation produces valid buffer. Photo upload stores in correct bucket path. Signed URLs generate correctly.
  </verify>
  <done>
Photo evidence upload and gallery working. PDF generation produces A4 German-language document with line items table. Download button triggers PDF download. All storage uses existing media bucket.
  </done>
</task>

<task type="auto">
  <name>Task 2: Budget impact analytics API, waterfall chart, and per-project dashboard</name>
  <files>
    src/app/api/projects/[id]/change-orders/analytics/route.ts
    src/components/change-orders/BudgetImpactChart.tsx
    src/components/change-orders/BudgetSummaryCards.tsx
    src/app/dashboard/projekte/[id]/aenderungsauftraege/page.tsx
  </files>
  <action>
**1. Analytics API `src/app/api/projects/[id]/change-orders/analytics/route.ts`:**
- GET: Fetch budget impact data for a project. Query:
  - Project original budget from renovation_projects table (total_budget or estimated_cost field — check which exists)
  - All change orders for the project (via work_orders.project_id join): co_number, description, total_amount, status, approved_at
  - Compute aggregates:
    - approved_total: SUM of total_amount WHERE status = 'approved'
    - pending_total: SUM of total_amount WHERE status IN ('submitted', 'under_review')
    - net_budget: original_budget + approved_total
    - count_by_status: { draft, submitted, under_review, approved, rejected, cancelled }
- Return: { original_budget, approved_total, pending_total, net_budget, count_by_status, change_orders: [...] }
- Auth: internal roles.

**2. `BudgetImpactChart.tsx`** — Recharts waterfall chart (follow RESEARCH.md Pattern 3):
- Props: `originalBudget: number`, `changeOrders: Array<{ co_number, description, total_amount, approved_at }>`
- Transform data for waterfall effect using stacked bars pattern:
  - First bar: "Urspr. Budget" (original) — blue fill, invisible=0
  - Middle bars: each approved CO — green fill for additions, red for credits
  - invisible value = previousCumulative for additions, cumulative for reductions
  - Last bar: "Aktuelles Budget" (current) — indigo fill, invisible=0
- Use ComposedChart from recharts with:
  - CartesianGrid, XAxis (angled labels), YAxis (CHF formatting)
  - Tooltip with Swiss franc formatting (de-CH locale)
  - Two stacked Bar components: invisible (transparent) + value (colored per Cell)
- ResponsiveContainer width="100%" height={400}
- Handle edge case: no approved COs (show only original and current as same value)

**3. `BudgetSummaryCards.tsx`:**
- Props: `originalBudget, approvedTotal, netBudget, pendingTotal`
- Four cards in responsive grid (4 cols on lg, 2 on md, 1 on sm):
  - "Urspruengliches Budget" — blue, CHF formatted
  - "Genehmigte AAs" — green if positive, red if negative, CHF formatted
  - "Aktuelles Budget" — indigo, CHF formatted
  - "Haengige AAs" — amber, CHF formatted
- Each card: icon, label, amount. Follow existing card patterns in the codebase.

**4. Per-project analytics page `src/app/dashboard/projekte/[id]/aenderungsauftraege/page.tsx`:**
- Server component
- Fetch analytics from /api/projects/[id]/change-orders/analytics
- Layout:
  - Page header: "Aenderungsauftraege — {Project Name}"
  - BudgetSummaryCards at top
  - BudgetImpactChart below cards
  - Table of all COs for this project below chart: CO number, description, status badge, amount, date
  - Link to create new CO for this project
- Breadcrumb: Dashboard > Projekte > {Project} > Aenderungsauftraege
  </action>
  <verify>
TypeScript compiles. Analytics API returns correct aggregates. Waterfall chart renders with recharts. Summary cards display formatted CHF values. Per-project page shows all sections.
  </verify>
  <done>
Budget impact analytics API returns project-level CO aggregates. Waterfall chart visualizes budget flow with green/red bars. Summary cards show key metrics. Per-project dashboard page complete at /dashboard/projekte/[id]/aenderungsauftraege.
  </done>
</task>

</tasks>

<verification>
- Photo upload stores files in media bucket at correct path
- Signed URLs work with 1-hour expiry
- PDF generates valid A4 document with German text and line items table
- Analytics API computes correct budget aggregates from approved COs
- Waterfall chart handles positive and negative CO amounts correctly
- Summary cards display all four metrics with CHF formatting
- Per-project page renders all sections
</verification>

<success_criteria>
- Photos uploadable and viewable with signed URLs
- PDF downloadable with complete CO information
- Budget impact visible at project level with waterfall chart
- Summary cards show Original Budget, Approved COs, Net Budget, Pending COs
- All components use recharts (waterfall) and @react-pdf/renderer (PDF)
</success_criteria>

<output>
After completion, create `.planning/phases/21-change-orders/21-03-SUMMARY.md`
</output>
