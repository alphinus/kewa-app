---
phase: 21-change-orders
plan: 04
type: execute
wave: 3
depends_on: ["21-02", "21-03"]
files_modified:
  - src/app/api/change-orders/[id]/send-approval/route.ts
  - src/app/portal/change-orders/[token]/page.tsx
  - src/app/api/portal/change-orders/[token]/route.ts
  - src/app/api/portal/change-orders/[token]/approve/route.ts
  - src/app/api/portal/change-orders/[token]/reject/route.ts
  - src/components/change-orders/ClientApprovalView.tsx
  - src/components/change-orders/SendApprovalDialog.tsx
autonomous: true

must_haves:
  truths:
    - "KEWA user can send a change order for client approval via magic link"
    - "Client can access change order via magic-link URL without login"
    - "Client can approve a change order from the portal"
    - "Client can reject a change order with mandatory comment"
    - "Magic link expires after 7 days"
    - "Used/expired token shows appropriate error message"
    - "Client sees line items only when show_line_items_to_client is true"
  artifacts:
    - path: "src/app/api/change-orders/[id]/send-approval/route.ts"
      provides: "Creates magic link token and returns portal URL"
      exports: ["POST"]
    - path: "src/app/portal/change-orders/[token]/page.tsx"
      provides: "Client-facing portal page for CO approval"
    - path: "src/app/api/portal/change-orders/[token]/route.ts"
      provides: "Token validation and CO data fetch for portal"
      exports: ["GET"]
    - path: "src/app/api/portal/change-orders/[token]/approve/route.ts"
      provides: "Client approval endpoint"
      exports: ["POST"]
    - path: "src/app/api/portal/change-orders/[token]/reject/route.ts"
      provides: "Client rejection endpoint"
      exports: ["POST"]
  key_links:
    - from: "src/app/api/change-orders/[id]/send-approval/route.ts"
      to: "supabase RPC create_magic_link_token"
      via: "Creates token with purpose 'change_order_approval'"
      pattern: "create_magic_link_token"
    - from: "src/app/api/portal/change-orders/[token]/route.ts"
      to: "supabase RPC validate_magic_link_token"
      via: "Validates token without consuming it (read-only check)"
      pattern: "validate_magic_link_token"
    - from: "src/app/api/portal/change-orders/[token]/approve/route.ts"
      to: "supabase"
      via: "Updates CO status + marks token as used"
      pattern: "status.*approved"
    - from: "src/app/portal/change-orders/[token]/page.tsx"
      to: "/api/portal/change-orders/[token]"
      via: "Server component fetch for CO data"
      pattern: "fetch.*portal.*change-orders"
---

<objective>
Implement the client approval portal using magic links — KEWA sends approval link, client views change order details, and approves or rejects from the portal.

Purpose: Enables external client participation in the change order approval workflow without requiring login. Clients receive a time-limited magic link, view CO details (with configurable financial visibility), and take approval action.

Output: Magic link creation API, portal page with approval UI, token validation and action endpoints, approval dialog component.
</objective>

<execution_context>
@C:\Users\Mario Giacchino\.claude\get-shit-done\workflows\execute-plan.md
@C:\Users\Mario Giacchino\.claude\get-shit-done\templates\summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/21-change-orders/21-CONTEXT.md
@.planning/phases/21-change-orders/21-RESEARCH.md
@.planning/phases/21-change-orders/21-01-SUMMARY.md
@.planning/phases/21-change-orders/21-02-SUMMARY.md
@.planning/phases/21-change-orders/21-03-SUMMARY.md

Key reference files:
@supabase/migrations/024_magic_links.sql — create_magic_link_token and validate_magic_link_token functions
@src/types/change-orders.ts — ChangeOrder types
@src/components/change-orders/ChangeOrderDetail.tsx — internal detail view to adapt for portal
@src/components/change-orders/PhotoGallery.tsx — photo gallery for portal view
</context>

<tasks>

<task type="auto">
  <name>Task 1: Magic link creation API and send approval dialog</name>
  <files>
    src/app/api/change-orders/[id]/send-approval/route.ts
    src/components/change-orders/SendApprovalDialog.tsx
  </files>
  <action>
**1. Send approval endpoint `src/app/api/change-orders/[id]/send-approval/route.ts`:**
- POST: Creates magic link token for client change order approval
- Accepts `{ client_email: string, client_name?: string }`
- Validate: CO exists, status is 'under_review' or 'approved' (sending link for record)
- Validate: client_email is provided and looks like an email (basic regex)
- Call supabase RPC `create_magic_link_token` with parameters:
  - p_email: client_email
  - p_purpose: 'change_order_approval'
  - p_work_order_id: null (not a work order token)
  - p_user_id: null (client doesn't have user account)
  - p_expires_hours: 168 (7 days)
  - p_created_by: current user ID
- Store CO reference: Insert into magic_link_tokens a reference to the change_order_id.
  - Since magic_link_tokens doesn't have a change_order_id column, use a simple approach: store the change_order_id in a separate lookup. Two options:
    - Option A: Add a `metadata` JSONB column to magic_link_tokens (requires migration)
    - Option B: Create a `change_order_approval_tokens` join table (cleaner)
  - Use Option B: Create a small additional table `change_order_approval_tokens` (id, token UUID references magic_link_tokens.token, change_order_id UUID references change_orders.id, created_at). Add this to the 057 migration OR create a 058 migration.
  - Actually, since Plan 01 creates the migration, add this table to 057_change_orders.sql. If Plan 01 already executed, create 058_change_order_tokens.sql instead. Check if 057 already includes this table; if not, create a new migration.
- Construct portal URL: `/portal/change-orders/${token}`
- Return: `{ token, portal_url, expires_at }`
- Auth: internal roles only

NOTE: The `change_order_approval_tokens` table needs to exist. Add it to the migration in Plan 01 if not yet executed. If Plan 01 is already done, create `supabase/migrations/058_change_order_approval_tokens.sql`:
```sql
CREATE TABLE IF NOT EXISTS change_order_approval_tokens (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  token UUID NOT NULL REFERENCES magic_link_tokens(token) ON DELETE CASCADE,
  change_order_id UUID NOT NULL REFERENCES change_orders(id) ON DELETE CASCADE,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  UNIQUE(token)
);
CREATE INDEX idx_co_approval_tokens_co ON change_order_approval_tokens(change_order_id);
CREATE INDEX idx_co_approval_tokens_token ON change_order_approval_tokens(token);
```

**2. `SendApprovalDialog.tsx`** — Dialog/modal component for sending approval link:
- Props: `changeOrderId, coNumber, isOpen, onClose, onSent`
- Form fields: Client email (required), Client name (optional)
- Submit button: "Genehmigungslink senden"
- On submit: POST to /api/change-orders/[id]/send-approval
- On success: Show portal URL with copy button, display expiry info (7 Tage gueltig)
- Error handling: Show validation errors inline
  </action>
  <verify>
Magic link creation works via API call. Token stored with CO reference. Portal URL returned correctly. Dialog renders with form fields.
  </verify>
  <done>
Send approval endpoint creates magic link token with 7-day expiry. SendApprovalDialog provides UI for entering client email and displays generated portal URL. Token-to-CO mapping stored in change_order_approval_tokens table.
  </done>
</task>

<task type="auto">
  <name>Task 2: Client portal page with approval/rejection actions</name>
  <files>
    src/app/portal/change-orders/[token]/page.tsx
    src/app/api/portal/change-orders/[token]/route.ts
    src/app/api/portal/change-orders/[token]/approve/route.ts
    src/app/api/portal/change-orders/[token]/reject/route.ts
    src/components/change-orders/ClientApprovalView.tsx
  </files>
  <action>
**1. Portal data endpoint `src/app/api/portal/change-orders/[token]/route.ts`:**
- GET: Validates token and returns change order data for portal display
- Query magic_link_tokens to check: token exists, not expired, not revoked, not used
  - DO NOT call validate_magic_link_token RPC here (that marks as used). Instead, do a manual SELECT check:
    ```
    SELECT * FROM magic_link_tokens WHERE token = $1 AND used_at IS NULL AND is_revoked = false AND expires_at > NOW()
    ```
- If invalid: return { valid: false, error: 'Token expired/invalid' } with 200 (not 401, to allow UI to show appropriate message)
- If valid: lookup change_order_id from change_order_approval_tokens, fetch CO with work order join
- Respect `show_line_items_to_client`: if false, exclude line_items from response, return only total_amount and description
- Return: { valid: true, change_order: {...}, show_line_items: boolean }
- NO auth required (public endpoint — token IS the auth)

**2. Approve endpoint `src/app/api/portal/change-orders/[token]/approve/route.ts`:**
- POST: Client approves change order
- Accepts: `{ comment?: string }` (approval comment optional)
- Validate token (same manual check as above)
- Mark token as used: `UPDATE magic_link_tokens SET used_at = NOW() WHERE token = $1`
- Update change order: Set status = 'approved', approved_at = NOW()
  - Only if current status is 'under_review' — otherwise return error "Change order already processed"
- Log approval in audit trail
- Return: { success: true, status: 'approved' }
- NO auth required (public endpoint)

**3. Reject endpoint `src/app/api/portal/change-orders/[token]/reject/route.ts`:**
- POST: Client rejects change order
- Accepts: `{ comment: string }` (comment REQUIRED for rejection)
- Validate: comment must be non-empty (return 400 if missing)
- Same token validation as approve
- Mark token as used
- Update change order: Set status = 'rejected', rejected_at = NOW()
  - Only if current status is 'under_review'
- Log rejection in audit trail with comment
- Return: { success: true, status: 'rejected' }
- NO auth required (public endpoint)

**4. `ClientApprovalView.tsx`** — Client-facing change order view:
- Props: `changeOrder`, `showLineItems`, `onApprove`, `onReject`, `isProcessed`
- Clean, professional layout (no dashboard chrome):
  - KEWA AG header/branding
  - CO number and work order reference
  - Description and reason (German labels)
  - Schedule impact if non-zero
  - Line items table (only if showLineItems is true)
  - Total amount (always shown)
  - Photo gallery (if photos exist — fetch from photos endpoint using token context)
  - Version history (simplified — just version count and current version)
- Action area (only if not yet processed):
  - "Genehmigen" button (green)
  - "Ablehnen" button (red) — opens comment textarea (required)
- If already processed: show status message ("Dieser Aenderungsauftrag wurde bereits bearbeitet")
- If token invalid/expired: show error message ("Dieser Link ist abgelaufen oder ungueltig")

**5. Portal page `src/app/portal/change-orders/[token]/page.tsx`:**
- Server component for initial data fetch
- Call GET /api/portal/change-orders/[token] to validate and get data
- If invalid: render error view
- If valid: render ClientApprovalView with data
- Client-side interactivity for approve/reject actions (use 'use client' wrapper for action buttons)
- Minimal layout — no sidebar, no dashboard navigation. Just KEWA branding + CO content + action buttons
- Meta tags: title "Aenderungsauftrag {CO number} — KEWA AG"
  </action>
  <verify>
Portal page renders at /portal/change-orders/{token}. Invalid tokens show error message. Valid tokens show CO details. Approve button updates status. Reject button requires comment. Token marked as used after action. Line items hidden when show_line_items_to_client is false.
  </verify>
  <done>
Client portal fully functional. Magic link leads to professional CO view. Client can approve or reject (with mandatory comment). Token consumed on action to prevent reuse. Financial detail visibility respects per-CO configuration.
  </done>
</task>

</tasks>

<verification>
- Magic link token creates with purpose 'change_order_approval' and 7-day expiry
- Portal page renders without authentication
- Token validation: expired/used/revoked tokens show error, valid tokens show CO
- Approve action: updates status to approved, marks token as used
- Reject action: requires comment, updates status to rejected, marks token as used
- Double-click prevention: second action on same token fails gracefully
- show_line_items_to_client=false hides line items from portal view
- Portal has clean professional appearance without dashboard chrome
</verification>

<success_criteria>
- Complete client approval flow: KEWA sends link -> client opens -> approves/rejects
- Token security: 7-day expiry, single-use, revocable
- Financial visibility configurable per change order
- Rejection requires comment, approval comment optional
- Audit trail captures all portal actions
</success_criteria>

<output>
After completion, create `.planning/phases/21-change-orders/21-04-SUMMARY.md`
</output>
