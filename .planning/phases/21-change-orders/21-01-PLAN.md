---
phase: 21-change-orders
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/057_change_orders.sql
  - src/types/change-orders.ts
  - src/lib/change-orders/queries.ts
  - src/lib/change-orders/workflow.ts
  - src/app/api/change-orders/route.ts
  - src/app/api/change-orders/[id]/route.ts
autonomous: true

must_haves:
  truths:
    - "Change orders table exists with versioning, line items, status workflow"
    - "TypeScript types cover all change order entities and API contracts"
    - "User can create a change order linked to work order via API"
    - "User can list, read, update change orders with filters"
    - "CO number auto-generates as CO-YYYY-NNNNN from database sequence"
    - "Status transitions enforced by database trigger"
  artifacts:
    - path: "supabase/migrations/057_change_orders.sql"
      provides: "change_orders, change_order_versions, change_order_photos tables, sequence, triggers"
      contains: "CREATE TABLE change_orders"
    - path: "src/types/change-orders.ts"
      provides: "ChangeOrder, ChangeOrderVersion, ChangeOrderLineItem, ChangeOrderStatus types"
      exports: ["ChangeOrder", "ChangeOrderStatus", "ChangeOrderLineItem"]
    - path: "src/lib/change-orders/queries.ts"
      provides: "Database query helpers for change orders"
      exports: ["calculateLineItemsTotal"]
    - path: "src/lib/change-orders/workflow.ts"
      provides: "Status transition validation and workflow utilities"
      exports: ["VALID_TRANSITIONS", "canTransition"]
    - path: "src/app/api/change-orders/route.ts"
      provides: "GET list + POST create endpoints"
      exports: ["GET", "POST"]
    - path: "src/app/api/change-orders/[id]/route.ts"
      provides: "GET detail + PATCH update + DELETE soft-delete"
      exports: ["GET", "PATCH", "DELETE"]
  key_links:
    - from: "src/app/api/change-orders/route.ts"
      to: "src/lib/change-orders/queries.ts"
      via: "import calculateLineItemsTotal"
      pattern: "calculateLineItemsTotal"
    - from: "src/app/api/change-orders/route.ts"
      to: "supabase"
      via: "createClient + supabase.from('change_orders')"
      pattern: "from\\('change_orders'\\)"
    - from: "src/app/api/change-orders/route.ts"
      to: "supabase RPC"
      via: "generate_change_order_number"
      pattern: "rpc\\('generate_change_order_number'\\)"
---

<objective>
Create the change order database schema, TypeScript types, query utilities, and CRUD API routes.

Purpose: Establishes the data foundation for all change order operations — schema with versioning, status workflow enforcement via database triggers, CO number sequence, and complete CRUD API following proven purchase order patterns.

Output: Migration file, type definitions, query helpers, workflow utilities, and API routes for create/read/update/list change orders.
</objective>

<execution_context>
@C:\Users\Mario Giacchino\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\Mario Giacchino\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/21-change-orders/21-CONTEXT.md
@.planning/phases/21-change-orders/21-RESEARCH.md

Key reference files (read these for patterns):
@supabase/migrations/051_purchase_orders.sql — sequence, status trigger, table structure
@supabase/migrations/048_knowledge_base.sql — version history table and trigger pattern
@src/types/suppliers.ts — type file structure and conventions
@src/app/api/purchase-orders/route.ts — API route pattern (auth, validation, supabase queries)
@src/lib/suppliers/status-utils.ts — status workflow utility pattern
@src/lib/suppliers/purchase-order-queries.ts — query helper pattern
</context>

<tasks>

<task type="auto">
  <name>Task 1: Database migration — change_orders schema with versioning and workflow</name>
  <files>supabase/migrations/057_change_orders.sql</files>
  <action>
Create migration `057_change_orders.sql` with the following (follow patterns from 051_purchase_orders.sql and 048_knowledge_base.sql):

**1. Status enum:**
```sql
CREATE TYPE change_order_status AS ENUM ('draft', 'submitted', 'under_review', 'approved', 'rejected', 'cancelled');
```

**2. Reason category enum:**
```sql
CREATE TYPE change_order_reason AS ENUM ('owner_request', 'unforeseen_conditions', 'design_error', 'site_conditions', 'regulatory_requirement', 'other');
```

**3. Sequence for CO numbers:**
```sql
CREATE SEQUENCE change_order_seq START WITH 1 INCREMENT BY 1 NO MAXVALUE CACHE 1;
```

**4. `change_orders` table:**
- `id` UUID PK
- `co_number` TEXT UNIQUE NOT NULL (CO-YYYY-NNNNN)
- `work_order_id` UUID NOT NULL REFERENCES work_orders(id)
- `related_work_order_ids` UUID[] DEFAULT '{}'
- `version` INTEGER DEFAULT 1
- `description` TEXT NOT NULL
- `reason_category` change_order_reason NOT NULL
- `reason_details` TEXT
- `line_items` JSONB DEFAULT '[]' (same structure as purchase orders: {id, description, quantity, unit, unit_price, total})
- `total_amount` DECIMAL(12,2) NOT NULL DEFAULT 0
- `schedule_impact_days` INTEGER DEFAULT 0
- `status` change_order_status DEFAULT 'draft'
- `created_by` UUID REFERENCES users(id)
- `creator_type` TEXT NOT NULL DEFAULT 'internal' CHECK (creator_type IN ('internal', 'contractor'))
- `current_approver_id` UUID REFERENCES users(id)
- `show_line_items_to_client` BOOLEAN DEFAULT true (controls financial detail visibility in client portal)
- Standard timestamps: created_at, updated_at
- Status timestamps: submitted_at, approved_at, rejected_at, cancelled_at (all TIMESTAMPTZ, nullable)
- `cancelled_reason` TEXT

**5. `change_order_versions` table (temporal history, like kb_articles_history):**
- `version_id` UUID PK
- `change_order_id` UUID NOT NULL REFERENCES change_orders(id) ON DELETE CASCADE
- `version` INTEGER NOT NULL
- `description` TEXT NOT NULL
- `line_items` JSONB NOT NULL
- `total_amount` DECIMAL(12,2)
- `schedule_impact_days` INTEGER
- `revised_by` UUID REFERENCES users(id)
- `revised_at` TIMESTAMPTZ DEFAULT NOW()
- `revision_reason` TEXT
- UNIQUE(change_order_id, version)

**6. `change_order_photos` table:**
- `id` UUID PK
- `change_order_id` UUID NOT NULL REFERENCES change_orders(id) ON DELETE CASCADE
- `storage_path` TEXT NOT NULL
- `filename` TEXT NOT NULL
- `file_size` INTEGER
- `mime_type` TEXT
- `caption` TEXT
- `uploaded_by` UUID REFERENCES users(id)
- `uploaded_at` TIMESTAMPTZ DEFAULT NOW()

**7. `approval_thresholds` table:**
- `id` UUID PK
- `project_id` UUID REFERENCES renovation_projects(id) ON DELETE CASCADE (nullable for global)
- `min_amount` DECIMAL(12,2) (nullable = no minimum)
- `max_amount` DECIMAL(12,2) (nullable = no maximum)
- `approver_role` TEXT NOT NULL CHECK (approver_role IN ('property_manager', 'finance_director', 'ceo'))
- `requires_client_approval` BOOLEAN DEFAULT false
- `priority` INTEGER DEFAULT 0
- `created_at` TIMESTAMPTZ DEFAULT NOW()
- `updated_at` TIMESTAMPTZ DEFAULT NOW()
- Seed 3 default global thresholds: <5000 property_manager, 5000-25000 finance_director, >25000 ceo

**8. Functions:**
- `generate_change_order_number()` — like generate_purchase_order_number(), returns 'CO-YYYY-NNNNN'
- `validate_change_order_status_transition()` — BEFORE UPDATE trigger, validates transitions per JSONB map (draft->submitted/cancelled, submitted->under_review/cancelled, under_review->approved/rejected/submitted/cancelled, approved->cancelled, rejected->[], cancelled->[]), auto-sets timestamps
- `change_order_version_trigger()` — AFTER UPDATE trigger: when version incremented, stores OLD values in change_order_versions (like kb_articles_version_trigger)
- `log_change_order_audit()` — AFTER UPDATE trigger: logs status changes to audit_logs via create_audit_log function
- `prevent_work_order_deletion()` — BEFORE DELETE trigger on work_orders: raises exception if active COs exist (status IN submitted, under_review, approved)

**9. Indexes:**
- change_orders: work_order_id, status, created_at DESC
- change_order_versions: (change_order_id, version DESC)
- change_order_photos: change_order_id
- approval_thresholds: project_id

**10. Comments on all tables, key columns, and functions.**

Do NOT use the existing `update_updated_at()` trigger function — check if it exists first. If it does exist (it should from prior migrations), create the updated_at trigger on change_orders using it. Same pattern as purchase_orders.
  </action>
  <verify>
Run `npx supabase db push` or equivalent to verify migration applies without errors. If local Supabase is not running, verify SQL syntax by reading through for obvious issues.
  </verify>
  <done>
Migration file exists at supabase/migrations/057_change_orders.sql. Tables change_orders, change_order_versions, change_order_photos, approval_thresholds created. Sequence, functions, triggers, and indexes all defined. Default approval thresholds seeded.
  </done>
</task>

<task type="auto">
  <name>Task 2: TypeScript types, query helpers, workflow utilities, and CRUD API</name>
  <files>
    src/types/change-orders.ts
    src/lib/change-orders/queries.ts
    src/lib/change-orders/workflow.ts
    src/app/api/change-orders/route.ts
    src/app/api/change-orders/[id]/route.ts
  </files>
  <action>
**1. Types file `src/types/change-orders.ts`** (follow src/types/suppliers.ts pattern):

Define all types with clear section comments:

```
ChangeOrderStatus = 'draft' | 'submitted' | 'under_review' | 'approved' | 'rejected' | 'cancelled'
ChangeOrderReason = 'owner_request' | 'unforeseen_conditions' | 'design_error' | 'site_conditions' | 'regulatory_requirement' | 'other'
CreatorType = 'internal' | 'contractor'

ChangeOrderLineItem { id, description, quantity, unit, unit_price, total } — same structure as PurchaseOrderLineItem

ChangeOrder entity — matches DB schema, includes optional joined fields:
  - work_order?: { id, title, wo_number }
  - project?: { id, name }

ChangeOrderVersion — matches change_order_versions table
ChangeOrderPhoto — matches change_order_photos table

API input types: CreateChangeOrderInput, UpdateChangeOrderInput
API response types: ChangeOrderResponse, ChangeOrdersResponse
```

**2. Query helpers `src/lib/change-orders/queries.ts`** (follow purchase-order-queries.ts pattern):
- `calculateLineItemsTotal(items: ChangeOrderLineItem[]): number` — sums item.total values (preserve sign for credits)
- `CHANGE_ORDER_SELECT` const — select query with work_order join (id, title, wo_number) and project join via work order
- `formatCHF(amount: number): string` — Swiss franc formatting with Intl.NumberFormat('de-CH')

**3. Workflow utilities `src/lib/change-orders/workflow.ts`** (follow status-utils.ts pattern):
- `VALID_TRANSITIONS` map — matching trigger's JSONB
- `canTransition(from, to): boolean`
- `getStatusLabel(status): string` — German labels (Entwurf, Eingereicht, In Pruefung, Genehmigt, Abgelehnt, Storniert)
- `getStatusColor(status): string` — Tailwind color classes per status
- `REASON_LABELS` map — German labels for reason categories

**4. API route `src/app/api/change-orders/route.ts`** (follow purchase-orders/route.ts pattern exactly):
- GET: List change orders with filters (work_order_id, status, project_id). Select with work_order join. Pagination with limit/offset. Auth check for internal roles.
- POST: Create change order. Validate required fields (work_order_id, description, reason_category, line_items). Verify work order exists. Generate CO number via RPC `generate_change_order_number`. Calculate total_amount from line items. Insert and return with joins.

**5. API route `src/app/api/change-orders/[id]/route.ts`** (follow purchase-orders/[id]/route.ts pattern):
- GET: Fetch single change order by ID with joins (work_order, versions via separate query)
- PATCH: Update change order fields. Only allow updates when status is 'draft'. Recalculate total_amount if line_items changed.
- DELETE: Soft-delete by setting status to 'cancelled'. Require `cancelled_reason` in body. Only allow if status permits transition to cancelled.

All API routes: use `createClient` from `@/lib/supabase/server`, check `x-user-id` and `x-user-role` headers, restrict to ALLOWED_ROLES `['kewa', 'imeri']`. Use try/catch with proper error responses.
  </action>
  <verify>
TypeScript compilation passes: `npx tsc --noEmit` (or at minimum, no red squiggles in the created files). API routes follow existing patterns and import from correct paths.
  </verify>
  <done>
Types defined in src/types/change-orders.ts. Query helpers in src/lib/change-orders/queries.ts. Workflow utils in src/lib/change-orders/workflow.ts. CRUD API routes at /api/change-orders (GET, POST) and /api/change-orders/[id] (GET, PATCH, DELETE). All follow existing codebase patterns.
  </done>
</task>

</tasks>

<verification>
- Migration file parses as valid SQL
- TypeScript types compile without errors
- API routes follow same auth/validation/response pattern as purchase-orders
- Status transition validation matches between workflow.ts and database trigger
- CO number generation uses sequence function correctly
</verification>

<success_criteria>
- change_orders, change_order_versions, change_order_photos, approval_thresholds tables created
- CO-YYYY-NNNNN sequence generates correctly
- Status transitions enforced at database level
- Version history trigger captures old values on version increment
- Full CRUD API operational at /api/change-orders
- All TypeScript types and utilities properly exported
</success_criteria>

<output>
After completion, create `.planning/phases/21-change-orders/21-01-SUMMARY.md`
</output>
