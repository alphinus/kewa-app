---
phase: 21-change-orders
plan: 02
type: execute
wave: 2
depends_on: ["21-01"]
files_modified:
  - src/app/api/change-orders/[id]/status/route.ts
  - src/app/api/change-orders/[id]/revise/route.ts
  - src/app/api/change-orders/[id]/versions/route.ts
  - src/lib/change-orders/threshold-routing.ts
  - src/app/dashboard/aenderungsauftraege/page.tsx
  - src/app/dashboard/aenderungsauftraege/neu/page.tsx
  - src/app/dashboard/aenderungsauftraege/[id]/page.tsx
  - src/app/dashboard/aenderungsauftraege/[id]/bearbeiten/page.tsx
  - src/components/change-orders/ChangeOrderForm.tsx
  - src/components/change-orders/ChangeOrderList.tsx
  - src/components/change-orders/ChangeOrderStatusBadge.tsx
  - src/components/change-orders/ChangeOrderDetail.tsx
  - src/components/change-orders/VersionHistoryTimeline.tsx
  - src/components/change-orders/ApprovalWorkflowCard.tsx
  - src/components/change-orders/LineItemEditor.tsx
autonomous: true

must_haves:
  truths:
    - "User can submit a change order for approval and it transitions through workflow states"
    - "Approver can approve or reject a change order with comments"
    - "Approver can create counter-offer revision with modified line items"
    - "All status changes are logged in audit trail"
    - "Threshold routing determines approver based on CO total amount"
    - "User can view version history timeline showing all revisions"
    - "User can browse, create, and manage change orders from dashboard UI"
  artifacts:
    - path: "src/app/api/change-orders/[id]/status/route.ts"
      provides: "Status transition endpoint (submit, approve, reject, cancel)"
      exports: ["PATCH"]
    - path: "src/app/api/change-orders/[id]/revise/route.ts"
      provides: "Counter-offer revision endpoint"
      exports: ["POST"]
    - path: "src/app/api/change-orders/[id]/versions/route.ts"
      provides: "Version history listing"
      exports: ["GET"]
    - path: "src/lib/change-orders/threshold-routing.ts"
      provides: "Approval threshold logic"
      exports: ["determineApprover"]
    - path: "src/components/change-orders/ChangeOrderForm.tsx"
      provides: "Create/edit form with line items"
    - path: "src/components/change-orders/ChangeOrderList.tsx"
      provides: "Filterable list with status pills"
    - path: "src/app/dashboard/aenderungsauftraege/page.tsx"
      provides: "Change orders list dashboard page"
  key_links:
    - from: "src/app/api/change-orders/[id]/status/route.ts"
      to: "src/lib/change-orders/workflow.ts"
      via: "canTransition validation before DB update"
      pattern: "canTransition"
    - from: "src/app/api/change-orders/[id]/status/route.ts"
      to: "src/lib/change-orders/threshold-routing.ts"
      via: "determineApprover on submit"
      pattern: "determineApprover"
    - from: "src/app/api/change-orders/[id]/revise/route.ts"
      to: "supabase"
      via: "Optimistic locking with version check"
      pattern: "AND version ="
    - from: "src/app/dashboard/aenderungsauftraege/page.tsx"
      to: "/api/change-orders"
      via: "fetch in server component"
      pattern: "fetch.*api/change-orders"
---

<objective>
Implement the approval workflow API (status transitions, counter-offer revisions, threshold-based routing), audit trail integration, and the full dashboard UI for browsing/creating/managing change orders.

Purpose: Enables the complete change order lifecycle — creating, submitting for approval, threshold-based routing to appropriate approver, counter-offer negotiations via versioning, and full dashboard UI for managing all operations.

Output: Status transition API, revision API, version history API, threshold routing logic, and complete dashboard pages with form/list/detail/edit components.
</objective>

<execution_context>
@C:\Users\Mario Giacchino\.claude\get-shit-done\workflows\execute-plan.md
@C:\Users\Mario Giacchino\.claude\get-shit-done\templates\summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/21-change-orders/21-CONTEXT.md
@.planning/phases/21-change-orders/21-RESEARCH.md
@.planning/phases/21-change-orders/21-01-SUMMARY.md

Key reference files:
@src/app/api/purchase-orders/[id]/status/route.ts — status transition API pattern
@src/components/suppliers/PurchaseOrderForm.tsx — form with line items pattern
@src/components/suppliers/PurchaseOrderList.tsx — filterable list pattern
@src/components/suppliers/PurchaseOrderStatusBadge.tsx — status badge pattern
@src/components/suppliers/LineItemEditor.tsx — line item editor to reference (not reuse — CO needs bidirectional +/- amounts)
@src/app/dashboard/bestellungen/ — dashboard page structure pattern (if exists, else use suppliers dashboard pages)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Approval workflow API — status transitions, revisions, threshold routing</name>
  <files>
    src/app/api/change-orders/[id]/status/route.ts
    src/app/api/change-orders/[id]/revise/route.ts
    src/app/api/change-orders/[id]/versions/route.ts
    src/lib/change-orders/threshold-routing.ts
  </files>
  <action>
**1. Status transition endpoint `src/app/api/change-orders/[id]/status/route.ts`:**
- PATCH: Accepts `{ status, comment?, cancelled_reason? }`
- Validate transition using `canTransition(currentStatus, newStatus)` from workflow.ts
- On `submitted`: call `determineApprover()` to set `current_approver_id`, set `submitted_at`
- On `approved`: verify current user matches current_approver_id (or has admin role), set `approved_at`
- On `rejected`: require `comment` in body (reject without comment = 400), set `rejected_at`
- On `cancelled`: require `cancelled_reason` in body, set `cancelled_at` and `cancelled_reason`
- Update status in change_orders table (trigger handles transition validation at DB level too)
- Auth: internal roles only ('kewa', 'imeri')
- Return updated change order

**2. Counter-offer revision endpoint `src/app/api/change-orders/[id]/revise/route.ts`:**
- POST: Creates a new version of the change order
- Accepts `{ line_items, description?, schedule_impact_days?, revision_reason }`
- Only allowed when status is 'under_review' or 'submitted'
- Use optimistic locking: `UPDATE ... SET version = version + 1 ... WHERE id = $1 AND version = $2`
- If affected rows = 0, return 409 Conflict (version changed by another user)
- Version trigger (DB) captures old values in change_order_versions
- Recalculate total_amount from new line_items
- Reset status to 'submitted' for re-review
- Return updated change order with new version number

**3. Version history endpoint `src/app/api/change-orders/[id]/versions/route.ts`:**
- GET: Returns all versions from change_order_versions table for a CO
- Ordered by version DESC
- Join revised_by to get user name
- Return array of versions

**4. Threshold routing `src/lib/change-orders/threshold-routing.ts`:**
- `determineApprover(changeOrderId, totalAmount, projectId, supabase)` async function
- Query approval_thresholds table: first check project-specific (project_id = X), then global (project_id IS NULL)
- Match based on amount: (min_amount IS NULL OR amount >= min_amount) AND (max_amount IS NULL OR amount < max_amount)
- Order by priority ASC, LIMIT 1
- Return `{ approver_role, requires_client_approval }`
- Export `ApprovalRoute` type

Note: The actual user lookup by role is a simple query — don't over-engineer this. For now, return the role string and let the status endpoint handle user assignment.
  </action>
  <verify>
TypeScript compiles: `npx tsc --noEmit`. Status transition endpoint validates correctly. Revision endpoint uses optimistic locking pattern. Threshold routing queries approval_thresholds table correctly.
  </verify>
  <done>
Status transitions work via PATCH /api/change-orders/[id]/status. Counter-offers create new versions via POST /api/change-orders/[id]/revise with optimistic locking. Version history available via GET /api/change-orders/[id]/versions. Threshold routing determines approver by amount.
  </done>
</task>

<task type="auto">
  <name>Task 2: Dashboard UI — list, create, detail, edit pages with all components</name>
  <files>
    src/app/dashboard/aenderungsauftraege/page.tsx
    src/app/dashboard/aenderungsauftraege/neu/page.tsx
    src/app/dashboard/aenderungsauftraege/[id]/page.tsx
    src/app/dashboard/aenderungsauftraege/[id]/bearbeiten/page.tsx
    src/components/change-orders/ChangeOrderForm.tsx
    src/components/change-orders/ChangeOrderList.tsx
    src/components/change-orders/ChangeOrderStatusBadge.tsx
    src/components/change-orders/ChangeOrderDetail.tsx
    src/components/change-orders/VersionHistoryTimeline.tsx
    src/components/change-orders/ApprovalWorkflowCard.tsx
    src/components/change-orders/LineItemEditor.tsx
  </files>
  <action>
**Components (follow existing supplier component patterns):**

**1. `ChangeOrderStatusBadge.tsx`** — Like PurchaseOrderStatusBadge. Color-coded badge using getStatusColor/getStatusLabel from workflow.ts. Status-specific colors: draft=gray, submitted=blue, under_review=amber, approved=green, rejected=red, cancelled=slate.

**2. `LineItemEditor.tsx`** — New component (don't import from suppliers — CO line items support negative amounts for credits). Props: `items`, `onChange`, `readOnly?`. Features:
- Add/remove line items
- Fields: description (text), quantity (number), unit (select: m2, Stk, Pauschal, h, lfm), unit_price (number — can be negative), total (auto-calculated)
- Show total at bottom with explicit +/- indication
- Each row has delete button (unless readOnly)
- Auto-generate UUID for new items

**3. `ChangeOrderForm.tsx`** — Create/edit form. Props: `changeOrder?` (for edit mode), `onSubmit`, `onCancel`. Fields:
- Work order selector (dropdown, required) — fetch work orders for selection
- Description (textarea, required)
- Reason category (select dropdown with German labels from REASON_LABELS)
- Reason details (textarea, optional)
- Schedule impact days (number input, can be negative)
- Line items (using LineItemEditor)
- Show line items to client (checkbox, default true)
- Submit button: "Entwurf speichern" for draft, "Einreichen" for submit

**4. `ChangeOrderList.tsx`** — Filterable list. Status filter pills showing counts per status (follow existing pattern). Columns: CO number, work order, description, total amount (CHF), status badge, created date. Sort by created_at DESC. Link each row to detail page.

**5. `ChangeOrderDetail.tsx`** — Full detail view. Sections:
- Header: CO number, status badge, work order link
- Info grid: reason category, schedule impact, creator, dates
- Line items table (read-only LineItemEditor)
- Total amount (prominently displayed)
- ApprovalWorkflowCard (if not draft)
- VersionHistoryTimeline

**6. `VersionHistoryTimeline.tsx`** — Vertical timeline showing all versions. Each entry: version number, date, revised_by name, revision_reason, amount change. Highlight current version.

**7. `ApprovalWorkflowCard.tsx`** — Shows current approval status and available actions. If under_review: show Approve/Reject buttons. If submitted: show "Awaiting review" state. Show current approver. Display approval/rejection comments.

**Dashboard Pages:**

**8. `/dashboard/aenderungsauftraege/page.tsx`** — Server component. Fetch change orders from API. Render ChangeOrderList. Header with "Neuer Aenderungsauftrag" button linking to /neu. Page title: "Aenderungsauftraege".

**9. `/dashboard/aenderungsauftraege/neu/page.tsx`** — Client component. Render ChangeOrderForm. On submit, POST to /api/change-orders. On success, redirect to detail page.

**10. `/dashboard/aenderungsauftraege/[id]/page.tsx`** — Server component. Fetch change order by ID from API. Fetch versions. Render ChangeOrderDetail. Action buttons: Edit (if draft), Submit (if draft), Cancel.

**11. `/dashboard/aenderungsauftraege/[id]/bearbeiten/page.tsx`** — Client component. Fetch existing CO, render ChangeOrderForm in edit mode. On submit, PATCH to /api/change-orders/[id]. Only accessible when status is 'draft'.

All pages: Use `Suspense` boundaries where needed. German text throughout. Follow existing dashboard page layout patterns (breadcrumbs, page header, content area).
  </action>
  <verify>
`npx tsc --noEmit` passes. Pages render at correct routes. Form creates change orders. List shows status filter pills. Detail page shows version history and approval card.
  </verify>
  <done>
Dashboard UI complete at /dashboard/aenderungsauftraege with list, create, detail, and edit pages. All components render with German labels. Status workflow actions available from detail page. Line items support bidirectional amounts.
  </done>
</task>

</tasks>

<verification>
- Status transition API validates transitions correctly
- Optimistic locking prevents concurrent revision conflicts
- Threshold routing queries correct table with project fallback to global
- Dashboard list page renders with status filter pills
- Create form submits to API and generates CO number
- Detail page shows version history timeline
- Approval card shows correct actions per status
- Line items handle negative amounts for credits
</verification>

<success_criteria>
- Complete approval workflow: draft -> submitted -> under_review -> approved/rejected
- Counter-offers create new versions with history preserved
- Threshold-based approver routing functional
- All audit trail logging via database trigger
- Full dashboard UI at /dashboard/aenderungsauftraege with CRUD operations
- All components follow existing codebase patterns
</success_criteria>

<output>
After completion, create `.planning/phases/21-change-orders/21-02-SUMMARY.md`
</output>
