---
phase: 22-inspection-core
plan: 03
type: execute
wave: 3
depends_on: ["22-01", "22-02"]
files_modified:
  - src/components/inspections/SignatureCapture.tsx
  - src/components/inspections/DefectReviewCard.tsx
  - src/components/inspections/InspectionDetail.tsx
  - src/app/api/inspections/[id]/signature/route.ts
  - src/app/api/inspections/[id]/complete/route.ts
  - src/app/api/inspections/[id]/defects/[defectId]/action/route.ts
  - src/lib/inspections/defect-actions.ts
  - src/lib/inspections/signature-utils.ts
  - src/app/dashboard/abnahmen/[id]/maengel/page.tsx
  - src/app/dashboard/abnahmen/[id]/unterschrift/page.tsx
  - src/app/dashboard/vorlagen/abnahmen/page.tsx
  - src/app/dashboard/vorlagen/abnahmen/neu/page.tsx
  - src/app/dashboard/vorlagen/abnahmen/[id]/page.tsx
  - src/components/inspections/ChecklistEditor.tsx
  - src/components/inspections/InspectionPDF.tsx
  - src/app/api/inspections/[id]/pdf/route.ts
autonomous: true

must_haves:
  truths:
    - "User can capture digital signature from contractor with canvas drawing and typed name"
    - "User can review defects and take action (create task, defer, dismiss)"
    - "User can create follow-up tasks from failed checklist items or defects"
    - "User can complete inspection with defect warnings (warn but allow)"
    - "User can manage inspection templates (create, edit, list)"
    - "Signature PNG is stored in inspections bucket at inspections/{id}/signature.png"
  artifacts:
    - path: "src/components/inspections/SignatureCapture.tsx"
      provides: "Canvas-based signature capture with typed name"
      min_lines: 60
    - path: "src/components/inspections/DefectReviewCard.tsx"
      provides: "Defect action selection (task/defer/dismiss)"
      min_lines: 50
    - path: "src/app/api/inspections/[id]/signature/route.ts"
      provides: "Signature PNG upload endpoint"
      exports: ["POST"]
    - path: "src/app/api/inspections/[id]/complete/route.ts"
      provides: "Inspection completion endpoint with defect warnings"
      exports: ["POST"]
    - path: "src/lib/inspections/defect-actions.ts"
      provides: "Follow-up task creation from defects"
      exports: ["createFollowUpTask", "deferDefect", "dismissDefect"]
    - path: "src/app/dashboard/abnahmen/[id]/unterschrift/page.tsx"
      provides: "Signature capture page"
      min_lines: 40
    - path: "src/app/dashboard/abnahmen/[id]/maengel/page.tsx"
      provides: "Defect review and action page"
      min_lines: 50
    - path: "src/app/dashboard/vorlagen/abnahmen/page.tsx"
      provides: "Inspection template list page"
      min_lines: 30
    - path: "src/components/inspections/InspectionPDF.tsx"
      provides: "PDF protocol template for inspections"
      min_lines: 80
    - path: "src/app/api/inspections/[id]/pdf/route.ts"
      provides: "PDF generation endpoint"
      exports: ["GET"]
  key_links:
    - from: "src/components/inspections/SignatureCapture.tsx"
      to: "/api/inspections/[id]/signature"
      via: "POST PNG data URL"
      pattern: "fetch.*signature"
    - from: "src/lib/inspections/defect-actions.ts"
      to: "tasks table"
      via: "INSERT subtask with parent_task_id"
      pattern: "insert.*tasks"
    - from: "src/components/inspections/DefectReviewCard.tsx"
      to: "/api/inspections/[id]/defects/[defectId]/action"
      via: "POST action selection"
      pattern: "fetch.*action"
    - from: "src/app/api/inspections/[id]/pdf/route.ts"
      to: "src/components/inspections/InspectionPDF.tsx"
      via: "renderToBuffer for PDF generation"
      pattern: "renderToBuffer"
---

<objective>
Build the signature capture, defect review/action workflow, follow-up task generation, inspection completion, template management, and PDF generation.

Purpose: Completes the inspection workflow — after checklist execution (Plan 02), inspector reviews defects, captures contractor signature, generates PDF protocol, and creates follow-up tasks.
Output: Signature capture component, defect action workflow, template management pages, PDF generation, completion flow.
</objective>

<execution_context>
@C:\Users\Mario Giacchino\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\Mario Giacchino\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/22-inspection-core/22-CONTEXT.md
@.planning/phases/22-inspection-core/22-RESEARCH.md
@.planning/phases/22-inspection-core/22-01-SUMMARY.md
@.planning/phases/22-inspection-core/22-02-SUMMARY.md
@src/types/inspections.ts
@src/lib/inspections/queries.ts
@src/lib/inspections/workflow.ts
@src/lib/pdf/change-order-pdf.tsx
@src/app/api/change-orders/[id]/route.ts
@src/components/change-orders/ChangeOrderForm.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Signature capture, defect actions, and completion API</name>
  <files>
    src/lib/inspections/signature-utils.ts
    src/lib/inspections/defect-actions.ts
    src/app/api/inspections/[id]/signature/route.ts
    src/app/api/inspections/[id]/complete/route.ts
    src/app/api/inspections/[id]/defects/[defectId]/action/route.ts
  </files>
  <action>
**src/lib/inspections/signature-utils.ts** — Signature storage helpers:
- `uploadSignature(inspectionId: string, dataUrl: string)`: Converts base64 data URL to Buffer. Uploads to inspections/{inspectionId}/signature.png using Supabase storage. Returns storage path string.
- `getSignatureUrl(storagePath: string)`: Returns 1-hour signed URL for the signature PNG.

**src/lib/inspections/defect-actions.ts** — Defect action handlers:
- `createFollowUpTask(defect: InspectionDefect, inspection: Inspection, assigneeId: string)`: Creates a task in tasks table as a subtask of the work order's task. Fields: title = "Mangel: {defect.title}", description = defect.description + " (Schweregrad: {severity})", project_id = inspection.project_id, renovation_project_id (from work order if available), parent_task_id = inspection work order's task_id (from work_orders.task_id), status = 'open', priority = severity-based ('schwer' -> 'urgent', 'mittel' -> 'high', 'gering' -> 'normal'). Returns created task. Updates defect: set action='task_created', linked_task_id=task.id.
- `deferDefect(defectId: string, reason?: string)`: Updates defect action='deferred', action_reason=reason.
- `dismissDefect(defectId: string, reason: string)`: Updates defect action='dismissed', action_reason=reason. Reason is required for dismiss.

**src/app/api/inspections/[id]/signature/route.ts**
- POST: Save signature. JSON body: { image_data_url: string (base64 PNG), signer_name: string, signer_role: string }. Auth required.
  1. Validate inspection exists and status is 'completed' (signature comes after completion).
  2. Upload signature PNG using signature-utils.uploadSignature().
  3. Update inspection: signature_storage_path, signer_name, signer_role, signed_at=NOW(), status='signed'.
  4. Returns { inspection, signature_url }.
- Also support "refused" case: POST with { refused: true, refused_reason: string }. Sets signature_refused=true, signature_refused_reason, but does NOT change status to 'signed'. Inspection stays at 'completed'.

**src/app/api/inspections/[id]/complete/route.ts**
- POST: Complete inspection. Auth required. JSON body: { acknowledge_defects?: boolean }.
  1. Validate inspection status is 'in_progress'.
  2. Fetch all defects for this inspection.
  3. Compute overall_result using workflow.computeOverallResult(defects).
  4. Check if there are open defects. If yes and acknowledge_defects !== true, return { warning: true, message: "Es gibt offene Mängel. Möchten Sie die Abnahme trotzdem abschliessen?", open_defects_count: N, overall_result }. Client must re-submit with acknowledge_defects: true.
  5. If no open defects OR acknowledged: Update inspection status='completed', overall_result, completed_at=NOW(). Returns { inspection }.

**src/app/api/inspections/[id]/defects/[defectId]/action/route.ts**
- POST: Take action on defect. JSON body: { action: 'task_created' | 'deferred' | 'dismissed', reason?: string, assignee_id?: string }.
  1. Auth required. Validate defect exists and belongs to inspection.
  2. If defect.action is not null, return 400 "Aktion bereits ausgeführt" (prevent duplicate actions).
  3. Based on action:
     - 'task_created': Call defect-actions.createFollowUpTask(). assignee_id required. Return { defect, task }.
     - 'deferred': Call defect-actions.deferDefect(). Return { defect }.
     - 'dismissed': reason required. Call defect-actions.dismissDefect(). Return { defect }.
  </action>
  <verify>
Run: `npx tsc --noEmit` — no TypeScript errors.
Verify: signature-utils can convert data URL to buffer.
Verify: defect-actions creates task with correct parent_task_id linking.
  </verify>
  <done>Signature upload stores PNG in inspections bucket. Follow-up tasks created as subtasks with severity-based priority. Completion flow warns about open defects. Defect actions prevent duplicate task creation.</done>
</task>

<task type="auto">
  <name>Task 2: Signature capture, defect review, and completion UI pages</name>
  <files>
    src/components/inspections/SignatureCapture.tsx
    src/components/inspections/DefectReviewCard.tsx
    src/components/inspections/InspectionDetail.tsx
    src/app/dashboard/abnahmen/[id]/maengel/page.tsx
    src/app/dashboard/abnahmen/[id]/unterschrift/page.tsx
  </files>
  <action>
**src/components/inspections/SignatureCapture.tsx** — 'use client' component:
Uses react-signature-canvas. Import: `import SignatureCanvas from 'react-signature-canvas'`.
Props: onSave callback (imageDataUrl, signerName, signerRole), onRefused callback (reason).
- Canvas area: 500x200px with dashed border, white background. Label: "Unterschrift (bitte hier zeichnen)".
- Clear button: "Löschen" to reset canvas.
- Name input: text field labeled "Name (getippt zur Identifikation)", placeholder "Max Mustermann".
- Role input: text field labeled "Rolle", placeholder "Handwerker" with default value "Handwerker".
- Save button: "Unterschrift speichern". Validates: canvas not empty, name not empty. Gets PNG data URL via sigCanvas.current.toDataURL('image/png').
- Refusal option: "Unterschrift verweigert" button (secondary style). Opens reason textarea (mandatory). "Ohne Unterschrift abschliessen" button to confirm refusal.
- Loading state during save.
- Touch-friendly: all interactive elements min 48px height.
- Responsive: canvas width adapts to container (use w-full with max-w-[500px]).

**src/components/inspections/DefectReviewCard.tsx** — 'use client' component:
Defect action selection card. Props: defect (InspectionDefect), onActionTaken callback, users (for assignee selection).
- Header: defect title, severity badge, current status
- Description text
- Photo thumbnails (if any)
- If defect.action is already set: show current action as read-only ("Aufgabe erstellt", "Verschoben", "Verworfen") with action_reason if present
- If defect.action is null: show action selection radio buttons:
  - "Aufgabe erstellen" (task_created) — shows assignee dropdown when selected
  - "Auf nächste Abnahme verschieben" (deferred) — optional reason textarea
  - "Verwerfen" (dismissed) — mandatory reason textarea
- Submit button: "Aktion ausführen"
- Disable submit until action selected (and reason filled for dismissed)

**src/components/inspections/InspectionDetail.tsx** — 'use client' component:
Comprehensive inspection detail view. Props: inspection (Inspection), defects (InspectionDefect[]).
- Header: title, status badge, overall result badge (if set)
- Metadata: inspection date, inspector, work order/project link
- Stats grid: Total items, Passed, Failed, N/A, Unchecked (computed from checklist_items)
- Defect summary: count by severity (cards for Schwer/Mittel/Gering with counts)
- Signature section: if signed, show signer name + signed_at. If refused, show "Unterschrift verweigert" + reason.
- Action buttons based on status:
  - in_progress: "Checkliste bearbeiten", "Abnahme abschliessen"
  - completed: "Mängel prüfen", "Unterschrift erfassen", "PDF erstellen"
  - signed: "PDF herunterladen"

**src/app/dashboard/abnahmen/[id]/maengel/page.tsx** — Client Component ('use client'):
Defect review and action page. Page title: "Mängel prüfen".
- Fetches inspection and defects from /api/inspections/{id}
- Fetches users from /api/auth/session (or user list) for assignee selection
- Renders DefectReviewCard for each defect, ordered by severity (schwer first)
- Summary at top: "X Mängel gesamt, Y ohne Aktion"
- When action taken on a defect: POST to /api/inspections/{id}/defects/{defectId}/action. Refresh defect list.
- Back button to inspection detail

**src/app/dashboard/abnahmen/[id]/unterschrift/page.tsx** — Client Component ('use client'):
Signature capture page. Page title: "Unterschrift".
- Fetches inspection from /api/inspections/{id}
- If status is not 'completed', redirect to detail page with message "Abnahme muss zuerst abgeschlossen werden"
- Shows inspection summary: title, date, overall result, defect count (highlight schwer in red)
- Renders SignatureCapture component
- On save: POST to /api/inspections/{id}/signature with { image_data_url, signer_name, signer_role }
- On refused: POST to /api/inspections/{id]/signature with { refused: true, refused_reason }
- On success: redirect to /dashboard/abnahmen/{id} with success message

Update **src/app/dashboard/abnahmen/[id]/page.tsx** (from Plan 22-02):
Replace the inline detail rendering with InspectionDetail component. Add navigation links to /maengel and /unterschrift sub-pages. Wire up the "Abnahme abschliessen" button to POST /api/inspections/{id}/complete. Handle the warning response (show modal asking "Es gibt offene Mängel...") and re-submit with acknowledge_defects: true.
  </action>
  <verify>
Run: `npx tsc --noEmit` — no TypeScript errors.
Run: `npm run build` — build succeeds.
Navigate to /dashboard/abnahmen/{id}/unterschrift — signature canvas renders.
Navigate to /dashboard/abnahmen/{id}/maengel — defect review cards render with action selection.
  </verify>
  <done>Signature canvas captures drawing + typed name. Defect review cards allow action selection. Completion flow warns about open defects. Refused signatures documented with reason.</done>
</task>

<task type="auto">
  <name>Task 3: Template management pages and PDF generation</name>
  <files>
    src/components/inspections/ChecklistEditor.tsx
    src/app/dashboard/vorlagen/abnahmen/page.tsx
    src/app/dashboard/vorlagen/abnahmen/neu/page.tsx
    src/app/dashboard/vorlagen/abnahmen/[id]/page.tsx
    src/components/inspections/InspectionPDF.tsx
    src/app/api/inspections/[id]/pdf/route.ts
  </files>
  <action>
**src/components/inspections/ChecklistEditor.tsx** — 'use client' component:
Template checklist editor for creating/editing inspection templates.
Props: initialSections (ChecklistSection[]), onChange callback.
- Sections list: each section has name (editable text input) and items
- "Abschnitt hinzufügen" button adds new section with generated UUID
- Per section: "Element hinzufügen" button adds new item (title + description fields)
- Drag reorder: use button-based reorder (up/down arrows) for sections and items (same pattern as template editor in src/components/templates/)
- Delete button per section and per item (with confirmation for sections that have items)
- Each item: title (required), description (optional textarea)
- Generate UUIDs for section.id and item.id using crypto.randomUUID()

**src/app/dashboard/vorlagen/abnahmen/page.tsx** — Server Component:
Page title: "Abnahme-Vorlagen". Fetches templates from /api/inspection-templates.
- List of templates: name, trade_category, formality_level, item count, is_active status
- Link button: "Neue Vorlage" -> /dashboard/vorlagen/abnahmen/neu
- Click template -> /dashboard/vorlagen/abnahmen/{id}

**src/app/dashboard/vorlagen/abnahmen/neu/page.tsx** — Client Component ('use client'):
Create template form.
- Fields: name (text), description (textarea), trade_category (select with all trade categories), formality_level (radio: Informeller Check / Formales Abnahmeprotokoll)
- ChecklistEditor component for building sections/items
- Submit: POST to /api/inspection-templates. Redirect to template list on success.

**src/app/dashboard/vorlagen/abnahmen/[id]/page.tsx** — Client Component ('use client'):
Edit template page. Fetches template from /api/inspection-templates/{id}.
- Same fields as create page, pre-populated
- ChecklistEditor pre-loaded with template.checklist_sections
- Save: PATCH to /api/inspection-templates/{id}
- Delete: Soft-delete (PATCH is_active=false) with confirmation dialog
- Back button to template list

**src/components/inspections/InspectionPDF.tsx** — React PDF component using @react-pdf/renderer:
Follow exact pattern from src/lib/pdf/change-order-pdf.tsx.
PDF document structure:
- Header: "Abnahmeprotokoll" or "Inspektionsbericht" (based on formality_level)
- Metadata block: title, inspection date, inspector name, work order/project, status, overall result
- Checklist results: grouped by section. Each item shows title + result icon (checkmark for pass, X for fail, dash for na) + notes
- Defect table: title, severity, status, description, action taken
- Signature block: if signed, embed signature PNG as Image component. Show signer name, role, timestamp. If refused, show "Unterschrift verweigert: {reason}".
- Footer: "Erstellt am {date}" with page numbers

Use @react-pdf/renderer components: Document, Page, Text, View, Image, StyleSheet.
Register fonts if needed (follow existing pattern).
Signature image: load from inspections bucket via signed URL. Pass as base64 data URL to Image component.

**src/app/api/inspections/[id]/pdf/route.ts**
- GET: Generate and return PDF. Auth required.
  1. Fetch inspection with defects from queries.getInspection(id)
  2. If inspection has signature, get signed URL for signature PNG
  3. Render PDF using @react-pdf/renderer renderToBuffer with InspectionPDF component
  4. Return Response with Content-Type: application/pdf, Content-Disposition: attachment with filename "Abnahme-{title}-{date}.pdf"
  </action>
  <verify>
Run: `npx tsc --noEmit` — no TypeScript errors.
Run: `npm run build` — build succeeds.
Navigate to /dashboard/vorlagen/abnahmen — template list renders.
Navigate to /dashboard/vorlagen/abnahmen/neu — template editor allows adding sections and items.
Call GET /api/inspections/{id}/pdf — returns valid PDF buffer.
  </verify>
  <done>Template management pages allow CRUD of inspection templates with checklist editor. PDF generation creates Abnahmeprotokoll with checklist results, defects, and embedded signature. Template editor supports section/item add/remove/reorder.</done>
</task>

</tasks>

<verification>
1. `npm run build` succeeds
2. Signature canvas renders and captures drawing + typed name
3. Signature PNG stored in inspections/{id}/signature.png
4. Signature refusal documented with mandatory reason
5. Defect review cards show action selection (task/defer/dismiss)
6. Follow-up tasks created as subtasks with severity-based priority
7. Completion warns about open defects, allows acknowledge
8. Template management pages work (list, create, edit, soft-delete)
9. PDF generates with checklist results, defects, and embedded signature
10. PDF Content-Disposition header sets proper filename
</verification>

<success_criteria>
- User can capture contractor signature via canvas drawing + typed name
- User can handle signature refusal with mandatory reason
- User can review defects and take action: create task, defer, dismiss
- Follow-up tasks appear as subtasks on the work order's task
- Inspection completion warns about open defects (warn, not block)
- User can manage inspection templates (create, edit, list, soft-delete)
- Checklist editor supports sections with items, add/remove/reorder
- PDF protocol includes checklist results, defect table, signature image
- All 8 INSP requirements (INSP-01 through INSP-08) are satisfied
</success_criteria>

<output>
After completion, create `.planning/phases/22-inspection-core/22-03-SUMMARY.md`
</output>
