---
phase: 22-inspection-core
plan: 02
type: execute
wave: 2
depends_on: ["22-01"]
files_modified:
  - src/app/api/inspections/[id]/defects/route.ts
  - src/app/api/inspections/[id]/defects/[defectId]/route.ts
  - src/app/api/inspections/[id]/photos/route.ts
  - src/app/api/inspections/[id]/defects/[defectId]/photos/route.ts
  - src/components/inspections/InspectionStatusBadge.tsx
  - src/components/inspections/SeverityBadge.tsx
  - src/components/inspections/ChecklistExecution.tsx
  - src/components/inspections/ChecklistItemCard.tsx
  - src/components/inspections/DefectForm.tsx
  - src/components/inspections/DefectList.tsx
  - src/app/dashboard/abnahmen/page.tsx
  - src/app/dashboard/abnahmen/neu/page.tsx
  - src/app/dashboard/abnahmen/[id]/page.tsx
  - src/app/dashboard/abnahmen/[id]/checkliste/page.tsx
  - src/components/inspections/InspectionForm.tsx
  - src/components/inspections/InspectionList.tsx
autonomous: true

must_haves:
  truths:
    - "User can create an inspection linked to project/work order with populated checklist"
    - "User can mark checklist items as pass/fail/na with photos per item"
    - "User can log defects with description and photos"
    - "Defect photos are stored in dedicated inspections bucket"
    - "Inspection list page shows all inspections with status badges"
  artifacts:
    - path: "src/app/dashboard/abnahmen/page.tsx"
      provides: "Inspection list page"
      min_lines: 30
    - path: "src/app/dashboard/abnahmen/neu/page.tsx"
      provides: "Create inspection page with template selection"
      min_lines: 30
    - path: "src/app/dashboard/abnahmen/[id]/checkliste/page.tsx"
      provides: "Checklist execution page with pass/fail/na and photo upload"
      min_lines: 40
    - path: "src/components/inspections/ChecklistExecution.tsx"
      provides: "Checklist runtime with section grouping and item result tracking"
      min_lines: 60
    - path: "src/components/inspections/DefectForm.tsx"
      provides: "Defect creation form with severity selector and photo nudge"
      min_lines: 40
    - path: "src/app/api/inspections/[id]/defects/route.ts"
      provides: "List and create defects for inspection"
      exports: ["GET", "POST"]
    - path: "src/app/api/inspections/[id]/photos/route.ts"
      provides: "Upload photos for checklist items"
      exports: ["GET", "POST"]
  key_links:
    - from: "src/app/dashboard/abnahmen/[id]/checkliste/page.tsx"
      to: "/api/inspections/[id]"
      via: "PATCH to save checklist progress"
      pattern: "fetch.*api/inspections"
    - from: "src/components/inspections/DefectForm.tsx"
      to: "/api/inspections/[id]/defects"
      via: "POST to create defect"
      pattern: "fetch.*defects"
    - from: "src/components/inspections/ChecklistItemCard.tsx"
      to: "/api/inspections/[id]/photos"
      via: "POST to upload item photos"
      pattern: "fetch.*photos"
---

<objective>
Build the checklist execution UI, defect logging, and photo upload features for inspections.

Purpose: Core inspection workflow — inspector creates inspection, executes checklist items (pass/fail/na), logs defects with photos.
Output: Dashboard pages for inspection list/create/detail/checklist, defect CRUD API, photo upload API, and all supporting components.
</objective>

<execution_context>
@C:\Users\Mario Giacchino\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\Mario Giacchino\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/22-inspection-core/22-CONTEXT.md
@.planning/phases/22-inspection-core/22-RESEARCH.md
@.planning/phases/22-inspection-core/22-01-SUMMARY.md
@src/types/inspections.ts
@src/lib/inspections/queries.ts
@src/app/api/change-orders/[id]/route.ts
@src/components/change-orders/ChangeOrderStatusBadge.tsx
@src/app/dashboard/aenderungsauftraege/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Defect and photo API routes</name>
  <files>
    src/app/api/inspections/[id]/defects/route.ts
    src/app/api/inspections/[id]/defects/[defectId]/route.ts
    src/app/api/inspections/[id]/photos/route.ts
    src/app/api/inspections/[id]/defects/[defectId]/photos/route.ts
  </files>
  <action>
**src/app/api/inspections/[id]/defects/route.ts**
- GET: List defects for inspection. Uses queries.listDefects(inspectionId). Auth required. Returns DefectsResponse.
- POST: Create defect. JSON body matches CreateDefectInput. Auth required. Validates inspection exists. Sets created_by from x-user-id. Returns { defect } with 201.

**src/app/api/inspections/[id]/defects/[defectId]/route.ts**
- PATCH: Update defect. JSON body matches UpdateDefectInput. Auth required. Validates defect belongs to inspection. If status change, validate transition. Returns { defect }.
- DELETE: Delete defect. Auth required. Only if action is null (no action taken yet). Returns { success: true }.

**src/app/api/inspections/[id]/photos/route.ts** — Checklist item photo management:
- GET: List photos for checklist items. Query param: ?item_id= (optional). Returns signed URLs from inspections bucket. Auth required. Returns { photos: { item_id, url, path }[] }.
- POST: Upload photo for checklist item. FormData with: file (image), item_id (string). Auth required. Upload to inspections/{inspectionId}/items/{uuid}.webp using Supabase storage. Compress with imageCompression if needed. Update the checklist_items JSONB in the inspection to add the storage path to the item's photo_storage_paths array. Returns { photo: { item_id, path, url } } with 201.

**src/app/api/inspections/[id]/defects/[defectId]/photos/route.ts** — Defect photo management:
- GET: List photos for defect. Returns signed URLs for each path in defect.photo_storage_paths. Auth required. Returns { photos: { url, path }[] }.
- POST: Upload photo for defect. FormData with: file (image). Auth required. Upload to inspections/{inspectionId}/defects/{uuid}.webp. Append path to defect.photo_storage_paths array. Returns { photo: { path, url } } with 201.

Storage pattern: Use createClient().storage.from('inspections') for all uploads. Generate signed URLs with 1-hour expiry using storage.createSignedUrl(). Follow existing pattern from knowledge base attachments (src/app/api/knowledge/articles/[id]/attachments/route.ts).

Important: The `inspections` storage bucket must exist in Supabase. Add a check at the top of photo routes — if bucket doesn't exist, return 500 with message "Inspections storage bucket not configured".
  </action>
  <verify>
Run: `npx tsc --noEmit` — no TypeScript errors.
Verify: All 4 route files export correct HTTP methods.
  </verify>
  <done>Defect CRUD API returns defects with severity/status. Photo upload stores files in inspections bucket at correct paths. Checklist item photos update the JSONB array.</done>
</task>

<task type="auto">
  <name>Task 2: Badge components and inspection list/create pages</name>
  <files>
    src/components/inspections/InspectionStatusBadge.tsx
    src/components/inspections/SeverityBadge.tsx
    src/components/inspections/InspectionList.tsx
    src/components/inspections/InspectionForm.tsx
    src/app/dashboard/abnahmen/page.tsx
    src/app/dashboard/abnahmen/neu/page.tsx
    src/app/dashboard/abnahmen/[id]/page.tsx
  </files>
  <action>
**src/components/inspections/InspectionStatusBadge.tsx** — 'use client' component:
Status badge for inspection status. Config map:
- in_progress: { label: 'In Bearbeitung', color: 'bg-blue-100 text-blue-800' }
- completed: { label: 'Abgeschlossen', color: 'bg-green-100 text-green-800' }
- signed: { label: 'Unterschrieben', color: 'bg-purple-100 text-purple-800' }
Follow existing badge pattern from ChangeOrderStatusBadge.

**src/components/inspections/SeverityBadge.tsx** — 'use client' component:
Severity badge for defects. Config map (from research):
- gering: { label: 'Gering', color: 'bg-yellow-100 text-yellow-800' }
- mittel: { label: 'Mittel', color: 'bg-orange-100 text-orange-800' }
- schwer: { label: 'Schwer', color: 'bg-red-100 text-red-800' }

**src/components/inspections/InspectionList.tsx** — 'use client' component:
Filterable list of inspections. Props: inspections: Inspection[].
- Shows cards with: title, status badge, inspection_date formatted Swiss, inspector name, work order or project name, defect count (if joined)
- Filter by status (dropdown), search by title
- Click navigates to /dashboard/abnahmen/{id}

**src/components/inspections/InspectionForm.tsx** — 'use client' component:
Form to create inspection. Props: onSubmit callback.
- Fields: title (text), description (textarea), work_order_id (select, fetched from /api/work-orders), project_id (select, fetched from /api/renovation-projects), template_id (select, fetched from /api/inspection-templates filtered by trade if work order has trade), inspection_date (date input, defaults to today)
- Either work_order_id OR project_id required (radio toggle to pick which)
- Template selector shows templates filtered by trade_category of the selected work order's partner. If no work order selected, show all templates.
- On submit: POST to /api/inspections with form data. Redirect to /dashboard/abnahmen/{newId}/checkliste

**src/app/dashboard/abnahmen/page.tsx** — Server Component:
Page title: "Abnahmen". Fetches inspections from /api/inspections (internal fetch). Renders InspectionList. Link button to /dashboard/abnahmen/neu ("Neue Abnahme").

**src/app/dashboard/abnahmen/neu/page.tsx** — Client Component ('use client'):
Page title: "Neue Abnahme". Renders InspectionForm. On success redirects to checklist page.

**src/app/dashboard/abnahmen/[id]/page.tsx** — Client Component ('use client'):
Inspection detail page. Fetches inspection from /api/inspections/{id} (includes defects).
Shows:
- Header: title, status badge, inspection date, inspector
- Link to work order / project
- Overall result badge (if set)
- Summary stats: total items, passed, failed, na, unchecked
- Defect summary: count by severity
- Action buttons: "Checkliste bearbeiten" (link to /checkliste), "Maengel verwalten" (link to /maengel — built in Plan 22-03)
- If status=in_progress, show "Abnahme abschliessen" button (calls PATCH with status=completed)
- Signature info (if signed): signer name, signed_at date
  </action>
  <verify>
Run: `npx tsc --noEmit` — no TypeScript errors.
Run: `npm run build` — build succeeds.
Navigate to /dashboard/abnahmen — page loads with inspection list.
  </verify>
  <done>Inspection list, create, and detail pages render. Status and severity badges display correctly. Form creates inspection with template-populated checklist.</done>
</task>

<task type="auto">
  <name>Task 3: Checklist execution and defect logging UI</name>
  <files>
    src/components/inspections/ChecklistItemCard.tsx
    src/components/inspections/ChecklistExecution.tsx
    src/components/inspections/DefectForm.tsx
    src/components/inspections/DefectList.tsx
    src/app/dashboard/abnahmen/[id]/checkliste/page.tsx
  </files>
  <action>
**src/components/inspections/ChecklistItemCard.tsx** — 'use client' component:
Single checklist item with result buttons and photo support.
Props: item (ChecklistItem from section), result (ChecklistItemResult | null), onResultChange callback, onAddPhoto callback, photoCount (number).
- Display: item title, description (gray text below)
- Three result buttons side by side: "Bestanden" (green when selected), "Nicht bestanden" (red when selected), "N/A" (gray when selected)
- Notes textarea (optional, saves to result.notes)
- Photo button: "+ Foto ({count})" — shows count of attached photos. Clicking triggers onAddPhoto.
- When result is 'fail', show prompt: "Mangel erfassen?" with button to open defect form for this item.
- Visual state: unchecked items have neutral border. Pass = green left border. Fail = red left border. NA = gray left border.
- Touch-friendly: min 48px height on all interactive elements.

**src/components/inspections/ChecklistExecution.tsx** — 'use client' component:
Full checklist execution interface. Props: inspection (Inspection), onSave callback.
- Renders checklist_items (ChecklistSectionResult[]) grouped by section
- Each section has a collapsible header showing section name and progress (e.g., "3/5 geprüft")
- Items rendered via ChecklistItemCard
- Progress bar at top: total checked / total items
- "Alle speichern" button at bottom — calls onSave with updated checklist_items JSONB
- Auto-save: debounce 3 seconds after last change (save partial progress)
- Photo upload: uses file input + fetch POST to /api/inspections/{id}/photos with FormData (file + item_id)
- "Mangel erfassen" inline: when user clicks on failed item's "Mangel erfassen?" prompt, open DefectForm in a modal/slide-over with checklist_item_id pre-filled

**src/components/inspections/DefectForm.tsx** — 'use client' component:
Form to create a defect. Props: inspectionId (string), checklistItemId? (string, pre-filled if from checklist item), onClose callback, onCreated callback.
- Fields: title (text, required), description (textarea), severity (radio: Gering/Mittel/Schwer with color indicators)
- Photo upload: file input for photos. After selecting, upload to /api/inspections/{id}/defects/{defectId}/photos. Show preview thumbnails.
- Photo nudge: if no photos added when clicking "Speichern", show confirmation: "Möchten Sie ein Foto hinzufügen? (Optional)" with "Ohne Foto speichern" and "Foto hinzufügen" buttons. Do NOT block — this is a nudge only.
- Submit: POST to /api/inspections/{id}/defects. Then upload photos if any. Call onCreated.
- Styled as a modal dialog with backdrop.

**src/components/inspections/DefectList.tsx** — 'use client' component:
List of defects for an inspection. Props: defects (InspectionDefect[]), onDefectClick callback.
- Shows cards with: title, severity badge, status badge (open/in_progress/resolved), description preview, photo count icon
- Sort by severity DESC (schwer first), then by created_at ASC
- Click on defect card calls onDefectClick

**src/app/dashboard/abnahmen/[id]/checkliste/page.tsx** — Client Component ('use client'):
Checklist execution page. Fetches inspection from /api/inspections/{id}.
- Page title: "{inspection.title} — Checkliste"
- Renders ChecklistExecution component
- Save handler: PATCH /api/inspections/{id} with { checklist_items: updatedItems }
- Back button to /dashboard/abnahmen/{id}
- If inspection status is not 'in_progress', show read-only view (result buttons disabled, no edit)
- Below checklist: DefectList showing current defects. "Neuen Mangel erfassen" button opens DefectForm modal (without pre-filled checklist_item_id).
  </action>
  <verify>
Run: `npx tsc --noEmit` — no TypeScript errors.
Run: `npm run build` — build succeeds.
Navigate to /dashboard/abnahmen/{id}/checkliste — checklist renders with sections, items can be marked pass/fail/na, defects can be created.
  </verify>
  <done>Checklist execution renders sections with items. Items can be marked pass/fail/na with visual indicators. Defects can be created from failed items or independently. Photos upload to inspections bucket. Photo nudge prompts but doesn't block.</done>
</task>

</tasks>

<verification>
1. `npm run build` succeeds
2. /dashboard/abnahmen page shows inspection list with status badges
3. /dashboard/abnahmen/neu creates inspection with template-populated checklist
4. /dashboard/abnahmen/{id}/checkliste renders sections and items with pass/fail/na buttons
5. Defect form creates defects with severity classification
6. Photo upload stores files in inspections bucket
7. Checklist progress shows checked/total counts per section
</verification>

<success_criteria>
- User can navigate to inspection list, create new inspection with template
- User can execute checklist items with pass/fail/na
- User can attach photos to individual checklist items
- User can create defects from failed items or independently
- Defects show severity badges (Gering/Mittel/Schwer)
- Photo nudge prompts but doesn't require photos
- Progress tracking shows checked items per section
</success_criteria>

<output>
After completion, create `.planning/phases/22-inspection-core/22-02-SUMMARY.md`
</output>
