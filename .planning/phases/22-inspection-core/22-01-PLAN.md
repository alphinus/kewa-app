---
phase: 22-inspection-core
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/059_inspections.sql
  - src/types/inspections.ts
  - src/app/api/inspections/route.ts
  - src/app/api/inspections/[id]/route.ts
  - src/app/api/inspection-templates/route.ts
  - src/app/api/inspection-templates/[id]/route.ts
  - src/lib/inspections/queries.ts
  - src/lib/inspections/workflow.ts
autonomous: true

must_haves:
  truths:
    - "Inspection templates table exists with trade_category and JSONB checklist_sections"
    - "Inspections table exists with status workflow, JSONB checklist_items, and signature fields"
    - "Inspection defects table exists with severity classification and independent lifecycle"
    - "API returns inspection templates filtered by trade category"
    - "API creates inspection with checklist populated from template"
    - "Status transition trigger validates inspection workflow (in_progress -> completed -> signed)"
  artifacts:
    - path: "supabase/migrations/059_inspections.sql"
      provides: "Inspection schema (templates, inspections, defects), enums, triggers, indexes"
      contains: "CREATE TABLE inspections"
    - path: "src/types/inspections.ts"
      provides: "TypeScript types for inspections, templates, defects, checklist items"
      exports: ["InspectionTemplate", "Inspection", "InspectionDefect", "ChecklistSection", "ChecklistItem"]
    - path: "src/app/api/inspections/route.ts"
      provides: "List and create inspections"
      exports: ["GET", "POST"]
    - path: "src/app/api/inspections/[id]/route.ts"
      provides: "Get, update, delete single inspection"
      exports: ["GET", "PATCH", "DELETE"]
    - path: "src/app/api/inspection-templates/route.ts"
      provides: "List and create inspection templates"
      exports: ["GET", "POST"]
    - path: "src/lib/inspections/queries.ts"
      provides: "Database query helpers for inspections and templates"
    - path: "src/lib/inspections/workflow.ts"
      provides: "Status transition validation for inspections and defects"
  key_links:
    - from: "src/app/api/inspections/route.ts"
      to: "src/lib/inspections/queries.ts"
      via: "imports query functions"
      pattern: "import.*from.*inspections/queries"
    - from: "src/app/api/inspections/route.ts"
      to: "src/types/inspections.ts"
      via: "imports types"
      pattern: "import.*from.*types/inspections"
    - from: "supabase/migrations/059_inspections.sql"
      to: "trade_category enum"
      via: "references existing enum"
      pattern: "trade_category trade_category"
---

<objective>
Create the database schema, TypeScript types, and CRUD APIs for inspections, inspection templates, and defects.

Purpose: Foundation layer for the entire inspection workflow. All UI plans depend on these artifacts.
Output: Migration file with 3 tables + 4 enums + triggers, TypeScript types file, 4 API route files, lib helpers.
</objective>

<execution_context>
@C:\Users\Mario Giacchino\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\Mario Giacchino\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/22-inspection-core/22-CONTEXT.md
@.planning/phases/22-inspection-core/22-RESEARCH.md
@supabase/migrations/057_change_orders.sql
@src/types/change-orders.ts
@src/app/api/change-orders/route.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Database migration and npm install</name>
  <files>supabase/migrations/059_inspections.sql</files>
  <action>
Install react-signature-canvas and its TypeScript types (needed in Plan 22-03, but install now to avoid dependency issues):

```bash
npm install react-signature-canvas
npm install --save-dev @types/react-signature-canvas
```

Create migration `059_inspections.sql` with:

**Enums (use DO/EXCEPTION pattern for idempotency like 057):**
- `inspection_formality`: `'informal_check'`, `'formal_abnahme'`
- `inspection_status`: `'in_progress'`, `'completed'`, `'signed'`
- `inspection_result`: `'passed'`, `'passed_with_conditions'`, `'failed'`
- `defect_severity`: `'gering'`, `'mittel'`, `'schwer'`
- `defect_status`: `'open'`, `'in_progress'`, `'resolved'`

**Table: inspection_templates**
- id UUID PK
- name TEXT NOT NULL
- description TEXT
- trade_category trade_category NOT NULL (references existing enum from 014_partner.sql)
- formality_level inspection_formality NOT NULL DEFAULT 'informal_check'
- checklist_sections JSONB NOT NULL DEFAULT '[]' -- [{id, name, items: [{id, title, description}]}]
- is_active BOOLEAN DEFAULT true
- created_by UUID REFERENCES users(id)
- created_at, updated_at TIMESTAMPTZ

**Table: inspections**
- id UUID PK
- work_order_id UUID REFERENCES work_orders(id) (nullable)
- project_id UUID REFERENCES renovation_projects(id) (nullable)
- template_id UUID REFERENCES inspection_templates(id) (nullable)
- parent_inspection_id UUID REFERENCES inspections(id) (nullable, for Phase 23 re-inspections)
- title TEXT NOT NULL
- description TEXT
- inspector_id UUID NOT NULL REFERENCES users(id)
- inspection_date DATE NOT NULL DEFAULT CURRENT_DATE
- status inspection_status NOT NULL DEFAULT 'in_progress'
- checklist_items JSONB NOT NULL DEFAULT '[]' -- copied from template, editable
- overall_result inspection_result (nullable, set at completion)
- notes TEXT
- signature_storage_path TEXT (nullable)
- signer_name TEXT (nullable)
- signer_role TEXT (nullable)
- signed_at TIMESTAMPTZ (nullable)
- signature_refused BOOLEAN DEFAULT false
- signature_refused_reason TEXT (nullable)
- completed_at TIMESTAMPTZ (nullable)
- created_at, updated_at TIMESTAMPTZ
- CHECK (work_order_id IS NOT NULL OR project_id IS NOT NULL)

**Table: inspection_defects**
- id UUID PK
- inspection_id UUID NOT NULL REFERENCES inspections(id) ON DELETE CASCADE
- checklist_item_id TEXT (nullable, links to item ID in checklist_items JSONB)
- title TEXT NOT NULL
- description TEXT
- severity defect_severity NOT NULL
- status defect_status NOT NULL DEFAULT 'open'
- action TEXT (nullable) -- 'task_created' | 'deferred' | 'dismissed'
- action_reason TEXT (nullable)
- linked_task_id UUID REFERENCES tasks(id) (nullable)
- photo_storage_paths TEXT[] DEFAULT '{}'
- created_by UUID REFERENCES users(id)
- resolved_by UUID REFERENCES users(id)
- resolved_at TIMESTAMPTZ
- created_at, updated_at TIMESTAMPTZ

**Triggers:**
1. `validate_inspection_status_transition` - BEFORE UPDATE trigger on inspections. Valid transitions: in_progress->completed, completed->signed. When transitioning to 'signed', require signature_storage_path AND signer_name (unless signature_refused=true). Use JSONB transition map pattern from change orders.
2. `update_updated_at` triggers on all three tables
3. `log_inspection_audit` - AFTER UPDATE on inspections for status changes, using create_audit_log function

**Indexes:**
- idx_inspections_work_order ON inspections(work_order_id)
- idx_inspections_project ON inspections(project_id)
- idx_inspections_template ON inspections(template_id)
- idx_inspections_status ON inspections(status)
- idx_inspections_inspector ON inspections(inspector_id)
- idx_inspection_defects_inspection ON inspection_defects(inspection_id)
- idx_inspection_defects_severity ON inspection_defects(severity)
- idx_inspection_defects_status ON inspection_defects(status)
- idx_inspection_templates_trade ON inspection_templates(trade_category) WHERE is_active = true

Add COMMENT ON for all tables and non-obvious columns. Follow exact comment style from 057_change_orders.sql.

**Storage bucket:** Create the `inspections` storage bucket using Supabase SQL:

```sql
INSERT INTO storage.buckets (id, name, public)
VALUES ('inspections', 'inspections', false)
ON CONFLICT (id) DO NOTHING;
```

Add RLS policy for authenticated users. Path pattern: inspections/{inspection_id}/items/, inspections/{inspection_id}/defects/, inspections/{inspection_id}/signature.png. Follow the pattern from existing storage setup (e.g., media bucket or kb_articles bucket). Include SELECT, INSERT policies for authenticated users.
  </action>
  <verify>
Run: `npx supabase db reset` -- migration applies without errors.
Verify: `npx supabase db diff` shows no unexpected drift.
Check: `npm ls react-signature-canvas` confirms package installed.
Check: `npm ls @types/react-signature-canvas` confirms types installed.
  </verify>
  <done>All three tables exist with correct columns, enums, triggers, and indexes. react-signature-canvas and @types/react-signature-canvas are installed. Inspections storage bucket noted for manual creation.</done>
</task>

<task type="auto">
  <name>Task 2: TypeScript types and lib helpers</name>
  <files>
    src/types/inspections.ts
    src/lib/inspections/queries.ts
    src/lib/inspections/workflow.ts
  </files>
  <action>
**src/types/inspections.ts** - Follow exact pattern from src/types/change-orders.ts:

Enums as union types:
- InspectionFormality: 'informal_check' | 'formal_abnahme'
- InspectionStatus: 'in_progress' | 'completed' | 'signed'
- InspectionResult: 'passed' | 'passed_with_conditions' | 'failed'
- DefectSeverity: 'gering' | 'mittel' | 'schwer'
- DefectStatus: 'open' | 'in_progress' | 'resolved'
- DefectAction: 'task_created' | 'deferred' | 'dismissed'

Interfaces:
- ChecklistItem: { id: string, title: string, description: string | null }
- ChecklistSection: { id: string, name: string, items: ChecklistItem[] }
- ChecklistItemResult: { item_id: string, status: 'pass' | 'fail' | 'na', notes: string | null, checked_at: string, photo_storage_paths: string[] }
- ChecklistSectionResult: { section_id: string, name: string, items: ChecklistItemResult[] }
- InspectionTemplate: full entity matching DB schema, with checklist_sections typed as ChecklistSection[]
- Inspection: full entity matching DB schema, with checklist_items typed as ChecklistSectionResult[], optional joined fields (work_order?, project?, template?, defects?)
- InspectionDefect: full entity matching DB schema

Input types:
- CreateInspectionTemplateInput: { name, description?, trade_category, formality_level?, checklist_sections }
- UpdateInspectionTemplateInput: partial of create
- CreateInspectionInput: { work_order_id?, project_id?, template_id?, title, description?, inspection_date?, checklist_items? }
- UpdateInspectionInput: { checklist_items?, overall_result?, notes?, status? }
- CreateDefectInput: { inspection_id, checklist_item_id?, title, description?, severity }
- UpdateDefectInput: { title?, description?, severity?, status?, action?, action_reason?, linked_task_id? }

Response types:
- InspectionTemplatesResponse: { templates: InspectionTemplate[] }
- InspectionTemplateResponse: { template: InspectionTemplate }
- InspectionsResponse: { inspections: Inspection[], total: number | null }
- InspectionResponse: { inspection: Inspection, defects?: InspectionDefect[] }
- DefectsResponse: { defects: InspectionDefect[] }

**src/lib/inspections/workflow.ts** - Inspection and defect status transition validation:

- `validateInspectionTransition(currentStatus, newStatus)`: Returns { valid: boolean, error?: string }. Allowed transitions: in_progress->completed, completed->signed.
- `validateDefectTransition(currentStatus, newStatus)`: Returns { valid: boolean, error?: string }. Allowed transitions: open->in_progress, open->resolved, in_progress->resolved.
- `canCompleteInspection(checklist_items)`: Returns { canComplete: boolean, warnings: string[] }. Checks that all items have a result. Warns about unchecked items. Does NOT block (warn only per context).
- `computeOverallResult(defects)`: Returns InspectionResult. Logic: if any 'schwer' severity defect with status 'open' => 'failed'. If any defect open but none 'schwer' => 'passed_with_conditions'. If no open defects => 'passed'.

**src/lib/inspections/queries.ts** - Database query functions using createClient from @/lib/supabase/server:

Templates:
- `listInspectionTemplates(filters?: { trade_category?, is_active? })`: SELECT with optional filters, ordered by name
- `getInspectionTemplate(id)`: SELECT by id
- `createInspectionTemplate(input, userId)`: INSERT
- `updateInspectionTemplate(id, input)`: UPDATE
- `deleteInspectionTemplate(id)`: UPDATE set is_active=false (soft delete)

Inspections:
- `listInspections(filters?: { work_order_id?, project_id?, status?, inspector_id? })`: SELECT with joins to work_orders(id, title, wo_number), renovation_projects(id, name), inspection_templates(id, name), ordered by created_at DESC
- `getInspection(id)`: SELECT with same joins + defects
- `createInspection(input, userId)`: INSERT. If template_id provided, fetch template and copy checklist_sections into checklist_items (as ChecklistSectionResult[] with all items having null status).
- `updateInspection(id, input)`: UPDATE with status transition validation (call workflow.ts first)
- `deleteInspection(id)`: DELETE (hard delete, only allowed in 'in_progress' status)

Defects:
- `listDefects(inspectionId)`: SELECT ordered by severity DESC, created_at ASC
- `createDefect(input, userId)`: INSERT
- `updateDefect(id, input)`: UPDATE with defect status transition validation
- `deleteDefect(id)`: DELETE
  </action>
  <verify>
Run: `npx tsc --noEmit` -- no TypeScript errors.
Check: All exported types and functions are accessible from other files.
  </verify>
  <done>Types file exports all inspection/template/defect interfaces. Queries module provides full CRUD. Workflow module validates status transitions.</done>
</task>

<task type="auto">
  <name>Task 3: API route handlers</name>
  <files>
    src/app/api/inspections/route.ts
    src/app/api/inspections/[id]/route.ts
    src/app/api/inspection-templates/route.ts
    src/app/api/inspection-templates/[id]/route.ts
  </files>
  <action>
Follow exact API pattern from src/app/api/change-orders/route.ts and [id]/route.ts.

**src/app/api/inspection-templates/route.ts**
- GET: List templates. Query params: ?trade_category=, ?is_active=. Auth required (x-user-id, x-user-role). Returns InspectionTemplatesResponse.
- POST: Create template. JSON body matches CreateInspectionTemplateInput. Auth required. Validates required fields (name, trade_category, checklist_sections must be array). Returns { template } with 201.

**src/app/api/inspection-templates/[id]/route.ts**
- GET: Get single template by id. Auth required. Returns InspectionTemplateResponse. 404 if not found.
- PATCH: Update template. JSON body matches UpdateInspectionTemplateInput. Auth required. Returns { template }.
- DELETE: Soft-delete (set is_active=false). Auth required. Returns { success: true }.

**src/app/api/inspections/route.ts**
- GET: List inspections. Query params: ?work_order_id=, ?project_id=, ?status=, ?inspector_id=. Auth required. Returns InspectionsResponse.
- POST: Create inspection. JSON body matches CreateInspectionInput. Auth required. Must provide work_order_id OR project_id. If template_id provided, auto-populate checklist_items from template. Sets inspector_id from x-user-id. Returns { inspection } with 201.

**src/app/api/inspections/[id]/route.ts**
- GET: Get inspection by id with defects. Auth required. Returns InspectionResponse with defects array.
- PATCH: Update inspection. JSON body matches UpdateInspectionInput. Auth required. If status change requested, validate transition using workflow.ts. If status='completed', auto-compute overall_result from defects using computeOverallResult. Set completed_at timestamp. Returns { inspection }.
- DELETE: Delete inspection. Auth required. Only allowed if status='in_progress'. Returns { success: true }. Returns 400 if status is completed or signed.

All routes: Use try-catch pattern. Return { error: string } on failures. Use createClient from @/lib/supabase/server. Read userId from request.headers.get('x-user-id'), userRole from request.headers.get('x-user-role'). Return 401 if missing.
  </action>
  <verify>
Run: `npx tsc --noEmit` -- no TypeScript errors.
Run: `npm run build` -- build succeeds.
Verify routes exist: Check that all 4 route files export the expected HTTP methods.
  </verify>
  <done>Four API route files handle full CRUD for templates and inspections. Template creation populates checklist. Status transitions validated. Completion auto-computes result.</done>
</task>

</tasks>

<verification>
1. `npx supabase db reset` succeeds — migration 059 applies cleanly
2. `npx tsc --noEmit` passes — all types resolve
3. `npm run build` succeeds — no build errors
4. `npm ls react-signature-canvas` shows installed package
5. All API routes export correct HTTP methods
</verification>

<success_criteria>
- Migration creates inspection_templates, inspections, inspection_defects with all columns, enums, triggers, indexes
- TypeScript types match database schema exactly
- Template CRUD API works (list, get, create, update, soft-delete)
- Inspection CRUD API works (list with joins, get with defects, create with template population, update with status validation, delete)
- Status transition trigger prevents invalid transitions at database level
- react-signature-canvas is installed for Plan 22-03
</success_criteria>

<output>
After completion, create `.planning/phases/22-inspection-core/22-01-SUMMARY.md`
</output>
