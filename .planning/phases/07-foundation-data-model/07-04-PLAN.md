# Plan: RBAC & Multi-Auth System

```yaml
---
phase: 07
plan: 04
name: rbac-multi-auth
wave: 2
autonomous: true
scope: large
requirements:
  - AUTH-01
  - AUTH-02
  - AUTH-03
  - AUTH-04
  - AUTH-05
  - AUTH-06
  - AUTH-07
  - AUTH-08
  - AUTH-09
must_haves:
  - roles table with 5 roles (admin, manager, accounting, tenant, contractor)
  - permissions table with granular permissions
  - role_permissions junction table
  - users table extended with role_id, email, auth_method
  - PIN auth preserved for kewa/imeri (now admin/manager)
  - Email+Password auth functional for tenants
  - Magic-Link auth functional for contractors
  - All auth methods create valid JWT session
  - Audit log entry for every auth event
---
```

## Objective

Implement complete RBAC (Role-Based Access Control) with 5 roles and 3 authentication methods. Preserve existing PIN auth while adding Email+Password and Magic-Link.

## Context

**Current Auth (v1):**
- 2 users: KEWA (admin), Imeri (worker)
- PIN-based auth only
- Simple role check in middleware

**Target Auth (v2.0):**
- 5 roles: Admin, Property Manager, Accounting, Tenant, External Contractor
- 3 auth methods:
  - PIN: Internal users (Admin, Manager, Accounting)
  - Email+Password: Tenants
  - Magic-Link: External Contractors (per-WorkOrder)
- Granular permissions per role
- Audit logging for all auth events

**Dependencies:**
- Plan 07-01 (session utilities) must be complete
- Plan 07-02 (AuditLog table) must be complete

## Tasks

### Task 1: Create RBAC Database Schema

**What:** Roles, permissions, and junction tables.

**SQL Migration:** `supabase/migrations/022_rbac.sql`

```sql
-- Role enum (matches TypeScript)
CREATE TYPE user_role AS ENUM (
  'admin',
  'property_manager',
  'accounting',
  'tenant',
  'external_contractor'
);

-- Auth method enum
CREATE TYPE auth_method AS ENUM (
  'pin',
  'email_password',
  'magic_link'
);

-- Roles table
CREATE TABLE IF NOT EXISTS roles (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  name user_role UNIQUE NOT NULL,
  display_name TEXT NOT NULL,
  description TEXT,
  is_internal BOOLEAN DEFAULT false, -- Can access internal dashboard
  is_active BOOLEAN DEFAULT true,
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- Seed roles
INSERT INTO roles (name, display_name, description, is_internal) VALUES
  ('admin', 'Administrator', 'Full system access, manages all settings', true),
  ('property_manager', 'Property Manager', 'Manages properties, projects, and work orders', true),
  ('accounting', 'Accounting', 'Manages costs, invoices, and payments', true),
  ('tenant', 'Tenant', 'Views own unit, creates tickets', false),
  ('external_contractor', 'External Contractor', 'Views and responds to assigned work orders', false)
ON CONFLICT (name) DO NOTHING;

-- Permissions table
CREATE TABLE IF NOT EXISTS permissions (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  code TEXT UNIQUE NOT NULL, -- e.g., 'projects:create'
  name TEXT NOT NULL,
  description TEXT,
  resource TEXT NOT NULL, -- e.g., 'projects'
  action TEXT NOT NULL, -- e.g., 'create', 'read', 'update', 'delete'
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- Role-Permission junction
CREATE TABLE IF NOT EXISTS role_permissions (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  role_id UUID NOT NULL REFERENCES roles(id) ON DELETE CASCADE,
  permission_id UUID NOT NULL REFERENCES permissions(id) ON DELETE CASCADE,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  UNIQUE(role_id, permission_id)
);

CREATE INDEX IF NOT EXISTS idx_role_permissions_role ON role_permissions(role_id);
CREATE INDEX IF NOT EXISTS idx_role_permissions_permission ON role_permissions(permission_id);

-- Seed permissions
INSERT INTO permissions (code, name, resource, action, description) VALUES
  -- Properties
  ('properties:read', 'View Properties', 'properties', 'read', 'View property details'),
  ('properties:create', 'Create Properties', 'properties', 'create', 'Create new properties'),
  ('properties:update', 'Update Properties', 'properties', 'update', 'Edit property details'),
  ('properties:delete', 'Delete Properties', 'properties', 'delete', 'Delete properties'),

  -- Units
  ('units:read', 'View Units', 'units', 'read', 'View unit details'),
  ('units:create', 'Create Units', 'units', 'create', 'Create new units'),
  ('units:update', 'Update Units', 'units', 'update', 'Edit unit details'),
  ('units:delete', 'Delete Units', 'units', 'delete', 'Delete units'),

  -- Projects
  ('projects:read', 'View Projects', 'projects', 'read', 'View project details'),
  ('projects:create', 'Create Projects', 'projects', 'create', 'Create new projects'),
  ('projects:update', 'Update Projects', 'projects', 'update', 'Edit project details'),
  ('projects:delete', 'Delete Projects', 'projects', 'delete', 'Delete projects'),
  ('projects:archive', 'Archive Projects', 'projects', 'archive', 'Archive/restore projects'),

  -- Tasks
  ('tasks:read', 'View Tasks', 'tasks', 'read', 'View task details'),
  ('tasks:create', 'Create Tasks', 'tasks', 'create', 'Create new tasks'),
  ('tasks:update', 'Update Tasks', 'tasks', 'update', 'Edit task details'),
  ('tasks:delete', 'Delete Tasks', 'tasks', 'delete', 'Delete tasks'),
  ('tasks:complete', 'Complete Tasks', 'tasks', 'complete', 'Mark tasks as complete'),

  -- Work Orders
  ('work_orders:read', 'View Work Orders', 'work_orders', 'read', 'View work order details'),
  ('work_orders:create', 'Create Work Orders', 'work_orders', 'create', 'Create new work orders'),
  ('work_orders:update', 'Update Work Orders', 'work_orders', 'update', 'Edit work order details'),
  ('work_orders:delete', 'Delete Work Orders', 'work_orders', 'delete', 'Delete work orders'),
  ('work_orders:respond', 'Respond to Work Orders', 'work_orders', 'respond', 'Accept/reject work orders'),

  -- Partners
  ('partners:read', 'View Partners', 'partners', 'read', 'View partner details'),
  ('partners:create', 'Create Partners', 'partners', 'create', 'Create new partners'),
  ('partners:update', 'Update Partners', 'partners', 'update', 'Edit partner details'),
  ('partners:delete', 'Delete Partners', 'partners', 'delete', 'Delete partners'),

  -- Costs
  ('costs:read', 'View Costs', 'costs', 'read', 'View cost details'),
  ('costs:create', 'Create Costs', 'costs', 'create', 'Create invoices/expenses'),
  ('costs:update', 'Update Costs', 'costs', 'update', 'Edit cost entries'),
  ('costs:delete', 'Delete Costs', 'costs', 'delete', 'Delete cost entries'),
  ('costs:approve', 'Approve Costs', 'costs', 'approve', 'Approve invoices for payment'),
  ('costs:export', 'Export Costs', 'costs', 'export', 'Export cost data to CSV'),

  -- Reports
  ('reports:read', 'View Reports', 'reports', 'read', 'View reports'),
  ('reports:create', 'Generate Reports', 'reports', 'create', 'Generate new reports'),

  -- Users
  ('users:read', 'View Users', 'users', 'read', 'View user details'),
  ('users:create', 'Create Users', 'users', 'create', 'Create new users'),
  ('users:update', 'Update Users', 'users', 'update', 'Edit user details'),
  ('users:delete', 'Delete Users', 'users', 'delete', 'Delete users'),

  -- Tenants
  ('tenants:read', 'View Tenants', 'tenants', 'read', 'View tenant details'),
  ('tenants:manage', 'Manage Tenants', 'tenants', 'manage', 'Create/edit/delete tenants'),

  -- Tickets
  ('tickets:read', 'View Tickets', 'tickets', 'read', 'View tenant tickets'),
  ('tickets:create', 'Create Tickets', 'tickets', 'create', 'Create new tickets'),
  ('tickets:update', 'Update Tickets', 'tickets', 'update', 'Edit tickets'),
  ('tickets:convert', 'Convert Tickets', 'tickets', 'convert', 'Convert ticket to work order'),

  -- Audit
  ('audit:read', 'View Audit Logs', 'audit', 'read', 'View audit trail'),

  -- Settings
  ('settings:read', 'View Settings', 'settings', 'read', 'View system settings'),
  ('settings:update', 'Update Settings', 'settings', 'update', 'Edit system settings')

ON CONFLICT (code) DO NOTHING;

-- Assign permissions to roles
-- Admin: all permissions
INSERT INTO role_permissions (role_id, permission_id)
SELECT r.id, p.id
FROM roles r, permissions p
WHERE r.name = 'admin'
ON CONFLICT DO NOTHING;

-- Property Manager: most except user management and settings
INSERT INTO role_permissions (role_id, permission_id)
SELECT r.id, p.id
FROM roles r, permissions p
WHERE r.name = 'property_manager'
  AND p.code NOT LIKE 'users:%'
  AND p.code NOT LIKE 'settings:%'
  AND p.code != 'audit:read'
ON CONFLICT DO NOTHING;

-- Accounting: costs, reports, read-only on projects/work orders
INSERT INTO role_permissions (role_id, permission_id)
SELECT r.id, p.id
FROM roles r, permissions p
WHERE r.name = 'accounting'
  AND (
    p.code LIKE 'costs:%'
    OR p.code LIKE 'reports:%'
    OR p.code IN ('projects:read', 'work_orders:read', 'partners:read', 'units:read')
  )
ON CONFLICT DO NOTHING;

-- Tenant: own unit, create tickets
INSERT INTO role_permissions (role_id, permission_id)
SELECT r.id, p.id
FROM roles r, permissions p
WHERE r.name = 'tenant'
  AND p.code IN ('units:read', 'tickets:create', 'tickets:read')
ON CONFLICT DO NOTHING;

-- External Contractor: own work orders only
INSERT INTO role_permissions (role_id, permission_id)
SELECT r.id, p.id
FROM roles r, permissions p
WHERE r.name = 'external_contractor'
  AND p.code IN ('work_orders:read', 'work_orders:respond')
ON CONFLICT DO NOTHING;
```

**Acceptance:**
- Roles table with 5 roles
- Permissions table with ~40 permissions
- Role_permissions correctly assigned
- Indexes for performance

---

### Task 2: Extend Users Table for Multi-Auth

**What:** Add auth fields to users table.

**SQL Migration:** `supabase/migrations/023_users_auth.sql`

```sql
-- Add auth fields to users
ALTER TABLE users
ADD COLUMN IF NOT EXISTS role_id UUID REFERENCES roles(id),
ADD COLUMN IF NOT EXISTS email TEXT UNIQUE,
ADD COLUMN IF NOT EXISTS email_verified BOOLEAN DEFAULT false,
ADD COLUMN IF NOT EXISTS password_hash TEXT, -- For email+password auth
ADD COLUMN IF NOT EXISTS auth_method auth_method DEFAULT 'pin',
ADD COLUMN IF NOT EXISTS last_login_at TIMESTAMPTZ,
ADD COLUMN IF NOT EXISTS login_count INTEGER DEFAULT 0,
ADD COLUMN IF NOT EXISTS is_active BOOLEAN DEFAULT true,
ADD COLUMN IF NOT EXISTS updated_at TIMESTAMPTZ DEFAULT NOW();

-- Migrate existing users to roles
-- KEWA -> admin
UPDATE users u
SET role_id = r.id, auth_method = 'pin'
FROM roles r
WHERE u.role = 'kewa' AND r.name = 'admin';

-- Imeri -> property_manager
UPDATE users u
SET role_id = r.id, auth_method = 'pin'
FROM roles r
WHERE u.role = 'imeri' AND r.name = 'property_manager';

-- Index for email lookup
CREATE INDEX IF NOT EXISTS idx_users_email ON users(email) WHERE email IS NOT NULL;
CREATE INDEX IF NOT EXISTS idx_users_role_id ON users(role_id);
CREATE INDEX IF NOT EXISTS idx_users_auth_method ON users(auth_method);

CREATE TRIGGER users_updated_at
  BEFORE UPDATE ON users
  FOR EACH ROW EXECUTE FUNCTION update_updated_at();

-- Create tenant users table for unit assignment
CREATE TABLE IF NOT EXISTS tenant_users (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  unit_id UUID NOT NULL REFERENCES units(id) ON DELETE CASCADE,
  is_primary BOOLEAN DEFAULT false, -- Primary tenant
  move_in_date DATE,
  move_out_date DATE,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  UNIQUE(user_id, unit_id)
);

CREATE INDEX IF NOT EXISTS idx_tenant_users_user ON tenant_users(user_id);
CREATE INDEX IF NOT EXISTS idx_tenant_users_unit ON tenant_users(unit_id);
```

**Acceptance:**
- Users table extended with auth fields
- Existing users migrated to new roles
- Tenant-Unit relationship table created

---

### Task 3: Create Magic Link Token Table

**What:** Secure token storage for magic links.

**SQL Migration:** `supabase/migrations/024_magic_links.sql`

```sql
-- Magic link tokens for contractor access
CREATE TABLE IF NOT EXISTS magic_link_tokens (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  token UUID UNIQUE NOT NULL DEFAULT gen_random_uuid(),

  -- User or work order based
  user_id UUID REFERENCES users(id),
  work_order_id UUID REFERENCES work_orders(id),

  -- Token details
  email TEXT NOT NULL,
  purpose TEXT NOT NULL, -- 'work_order_access', 'login', etc.

  -- Validity
  expires_at TIMESTAMPTZ NOT NULL,
  used_at TIMESTAMPTZ,
  is_revoked BOOLEAN DEFAULT false,

  -- Tracking
  created_at TIMESTAMPTZ DEFAULT NOW(),
  created_by UUID REFERENCES users(id)
);

CREATE INDEX IF NOT EXISTS idx_magic_links_token ON magic_link_tokens(token);
CREATE INDEX IF NOT EXISTS idx_magic_links_email ON magic_link_tokens(email);
CREATE INDEX IF NOT EXISTS idx_magic_links_work_order ON magic_link_tokens(work_order_id);

-- Clean up expired tokens automatically
CREATE OR REPLACE FUNCTION cleanup_expired_tokens()
RETURNS void AS $$
BEGIN
  DELETE FROM magic_link_tokens
  WHERE expires_at < NOW() - INTERVAL '7 days';
END;
$$ LANGUAGE plpgsql;
```

**Acceptance:**
- Magic link tokens table created
- Tokens linked to work orders or users
- Expiry tracking
- Cleanup function for old tokens

---

### Task 4: Implement PIN Auth (Preserve v1)

**What:** Update PIN auth to use new RBAC system.

**Files:**
- `src/app/api/auth/login/route.ts` — Update to use roles
- `src/lib/auth.ts` — Add role lookup

```typescript
// Updated login flow
1. Receive PIN
2. Find user with matching PIN hash
3. Verify user.auth_method === 'pin'
4. Load role from roles table
5. Create JWT with userId, roleId, roleName, permissions
6. Create audit log entry (AUTH-06)
7. Return session cookie
```

**Acceptance:**
- PIN login still works for KEWA/Imeri
- Session includes role permissions
- Audit log created on login

---

### Task 5: Implement Email+Password Auth (AUTH-08)

**What:** Add email/password authentication for tenants.

**Files:**
- `src/app/api/auth/register/route.ts` — New registration endpoint
- `src/app/api/auth/login/route.ts` — Add email+password flow
- `src/lib/auth.ts` — Add password hashing/verification

**Flow:**
```typescript
// Registration (admin creates tenant)
1. Admin creates user with email + temporary password
2. Email sent with password reset link (optional)
3. User sets password on first login

// Login
1. Receive email + password
2. Find user by email
3. Verify user.auth_method === 'email_password'
4. Verify password hash
5. Create JWT session
6. Create audit log entry
```

**Acceptance:**
- Tenants can register with email
- Password properly hashed (bcrypt)
- Email verification optional but supported
- Session same format as PIN auth

---

### Task 6: Implement Magic Link Auth (AUTH-09)

**What:** Token-based authentication for external contractors.

**Files:**
- `src/app/api/auth/magic-link/send/route.ts` — Generate and store token
- `src/app/api/auth/magic-link/verify/route.ts` — Validate token and create session
- `src/app/api/contractor/[token]/route.ts` — Public contractor portal access

**Flow:**
```typescript
// Send magic link (when creating WorkOrder)
1. Generate unique token
2. Store in magic_link_tokens with work_order_id
3. Set 72h expiry (configurable)
4. Return mailto: link with token URL

// Verify magic link
1. Receive token from URL
2. Find token in database
3. Verify not expired, not used, not revoked
4. Mark as used
5. Create session with contractor role
6. Create audit log entry
7. Redirect to contractor portal
```

**Acceptance:**
- Magic links generated for work orders
- Tokens expire after configured time
- One-time use (marked as used after first access)
- Creates valid session with limited permissions

---

### Task 7: Create Auth Audit Logging (AUTH-06)

**What:** Log all authentication events.

**Files:**
- `src/lib/audit.ts` — Audit logging utilities

```typescript
// Audit events to log:
- 'auth.login.pin.success'
- 'auth.login.pin.failure'
- 'auth.login.email.success'
- 'auth.login.email.failure'
- 'auth.login.magic_link.success'
- 'auth.login.magic_link.failure'
- 'auth.login.magic_link.expired'
- 'auth.logout'
- 'auth.session.created'
- 'auth.session.expired'
- 'auth.password.changed'
- 'auth.password.reset.requested'
```

**Acceptance:**
- All auth events logged to audit_logs table
- Includes: user_id, action, ip_address, user_agent
- Failed attempts logged (for security monitoring)

---

### Task 8: Update Middleware for RBAC

**What:** Middleware checks permissions, not just roles.

**Files:**
- `src/middleware.ts` — Enhanced permission checking
- `src/lib/permissions.ts` — Permission utilities

```typescript
// Middleware flow:
1. Validate session token
2. Extract userId, roleId, permissions from token
3. For protected routes, check required permission
4. Set headers: x-user-id, x-user-role, x-user-permissions
5. For public routes (contractor portal), verify magic link token

// Permission checking:
hasPermission(userPermissions: string[], required: string): boolean
hasAnyPermission(userPermissions: string[], required: string[]): boolean
hasAllPermissions(userPermissions: string[], required: string[]): boolean
```

**Acceptance:**
- Middleware extracts permissions from session
- Routes can require specific permissions
- Contractor portal routes work with magic link

---

### Task 9: Update TypeScript Types

**What:** Add RBAC types and update auth types.

**Files:**
- `src/types/index.ts` — Role and permission types
- `src/types/database.ts` — Database entity types
- `src/types/auth.ts` — Auth-specific types

**Acceptance:**
- Role, Permission, RolePermission interfaces
- Session type includes permissions
- AuthMethod type union

---

## Verification

```bash
# Database
supabase db query "SELECT * FROM roles"
supabase db query "SELECT * FROM permissions LIMIT 10"
supabase db query "SELECT r.name, COUNT(rp.id) FROM roles r LEFT JOIN role_permissions rp ON r.id = rp.role_id GROUP BY r.name"

# PIN Auth (existing)
curl -X POST http://localhost:3000/api/auth/login -d '{"pin":"1234"}'

# Check session includes permissions
curl http://localhost:3000/api/auth/session -H "Cookie: session=..."

# TypeScript
npm run type-check
```

## Success Criteria

- [ ] 5 roles created with correct permissions
- [ ] Users table extended with auth fields
- [ ] Existing PIN auth preserved and working
- [ ] Email+Password auth functional
- [ ] Magic Link auth functional
- [ ] All auth events logged to audit_logs
- [ ] Middleware checks permissions
- [ ] TypeScript types complete

## Output

**New Files:**
- `supabase/migrations/022_rbac.sql`
- `supabase/migrations/023_users_auth.sql`
- `supabase/migrations/024_magic_links.sql`
- `src/app/api/auth/register/route.ts`
- `src/app/api/auth/magic-link/send/route.ts`
- `src/app/api/auth/magic-link/verify/route.ts`
- `src/lib/permissions.ts`
- `src/lib/audit.ts`
- `src/types/auth.ts`

**Modified Files:**
- `src/app/api/auth/login/route.ts`
- `src/lib/auth.ts`
- `src/middleware.ts`
- `src/types/index.ts`
- `src/types/database.ts`
