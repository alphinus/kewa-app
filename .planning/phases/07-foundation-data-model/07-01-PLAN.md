# Plan: Tech Debt Fixes

```yaml
---
phase: 07
plan: 01
name: tech-debt-fixes
wave: 1
autonomous: true
scope: small
requirements:
  - DEBT-01
  - DEBT-02
  - DEBT-03
  - DEBT-04
must_haves:
  - Middleware uses non-deprecated pattern (no console warnings)
  - Build completes without race conditions
  - Session validation unified in single utility
  - Phase 03 VERIFICATION.md exists
---
```

## Objective

Fix accumulated technical debt from v1 development before building Phase 7 foundation. Clean slate for new features.

## Context

**Codebase State:**
- Next.js 16.1.2 with React 19, Supabase, Tailwind CSS 4
- Current middleware at `src/middleware.ts` uses deprecated proxy pattern
- Session handling split across 3 files with potential inconsistencies
- Turbopack build has intermittent race conditions

**Files to Modify:**
- `src/middleware.ts` — Fix deprecated pattern
- `src/lib/auth.ts` — Extract unified session validation
- `next.config.ts` — Turbopack stability adjustments
- `.planning/phases/03-*/` — Create missing VERIFICATION.md

## Tasks

### Task 1: Fix Middleware Deprecation Warning (DEBT-01)

**What:** Replace deprecated `NextResponse.next({ request: { headers } })` with current pattern.

**How:**
1. Read current `src/middleware.ts`
2. Replace header injection pattern with `NextResponse.next()` + response headers
3. Use `request.headers.set()` for x-user-id and x-user-role
4. Test that protected routes still work

**Acceptance:**
- `npm run build` shows no middleware deprecation warnings
- Protected routes still require authentication
- User info headers still passed to API routes

**Files:** `src/middleware.ts`

---

### Task 2: Stabilize Turbopack Build (DEBT-02)

**What:** Ensure consistent builds without race conditions.

**How:**
1. Read `next.config.ts` current configuration
2. Add explicit chunk loading settings if missing
3. Verify `reactCompiler: true` is stable with current React 19 version
4. Run `npm run build` 3 times to verify consistency

**Acceptance:**
- 3 consecutive builds complete successfully
- No "module not found" or chunk loading errors
- Build time variance < 20%

**Files:** `next.config.ts`

---

### Task 3: Unify Session Pattern (DEBT-03)

**What:** Create single source of truth for session validation.

**How:**
1. Create `src/lib/session.ts` with unified session utilities:
   - `validateSession(cookie: string)` — Edge-compatible JWT validation
   - `getSessionFromRequest(request: NextRequest)` — Extract and validate
   - `SessionPayload` type exported for consistency
2. Refactor `src/middleware.ts` to use new session utility
3. Refactor `src/app/api/auth/session/route.ts` to use same utility
4. Update `src/lib/auth.ts` to re-export session utilities

**Acceptance:**
- Single session validation function used everywhere
- No duplicate JWT validation code
- `GET /api/auth/session` returns same result as middleware validation

**Files:**
- `src/lib/session.ts` (new)
- `src/middleware.ts`
- `src/app/api/auth/session/route.ts`
- `src/lib/auth.ts`

---

### Task 4: Create Phase 03 VERIFICATION.md (DEBT-04)

**What:** Document photo documentation feature verification for audit trail.

**How:**
1. Find Phase 03 directory in `.planning/phases/`
2. Create `03-VERIFICATION.md` documenting:
   - Photo upload functionality verified
   - Before/after comparison view verified
   - Compression to WebP verified
   - Storage in Supabase verified
3. Mark as retroactive verification

**Acceptance:**
- `.planning/phases/03-*/03-VERIFICATION.md` exists
- Documents all photo-related requirements from Phase 03

**Files:** `.planning/phases/03-*/03-VERIFICATION.md`

---

## Verification

```bash
# DEBT-01: No middleware warnings
npm run build 2>&1 | grep -i "middleware\|deprecated" || echo "No warnings"

# DEBT-02: Consistent builds
npm run build && npm run build && npm run build

# DEBT-03: Session utilities exported
grep -r "validateSession" src/lib/session.ts

# DEBT-04: Verification exists
ls .planning/phases/03-*/03-VERIFICATION.md
```

## Success Criteria

- [ ] Middleware uses non-deprecated Next.js 16 pattern
- [ ] Build completes 3x without errors
- [ ] Session validation consolidated in `src/lib/session.ts`
- [ ] Phase 03 VERIFICATION.md created
- [ ] All existing functionality preserved (no regressions)

## Output

**Modified Files:**
- `src/middleware.ts` — Updated pattern
- `src/lib/session.ts` — New unified session utility
- `src/lib/auth.ts` — Re-exports session utilities
- `src/app/api/auth/session/route.ts` — Uses unified utility
- `next.config.ts` — Turbopack stability
- `.planning/phases/03-*/03-VERIFICATION.md` — New
