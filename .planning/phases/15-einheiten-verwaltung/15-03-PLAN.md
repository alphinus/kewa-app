---
phase: 15-einheiten-verwaltung
plan: 03
type: execute
wave: 2
depends_on: ["15-01"]
files_modified:
  - src/app/dashboard/einheiten/page.tsx
  - src/components/units/UnitForm.tsx
  - src/components/units/UnitList.tsx
  - src/components/units/UnitCard.tsx
autonomous: true

must_haves:
  truths:
    - "Admin sees list of units filtered by current building context"
    - "Admin can open create form and add new unit"
    - "Admin can click unit and open edit form"
    - "Unit list shows unit number, tenant name (or Leerstand), room count"
  artifacts:
    - path: "src/app/dashboard/einheiten/page.tsx"
      provides: "Unit list page with building context"
      min_lines: 80
    - path: "src/components/units/UnitForm.tsx"
      provides: "Create/edit unit form modal"
      min_lines: 150
    - path: "src/components/units/UnitList.tsx"
      provides: "Building-scoped unit list component"
      min_lines: 60
    - path: "src/components/units/UnitCard.tsx"
      provides: "Unit display card with key info"
      min_lines: 40
  key_links:
    - from: "src/app/dashboard/einheiten/page.tsx"
      to: "BuildingContext"
      via: "useBuilding hook"
      pattern: "useBuilding\\(\\)"
    - from: "src/components/units/UnitForm.tsx"
      to: "/api/units"
      via: "fetch POST/PATCH"
      pattern: "fetch.*api/units"
---

<objective>
Create unit management UI with list page and create/edit forms.

Purpose: Admin can view all units for the selected building and manage them (add, edit). The UI respects building context from Phase 14 and displays unit information per CONTEXT.md (unit number, tenant name/Leerstand, room count).

Output: Complete unit management UI with list page at /dashboard/einheiten and UnitForm component for create/edit operations.
</objective>

<execution_context>
@C:\Users\Mario Giacchino\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\Mario Giacchino\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/15-einheiten-verwaltung/15-CONTEXT.md
@.planning/phases/15-einheiten-verwaltung/15-RESEARCH.md
@src/app/dashboard/liegenschaft/page.tsx
@src/components/partners/PartnerForm.tsx
@src/components/partners/PartnerList.tsx
@src/contexts/BuildingContext.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create UnitCard and UnitList components</name>
  <files>
src/components/units/UnitCard.tsx
src/components/units/UnitList.tsx
  </files>
  <action>
Create UnitCard.tsx following PartnerCard pattern:
- Display unit_number or name as title
- Show tenant_name or "Leerstand" badge (amber color) if is_vacant or no tenant
- Show room count (from rooms relation or placeholder "- Raeume")
- Show floor label using getFloorLabel helper (EG, 1.OG, etc.)
- Show size_class if available (e.g., "3.5-Zi.")
- Include edit and view buttons
- Use Tailwind classes consistent with existing cards

```typescript
interface UnitCardProps {
  unit: Unit & { rooms?: { id: string }[] }
  onEdit: (unit: Unit) => void
  onView: (unit: Unit) => void
}
```

Create UnitList.tsx:
- Accept units array and handlers
- Map units to UnitCard components
- Grid layout (1 col mobile, 2 cols tablet, 3 cols desktop)
- Empty state message when no units

Floor label helper (reuse from wohnungen/[id]/page.tsx):
```typescript
function getFloorLabel(floor: number | null): string {
  if (floor === null) return ''
  if (floor < 0) return 'UG'
  if (floor === 0) return 'EG'
  if (floor === 4) return 'DG'
  return `${floor}. OG`
}
```
  </action>
  <verify>TypeScript compiles: `npx tsc --noEmit`</verify>
  <done>UnitCard and UnitList components exist with proper typing and display</done>
</task>

<task type="auto">
  <name>Task 2: Create UnitForm component</name>
  <files>src/components/units/UnitForm.tsx</files>
  <action>
Create UnitForm following PartnerForm pattern exactly:

Props interface:
```typescript
interface UnitFormProps {
  mode: 'create' | 'edit'
  unit?: Unit
  buildingId: string
  onSave: (unit: Unit) => void
  onCancel: () => void
}
```

Form fields from CONTEXT.md:
1. Name (required) - text input
2. Unit Number - text input, placeholder "z.B. 4.1"
3. Floor - dropdown with options: UG (-1), EG (0), 1.OG (1), 2.OG (2), 3.OG (3), DG (4)
4. Size Class - dropdown with options: 1-Zi., 1.5-Zi., 2-Zi., 2.5-Zi., 3-Zi., 3.5-Zi., 4-Zi., 4.5-Zi., 5-Zi., 5.5-Zi., 6-Zi.
5. Unit Type - dropdown (Wohnung, Gemeinschaftsraum)

Tenant section (collapsible or always visible):
6. Tenant Name - text input
7. Tenant Phone - tel input
8. Tenant Email - email input (optional)
9. Move-in Date - date input
10. Is Vacant - checkbox (auto-derived but can override)

Form behavior:
- Modal overlay like PartnerForm (fixed inset-0, z-50)
- Validate required fields (name, building_id comes from props)
- POST to /api/units for create, PATCH to /api/units/:id for edit
- Show saving state and errors
- Call onSave with returned unit on success

Validation:
- Name is required
- If tenant fields provided, validate email format (if email entered)

German labels:
- "Einheit Name" for name
- "Einheitsnummer" for unit_number
- "Etage" for floor
- "Groesse" for size_class
- "Typ" for unit_type
- "Mieter" section for tenant fields
  </action>
  <verify>TypeScript compiles: `npx tsc --noEmit`</verify>
  <done>UnitForm component handles create/edit with all fields from CONTEXT.md</done>
</task>

<task type="auto">
  <name>Task 3: Create einheiten page with building context</name>
  <files>src/app/dashboard/einheiten/page.tsx</files>
  <action>
Create page following liegenschaft/page.tsx pattern:

'use client' component using BuildingContext:
```typescript
import { useBuilding } from '@/contexts/BuildingContext'

export default function EinheitenPage() {
  const { selectedBuildingId, isAllSelected, isLoading: buildingLoading } = useBuilding()
  // ...
}
```

State:
- units: Unit[] with rooms relation
- loading: boolean
- error: string | null
- showForm: boolean
- editingUnit: Unit | null

Data fetching:
- Fetch units when selectedBuildingId changes
- If 'all' or no building selected, show prompt to select building
- GET /api/units?building_id=X
- Include rooms count in display

UI structure:
1. Header with title "Einheiten" and "Neu" button (+ icon)
2. Building context message if 'all' selected: "Bitte waehlen Sie eine Liegenschaft aus"
3. UnitList component with units
4. UnitForm modal when showForm is true
5. Empty state when no units

Event handlers:
- handleCreateClick: setShowForm(true), setEditingUnit(null)
- handleEditClick: setShowForm(true), setEditingUnit(unit)
- handleSave: add/update unit in list, close form
- handleCancel: close form

Add loading skeleton while fetching (simple gray boxes).
  </action>
  <verify>
Manual verification:
- Navigate to /dashboard/einheiten
- Page shows unit list when building selected
- Shows prompt when 'all' selected
- Click "Neu" opens empty form
- Click unit card opens edit form
- Form saves and updates list
  </verify>
  <done>Einheiten page displays building-scoped unit list with create/edit functionality</done>
</task>

</tasks>

<verification>
1. TypeScript compiles: `npx tsc --noEmit`
2. /dashboard/einheiten shows units for selected building
3. Create form adds new unit to list
4. Edit form updates existing unit
5. List shows unit number, tenant/Leerstand, floor
</verification>

<success_criteria>
- Admin sees list of units filtered by current building context
- Admin can create new unit with all fields
- Admin can edit existing unit
- Unit list displays key info: number, tenant/Leerstand, room count, floor
- UI matches existing codebase patterns (PartnerForm, liegenschaft page)
</success_criteria>

<output>
After completion, create `.planning/phases/15-einheiten-verwaltung/15-03-SUMMARY.md`
</output>
