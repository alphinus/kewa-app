---
phase: 15-einheiten-verwaltung
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/app/api/units/route.ts
  - src/app/api/units/[id]/route.ts
  - src/types/database.ts
autonomous: true

must_haves:
  truths:
    - "GET /api/units?building_id=X returns only units for that building"
    - "POST /api/units creates unit with extended tenant fields"
    - "PATCH /api/units/:id updates all unit fields including tenant info"
    - "DELETE /api/units/:id removes unit (kewa role only)"
  artifacts:
    - path: "src/app/api/units/route.ts"
      provides: "GET with building_id filter, POST for unit creation"
      exports: ["GET", "POST"]
    - path: "src/app/api/units/[id]/route.ts"
      provides: "GET, PATCH, DELETE for single unit"
      exports: ["GET", "PATCH", "DELETE"]
  key_links:
    - from: "src/app/api/units/route.ts"
      to: "supabase.from('units')"
      via: "building_id filter in query"
      pattern: "eq\\('building_id'"
---

<objective>
Extend Unit API with building_id filter, POST for creation, full PATCH, and DELETE operations.

Purpose: Enable unit CRUD operations scoped to buildings, supporting the expanded tenant data model from CONTEXT.md (tenant_phone, tenant_email, tenant_move_in_date, is_vacant, unit_number, size_class).

Output: Complete Unit API supporting building-scoped listing, unit creation with all fields, full update, and admin-only delete.
</objective>

<execution_context>
@C:\Users\Mario Giacchino\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\Mario Giacchino\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/15-einheiten-verwaltung/15-CONTEXT.md
@.planning/phases/15-einheiten-verwaltung/15-RESEARCH.md
@src/app/api/units/route.ts
@src/app/api/units/[id]/route.ts
@src/app/api/partners/route.ts
@src/types/database.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend Unit type with tenant fields</name>
  <files>src/types/database.ts</files>
  <action>
Add extended tenant fields to the Unit interface:
- unit_number: string | null (Floor.Apartment format like "4.1", "4.2")
- size_class: string | null (e.g., "3.5-Zi.")
- tenant_phone: string | null
- tenant_email: string | null
- tenant_move_in_date: string | null (ISO date)
- is_vacant: boolean
- vacancy_reason: string | null (values: 'no_tenant', 'komplettsanierung', 'manual')

Add CreateUnitInput interface for POST:
```typescript
export interface CreateUnitInput {
  building_id: string
  name: string
  unit_type: UnitType
  floor?: number | null
  position?: string | null
  unit_number?: string | null
  size_class?: string | null
  tenant_name?: string | null
  tenant_phone?: string | null
  tenant_email?: string | null
  tenant_move_in_date?: string | null
  is_vacant?: boolean
  vacancy_reason?: string | null
  tenant_visible_to_imeri?: boolean
}
```

Add UpdateUnitInput interface (extend existing or replace):
```typescript
export interface UpdateUnitInput {
  name?: string
  unit_type?: UnitType
  floor?: number | null
  position?: string | null
  unit_number?: string | null
  size_class?: string | null
  tenant_name?: string | null
  tenant_phone?: string | null
  tenant_email?: string | null
  tenant_move_in_date?: string | null
  is_vacant?: boolean
  vacancy_reason?: string | null
  tenant_visible_to_imeri?: boolean
}
```

Note: Do NOT change database migrations - the extended fields will be added to the database in a future phase or may already exist. For now, make the types optional to maintain backward compatibility.
  </action>
  <verify>TypeScript compiles without errors: `npx tsc --noEmit`</verify>
  <done>Unit interface has all extended tenant fields, CreateUnitInput and UpdateUnitInput types exist</done>
</task>

<task type="auto">
  <name>Task 2: Add building_id filter and POST to units collection route</name>
  <files>src/app/api/units/route.ts</files>
  <action>
Extend GET to support building_id query parameter:
- Parse building_id from searchParams
- If building_id provided and not 'all', filter by building_id
- Keep existing sorting (floor desc, name asc)
- Keep existing role-based filtering (Imeri visibility)

Add POST handler following partners API pattern:
- Auth check: require x-user-id and x-user-role headers
- Role check: only 'kewa' and 'imeri' can create units
- Validate required fields: building_id, name, unit_type
- Validate unit_type is valid enum value ('apartment', 'common_area', 'building', 'parking_spot')
- Insert with all provided fields, defaults for is_vacant (true)
- Return created unit with 201 status

Use manual validation pattern (not Zod) consistent with codebase:
```typescript
if (!body.building_id) {
  return NextResponse.json({ error: 'building_id is required' }, { status: 400 })
}
```
  </action>
  <verify>
Manual test:
- GET /api/units returns all units
- GET /api/units?building_id=<uuid> returns filtered units
- GET /api/units?building_id=all returns all units
- POST /api/units with valid body returns 201
- POST /api/units without building_id returns 400
  </verify>
  <done>Units GET supports building_id filter, POST creates new units</done>
</task>

<task type="auto">
  <name>Task 3: Extend single unit route with PATCH and DELETE</name>
  <files>src/app/api/units/[id]/route.ts</files>
  <action>
Replace existing PUT with PATCH for consistency with REST conventions:
- Auth check: require x-user-id and x-user-role headers
- Role check: only 'kewa' and 'imeri' can update
- Accept partial updates (any combination of UpdateUnitInput fields)
- Validate at least one field provided
- Return updated unit with task stats

Add DELETE handler:
- Auth check: require x-user-id and x-user-role headers
- Role check: ONLY 'kewa' can delete (admin-only for safety, consistent with buildings/partners pattern)
- Log warning if unit has related projects (but proceed - admin override pattern)
- Delete unit from database
- Return 204 on success

Follow existing [id] route patterns from partners/[id]/route.ts:
```typescript
export async function PATCH(
  request: NextRequest,
  { params }: { params: Promise<{ id: string }> }
) {
  const { id } = await params
  // ...
}
```
  </action>
  <verify>
Manual test:
- PATCH /api/units/:id with partial body returns updated unit
- DELETE /api/units/:id as kewa returns 204
- DELETE /api/units/:id as imeri returns 403
  </verify>
  <done>PATCH updates units with extended fields, DELETE removes units (kewa only)</done>
</task>

</tasks>

<verification>
1. TypeScript compiles: `npx tsc --noEmit`
2. GET /api/units?building_id=X returns filtered results
3. POST /api/units creates unit with all extended fields
4. PATCH /api/units/:id updates any combination of fields
5. DELETE /api/units/:id works for kewa role only
</verification>

<success_criteria>
- Unit API supports building_id filtering for multi-building context
- Units can be created with full tenant information
- Units can be fully updated including new tenant fields
- Admin can delete units with appropriate warnings
- All operations respect role-based access control
</success_criteria>

<output>
After completion, create `.planning/phases/15-einheiten-verwaltung/15-01-SUMMARY.md`
</output>
