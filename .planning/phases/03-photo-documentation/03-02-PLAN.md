---
phase: 03-photo-documentation
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - src/components/photos/PhotoUpload.tsx
  - src/components/photos/PhotoGallery.tsx
  - src/components/photos/BeforeAfterView.tsx
  - src/components/tasks/CompleteTaskModal.tsx
  - src/app/dashboard/aufgaben/[id]/page.tsx
autonomous: false

must_haves:
  truths:
    - "User can select photo from camera or gallery"
    - "Photo preview shows before upload"
    - "Upload progress is visible"
    - "Before/After photos display side by side"
    - "Imeri must upload at least 1 photo to complete task"
  artifacts:
    - path: "src/components/photos/PhotoUpload.tsx"
      provides: "Photo capture and upload component"
      min_lines: 80
    - path: "src/components/photos/PhotoGallery.tsx"
      provides: "Photo grid with delete option"
      min_lines: 50
    - path: "src/components/photos/BeforeAfterView.tsx"
      provides: "Side-by-side explanation/completion display"
      min_lines: 40
    - path: "src/components/tasks/CompleteTaskModal.tsx"
      provides: "Updated modal requiring photo for completion"
      contains: "PhotoUpload"
  key_links:
    - from: "src/components/photos/PhotoUpload.tsx"
      to: "/api/photos POST"
      via: "fetch with FormData"
      pattern: "fetch.*api/photos"
    - from: "src/components/tasks/CompleteTaskModal.tsx"
      to: "PhotoUpload"
      via: "import and render"
      pattern: "import.*PhotoUpload"
    - from: "src/app/dashboard/aufgaben/[id]/page.tsx"
      to: "BeforeAfterView"
      via: "import and render"
      pattern: "import.*BeforeAfterView"
---

<objective>
Create photo UI components for capturing, uploading, and displaying task photos.

Purpose: Complete the photo documentation flow - KEWA adds explanation photos, Imeri adds completion photos (required), and both see before/after comparison.
Output: Reusable photo components integrated into task management UI.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
@~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior plan context (API we're using)
@.planning/phases/03-photo-documentation/03-01-SUMMARY.md

# Existing UI patterns
@src/components/tasks/CompleteTaskModal.tsx
@src/components/tasks/ImeriTaskCard.tsx
@src/lib/imageCompression.ts
@src/types/database.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create PhotoUpload component</name>
  <files>src/components/photos/PhotoUpload.tsx</files>
  <action>
Create reusable photo upload component:

**Props:**
```typescript
interface PhotoUploadProps {
  taskId: string
  photoType: 'explanation' | 'completion'
  maxPhotos?: number  // Default 2
  existingPhotos?: TaskPhotoWithUrl[]
  onUploadComplete?: (photo: TaskPhotoWithUrl) => void
  onDelete?: (photoId: string) => void
  disabled?: boolean
}
```

**Features:**

1. **File input with camera support:**
   - `accept="image/*"` for all images
   - `capture="environment"` attribute for mobile camera
   - Hidden input, triggered by styled button

2. **Photo selection:**
   - Button: "Foto aufnehmen" (Camera icon) - mobile
   - Button: "Foto auswaehlen" (Gallery icon) - desktop/mobile
   - Show count: "1 von 2 Fotos" when photos exist

3. **Preview before upload:**
   - Show selected image in thumbnail
   - "Hochladen" and "Abbrechen" buttons
   - Compress image using imageCompression.ts before preview

4. **Upload with progress:**
   - Show spinner during upload
   - Use fetch with FormData to POST /api/photos
   - Include retry logic (3 attempts with exponential backoff)
   - Show success checkmark or error message

5. **Existing photos display:**
   - Grid of thumbnails (2 columns on mobile)
   - Each with delete button (trash icon)
   - Confirm before delete: "Foto loeschen?"

**Styling:**
- Touch targets: min 48px
- Use existing Tailwind patterns from project
- Mobile-first responsive design

**Error states:**
- "Upload fehlgeschlagen. Erneut versuchen?" with retry button
- "Maximale Anzahl erreicht" when limit hit
  </action>
  <verify>npm run type-check passes, component renders without errors</verify>
  <done>PhotoUpload component handles camera/gallery selection, compression, upload with retry, and deletion</done>
</task>

<task type="auto">
  <name>Task 2: Create PhotoGallery and BeforeAfterView components</name>
  <files>src/components/photos/PhotoGallery.tsx, src/components/photos/BeforeAfterView.tsx</files>
  <action>
**PhotoGallery.tsx** - Simple grid display:

```typescript
interface PhotoGalleryProps {
  photos: TaskPhotoWithUrl[]
  onPhotoClick?: (photo: TaskPhotoWithUrl) => void
  emptyMessage?: string
}
```

- 2-column grid on mobile, 4-column on desktop
- Thumbnail images with lazy loading
- Click to open full-size in new tab/modal
- Show "Keine Fotos" when empty

**BeforeAfterView.tsx** - Side-by-side comparison:

```typescript
interface BeforeAfterViewProps {
  explanationPhotos: TaskPhotoWithUrl[]  // KEWA's "before" photos
  completionPhotos: TaskPhotoWithUrl[]   // Imeri's "after" photos
}
```

Layout:
```
+-------------------+-------------------+
|    Erklaerung     |    Erledigung     |
|    (KEWA AG)      |     (Imeri)       |
+-------------------+-------------------+
|  [photo 1]        |  [photo 1]        |
|  [photo 2]        |  [photo 2]        |
+-------------------+-------------------+
```

- Two columns, labeled headers
- Stack vertically on very small screens (<400px)
- Empty column shows: "Noch keine Fotos"
- Photo thumbnails clickable to view full size
  </action>
  <verify>npm run type-check passes, components follow existing patterns</verify>
  <done>PhotoGallery displays photos in grid, BeforeAfterView shows side-by-side comparison</done>
</task>

<task type="auto">
  <name>Task 3: Update CompleteTaskModal to require photo</name>
  <files>src/components/tasks/CompleteTaskModal.tsx</files>
  <action>
Modify existing CompleteTaskModal to require at least 1 completion photo:

**Changes:**

1. **Add state for photos:**
   - Fetch existing completion photos on mount
   - Track newly uploaded photos

2. **Add PhotoUpload component:**
   - Position before the optional note field
   - photoType="completion"
   - taskId from props
   - Show existing photos if any

3. **Validation:**
   - "Erledigen" button disabled if no completion photos
   - Show hint: "Mindestens 1 Foto erforderlich"
   - Enable button once photo uploaded

4. **Layout update:**
   ```
   +---------------------------+
   |  Aufgabe erledigen        |
   +---------------------------+
   |  [Task title]             |
   |                           |
   |  Foto-Dokumentation       |
   |  [PhotoUpload component]  |
   |                           |
   |  Notiz (optional)         |
   |  [textarea]               |
   |                           |
   |  [Abbrechen] [Erledigen]  |
   +---------------------------+
   ```

5. **On complete:**
   - Photos already uploaded via PhotoUpload
   - Just update task status to 'completed'
   - Close modal on success
  </action>
  <verify>npm run type-check passes, modal still functions correctly</verify>
  <done>CompleteTaskModal requires at least 1 photo before allowing completion</done>
</task>

<task type="auto">
  <name>Task 4: Create task detail page with photos</name>
  <files>src/app/dashboard/aufgaben/[id]/page.tsx</files>
  <action>
Create task detail page at /dashboard/aufgaben/[id]:

**Features:**

1. **Task header:**
   - Title, priority badge, status badge
   - Due date (formatted)
   - Unit and project breadcrumb

2. **Task description:**
   - Full description text
   - Completion note (if completed)

3. **Photo section:**
   - BeforeAfterView component
   - Fetch photos from GET /api/photos?task_id={id}
   - If KEWA viewing: show PhotoUpload for explanation photos
   - If task not completed: explanation photos only
   - If completed: both explanation and completion photos

4. **Actions (based on role/status):**
   - KEWA + open: "Bearbeiten" button, PhotoUpload for explanation
   - Imeri + open: "Als erledigt markieren" (opens CompleteTaskModal)
   - Any + completed: View only, show completion timestamp

**Mobile layout:**
- Full width, stacked sections
- Sticky bottom bar for actions
- Touch-optimized photo viewing

**Loading state:**
- Skeleton for task details
- Spinner for photos
  </action>
  <verify>npm run type-check passes, page renders task with photos</verify>
  <done>Task detail page shows full task info with before/after photos and role-appropriate actions</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete photo documentation flow: upload, compression, before/after display, required photos for task completion</what-built>
  <how-to-verify>
    1. Run: npm run dev
    2. Login as KEWA AG
    3. Navigate to /dashboard/aufgaben and select a task
    4. Upload an explanation photo (verify compression, preview, upload)
    5. View task detail - see explanation photo
    6. Login as Imeri
    7. Navigate to /dashboard/tasks and tap a task
    8. Tap "Erledigt" - verify photo required
    9. Upload completion photo
    10. Complete task - verify status changes
    11. View task detail - verify before/after display
    12. Test on mobile: camera capture, touch targets, responsive layout
  </how-to-verify>
  <resume-signal>Type "approved" if photo flow works end-to-end, or describe issues</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run type-check` passes
- [ ] `npm run build` succeeds (NEXT_TURBOPACK=0 if needed)
- [ ] PhotoUpload handles camera and gallery
- [ ] Images are compressed before upload
- [ ] BeforeAfterView shows side-by-side comparison
- [ ] CompleteTaskModal requires photo
- [ ] Task detail page displays photos
- [ ] Human verified end-to-end flow
</verification>

<success_criteria>
- All tasks completed
- Type checking passes
- Build succeeds
- Photo upload works on mobile with camera
- Compression reduces file size significantly
- Before/after comparison visible
- Task completion requires photo evidence
- Human approval of visual/functional correctness
</success_criteria>

<output>
After completion, create `.planning/phases/03-photo-documentation/03-02-SUMMARY.md`
</output>
