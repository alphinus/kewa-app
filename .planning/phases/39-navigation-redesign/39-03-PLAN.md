---
phase: 39-navigation-redesign
plan: 03
type: execute
wave: 2
depends_on:
  - 39-02
files_modified:
  - src/app/dashboard/objekte/[propertyId]/[buildingId]/page.tsx
  - src/app/dashboard/objekte/[propertyId]/[buildingId]/[unitId]/page.tsx
  - src/app/dashboard/objekte/[propertyId]/[buildingId]/[unitId]/raum/[roomId]/page.tsx
autonomous: true
requirements:
  - NAV-03

must_haves:
  truths:
    - "/dashboard/objekte/[propertyId]/[buildingId] shows building detail with 3 tabs: Heatmap, Einheiten, Info"
    - "/dashboard/objekte/[propertyId]/[buildingId]/[unitId] shows unit detail with condition summary and room cards"
    - "Room cards on unit detail page link to /dashboard/objekte/.../raum/[roomId]"
    - "Room detail page displays room condition, source project, and action links"
    - "All three pages show DashboardBreadcrumbs with entity names resolved from API data"
    - "New pages use URL params (not BuildingContext) for building/unit identification"
  artifacts:
    - path: "src/app/dashboard/objekte/[propertyId]/[buildingId]/page.tsx"
      provides: "Building detail page with Heatmap/Einheiten/Info tabs"
      contains: "buildingId"
    - path: "src/app/dashboard/objekte/[propertyId]/[buildingId]/[unitId]/page.tsx"
      provides: "Unit detail page with condition summary and room cards"
      contains: "unitId"
    - path: "src/app/dashboard/objekte/[propertyId]/[buildingId]/[unitId]/raum/[roomId]/page.tsx"
      provides: "Room detail page with condition and action links"
      contains: "roomId"
  key_links:
    - from: "src/app/dashboard/objekte/[propertyId]/[buildingId]/page.tsx"
      to: "/api/buildings/[id]/heatmap"
      via: "fetch for heatmap data"
      pattern: "api/buildings.*heatmap"
    - from: "src/app/dashboard/objekte/[propertyId]/[buildingId]/[unitId]/page.tsx"
      to: "/api/units/[id]"
      via: "fetch for unit detail + rooms"
      pattern: "api/units"
    - from: "src/app/dashboard/objekte/[propertyId]/[buildingId]/[unitId]/raum/[roomId]/page.tsx"
      to: "/api/rooms/[id]"
      via: "fetch for room detail"
      pattern: "api/rooms"
---

<objective>
Create the bottom three levels of the /objekte drill-down: building detail (tabs), unit detail (room cards), and room detail.

Purpose: Complete the Objekte URL hierarchy (D5, D6). Building detail uses a tabbed layout for heatmap/units/info. Unit detail shows condition overview and room cards. Room detail shows condition and links.
Output: Three new page files completing the full /objekte drill-down.
</objective>

<execution_context>
@C:/Users/Mario Giacchino/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Mario Giacchino/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/39-navigation-redesign/39-CONTEXT.md
@.planning/phases/39-navigation-redesign/39-RESEARCH.md
@.planning/phases/39-navigation-redesign/39-02-SUMMARY.md
@src/app/dashboard/liegenschaft/page.tsx
@src/app/dashboard/einheiten/page.tsx
@src/app/dashboard/wohnungen/[id]/page.tsx
@src/app/dashboard/liegenschaft/[id]/page.tsx
@src/app/dashboard/liegenschaft/[id]/einheit/[unitId]/raum/[roomId]/page.tsx
@src/app/dashboard/einheiten/[id]/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create building detail page with tabs (D5)</name>
  <files>
    src/app/dashboard/objekte/[propertyId]/[buildingId]/page.tsx
  </files>
  <action>
Create `src/app/dashboard/objekte/[propertyId]/[buildingId]/page.tsx` as a 'use client' component.

**Params:** `params: Promise<{ propertyId: string; buildingId: string }>` — unwrap with `use(params)`

**CRITICAL (Pitfall 3):** Use `params.buildingId` from the URL, NOT `useBuilding()` from BuildingContext. The new /objekte pages are URL-driven, not context-driven.

**Data fetching:**
- Fetch building info: `GET /api/buildings/${buildingId}` → `{ building }` (for name, address)
- Fetch property info: `GET /api/properties/${propertyId}` → `{ property }` (for property name in breadcrumbs)
- Heatmap data (for Heatmap tab): `GET /api/buildings/${buildingId}/heatmap` → `{ buildingId, buildingName, units: HeatmapUnit[] }`
- Units list (for Einheiten tab): `GET /api/units?building_id=${buildingId}` → `{ units }` — filter to apartment + common_area (exclude parking)
- Fetch all data in parallel on mount using Promise.all

**Breadcrumbs:**
- `<DashboardBreadcrumbs labels={{ [propertyId]: property.name, [buildingId]: building.name }} />`

**Tab layout (D5) — state-based tabs, no URL query param:**
- State: `const [activeTab, setActiveTab] = useState<'heatmap' | 'einheiten' | 'info'>('heatmap')`
- Tab bar: 3 buttons with labels "Heatmap", "Einheiten", "Info"
- Active tab: `bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100 shadow-sm font-medium`
- Inactive tab: `text-gray-500 dark:text-gray-400 hover:text-gray-700`
- Tab bar container: `flex gap-1 p-1 bg-gray-100 dark:bg-gray-800/50 rounded-lg mb-6`

**Heatmap tab content:**
Reuse the heatmap rendering logic from `src/app/dashboard/liegenschaft/page.tsx`:
- Copy the FLOOR_CONFIG, POSITION_ORDER, UnitCell, EmptyCell, StatCard, ParkingCard helper components
- Copy getUnitByFloorPosition, getUnitByFloor, getConditionColor helpers
- Render the same heatmap grid with summary stats at top
- Unit click: set selectedUnitId state, show UnitDetailPanel (import from `@/components/dashboard/UnitDetailPanel`)
- Also fetch parking from units response (filter `unit_type === 'parking_spot'`)

**Einheiten tab content:**
Reuse UnitList component from `@/components/units/UnitList`:
- Pass filtered units (apartments + common_areas only)
- onView handler: navigate to `/dashboard/objekte/${propertyId}/${buildingId}/${unit.id}`
- onEdit handler: open UnitForm modal (import from `@/components/units/UnitForm`)
- Add "Neu" button for creating units (same as einheiten/page.tsx)

**Info tab content:**
Reuse building info display from `src/app/dashboard/liegenschaft/[id]/page.tsx`:
- Card showing building name, address, created/updated dates
- DeliveryList for property delivery history (import from `@/components/suppliers/DeliveryList`, pass building.property_id)

**Loading/error/empty states:** Standard patterns (skeleton, error card, empty message).

**Page title:** Building name as `<h1>`.
  </action>
  <verify>
Run `npx tsc --noEmit`. Verify file exists at correct path. Grep for `activeTab` to confirm tab state exists. Grep for `heatmap` to confirm API call.
  </verify>
  <done>
Building detail page at /dashboard/objekte/[propertyId]/[buildingId] renders three tabs (Heatmap, Einheiten, Info) with existing content reused. Uses URL params, not BuildingContext.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create unit detail and room detail pages (D6)</name>
  <files>
    src/app/dashboard/objekte/[propertyId]/[buildingId]/[unitId]/page.tsx
    src/app/dashboard/objekte/[propertyId]/[buildingId]/[unitId]/raum/[roomId]/page.tsx
  </files>
  <action>
**1. Create `src/app/dashboard/objekte/[propertyId]/[buildingId]/[unitId]/page.tsx` (Unit Detail — D6):**

'use client' component. Params: `Promise<{ propertyId: string; buildingId: string; unitId: string }>`.

**Data fetching (parallel):**
- `GET /api/units/${unitId}` → `{ unit }` (name, unit_type, floor, position, tenant_name, building info)
- `GET /api/rooms?unit_id=${unitId}` → `{ rooms }` (for room cards)
- `GET /api/properties/${propertyId}` → property name (for breadcrumbs)
- `GET /api/buildings/${buildingId}` → building name (for breadcrumbs)

**Breadcrumbs:**
`<DashboardBreadcrumbs labels={{ [propertyId]: property.name, [buildingId]: building.name, [unitId]: unit.name }} />`

**Content structure per D6:**

1. **Header section:** Card with unit name (h1), badges for unit_type (getUnitTypeLabel), floor (getFloorLabel), tenant info if present. Reuse `UnitActions` component from `@/components/units/UnitActions` for action buttons.

2. **Condition summary:** Reuse the condition summary pattern from `wohnungen/[id]/page.tsx` — calculate from rooms array using the same logic: overall condition badge, renovation percentage, room counts (new/partial/old), progress bar. Use `ConditionBadge` from `@/components/units/ConditionBadge`. Import `fetchUnitConditionData` and `fetchRecentConditionHistory` is NOT possible (server-only Supabase). Instead, compute condition summary client-side from the rooms array (same logic as `einheiten/[id]/page.tsx`'s `calculateConditionSummary`).

3. **Room cards grid** `grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3`:
- Each room as a card: room name, room type label (German), condition badge, condition_updated_at date
- Card wraps in `<Link href={/dashboard/objekte/${propertyId}/${buildingId}/${unitId}/raum/${room.id}}>` for drill-down
- Room card styling: `bg-gray-50 dark:bg-gray-800 rounded-lg border border-gray-100 dark:border-gray-700 p-3 hover:border-blue-300 dark:hover:border-blue-600 transition-colors cursor-pointer`

4. **Room management:** RoomList from `@/components/units/RoomList` with onEdit/onAdd handlers + RoomForm modal. OR keep it simpler: just render the room cards with link navigation (room CRUD available on the old einheiten/[id] page still). Simpler approach: render room cards as navigable cards. Include an "Add Room" button that opens RoomForm modal (import from `@/components/units/RoomForm`).

Loading/error states: Standard patterns.

**2. Create `src/app/dashboard/objekte/[propertyId]/[buildingId]/[unitId]/raum/[roomId]/page.tsx` (Room Detail):**

'use client' component. Params: `Promise<{ propertyId: string; buildingId: string; unitId: string; roomId: string }>`.

**Data fetching:**
- `GET /api/rooms/${roomId}` → `{ room }` (includes room.unit with building info)
- Fetch property name: `GET /api/properties/${propertyId}` → for breadcrumbs
- Fetch building name: `GET /api/buildings/${buildingId}` → for breadcrumbs

**Breadcrumbs:**
`<DashboardBreadcrumbs labels={{ [propertyId]: property.name, [buildingId]: building.name, [unitId]: room.unit?.name || unitId, [roomId]: room.name }} />`

**Content — reuse from `liegenschaft/[id]/einheit/[unitId]/raum/[roomId]/page.tsx`:**
- Room name as h1, room_type below
- Condition card: badge with condition label (Neu/Teilsaniert/Unsaniert), condition_updated_at date, source project link if present
- Action links card: "Aufgaben anzeigen" link to `/dashboard/aufgaben?room_id=${roomId}`, "Abnahmen anzeigen" link to `/dashboard/abnahmen?room_id=${roomId}`, source project link if present
- All links updated to use /dashboard paths (no /liegenschaft references)
  </action>
  <verify>
Run `npx tsc --noEmit`. Verify both page.tsx files exist at correct paths. Grep for `raum` in the room detail page path. Grep for `DashboardBreadcrumbs` in both files.
  </verify>
  <done>
Unit detail page shows condition summary and clickable room cards. Room detail page shows condition, source project, and action links. Both use DashboardBreadcrumbs with entity name overrides. Full drill-down from objekte to room is complete.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes
2. All three page files exist at correct nested paths
3. Building detail has 3-tab layout (heatmap, einheiten, info)
4. Unit detail has room cards that link to room detail
5. Room detail has condition display and action links
6. All pages use DashboardBreadcrumbs with labels prop
7. No page uses `useBuilding()` from BuildingContext — all use URL params
</verification>

<success_criteria>
- Full drill-down path works: /objekte > /[propertyId] > /[buildingId] > /[unitId] > /raum/[roomId]
- Building detail shows tabs: Heatmap, Einheiten, Info
- Unit detail shows condition summary + room cards
- Room detail shows condition + action links
- Breadcrumbs show entity names (not UUIDs)
- No TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/39-navigation-redesign/39-03-SUMMARY.md`
</output>
