---
phase: 02-task-management
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/types/database.ts
  - src/app/api/units/route.ts
  - src/app/api/projects/route.ts
  - src/app/api/projects/[id]/route.ts
  - src/app/api/tasks/route.ts
  - src/app/api/tasks/[id]/route.ts
autonomous: true

must_haves:
  truths:
    - "API gibt Liste aller Einheiten mit offenen Aufgaben-Count zurueck"
    - "API ermoeglicht CRUD fuer Projekte"
    - "API ermoeglicht CRUD fuer Aufgaben"
    - "Aufgaben haben Titel, Beschreibung, Faelligkeit, Prioritaet"
  artifacts:
    - path: "src/types/database.ts"
      provides: "TypeScript types matching database schema"
      contains: "interface Task"
    - path: "src/app/api/units/route.ts"
      provides: "GET units with task statistics"
      exports: ["GET"]
    - path: "src/app/api/tasks/route.ts"
      provides: "Task CRUD operations"
      exports: ["GET", "POST"]
    - path: "src/app/api/tasks/[id]/route.ts"
      provides: "Single task operations"
      exports: ["GET", "PUT", "DELETE"]
  key_links:
    - from: "src/app/api/units/route.ts"
      to: "supabase.from('units')"
      via: "Supabase query with task count aggregation"
      pattern: "supabase.*from.*units"
    - from: "src/app/api/tasks/route.ts"
      to: "supabase.from('tasks')"
      via: "Supabase CRUD operations"
      pattern: "supabase.*from.*tasks"
---

<objective>
Create the Task Management API foundation - database types and CRUD endpoints for units, projects, and tasks.

Purpose: Provide the data layer that both KEWA and Imeri dashboards will consume. All task operations flow through these endpoints.
Output: Working API routes that return real data from Supabase.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation/01-01-SUMMARY.md
@.planning/phases/01-foundation/01-02-SUMMARY.md

@supabase/migrations/001_initial_schema.sql
@src/lib/supabase/server.ts
@src/types/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create database TypeScript types</name>
  <files>src/types/database.ts</files>
  <action>
    Create TypeScript interfaces matching the database schema from 001_initial_schema.sql:

    - Building: id, name, address, created_at
    - Unit: id, building_id, name, unit_type, floor, position, tenant_name, tenant_visible_to_imeri, created_at
    - Project: id, unit_id, name, description, status, visible_to_imeri, created_at
    - Task: id, project_id, title, description, status, priority, due_date, completed_at, completion_note, recurring_type, created_at, updated_at

    Add utility types:
    - UnitWithStats (extends Unit with open_tasks_count, total_tasks_count)
    - TaskWithProject (extends Task with project name and unit info)
    - CreateTaskInput, UpdateTaskInput for API payloads

    Export all types. Use existing Role, TaskStatus, Priority from src/types/index.ts.
  </action>
  <verify>npx tsc --noEmit passes</verify>
  <done>All database entities have TypeScript types, properly typed for Supabase queries</done>
</task>

<task type="auto">
  <name>Task 2: Create units API with task statistics</name>
  <files>src/app/api/units/route.ts</files>
  <action>
    Create GET /api/units endpoint that returns all units with task statistics:

    1. Query units table joined with task counts:
       - Use Supabase RPC or manual aggregation
       - Count open tasks per unit (via projects -> tasks where status='open')
       - Count total tasks per unit

    2. Return UnitWithStats[] sorted by floor (descending) then name

    3. Handle authentication:
       - Read userId from x-user-id header (set by middleware)
       - If role is 'imeri', filter out units where tenant_visible_to_imeri=false

    Return format: { units: UnitWithStats[] }

    Use createClient() from src/lib/supabase/server.ts for database access.
  </action>
  <verify>curl -X GET localhost:3000/api/units -H "Cookie: session=..." returns unit list with task counts</verify>
  <done>GET /api/units returns all units with open_tasks_count and total_tasks_count</done>
</task>

<task type="auto">
  <name>Task 3: Create tasks API with CRUD operations</name>
  <files>src/app/api/tasks/route.ts, src/app/api/tasks/[id]/route.ts</files>
  <action>
    Create /api/tasks endpoints:

    **GET /api/tasks** (route.ts):
    - Return all tasks with project and unit info (TaskWithProject[])
    - Support query params: ?status=open|completed, ?project_id=uuid, ?unit_id=uuid
    - Sort by due_date (nulls last), then priority (urgent first), then created_at
    - For Imeri role: filter to visible_to_imeri=true projects only

    **POST /api/tasks** (route.ts):
    - Accept CreateTaskInput: { project_id, title, description?, due_date?, priority? }
    - Set defaults: status='open', priority='normal'
    - Validate project_id exists
    - Return created task

    **GET /api/tasks/[id]** ([id]/route.ts):
    - Return single TaskWithProject by id
    - 404 if not found

    **PUT /api/tasks/[id]** ([id]/route.ts):
    - Accept UpdateTaskInput (partial update)
    - If status changes to 'completed', set completed_at to NOW()
    - If status changes to 'open', clear completed_at
    - Return updated task

    **DELETE /api/tasks/[id]** ([id]/route.ts):
    - Delete task by id
    - Return { success: true }

    All endpoints use Supabase server client. Return proper HTTP status codes.
  </action>
  <verify>
    - curl POST /api/tasks creates task and returns 201
    - curl GET /api/tasks returns task list
    - curl PUT /api/tasks/:id updates task
    - curl DELETE /api/tasks/:id deletes task
  </verify>
  <done>Full CRUD for tasks working, with filtering by status/project/unit</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] npx tsc --noEmit passes (no TypeScript errors)
- [ ] npm run build succeeds
- [ ] GET /api/units returns units with task counts
- [ ] GET /api/tasks returns task list
- [ ] POST /api/tasks creates new task
- [ ] PUT /api/tasks/:id updates task (including status change)
- [ ] DELETE /api/tasks/:id removes task
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- API endpoints return real data from Supabase
- Types are properly exported and usable
- No hardcoded/placeholder data in API responses
</success_criteria>

<output>
After completion, create `.planning/phases/02-task-management/02-01-SUMMARY.md`
</output>
