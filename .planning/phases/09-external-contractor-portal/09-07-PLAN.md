---
phase: 09-external-contractor-portal
plan: 07
type: execute
wave: 1
depends_on: []
files_modified:
  - src/app/dashboard/projekte/[id]/page.tsx
  - src/app/dashboard/auftraege/page.tsx
  - src/app/dashboard/auftraege/neu/page.tsx
  - src/app/dashboard/auftraege/[id]/page.tsx
autonomous: true

# Goal-backward verification
must_haves:
  truths:
    - "Create Work Order button visible on project detail page"
    - "Work order list page shows all work orders with status"
    - "Work order detail page shows full info with send button"
    - "WorkOrderForm and WorkOrderSendDialog are wired into UI"
  artifacts:
    - path: "src/app/dashboard/projekte/[id]/page.tsx"
      provides: "Create Work Order action button"
      contains: "Auftrag erstellen"
    - path: "src/app/dashboard/auftraege/page.tsx"
      provides: "Work order list page"
      exports: ["default"]
    - path: "src/app/dashboard/auftraege/neu/page.tsx"
      provides: "Create work order page"
      exports: ["default"]
    - path: "src/app/dashboard/auftraege/[id]/page.tsx"
      provides: "Work order detail page"
      exports: ["default"]
  key_links:
    - from: "projekte/[id]/page.tsx"
      to: "/dashboard/auftraege/neu"
      via: "Link"
      pattern: "/dashboard/auftraege/neu"
    - from: "auftraege/neu/page.tsx"
      to: "WorkOrderForm"
      via: "import"
      pattern: "WorkOrderForm"
    - from: "auftraege/[id]/page.tsx"
      to: "WorkOrderSendDialog"
      via: "import"
      pattern: "WorkOrderSendDialog"
---

<objective>
Integrate WorkOrderForm and WorkOrderSendDialog into admin UI.

Purpose: Closes UAT Test 1 blocker - WorkOrderForm exists but is NOT integrated into any page. No Create Work Order button on project detail page.

Output: Complete work order management UI in KEWA admin dashboard.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md

# Gap source
@.planning/phases/09-external-contractor-portal/09-UAT.md

# Existing components
@src/components/work-orders/WorkOrderForm.tsx
@src/components/work-orders/WorkOrderSendDialog.tsx

# Project detail page to modify
@src/app/dashboard/projekte/[id]/page.tsx

# API endpoints already exist
@src/app/api/work-orders/route.ts
@src/app/api/work-orders/[id]/route.ts
@src/app/api/work-orders/[id]/send/route.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add "Auftrag erstellen" button to project detail page</name>
  <files>src/app/dashboard/projekte/[id]/page.tsx</files>
  <action>
    Add a new action button "Auftrag erstellen" in the Actions section that:
    1. Links to `/dashboard/auftraege/neu?project_id={project.id}`
    2. Uses appropriate icon (document/clipboard icon)
    3. Styled same as other action buttons
    4. Only visible for active/planned projects (not archived)

    Add after "Aufgaben anzeigen" button:
    ```tsx
    <Link
      href={`/dashboard/auftraege/neu?project_id=${project.id}`}
      className="inline-flex items-center gap-2 px-4 py-2 text-sm font-medium text-white bg-green-600 hover:bg-green-700 rounded-lg transition-colors"
    >
      <svg ...>...</svg>
      Auftrag erstellen
    </Link>
    ```
  </action>
  <verify>npm run build succeeds</verify>
  <done>Project detail page has "Auftrag erstellen" button linking to create form</done>
</task>

<task type="auto">
  <name>Task 2: Create work order list page</name>
  <files>src/app/dashboard/auftraege/page.tsx</files>
  <action>
    Create a new page that lists all work orders:
    1. Fetch work orders from supabase with partner and project relations
    2. Display in table/card format with: title, partner, status, deadline
    3. Status badges with colors (draft, sent, viewed, accepted, rejected, etc.)
    4. Link each row to detail page `/dashboard/auftraege/{id}`
    5. "Neuer Auftrag" button linking to create page
    6. Use existing project list page as template for structure

    Query work orders with:
    ```ts
    const { data: workOrders } = await supabase
      .from('work_orders')
      .select(`
        id, title, status, acceptance_deadline, estimated_cost, created_at,
        partner:partners (company_name),
        project:renovation_projects (name)
      `)
      .order('created_at', { ascending: false })
    ```

    German status labels:
    - draft: Entwurf
    - sent: Gesendet
    - viewed: Angesehen
    - accepted: Angenommen
    - rejected: Abgelehnt
    - in_progress: In Arbeit
    - done: Erledigt
    - closed: Abgeschlossen
  </action>
  <verify>npm run build succeeds</verify>
  <done>Work order list page displays all work orders with navigation</done>
</task>

<task type="auto">
  <name>Task 3: Create work order create page</name>
  <files>src/app/dashboard/auftraege/neu/page.tsx</files>
  <action>
    Create a page that wraps WorkOrderForm:
    1. Import WorkOrderForm from '@/components/work-orders/WorkOrderForm'
    2. Read project_id and task_id from URL searchParams
    3. Pass defaultProjectId and defaultTaskId to WorkOrderForm
    4. Handle onSave: redirect to `/dashboard/auftraege/{newId}`
    5. Handle onCancel: router.back() or redirect to list

    The page is a client component wrapping the form:
    ```tsx
    'use client'

    import { useRouter, useSearchParams } from 'next/navigation'
    import { WorkOrderForm } from '@/components/work-orders/WorkOrderForm'

    export default function CreateWorkOrderPage() {
      const router = useRouter()
      const searchParams = useSearchParams()
      const projectId = searchParams.get('project_id') ?? undefined
      const taskId = searchParams.get('task_id') ?? undefined

      return (
        <div className="max-w-3xl mx-auto">
          <h1>Neuer Arbeitsauftrag</h1>
          <WorkOrderForm
            mode="create"
            defaultProjectId={projectId}
            defaultTaskId={taskId}
            onSave={(wo) => router.push(`/dashboard/auftraege/${wo.id}`)}
            onCancel={() => router.back()}
          />
        </div>
      )
    }
    ```
  </action>
  <verify>npm run build succeeds</verify>
  <done>Create work order page uses WorkOrderForm with URL params</done>
</task>

<task type="auto">
  <name>Task 4: Create work order detail page with send dialog</name>
  <files>src/app/dashboard/auftraege/[id]/page.tsx</files>
  <action>
    Create a detail page that shows full work order info and send dialog:
    1. Fetch work order with all relations (partner, project, task)
    2. Display all fields: title, description, scope, dates, cost, deadline
    3. Show partner info and project link
    4. Action buttons section with:
       - "Senden" button (only if status=draft) - opens WorkOrderSendDialog
       - "PDF herunterladen" button
       - "Bearbeiten" button (only if status=draft)
    5. Event timeline section (using EventLog component if available)
    6. Counter-offer review section (if counter_offer_status = pending)

    Make it a client component for dialog interaction:
    ```tsx
    'use client'

    import { useState } from 'react'
    import { WorkOrderSendDialog } from '@/components/work-orders/WorkOrderSendDialog'
    // ... rest
    ```

    Fetch work order:
    ```ts
    const { data: workOrder } = await supabase
      .from('work_orders')
      .select(`
        *,
        partner:partners (*),
        project:renovation_projects (id, name),
        task:tasks (id, title)
      `)
      .eq('id', id)
      .single()
    ```
  </action>
  <verify>npm run build succeeds</verify>
  <done>Work order detail page shows full info with send dialog</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] npm run build succeeds
- [ ] Project detail page has "Auftrag erstellen" button
- [ ] /dashboard/auftraege shows work order list
- [ ] /dashboard/auftraege/neu renders WorkOrderForm
- [ ] /dashboard/auftraege/[id] renders detail with WorkOrderSendDialog
</verification>

<success_criteria>
- All tasks completed
- Work order creation flow accessible from project detail
- Full work order management UI in admin dashboard
- WorkOrderForm and WorkOrderSendDialog properly integrated
</success_criteria>

<output>
After completion, create `.planning/phases/09-external-contractor-portal/09-07-SUMMARY.md`
</output>
