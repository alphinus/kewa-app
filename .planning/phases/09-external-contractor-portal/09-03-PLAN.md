---
phase: 09
plan: 03
name: Response Actions & Counter-Offer Flow
scope: medium
wave: 2
depends_on: [01, 02]
files_modified:
  - src/app/api/contractor/[token]/status/route.ts
  - src/app/api/contractor/[token]/[workOrderId]/respond/route.ts
  - src/app/contractor/[token]/[workOrderId]/response-form.tsx
  - src/app/contractor/[token]/[workOrderId]/reject-modal.tsx
  - src/app/contractor/[token]/[workOrderId]/counter-offer-form.tsx
  - src/components/admin/work-orders/CounterOfferReview.tsx
  - supabase/migrations/037_work_order_extensions.sql
autonomous: true
requirements:
  - EXT-07
  - EXT-08
  - EXT-09
  - EXT-10
---

<objective>
Implement the full contractor response flow including Accept, Reject with reasons, Counter-offer with price/date proposal, and question/comment fields. Include KEWA admin UI for reviewing counter-offers.
</objective>

<context>
Per 09-CONTEXT.md decisions:
- "Rejection: Reason required - select from list + optional comment"
- "Counter-offer: Supported - contractor can propose different price, KEWA approves/rejects"
- "After counter-offer rejected: KEWA chooses - can close or send back"
- "No in-app messaging - contact info shown, communication via phone/email"

Work order table already has: proposed_cost, proposed_start_date, proposed_end_date, contractor_notes, rejection_reason.
</context>

<tasks>
1. Create migration for counter-offer tracking (supabase/migrations/037_work_order_extensions.sql)
   - Add counter_offer_status enum: pending, approved, rejected
   - Add counter_offer_status column to work_orders
   - Add counter_offer_responded_at timestamp
   - Add counter_offer_response_notes text

2. Create contractor response API (src/app/api/contractor/[token]/[workOrderId]/respond/route.ts)
   - POST with action: 'accept' | 'reject' | 'counter_offer'
   - Accept: sets status to 'accepted', copies proposed values if different
   - Reject: sets status to 'rejected', requires rejection_reason
   - Counter-offer: keeps status 'viewed', sets proposed values, sets counter_offer_status='pending'
   - Validates token and work order ownership

3. Define rejection reasons constant
   - capacity: "Keine freie Kapazitaet im Zeitraum"
   - location: "Standort zu weit entfernt"
   - scope: "Arbeitsumfang nicht passend"
   - timeline: "Zeitrahmen nicht realisierbar"
   - price: "Budget nicht ausreichend"
   - other: "Sonstiges (bitte angeben)"

4. Create ResponseForm component (src/app/contractor/[token]/[workOrderId]/response-form.tsx)
   - Shows when status is 'viewed'
   - Proposed cost input (pre-filled with estimated_cost)
   - Proposed dates inputs (start/end)
   - Questions/comments textarea
   - Accept button: if proposed matches estimated, direct accept
   - Accept with changes button: if proposed differs, triggers counter-offer
   - Reject button: opens RejectModal

5. Create RejectModal component (src/app/contractor/[token]/[workOrderId]/reject-modal.tsx)
   - Radio buttons for rejection reasons
   - "Other" shows additional textarea
   - Cancel and Confirm buttons
   - Calls respond API with action='reject'

6. Create CounterOfferForm component (src/app/contractor/[token]/[workOrderId]/counter-offer-form.tsx)
   - Comparison view: KEWA's offer vs Contractor's proposal
   - Shows differences highlighted
   - Explanation textarea
   - Submit creates counter-offer

7. Create KEWA admin CounterOfferReview component (src/components/admin/work-orders/CounterOfferReview.tsx)
   - Shows on work order detail when counter_offer_status='pending'
   - Side-by-side comparison
   - Approve button: sets status='accepted', counter_offer_status='approved'
   - Reject button: sets counter_offer_status='rejected', optionally sends back to contractor
   - Close button: closes the work order entirely

8. Update status transition validation
   - Allow 'viewed' -> 'viewed' (for counter-offer updates)
   - Allow 'accepted' from counter-offer approval (KEWA action)
</tasks>

<verification>
- Contractor can accept work order, status changes to 'accepted'
- Contractor can reject with reason, status changes to 'rejected'
- Contractor can propose different price/dates
- Counter-offer creates pending state for KEWA review
- KEWA can approve counter-offer, status changes to 'accepted'
- KEWA can reject counter-offer
- Rejection reasons are recorded in database
- Contractor notes saved with response
</verification>

<must_haves>
- Accept/Reject buttons functional (EXT-07)
- Contractor can propose price with comment (EXT-08)
- Contractor can propose different dates (EXT-09)
- Question/comment field available (EXT-10)
- Rejection requires reason selection
- Counter-offer flow with KEWA approval
</must_haves>
