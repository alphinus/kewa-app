---
phase: 09-external-contractor-portal
plan: 06
type: execute
wave: 1
depends_on: []
files_modified: [src/middleware.ts]
autonomous: true

# Goal-backward verification
must_haves:
  truths:
    - "Contractor can access portal via magic link without prior session"
    - "Magic link token in URL path is validated before session check"
    - "Internal users still require session for dashboard"
  artifacts:
    - path: "src/middleware.ts"
      provides: "Fixed contractor route handling"
      contains: "validateContractorAccess"
  key_links:
    - from: "middleware.ts"
      to: "validateContractorAccess"
      via: "import"
      pattern: "validateContractorAccess"
---

<objective>
Fix middleware to allow contractor portal access via magic link without prior session.

Purpose: Closes UAT Test 4 blocker - middleware blocks contractor portal because token is in path (not query param) and session check happens before token validation.

Output: Middleware that validates path-based tokens before requiring session.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md

# Gap source
@.planning/phases/09-external-contractor-portal/09-UAT.md

# Current implementation
@src/middleware.ts
@src/lib/magic-link.ts
@src/app/contractor/[token]/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix handleContractorRoute to validate path token</name>
  <files>src/middleware.ts</files>
  <action>
    The current logic checks for `?token=xxx` query param but actual URLs are `/contractor/{token-value}`.

    Fix handleContractorRoute to:
    1. Extract token from pathname (after `/contractor/`)
    2. Call validateContractorAccess(token) to check if token is valid
    3. If token is valid, let request through (page component handles session creation)
    4. If token is invalid, redirect to login with appropriate error
    5. Remove the query param token redirect logic (not used)

    The key insight: contractor URLs are `/contractor/{token}` where token IS the path segment.
    Example: `/contractor/abc123xyz` - extract `abc123xyz` as the token.

    Import validateContractorAccess from '@/lib/magic-link'.

    The function should:
    - Parse pathname to extract token (everything after `/contractor/`)
    - Handle nested paths like `/contractor/{token}/{workOrderId}` by extracting first segment
    - Validate token using validateContractorAccess
    - If valid: NextResponse.next() with contractor headers
    - If invalid: redirect to login with error
  </action>
  <verify>TypeScript compiles: npx tsc --noEmit src/middleware.ts</verify>
  <done>Middleware validates path-based magic link tokens before requiring session</done>
</task>

<task type="auto">
  <name>Task 2: Test middleware allows magic link access</name>
  <files>src/middleware.ts</files>
  <action>
    Verify the fix by checking:
    1. Code correctly extracts token from path
    2. validateContractorAccess is called with extracted token
    3. Valid tokens pass through without session requirement
    4. Invalid tokens redirect to login with error

    Also ensure:
    - `/dashboard/*` routes still require session
    - `/api/*` routes still require session
    - Nested contractor paths work (e.g., `/contractor/{token}/{workOrderId}`)
  </action>
  <verify>npm run build succeeds without errors</verify>
  <done>Build passes, middleware logic handles all contractor URL patterns</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] npm run build succeeds
- [ ] Middleware extracts token from path `/contractor/{token}`
- [ ] validateContractorAccess is imported and called
- [ ] Valid tokens allow access without prior session
- [ ] Invalid tokens redirect to login
</verification>

<success_criteria>
- All tasks completed
- Middleware allows contractor portal access via path-based magic link tokens
- No regression in dashboard/API session requirements
</success_criteria>

<output>
After completion, create `.planning/phases/09-external-contractor-portal/09-06-SUMMARY.md`
</output>
