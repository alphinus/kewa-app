---
phase: 09
plan: 04
name: Contractor File Uploads
scope: medium
wave: 2
depends_on: [01, 02]
files_modified:
  - src/app/api/contractor/[token]/[workOrderId]/upload/route.ts
  - src/app/api/contractor/[token]/[workOrderId]/media/route.ts
  - src/app/contractor/[token]/[workOrderId]/upload-section.tsx
  - src/app/contractor/[token]/[workOrderId]/media-gallery.tsx
  - src/components/upload/FileUploader.tsx
  - src/lib/storage/contractor-upload.ts
autonomous: true
requirements:
  - EXT-11
  - EXT-12
---

<objective>
Enable contractors to upload documents (offers, invoices) and photos (completion evidence) through the portal. Uses existing media table and storage bucket patterns.
</objective>

<context>
Per 09-CONTEXT.md decisions:
- "Uploads: Flexible - any combination of photos, documents, videos"
- "Evidence requests: Contractor decides what to upload"
- "Completion: Mark complete button - contractor signals done"

Storage conventions from 031_storage_buckets.sql:
- work_orders/{work_order_id}/documents/{uuid}.pdf
- work_orders/{work_order_id}/photos/{context}/{uuid}.webp

Media table supports polymorphic attachments via entity_type/entity_id.
</context>

<tasks>
1. Create contractor upload utility (src/lib/storage/contractor-upload.ts)
   - validateContractorUpload: check file type, size limits
   - generateStoragePath: based on work order ID and media type
   - Photo limits: 10MB max, image/* mime types
   - Document limits: 20MB max, application/pdf

2. Create contractor upload API (src/app/api/contractor/[token]/[workOrderId]/upload/route.ts)
   - POST accepts multipart/form-data
   - Validates token and work order access
   - File field: file (required)
   - Type field: 'photo' | 'document'
   - Context field: 'offer' | 'invoice' | 'completion' | 'other'
   - Uploads to Supabase Storage
   - Creates media table record
   - Returns media record with signed URL

3. Create contractor media list API (src/app/api/contractor/[token]/[workOrderId]/media/route.ts)
   - GET returns all media for work order
   - Generates fresh signed URLs
   - Filters by type if query param provided
   - DELETE removes specific media (soft delete)

4. Create FileUploader component (src/components/upload/FileUploader.tsx)
   - Mobile-optimized upload UI
   - Drag-and-drop (desktop) or tap to select (mobile)
   - Camera capture option for photos
   - Progress indicator during upload
   - Preview after upload
   - Delete button on uploaded items
   - Accept prop for allowed file types

5. Create UploadSection component (src/app/contractor/[token]/[workOrderId]/upload-section.tsx)
   - Section in work order detail
   - Tabs: Photos | Documents
   - FileUploader instance for each tab
   - Context selector (completion, offer, invoice, other)
   - Count badge showing uploaded items

6. Create MediaGallery component (src/app/contractor/[token]/[workOrderId]/media-gallery.tsx)
   - Grid display of uploaded photos
   - List display for documents
   - Lightbox for photo viewing
   - Download link for documents
   - Delete option if status allows

7. Integrate with work order detail
   - Show UploadSection when status is accepted/in_progress/done
   - Show MediaGallery always (read-only for closed)
   - Update UI after successful upload

8. Add completion flow integration
   - "Mark Complete" button enabled only when work is in_progress
   - Optional prompt to upload completion photos before marking done
   - Sets status to 'done'
</tasks>

<verification>
- Contractor can upload photos via portal
- Contractor can upload PDF documents
- File size limits enforced
- Media records created in database
- Signed URLs generated for viewing
- Gallery displays uploaded media
- Delete removes media (when allowed)
- Camera capture works on mobile
</verification>

<must_haves>
- Document upload (offer/invoice) functional (EXT-11)
- Photo upload functional (EXT-12)
- Uploads linked to work order in media table
- Storage paths follow convention
- Mobile-optimized upload UI
</must_haves>
