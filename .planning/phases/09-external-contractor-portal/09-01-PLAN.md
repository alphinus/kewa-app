---
phase: 09
plan: 01
name: WorkOrder Creation & PDF Generation
scope: medium
wave: 1
depends_on: []
files_modified:
  - package.json
  - src/lib/pdf/work-order-pdf.tsx
  - src/app/api/work-orders/route.ts
  - src/app/api/work-orders/[id]/route.ts
  - src/app/api/work-orders/[id]/pdf/route.ts
  - src/app/api/work-orders/[id]/send/route.ts
  - src/types/work-order.ts
  - src/components/work-orders/WorkOrderForm.tsx
  - src/components/work-orders/WorkOrderSendDialog.tsx
autonomous: true
requirements:
  - EXT-01
  - EXT-02
  - EXT-03
  - EXT-04
  - EXT-05
---

<objective>
Implement WorkOrder creation from projects/tasks with partner assignment, PDF generation using @react-pdf/renderer, and email sending via mailto links with magic link tokens.
</objective>

<context>
The work_orders table already exists (migration 013) with all required fields including scope_of_work, location via room_id, dates, attachments via media table, and notes. The magic link infrastructure is complete. This plan adds the creation UI, PDF generation, and email workflow.

**Key decisions from 09-CONTEXT.md:**
- Email content: KEWA chooses per work order whether to attach PDF or just include link
- Info exposed: Work-relevant only â€” address, unit number, room(s), access instructions, site contact
</context>

<tasks>
1. Install @react-pdf/renderer library
   - Add to package.json dependencies
   - Verify compatibility with Next.js 16 and React 19

2. Create WorkOrder TypeScript types (src/types/work-order.ts)
   - WorkOrder interface matching database schema
   - WorkOrderWithRelations for queries with room/unit/building joins
   - CreateWorkOrderInput for API
   - WorkOrderPDFData for PDF generation

3. Create work order PDF template (src/lib/pdf/work-order-pdf.tsx)
   - A4 format with KEWA AG branding
   - Sections: Header, Location, Scope, Schedule, Cost, Deadline, Footer
   - German text throughout (Arbeitsauftrag, Standort, etc.)
   - Support Swiss date format (dd.MM.yyyy)

4. Create work order CRUD API routes
   - POST /api/work-orders - Create work order from project/task
   - GET /api/work-orders/[id] - Get work order with relations
   - PATCH /api/work-orders/[id] - Update work order

5. Create PDF generation API route (src/app/api/work-orders/[id]/pdf/route.ts)
   - GET returns PDF as binary with Content-Disposition header
   - Fetch work order with all relations for PDF data
   - Use @react-pdf/renderer renderToStream

6. Create send workflow API route (src/app/api/work-orders/[id]/send/route.ts)
   - POST triggers: create magic link, build mailto, update status to 'sent'
   - Returns: token, url, expiresAt, mailtoLink, pdfDownloadUrl
   - Update work order status from draft to sent

7. Create WorkOrderForm component
   - Select project (required) or task (optional)
   - Select partner from partners list (filtered by trade if task has trade)
   - Enter scope_of_work (textarea)
   - Set requested dates (start/end)
   - Set estimated_cost
   - Set acceptance_deadline (default 72 hours from now)
   - Add internal_notes

8. Create WorkOrderSendDialog component
   - Preview work order details
   - Download PDF button
   - Open Email button (mailto link)
   - Instructions for manual PDF attachment
   - Confirm send button (calls send API)
</tasks>

<verification>
- npm install @react-pdf/renderer succeeds
- POST /api/work-orders creates work order with all required fields
- GET /api/work-orders/[id]/pdf returns valid PDF binary
- PDF contains all work order details in German
- POST /api/work-orders/[id]/send creates magic link and returns mailto
- Work order status transitions from draft to sent
- Mailto link opens user's email client with pre-filled content
</verification>

<must_haves>
- WorkOrder created from project/task with partner assignment (EXT-01)
- WorkOrder contains scope, location, dates, estimated cost, notes (EXT-02)
- PDF generation produces downloadable A4 document (EXT-03)
- Email via mailto link with magic link URL (EXT-04, EXT-05)
- Status updated to 'sent' after email workflow initiated
</must_haves>
