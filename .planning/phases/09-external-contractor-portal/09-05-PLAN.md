---
phase: 09
plan: 05
name: Tracking & Event Logging
scope: small
wave: 3
depends_on: [01, 02, 03, 04]
files_modified:
  - supabase/migrations/038_work_order_events.sql
  - src/lib/work-orders/events.ts
  - src/app/api/work-orders/[id]/events/route.ts
  - src/components/admin/work-orders/EventLog.tsx
  - src/app/contractor/[token]/[workOrderId]/deadline-banner.tsx
autonomous: true
requirements:
  - EXT-14
  - EXT-16
---

<objective>
Implement timestamped event logging for all work order activities and deadline tracking with visual indicators.
</objective>

<context>
Per 09-CONTEXT.md decisions:
- "Deadlines: Shown but no automated reminders - KEWA follows up manually"
- EXT-15 (Automatic Reminders) is DEFERRED

Need event logging for: created, sent, viewed, accepted, rejected, counter_offer, status changes, uploads, etc.
</context>

<tasks>
1. Create work order events migration (supabase/migrations/038_work_order_events.sql)
   - work_order_events table
   - Columns: id, work_order_id, event_type, event_data (JSONB), actor_type (kewa/contractor), actor_id, created_at
   - Event types enum: created, sent, viewed, accepted, rejected, counter_offer_submitted, counter_offer_approved, counter_offer_rejected, started, completed, upload_added, status_changed
   - Index on work_order_id for efficient queries
   - Trigger to auto-log status changes

2. Create event logging utility (src/lib/work-orders/events.ts)
   - logWorkOrderEvent(workOrderId, eventType, data, actor)
   - getWorkOrderEvents(workOrderId) with pagination
   - Event type constants with German labels

3. Create events API route (src/app/api/work-orders/[id]/events/route.ts)
   - GET returns paginated event list
   - KEWA/Imeri only (contractors see limited events in portal)

4. Integrate event logging into existing APIs
   - Log 'sent' when magic link created
   - Log 'viewed' when contractor first opens
   - Log 'accepted/rejected' on response
   - Log 'counter_offer_submitted' on counter-offer
   - Log 'upload_added' on file upload
   - Log 'status_changed' for all transitions

5. Create EventLog component (src/components/admin/work-orders/EventLog.tsx)
   - Timeline display of events
   - Event icon and color by type
   - Timestamp in Swiss format
   - Actor indicator (KEWA vs Contractor)
   - Expandable event data details
   - Load more pagination

6. Create DeadlineBanner component (src/app/contractor/[token]/[workOrderId]/deadline-banner.tsx)
   - Shows acceptance_deadline prominently
   - Color coding: green (>48h), yellow (24-48h), red (<24h), expired
   - Countdown display: "Antwort bis: DD.MM.YYYY (noch X Tage)"
   - Expired state: "Frist abgelaufen - bitte KEWA kontaktieren"

7. Add deadline to dashboard cards
   - Show deadline on work order cards
   - Highlight overdue items
   - Sort by deadline when action needed

8. Create deadline check utility
   - isDeadlinePassed(workOrder)
   - getDeadlineStatus(workOrder): 'ok' | 'warning' | 'urgent' | 'expired'
   - Used in UI components for consistent styling
</tasks>

<verification>
- Events logged for all work order actions
- Events include timestamp, type, actor, and data
- Event timeline displays in admin UI
- Deadline displayed prominently in contractor portal
- Deadline color coding reflects urgency
- Overdue items highlighted in dashboard
- Status changes auto-logged via trigger
</verification>

<must_haves>
- Timestamped events in log (EXT-14)
- Deadline displayed with countdown (EXT-16)
- Event log viewable in admin UI
- All status changes tracked
- Upload events recorded
</must_haves>
