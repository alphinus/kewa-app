---
phase: 09
plan: 02
name: Contractor Dashboard Transformation
scope: medium
wave: 1
depends_on: []
files_modified:
  - src/app/contractor/[token]/page.tsx
  - src/app/contractor/[token]/work-order-card.tsx
  - src/app/contractor/[token]/dashboard-section.tsx
  - src/app/contractor/[token]/request-link-form.tsx
  - src/lib/contractor/queries.ts
  - src/lib/magic-link.ts
autonomous: true
requirements:
  - EXT-06
  - EXT-13
---

<objective>
Transform the contractor portal from showing a single work order to displaying a dashboard of ALL work orders for that contractor. Implement viewed status tracking and request-new-link form for expired tokens.
</objective>

<context>
Per 09-CONTEXT.md decisions:
- "Link leads to dashboard showing all contractor's work orders (not single work order)"
- "Link validity: Until work order is complete (contractor can bookmark)"
- "Expired/completed link: Show Request new link form"
- "Dashboard layout: Card per work order showing status at a glance"
- "Status display: Action needed focus"

Current implementation shows single work order linked to token. Need to query by contractor email instead.
</context>

<tasks>
1. Create contractor queries library (src/lib/contractor/queries.ts)
   - getContractorWorkOrders(email: string) - fetches all work orders for partner with that email
   - Query via partners.email join, exclude draft status
   - Include room/unit/building relations
   - Sort by created_at descending

2. Update magic link validation (src/lib/magic-link.ts)
   - Add validateContractorAccess function
   - Check work order status instead of time-based expiry for viewed/accepted/in_progress
   - Return 'work_order_closed' error for closed work orders
   - Time-based expiry still applies for never-viewed (draft/sent) tokens

3. Transform contractor page (src/app/contractor/[token]/page.tsx)
   - Validate token to get contractor email
   - Fetch ALL work orders for contractor
   - Group by action status: needsAction, inProgress, completed
   - Display DashboardSection for each group

4. Create DashboardSection component (src/app/contractor/[token]/dashboard-section.tsx)
   - Section header with count badge
   - Color coding: orange for action needed, purple for in progress, gray for completed
   - Completed section collapsed by default (details element)
   - Empty state for no work orders

5. Enhance WorkOrderCard for dashboard (src/app/contractor/[token]/work-order-card.tsx)
   - Compact card variant for dashboard list
   - Show: title, location, status badge, deadline
   - Action needed indicator (pulsing dot or badge)
   - Click navigates to detail view
   - Full card variant for detail view (existing)

6. Implement auto-viewed tracking
   - When contractor opens dashboard for first time, mark 'sent' orders as 'viewed'
   - API call on page load if any orders in 'sent' status
   - Update viewed_at timestamp

7. Create request-link-form component (src/app/contractor/[token]/request-link-form.tsx)
   - Shown when token invalid/expired/work_order_closed
   - Email input field
   - Submit sends request to KEWA (audit log entry)
   - Confirmation message: "Request sent. KEWA will contact you."

8. Create work order detail route
   - src/app/contractor/[token]/[workOrderId]/page.tsx
   - Full work order details with all actions
   - Back to dashboard link
</tasks>

<verification>
- Contractor portal shows ALL work orders for contractor email
- Work orders grouped by action status
- 'Sent' status changes to 'viewed' when contractor opens dashboard
- viewed_at timestamp is set
- Completed work orders shown in collapsed section
- Invalid token shows request-link form
- Card click navigates to detail view
</verification>

<must_haves>
- Portal displays details and attachments for work order (EXT-06)
- Tracking: Viewed status set when magic link opened (EXT-13)
- Dashboard groups work orders by action status
- Status-aware token expiry (not time-based for active work orders)
</must_haves>
