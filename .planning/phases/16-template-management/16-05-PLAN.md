---
phase: 16-template-management
plan: 05
type: execute
wave: 1
depends_on: []
files_modified:
  - src/app/api/templates/route.ts
  - src/components/templates/TemplateCard.tsx
  - src/types/templates.ts
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Admin sees template list with phase count displayed on each card"
    - "Admin sees last modified date formatted and displayed on each card"
    - "Phase count is accurate (matches actual number of phases in template hierarchy)"
  artifacts:
    - path: "src/app/api/templates/route.ts"
      provides: "Template list endpoint with phase count"
      contains: "phase_count"
    - path: "src/components/templates/TemplateCard.tsx"
      provides: "Template card with phase count and updated_at display"
      contains: "phase_count"
    - path: "src/types/templates.ts"
      provides: "Template type with optional phase_count"
      exports: ["Template"]
  key_links:
    - from: "src/app/api/templates/route.ts"
      to: "template_phases table"
      via: "LEFT JOIN with COUNT"
      pattern: "COUNT.*template_phases"
    - from: "src/components/templates/TemplateCard.tsx"
      to: "template.phase_count"
      via: "conditional render"
      pattern: "template\\.phase_count"
    - from: "src/components/templates/TemplateCard.tsx"
      to: "template.updated_at"
      via: "date formatting"
      pattern: "template\\.updated_at"
---

<objective>
Display phase count and last modified date on template list cards

Purpose: Close verification gap from TMPL-01 success criterion requiring "name, phase count, and last modified date" on template list view
Output: Template cards show phase count (e.g., "3 Phasen") and formatted last modified date (e.g., "Aktualisiert: 24.01.2026")
</objective>

<execution_context>
@C:\Users\Mario Giacchino\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\Mario Giacchino\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@C:\Dev\KeWa-App\.planning\PROJECT.md
@C:\Dev\KeWa-App\.planning\ROADMAP.md
@C:\Dev\KeWa-App\.planning\STATE.md
@C:\Dev\KeWa-App\.planning\phases\16-template-management\16-VERIFICATION.md
@C:\Dev\KeWa-App\.planning\phases\16-template-management\16-CONTEXT.md
@C:\Dev\KeWa-App\src\app\api\templates\route.ts
@C:\Dev\KeWa-App\src\components\templates\TemplateCard.tsx
@C:\Dev\KeWa-App\src\types\templates.ts
</context>

<tasks>

<task type="auto">
  <name>Extend Template API to include phase count</name>
  <files>
    src/app/api/templates/route.ts
    src/types/templates.ts
  </files>
  <action>
**src/types/templates.ts:**
Add optional phase_count field to Template interface (line 51-64):
```typescript
export interface Template {
  id: string
  name: string
  description: string | null
  category: TemplateCategory
  scope: TemplateScope
  target_room_type: RoomType | null
  total_duration_days: number | null
  total_estimated_cost: number | null
  is_active: boolean
  created_by: string | null
  created_at: string
  updated_at: string
  phase_count?: number  // <-- Add this optional field
}
```

**src/app/api/templates/route.ts:**
Replace the simple select query (lines 35-49) with a query that includes phase count via LEFT JOIN:

```typescript
let query = supabase
  .from('templates')
  .select(`
    *,
    template_phases (
      id
    )
  `)
  .order('category')
  .order('name')
```

Then after fetching data (before return, line 51), transform the response to flatten phase count:

```typescript
const { data, error } = await query

if (error) {
  console.error('Error fetching templates:', error)
  return NextResponse.json({ error: error.message }, { status: 500 })
}

// Transform data to include phase_count
const templates = data.map((template: any) => ({
  ...template,
  phase_count: template.template_phases?.length || 0,
  template_phases: undefined  // Remove nested array from response
}))

return NextResponse.json({ templates })
```

**Rationale:** Using Supabase's nested select with transformation is more efficient than separate COUNT query. The template_phases relation already exists, so we SELECT just the ids (minimal data), count them client-side, then strip the nested array before returning.

**DO NOT** add phase_count to the database schema - it's derived from template_phases count, not stored.
  </action>
  <verify>
Manual check: `curl http://localhost:3000/api/templates` and verify response includes `phase_count: N` for each template
  </verify>
  <done>
GET /api/templates returns templates array with phase_count field populated for each template
  </done>
</task>

<task type="auto">
  <name>Display phase count and last modified date on TemplateCard</name>
  <files>src/components/templates/TemplateCard.tsx</files>
  <action>
Add phase count and last modified date display to TemplateCard component.

**Location:** Insert between the "Duration and cost info" section (lines 81-89) and the "Action buttons" section (line 92).

**Code to insert:**
```typescript
      {/* Phase count and last modified */}
      <div className="flex items-center gap-4 text-sm text-gray-500 mb-4">
        {typeof template.phase_count === 'number' && (
          <span>{template.phase_count} {template.phase_count === 1 ? 'Phase' : 'Phasen'}</span>
        )}
        {template.updated_at && (
          <span>
            Aktualisiert: {new Date(template.updated_at).toLocaleDateString('de-CH', {
              day: '2-digit',
              month: '2-digit',
              year: 'numeric'
            })}
          </span>
        )}
      </div>
```

**Placement:** This creates a new info row showing phase count and last modified date, styled consistently with the existing duration/cost info row above it.

**Conditional rendering:**
- Phase count only shown if phase_count field exists (API provides it)
- Last modified only shown if updated_at exists (always exists per Template schema)
- Singular "Phase" vs plural "Phasen" based on count

**Date formatting:** Swiss locale (de-CH) with DD.MM.YYYY format to match existing codebase patterns.
  </action>
  <verify>
Visit http://localhost:3000/templates and confirm each TemplateCard displays:
1. Phase count (e.g., "3 Phasen" or "1 Phase")
2. Last modified date (e.g., "Aktualisiert: 24.01.2026")
  </verify>
  <done>
Template list cards display phase count and formatted last modified date below duration/cost info
  </done>
</task>

</tasks>

<verification>
1. API returns phase_count for each template in list response
2. TemplateCard component renders phase count with correct singular/plural
3. TemplateCard component renders formatted last modified date
4. Phase count is accurate (matches actual phases in template hierarchy)
5. Date format follows Swiss locale (DD.MM.YYYY)
</verification>

<success_criteria>
TMPL-01 verification gap closed:
- [ ] Template list shows phase count on each card
- [ ] Template list shows last modified date on each card
- [ ] Phase count matches actual template_phases count
- [ ] Dates formatted in Swiss locale
- [ ] No performance degradation from API change
</success_criteria>

<output>
After completion, create `.planning/phases/16-template-management/16-05-SUMMARY.md`
</output>
