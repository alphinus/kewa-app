---
phase: 16-template-management
plan: 03
type: execute
wave: 2
depends_on: ["16-01"]
files_modified:
  - src/components/templates/TemplateEditor.tsx
  - src/app/api/templates/[id]/reorder/route.ts
autonomous: true

must_haves:
  truths:
    - "Admin can drag phases to reorder within template"
    - "Admin can drag packages to reorder within phase"
    - "Admin can drag tasks to reorder within package"
    - "Reordering updates sort_order in database"
  artifacts:
    - path: "src/components/templates/TemplateEditor.tsx"
      provides: "Drag-drop handlers for hierarchy items"
      contains: "onDragStart"
    - path: "src/app/api/templates/[id]/reorder/route.ts"
      provides: "Bulk sort_order update endpoint"
      exports: ["PATCH"]
  key_links:
    - from: "src/components/templates/TemplateEditor.tsx"
      to: "/api/templates/[id]/reorder"
      via: "PATCH on drop"
      pattern: "reorder"
---

<objective>
Add drag-and-drop reordering to template hierarchy editor.

Purpose: CONTEXT.md specifies drag-drop reordering within levels. TemplateEditor has CRUD but no reordering.
Output: Working drag-drop for phases, packages, and tasks with database persistence.
</objective>

<execution_context>
@C:\Users\Mario Giacchino\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\Mario Giacchino\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/16-template-management/16-CONTEXT.md
@.planning/phases/16-template-management/16-RESEARCH.md

# Existing editor to modify
@src/components/templates/TemplateEditor.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create reorder API endpoint</name>
  <files>src/app/api/templates/[id]/reorder/route.ts</files>
  <action>
    Create PATCH endpoint accepting:
    ```typescript
    {
      type: 'phase' | 'package' | 'task'
      items: Array<{ id: string; sort_order: number }>
    }
    ```

    Requires kewa role.

    Based on type, update sort_order for each item:
    - phase: UPDATE template_phases SET sort_order = ? WHERE id = ?
    - package: UPDATE template_packages SET sort_order = ? WHERE id = ?
    - task: UPDATE template_tasks SET sort_order = ? WHERE id = ?

    Use batch update pattern for efficiency.

    Return { success: true } on completion.

    Error handling:
    - 400 if type invalid or items empty
    - 500 on database error
  </action>
  <verify>PATCH /api/templates/[id]/reorder with items array updates sort_order values</verify>
  <done>Reorder endpoint accepts item array and updates sort_order in batch</done>
</task>

<task type="auto">
  <name>Task 2: Add drag-drop to TemplateEditor</name>
  <files>src/components/templates/TemplateEditor.tsx</files>
  <action>
    Add reorderItems function using lib/api/templates:
    ```typescript
    async function reorderItems(
      type: 'phase' | 'package' | 'task',
      items: Array<{ id: string; sort_order: number }>
    ) {
      const response = await fetch(`/api/templates/${template.id}/reorder`, {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ type, items })
      })
      if (!response.ok) throw new Error('Reorder failed')
    }
    ```

    In EditorTree component, add drag-drop handlers using HTML5 Drag API:

    1. Add dragging state: const [draggedItem, setDraggedItem] = useState<{type: string, id: string, parentId?: string} | null>(null)

    2. For phase rows, add:
    ```tsx
    draggable
    onDragStart={(e) => {
      e.dataTransfer.effectAllowed = 'move'
      setDraggedItem({ type: 'phase', id: phase.id })
    }}
    onDragOver={(e) => {
      if (draggedItem?.type === 'phase') {
        e.preventDefault()
        e.dataTransfer.dropEffect = 'move'
      }
    }}
    onDrop={async (e) => {
      if (draggedItem?.type !== 'phase') return
      e.preventDefault()
      // Reorder phases
      const draggedIndex = phases.findIndex(p => p.id === draggedItem.id)
      const dropIndex = phases.findIndex(p => p.id === phase.id)
      if (draggedIndex === dropIndex) return

      const reordered = [...phases]
      const [removed] = reordered.splice(draggedIndex, 1)
      reordered.splice(dropIndex, 0, removed)

      // Update sort_order
      const items = reordered.map((p, i) => ({ id: p.id, sort_order: i + 1 }))
      await reorderItems('phase', items)
      onUpdate?.()
      setDraggedItem(null)
    }}
    onDragEnd={() => setDraggedItem(null)}
    ```

    3. Same pattern for packages (only accept drops from same phase):
    - On dragStart: setDraggedItem({ type: 'package', id: pkg.id, parentId: phase.id })
    - On dragOver: only allow if draggedItem.type === 'package' && draggedItem.parentId === phase.id

    4. Same pattern for tasks (only accept drops from same package):
    - On dragStart: setDraggedItem({ type: 'task', id: task.id, parentId: pkg.id })
    - On dragOver: only allow if draggedItem.type === 'task' && draggedItem.parentId === pkg.id

    5. Add visual feedback:
    - cursor-grab on draggable items
    - cursor-grabbing while dragging
    - bg-blue-100 on valid drop target during dragover

    Pass reorderItems through props or lift state as needed.
  </action>
  <verify>
    Drag a phase, drop on another phase position - order changes
    Drag a package within same phase - order changes
    Drag a task within same package - order changes
    Cannot drag package to different phase
    Cannot drag task to different package
  </verify>
  <done>
    Drag-drop reordering works for phases, packages, tasks within their parent level
    Sort order persisted to database on drop
  </done>
</task>

</tasks>

<verification>
1. Phases can be reordered via drag-drop
2. Packages can be reordered within their phase
3. Tasks can be reordered within their package
4. Cross-parent drops are rejected (package can't move to different phase)
5. Database sort_order updated after each reorder
6. Page refresh shows persisted order
</verification>

<success_criteria>
- HTML5 drag-drop working for all three levels
- Reordering persists to database
- Visual feedback during drag
- Cross-parent drops blocked
</success_criteria>

<output>
After completion, create `.planning/phases/16-template-management/16-03-SUMMARY.md`
</output>
