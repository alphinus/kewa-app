---
phase: 16-template-management
plan: 04
type: execute
wave: 2
depends_on: ["16-01"]
files_modified:
  - src/app/dashboard/wohnungen/[id]/page.tsx
  - src/components/projects/ProjectCreateWithTemplate.tsx
  - src/app/api/projects/route.ts
autonomous: true

must_haves:
  truths:
    - "Admin can select template when creating new project"
    - "Template preview shows structure before creation"
    - "Project created with template has phases, packages, tasks from template"
  artifacts:
    - path: "src/components/projects/ProjectCreateWithTemplate.tsx"
      provides: "Template-first project creation component"
      min_lines: 150
  key_links:
    - from: "src/components/projects/ProjectCreateWithTemplate.tsx"
      to: "/api/templates"
      via: "fetchTemplates for selection"
      pattern: "fetchTemplates"
    - from: "src/components/projects/ProjectCreateWithTemplate.tsx"
      to: "/api/templates/[id]/apply"
      via: "applyTemplateToProject"
      pattern: "applyTemplateToProject"
---

<objective>
Integrate template selection into project creation flow.

Purpose: TMPL-05 requires "Project creation form shows template dropdown and applies selected template to new project". Per CONTEXT.md, template selection is first step with side-by-side preview.
Output: ProjectCreateWithTemplate component integrated into wohnungen detail page.
</objective>

<execution_context>
@C:\Users\Mario Giacchino\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\Mario Giacchino\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/16-template-management/16-CONTEXT.md
@.planning/phases/16-template-management/16-RESEARCH.md

# Existing wizard for reference
@src/components/templates/TemplateApplyWizard.tsx

# Target page for integration
@src/app/dashboard/wohnungen/[id]/page.tsx

# Template utilities
@src/lib/templates/apply.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ProjectCreateWithTemplate component</name>
  <files>src/components/projects/ProjectCreateWithTemplate.tsx</files>
  <action>
    Create component following CONTEXT.md decision (template-first with side-by-side preview):

    Props:
    ```typescript
    interface ProjectCreateWithTemplateProps {
      unitId: string
      unitName: string
      onSuccess?: (projectId: string) => void
      onCancel?: () => void
    }
    ```

    State:
    - templates: Template[]
    - selectedTemplateId: string | null
    - selectedTemplate: TemplateWithHierarchy | null
    - excludedTaskIds: Set<string>
    - projectName: string
    - startDate: string (default today)
    - loading, error states

    Layout (two-column per CONTEXT.md):
    ```tsx
    <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
      {/* Left: Template selection and project details */}
      <div className="space-y-4">
        <h3>1. Template waehlen</h3>
        <div className="space-y-2 max-h-64 overflow-y-auto">
          {templates.map(t => (
            <button
              key={t.id}
              onClick={() => setSelectedTemplateId(t.id)}
              className={`w-full p-3 border rounded text-left ${selectedTemplateId === t.id ? 'border-blue-500 bg-blue-50' : ''}`}
            >
              <div className="font-medium">{t.name}</div>
              <div className="text-sm text-gray-500">{t.category}</div>
            </button>
          ))}
        </div>

        {selectedTemplate && (
          <>
            <h3>2. Projektdetails</h3>
            <input
              value={projectName}
              onChange={...}
              placeholder="Projektname"
            />
            <input
              type="date"
              value={startDate}
              onChange={...}
            />
          </>
        )}
      </div>

      {/* Right: Template preview */}
      <div>
        {selectedTemplate && (
          <TemplatePreviewWithExclusion
            template={selectedTemplate}
            excludedTaskIds={excludedTaskIds}
            onToggleTask={(id) => toggleExclusion(id)}
          />
        )}
      </div>
    </div>
    ```

    TemplatePreviewWithExclusion shows WBS tree with checkboxes for optional tasks.

    Submit flow:
    1. Create project via POST /api/projects with { unit_id, name, status: 'active' }
    2. Apply template via applyTemplateToProject({ templateId, projectId, startDate, excludedTaskIds })
    3. Call onSuccess(projectId)

    Use fetchTemplates({ active: true }) for template list.
    Use fetchTemplate(id) when template selected to get hierarchy.
  </action>
  <verify>Component renders with template list, selecting shows preview, can customize optional tasks</verify>
  <done>ProjectCreateWithTemplate component created with two-column layout and preview</done>
</task>

<task type="auto">
  <name>Task 2: Integrate into wohnungen detail page</name>
  <files>src/app/dashboard/wohnungen/[id]/page.tsx</files>
  <action>
    In the wohnungen detail page, find where projects are listed or where "Neues Projekt" action would be.

    Add state for modal: const [showCreateProject, setShowCreateProject] = useState(false)

    Add button to open modal:
    ```tsx
    <button
      onClick={() => setShowCreateProject(true)}
      className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700"
    >
      + Neues Projekt
    </button>
    ```

    Add modal:
    ```tsx
    {showCreateProject && (
      <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
        <div className="bg-white rounded-lg max-w-4xl w-full max-h-[90vh] overflow-auto p-6">
          <div className="flex justify-between items-center mb-4">
            <h2 className="text-xl font-semibold">Neues Projekt erstellen</h2>
            <button onClick={() => setShowCreateProject(false)}>X</button>
          </div>
          <ProjectCreateWithTemplate
            unitId={unit.id}
            unitName={unit.name}
            onSuccess={(projectId) => {
              setShowCreateProject(false)
              router.push(`/dashboard/projekte/${projectId}`)
            }}
            onCancel={() => setShowCreateProject(false)}
          />
        </div>
      </div>
    )}
    ```

    Import ProjectCreateWithTemplate and useRouter.
  </action>
  <verify>Navigate to wohnungen detail, click "Neues Projekt", modal opens with template selection</verify>
  <done>Project creation with template integrated into wohnungen detail page</done>
</task>

<task type="auto">
  <name>Task 3: Create TemplatePreviewWithExclusion sub-component</name>
  <files>src/components/projects/ProjectCreateWithTemplate.tsx</files>
  <action>
    Add TemplatePreviewWithExclusion as internal component (or separate file if too large):

    ```typescript
    interface TemplatePreviewWithExclusionProps {
      template: TemplateWithHierarchy
      excludedTaskIds: Set<string>
      onToggleTask: (taskId: string) => void
    }

    function TemplatePreviewWithExclusion({ template, excludedTaskIds, onToggleTask }: TemplatePreviewWithExclusionProps) {
      const metrics = calculateTemplateMetrics(template, excludedTaskIds)
      const optionalTasks = getOptionalTasks(template)

      return (
        <div className="space-y-4">
          {/* Metrics summary */}
          <div className="grid grid-cols-3 gap-2 text-center">
            <div className="bg-gray-50 p-2 rounded">
              <div className="font-bold">{template.phases.length}</div>
              <div className="text-xs text-gray-500">Phasen</div>
            </div>
            <div className="bg-gray-50 p-2 rounded">
              <div className="font-bold">{metrics.taskCount}</div>
              <div className="text-xs text-gray-500">Aufgaben</div>
            </div>
            <div className="bg-gray-50 p-2 rounded">
              <div className="font-bold">{metrics.totalDays}</div>
              <div className="text-xs text-gray-500">Tage</div>
            </div>
          </div>

          {/* Optional tasks toggle */}
          {optionalTasks.length > 0 && (
            <div className="border rounded p-3">
              <h4 className="font-medium mb-2">Optionale Aufgaben</h4>
              <div className="space-y-2 max-h-40 overflow-y-auto">
                {optionalTasks.map(task => (
                  <label key={task.id} className="flex items-center gap-2 text-sm">
                    <input
                      type="checkbox"
                      checked={!excludedTaskIds.has(task.id)}
                      onChange={() => onToggleTask(task.id)}
                    />
                    <span className={excludedTaskIds.has(task.id) ? 'text-gray-400' : ''}>
                      {task.wbs_code} {task.name}
                    </span>
                  </label>
                ))}
              </div>
            </div>
          )}

          {/* Collapsed WBS preview */}
          <div className="border rounded p-3 max-h-60 overflow-y-auto">
            <h4 className="font-medium mb-2">Struktur</h4>
            {template.phases.map(phase => (
              <div key={phase.id} className="text-sm">
                <div className="font-medium">{phase.wbs_code} {phase.name}</div>
                <div className="ml-4 text-gray-600">
                  {phase.packages.length} Pakete, {phase.packages.reduce((sum, p) => sum + p.tasks.length, 0)} Aufgaben
                </div>
              </div>
            ))}
          </div>
        </div>
      )
    }
    ```

    Import calculateTemplateMetrics, getOptionalTasks from @/lib/templates/apply.
  </action>
  <verify>Preview shows metrics, optional task toggles, and collapsed structure</verify>
  <done>Template preview component shows metrics and allows optional task customization</done>
</task>

</tasks>

<verification>
1. "Neues Projekt" button appears on wohnungen detail page
2. Clicking opens modal with template selection
3. Selecting template shows preview with metrics and optional tasks
4. Can toggle optional tasks on/off
5. Entering project name and clicking create:
   - Creates project
   - Applies template
   - Redirects to project page
6. Created project has phases, packages, tasks from template
</verification>

<success_criteria>
- Template-first project creation flow working
- Side-by-side preview with optional task customization
- Projects created from templates have full WBS structure
- Integrated into wohnungen detail page
</success_criteria>

<output>
After completion, create `.planning/phases/16-template-management/16-04-SUMMARY.md`
</output>
