---
phase: 36-data-migration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/079_hauswart_role.sql
  - supabase/migrations/080_seed_organizations.sql
autonomous: true
requirements: [MIGR-01]

must_haves:
  truths:
    - "Organization 'KeWa AG' exists with slug 'kewa-ag' and UUID 00000000-0000-0000-0010-000000000001"
    - "Organization 'GIMBA AG' exists with slug 'gimba-ag' and UUID 00000000-0000-0000-0010-000000000002"
    - "3 KEWA AG owners exist: KeWa AG (company), Erbengemeinschaft Brunner (community), Pensionskasse Zuerich (company)"
    - "1 GIMBA AG owner exists: Graber Immobilien GmbH (company)"
    - "4 mandates exist: Eigenverwaltung KEWA, Mandat Brunner, STWE Pensionskasse ZH, Verwaltung Graber"
    - "All users from D5 matrix exist with correct role_id and auth_method"
    - "All users have organization_members rows with correct org assignment and is_default=true"
    - "Cross-org users (Mario Giacchino, Thomas Wyss) have 2 org_members rows each"
    - "hauswart role exists with 12 permissions (no financial access)"
    - "Imeri (ID ...0002) has role_id pointing to hauswart"
  artifacts:
    - path: "supabase/migrations/079_hauswart_role.sql"
      provides: "hauswart ENUM value, role record, missing permissions, role_permissions assignment"
      contains: "ALTER TYPE user_role ADD VALUE IF NOT EXISTS 'hauswart'"
    - path: "supabase/migrations/080_seed_organizations.sql"
      provides: "Organizations, owners, mandates, users, organization_members seed data"
      contains: "kewa-ag"
  key_links:
    - from: "080_seed_organizations.sql"
      to: "organizations table"
      via: "INSERT with deterministic UUIDs"
      pattern: "00000000-0000-0000-0010-000000000001"
    - from: "080_seed_organizations.sql"
      to: "organization_members table"
      via: "INSERT mapping users to orgs"
      pattern: "organization_members"
    - from: "079_hauswart_role.sql"
      to: "roles + role_permissions tables"
      via: "INSERT role + permission mapping"
      pattern: "hauswart"
---

<objective>
Seed the hauswart role with permissions, then seed all organizations, owners, mandates, users, and organization_members for the multi-tenant showcase.

Purpose: Establishes the master data foundation (orgs, owners, mandates, users) that all property/building/unit seeding and backfill depends on. The hauswart role must exist before users referencing it can be inserted.

Output: Two migration files (079, 080) creating the hauswart role and all master entity seed data for both KEWA AG and GIMBA AG organizations.
</objective>

<execution_context>
@C:/Users/Mario Giacchino/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Mario Giacchino/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/36-data-migration/36-CONTEXT.md
@.planning/phases/36-data-migration/36-RESEARCH.md
@supabase/migrations/073_org_foundation.sql
@supabase/migrations/022_rbac.sql
@supabase/migrations/023_users_auth.sql
@supabase/migrations/063_seed_tenant_portal.sql
@supabase/migrations/002_set_pin_hashes.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create 079_hauswart_role.sql — ENUM extension, missing permissions, role record, role_permissions</name>
  <files>supabase/migrations/079_hauswart_role.sql</files>
  <action>
Create migration file `079_hauswart_role.sql` with these operations in order:

**Step 1: Add hauswart ENUM value (D9)**
```sql
ALTER TYPE user_role ADD VALUE IF NOT EXISTS 'hauswart';
```
This MUST be at the top level, NOT inside a BEGIN/COMMIT block (PostgreSQL restriction on ADD VALUE).

**Step 2: Insert missing permissions that hauswart needs**
The permissions table (from 022_rbac.sql) is missing these codes that hauswart requires:
- `buildings:read` — resource: buildings, action: read
- `rooms:read` — resource: rooms, action: read
- `inspections:read` — resource: inspections, action: read
- `inspections:create` — resource: inspections, action: create
- `inspections:update` — resource: inspections, action: update

Use the same column pattern as 022_rbac.sql: `(code, name, resource, action, description)`. Use `ON CONFLICT (code) DO NOTHING` for idempotency.

**Step 3: Insert hauswart role record**
```sql
INSERT INTO roles (name, display_name, description, is_internal) VALUES
  ('hauswart', 'Hauswart', 'Gebaeudeunterhalt, Inspektionen und Meldungen', true)
ON CONFLICT (name) DO NOTHING;
```

**Step 4: Assign permissions to hauswart**
Use a cross-join SELECT pattern (same as 022_rbac.sql role_permissions seed):
```sql
INSERT INTO role_permissions (role_id, permission_id)
SELECT r.id, p.id
FROM roles r, permissions p
WHERE r.name = 'hauswart'
  AND p.code IN (
    'properties:read', 'buildings:read', 'units:read', 'rooms:read',
    'tasks:read', 'tasks:create', 'tasks:update',
    'work_orders:read',
    'inspections:read', 'inspections:create', 'inspections:update',
    'tickets:read', 'tickets:update'
  )
ON CONFLICT (role_id, permission_id) DO NOTHING;
```

These are 13 permission codes. hauswart explicitly gets NO access to: costs, invoices, payments, reports, settings, users (D9).

Add a standard migration header comment:
```
-- KEWA v4.0: Multi-Tenant Data Migration
-- Migration: 079_hauswart_role.sql
-- Creates: hauswart ENUM value, missing permissions, role record, role_permissions
-- Requirements: D9 (hauswart role)
-- Phase 36: Data Migration & Backfill
```
  </action>
  <verify>
Run against local Supabase:
```bash
npx supabase db reset
```
Then verify:
```sql
SELECT * FROM roles WHERE name = 'hauswart';
SELECT count(*) FROM role_permissions WHERE role_id = (SELECT id FROM roles WHERE name = 'hauswart');
-- Expected: 13 permissions
SELECT p.code FROM role_permissions rp JOIN permissions p ON p.id = rp.permission_id JOIN roles r ON r.id = rp.role_id WHERE r.name = 'hauswart' ORDER BY p.code;
-- Should NOT include any costs:*, invoices:*, payments:*, reports:*, settings:*, users:* codes
```
  </verify>
  <done>hauswart ENUM value exists in user_role type. Role record exists with is_internal=true. 13 permissions assigned (properties:read, buildings:read, units:read, rooms:read, tasks:read/create/update, work_orders:read, inspections:read/create/update, tickets:read/update). No financial permissions.</done>
</task>

<task type="auto">
  <name>Task 2: Create 080_seed_organizations.sql — orgs, owners, mandates, users, org_members</name>
  <files>supabase/migrations/080_seed_organizations.sql</files>
  <action>
Create migration file `080_seed_organizations.sql` with these operations in order. All INSERTs use `ON CONFLICT (id) DO NOTHING` or appropriate unique column for idempotency.

Add standard migration header:
```
-- KEWA v4.0: Multi-Tenant Data Migration
-- Migration: 080_seed_organizations.sql
-- Creates: Organizations, owners, mandates, users, organization_members seed data
-- Requirements: MIGR-01
-- Phase 36: Data Migration & Backfill
```

**UUID Namespace (from RESEARCH.md):**
- `0010` = Organizations
- `0011` = Owners
- `0012` = Mandates
- `0020` = New users

Use the `0010` namespace for organizations per research recommendation (avoids collision with existing buildings UUID `0001` namespace).

**SECTION 1: Organizations (D1, D2)**

Insert KEWA AG:
- id: `00000000-0000-0000-0010-000000000001`
- name: `KeWa AG`
- slug: `kewa-ag`
- uid: `CHE-135.108.414`
- commercial_register: `CH-130.3.026.656-4`
- country: `CH`
- is_active: true

Insert GIMBA AG:
- id: `00000000-0000-0000-0010-000000000002`
- name: `GIMBA AG`
- slug: `gimba-ag`
- uid: `CHE-217.838.550`
- commercial_register: `CH-290.3.020.028-0`
- country: `CH`
- is_active: true

**SECTION 2: Owners (D3)**

KEWA AG owners:
1. KeWa AG as owner (Eigenverwaltung):
   - id: `00000000-0000-0000-0011-000000000001`
   - organization_id: KEWA AG UUID
   - owner_type: `company`
   - name: `KeWa AG`
   - address: `Rietbrunnen 42`
   - postal_code: `8808`
   - city: `Pfaeffikon SZ`
   - country: `CH`

2. Erbengemeinschaft Brunner (Drittverwaltung):
   - id: `00000000-0000-0000-0011-000000000002`
   - organization_id: KEWA AG UUID
   - owner_type: `community`
   - name: `Erbengemeinschaft Brunner`
   - address: `Muehlegasse 12`
   - postal_code: `8001`
   - city: `Zuerich`
   - phone: `+41 44 211 33 44`
   - email: `fritz.brunner@bluewin.ch`
   - user_id: will be set to Fritz Brunner user (see users section)

3. Pensionskasse Zuerich:
   - id: `00000000-0000-0000-0011-000000000003`
   - organization_id: KEWA AG UUID
   - owner_type: `company`
   - name: `Pensionskasse Stadt Zuerich`
   - address: `Stadthausquai 17`
   - postal_code: `8001`
   - city: `Zuerich`
   - user_id: NULL (institutional, no portal login per D3)

GIMBA AG owner:
4. Graber Immobilien GmbH:
   - id: `00000000-0000-0000-0011-000000000004`
   - organization_id: GIMBA AG UUID
   - owner_type: `company`
   - name: `Graber Immobilien GmbH`
   - address: `Hauptstrasse 15`
   - postal_code: `8455`
   - city: `Ruedlingen`

**SECTION 3: Mandates (D3)**

All mandates: `start_date = '2024-01-01'`, `end_date = NULL`, `is_active = true`.

1. Eigenverwaltung KEWA:
   - id: `00000000-0000-0000-0012-000000000001`
   - organization_id: KEWA AG UUID
   - owner_id: KeWa AG owner UUID (`0011-...001`)
   - name: `Eigenverwaltung KEWA`
   - mandate_type: `rental`

2. Mandat Brunner:
   - id: `00000000-0000-0000-0012-000000000002`
   - organization_id: KEWA AG UUID
   - owner_id: Erbengemeinschaft Brunner UUID (`0011-...002`)
   - name: `Mandat Brunner`
   - mandate_type: `rental`

3. STWE Pensionskasse ZH:
   - id: `00000000-0000-0000-0012-000000000003`
   - organization_id: KEWA AG UUID
   - owner_id: Pensionskasse Zuerich UUID (`0011-...003`)
   - name: `STWE Pensionskasse ZH`
   - mandate_type: `stwe`

4. Verwaltung Graber:
   - id: `00000000-0000-0000-0012-000000000004`
   - organization_id: GIMBA AG UUID
   - owner_id: Graber Immobilien GmbH UUID (`0011-...004`)
   - name: `Verwaltung Graber`
   - mandate_type: `rental`

**SECTION 4: Users (D5)**

Use bcrypt hash `$2b$10$mZk/6eWmIPwvfwz/jkaBceGz2/l6YqX.KPI.FNGWZSMqOFIjsHXi2` for all PIN and password hashes (same as 063_seed_tenant_portal.sql, hash of 'test1234').

All new users get `role = 'kewa'` for the legacy NOT NULL column (Pitfall 2 from RESEARCH.md).

**Handle existing user "KEWA AG" (ID ...0001):** Rename display_name to "Rolf Kaelin" and update role_id to admin. This reuses the existing user rather than creating a new one, preserving any FK references.

```sql
-- Rename existing "KEWA AG" user to Rolf Kaelin
UPDATE users SET
  display_name = 'Rolf Kaelin',
  role_id = (SELECT id FROM roles WHERE name = 'admin')
WHERE id = '00000000-0000-0000-0000-000000000001';
```

**Update existing user Imeri (D5) — change role to hauswart:**
```sql
UPDATE users SET
  role_id = (SELECT id FROM roles WHERE name = 'hauswart')
WHERE id = '00000000-0000-0000-0000-000000000002';
```

**New KEWA AG users:**

| UUID (0020 namespace) | Name | role_id lookup | auth_method | email |
|---|---|---|---|---|
| `...0020-...001` | Flurina Kaelin | admin | pin | NULL |
| `...0020-...002` | Sandra Keller | accounting | email_password | sandra.keller@kewa.ch |
| `...0020-...003` | Beat Steiner | hauswart | pin | NULL |
| `...0020-...004` | Fritz Brunner | tenant | email_password | fritz.brunner@bluewin.ch |

Fritz Brunner gets a user account for the prepared owner-login FK (D5). Create user first, then UPDATE owners SET user_id for Erbengemeinschaft Brunner.

**New GIMBA AG users:**

| UUID (0020 namespace) | Name | role_id lookup | auth_method | email |
|---|---|---|---|---|
| `...0020-...005` | Simon Graber | admin | pin | NULL |
| `...0020-...006` | Lisa Meier | property_manager | email_password | lisa.meier@gimba.ch |
| `...0020-...007` | Markus Huber | tenant | email_password | markus.huber@example.com |
| `...0020-...008` | Paolo Rossi | external_contractor | pin | NULL |

**Cross-org users:**

| UUID (0020 namespace) | Name | role_id lookup | auth_method | email |
|---|---|---|---|---|
| `...0020-...009` | Mario Giacchino | external_contractor | pin | NULL |
| `...0020-...010` | Thomas Wyss | property_manager | email_password | thomas.wyss@treuhand.ch |

All PIN users: set `pin_hash` to the bcrypt placeholder, `password_hash = NULL`, `email = NULL` (unless specified), `email_verified = false`.
All email_password users: set `pin_hash` to the bcrypt placeholder (pin_hash is NOT NULL), `password_hash` to the same bcrypt hash, `email_verified = true`.

All users: `is_active = true`.

**SECTION 5: Update owner user_id FK**

After Fritz Brunner user is inserted:
```sql
UPDATE owners SET user_id = '00000000-0000-0000-0020-000000000004'
WHERE id = '00000000-0000-0000-0011-000000000002';  -- Erbengemeinschaft Brunner
```

**SECTION 6: Organization Members (MIGR-01 acceptance)**

Map ALL users to their organization(s) with correct role_id and `is_default = true`.

KEWA AG members (organization_id = `0010-...001`):
- Rolf Kaelin (`0000-...001`) — role: admin, is_default: true
- Imeri (`0000-...002`) — role: hauswart, is_default: true
- Flurina Kaelin (`0020-...001`) — role: admin, is_default: true
- Sandra Keller (`0020-...002`) — role: accounting, is_default: true
- Beat Steiner (`0020-...003`) — role: hauswart, is_default: true
- Fritz Brunner (`0020-...004`) — role: tenant, is_default: true
- Mario Giacchino (`0020-...009`) — role: external_contractor, is_default: true
- Thomas Wyss (`0020-...010`) — role: property_manager, is_default: true

Also map existing tenant users from 063_seed_tenant_portal.sql by email lookup:
- Hans Mueller (mueller@example.com) — role: tenant, is_default: true
- Anna Schmidt (schmidt@example.com) — role: tenant, is_default: true
- Peter Weber (weber@example.com) — role: tenant, is_default: true

GIMBA AG members (organization_id = `0010-...002`):
- Simon Graber (`0020-...005`) — role: admin, is_default: true
- Lisa Meier (`0020-...006`) — role: property_manager, is_default: true
- Markus Huber (`0020-...007`) — role: tenant, is_default: true
- Paolo Rossi (`0020-...008`) — role: external_contractor, is_default: true
- Mario Giacchino (`0020-...009`) — role: external_contractor, is_default: false (KEWA is default)
- Thomas Wyss (`0020-...010`) — role: property_manager, is_default: false (KEWA is default)

Use `ON CONFLICT (organization_id, user_id) DO NOTHING` on all org_members inserts.

For the tenant email lookups, use:
```sql
INSERT INTO organization_members (organization_id, user_id, role_id, is_default)
SELECT '00000000-0000-0000-0010-000000000001', u.id,
  (SELECT id FROM roles WHERE name = 'tenant'), true
FROM users u WHERE u.email = 'mueller@example.com'
ON CONFLICT (organization_id, user_id) DO NOTHING;
```
  </action>
  <verify>
Run `npx supabase db reset` and verify:
```sql
-- Organizations
SELECT name, slug FROM organizations ORDER BY name;
-- Expected: GIMBA AG, KeWa AG

-- Owners
SELECT o.name, o.owner_type, org.name as org FROM owners o JOIN organizations org ON org.id = o.organization_id ORDER BY o.name;
-- Expected: 4 owners

-- Mandates
SELECT m.name, m.mandate_type, org.name as org FROM mandates m JOIN organizations org ON org.id = m.organization_id ORDER BY m.name;
-- Expected: 4 mandates

-- Users count
SELECT count(*) FROM users;
-- Expected: original users + 10 new users

-- Org members
SELECT org.name, u.display_name, r.name as role, om.is_default
FROM organization_members om
JOIN organizations org ON org.id = om.organization_id
JOIN users u ON u.id = om.user_id
JOIN roles r ON r.id = om.role_id
ORDER BY org.name, u.display_name;
-- Expected: 11 KEWA rows, 6 GIMBA rows (Mario + Thomas appear in both)

-- Cross-org verification
SELECT u.display_name, count(*) as org_count
FROM organization_members om JOIN users u ON u.id = om.user_id
GROUP BY u.display_name HAVING count(*) > 1;
-- Expected: Mario Giacchino (2), Thomas Wyss (2)
```
  </verify>
  <done>Both organizations exist with real Handelsregister data. All 4 owners mapped correctly. All 4 mandates active with start_date 2024-01-01. All D5 users created with correct roles. All organization_members rows present including cross-org users with dual membership. Imeri's role updated to hauswart. Fritz Brunner user_id FK set on Erbengemeinschaft Brunner owner.</done>
</task>

</tasks>

<verification>
```sql
-- Comprehensive verification
-- 1. Organizations
SELECT count(*) FROM organizations; -- Expected: 2

-- 2. Owners with org assignment
SELECT count(*) FROM owners; -- Expected: 4

-- 3. Mandates with owner chain
SELECT m.name, o.name as owner, org.name as org
FROM mandates m
JOIN owners o ON o.id = m.owner_id
JOIN organizations org ON org.id = m.organization_id;
-- Expected: 4 rows, correct owner-org chain

-- 4. Organization members
SELECT count(*) FROM organization_members; -- Expected: 17

-- 5. Hauswart role and permissions
SELECT count(*) FROM role_permissions
WHERE role_id = (SELECT id FROM roles WHERE name = 'hauswart');
-- Expected: 13
```
</verification>

<success_criteria>
- 079_hauswart_role.sql and 080_seed_organizations.sql apply cleanly on `supabase db reset`
- 2 organizations, 4 owners, 4 mandates, all D5 users, 17 organization_members rows exist
- hauswart role has exactly 13 permissions (no financial access)
- Cross-org users appear in 2 organizations
- Migration is idempotent (can run twice without errors)
</success_criteria>

<output>
After completion, create `.planning/phases/36-data-migration/36-01-SUMMARY.md`
</output>
