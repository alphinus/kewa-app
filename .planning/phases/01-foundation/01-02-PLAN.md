---
phase: 01-foundation
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - package.json
  - src/app/api/auth/login/route.ts
  - src/app/api/auth/logout/route.ts
  - src/app/api/auth/session/route.ts
  - src/lib/auth.ts
  - src/middleware.ts
  - src/app/login/page.tsx
autonomous: true

must_haves:
  truths:
    - "User kann sich mit korrektem PIN anmelden"
    - "Falscher PIN zeigt Fehlermeldung"
    - "Session bleibt nach Browser-Refresh aktiv"
    - "Session läuft nach 7 Tagen ab"
    - "Logout löscht Session zuverlässig"
  artifacts:
    - path: "src/app/api/auth/login/route.ts"
      provides: "PIN validation endpoint"
      exports: ["POST"]
    - path: "src/lib/auth.ts"
      provides: "Auth utilities"
      exports: ["verifyPin", "createSession", "getSession"]
    - path: "src/middleware.ts"
      provides: "Route protection"
      contains: "matcher"
    - path: "src/app/login/page.tsx"
      provides: "Login UI"
      min_lines: 30
  key_links:
    - from: "src/app/api/auth/login/route.ts"
      to: "src/lib/auth.ts"
      via: "imports verifyPin, createSession"
    - from: "src/middleware.ts"
      to: "src/lib/auth.ts"
      via: "imports getSession"
    - from: "src/app/login/page.tsx"
      to: "/api/auth/login"
      via: "fetch POST on submit"
---

<objective>
Implement PIN-based authentication with persistent sessions.

Purpose: Enable KEWA AG and Imeri to log in with their respective PINs and maintain sessions.
Output: Working login flow with 7-day session cookies, role-based access, and route protection.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation/01-01-SUMMARY.md

@src/lib/supabase/server.ts
@supabase/migrations/001_initial_schema.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create auth utilities with PIN verification</name>
  <files>package.json, src/lib/auth.ts</files>
  <action>
    Install bcrypt for PIN hashing:
    - npm install bcryptjs
    - npm install -D @types/bcryptjs

    Create src/lib/auth.ts with:

    **hashPin(pin: string): Promise&lt;string&gt;**
    - Use bcrypt.hash with cost factor 10
    - For generating initial PIN hashes

    **verifyPin(pin: string, hash: string): Promise&lt;boolean&gt;**
    - Use bcrypt.compare
    - Returns true if PIN matches hash

    **createSession(userId: string, role: string): string**
    - Create JWT-like token with jose library (already in Next.js)
    - Payload: { userId, role, exp: 7 days }
    - Sign with process.env.SESSION_SECRET
    - Return base64 encoded token

    **getSession(token: string): { userId: string, role: 'kewa' | 'imeri' } | null**
    - Verify and decode token
    - Return null if expired or invalid
    - Return user info if valid

    Add SESSION_SECRET to .env.local and .env.example

    Note: Use jose library (built into Next.js Edge runtime) instead of jsonwebtoken.
  </action>
  <verify>npm run build succeeds, auth.ts exports all functions</verify>
  <done>Auth utilities ready for PIN verification and session management</done>
</task>

<task type="auto">
  <name>Task 2: Create login/logout API routes</name>
  <files>src/app/api/auth/login/route.ts, src/app/api/auth/logout/route.ts, src/app/api/auth/session/route.ts</files>
  <action>
    Create POST /api/auth/login:
    - Accept JSON body: { pin: string }
    - Query users table for matching PIN hash
    - Use verifyPin to compare
    - If match: createSession, set httpOnly cookie (7 days, SameSite=Lax)
    - Return { success: true, role: 'kewa' | 'imeri' }
    - If no match: return 401 { error: 'Ungültiger PIN' }

    Create POST /api/auth/logout:
    - Clear session cookie (set empty value, maxAge: 0)
    - Return { success: true }

    Create GET /api/auth/session:
    - Read session cookie
    - Validate with getSession
    - Return { authenticated: true, role } or { authenticated: false }

    Cookie settings:
    - Name: 'session'
    - httpOnly: true (prevents XSS)
    - secure: process.env.NODE_ENV === 'production'
    - sameSite: 'lax'
    - maxAge: 60 * 60 * 24 * 7 (7 days)
    - path: '/'
  </action>
  <verify>curl -X POST /api/auth/login with valid PIN returns 200 with Set-Cookie header</verify>
  <done>Login, logout, and session check endpoints working</done>
</task>

<task type="auto">
  <name>Task 3: Create middleware for route protection and login page</name>
  <files>src/middleware.ts, src/app/login/page.tsx</files>
  <action>
    Create src/middleware.ts:
    - Protect routes matching /dashboard/* and /api/* (except /api/auth/*)
    - Read session cookie, validate with getSession
    - If no valid session: redirect to /login
    - If valid session: continue (NextResponse.next())
    - Pass role to request headers for downstream use

    Export config with matcher:
    ```typescript
    export const config = {
      matcher: ['/dashboard/:path*', '/api/((?!auth).*)']
    }
    ```

    Create src/app/login/page.tsx:
    - Simple centered login form
    - 4-digit PIN input (type="password", inputMode="numeric")
    - Submit button
    - Error message display for invalid PIN
    - On success: redirect to /dashboard
    - Mobile-friendly: large touch targets (min 48px height)
    - Use Tailwind for styling

    Use client-side fetch to POST to /api/auth/login.
    Use useRouter for redirect after successful login.
  </action>
  <verify>Accessing /dashboard without session redirects to /login, valid PIN login redirects to /dashboard</verify>
  <done>Route protection active, login page functional</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] npm run build succeeds
- [ ] POST /api/auth/login with correct PIN returns 200 + session cookie
- [ ] POST /api/auth/login with wrong PIN returns 401
- [ ] GET /api/auth/session with valid cookie returns authenticated: true
- [ ] Accessing /dashboard without session redirects to /login
- [ ] Login form accepts PIN and redirects on success
- [ ] Session persists after browser refresh (check cookie in DevTools)
</verification>

<success_criteria>
- PIN authentication working for both KEWA AG and Imeri
- 7-day session cookies set correctly
- Route protection via middleware active
- Login page is mobile-friendly with large touch targets
- Logout clears session completely
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-02-SUMMARY.md`
</output>
