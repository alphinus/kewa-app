---
phase: 06-reports-advanced
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/tasks/TaskForm.tsx
  - src/app/api/tasks/[id]/route.ts
  - src/app/api/tasks/recurring/route.ts
  - src/types/database.ts
autonomous: true
user_setup: []

must_haves:
  truths:
    - "KEWA can create a task with recurring_type weekly or monthly"
    - "When recurring task is completed, a new instance is automatically created with next due date"
    - "Recurring tasks show indicator in task list"
    - "Recurring due date is calculated correctly (weekly=+7 days, monthly=+1 month)"
  artifacts:
    - path: "src/components/tasks/TaskForm.tsx"
      provides: "Recurring type selector UI"
      contains: "recurring"
    - path: "src/app/api/tasks/recurring/route.ts"
      provides: "Automatic recurring task creation endpoint"
      exports: ["POST"]
  key_links:
    - from: "src/app/api/tasks/[id]/route.ts"
      to: "/api/tasks/recurring"
      via: "POST call on task completion"
      pattern: "fetch.*api/tasks/recurring"
---

<objective>
Implement recurring task functionality for KEWA AG.

Purpose: Allow KEWA to create weekly/monthly recurring tasks (e.g., weekly cleaning, monthly inspections). When Imeri completes a recurring task, a new instance is automatically created with the next due date.

Output: TaskForm with recurring selector, automatic task regeneration on completion.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@src/types/database.ts
@src/components/tasks/TaskForm.tsx
@src/app/api/tasks/[id]/route.ts
@src/app/api/tasks/route.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add recurring type selector to TaskForm</name>
  <files>src/components/tasks/TaskForm.tsx</files>
  <action>
Add a recurring type select field to TaskForm.tsx:
1. Add state: `const [recurringType, setRecurringType] = useState(task?.recurring_type || 'none')`
2. Add options: `{ value: 'none', label: 'Einmalig' }, { value: 'weekly', label: 'Woechentlich' }, { value: 'monthly', label: 'Monatlich' }`
3. Add select field after priority selector with label "Wiederholung"
4. Include recurring_type in CreateTaskInput (create mode)
5. Include recurring_type in UpdateTaskInput (edit mode)
6. Only show for KEWA role (pass role as prop or check session)
7. Style consistent with existing priority selector (48px touch target)
  </action>
  <verify>npm run build succeeds, form displays recurring selector</verify>
  <done>TaskForm includes recurring type selector for KEWA</done>
</task>

<task type="auto">
  <name>Task 2: Create recurring task generation endpoint</name>
  <files>src/app/api/tasks/recurring/route.ts</files>
  <action>
Create POST /api/tasks/recurring endpoint:
1. Accept: { completed_task_id: string }
2. Fetch the completed task with project info
3. Verify task has recurring_type !== 'none'
4. Calculate next due date:
   - weekly: add 7 days to original due_date (or completed_at if no due_date)
   - monthly: add 1 month to original due_date (or completed_at if no due_date)
5. Create new task copying: project_id, title, description, priority, recurring_type
6. Set status='open', new due_date, clear completion fields
7. Return the new task
8. Handle edge cases: task not found, not recurring, already has successor
9. Add parent_task_id column consideration (optional, for tracking lineage)
  </action>
  <verify>curl -X POST /api/tasks/recurring with test task_id creates successor</verify>
  <done>Recurring endpoint creates next task instance</done>
</task>

<task type="auto">
  <name>Task 3: Trigger recurring task creation on completion</name>
  <files>src/app/api/tasks/[id]/route.ts</files>
  <action>
Modify PUT /api/tasks/[id] to trigger recurring task creation:
1. After successful status change to 'completed', check if recurring_type !== 'none'
2. If recurring, make internal call to POST /api/tasks/recurring with the task id
3. Fire and forget (don't block response on recurring task creation)
4. Log any errors but don't fail the completion
5. Consider adding recurring_next_task_id to track the successor (optional)
  </action>
  <verify>Complete a recurring task, verify new task appears with correct due date</verify>
  <done>Completing recurring task auto-creates next instance</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] npm run build succeeds
- [ ] TaskForm shows recurring selector (KEWA only)
- [ ] Creating task with weekly recurring works
- [ ] Completing weekly task creates new task with +7 days due date
- [ ] Completing monthly task creates new task with +1 month due date
- [ ] Non-recurring tasks complete without creating successor
</verification>

<success_criteria>
- All tasks completed
- KEWA can create recurring tasks
- Recurring tasks auto-regenerate on completion
- Due dates calculate correctly
</success_criteria>

<output>
After completion, create `.planning/phases/06-reports-advanced/06-01-SUMMARY.md`
</output>
