---
phase: 06-reports-advanced
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/app/api/reports/weekly/route.ts
  - src/app/dashboard/berichte/page.tsx
  - src/components/reports/WeeklyReport.tsx
  - src/components/navigation/mobile-nav.tsx
autonomous: false
user_setup: []

must_haves:
  truths:
    - "KEWA can view weekly report showing tasks completed in past 7 days"
    - "Report includes task title, unit, completion date, completion note"
    - "Report shows before/after photos for documented tasks"
    - "Report is organized by unit/project"
    - "KEWA can select different week ranges"
  artifacts:
    - path: "src/app/api/reports/weekly/route.ts"
      provides: "Weekly report data aggregation"
      exports: ["GET"]
    - path: "src/app/dashboard/berichte/page.tsx"
      provides: "Reports page with weekly summary"
      min_lines: 50
    - path: "src/components/reports/WeeklyReport.tsx"
      provides: "Report display component"
      min_lines: 80
  key_links:
    - from: "src/app/dashboard/berichte/page.tsx"
      to: "/api/reports/weekly"
      via: "fetch for report data"
      pattern: "fetch.*api/reports/weekly"
    - from: "src/components/reports/WeeklyReport.tsx"
      to: "TaskPhotoWithUrl"
      via: "photo display"
      pattern: "TaskPhotoWithUrl|photo"
---

<objective>
Implement weekly report generation for KEWA AG.

Purpose: Give KEWA AG a summary view of all work completed in the past week, including photos and timestamps. This is the primary accountability feature - proving what work Imeri has done.

Output: /dashboard/berichte page with weekly report showing completed tasks, photos, and notes.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
@~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@src/app/api/tasks/route.ts
@src/app/api/photos/route.ts
@src/types/database.ts
@src/components/navigation/mobile-nav.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create weekly report API endpoint</name>
  <files>src/app/api/reports/weekly/route.ts</files>
  <action>
Create GET /api/reports/weekly endpoint:
1. Accept query params: ?start_date=YYYY-MM-DD&end_date=YYYY-MM-DD (default: last 7 days)
2. KEWA only (return 403 for Imeri)
3. Fetch all tasks where:
   - status = 'completed'
   - completed_at BETWEEN start_date AND end_date
4. Include project and unit info (join)
5. For each task, fetch associated photos (both explanation and completion)
6. Group results by unit, then by project
7. Return structure:
   ```
   {
     period: { start: string, end: string },
     summary: { total_completed: number, units_with_work: number },
     units: [{
       unit: { id, name, unit_type, floor },
       projects: [{
         project: { id, name },
         tasks: [{
           task: { id, title, completed_at, completion_note },
           photos: { explanation: [], completion: [] }
         }]
       }]
     }]
   }
   ```
8. Sort: units by floor (desc), projects alphabetically, tasks by completed_at
  </action>
  <verify>curl /api/reports/weekly returns structured report data</verify>
  <done>Weekly report endpoint returns aggregated data</done>
</task>

<task type="auto">
  <name>Task 2: Create WeeklyReport component</name>
  <files>src/components/reports/WeeklyReport.tsx</files>
  <action>
Create WeeklyReport display component:
1. Accept report data as prop (matching API response structure)
2. Display summary header: "X Aufgaben erledigt in Y Einheiten"
3. For each unit, show collapsible section:
   - Unit name as header
   - Project subsections
   - Task cards showing: title, completed_at (formatted), completion_note
   - Before/after photo comparison using existing BeforeAfterView pattern
4. Mobile-first layout (single column)
5. Empty state if no completed tasks
6. Use existing Card, CardHeader, CardContent components
7. Format dates in German locale (z.B. "15. Januar 2026, 14:30")
  </action>
  <verify>npm run build succeeds</verify>
  <done>WeeklyReport component displays report data</done>
</task>

<task type="auto">
  <name>Task 3: Create reports page with week selector</name>
  <files>src/app/dashboard/berichte/page.tsx</files>
  <action>
Create /dashboard/berichte page:
1. KEWA only (redirect Imeri to /dashboard)
2. Week selector at top:
   - Default to current week (Mon-Sun)
   - "Vorherige Woche" / "Naechste Woche" buttons
   - Display selected range: "10. Jan - 16. Jan 2026"
3. Fetch report data on mount and when week changes
4. Show loading state while fetching
5. Render WeeklyReport component with data
6. Error handling for API failures
7. Responsive layout matching other dashboard pages
  </action>
  <verify>npm run build succeeds</verify>
  <done>Reports page displays weekly report with navigation</done>
</task>

<task type="auto">
  <name>Task 4: Add reports link to navigation</name>
  <files>src/components/navigation/mobile-nav.tsx</files>
  <action>
Add "Berichte" link to mobile navigation for KEWA:
1. Add new nav item between "Gebaude" and any other items
2. Icon: chart/document icon (use similar pattern to existing icons)
3. Path: /dashboard/berichte
4. Only show for KEWA role (check session role)
5. Active state styling matching existing nav items
  </action>
  <verify>npm run build succeeds, nav shows Berichte for KEWA</verify>
  <done>Navigation includes Berichte link for KEWA</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Weekly reports page with completed tasks, photos, and week navigation</what-built>
  <how-to-verify>
    1. Run: npm run dev
    2. Login as KEWA
    3. Visit: http://localhost:3000/dashboard/berichte
    4. Verify: Summary shows count of completed tasks
    5. Verify: Tasks grouped by unit and project
    6. Verify: Before/after photos display correctly
    7. Verify: Week navigation works (prev/next buttons)
    8. Verify: Navigation bar shows "Berichte" link
    9. Login as Imeri, verify Berichte is not accessible
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] npm run build succeeds
- [ ] Weekly report API returns correct data structure
- [ ] Reports page loads and displays data
- [ ] Week navigation changes displayed period
- [ ] Photos display in report
- [ ] KEWA can access, Imeri cannot
</verification>

<success_criteria>
- All tasks completed
- KEWA can view weekly report
- Report shows completed tasks with photos
- Week navigation works
- Human verification passed
</success_criteria>

<output>
After completion, create `.planning/phases/06-reports-advanced/06-02-SUMMARY.md`
</output>
