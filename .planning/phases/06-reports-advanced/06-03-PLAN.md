---
phase: 06-reports-advanced
plan: 03
type: execute
wave: 2
depends_on: ["06-01", "06-02"]
files_modified:
  - src/app/api/projects/[id]/route.ts
  - src/app/api/projects/[id]/archive/route.ts
  - src/components/projects/ProjectCard.tsx
  - src/app/dashboard/tasks/page.tsx
  - supabase/migrations/006_archive_tracking.sql
autonomous: false
user_setup: []

must_haves:
  truths:
    - "KEWA can archive a project when all its tasks are completed"
    - "Archived projects are hidden from default views"
    - "KEWA can view archived projects via filter toggle"
    - "Archived projects show visual distinction (grayed out, archive badge)"
    - "Archive action is reversible (unarchive)"
  artifacts:
    - path: "src/app/api/projects/[id]/archive/route.ts"
      provides: "Archive/unarchive endpoint"
      exports: ["POST"]
    - path: "supabase/migrations/006_archive_tracking.sql"
      provides: "archived_at column for projects"
      contains: "archived_at"
  key_links:
    - from: "src/app/dashboard/tasks/page.tsx"
      to: "/api/projects?include_archived=true"
      via: "fetch with archive filter"
      pattern: "include_archived"
---

<objective>
Implement project archiving system for KEWA AG.

Purpose: Allow KEWA to archive completed projects to keep the active view clean while preserving historical data. Archived projects can be viewed when needed but don't clutter the main interface.

Output: Archive button on projects, archived projects filter, visual archive indicators.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
@~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@src/app/api/projects/route.ts
@src/types/database.ts
@src/app/dashboard/tasks/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create archive migration</name>
  <files>supabase/migrations/006_archive_tracking.sql</files>
  <action>
Create migration to add archive tracking:
1. Add archived_at TIMESTAMPTZ column to projects table (nullable, default null)
2. Add index on archived_at for filtering
3. Add check: archived_at only set when status = 'archived'
4. Update existing 'archived' status projects to have archived_at = NOW() (if any)

Note: status='archived' already exists in schema, but archived_at provides timestamp.
  </action>
  <verify>Migration file is valid SQL</verify>
  <done>Migration adds archived_at tracking column</done>
</task>

<task type="auto">
  <name>Task 2: Create archive/unarchive endpoint</name>
  <files>src/app/api/projects/[id]/archive/route.ts</files>
  <action>
Create POST /api/projects/[id]/archive endpoint:
1. KEWA only (403 for Imeri)
2. Accept body: { archive: boolean }
3. If archive=true:
   - Check all tasks in project are completed
   - If not all completed, return 400 "Alle Aufgaben muessen erledigt sein"
   - Set status='archived', archived_at=NOW()
4. If archive=false (unarchive):
   - Set status='active', archived_at=null
5. Return updated project
  </action>
  <verify>curl tests for archive/unarchive work correctly</verify>
  <done>Archive endpoint handles archiving logic</done>
</task>

<task type="auto">
  <name>Task 3: Update projects API to support archive filter</name>
  <files>src/app/api/projects/route.ts</files>
  <action>
Modify GET /api/projects:
1. Add query param: ?include_archived=true|false (default false)
2. When include_archived=false, filter out status='archived'
3. When include_archived=true, return all projects
4. Add archived_at to Project type in response
  </action>
  <verify>API filters archived projects by default</verify>
  <done>Projects API supports archive filtering</done>
</task>

<task type="auto">
  <name>Task 4: Add archive UI to tasks page</name>
  <files>src/app/dashboard/tasks/page.tsx</files>
  <action>
Add archive functionality to KEWA tasks page:
1. Add "Archivierte anzeigen" toggle (checkbox or switch)
2. Pass include_archived to projects fetch based on toggle
3. For each project card, add archive button (when all tasks completed)
4. Archive button: gray archive icon, shows on hover/focus
5. Show "Archivieren" tooltip
6. Archived projects show: grayed styling, "Archiviert" badge
7. Archived projects have "Wiederherstellen" button instead
8. Confirmation dialog before archiving
  </action>
  <verify>npm run build succeeds</verify>
  <done>Tasks page supports project archiving UI</done>
</task>

<task type="auto">
  <name>Task 5: Update types for archive support</name>
  <files>src/types/database.ts</files>
  <action>
Update TypeScript types:
1. Add archived_at: string | null to Project interface
2. Add include_archived to any API query types
3. Ensure ProjectWithUnit includes archived_at
  </action>
  <verify>npm run build succeeds with no type errors</verify>
  <done>Types support archive fields</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Project archiving system with archive/unarchive, filtering, and visual indicators</what-built>
  <how-to-verify>
    1. Run: npm run dev
    2. Login as KEWA
    3. Complete all tasks in a project (or use test data)
    4. Verify: Archive button appears on project with all tasks completed
    5. Click archive: Verify confirmation dialog appears
    6. Confirm: Verify project disappears from default view
    7. Toggle "Archivierte anzeigen": Verify archived project reappears grayed out
    8. Click "Wiederherstellen": Verify project unarchives
    9. Verify: Imeri cannot archive projects
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] npm run build succeeds
- [ ] Migration file is valid
- [ ] Archive endpoint works for completed projects
- [ ] Archive fails for projects with open tasks
- [ ] Archived projects hidden by default
- [ ] Toggle shows archived projects
- [ ] Unarchive restores project to active
</verification>

<success_criteria>
- All tasks completed
- KEWA can archive completed projects
- Archived projects filter works
- Visual distinction for archived projects
- Human verification passed
</success_criteria>

<output>
After completion, create `.planning/phases/06-reports-advanced/06-03-SUMMARY.md`
</output>
