---
phase: 04-voice-notes
plan: 03
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - src/components/audio/AudioRecorder.tsx
  - src/components/audio/AudioPlayer.tsx
  - src/components/audio/AudioGallery.tsx
  - src/app/dashboard/aufgaben/[id]/page.tsx
  - src/app/dashboard/audio/page.tsx
autonomous: false

must_haves:
  truths:
    - "KEWA can record audio up to 1 minute"
    - "KEWA can see transcription after recording"
    - "Imeri can play KEWA's audio"
    - "Imeri can read transcription"
    - "Imeri can record emergency audio"
    - "KEWA sees all audio files in gallery"
  artifacts:
    - path: "src/components/audio/AudioRecorder.tsx"
      provides: "Audio recording component"
      min_lines: 100
    - path: "src/components/audio/AudioPlayer.tsx"
      provides: "Audio playback component"
      min_lines: 50
    - path: "src/components/audio/AudioGallery.tsx"
      provides: "Audio list/gallery component"
      min_lines: 60
    - path: "src/app/dashboard/audio/page.tsx"
      provides: "Audio overview page for KEWA"
      min_lines: 50
  key_links:
    - from: "AudioRecorder"
      to: "/api/audio POST"
      via: "FormData upload"
    - from: "AudioPlayer"
      to: "signed URL"
      via: "HTML5 audio element"
    - from: "Task detail page"
      to: "AudioRecorder/AudioPlayer"
      via: "role-based rendering"
---

<objective>
Create audio recording, playback, and gallery UI components with task detail integration.

Purpose: Enable voice note workflow - KEWA records explanations, Imeri plays them back with transcription.
Output: React components for audio capture/playback and integrated task detail view.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
@~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior phase patterns (audio UI follows photo UI patterns):
@.planning/phases/03-photo-documentation/03-02-SUMMARY.md

# Existing components to follow patterns from:
@src/components/photos/PhotoUpload.tsx
@src/app/dashboard/aufgaben/[id]/page.tsx
@src/types/database.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create AudioRecorder component</name>
  <files>src/components/audio/AudioRecorder.tsx</files>
  <action>
Create src/components/audio/AudioRecorder.tsx following PhotoUpload.tsx patterns:

Props interface:
- taskId: string
- audioType: AudioType
- existingAudio?: TaskAudioWithUrl
- onRecordComplete?: (audio: TaskAudioWithUrl) => void
- onDelete?: (audioId: string) => void
- disabled?: boolean

State:
- recordingState: 'idle' | 'recording' | 'preview' | 'uploading' | 'success' | 'error'
- recordedBlob: Blob | null
- recordingDuration: number (seconds)
- previewUrl: string | null
- errorMessage: string | null

Implementation:
1. Use MediaRecorder API for recording:
   - Check navigator.mediaDevices.getUserMedia support
   - Request audio permission: { audio: true }
   - Create MediaRecorder with mimeType preference: ['audio/webm', 'audio/mp4']
   - Collect chunks on dataavailable event
   - Stop after MAX_DURATION (60 seconds) or user stops

2. Recording UI:
   - Start button (microphone icon) when idle
   - Stop button (square icon) + duration counter when recording
   - Max duration indicator "0:45 / 1:00"
   - Auto-stop at 60 seconds with notification

3. Preview UI (after recording stops):
   - Playback preview (simple audio element)
   - Duration display
   - "Abbrechen" (cancel) and "Hochladen" (upload) buttons

4. Upload:
   - Create FormData with blob, task_id, audio_type
   - POST to /api/audio with retry logic (same as PhotoUpload)
   - Show uploading state with spinner

5. Success/Error states:
   - Same patterns as PhotoUpload
   - Error: show message + retry button

6. Existing audio display:
   - If existingAudio provided, show AudioPlayer instead of recorder
   - Delete button with confirmation (same pattern as photos)

German labels: "Aufnahme starten", "Aufnahme stoppen", "Wird hochgeladen...", etc.
  </action>
  <verify>Component file compiles: npx tsc --noEmit</verify>
  <done>AudioRecorder captures, previews, and uploads audio with max 60s duration</done>
</task>

<task type="auto">
  <name>Task 2: Create AudioPlayer component</name>
  <files>src/components/audio/AudioPlayer.tsx</files>
  <action>
Create src/components/audio/AudioPlayer.tsx:

Props interface:
- audio: TaskAudioWithUrl
- showTranscription?: boolean (default true)
- compact?: boolean (default false)

Component structure:
1. Audio element with custom controls:
   - Play/pause button (large, 48px touch target)
   - Duration display (current / total)
   - Progress bar (tappable for seeking)

2. Transcription section (if showTranscription and audio.transcription):
   - Status indicator based on transcription_status:
     - 'pending': "Transkription wird vorbereitet..."
     - 'processing': "Transkription laeuft..." with spinner
     - 'completed': Show transcription text
     - 'failed': "Transkription fehlgeschlagen" with retry hint
   - Transcription text in readable format (expandable if long)

3. Metadata (if not compact):
   - File name
   - Recorded date/time
   - Duration

4. Compact mode:
   - Just play button + duration inline
   - No transcription display
   - Used in gallery list view

Audio element behavior:
- HTML5 <audio> with preload="metadata"
- Custom styled play button
- Touch-friendly progress bar

German labels: "Abspielen", "Pause", "Transkription"
  </action>
  <verify>Component file compiles: npx tsc --noEmit</verify>
  <done>AudioPlayer plays audio with transcription display and custom controls</done>
</task>

<task type="auto">
  <name>Task 3: Create AudioGallery component and page</name>
  <files>src/components/audio/AudioGallery.tsx, src/app/dashboard/audio/page.tsx</files>
  <action>
Create src/components/audio/AudioGallery.tsx:

Props interface:
- audios: TaskAudioWithUrl[]
- onSelect?: (audio: TaskAudioWithUrl) => void
- showTaskInfo?: boolean (default true)

Component:
1. List of audio items, each showing:
   - Audio type badge (Erklaerung/Notfall)
   - Task title (if showTaskInfo and available)
   - Compact AudioPlayer
   - Transcription preview (first 100 chars if available)
   - Date recorded

2. Empty state: "Keine Sprachnotizen vorhanden"

3. Sorting: most recent first (by created_at)

4. Click handler for selecting/expanding audio

Create src/app/dashboard/audio/page.tsx (KEWA only):

Page structure:
1. Header: "Sprachnotizen" with back button
2. Fetch all audio (new API endpoint or filter on client)
3. Filter tabs: "Alle" | "Erklaerungen" | "Notfaelle"
4. AudioGallery component with full list
5. Selected audio detail view (expanded player with full transcription)

API: May need GET /api/audio (without task_id) for KEWA to list all - or fetch tasks and aggregate.

Simpler approach: Fetch from /api/audio without task_id param â†’ returns all audio (KEWA only).
Modify GET /api/audio in 04-01 to return all if no task_id and user is KEWA.
  </action>
  <verify>npm run build succeeds</verify>
  <done>AudioGallery displays audio list, audio page shows all recordings for KEWA</done>
</task>

<task type="auto">
  <name>Task 4: Integrate audio into task detail page</name>
  <files>src/app/dashboard/aufgaben/[id]/page.tsx</files>
  <action>
Modify src/app/dashboard/aufgaben/[id]/page.tsx to add audio section:

1. Fetch audio for task: GET /api/audio?task_id={id}

2. Add audio section below photo section (similar structure):
   - Section header: "Sprachnotizen"
   - Role-based display:
     a. KEWA viewing:
        - AudioRecorder for explanation audio (if not exists)
        - AudioPlayer for existing explanation audio
        - AudioPlayer for any emergency audio from Imeri (read-only)
     b. Imeri viewing:
        - AudioPlayer for KEWA's explanation (with transcription)
        - AudioRecorder for emergency audio (if not exists)
        - AudioPlayer for existing emergency audio

3. Layout:
   - Explanation audio section: "Erklaerung von KEWA"
   - Emergency audio section: "Notfall-Notiz" (only if exists or Imeri recording)

4. State management:
   - Add audios state: TaskAudioWithUrl[]
   - Refresh on upload/delete

5. Styling:
   - Match photo section styling
   - Clear separation between explanation and emergency sections
   - Color coding: blue for explanation, orange/red for emergency
  </action>
  <verify>npm run build succeeds</verify>
  <done>Task detail page shows audio recorder/player based on role</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Audio recording, playback, and gallery with task integration</what-built>
  <how-to-verify>
    1. Run: npm run dev
    2. Login as KEWA (PIN: 1234)
    3. Navigate to any task detail page
    4. Test audio recording:
       - Click "Aufnahme starten"
       - Speak for a few seconds
       - Click "Aufnahme stoppen"
       - Preview should play back
       - Click "Hochladen"
       - Wait for transcription to appear
    5. Verify transcription displays correctly
    6. Navigate to /dashboard/audio
       - Should see list of all recordings
    7. Login as Imeri (PIN: 5678)
    8. Navigate to same task
       - Should see KEWA's audio with transcription
       - Should be able to play audio
       - Should have option to record emergency audio
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] AudioRecorder records up to 60 seconds
- [ ] AudioPlayer plays back with custom controls
- [ ] Transcription displays for completed audio
- [ ] AudioGallery shows audio list
- [ ] /dashboard/audio page works (KEWA only)
- [ ] Task detail shows audio sections
- [ ] Role-based UI works correctly
- [ ] npm run build succeeds
</verification>

<success_criteria>
- All 5 tasks completed (including checkpoint)
- KEWA can record explanation audio
- KEWA sees transcription after processing
- Imeri can play KEWA's audio
- Imeri can read transcription
- Imeri can record emergency audio
- Audio gallery shows all recordings
- UI is touch-friendly (48px targets)
</success_criteria>

<output>
After completion, create `.planning/phases/04-voice-notes/04-03-SUMMARY.md`
</output>
