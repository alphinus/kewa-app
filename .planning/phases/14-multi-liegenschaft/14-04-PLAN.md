---
phase: 14-multi-liegenschaft
plan: 04
type: execute
wave: 2
depends_on: ["14-02", "14-03"]
files_modified:
  - src/app/dashboard/projekte/page.tsx
  - src/app/dashboard/aufgaben/page.tsx
autonomous: true

must_haves:
  truths:
    - "Projects page fetches with building_id from BuildingContext"
    - "Tasks page fetches with building_id from BuildingContext"
    - "Changing building in selector re-fetches page data"
    - "When 'all' selected, pages show data across all buildings with building badges"
  artifacts:
    - path: "src/app/dashboard/projekte/page.tsx"
      provides: "Projects list filtered by selected building"
      min_lines: 80
    - path: "src/app/dashboard/aufgaben/page.tsx"
      provides: "Tasks list filtered by selected building"
      min_lines: 80
  key_links:
    - from: "src/app/dashboard/projekte/page.tsx"
      to: "/api/projects"
      via: "fetch with building_id"
      pattern: "building_id="
    - from: "src/app/dashboard/aufgaben/page.tsx"
      to: "/api/tasks"
      via: "fetch with building_id"
      pattern: "building_id="
---

<objective>
Wire projects and tasks pages to use BuildingContext for data filtering.

Purpose: Pages reflect the selected building from the header PropertySelector.
Output: Updated page components that fetch with building_id and react to selection changes.
</objective>

<execution_context>
@C:\Users\Mario Giacchino\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\Mario Giacchino\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/14-multi-liegenschaft/14-CONTEXT.md
@.planning/phases/14-multi-liegenschaft/14-02-SUMMARY.md
@.planning/phases/14-multi-liegenschaft/14-03-SUMMARY.md

# Pages to modify
@src/app/dashboard/projekte/page.tsx
@src/app/dashboard/aufgaben/page.tsx

# Context to use
@src/contexts/BuildingContext.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wire projects page to building context</name>
  <files>src/app/dashboard/projekte/page.tsx</files>
  <action>
Modify ProjektePage component:

1. Import and use useBuilding hook:
   ```typescript
   import { useBuilding } from '@/contexts/BuildingContext'

   const { selectedBuildingId, isAllSelected } = useBuilding()
   ```

2. Update fetchProjects to include building_id:
   ```typescript
   const buildingParam = selectedBuildingId && selectedBuildingId !== 'all'
     ? `&building_id=${selectedBuildingId}`
     : ''

   const projectsUrl = showArchived
     ? `/api/projects?include_archived=true${buildingParam}`
     : `/api/projects${buildingParam ? '?' + buildingParam.slice(1) : ''}`
   ```

3. Add selectedBuildingId to useEffect dependency array to re-fetch when building changes

4. When isAllSelected, show building badge on each project card:
   - Add building info to ProjectWithStats interface (get from unit's building)
   - Display small badge showing which building the project belongs to
   - This helps users identify projects when viewing "all"

5. Handle loading state while context initializes:
   ```typescript
   if (isLoading) return <LoadingSkeleton />
   ```
  </action>
  <verify>
- Change building in header selector -> projects list updates
- Select "Alle" -> shows all projects with building badges
- Select specific building -> shows only that building's projects
  </verify>
  <done>Projects page filters by selected building and re-fetches on change</done>
</task>

<task type="auto">
  <name>Task 2: Wire tasks page to building context</name>
  <files>src/app/dashboard/aufgaben/page.tsx</files>
  <action>
Modify the tasks page (if it exists) or create reference for dashboard task list:

1. Import and use useBuilding hook:
   ```typescript
   import { useBuilding } from '@/contexts/BuildingContext'

   const { selectedBuildingId, isAllSelected } = useBuilding()
   ```

2. Update task fetching to include building_id:
   ```typescript
   const buildingParam = selectedBuildingId && selectedBuildingId !== 'all'
     ? `building_id=${selectedBuildingId}`
     : ''

   const tasksUrl = `/api/tasks${buildingParam ? '?' + buildingParam : ''}`
   ```

3. Add selectedBuildingId to useEffect dependency to re-fetch on change

4. When isAllSelected, show building/property context on each task:
   - Task cards already show unit and project info
   - Add small badge or prefix showing building name for context

5. Handle loading state properly

Note: Check if this file exists first. If it's handled differently (e.g., tasks shown on main dashboard only), adjust approach accordingly.
  </action>
  <verify>
- Change building in header selector -> tasks list updates
- Select "Alle" -> shows all tasks with building context
- Select specific building -> shows only that building's tasks
  </verify>
  <done>Tasks page filters by selected building and re-fetches on change</done>
</task>

</tasks>

<verification>
1. Run `npm run build` - no TypeScript errors
2. Open app, select Building A -> projects/tasks page shows only Building A data
3. Switch to Building B -> page refreshes with Building B data
4. Select "Alle Liegenschaften" -> page shows all data with building badges
5. Data correctly filters through the chain: building -> unit -> project (-> task)
</verification>

<success_criteria>
- Projects page respects selected building from context
- Tasks page respects selected building from context
- Changing selection triggers data re-fetch
- "Alle" selection shows all data with building identification
- No hardcoded building IDs remain
</success_criteria>

<output>
After completion, create `.planning/phases/14-multi-liegenschaft/14-04-SUMMARY.md`
</output>
