---
phase: 14-multi-liegenschaft
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/app/api/properties/[id]/route.ts
  - src/app/api/buildings/[id]/route.ts
autonomous: true

must_haves:
  truths:
    - "Admin can update property name and address via PATCH /api/properties/[id]"
    - "Admin can delete property via DELETE /api/properties/[id]"
    - "Admin can update building name and address via PATCH /api/buildings/[id]"
    - "Admin can delete building via DELETE /api/buildings/[id]"
    - "Delete operations warn about cascade implications but proceed (admin override)"
  artifacts:
    - path: "src/app/api/properties/[id]/route.ts"
      provides: "PATCH and DELETE handlers for single property"
      exports: ["PATCH", "DELETE"]
    - path: "src/app/api/buildings/[id]/route.ts"
      provides: "PATCH and DELETE handlers for single building"
      exports: ["PATCH", "DELETE"]
  key_links:
    - from: "src/app/api/properties/[id]/route.ts"
      to: "properties table"
      via: "supabase update/delete"
      pattern: "supabase\\.from\\('properties'\\)\\.(update|delete)"
    - from: "src/app/api/buildings/[id]/route.ts"
      to: "buildings table"
      via: "supabase update/delete"
      pattern: "supabase\\.from\\('buildings'\\)\\.(update|delete)"
---

<objective>
Add UPDATE and DELETE API routes for properties and buildings.

Purpose: Complete CRUD operations for property/building management (currently only GET/POST exist).
Output: Two new route files with PATCH and DELETE handlers.
</objective>

<execution_context>
@C:\Users\Mario Giacchino\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\Mario Giacchino\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/14-multi-liegenschaft/14-CONTEXT.md

# Reference existing API patterns
@src/app/api/properties/route.ts
@src/app/api/buildings/route.ts
@src/app/api/partners/[id]/route.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create property single-resource route</name>
  <files>src/app/api/properties/[id]/route.ts</files>
  <action>
Create route file with PATCH and DELETE handlers:

**PATCH /api/properties/[id]:**
- Auth check: userId and userRole from headers
- Role check: only kewa/imeri roles allowed
- Validate request body: name (optional string, min 1 char if provided), address (optional string), description (optional string)
- Update property in database using supabase.from('properties').update()
- Return updated property

**DELETE /api/properties/[id]:**
- Auth check: userId and userRole from headers
- Role check: only kewa role allowed (admin-only delete, same as partners)
- Check for associated buildings (count them)
- Log warning if buildings exist but proceed anyway (admin override pattern from phase 13)
- Delete property (ON DELETE CASCADE handles buildings/units)
- Return 204 No Content

Follow existing patterns from partners/[id]/route.ts for structure. Use manual validation (no Zod) per codebase convention.
  </action>
  <verify>
Create test requests:
- `curl -X PATCH /api/properties/{id} -d '{"name":"Updated"}' -H 'Content-Type: application/json'` returns 200 with updated property
- `curl -X DELETE /api/properties/{id}` returns 204
  </verify>
  <done>PATCH updates property fields, DELETE removes property with cascade warning in console</done>
</task>

<task type="auto">
  <name>Task 2: Create building single-resource route</name>
  <files>src/app/api/buildings/[id]/route.ts</files>
  <action>
Create route file with PATCH and DELETE handlers:

**PATCH /api/buildings/[id]:**
- Auth check: userId and userRole from headers
- Role check: only kewa/imeri roles allowed
- Validate request body: name (optional string, min 1 char if provided), address (optional string), property_id (optional UUID - allows moving building to different property)
- If property_id provided, verify target property exists
- Update building in database
- Return updated building

**DELETE /api/buildings/[id]:**
- Auth check: userId and userRole from headers
- Role check: only kewa role allowed
- Check for associated units (count them)
- Log warning if units exist but proceed anyway
- Delete building (ON DELETE CASCADE handles units)
- Return 204 No Content

Note: Building already has heatmap route at /api/buildings/[buildingId]/heatmap. This new route is at /api/buildings/[id]/route.ts for PATCH/DELETE.
  </action>
  <verify>
Create test requests:
- `curl -X PATCH /api/buildings/{id} -d '{"name":"Updated Building"}' -H 'Content-Type: application/json'` returns 200
- `curl -X DELETE /api/buildings/{id}` returns 204
  </verify>
  <done>PATCH updates building fields, DELETE removes building with cascade warning in console</done>
</task>

</tasks>

<verification>
1. Run `npm run build` - no TypeScript errors
2. Both route files exist and export PATCH and DELETE functions
3. Auth checks present in all handlers
4. Role restrictions: PATCH allows kewa/imeri, DELETE allows only kewa
</verification>

<success_criteria>
- PATCH /api/properties/[id] updates property and returns updated record
- DELETE /api/properties/[id] removes property and returns 204
- PATCH /api/buildings/[id] updates building and returns updated record
- DELETE /api/buildings/[id] removes building and returns 204
- All handlers have proper auth and role checks
</success_criteria>

<output>
After completion, create `.planning/phases/14-multi-liegenschaft/14-01-SUMMARY.md`
</output>
