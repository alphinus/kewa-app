---
phase: 14-multi-liegenschaft
plan: 05
type: execute
wave: 2
depends_on: ["14-02"]
files_modified:
  - src/app/dashboard/page.tsx
  - src/app/dashboard/liegenschaft/page.tsx
autonomous: true

must_haves:
  truths:
    - "Main dashboard shows tasks/stats for selected building only (or all if 'all' selected)"
    - "Liegenschaft page respects selected building from context"
    - "Heatmap shows selected building's units"
    - "Changing building selection updates dashboard and heatmap"
  artifacts:
    - path: "src/app/dashboard/page.tsx"
      provides: "Dashboard filtered by selected building"
      min_lines: 100
    - path: "src/app/dashboard/liegenschaft/page.tsx"
      provides: "Liegenschaft page using context building"
      min_lines: 80
  key_links:
    - from: "src/app/dashboard/page.tsx"
      to: "/api/tasks"
      via: "fetch with building_id"
      pattern: "building_id"
    - from: "src/app/dashboard/liegenschaft/page.tsx"
      to: "/api/buildings/[id]/heatmap"
      via: "fetch with selected building"
      pattern: "selectedBuildingId"
---

<objective>
Wire main dashboard and Liegenschaft page to use BuildingContext for data filtering.

Purpose: Dashboard overview and heatmap reflect the selected building.
Output: Updated dashboard and liegenschaft pages that respect building selection.
</objective>

<execution_context>
@C:\Users\Mario Giacchino\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\Mario Giacchino\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/14-multi-liegenschaft/14-CONTEXT.md
@.planning/phases/14-multi-liegenschaft/14-02-SUMMARY.md

# Pages to modify
@src/app/dashboard/page.tsx
@src/app/dashboard/liegenschaft/page.tsx

# Context
@src/contexts/BuildingContext.tsx

# Heatmap API
@src/app/api/buildings/[buildingId]/heatmap/route.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wire main dashboard to building context</name>
  <files>src/app/dashboard/page.tsx</files>
  <action>
Modify dashboard page:

1. Import and use useBuilding hook:
   ```typescript
   import { useBuilding } from '@/contexts/BuildingContext'

   const { selectedBuildingId, isAllSelected, isLoading: buildingLoading } = useBuilding()
   ```

2. Update task fetching to include building_id filter:
   - The dashboard fetches tasks for overview stats
   - Add building_id query param when specific building selected
   - When 'all' selected, fetch without filter

3. Add selectedBuildingId to useEffect dependency to re-fetch on change

4. Consider showing a header or badge indicating current building context:
   - "Zeigt Aufgaben fuer: [Building Name]"
   - Or just rely on header selector being visible

5. Handle edge case: if isAllSelected, dashboard shows aggregate stats across all buildings
   - Stats cards show totals
   - Recent activity includes building name on each item

6. Wait for building context to initialize before fetching:
   ```typescript
   useEffect(() => {
     if (!buildingLoading) {
       fetchTasks()
     }
   }, [selectedBuildingId, buildingLoading])
   ```
  </action>
  <verify>
- Select Building A -> dashboard shows only Building A tasks
- Select "Alle" -> dashboard shows all tasks with aggregate stats
- Changing selection updates dashboard immediately
  </verify>
  <done>Dashboard filters by selected building</done>
</task>

<task type="auto">
  <name>Task 2: Wire Liegenschaft page to building context</name>
  <files>src/app/dashboard/liegenschaft/page.tsx</files>
  <action>
Review and update Liegenschaft page:

1. Check current implementation - it may already use URL param for building selection
2. If using URL param, update to use BuildingContext instead:
   ```typescript
   import { useBuilding } from '@/contexts/BuildingContext'

   const { selectedBuildingId, isLoading } = useBuilding()
   ```

3. When selectedBuildingId is 'all':
   - Option A: Show prompt to select a specific building ("Bitte waehlen Sie ein Gebaeude")
   - Option B: Show first building's heatmap with ability to navigate
   - Recommend Option A as heatmap is building-specific

4. Fetch heatmap data using selectedBuildingId:
   ```typescript
   const fetchHeatmap = async () => {
     if (!selectedBuildingId || selectedBuildingId === 'all') {
       setShowSelectPrompt(true)
       return
     }

     const response = await fetch(`/api/buildings/${selectedBuildingId}/heatmap`)
     // ... handle response
   }
   ```

5. Remove any BuildingSelector component if present (header selector replaces it)
   - Or keep it as a secondary way to switch within the page if useful

6. Add selectedBuildingId to dependency array for re-fetch on selection change
  </action>
  <verify>
- Select specific building -> Liegenschaft shows that building's heatmap
- Select "Alle" -> page shows prompt to select a building
- Changing building selection updates heatmap
  </verify>
  <done>Liegenschaft page uses context building for heatmap</done>
</task>

</tasks>

<verification>
1. Run `npm run build` - no TypeScript errors
2. Test dashboard:
   - Select Building A -> shows Building A stats and tasks
   - Select "Alle" -> shows aggregate view
3. Test Liegenschaft:
   - Select Building A -> shows Building A heatmap
   - Select "Alle" -> shows "select a building" prompt
4. Verify header selector and page data stay in sync
</verification>

<success_criteria>
- Main dashboard respects selected building from context
- Liegenschaft heatmap shows selected building
- "Alle" selection handled appropriately (aggregate for dashboard, prompt for heatmap)
- Changing selection triggers data re-fetch on both pages
- No hardcoded building IDs remain
</success_criteria>

<output>
After completion, create `.planning/phases/14-multi-liegenschaft/14-05-SUMMARY.md`
</output>
