---
phase: 20-supplier-advanced
plan: 02
type: execute
wave: 2
depends_on: ["20-01"]
files_modified:
  - src/lib/suppliers/inventory-queries.ts
  - src/lib/suppliers/alert-calculations.ts
  - src/app/api/inventory-movements/route.ts
  - src/app/api/inventory-movements/[id]/route.ts
  - src/app/api/reorder-alerts/route.ts
  - src/components/suppliers/InventoryMovementForm.tsx
  - src/components/suppliers/InventoryLevelCard.tsx
  - src/components/suppliers/ReorderAlertList.tsx
  - src/app/dashboard/lieferanten/bestand/page.tsx
  - src/app/dashboard/lieferanten/bestand/[propertyId]/page.tsx
autonomous: true

must_haves:
  truths:
    - "User can record a tank reading (level, capacity, date) for a property"
    - "User can see current inventory level per property with percentage and projected empty date"
    - "User sees reorder alerts with urgency (critical/warning/normal) when stock is below threshold"
    - "Inventory overview page lists all properties with their current tank levels"
    - "Property detail page shows inventory movement history"
    - "Insufficient data message shown when fewer than 2 readings exist"
  artifacts:
    - path: "src/app/api/inventory-movements/route.ts"
      provides: "GET (list) and POST (create reading) endpoints"
      exports: ["GET", "POST"]
    - path: "src/app/api/inventory-movements/[id]/route.ts"
      provides: "GET, PATCH, DELETE for individual movements"
      exports: ["GET", "PATCH", "DELETE"]
    - path: "src/app/api/reorder-alerts/route.ts"
      provides: "GET endpoint returning active reorder alerts"
      exports: ["GET"]
    - path: "src/components/suppliers/InventoryMovementForm.tsx"
      provides: "Form for recording tank readings"
    - path: "src/components/suppliers/InventoryLevelCard.tsx"
      provides: "Card showing current level, percentage, projected empty date"
    - path: "src/components/suppliers/ReorderAlertList.tsx"
      provides: "List of active alerts with urgency badges"
    - path: "src/app/dashboard/lieferanten/bestand/page.tsx"
      provides: "Inventory overview page"
    - path: "src/app/dashboard/lieferanten/bestand/[propertyId]/page.tsx"
      provides: "Property inventory detail with movement history"
  key_links:
    - from: "src/app/api/inventory-movements/route.ts"
      to: "inventory_movements table"
      via: "supabase.from('inventory_movements')"
      pattern: "from\\('inventory_movements'\\)"
    - from: "src/app/api/inventory-movements/route.ts"
      to: "previous reading lookup"
      via: "query for latest reading to calculate usage rate"
      pattern: "order.*movement_date.*desc"
    - from: "src/app/api/reorder-alerts/route.ts"
      to: "get_reorder_alerts DB function"
      via: "supabase.rpc('get_reorder_alerts')"
      pattern: "rpc\\('get_reorder_alerts'\\)"
    - from: "src/app/dashboard/lieferanten/bestand/page.tsx"
      to: "/api/inventory-movements and /api/reorder-alerts"
      via: "fetch calls"
      pattern: "fetch.*api/(inventory-movements|reorder-alerts)"
---

<objective>
Build inventory tracking API routes, reorder alert endpoint, and dashboard pages for consumption monitoring.

Purpose: Users can record tank readings, see current levels per property, and receive alerts when stock runs low.
Output: 3 API routes, 3 UI components, 2 dashboard pages, 2 lib utility files.
</objective>

<execution_context>
@C:\Users\Mario Giacchino\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\Mario Giacchino\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/20-supplier-advanced/20-01-SUMMARY.md
@src/types/suppliers.ts
@src/app/api/deliveries/route.ts
@src/app/dashboard/lieferanten/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create inventory movement and reorder alert API routes</name>
  <files>
    src/lib/suppliers/inventory-queries.ts
    src/lib/suppliers/alert-calculations.ts
    src/app/api/inventory-movements/route.ts
    src/app/api/inventory-movements/[id]/route.ts
    src/app/api/reorder-alerts/route.ts
  </files>
  <action>
    Create src/lib/suppliers/inventory-queries.ts:
    - Helper function `getPreviousReading(supabase, propertyId, beforeDate)` — queries inventory_movements for latest reading before given date for property. Returns { movement_date, tank_level } or null.
    - Helper function `calculateConsumption(previousReading, currentLevel, currentDate)` — returns { days_since_last, consumption_amount, daily_usage_rate } or nulls if no previous reading or if movement_type is 'delivery' (delivery increases level, not consumption).
    - Helper function `getCurrentLevels(supabase)` — queries current_inventory_levels view, joins properties for name.
    - Helper function `getMovementHistory(supabase, propertyId, limit?, offset?)` — queries inventory_movements for a property, ordered by movement_date DESC.

    Create src/lib/suppliers/alert-calculations.ts:
    - Function `getReorderAlerts(supabase, thresholdPercentage = 20)` — calls supabase.rpc('get_reorder_alerts', { threshold_pct: thresholdPercentage }). Joins property name. Returns typed ReorderAlert[].
    - Function `getAlertUrgencyColor(urgency: 'critical' | 'warning' | 'normal')` — returns Tailwind color class: critical='text-red-600', warning='text-amber-600', normal='text-green-600'.
    - Function `getAlertUrgencyLabel(urgency)` — returns German labels: critical='Kritisch', warning='Warnung', normal='Normal'.

    Create src/app/api/inventory-movements/route.ts:
    - GET: List inventory movements. Query params: property_id (filter), limit (default 50), offset (default 0). Select *, join property name. Return { movements, total, limit, offset }.
    - POST: Create inventory movement. Body: { property_id, movement_type, movement_date, tank_level, tank_capacity?, building_id?, delivery_id?, notes? }. Before insert, call getPreviousReading and calculateConsumption to set days_since_last, consumption_amount, daily_usage_rate. For movement_type='delivery': consumption fields are null (delivery adds to tank, sets new baseline). Set created_by from x-user-id header. Return { movement } with 201.
    - Auth: kewa/imeri roles only (follow deliveries/route.ts pattern).

    Create src/app/api/inventory-movements/[id]/route.ts:
    - GET: Single movement by id. Return { movement }.
    - PATCH: Update movement. Only allow updating: movement_date, tank_level, tank_capacity, notes. Recalculate consumption fields if tank_level or movement_date changed. Return { movement }.
    - DELETE: Delete movement by id. Return 204 no content.
    - Auth: kewa/imeri roles.

    Create src/app/api/reorder-alerts/route.ts:
    - GET: Return active reorder alerts. Query param: threshold (default 20). Call getReorderAlerts. Join property name from properties table. Return { alerts, threshold }.
    - Auth: kewa/imeri roles.

    All routes follow the pattern from src/app/api/deliveries/route.ts: try-catch wrapper, header-based auth, NextResponse.json.
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - Each route file exports correct HTTP methods
    - grep confirms supabase queries reference correct tables/views
  </verify>
  <done>
    POST /api/inventory-movements creates reading with auto-calculated usage rate. GET lists movements with property filter. GET /api/reorder-alerts returns alerts with urgency. CRUD on individual movements works.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create inventory components and dashboard pages</name>
  <files>
    src/components/suppliers/InventoryMovementForm.tsx
    src/components/suppliers/InventoryLevelCard.tsx
    src/components/suppliers/ReorderAlertList.tsx
    src/app/dashboard/lieferanten/bestand/page.tsx
    src/app/dashboard/lieferanten/bestand/[propertyId]/page.tsx
  </files>
  <action>
    Create src/components/suppliers/InventoryMovementForm.tsx:
    - 'use client' component
    - Form fields: property selector (dropdown), movement_date (date input), tank_level (number, step 0.01), tank_capacity (number, step 0.01), movement_type (select: reading/adjustment — delivery is auto-created), notes (textarea)
    - On submit: POST to /api/inventory-movements, call onSuccess callback
    - Loading/error states with German labels
    - Props: properties (Property[]), onSuccess callback, initialValues? (for editing)

    Create src/components/suppliers/InventoryLevelCard.tsx:
    - Props: level (CurrentInventoryLevel), propertyName (string)
    - Display: property name, current level (tonnes), tank capacity, level percentage with color coding (green >50%, amber 20-50%, red <20%), daily usage rate, projected empty date (formatted de-CH), days until empty
    - Show "Keine Verbrauchsdaten" when daily_usage_rate is null (insufficient data)
    - Link to property detail page: /dashboard/lieferanten/bestand/{propertyId}

    Create src/components/suppliers/ReorderAlertList.tsx:
    - Props: alerts (ReorderAlert[])
    - Display list of alerts sorted by urgency (critical first)
    - Each alert shows: property name, current level, level percentage, days until empty, urgency badge with color (using getAlertUrgencyColor/Label)
    - Empty state: "Keine Warnungen — alle Bestaende im gruenen Bereich"

    Create src/app/dashboard/lieferanten/bestand/page.tsx:
    - 'use client' page
    - Title: "Bestandsuebersicht" (Inventory Overview)
    - Section 1: ReorderAlertList (fetch from /api/reorder-alerts)
    - Section 2: Grid of InventoryLevelCard for each property (fetch from /api/inventory-movements with current levels)
    - Button to add new reading (opens InventoryMovementForm in modal or inline)
    - Fetch properties from /api/properties for property list
    - Loading/error states

    Create src/app/dashboard/lieferanten/bestand/[propertyId]/page.tsx:
    - 'use client' page
    - Title: Property name + "Bestandsverlauf" (Inventory History)
    - Section 1: Current InventoryLevelCard for this property
    - Section 2: Table of inventory movements for this property (date, type, level, consumption, usage rate, notes)
    - Button to record new reading (InventoryMovementForm pre-filled with property)
    - Back link to /dashboard/lieferanten/bestand

    Export new components from src/components/suppliers/index.ts (update barrel file).
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - All 3 components export correctly
    - Both dashboard pages render without build errors: `npx next build` (or check with tsc)
    - grep confirms fetch calls target correct API routes
  </verify>
  <done>
    User can navigate to /dashboard/lieferanten/bestand and see all property inventory levels with alerts. User can record tank readings via form. User can drill into property detail and see movement history. Insufficient data shown when <2 readings.
  </done>
</task>

</tasks>

<verification>
- All API routes return proper responses with auth checks
- InventoryMovementForm submits and creates movement
- InventoryLevelCard shows level percentage with color coding
- ReorderAlertList shows alerts sorted by urgency
- Dashboard pages fetch and display data
- `npx tsc --noEmit` passes
</verification>

<success_criteria>
- POST /api/inventory-movements creates reading with auto-calculated consumption rate
- GET /api/reorder-alerts returns alerts with urgency classification
- /dashboard/lieferanten/bestand shows inventory overview with alerts
- /dashboard/lieferanten/bestand/[propertyId] shows movement history for specific property
- "Keine Verbrauchsdaten" shown when insufficient readings for rate calculation
</success_criteria>

<output>
After completion, create `.planning/phases/20-supplier-advanced/20-02-SUMMARY.md`
</output>
