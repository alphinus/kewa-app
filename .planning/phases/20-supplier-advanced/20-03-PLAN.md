---
phase: 20-supplier-advanced
plan: 03
type: execute
wave: 2
depends_on: ["20-01"]
files_modified:
  - src/lib/suppliers/analytics-queries.ts
  - src/app/api/suppliers/analytics/price-history/route.ts
  - src/app/api/suppliers/analytics/consumption/route.ts
  - src/app/api/purchase-orders/[id]/allocations/route.ts
  - src/components/suppliers/PriceHistoryChart.tsx
  - src/components/suppliers/ConsumptionPatternChart.tsx
  - src/components/suppliers/MultiPropertyOrderForm.tsx
  - src/app/dashboard/lieferanten/analytics/preise/page.tsx
  - src/app/dashboard/lieferanten/analytics/verbrauch/page.tsx
autonomous: true

must_haves:
  truths:
    - "User can view price history chart showing CHF/tonne over time"
    - "User can view seasonal consumption patterns grouped by month with year context"
    - "User can create multi-property allocations on a purchase order"
    - "Allocation validation prevents total exceeding PO amount"
    - "Price history page allows filtering by supplier and date range"
    - "Consumption page shows monthly averages per property"
  artifacts:
    - path: "src/app/api/suppliers/analytics/price-history/route.ts"
      provides: "GET endpoint returning delivery price history"
      exports: ["GET"]
    - path: "src/app/api/suppliers/analytics/consumption/route.ts"
      provides: "GET endpoint returning seasonal consumption data"
      exports: ["GET"]
    - path: "src/app/api/purchase-orders/[id]/allocations/route.ts"
      provides: "GET and POST for PO allocations"
      exports: ["GET", "POST"]
    - path: "src/components/suppliers/PriceHistoryChart.tsx"
      provides: "Recharts LineChart for price trends"
    - path: "src/components/suppliers/ConsumptionPatternChart.tsx"
      provides: "Recharts AreaChart for seasonal consumption"
    - path: "src/components/suppliers/MultiPropertyOrderForm.tsx"
      provides: "Form for allocating PO across properties"
    - path: "src/app/dashboard/lieferanten/analytics/preise/page.tsx"
      provides: "Price history dashboard page"
    - path: "src/app/dashboard/lieferanten/analytics/verbrauch/page.tsx"
      provides: "Consumption patterns dashboard page"
  key_links:
    - from: "src/app/api/suppliers/analytics/price-history/route.ts"
      to: "delivery_price_history view"
      via: "supabase.from('delivery_price_history')"
      pattern: "from\\('delivery_price_history'\\)"
    - from: "src/app/api/suppliers/analytics/consumption/route.ts"
      to: "seasonal_consumption view"
      via: "supabase.from('seasonal_consumption')"
      pattern: "from\\('seasonal_consumption'\\)"
    - from: "src/app/api/purchase-orders/[id]/allocations/route.ts"
      to: "purchase_order_allocations table"
      via: "supabase.from('purchase_order_allocations')"
      pattern: "from\\('purchase_order_allocations'\\)"
    - from: "src/components/suppliers/PriceHistoryChart.tsx"
      to: "recharts"
      via: "import { LineChart } from 'recharts'"
      pattern: "from 'recharts'"
    - from: "src/components/suppliers/ConsumptionPatternChart.tsx"
      to: "recharts"
      via: "import { AreaChart } from 'recharts'"
      pattern: "from 'recharts'"
---

<objective>
Build price analytics APIs, consumption pattern analytics, multi-property order allocations, and corresponding chart components and dashboard pages.

Purpose: Users can analyze pricing trends, understand seasonal consumption, and create bulk orders distributed across properties.
Output: 3 API routes, 3 UI components, 2 dashboard pages, 1 lib utility file.
</objective>

<execution_context>
@C:\Users\Mario Giacchino\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\Mario Giacchino\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/20-supplier-advanced/20-01-SUMMARY.md
@src/types/suppliers.ts
@src/app/api/purchase-orders/route.ts
@src/app/api/purchase-orders/[id]/route.ts
@src/components/suppliers/PurchaseOrderForm.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create analytics and allocation API routes</name>
  <files>
    src/lib/suppliers/analytics-queries.ts
    src/app/api/suppliers/analytics/price-history/route.ts
    src/app/api/suppliers/analytics/consumption/route.ts
    src/app/api/purchase-orders/[id]/allocations/route.ts
  </files>
  <action>
    Create src/lib/suppliers/analytics-queries.ts:
    - Function `getPriceHistory(supabase, filters?)` — queries delivery_price_history view. Optional filters: supplier_id, property_id, date_from, date_to. Joins supplier name from partners table (or rely on view if view includes it — check view definition). Returns PriceHistoryPoint[].
    - Function `getSeasonalConsumption(supabase, propertyId?)` — queries seasonal_consumption view. Optional property_id filter. Returns SeasonalConsumption[].
    - Function `getMonthName(month: number)` — returns German month name ('Januar', 'Februar', ..., 'Dezember').
    - Function `getAllocations(supabase, purchaseOrderId)` — queries purchase_order_allocations for PO, joins property name. Returns PurchaseOrderAllocation[].
    - Function `createAllocation(supabase, input: CreateAllocationInput)` — inserts into purchase_order_allocations. Returns created record.

    Create src/app/api/suppliers/analytics/price-history/route.ts:
    - GET: Return price history data. Query params: supplier_id (optional), property_id (optional), from (date string, optional), to (date string, optional). Call getPriceHistory. Join supplier name from partners and property name from properties. Return { prices, filters_applied }.
    - Auth: kewa/imeri roles.

    Create src/app/api/suppliers/analytics/consumption/route.ts:
    - GET: Return seasonal consumption data. Query params: property_id (optional). Call getSeasonalConsumption. Enrich each row with monthName using getMonthName. Join property name from properties. Return { consumption, property_id }.
    - Auth: kewa/imeri roles.

    Create src/app/api/purchase-orders/[id]/allocations/route.ts:
    - GET: List allocations for a PO. Call getAllocations. Return { allocations, purchase_order_id }.
    - POST: Create allocation for a PO. Body: { property_id, building_id?, allocated_quantity, allocated_amount, notes? }. Set purchase_order_id from URL params. Call createAllocation. The DB trigger validates totals do not exceed PO amount — if trigger raises exception, catch and return 400 with message. Return { allocation } with 201.
    - Auth: kewa/imeri roles.

    Follow existing API route patterns (try-catch, header auth, NextResponse.json).
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - Each route file exports correct HTTP methods
    - grep confirms queries reference correct views/tables
  </verify>
  <done>
    GET /api/suppliers/analytics/price-history returns price trends with filtering. GET /api/suppliers/analytics/consumption returns seasonal data with German month names. POST /api/purchase-orders/[id]/allocations creates allocation with server-side validation.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create chart components, allocation form, and dashboard pages</name>
  <files>
    src/components/suppliers/PriceHistoryChart.tsx
    src/components/suppliers/ConsumptionPatternChart.tsx
    src/components/suppliers/MultiPropertyOrderForm.tsx
    src/app/dashboard/lieferanten/analytics/preise/page.tsx
    src/app/dashboard/lieferanten/analytics/verbrauch/page.tsx
  </files>
  <action>
    Create src/components/suppliers/PriceHistoryChart.tsx:
    - 'use client' component using Recharts
    - Props: data (PriceHistoryPoint[]), title? (string)
    - ResponsiveContainer wrapping LineChart with height 400
    - XAxis: date formatted with toLocaleDateString('de-CH')
    - YAxis: CHF/Tonne label, formatted with formatCHF from @/lib/utils (or inline CHF format)
    - CartesianGrid with strokeDasharray="3 3"
    - Tooltip showing formatted date and price
    - Legend
    - Line: monotone type, blue stroke (#3b82f6), strokeWidth 2, dots
    - Empty state: "Keine Preisdaten vorhanden" when data is empty

    Create src/components/suppliers/ConsumptionPatternChart.tsx:
    - 'use client' component using Recharts
    - Props: data (SeasonalConsumption[] enriched with monthName), title? (string)
    - ResponsiveContainer wrapping AreaChart with height 400
    - Gradient fill (linearGradient blue from 0.8 to 0.1 opacity)
    - XAxis: monthName
    - YAxis: "Durchschn. Menge (Tonnen)" label
    - Tooltip showing quantity formatted to 2 decimals with "Tonnen" suffix
    - Area: monotone type, blue stroke, gradient fill
    - Caption text below: "Durchschnittlicher Verbrauch pro Monat basierend auf historischen Lieferungen"
    - Empty state: "Keine Verbrauchsdaten vorhanden"

    Create src/components/suppliers/MultiPropertyOrderForm.tsx:
    - 'use client' component
    - Props: purchaseOrderId (string), totalQuantity (number), totalAmount (number), properties (Property[]), onSuccess callback
    - State: allocations array, loading, error
    - Fetch existing allocations on mount (GET /api/purchase-orders/{id}/allocations)
    - Each allocation row: property selector, quantity input (number step 0.01), amount (auto-calculated from quantity * unit_price where unit_price = totalAmount / totalQuantity)
    - Add/remove allocation rows
    - Summary section showing: allocated quantity, remaining quantity, allocated amount, remaining amount
    - Validation: warn if remaining < 0 (over-allocated), disable submit
    - On save each allocation: POST to /api/purchase-orders/{id}/allocations
    - German labels throughout: "Verteilung auf Liegenschaften", "Liegenschaft waehlen...", "Menge", "Betrag", "+ Liegenschaft hinzufuegen", "Entfernen"

    Create src/app/dashboard/lieferanten/analytics/preise/page.tsx:
    - 'use client' page
    - Title: "Preisentwicklung" (Price Development)
    - Filter bar: supplier dropdown (fetch from /api/suppliers), date range (from/to date inputs)
    - PriceHistoryChart component displaying filtered data
    - Fetch from /api/suppliers/analytics/price-history with filter params
    - Loading/error states

    Create src/app/dashboard/lieferanten/analytics/verbrauch/page.tsx:
    - 'use client' page
    - Title: "Saisonaler Verbrauch" (Seasonal Consumption)
    - Filter: property dropdown (fetch from /api/properties or use properties from context)
    - ConsumptionPatternChart component
    - Fetch from /api/suppliers/analytics/consumption with property filter
    - Loading/error states

    Update src/components/suppliers/index.ts to export new components.
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - All 3 components export correctly from barrel file
    - Both dashboard pages exist and import correct components
    - grep confirms Recharts imports (LineChart, AreaChart, ResponsiveContainer)
    - grep confirms fetch calls to analytics API routes
  </verify>
  <done>
    PriceHistoryChart renders CHF/tonne over time with de-CH formatting. ConsumptionPatternChart renders seasonal AreaChart with German labels. MultiPropertyOrderForm allows allocating PO across properties with validation. Analytics pages display charts with supplier/property/date filtering.
  </done>
</task>

</tasks>

<verification>
- Price history chart renders with proper CHF formatting and date labels
- Consumption chart shows seasonal patterns by month with year context
- Multi-property allocation prevents over-allocation (server + client validation)
- Analytics pages load with proper filtering
- `npx tsc --noEmit` passes
</verification>

<success_criteria>
- /dashboard/lieferanten/analytics/preise shows price trends filterable by supplier and date range
- /dashboard/lieferanten/analytics/verbrauch shows seasonal consumption filterable by property
- Multi-property allocation form validates totals against PO amount
- Charts use Recharts with German labels and CHF formatting
- Empty states shown when no data available
</success_criteria>

<output>
After completion, create `.planning/phases/20-supplier-advanced/20-03-SUMMARY.md`
</output>
