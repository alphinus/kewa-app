---
phase: 37-rls-context-wiring
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/supabase/with-org.ts
  - src/middleware.ts
autonomous: true
requirements:
  - RLS-02
  - RLS-03
must_haves:
  truths:
    - "Middleware resolves organization_id from cookie or user's default org and sets x-organization-id response header"
    - "createOrgClient(request) reads x-organization-id header, creates Supabase client, calls set_org_context RPC, and returns the client"
    - "createOrgClient throws OrgContextMissingError (mapped to 401) when x-organization-id header is absent"
    - "createPublicClient() creates a Supabase client without org context for global/public tables"
    - "createServiceClient() creates a Supabase client with service_role key for admin operations"
  artifacts:
    - path: "src/lib/supabase/with-org.ts"
      provides: "createOrgClient, createPublicClient, createServiceClient, OrgContextMissingError"
      exports: ["createOrgClient", "createPublicClient", "createServiceClient", "OrgContextMissingError"]
    - path: "src/middleware.ts"
      provides: "x-organization-id response header on authenticated requests"
      contains: "x-organization-id"
  key_links:
    - from: "src/middleware.ts"
      to: "organization_members table"
      via: "Supabase query for default org when cookie absent"
      pattern: "organization_members"
    - from: "src/lib/supabase/with-org.ts"
      to: "076_rls_helpers.sql set_org_context"
      via: "supabase.rpc('set_org_context')"
      pattern: "rpc.*set_org_context"
    - from: "src/lib/supabase/with-org.ts"
      to: "src/middleware.ts"
      via: "x-organization-id header"
      pattern: "x-organization-id"
---

<objective>
Create the TypeScript org-context layer: (1) enhance middleware to resolve and set x-organization-id header, (2) create createOrgClient/createPublicClient/createServiceClient helpers in a new file.

Purpose: Bridge between middleware org resolution and database RLS context — every tenant query flows through createOrgClient which sets the Postgres session variable via RPC.
Output: `src/lib/supabase/with-org.ts` (new), `src/middleware.ts` (modified)
</objective>

<execution_context>
@C:/Users/Mario Giacchino/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Mario Giacchino/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/37-rls-context-wiring/37-RESEARCH.md
@.planning/phases/37-rls-context-wiring/37-CONTEXT.md
@src/middleware.ts
@src/lib/supabase/server.ts
@src/lib/session.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create src/lib/supabase/with-org.ts — org-aware Supabase client helpers</name>
  <files>src/lib/supabase/with-org.ts</files>
  <action>
Create `src/lib/supabase/with-org.ts` with these exports:

**1. OrgContextMissingError class**
Custom error extending Error. Used by route handlers to distinguish org context failures from other errors and return 401.

**2. createOrgClient(request: NextRequest): Promise&lt;SupabaseClient&gt;**
- Read `x-organization-id` from `request.headers.get('x-organization-id')`
- If absent or empty: throw `new OrgContextMissingError('x-organization-id header required')`
- Create a Supabase server client using `createServerClient` from `@supabase/ssr` with `cookies()` from `next/headers` — same pattern as existing `server.ts` createClient
- Call `await supabase.rpc('set_org_context', { org_id: orgId })`
- If RPC returns error: throw `new Error('Failed to set org context: ' + error.message)`
- Return the supabase client

**3. createPublicClient(): Promise&lt;SupabaseClient&gt;**
- Same as current `createClient()` from `server.ts` — uses anon key, no org context
- For global lookup tables (ticket_categories, users, roles, permissions) and auth/portal routes

**4. createServiceClient(): Promise&lt;SupabaseClient&gt;**
- Create Supabase client using `SUPABASE_SERVICE_ROLE_KEY` env var (not anon key)
- Uses `createClient` from `@supabase/supabase-js` (not `@supabase/ssr`) since no cookie handling needed
- For admin operations that bypass RLS (user management, cross-org admin tasks)
- Throws if SUPABASE_SERVICE_ROLE_KEY is not set

Import `NextRequest` from `next/server`. Import `createServerClient` from `@supabase/ssr`. Import `cookies` from `next/headers`. Import `createClient as createBareClient` from `@supabase/supabase-js` for service client.

Do NOT re-export from `server.ts`. The old `createClient` in `server.ts` remains untouched — routes will be migrated in Plan 37-03/37-04.
  </action>
  <verify>
- File exists at `src/lib/supabase/with-org.ts`
- Exports: `createOrgClient`, `createPublicClient`, `createServiceClient`, `OrgContextMissingError`
- `createOrgClient` reads `x-organization-id` header and calls `supabase.rpc('set_org_context', ...)`
- `createOrgClient` throws `OrgContextMissingError` when header missing
- `createPublicClient` creates plain anon-key client (same as server.ts createClient)
- `createServiceClient` uses `SUPABASE_SERVICE_ROLE_KEY`
- TypeScript compiles: `npx tsc --noEmit src/lib/supabase/with-org.ts` (or check with full project build)
  </verify>
  <done>with-org.ts exports 3 client factories and 1 error class, createOrgClient calls set_org_context RPC, fail-fast on missing header</done>
</task>

<task type="auto">
  <name>Task 2: Enhance middleware to set x-organization-id header</name>
  <files>src/middleware.ts</files>
  <action>
Modify the main `middleware()` function in `src/middleware.ts`. After the session validation succeeds and before creating the `response = NextResponse.next()`, add org resolution logic:

**After line 81 (`// Valid session - continue with session data in response headers`) and before `const response = NextResponse.next()`:**

1. Read org cookie: `const orgCookie = request.cookies.get('organization_id')?.value`
2. Initialize: `let orgId = orgCookie || null`
3. If no orgCookie:
   - Import `createClient` from `@/lib/supabase/server` at top of file
   - Create a plain Supabase client: `const supabase = await createClient()`
   - Query default org: `const { data } = await supabase.from('organization_members').select('organization_id').eq('user_id', session.userId).eq('is_default', true).single()`
   - Set `orgId = data?.organization_id || null`
4. After `const response = NextResponse.next()`, add: `if (orgId) { response.headers.set('x-organization-id', orgId) }`

**Important constraints:**
- Do NOT touch contractor route handling (`handleContractorRoute`) — contractors have no org context
- Do NOT touch portal route handling (`handlePortalRoute`) — portal has separate session
- The org resolution only runs for the main authenticated flow (dashboard + API routes that pass session validation)
- The `organization_members` table does NOT have RLS (it's a global table, not in the 62-table list), so the plain createClient query works without org context
- Import `createClient` from `@/lib/supabase/server` (NOT from `with-org.ts`)
  </action>
  <verify>
- `grep 'x-organization-id' src/middleware.ts` shows the header being set
- `grep 'organization_members' src/middleware.ts` shows the default org lookup
- `grep 'organization_id.*cookie' src/middleware.ts` shows cookie read
- Middleware still handles contractor/portal routes unchanged
- No circular imports (middleware imports from server.ts, not with-org.ts)
  </verify>
  <done>Middleware resolves org from cookie or default org_member, sets x-organization-id header on all authenticated responses</done>
</task>

</tasks>

<verification>
- `src/lib/supabase/with-org.ts` exists with 4 exports
- `src/middleware.ts` sets `x-organization-id` response header
- No circular dependency between with-org.ts and middleware.ts
- TypeScript compilation passes (no type errors in modified files)
</verification>

<success_criteria>
Middleware sets x-organization-id header on every authenticated request. createOrgClient reads it and sets Postgres session variable via RPC. createPublicClient and createServiceClient provide non-org alternatives.
</success_criteria>

<output>
After completion, create `.planning/phases/37-rls-context-wiring/37-02-SUMMARY.md`
</output>
