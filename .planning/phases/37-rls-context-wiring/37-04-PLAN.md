---
phase: 37-rls-context-wiring
plan: 04
type: execute
wave: 2
depends_on:
  - 37-02
files_modified:
  - src/lib/supabase/cached-queries.ts
  - src/lib/**/*.ts
  - src/app/dashboard/**/*.tsx
  - src/app/contractor/**/*.tsx
  - src/app/portal/**/*.tsx
  - src/app/admin/**/*.tsx
autonomous: true
requirements:
  - RLS-04
must_haves:
  truths:
    - "All 45 non-API files that import createClient from @/lib/supabase/server are migrated to the appropriate with-org client"
    - "cached-queries.ts uses createPublicClient (server components cannot call createOrgClient — they have no request object)"
    - "Dashboard server components and lib utilities for tenant data use createPublicClient (RLS context will be set via alternative pattern in Phase 38)"
    - "Portal/contractor lib files use createPublicClient"
    - "Zero non-API files import createClient from @/lib/supabase/server"
  artifacts:
    - path: "src/lib/supabase/cached-queries.ts"
      provides: "Cached query wrappers using createPublicClient"
      contains: "createPublicClient"
  key_links:
    - from: "src/lib/**/*.ts"
      to: "src/lib/supabase/with-org.ts"
      via: "import { createPublicClient } or import { createOrgClient }"
      pattern: "from '@/lib/supabase/with-org'"
---

<objective>
Migrate all 45 non-API files (lib utilities, server components, cached queries) from `createClient` (from `@/lib/supabase/server`) to the appropriate client from `with-org.ts`.

Purpose: Complete the migration so no file in the codebase uses the old createClient for data queries. Server components and lib utilities transition to createPublicClient (they cannot access request headers; org context for server components is deferred to Phase 38 when OrganizationProvider threads context through React).
Output: 45 files updated, zero remaining imports of createClient from server.ts outside of with-org.ts itself.
</objective>

<execution_context>
@C:/Users/Mario Giacchino/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Mario Giacchino/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/37-rls-context-wiring/37-RESEARCH.md
@.planning/phases/37-rls-context-wiring/37-02-SUMMARY.md
@src/lib/supabase/cached-queries.ts
@src/lib/supabase/with-org.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Migrate lib utility files to appropriate client</name>
  <files>src/lib/**/*.ts</files>
  <action>
Migrate all lib files that import from `@/lib/supabase/server`. Apply the appropriate client based on usage context:

**Files that are called from API route handlers (receive no request):**
These lib files are called by API routes which already set org context via createOrgClient. The lib file's Supabase client shares the same connection/session, so it uses createPublicClient (the org context is already set at the route level via RPC — the Postgres session variable persists for the connection's transaction scope).

**Import change for all lib files:**
```
// OLD:
import { createClient } from '@/lib/supabase/server'

// NEW:
import { createPublicClient } from '@/lib/supabase/with-org'
```

**Client instantiation change:**
```
// OLD:
const supabase = await createClient()

// NEW:
const supabase = await createPublicClient()
```

**Complete list of lib files to migrate (31 files):**
- `src/lib/audit.ts`
- `src/lib/magic-link.ts`
- `src/lib/admin/ticket-to-work-order.ts`
- `src/lib/comments/comment-queries.ts`
- `src/lib/contractor/queries.ts`
- `src/lib/costs/invoice-queries.ts`
- `src/lib/costs/unit-cost-queries.ts`
- `src/lib/dashboard/occupancy-queries.ts`
- `src/lib/inspections/defect-actions.ts`
- `src/lib/inspections/portal-tokens.ts`
- `src/lib/inspections/queries.ts`
- `src/lib/inspections/re-inspection.ts`
- `src/lib/inspections/signature-utils.ts`
- `src/lib/knowledge/search.ts`
- `src/lib/notifications/preferences.ts`
- `src/lib/notifications/queries.ts`
- `src/lib/notifications/send.ts`
- `src/lib/notifications/tenant-triggers.ts`
- `src/lib/notifications/triggers.ts`
- `src/lib/parking/parking-queries.ts`
- `src/lib/portal/message-queries.ts`
- `src/lib/portal/tenant-isolation.ts`
- `src/lib/portal/ticket-queries.ts`
- `src/lib/settings/queries.ts`
- `src/lib/supabase/cached-queries.ts`
- `src/lib/units/condition-queries.ts`
- `src/lib/units/timeline-queries.ts`
- `src/lib/work-orders/events.ts`

**IMPORTANT:** `src/lib/supabase/server.ts` itself is NOT migrated — it remains as-is. The `createPublicClient` in `with-org.ts` replicates its pattern. `server.ts` will be deprecated but not deleted (may have edge cases referencing it in Phase 38+).

**IMPORTANT:** `src/lib/supabase/with-org.ts` imports from server.ts internals (`@supabase/ssr`, `cookies`) — do NOT change with-org.ts itself.
  </action>
  <verify>
`grep -rl "from '@/lib/supabase/server'" src/lib/` returns ONLY `src/lib/supabase/cached-queries.ts` if it was handled, or zero files. The only allowed remaining reference is `src/lib/supabase/server.ts` itself (the file being kept).
Actually, verify: `grep -rl "from '@/lib/supabase/server'" src/lib/ --include='*.ts'` returns zero files (excluding server.ts itself since it doesn't import from itself).
  </verify>
  <done>All lib utility files use createPublicClient from with-org.ts, zero imports from @/lib/supabase/server remain in src/lib/ (except server.ts itself)</done>
</task>

<task type="auto">
  <name>Task 2: Migrate server components and page files</name>
  <files>src/app/dashboard/**/*.tsx, src/app/contractor/**/*.tsx, src/app/portal/**/*.tsx, src/app/admin/**/*.tsx</files>
  <action>
Migrate all server component/page files that import from `@/lib/supabase/server`:

**Import change (same for all):**
```
// OLD:
import { createClient } from '@/lib/supabase/server'

// NEW:
import { createPublicClient } from '@/lib/supabase/with-org'
```

**Client instantiation change:**
```
// OLD:
const supabase = await createClient()

// NEW:
const supabase = await createPublicClient()
```

**Server component files to migrate (14 files):**

Dashboard pages:
- `src/app/dashboard/wohnungen/[id]/page.tsx`
- `src/app/dashboard/projekte/[id]/page.tsx`
- `src/app/dashboard/projekte/[id]/aenderungsauftraege/page.tsx`
- `src/app/dashboard/kosten/wohnungen/[id]/page.tsx`
- `src/app/dashboard/kosten/rechnungen/page.tsx`
- `src/app/dashboard/kosten/projekte/[id]/page.tsx`
- `src/app/dashboard/kosten/page.tsx`
- `src/app/dashboard/kosten/export/page.tsx`
- `src/app/dashboard/knowledge/category/[id]/page.tsx`
- `src/app/dashboard/auftraege/page.tsx`
- `src/app/dashboard/vorlagen/abnahmen/page.tsx`
- `src/app/dashboard/aenderungsauftraege/[id]/page.tsx`

Contractor pages:
- `src/app/contractor/[token]/knowledge/[id]/page.tsx`
- `src/app/contractor/[token]/knowledge/page.tsx`

Portal pages:
- `src/app/portal/page.tsx`
- `src/app/portal/change-orders/[token]/page.tsx`

Admin page:
- `src/app/admin/page.tsx`

**Why createPublicClient for server components:** Server components run at request time but do NOT receive the NextRequest object. They cannot read the `x-organization-id` header. After RLS is enabled, these pages will show data for the org context set by the last RPC call on that connection (which is unreliable). Phase 38 (OrganizationProvider) will solve this by threading org context through React server components. For now, createPublicClient is the correct intermediate step — it makes the import migration complete while acknowledging that server component org scoping is a Phase 38 concern.

After both tasks, verify: `grep -rl "from '@/lib/supabase/server'" src/` should return ONLY `src/lib/supabase/server.ts` (the file itself) and `src/lib/supabase/with-org.ts` (if it imports from server.ts — actually it doesn't, it imports from @supabase/ssr directly).
  </action>
  <verify>
`grep -rl "from '@/lib/supabase/server'" src/` returns ONLY `src/lib/supabase/server.ts` itself (zero other files).
`grep -rl "createPublicClient" src/app/` returns the ~17 page files.
TypeScript compilation passes.
  </verify>
  <done>All server component and page files use createPublicClient, zero remaining createClient imports from server.ts anywhere in src/ except server.ts itself</done>
</task>

</tasks>

<verification>
- `grep -rl "from '@/lib/supabase/server'" src/ | grep -v 'src/lib/supabase/server.ts'` returns 0 files
- `grep -rl "createPublicClient\|createOrgClient" src/` returns 168+ files (123 API + 45 non-API)
- TypeScript compilation passes: `npx tsc --noEmit` (or next build succeeds)
- `src/lib/supabase/server.ts` still exists (not deleted, kept for potential edge cases)
</verification>

<success_criteria>
All 45 non-API files migrated from createClient to createPublicClient. The entire codebase (except server.ts itself) uses with-org.ts clients exclusively. Zero remaining imports of createClient from @/lib/supabase/server.
</success_criteria>

<output>
After completion, create `.planning/phases/37-rls-context-wiring/37-04-SUMMARY.md`
</output>
