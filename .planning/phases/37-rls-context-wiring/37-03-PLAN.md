---
phase: 37-rls-context-wiring
plan: 03
type: execute
wave: 2
depends_on:
  - 37-02
files_modified:
  - src/app/api/**/*.ts
  - src/app/api/**/*.tsx
autonomous: true
requirements:
  - RLS-04
must_haves:
  truths:
    - "All ~98 tenant API route files import createOrgClient from @/lib/supabase/with-org instead of createClient from @/lib/supabase/server"
    - "All ~25 public/portal/contractor/auth route files import createPublicClient from @/lib/supabase/with-org instead of createClient from @/lib/supabase/server"
    - "Every route handler using createOrgClient wraps it in try/catch returning 401 on OrgContextMissingError"
    - "Zero API route files import createClient from @/lib/supabase/server"
  artifacts:
    - path: "src/app/api/**/route.ts"
      provides: "Org-scoped API routes"
      contains: "createOrgClient"
  key_links:
    - from: "src/app/api/**/route.ts (tenant routes)"
      to: "src/lib/supabase/with-org.ts"
      via: "import { createOrgClient }"
      pattern: "createOrgClient"
    - from: "src/app/api/**/route.ts (public routes)"
      to: "src/lib/supabase/with-org.ts"
      via: "import { createPublicClient }"
      pattern: "createPublicClient"
---

<objective>
Migrate all 123 API route files from `createClient` (from `@/lib/supabase/server`) to the appropriate org-aware client (`createOrgClient`, `createPublicClient`, or `createServiceClient` from `@/lib/supabase/with-org`).

Purpose: Every tenant API query flows through createOrgClient, ensuring RLS context is set before any database operation.
Output: All 123 API route files updated.
</objective>

<execution_context>
@C:/Users/Mario Giacchino/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Mario Giacchino/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/37-rls-context-wiring/37-RESEARCH.md
@.planning/phases/37-rls-context-wiring/37-02-SUMMARY.md
@src/lib/supabase/with-org.ts
@src/app/api/buildings/route.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Migrate ~98 tenant API routes to createOrgClient</name>
  <files>src/app/api/**/route.ts, src/app/api/**/route.tsx</files>
  <action>
For each tenant API route file (list below), apply these mechanical transformations:

**Import change:**
```
// OLD:
import { createClient } from '@/lib/supabase/server'

// NEW:
import { createOrgClient } from '@/lib/supabase/with-org'
```

**Client instantiation change — in each handler function (GET, POST, PUT, PATCH, DELETE):**
```
// OLD:
const supabase = await createClient()

// NEW:
const supabase = await createOrgClient(request)
```

**Add error handling if not already in a try/catch:**
Every handler that uses createOrgClient MUST be inside a try/catch. Most handlers already have try/catch blocks. The `createOrgClient` call should be the first line inside the try block. If the function lacks try/catch, wrap the entire body.

**`request` parameter:** Most route handlers already accept `request: NextRequest`. Verify each handler has the `request` parameter. For handlers that don't use `request` yet (rare — some GET handlers may destructure differently), add `request: NextRequest` as the first parameter.

**Tenant route files (~98 files):**
All files in `src/app/api/` that are NOT in the public list below. Key directories:
- `src/app/api/buildings/**`
- `src/app/api/properties/**`
- `src/app/api/units/**`
- `src/app/api/rooms/**`
- `src/app/api/tasks/**`
- `src/app/api/projects/**`
- `src/app/api/renovation-projects/**`
- `src/app/api/work-orders/**`
- `src/app/api/expenses/**`
- `src/app/api/invoices/**`
- `src/app/api/payments/**`
- `src/app/api/partners/**`
- `src/app/api/purchase-orders/**`
- `src/app/api/deliveries/**`
- `src/app/api/inventory-movements/**`
- `src/app/api/suppliers/**`
- `src/app/api/change-orders/**`
- `src/app/api/inspections/**`
- `src/app/api/inspection-templates/**`
- `src/app/api/templates/**`
- `src/app/api/knowledge/**`
- `src/app/api/comments/**`
- `src/app/api/photos/**`
- `src/app/api/audio/**`
- `src/app/api/notifications/**`
- `src/app/api/costs/**`
- `src/app/api/reports/**`
- `src/app/api/admin/tickets/**`
- `src/app/api/reorder-alerts/**`

Verify by running: `grep -rl "from '@/lib/supabase/server'" src/app/api/` — the only remaining files should be the public routes (see Task 2).
  </action>
  <verify>
`grep -rl "createClient.*from.*supabase/server" src/app/api/` returns ONLY the public/portal/contractor/auth route files (Task 2 list) — no tenant routes remain on old import.
`grep -rl "createOrgClient" src/app/api/` returns ~98 files.
  </verify>
  <done>All tenant API routes use createOrgClient(request) with proper try/catch error handling</done>
</task>

<task type="auto">
  <name>Task 2: Migrate ~25 public/portal/contractor/auth routes to createPublicClient</name>
  <files>src/app/api/auth/**/route.ts, src/app/api/portal/**/route.ts, src/app/api/contractor/**/route.ts, src/app/api/settings/categories/**/route.ts</files>
  <action>
For each public route file (list below), change the import only — these routes must NOT call set_org_context:

**Import change:**
```
// OLD:
import { createClient } from '@/lib/supabase/server'

// NEW:
import { createPublicClient } from '@/lib/supabase/with-org'
```

**Client instantiation change:**
```
// OLD:
const supabase = await createClient()

// NEW:
const supabase = await createPublicClient()
```

No try/catch changes needed — createPublicClient never throws OrgContextMissingError.

**Public route files (~25 files):**

Auth routes (no org context, query global users/roles tables):
- `src/app/api/auth/login/route.ts`
- `src/app/api/auth/register/route.ts`
- `src/app/api/auth/magic-link/send/route.ts`
- `src/app/api/auth/magic-link/verify/route.ts`

Portal routes (separate session handling, no internal org context):
- `src/app/api/portal/auth/login/route.ts`
- `src/app/api/portal/auth/register/[token]/route.ts`
- `src/app/api/portal/auth/verify-invite/[token]/route.ts`
- `src/app/api/portal/auth/qr-login/route.ts`
- `src/app/api/portal/dashboard/route.ts`
- `src/app/api/portal/profile/route.ts`
- `src/app/api/portal/tickets/[id]/attachments/route.ts`
- `src/app/api/portal/inspections/[token]/route.ts`
- `src/app/api/portal/inspections/[token]/acknowledge/route.ts`
- `src/app/api/portal/change-orders/[token]/route.ts`
- `src/app/api/portal/change-orders/[token]/approve/route.ts`
- `src/app/api/portal/change-orders/[token]/reject/route.ts`

Contractor routes (magic link auth, no internal org context):
- `src/app/api/contractor/request-link/route.ts`
- `src/app/api/contractor/[token]/status/route.ts`
- `src/app/api/contractor/[token]/mark-viewed/route.ts`
- `src/app/api/contractor/[token]/[workOrderId]/respond/route.ts`
- `src/app/api/contractor/[token]/[workOrderId]/upload/route.ts`
- `src/app/api/contractor/[token]/[workOrderId]/media/route.ts`

Settings (global lookup tables):
- `src/app/api/settings/categories/route.ts`
- `src/app/api/settings/categories/[id]/route.ts`

After this task, `grep -rl "from '@/lib/supabase/server'" src/app/api/` should return ZERO results.
  </action>
  <verify>
`grep -rl "from '@/lib/supabase/server'" src/app/api/` returns ZERO files.
`grep -rl "createPublicClient" src/app/api/` returns ~25 files matching the public route list.
No `createOrgClient` import in any auth/portal/contractor/settings route.
  </verify>
  <done>All public/portal/contractor/auth routes use createPublicClient(), zero files import from @/lib/supabase/server in src/app/api/</done>
</task>

</tasks>

<verification>
- `grep -rl "from '@/lib/supabase/server'" src/app/api/` returns 0 files
- `grep -rl "createOrgClient" src/app/api/` returns ~98 files
- `grep -rl "createPublicClient" src/app/api/` returns ~25 files
- Total: ~123 files migrated (matching original grep count)
- No file imports both createOrgClient and createPublicClient
- TypeScript compilation passes
</verification>

<success_criteria>
All 123 API route files migrated from createClient to createOrgClient or createPublicClient. Zero remaining imports of createClient from @/lib/supabase/server in API routes.
</success_criteria>

<output>
After completion, create `.planning/phases/37-rls-context-wiring/37-03-SUMMARY.md`
</output>
