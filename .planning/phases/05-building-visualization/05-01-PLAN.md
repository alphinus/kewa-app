---
phase: 05-building-visualization
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/app/api/units/[id]/route.ts
autonomous: true

must_haves:
  truths:
    - "KEWA AG can update tenant name for a unit"
    - "KEWA AG can toggle visibility settings for Imeri"
    - "API returns updated unit data after modification"
  artifacts:
    - path: "src/app/api/units/[id]/route.ts"
      provides: "GET single unit + PUT for tenant/visibility updates"
      exports: ["GET", "PUT"]
  key_links:
    - from: "PUT /api/units/[id]"
      to: "supabase.units"
      via: "supabase update query"
      pattern: "supabase.*from.*units.*update"
---

<objective>
Create API endpoint for viewing and updating individual units.

Purpose: Enable KEWA AG to edit tenant names and visibility settings for units.
Output: `/api/units/[id]` endpoint with GET and PUT methods.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-task-management/02-01-SUMMARY.md

@src/types/database.ts
@src/app/api/units/route.ts
@src/lib/supabase/server.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create unit detail API endpoint</name>
  <files>src/app/api/units/[id]/route.ts</files>
  <action>
Create Next.js API route with GET and PUT handlers:

**GET /api/units/[id]:**
- Fetch single unit by ID from Supabase
- Include task statistics (open_tasks_count, total_tasks_count) using same aggregation pattern as /api/units
- For Imeri role: reject if tenant_visible_to_imeri=false (403)
- Return UnitWithStats object

**PUT /api/units/[id]:**
- KEWA role only (403 for Imeri)
- Accept body: { tenant_name?: string, tenant_visible_to_imeri?: boolean }
- Update unit in Supabase
- Return updated unit

Follow existing patterns from /api/units/route.ts:
- Auth check via x-user-id and x-user-role headers
- Error response format: { error: string }
- Success response format: { unit: UnitWithStats }

Add TypeScript types to database.ts if needed:
- UpdateUnitInput interface
- UnitResponse interface
  </action>
  <verify>
Build passes: npm run build
TypeScript: npm run type-check
  </verify>
  <done>
- GET /api/units/[id] returns single unit with task stats
- PUT /api/units/[id] updates tenant_name and visibility (KEWA only)
- Proper auth checks and error handling
  </done>
</task>

<task type="auto">
  <name>Task 2: Add TypeScript types for unit API</name>
  <files>src/types/database.ts</files>
  <action>
Add to database.ts:

```typescript
/**
 * Input for updating a unit
 */
export interface UpdateUnitInput {
  tenant_name?: string | null
  tenant_visible_to_imeri?: boolean
}

/**
 * Response for single unit operations
 */
export interface UnitResponse {
  unit: UnitWithStats
}
```

Place in appropriate sections (API INPUT TYPES and API RESPONSE TYPES).
  </action>
  <verify>npm run type-check passes</verify>
  <done>UpdateUnitInput and UnitResponse types exported</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds without errors
- [ ] `npm run type-check` passes
- [ ] GET /api/units/[id] endpoint exists with auth check
- [ ] PUT /api/units/[id] endpoint exists with KEWA-only check
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- No TypeScript errors
- Unit API supports view and update operations
  </success_criteria>

<output>
After completion, create `.planning/phases/05-building-visualization/05-01-SUMMARY.md`
</output>
