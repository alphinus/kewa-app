---
phase: 05-building-visualization
plan: 03
type: execute
wave: 2
depends_on: ["05-01", "05-02"]
files_modified:
  - src/components/building/UnitDetailModal.tsx
  - src/app/dashboard/gebaude/page.tsx
autonomous: false

must_haves:
  truths:
    - "KEWA AG sees building visualization at /dashboard/gebaude"
    - "Clicking a unit opens detail modal"
    - "KEWA AG can edit tenant name in the modal"
    - "KEWA AG can toggle visibility for Imeri"
    - "Common areas are displayed below the building grid"
  artifacts:
    - path: "src/app/dashboard/gebaude/page.tsx"
      provides: "Building visualization page"
      min_lines: 80
    - path: "src/components/building/UnitDetailModal.tsx"
      provides: "Modal for viewing/editing unit details"
      min_lines: 100
  key_links:
    - from: "gebaude/page.tsx"
      to: "/api/units"
      via: "fetch on mount"
      pattern: "fetch.*api/units"
    - from: "UnitDetailModal"
      to: "/api/units/[id]"
      via: "PUT on save"
      pattern: "fetch.*api/units.*PUT"
---

<objective>
Create building visualization page with unit detail modal.

Purpose: KEWA AG can view building overview and edit unit details.
Output: Working /dashboard/gebaude page with interactive building grid.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
@~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-building-visualization/05-01-SUMMARY.md
@.planning/phases/05-building-visualization/05-02-SUMMARY.md

@src/types/database.ts
@src/hooks/useSession.ts
@src/components/ui/button.tsx
@src/components/ui/input.tsx
@src/components/ui/card.tsx
@src/lib/utils.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create UnitDetailModal component</name>
  <files>src/components/building/UnitDetailModal.tsx</files>
  <action>
Create modal for viewing and editing unit details:

**Props:**
- unit: UnitWithStats | null (null = closed)
- onClose: () => void
- onSave: (updated: UnitWithStats) => void
- isKewa: boolean (determines if editable)

**Display (view mode for both roles):**
- Unit name (large, header)
- Unit type badge (Wohnung, Gemeinschaftsraum, Gebaeude)
- Floor info if applicable
- Task statistics: "5 offene Aufgaben von 12"
- Progress bar (same style as UnitCell)

**Edit section (KEWA only):**
- Tenant name input (label: "Mietername")
- Checkbox: "Sichtbar fuer Imeri" (tenant_visible_to_imeri)
- Save button

**Actions:**
- Save: PUT /api/units/[id] with form data
- Show loading state during save
- Show success/error feedback
- Close on successful save or cancel

**Styling:**
- Modal overlay with backdrop blur
- Slide-up on mobile (like TaskForm pattern)
- Max-width 500px on desktop, full-width on mobile
- Touch-friendly inputs (h-12)
- Close button (X) in top right

**Link to tasks:**
- Button: "Aufgaben anzeigen" - links to /dashboard/aufgaben?unit_id={id}
  </action>
  <verify>
Build passes: npm run build
TypeScript: npm run type-check
  </verify>
  <done>
- Modal displays unit info with progress
- KEWA can edit tenant name and visibility
- Save calls PUT /api/units/[id]
- Proper loading/error states
  </done>
</task>

<task type="auto">
  <name>Task 2: Create building page</name>
  <files>src/app/dashboard/gebaude/page.tsx</files>
  <action>
Create the building visualization page:

**Structure:**
- Page title: "Gebaeudeuebersicht"
- BuildingGrid component (apartments only)
- CommonAreasList component (common areas + building)
- UnitDetailModal (conditionally rendered)

**Data fetching:**
- Fetch /api/units on mount
- Filter into apartments (unit_type='apartment') and commonAreas (unit_type='common_area' or 'building')
- Show loading skeleton while fetching
- Handle errors with retry option

**State:**
- units: UnitWithStats[]
- selectedUnit: UnitWithStats | null
- loading: boolean
- error: string | null

**Interactions:**
- Click unit -> setSelectedUnit(unit)
- Modal onClose -> setSelectedUnit(null)
- Modal onSave -> update units array, close modal

**Role check:**
- Use useSession hook to get role
- Pass isKewa={role === 'kewa'} to modal
- Both roles can VIEW, only KEWA can EDIT

**Layout:**
- Building grid centered, max-width 600px
- Common areas below with section divider
- Responsive padding
- German text for all labels

**Refresh:**
- Refetch units after successful save in modal
  </action>
  <verify>
Build passes: npm run build
TypeScript: npm run type-check
  </verify>
  <done>
- Page fetches and displays units
- Building grid shows apartments by floor
- Common areas listed below
- Click opens detail modal
- Save updates reflect in UI
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Building visualization page with interactive grid and unit editing</what-built>
  <how-to-verify>
    1. Run: npm run dev
    2. Login as KEWA (PIN for KEWA role)
    3. Navigate to "Gebaeude" in bottom nav
    4. Verify building grid shows 5 floors (Dach to EG)
    5. Verify apartments arranged: 3 per floor, Dach spans full width
    6. Verify progress bars with color coding (may be empty if no tasks)
    7. Click any apartment -> modal opens
    8. Verify modal shows unit details
    9. Edit tenant name, save -> verify change persists
    10. Check "Gemeinschaftsbereiche" section below grid
    11. Test on mobile viewport (375px) -> verify touch-friendly
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds without errors
- [ ] `npm run type-check` passes
- [ ] /dashboard/gebaude page renders building grid
- [ ] UnitDetailModal allows editing tenant info (KEWA only)
- [ ] Visual verification passed
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- No TypeScript errors
- User approved visual layout
  </success_criteria>

<output>
After completion, create `.planning/phases/05-building-visualization/05-03-SUMMARY.md`
</output>
