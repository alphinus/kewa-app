# Plan 11-01: Unit Timeline View

## Frontmatter

```yaml
phase: 11
plan: 01
name: Unit Timeline View
wave: 1
depends_on: []
scope: medium
autonomous: true
files_modified:
  - src/types/timeline.ts
  - src/lib/units/timeline-queries.ts
  - src/components/units/UnitTimeline.tsx
  - src/app/dashboard/wohnungen/[id]/page.tsx
```

## Goal

Build a unified timeline view for units showing all renovation activities, costs, and condition changes chronologically. Users can see the complete history of what happened to a unit.

## Requirements Addressed

- **HIST-01**: Unit hat Timeline aller Projekte/WorkOrders/Kosten/Media

## Context

From research (11-RESEARCH.md):
- Database infrastructure already complete (condition_history, work_order_events, etc.)
- UI pattern exists in EventLog.tsx
- Need to aggregate from multiple sources: projects, work_orders, condition_history, invoices

## Tasks

<task id="01" title="Create timeline types">
Create TypeScript types for unified timeline events.

**File:** `src/types/timeline.ts`

```typescript
export type TimelineEventType = 'project' | 'work_order' | 'condition' | 'cost' | 'media'

export interface TimelineEvent {
  id: string
  event_type: TimelineEventType
  event_subtype: string // e.g., 'created', 'completed', 'approved'
  title: string
  description?: string
  entity_id: string
  timestamp: string
  metadata?: {
    status?: string
    amount?: number
    condition?: string
    media_url?: string
  }
}
```
</task>

<task id="02" title="Create timeline query module" depends_on="01">
Build the unified timeline query that aggregates events from multiple sources.

**File:** `src/lib/units/timeline-queries.ts`

**Requirements:**
- Fetch from: renovation_projects, work_orders, condition_history, invoices (paid)
- Filter by unit_id
- Order by timestamp DESC
- Support pagination (limit/offset)
- Server-side query module (use createClient)

**Query pattern:**
```sql
WITH timeline_events AS (
  -- Projects
  SELECT 'project', id, status, name, updated_at FROM renovation_projects WHERE unit_id = $1
  UNION ALL
  -- Work orders via project
  SELECT 'work_order', wo.id, wo.status, wo.title, wo.updated_at
  FROM work_orders wo
  JOIN renovation_projects rp ON wo.renovation_project_id = rp.id
  WHERE rp.unit_id = $1
  UNION ALL
  -- Condition changes via rooms
  SELECT 'condition', ch.id, ch.new_condition, r.name, ch.changed_at
  FROM condition_history ch
  JOIN rooms r ON ch.entity_id = r.id AND ch.entity_type = 'room'
  WHERE r.unit_id = $1
  UNION ALL
  -- Paid invoices
  SELECT 'cost', i.id, 'paid', i.title, i.paid_at
  FROM invoices i
  JOIN renovation_projects rp ON i.renovation_project_id = rp.id
  WHERE rp.unit_id = $1 AND i.paid_at IS NOT NULL
)
SELECT * FROM timeline_events ORDER BY timestamp DESC LIMIT $2 OFFSET $3;
```

Export: `fetchUnitTimeline(unitId: string, limit?: number, offset?: number)`
</task>

<task id="03" title="Create UnitTimeline component" depends_on="01,02">
Build the timeline UI component following EventLog.tsx pattern.

**File:** `src/components/units/UnitTimeline.tsx`

**Requirements:**
- Display events chronologically with icons per type
- Event type icons:
  - project: ClipboardDocumentList
  - work_order: WrenchScrewdriver
  - condition: SparklesIcon
  - cost: CurrencyDollarIcon
- Color coding per status/type
- Expandable details on click
- "Mehr laden" button for pagination
- Empty state: "Keine Aktivitäten für diese Wohnung"
- Loading skeleton state

**Follow pattern from:** `src/components/admin/work-orders/EventLog.tsx`

**Props:**
```typescript
interface UnitTimelineProps {
  unitId: string
  className?: string
}
```
</task>

<task id="04" title="Integrate timeline into unit detail page" depends_on="03">
Add the timeline component to the existing unit detail page.

**File:** `src/app/dashboard/wohnungen/[id]/page.tsx`

**Requirements:**
- Add new section "Verlauf" (History) after existing content
- Use UnitTimeline component
- Section header with icon (ClockIcon)
- Responsive: full width on mobile, constrained on desktop

If page doesn't exist, create it following existing dashboard patterns (e.g., `/dashboard/kosten/wohnungen/[id]/page.tsx`).
</task>

## Verification

<verification>
- [ ] Timeline types exported from `src/types/timeline.ts`
- [ ] Query function returns events from all 4 sources (projects, work_orders, condition_history, invoices)
- [ ] UnitTimeline component renders with correct icons per event type
- [ ] Pagination works (load more button fetches next batch)
- [ ] Empty state shown when unit has no events
- [ ] No TypeScript errors
- [ ] Build succeeds: `npm run build`
</verification>

## Must Haves (Goal-Backward)

```yaml
must_haves:
  - "Unit timeline shows renovation project events"
  - "Unit timeline shows work order events"
  - "Unit timeline shows condition change events"
  - "Unit timeline shows cost/invoice events"
  - "Events sorted chronologically (newest first)"
  - "Timeline accessible from unit detail view"
```
