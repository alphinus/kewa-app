# Plan 11-03: Condition Automation Verification

## Frontmatter

```yaml
phase: 11
plan: 03
name: Condition Automation Verification
wave: 1
depends_on: []
scope: small
autonomous: true
files_modified:
  - supabase/migrations/038_condition_trigger_enhancement.sql
  - src/app/dashboard/wohnungen/[id]/page.tsx
```

## Goal

Verify that the existing automation triggers correctly update room conditions when projects are approved, and ensure the condition history is properly recorded with source references.

## Requirements Addressed

- **HIST-03**: Raum-Condition wird aus abgeschlossenen Projekten abgeleitet
- **HIST-04**: Automation: Projekt approved -> Raum=new mit Datum+Media+Projekt-ID

## Context

From research (11-RESEARCH.md):
- Trigger `on_project_approved()` already exists in migration 027
- Updates rooms to 'new' condition when project is approved
- Records in `condition_history` with `source_project_id`
- Need to verify it works and potentially enhance media linking

## Tasks

<task id="01" title="Verify existing trigger functionality">
Test that the existing trigger works correctly.

**Steps:**
1. Read migration 027_condition_tracking.sql to understand current implementation
2. Check if trigger is attached to renovation_projects table
3. Document the trigger flow:
   - Project status changes to 'approved'
   - Trigger fires
   - Affected rooms (via tasks with room_id) get condition = 'new'
   - condition_history record created

**Verification SQL to run manually:**
```sql
-- Check trigger exists
SELECT tgname, tgrelid::regclass
FROM pg_trigger
WHERE tgname LIKE '%project%approved%';

-- Check condition_history has records
SELECT COUNT(*) FROM condition_history;
```

Document findings in task output.
</task>

<task id="02" title="Review task-room linkage">
Ensure tasks have room_id set for the automation to work.

**Check:**
1. Review how tasks are created from templates (template application)
2. Verify tasks get room_id assigned
3. If room_id is optional, document when it's set

**Key query:**
```sql
-- Check tasks with room assignments
SELECT
  COUNT(*) as total_tasks,
  COUNT(room_id) as tasks_with_room
FROM tasks;
```

If tasks frequently lack room_id, the trigger won't update conditions. Document this as a known limitation or suggest enhancement.
</task>

<task id="03" title="Add condition history display to unit page">
Show recent condition changes in the unit detail view.

**File:** `src/app/dashboard/wohnungen/[id]/page.tsx`

**Requirements:**
- Add small section showing recent condition history entries
- Use existing `room_condition_timeline` view
- Display: room name, old -> new condition, date, source project name
- Limit to 5 most recent changes
- Link "Alle anzeigen" to timeline

**Query:**
```sql
SELECT * FROM room_condition_timeline
WHERE unit_id = $1
ORDER BY changed_at DESC
LIMIT 5;
```
</task>

<task id="04" title="Document automation behavior">
Create clear documentation of how the automation works.

**Add comment block to unit page or create inline documentation:**

```typescript
/**
 * Condition Automation (HIST-03, HIST-04)
 *
 * When a renovation_project status changes to 'approved':
 * 1. Trigger `on_project_approved()` fires
 * 2. All tasks with status='completed' and room_id set are found
 * 3. Those rooms get condition='new', condition_updated_at=NOW()
 * 4. A condition_history record is created with source_project_id
 *
 * Prerequisites:
 * - Tasks must have room_id assigned
 * - Tasks must be marked 'completed' before project approval
 *
 * Limitations:
 * - All affected rooms become 'new' (no partial detection)
 * - media_ids not auto-populated (enhancement for future)
 */
```
</task>

## Verification

<verification>
- [ ] Trigger exists on renovation_projects table
- [ ] Trigger logic correctly identifies affected rooms via tasks
- [ ] condition_history records created with source_project_id
- [ ] Recent condition changes visible on unit detail page
- [ ] Documentation added explaining automation flow
- [ ] No TypeScript errors
- [ ] Build succeeds: `npm run build`
</verification>

## Must Haves (Goal-Backward)

```yaml
must_haves:
  - "Automation trigger verified to exist and function"
  - "Room conditions update when project approved"
  - "Condition changes recorded in history with source reference"
  - "Recent condition changes visible in unit UI"
  - "Automation behavior documented"
```

## Notes

This plan is primarily verification and integration, not new feature development. The core automation was implemented in Phase 7. Success means confirming it works and making the results visible to users.

If testing reveals the trigger doesn't work, create a follow-up task to fix it rather than blocking this plan.
