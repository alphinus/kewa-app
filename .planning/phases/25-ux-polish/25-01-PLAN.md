---
phase: 25-ux-polish
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/suppliers/InvoiceLinkModal.tsx
  - src/app/dashboard/lieferanten/bestellungen/[id]/page.tsx
  - src/components/inspections/ChecklistExecution.tsx
  - src/lib/inspections/queries.ts
  - src/app/dashboard/liegenschaft/[id]/page.tsx
autonomous: true

must_haves:
  truths:
    - "Invoice linking opens a search/select modal instead of browser prompt()"
    - "Modal shows invoices filtered by the same supplier as the purchase order"
    - "Checklist items display their template-defined title and description"
    - "Property detail page shows delivery history with dates, quantities, and linked orders"
  artifacts:
    - path: "src/components/suppliers/InvoiceLinkModal.tsx"
      provides: "Invoice search/select modal for delivery linking"
      min_lines: 60
    - path: "src/app/dashboard/liegenschaft/[id]/page.tsx"
      provides: "Property detail page with delivery history"
      min_lines: 80
  key_links:
    - from: "src/app/dashboard/lieferanten/bestellungen/[id]/page.tsx"
      to: "src/components/suppliers/InvoiceLinkModal.tsx"
      via: "handleLinkInvoice opens modal instead of prompt()"
      pattern: "InvoiceLinkModal"
    - from: "src/components/inspections/ChecklistExecution.tsx"
      to: "inspection.template"
      via: "template checklist_sections lookup for item titles"
      pattern: "template.*checklist_sections"
    - from: "src/app/dashboard/liegenschaft/[id]/page.tsx"
      to: "/api/deliveries?property_id="
      via: "fetch deliveries filtered by property"
      pattern: "api/deliveries.*property_id"
---

<objective>
Fix three v2.2 UAT issues: replace prompt()-based invoice linking with a proper search/select modal, display checklist item titles from their template instead of "Item 1/2/3", and create a property-level delivery history page.

Purpose: Resolves UX debt carried from v2.2 UAT before starting v3.0 features.
Output: InvoiceLinkModal component, fixed ChecklistExecution, new property detail page with delivery history.
</objective>

<execution_context>
@C:\Users\Mario Giacchino\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\Mario Giacchino\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@src/app/dashboard/lieferanten/bestellungen/[id]/page.tsx
@src/components/suppliers/DeliveryList.tsx
@src/components/ui/dialog.tsx
@src/components/inspections/ChecklistExecution.tsx
@src/components/inspections/ChecklistItemCard.tsx
@src/lib/inspections/queries.ts
@src/types/inspections.ts
@src/types/suppliers.ts
@src/app/api/deliveries/route.ts
@src/app/api/deliveries/[id]/link-invoice/route.ts
@src/app/api/invoices/route.ts
@src/app/dashboard/liegenschaft/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Invoice link modal and checklist title fix</name>
  <files>
    src/components/suppliers/InvoiceLinkModal.tsx
    src/app/dashboard/lieferanten/bestellungen/[id]/page.tsx
    src/components/inspections/ChecklistExecution.tsx
    src/lib/inspections/queries.ts
  </files>
  <action>
**Invoice Link Modal (UXPL-01):**

Create `src/components/suppliers/InvoiceLinkModal.tsx`:
- Use existing Dialog/DialogContent/DialogHeader/DialogTitle/DialogFooter from `@/components/ui/dialog`
- Props: `{ open: boolean; onOpenChange: (open: boolean) => void; delivery: Delivery; supplierId: string; onLinked: () => void }`
- On mount, fetch invoices from `/api/invoices?partner_id={supplierId}&limit=50` (the API already supports partner_id filter)
- Display a list of invoices with: invoice_number, invoice_date, amount, status
- Add a text input at top for filtering the fetched list client-side (filter by invoice_number)
- Each invoice row has a "Verknuepfen" button
- On click, POST to `/api/deliveries/{delivery.id}/link-invoice` with `{ invoice_id: selectedInvoice.id }`
- On success, call `onLinked()` and close the modal
- On error, show inline error message in the modal (not alert())
- Handle loading/empty states: spinner while fetching, "Keine Rechnungen fuer diesen Lieferanten" if empty

Update `src/app/dashboard/lieferanten/bestellungen/[id]/page.tsx`:
- Import InvoiceLinkModal
- Add state: `const [linkDelivery, setLinkDelivery] = useState<Delivery | null>(null)`
- Replace the `handleLinkInvoice` function: instead of `prompt()`, set `setLinkDelivery(delivery)`
- Render `<InvoiceLinkModal>` at the bottom of the JSX, controlled by `linkDelivery !== null`
- Pass `supplierId={purchaseOrder.supplier?.id}` (the supplier ID from the purchase order)
- On `onLinked`, refresh deliveries via `setDeliveryRefreshKey(k => k + 1)` and refetch purchase order
- Remove the old `handleLinkInvoice` function body entirely -- no more `prompt()` or `.then()` chains

**Checklist Title Fix (UXPL-02):**

Update `src/lib/inspections/queries.ts`:
- Change `INSPECTION_SELECT` to include `checklist_sections` from the template join:
  ```
  template:inspection_templates(id, name, checklist_sections)
  ```
  This makes `inspection.template.checklist_sections` available on the client.

Update `src/components/inspections/ChecklistExecution.tsx`:
- Add a `useMemo` that builds a lookup map from template checklist_sections:
  ```typescript
  const templateItemMap = useMemo(() => {
    const map = new Map<string, { title: string; description: string | null }>()
    if (inspection.template?.checklist_sections) {
      for (const section of inspection.template.checklist_sections) {
        for (const item of section.items) {
          map.set(item.id, { title: item.title, description: item.description })
        }
      }
    }
    return map
  }, [inspection.template])
  ```
- Replace the hardcoded `item` prop in ChecklistItemCard (line ~230):
  ```typescript
  // BEFORE:
  item={{
    id: item.item_id,
    title: `Item ${index + 1}`,
    description: null,
  }}
  // AFTER:
  item={{
    id: item.item_id,
    title: templateItemMap.get(item.item_id)?.title || `Punkt ${index + 1}`,
    description: templateItemMap.get(item.item_id)?.description || null,
  }}
  ```
- Note: Use "Punkt" (German) as fallback instead of "Item"
- The `inspection.template` type in `src/types/inspections.ts` already has `template?: { id: string; name: string }` -- extend this inline to include `checklist_sections?: ChecklistSection[]` at the Inspection type's `template` field. Check the type definition and add `checklist_sections` to the joined template type if missing.
  </action>
  <verify>
1. `npx tsc --noEmit` passes without errors
2. Grep for `prompt(` in the purchase order detail page returns NO matches
3. Grep for `Item ${index` in ChecklistExecution returns NO matches (replaced with template lookup)
4. InvoiceLinkModal.tsx exists and imports Dialog components
  </verify>
  <done>
- Invoice linking uses a modal with supplier-filtered invoice list and search
- No prompt() calls remain in the purchase order detail page
- Checklist items display template-defined titles and descriptions
- Fallback "Punkt N" shown only when template data is missing
  </done>
</task>

<task type="auto">
  <name>Task 2: Property delivery history page</name>
  <files>
    src/app/dashboard/liegenschaft/[id]/page.tsx
  </files>
  <action>
**Delivery History Page (UXPL-03):**

Create `src/app/dashboard/liegenschaft/[id]/page.tsx`:
- This is a new page at path `/dashboard/liegenschaft/{buildingId}`
- Note: The existing liegenschaft page at `/dashboard/liegenschaft` uses `BuildingContext` to select a building (via `useBuilding()`). The `[id]` param here represents a building/property ID.
- Page structure:
  1. **Header** with breadcrumb: Dashboard > Liegenschaft > {buildingName}
  2. **Property/Building info card**: Fetch building info from `/api/buildings/{id}` -- show name, address if available
  3. **Delivery history section**: Fetch deliveries from `/api/deliveries?property_id={id}&limit=50`
     - Display as a table with columns: Datum, Lieferschein-Nr., Lieferant, Bestellt, Erhalten, Einheit, Bestellung, Rechnung
     - Use `formatSwissDate` from `@/lib/suppliers/purchase-order-queries`
     - Each row shows: `delivery.delivery_date`, `delivery.delivery_note_number`, `delivery.purchase_order?.supplier?.company_name`, `delivery.quantity_ordered`, `delivery.quantity_received`, `delivery.quantity_unit`, link to purchase order page, invoice number if linked
     - Sortable by date (default newest first, already sorted by API)
  4. **Empty state**: "Keine Lieferungen fuer diese Liegenschaft" with an icon
  5. **Loading state**: Skeleton rows (follow existing patterns from DeliveryList)

- Use standard page patterns:
  - `'use client'` directive
  - `use(params)` to unwrap the promise params (Next.js 16 pattern)
  - `useState` + `useEffect` for data fetching
  - `Card`, `CardHeader`, `CardContent` from `@/components/ui/card`
  - Same page layout: `<div className="p-4 pb-20 sm:p-6 max-w-6xl mx-auto space-y-6">`

- The deliveries API `/api/deliveries?property_id={id}` returns delivery objects with joined purchase_order (including supplier), property, building, and invoice data. This is already sufficient -- no new API endpoints needed.

- Note: The `property_id` on deliveries maps to the property that the delivery was made to. However, the API might also need the building ID. Check the data model: deliveries have both `property_id` and `building_id`. Since the `[id]` in the URL is the building ID from the liegenschaft drilldown, filter by building_id may be more appropriate. Try fetching via the existing DeliveryList component with `propertyId` prop first. If the building context is needed, also consider passing building_id. The safest approach: fetch `/api/deliveries?property_id={buildingPropertyId}` where you first fetch the building to get its property_id.

- Alternatively, since the delivery list component already exists and accepts `propertyId`, reuse it:
  ```tsx
  <DeliveryList propertyId={propertyId} />
  ```
  But note: DeliveryList is designed for purchase order context (has "Rechnung verknuepfen" button). For the property-level view, build a read-only delivery table without the link invoice action (omit `onLinkInvoice` prop, which DeliveryList already handles -- if no `onLinkInvoice` is passed, the action column button is not shown).

- Actually, the simplest correct approach: Use `<DeliveryList propertyId={id} />` without `onLinkInvoice`. The component already handles this case (line 243: `{!delivery.invoice_id && onLinkInvoice && ...}`). But we need to know whether `id` is a building_id or property_id. Looking at the URL structure `/dashboard/liegenschaft/[id]`, this `[id]` is a building ID (consistent with existing child routes like `liegenschaft/[id]/einheit/[unitId]/raum/[roomId]` where `[id]` is the building). So we need to first look up the property_id for this building, OR add a query param to the deliveries API.

- Best approach:
  1. Fetch building info: `GET /api/buildings/{id}` to get building name and property_id
  2. Fetch deliveries: Pass the property_id from the building to `<DeliveryList propertyId={building.property_id} />`
  3. This reuses the existing component and API without modification
  </action>
  <verify>
1. `npx tsc --noEmit` passes without errors
2. File `src/app/dashboard/liegenschaft/[id]/page.tsx` exists
3. Page renders at `/dashboard/liegenschaft/{buildingId}` with delivery history
4. DeliveryList component is reused (no duplication)
  </verify>
  <done>
- Property detail page exists at `/dashboard/liegenschaft/[id]`
- Page shows building info header and delivery history table
- Deliveries filtered by property_id of the building
- Empty state shown when no deliveries exist
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` -- full TypeScript compilation passes
2. No `prompt(` calls in purchase order detail page
3. No `Item ${index` pattern in ChecklistExecution
4. InvoiceLinkModal.tsx exists and is imported
5. Property detail page exists at liegenschaft/[id]/page.tsx
6. `npm run build` succeeds (pages compile)
</verification>

<success_criteria>
- UXPL-01: Invoice linking opens a search/select modal with supplier-filtered invoices
- UXPL-02: Checklist items display template-defined titles and descriptions
- UXPL-03: Property detail page shows delivery history with dates, quantities, and linked orders
</success_criteria>

<output>
After completion, create `.planning/phases/25-ux-polish/25-01-SUMMARY.md`
</output>
