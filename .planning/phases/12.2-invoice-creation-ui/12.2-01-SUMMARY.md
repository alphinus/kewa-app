---
phase: 12.2-invoice-creation-ui
plan: 01
subsystem: ui
tags: [invoice, form, work-order, swiss-vat, next.js]

# Dependency graph
requires:
  - phase: 10
    provides: Invoice API, cost management infrastructure
  - phase: 12.1
    provides: Project detail navigation with costs tab
provides:
  - Invoice creation form with work order pre-fill
  - "Neue Rechnung" page at /dashboard/kosten/rechnungen/neu
  - "Rechnung erstellen" action on eligible work orders
  - Draft invoice status support
  - Swiss VAT 8.0% auto-calculation
affects: [13-change-orders, 14-inspection]

# Tech tracking
tech-stack:
  added: []
  patterns: [work-order-pre-fill, counter-offer-selection, preview-before-submit]

key-files:
  created:
    - src/components/costs/InvoiceForm.tsx
    - src/app/dashboard/kosten/rechnungen/neu/page.tsx
  modified:
    - src/lib/costs/invoice-constants.ts
    - src/app/api/invoices/route.ts
    - src/app/dashboard/kosten/rechnungen/page.tsx
    - src/components/costs/WorkOrderCostRow.tsx
    - src/components/costs/ProjectCostDashboard.tsx
    - src/components/costs/InvoiceDetail.tsx
    - src/types/index.ts

key-decisions:
  - "Swiss VAT updated to 8.0% from 7.7%"
  - "Draft as default invoice status (not received)"
  - "Document optional for draft invoices"
  - "Counter-offer shown as radio button options"
  - "Line items synced to net amount"

patterns-established:
  - "Work order pre-fill pattern: select work order, auto-fill form fields"
  - "Amount source pattern: radio buttons for estimated vs proposed vs manual"
  - "Preview pattern: show summary before final submit"

# Metrics
duration: 13min
completed: 2026-01-19
---

# Phase 12.2 Plan 01: Invoice Creation Form & Page Summary

**Invoice creation UI with work order pre-fill, counter-offer handling, VAT 8.0% auto-calculation, and draft status support closing INT-02 gap**

## Performance

- **Duration:** 13 min
- **Started:** 2026-01-19T02:35:41Z
- **Completed:** 2026-01-19T02:48:18Z
- **Tasks:** 7
- **Files modified:** 9

## Accomplishments
- Invoice creation form with work order selector and full pre-fill capability
- Counter-offer handling showing both amounts for user selection
- "Neue Rechnung" page accessible from invoice list and work order rows
- "Rechnung erstellen" action on eligible work orders (done/accepted, no invoice)
- Draft invoice status support with optional document upload
- Swiss VAT 8.0% auto-calculation
- Duplicate invoice prevention (409 error if work order already has invoice)

## Task Commits

Each task was committed atomically:

1. **Task 1: Update Invoice Constants** - `80d3613` (chore)
2. **Task 2: Update Invoice API for Draft Status** - `8d95abf` (feat)
3. **Task 3: Create InvoiceForm Component** - `5011155` (feat)
4. **Task 4: Create Neue Rechnung Page** - `064bb10` (feat)
5. **Task 5: Add "Neue Rechnung" Button to Invoice List** - `c78b403` (feat)
6. **Task 6: Add "Rechnung erstellen" Action to Work Order Rows** - `aeaa2cc` (feat)
7. **Task 7: Verify E2E Flow Works** - Build verified

**Auto-fix:** `9e799a2` (fix) - InvoiceDetail draft status

## Files Created/Modified

### Created
- `src/components/costs/InvoiceForm.tsx` - Invoice creation form with work order pre-fill
- `src/app/dashboard/kosten/rechnungen/neu/page.tsx` - New invoice page

### Modified
- `src/lib/costs/invoice-constants.ts` - Added DEFAULT_TAX_RATE (8.0%), INVOICE_STATUSES, draft status labels/colors
- `src/app/api/invoices/route.ts` - Draft status support, work order duplicate check, VAT update
- `src/app/dashboard/kosten/rechnungen/page.tsx` - Added "Neue Rechnung" button
- `src/components/costs/WorkOrderCostRow.tsx` - Added "Rechnung erstellen" action column
- `src/components/costs/ProjectCostDashboard.tsx` - Updated table header for new column
- `src/components/costs/InvoiceDetail.tsx` - Added draft status to label/color maps
- `src/types/index.ts` - Added 'draft' to InvoiceStatus type

## Decisions Made

| Decision | Rationale |
|----------|-----------|
| Swiss VAT 8.0% | Updated from 7.7% per 2024 Swiss VAT change |
| Draft as default status | New invoices start as drafts, not received |
| Document optional for drafts | Allow creating draft without uploading PDF |
| Counter-offer radio buttons | Clear UX for selecting between estimated and proposed amounts |
| Line items sync to net amount | Single source of truth for invoice total |

## Deviations from Plan

### Auto-fixed Issues

**1. [Rule 1 - Bug] InvoiceDetail missing draft status**
- **Found during:** Task 7 (Verify E2E Flow)
- **Issue:** Build failed - `Record<InvoiceStatus, string>` missing 'draft' key
- **Fix:** Added 'draft' to STATUS_LABELS and STATUS_COLORS in InvoiceDetail.tsx
- **Files modified:** src/components/costs/InvoiceDetail.tsx
- **Verification:** Build passes
- **Committed in:** 9e799a2

---

**Total deviations:** 1 auto-fixed (1 bug)
**Impact on plan:** Essential fix for type safety after adding draft status to InvoiceStatus type. No scope creep.

## Issues Encountered

None - plan executed smoothly.

## User Setup Required

None - no external service configuration required.

## Next Phase Readiness

- INT-02 gap (Flow 2: Work Order to Invoice) is now closed
- Invoice creation flow complete: Work Order (done/accepted) -> Create Invoice -> Invoice List
- Ready for Phase 13 (Change Orders & Suppliers)
- All verification criteria pass

---
*Phase: 12.2-invoice-creation-ui*
*Completed: 2026-01-19*
