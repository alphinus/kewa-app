---
phase: 12.2-invoice-creation-ui
verified: 2026-01-19T04:00:00Z
status: passed
score: 9/9 must-haves verified
human_verification:
  - test: "Pre-fill verification"
    expected: "Selecting work order fills partner, title, description, amounts"
    why_human: "Dynamic behavior requiring actual UI interaction"
  - test: "Counter-offer radio buttons"
    expected: "If work order has proposed_cost, show both Offerte and Gegenofferte options"
    why_human: "Requires work order with counter-offer data"
  - test: "Preview step"
    expected: "Clicking Vorschau shows summary before submit"
    why_human: "UI interaction flow"
  - test: "Flow 2 end-to-end"
    expected: "Work Order row -> Rechnung erstellen -> Fill form -> Submit -> Invoice Detail"
    why_human: "Full user journey requires runtime testing"
---

# Phase 12.2: Invoice Creation UI Verification Report

**Phase Goal:** Enable invoice creation from completed work orders
**Verified:** 2026-01-19T04:00:00Z
**Status:** passed
**Re-verification:** No - initial verification

## Goal Achievement

### Observable Truths

| # | Truth | Status | Evidence |
|---|-------|--------|----------|
| 1 | InvoiceForm exists with work order pre-fill | VERIFIED | 939-line component at `src/components/costs/InvoiceForm.tsx` with full pre-fill logic (lines 154-183) |
| 2 | "Neue Rechnung" page at correct path | VERIFIED | 85-line page at `src/app/dashboard/kosten/rechnungen/neu/page.tsx`, appears in build output |
| 3 | "Rechnung erstellen" button on eligible work orders | VERIFIED | Lines 89-154 in `WorkOrderCostRow.tsx` with correct gating (`done/accepted` AND `!hasInvoice`) |
| 4 | "Neue Rechnung" button in invoice list header | VERIFIED | Lines 65-76 in `src/app/dashboard/kosten/rechnungen/page.tsx` |
| 5 | Pre-fill works from work order | VERIFIED | `handleWorkOrderSelect` at lines 154-183 fills title, description, amounts, partner |
| 6 | Counter-offer handling | VERIFIED | Lines 649-698 show radio buttons for Offerte/Gegenofferte/Manual when `proposed_cost` exists |
| 7 | VAT 8.0% auto-calculation | VERIFIED | `DEFAULT_TAX_RATE = 8.0` in invoice-constants.ts, used in form (line 86, 106-107) |
| 8 | Duplicate prevention | VERIFIED | API check at lines 203-217 in `/api/invoices/route.ts` returns 409 with German error message |
| 9 | Flow 2 complete | VERIFIED | All components wired: WorkOrderCostRow -> neu page -> InvoiceForm -> POST /api/invoices -> redirect to detail |

**Score:** 9/9 truths verified

### Required Artifacts

| Artifact | Expected | Status | Details |
|----------|----------|--------|---------|
| `src/components/costs/InvoiceForm.tsx` | Invoice creation form component | EXISTS, SUBSTANTIVE, WIRED | 939 lines, imported in neu/page.tsx |
| `src/app/dashboard/kosten/rechnungen/neu/page.tsx` | New invoice page | EXISTS, SUBSTANTIVE, WIRED | 85 lines, renders InvoiceForm, handles query params |
| `src/components/costs/WorkOrderCostRow.tsx` | Work order row with action | EXISTS, SUBSTANTIVE, WIRED | 209 lines, has "Rechnung erstellen" link (line 148-155) |
| `src/app/dashboard/kosten/rechnungen/page.tsx` | Invoice list with button | EXISTS, SUBSTANTIVE, WIRED | 113 lines, has "Neue Rechnung" button (lines 66-74) |
| `src/app/api/invoices/route.ts` | API with draft support | EXISTS, SUBSTANTIVE, WIRED | 258 lines, draft status (line 176), duplicate check (lines 203-217) |
| `src/lib/costs/invoice-constants.ts` | Constants with 8.0% VAT | EXISTS, SUBSTANTIVE, WIRED | 119 lines, DEFAULT_TAX_RATE = 8.0 (line 20) |

### Key Link Verification

| From | To | Via | Status | Details |
|------|-----|-----|--------|---------|
| WorkOrderCostRow | /rechnungen/neu | Link with query param | WIRED | Line 149: `href={/dashboard/kosten/rechnungen/neu?work_order_id=${workOrder.id}}` |
| Invoice list page | /rechnungen/neu | Link button | WIRED | Line 67: `href="/dashboard/kosten/rechnungen/neu"` |
| InvoiceForm | /api/invoices POST | fetch | WIRED | Line 381: `fetch('/api/invoices', { method: 'POST' ...})` |
| InvoiceForm | /api/work-orders GET | fetch | WIRED | Line 118: `fetch('/api/work-orders?status=done,accepted')` |
| InvoiceForm success | Invoice detail page | router.push | WIRED | Line 397: `router.push(/dashboard/kosten/rechnungen/${data.invoice.id})` |
| API invoices | Database | Supabase insert | WIRED | Lines 239-243: `supabase.from('invoices').insert(...)` |

### Requirements Coverage

| Requirement | Status | Blocking Issue |
|-------------|--------|----------------|
| InvoiceForm component with work order pre-fill | SATISFIED | None |
| "Neue Rechnung" page at `/dashboard/kosten/rechnungen/neu` | SATISFIED | None |
| "Rechnung erstellen" action from completed work orders | SATISFIED | None |

### Anti-Patterns Found

| File | Line | Pattern | Severity | Impact |
|------|------|---------|----------|--------|
| InvoiceForm.tsx | 595, 610, 734, 816 | placeholder attr | Info | HTML placeholder text, not code stubs |

No blocking anti-patterns found. The "placeholder" matches are legitimate HTML placeholder attributes for input fields.

### Human Verification Required

1. **Pre-fill Verification**
   - **Test:** Select a work order in dropdown
   - **Expected:** Partner name, title, description, and amount fields populate automatically
   - **Why human:** Requires runtime UI interaction with actual data

2. **Counter-offer Display**
   - **Test:** Select a work order that has `proposed_cost` (counter-offer)
   - **Expected:** Radio buttons appear showing "Offerte: CHF X" and "Gegenofferte: CHF Y"
   - **Why human:** Requires work order with counter-offer in database

3. **Preview Step**
   - **Test:** Fill required fields, click "Vorschau" button
   - **Expected:** Preview section shows invoice summary with all entered data
   - **Why human:** UI interaction flow

4. **Complete Flow 2**
   - **Test:** From project cost dashboard, find done/accepted work order, click "Rechnung erstellen", fill form, submit
   - **Expected:** Invoice created, redirected to invoice detail page, invoice visible in list
   - **Why human:** End-to-end user journey

### Notes

**Minor UX Consideration (Non-blocking):**

The `/api/work-orders` endpoint does not include invoice relation in its SELECT query, so InvoiceForm's client-side filtering (`!wo.invoice`) will pass all work orders through since `invoice` is undefined. However:
- Backend has proper duplicate prevention (409 error with German message)
- User gets clear error if they try to create duplicate
- WorkOrderCostRow (using `project-cost-queries.ts`) correctly gates the button since it fetches invoice data

This is a UX enhancement opportunity for Phase 13+, not a blocker.

---

*Verified: 2026-01-19T04:00:00Z*
*Verifier: Claude (gsd-verifier)*
