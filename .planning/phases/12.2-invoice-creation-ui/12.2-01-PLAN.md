---
plan: 12.2-01
name: Invoice Creation Form & Page
phase: 12.2
wave: 1
depends_on: []
files_modified:
  - src/components/costs/InvoiceForm.tsx (NEW)
  - src/app/dashboard/kosten/rechnungen/neu/page.tsx (NEW)
  - src/components/costs/WorkOrderCostRow.tsx
  - src/app/dashboard/kosten/rechnungen/page.tsx
  - src/app/api/invoices/route.ts
  - src/lib/costs/invoice-constants.ts
autonomous: true
estimated_tokens: 6000
scope: small
---

# Plan 12.2-01: Invoice Creation Form & Page

## Objective

Close integration gap INT-02 by creating an invoice creation UI that enables:
1. Creating invoices from completed work orders with pre-fill
2. "Neue Rechnung" page accessible from invoice list
3. "Rechnung erstellen" action on eligible work orders

## Context

**Gap from Milestone Audit:**
- Invoice table and API exist but no creation UI
- Work orders have invoices linked via `work_order_id` but no way to create them

**Affected Flow:** Work Order (done/accepted) → Create Invoice → Invoice List

**Key Decisions (from CONTEXT.md):**
- Pre-fill everything from work order: partner, amount, description, dates
- Counter-offer handling: show both amounts if exists, user picks
- VAT: 8.0% (Swiss VAT update from 7.7%)
- One line item per work order by default, user can add more
- Preview step before final submit
- Initial status: `draft`
- Prevent duplicate invoices (error if work order already has invoice)
- Entry points: button on work order rows + "Neue Rechnung" on invoice list

## Tasks

<task id="1">
<title>Update Invoice Constants</title>
<type>modify</type>
<file>src/lib/costs/invoice-constants.ts</file>
<description>
Add/update constants for invoice creation:

1. Update DEFAULT_TAX_RATE to 8.0 (Swiss VAT increase)
2. Add INVOICE_STATUSES array with all status options
3. Add invoice status labels in German

Reference existing expense-constants.ts pattern for structure.
</description>
</task>

<task id="2">
<title>Update Invoice API for Draft Status</title>
<type>modify</type>
<file>src/app/api/invoices/route.ts</file>
<description>
Update POST /api/invoices to:

1. Accept `status` field in body (default to 'draft' instead of 'received')
2. Update tax_rate default from 7.7 to 8.0
3. Add check: if `work_order_id` provided, verify no existing invoice linked to that work order
4. Return 409 Conflict if work order already has invoice: "Dieser Arbeitsauftrag hat bereits eine verknuepfte Rechnung"
5. Make `document_storage_path` optional for draft invoices (required when status != 'draft')

Check for existing work order invoice:
```typescript
if (body.work_order_id) {
  const { data: existingInvoice } = await supabase
    .from('invoices')
    .select('id')
    .eq('work_order_id', body.work_order_id)
    .single()

  if (existingInvoice) {
    return NextResponse.json(
      { error: 'Dieser Arbeitsauftrag hat bereits eine verknuepfte Rechnung' },
      { status: 409 }
    )
  }
}
```
</description>
</task>

<task id="3">
<title>Create InvoiceForm Component</title>
<type>create</type>
<file>src/components/costs/InvoiceForm.tsx</file>
<description>
Create client component following ExpenseForm.tsx pattern.

**Props:**
```typescript
interface InvoiceFormProps {
  workOrderId?: string        // Pre-select work order
  onSuccess?: (invoice: Invoice) => void
  onCancel?: () => void
}
```

**Form Fields:**
- Work Order selector (dropdown of eligible work orders: status done/accepted, no invoice yet)
- Partner (auto-filled from work order, readonly display)
- Invoice Number (required, text input)
- Title (pre-filled from work order title)
- Description (pre-filled from work order description)
- Invoice Date (date picker, default today)
- Due Date (date picker, optional)

**Amount Section:**
- If work order has counter-offer (proposed_cost != null):
  - Radio buttons: "Offerte (original)" | "Gegenofferte (proposed_cost)"
  - Show both amounts side-by-side for comparison
- Net Amount (from selected amount or manual entry)
- VAT Rate (default 8.0%, editable)
- VAT Amount (auto-calculated)
- Total Amount (auto-calculated)

**Line Items Section:**
- Default: 1 line item with work order description and total
- "Zeile hinzufuegen" button to add extra line items
- Each line: description, quantity (default 1), unit_price, total (calculated)

**Document Upload:**
- File input for invoice PDF
- Upload to 'documents' bucket via storage API
- Show uploaded filename or "Kein Dokument" status

**Preview & Submit:**
- "Vorschau" button shows modal/section with invoice summary
- Preview shows: partner, amounts, line items, dates, document
- "Rechnung erstellen" button (disabled until required fields filled)
- "Abbrechen" button calls onCancel

**Validation:**
- invoice_number required
- amount required and > 0
- invoice_date required
- work_order_id required (unless accessed from /rechnungen/neu without context)

**State Management:**
- Fetch eligible work orders on mount
- When work order selected, fetch its details and pre-fill
- Track form dirty state for cancel confirmation

**Styling:**
- Follow ExpenseForm.tsx layout and styling
- Use existing Card, Input, Button components
- Dark mode support with dark: variants
</description>
</task>

<task id="4">
<title>Create Neue Rechnung Page</title>
<type>create</type>
<file>src/app/dashboard/kosten/rechnungen/neu/page.tsx</file>
<description>
Create client page following /kosten/ausgaben/neu/page.tsx pattern.

**Page Structure:**
```typescript
'use client'

import { useSearchParams, useRouter } from 'next/navigation'
import Link from 'next/link'
import { Card, CardContent } from '@/components/ui/card'
import { InvoiceForm } from '@/components/costs/InvoiceForm'

export default function NeueRechnungPage() {
  const router = useRouter()
  const searchParams = useSearchParams()

  // Get pre-selection from query params
  const workOrderId = searchParams.get('work_order_id') ?? undefined

  function handleSuccess(invoice: Invoice) {
    // Redirect to invoice detail page
    router.push(`/dashboard/kosten/rechnungen/${invoice.id}`)
  }

  function handleCancel() {
    router.back()
  }

  return (
    <div className="space-y-6 pb-20">
      {/* Breadcrumb */}
      <nav>Rechnungen / Neu erfassen</nav>

      {/* Header */}
      <div>
        <h1>Rechnung erfassen</h1>
        <p>Erstellen Sie eine Rechnung fuer einen abgeschlossenen Arbeitsauftrag</p>
      </div>

      {/* Form Card */}
      <Card>
        <CardContent>
          <InvoiceForm
            workOrderId={workOrderId}
            onSuccess={handleSuccess}
            onCancel={handleCancel}
          />
        </CardContent>
      </Card>

      {/* Help text */}
      <div className="text-sm text-gray-500">
        Hinweis: Rechnungen werden als Entwurf gespeichert...
      </div>
    </div>
  )
}
```

**URL:** `/dashboard/kosten/rechnungen/neu`
**Query Params:** `?work_order_id=<uuid>` (optional pre-selection)
</description>
</task>

<task id="5">
<title>Add "Neue Rechnung" Button to Invoice List</title>
<type>modify</type>
<file>src/app/dashboard/kosten/rechnungen/page.tsx</file>
<description>
Add "Neue Rechnung" button in the header next to ExportButton.

Change from:
```tsx
<div className="flex items-start justify-between">
  <div>
    <h1>Rechnungen</h1>
    ...
  </div>
  <ExportButton projects={projects ?? []} />
</div>
```

To:
```tsx
<div className="flex items-start justify-between">
  <div>
    <h1>Rechnungen</h1>
    ...
  </div>
  <div className="flex items-center gap-3">
    <Link
      href="/dashboard/kosten/rechnungen/neu"
      className="inline-flex items-center px-4 py-2 text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 rounded-lg transition-colors"
    >
      <svg className="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4v16m8-8H4" />
      </svg>
      Neue Rechnung
    </Link>
    <ExportButton projects={projects ?? []} />
  </div>
</div>
```

Add Link import at top of file.
</description>
</task>

<task id="6">
<title>Add "Rechnung erstellen" Action to Work Order Rows</title>
<type>modify</type>
<file>src/components/costs/WorkOrderCostRow.tsx</file>
<description>
Add "Rechnung erstellen" button for eligible work orders.

**Eligibility:** status in ['done', 'accepted'] AND no invoice linked

**Changes:**

1. Add Link import from 'next/link'

2. Add new column header in table parent (note: this is just for row, header is elsewhere)

3. In the row, add action column before the status column:

```tsx
{/* Actions */}
<td className="py-3 px-4 text-right">
  {canCreateInvoice && (
    <Link
      href={`/dashboard/kosten/rechnungen/neu?work_order_id=${workOrder.id}`}
      onClick={(e) => e.stopPropagation()}
      className="inline-flex items-center px-2.5 py-1 text-xs font-medium text-blue-600 dark:text-blue-400 bg-blue-50 dark:bg-blue-900/20 hover:bg-blue-100 dark:hover:bg-blue-900/30 rounded transition-colors"
    >
      Rechnung erstellen
    </Link>
  )}
</td>
```

Where `canCreateInvoice` is:
```typescript
const canCreateInvoice =
  ['done', 'accepted'].includes(workOrder.status) &&
  !workOrder.invoice
```

4. e.stopPropagation() prevents row click navigation when clicking button
</description>
</task>

<task id="7">
<title>Verify E2E Flow Works</title>
<type>verify</type>
<description>
Manual verification that Flow 2 (Work Order → Invoice) works:

1. Navigate to /dashboard/kosten (project cost overview)
2. Click on a project with work orders
3. Find a work order with status 'done' or 'accepted' and no invoice
4. Should see "Rechnung erstellen" button in the row
5. Click button → navigates to /dashboard/kosten/rechnungen/neu?work_order_id=...
6. Form should pre-fill:
   - Work order selected in dropdown
   - Partner displayed (readonly)
   - Title and description from work order
   - Amount from work order (or counter-offer options if exists)
7. Fill required fields (invoice_number, invoice_date)
8. Click "Vorschau" → see preview of invoice
9. Click "Rechnung erstellen" → creates invoice
10. Redirects to /dashboard/kosten/rechnungen/{id}
11. Invoice appears in list with status "Entwurf"

Also verify:
- "Neue Rechnung" button on /dashboard/kosten/rechnungen works
- Attempting to create second invoice for same work order shows error
- Invoice list shows new button in header
</description>
</task>

## Verification Criteria

```yaml
automated:
  - file_exists: src/components/costs/InvoiceForm.tsx
  - file_exists: src/app/dashboard/kosten/rechnungen/neu/page.tsx
  - file_contains:
      path: src/app/dashboard/kosten/rechnungen/page.tsx
      pattern: "/dashboard/kosten/rechnungen/neu"
  - file_contains:
      path: src/components/costs/WorkOrderCostRow.tsx
      pattern: "Rechnung erstellen"
  - file_contains:
      path: src/app/api/invoices/route.ts
      pattern: "work_order_id"

manual:
  - "Invoice form pre-fills from work order"
  - "Counter-offer amounts shown when applicable"
  - "Preview step works before final submit"
  - "'Rechnung erstellen' button on eligible work orders"
  - "'Neue Rechnung' button on invoice list page"
  - "Duplicate invoice prevented with error message"
  - "Created invoice redirects to detail page"
```

## must_haves

These are the non-negotiable deliverables that define success:

1. **InvoiceForm component exists** with work order pre-fill capability
2. **"Neue Rechnung" page** at `/dashboard/kosten/rechnungen/neu`
3. **"Rechnung erstellen" button** on work orders (done/accepted, no invoice)
4. **"Neue Rechnung" button** in invoice list header
5. **Pre-fill works** - partner, amounts, description from work order
6. **Counter-offer handling** - both amounts shown when exists
7. **VAT 8.0%** auto-calculation
8. **Duplicate prevention** - error if work order already has invoice
9. **Flow 2 complete**: Work Order → Create Invoice → Invoice Detail

## Implementation Notes

### Pattern Reference
Follow ExpenseForm.tsx for:
- Form state management
- Entity selector pattern
- File upload handling
- Validation approach
- Submit/cancel flow

Follow /kosten/ausgaben/neu/page.tsx for:
- Page structure
- Breadcrumb
- Query param handling
- Success/cancel callbacks

### API Changes
POST /api/invoices changes:
- Accept `status` field (default 'draft')
- tax_rate default 8.0
- Check work_order_id uniqueness
- document_storage_path optional for drafts

### Work Order Data
Fetch from: `/api/work-orders?status=done,accepted&no_invoice=true`
Or use direct Supabase query in component:
```typescript
const { data: workOrders } = await supabase
  .from('work_orders')
  .select('id, title, description, status, partner_id, estimated_cost, proposed_cost, final_cost, partner:partners(id, company_name)')
  .in('status', ['done', 'accepted'])
  .is('id', 'not.in', invoicedWorkOrderIds)
```

### Styling
- Use existing Tailwind patterns
- Dark mode with `dark:` variants
- Card from `@/components/ui/card`
- Button, Input from `@/components/ui/`

## Rollback

If issues occur:
1. InvoiceForm is additive - can be removed without breaking existing functionality
2. "Neue Rechnung" page is new - removal doesn't affect existing pages
3. WorkOrderCostRow changes are additive (new column)
4. API changes are backward compatible (new optional fields)
