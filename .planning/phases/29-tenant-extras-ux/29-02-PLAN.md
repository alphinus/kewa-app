---
phase: 29-tenant-extras-ux
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/070_ticket_work_order_link.sql
  - src/types/portal.ts
  - src/lib/admin/ticket-to-work-order.ts
  - src/app/api/admin/tickets/[id]/convert-to-wo/route.ts
  - src/app/api/portal/profile/route.ts
  - src/app/(portal)/portal/profile/page.tsx
  - src/components/portal/ProfileForm.tsx
autonomous: true

must_haves:
  truths:
    - "KEWA operator can convert ticket to work order with one click"
    - "Ticket photos are copied to work order (not linked)"
    - "Ticket auto-closes with status message after conversion"
    - "Tenant sees conversion confirmation message in portal"
    - "Tenant can update phone and emergency contact from portal"
    - "Tenant cannot change email (read-only)"
  artifacts:
    - path: "supabase/migrations/070_ticket_work_order_link.sql"
      provides: "Link table between tickets and work orders"
      contains: "ticket_work_orders"
    - path: "src/lib/admin/ticket-to-work-order.ts"
      provides: "Conversion logic with photo copying"
      exports: ["convertTicketToWorkOrder"]
    - path: "src/app/api/admin/tickets/[id]/convert-to-wo/route.ts"
      provides: "Conversion API endpoint"
      exports: ["POST"]
    - path: "src/app/api/portal/profile/route.ts"
      provides: "Tenant profile API"
      exports: ["GET", "PATCH"]
    - path: "src/components/portal/ProfileForm.tsx"
      provides: "Profile edit form component"
      min_lines: 80
  key_links:
    - from: "src/app/api/admin/tickets/[id]/convert-to-wo/route.ts"
      to: "convertTicketToWorkOrder"
      via: "service function call"
      pattern: "convertTicketToWorkOrder"
    - from: "src/lib/admin/ticket-to-work-order.ts"
      to: "supabase.storage.copy"
      via: "photo copying"
      pattern: "storage.*copy"
    - from: "src/app/(portal)/portal/profile/page.tsx"
      to: "/api/portal/profile"
      via: "fetch on mount and form submit"
      pattern: "fetch.*api/portal/profile"
---

<objective>
Implement ticket-to-work-order conversion for KEWA operators and tenant profile management.

Purpose: TPRT-12 (ticket-to-work-order conversion) allows KEWA to efficiently handle tenant requests by converting them to internal work orders. TPRT-13 (profile management) enables tenants to keep their contact information current without admin intervention.

Output: Conversion API with photo copying, profile API with validation, profile UI form.
</objective>

<execution_context>
@C:\Users\Mario Giacchino\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\Mario Giacchino\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/29-tenant-extras-ux/29-CONTEXT.md
@.planning/phases/29-tenant-extras-ux/29-RESEARCH.md

# Work order structure
@src/app/api/work-orders/route.ts
@src/types/work-order.ts

# Ticket structure
@src/types/portal.ts
@src/lib/portal/ticket-queries.ts
@supabase/migrations/062_tenant_portal.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create database schema and conversion logic</name>
  <files>
    supabase/migrations/070_ticket_work_order_link.sql
    src/types/portal.ts
    src/lib/admin/ticket-to-work-order.ts
  </files>
  <action>
1. Create `supabase/migrations/070_ticket_work_order_link.sql`:
   ```sql
   -- Link table for ticket to work order conversion tracking
   CREATE TABLE IF NOT EXISTS ticket_work_orders (
     id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
     ticket_id UUID NOT NULL REFERENCES tickets(id),
     work_order_id UUID NOT NULL REFERENCES work_orders(id),
     converted_at TIMESTAMPTZ DEFAULT NOW(),
     converted_by UUID NOT NULL REFERENCES users(id),
     UNIQUE(ticket_id)
   );

   COMMENT ON TABLE ticket_work_orders IS 'Tracks which tickets have been converted to work orders';

   -- Index for lookups
   CREATE INDEX IF NOT EXISTS idx_ticket_work_orders_ticket ON ticket_work_orders(ticket_id);
   CREATE INDEX IF NOT EXISTS idx_ticket_work_orders_wo ON ticket_work_orders(work_order_id);

   -- Add conversion_status field to tickets if not exists
   ALTER TABLE tickets
     ADD COLUMN IF NOT EXISTS converted_to_wo_id UUID REFERENCES work_orders(id),
     ADD COLUMN IF NOT EXISTS conversion_message TEXT;
   ```

2. Update `src/types/portal.ts`:
   - Add to Ticket interface: converted_to_wo_id?: string | null, conversion_message?: string | null
   - Add interface ConvertTicketInput: { work_order_type: string, partner_id: string, description?: string }

3. Create `src/lib/admin/ticket-to-work-order.ts`:

   Export `convertTicketToWorkOrder` function:
   - Params: { ticketId, operatorUserId, workOrderType, partnerId, description? }
   - Steps:
     a. Fetch ticket with attachments and unit details
     b. Verify ticket is not already converted (check converted_to_wo_id)
     c. Verify ticket status allows conversion (offen or in_bearbeitung)
     d. Create work order:
        - title: Ticket {ticket_number} description truncated
        - description: Use provided description OR ticket.description
        - room_id: Derive from ticket.unit_id (get first room or null)
        - partner_id: From params
        - status: 'draft'
        - created_by: operatorUserId
     e. Copy ticket photos using Supabase Storage .copy():
        - Use SUPABASE_SERVICE_ROLE_KEY (server-side only)
        - Source: ticket_attachments storage path
        - Destination: media bucket with work_order_id prefix
        - Loop through each attachment, copy sequentially
        - Create media records for each copied file
     f. Create ticket_work_orders link record
     g. Update ticket:
        - status: 'geschlossen'
        - closed_at: NOW()
        - closed_by: operatorUserId
        - converted_to_wo_id: work_order.id
        - conversion_message: "Ihr Ticket wurde in einen Arbeitsauftrag umgewandelt"
     h. Return { workOrder, ticket }

   Use service role client for storage operations:
   ```typescript
   const supabaseAdmin = createClient(
     process.env.NEXT_PUBLIC_SUPABASE_URL!,
     process.env.SUPABASE_SERVICE_ROLE_KEY!
   )
   ```
  </action>
  <verify>
    - `npm run type-check` passes
    - Migration file is valid SQL
    - convertTicketToWorkOrder function handles all steps
    - Photo copying uses service role key
  </verify>
  <done>
    - Database schema for ticket-to-work-order link created
    - Ticket type extended with conversion fields
    - Conversion function with photo copying implemented
    - Ticket auto-closes with German message
  </done>
</task>

<task type="auto">
  <name>Task 2: Create conversion API endpoint</name>
  <files>
    src/app/api/admin/tickets/[id]/convert-to-wo/route.ts
    src/app/api/admin/tickets/route.ts
    src/app/api/admin/tickets/[id]/route.ts
  </files>
  <action>
1. Create `src/app/api/admin/tickets/[id]/convert-to-wo/route.ts`:
   - POST endpoint for operators to convert ticket to work order
   - Validate: x-user-id header (authenticated operator)
   - Validate: x-user-role must be admin or property_manager
   - Accept body: { partner_id: string, description?: string }
     (work_order_type derived from ticket category - no manual selection per CONTEXT.md)
   - Call convertTicketToWorkOrder service
   - Return { success: true, workOrder, ticket }
   - Handle errors:
     - 404: Ticket not found
     - 400: Already converted
     - 400: Invalid status for conversion
     - 500: Internal error

2. Create `src/app/api/admin/tickets/route.ts` - Admin ticket list:
   - GET endpoint for operators
   - Query params: status, urgency, building_id, unit_id, limit, offset
   - Select tickets with relations: category, unit (with building), created_by (tenant name)
   - Include unread_message_count (messages where sender_type='tenant' and read_at IS NULL)
   - Order by urgency DESC (notfall first), then last_message_at DESC
   - Return { tickets, total, limit, offset }

3. Create `src/app/api/admin/tickets/[id]/route.ts` - Admin single ticket:
   - GET: Fetch ticket with full details for operator view
   - Include: all messages with attachments, tenant details, unit/building info
   - PATCH: Update ticket fields (assigned_to, status via different endpoint)
  </action>
  <verify>
    - `npm run type-check` passes
    - `npm run build` succeeds
    - POST /api/admin/tickets/[id]/convert-to-wo exists
    - GET /api/admin/tickets exists for list view
    - Endpoints require operator authentication
  </verify>
  <done>
    - Conversion API endpoint created with validation
    - Admin ticket list endpoint for operator dashboard
    - Role-based access control (admin, property_manager)
    - Proper error handling with German messages
  </done>
</task>

<task type="auto">
  <name>Task 3: Create tenant profile management</name>
  <files>
    src/app/api/portal/profile/route.ts
    src/app/(portal)/portal/profile/page.tsx
    src/components/portal/ProfileForm.tsx
  </files>
  <action>
1. Create `src/app/api/portal/profile/route.ts`:

   GET /api/portal/profile:
   - Validate: x-portal-user-id header (authenticated tenant)
   - Fetch tenant_users record by user_id
   - Join with users table for email, display_name
   - Join with units table for unit info
   - Return: { profile: { id, email, display_name, phone, emergency_contact_name, emergency_contact_phone, unit } }

   PATCH /api/portal/profile:
   - Validate: x-portal-user-id header
   - Accept body: { phone?, emergency_contact_name?, emergency_contact_phone? }
   - Validate phone format (if provided): regex /^[0-9+ ()-]+$/
   - Update users table (NOT tenant_users - phone etc. are on users)
   - Return updated profile

   Note: Email is NOT editable (per CONTEXT.md - prevents auth complications)

2. Create `src/app/(portal)/portal/profile/page.tsx`:
   - 'use client' - client component for form handling
   - Fetch profile on mount via GET /api/portal/profile
   - Display ProfileForm component
   - Show loading state while fetching
   - Show error state if fetch fails

3. Create `src/components/portal/ProfileForm.tsx`:
   - Props: initialData, onSave callback
   - State: phone, emergencyName, emergencyPhone, errors, saving
   - Read-only display: Email, Einheit (unit name), Name
   - Editable fields:
     - Telefonnummer (phone) - required
     - Notfallkontakt Name (emergency_contact_name) - optional
     - Notfallkontakt Telefon (emergency_contact_phone) - optional

   Validation (per CONTEXT.md - on blur + on submit):
   - Phone: Required, must match phone regex
   - Emergency phone: Optional, but if provided must match phone regex
   - Show inline German error messages below fields

   Form submission:
   - Call onSave with updated fields
   - Show toast on success/error via sonner
   - German messages: "Profil gespeichert" / "Fehler beim Speichern"

   Styling:
   - Use existing Input, Label components from @/components/ui
   - Mobile-responsive (single column on mobile)
   - Consistent with portal design
  </action>
  <verify>
    - `npm run type-check` passes
    - `npm run build` succeeds
    - Profile page renders at /portal/profile
    - Form validates on blur and submit
    - Email field is read-only (not an input)
  </verify>
  <done>
    - Profile API with GET and PATCH endpoints
    - Profile page fetches and displays tenant data
    - Form allows editing phone and emergency contacts
    - Inline validation with German error messages
    - Toast feedback on save
  </done>
</task>

</tasks>

<verification>
1. Type check passes: `npm run type-check`
2. Build succeeds: `npm run build`
3. Database migration is valid SQL syntax
4. Conversion endpoint properly copies photos using storage.copy()
5. Profile form validates phone format
6. Profile page shows read-only email
</verification>

<success_criteria>
- TPRT-12: One-click ticket-to-work-order conversion works
- Photos are COPIED (not referenced) to work order
- Ticket auto-closes with German confirmation message
- TPRT-13: Tenant can update phone and emergency contact
- Email remains read-only
- Form validation on blur + submit with German messages
</success_criteria>

<output>
After completion, create `.planning/phases/29-tenant-extras-ux/29-02-SUMMARY.md`
</output>
