# Plan 12-03: Occupancy Dashboard

---
phase: 12
plan: 03
name: Occupancy Dashboard
wave: 2
depends_on: ["12-01"]
scope: small
autonomous: true
files_modified:
  - src/components/dashboard/OccupancyGauge.tsx
  - src/components/dashboard/OccupancySparkline.tsx
  - src/lib/dashboard/occupancy-queries.ts
  - src/components/dashboard/PropertyDashboard.tsx
requirements:
  - OCCU-01
  - OCCU-02
  - OCCU-03
  - OCCU-04
  - PARK-05
---

## Objective

Implement occupancy metrics showing combined unit and parking occupancy with visual gauge and trend sparkline.

## Context

From 12-RESEARCH.md and 12-CONTEXT.md:
- Combined meter with segments for units and parking
- Sparkline showing occupancy trend
- Vacancy = tenant_name IS NULL
- SVG polyline for sparkline (CSS-only, no library)

Existing code references:
- Progress bars throughout codebase use `width: ${percent}%`
- Phase 8 decision: CSS-based visualizations
- Swiss formatting in `src/lib/costs/formatters.ts`

## Tasks

<task id="01" title="Create occupancy query module">
Server-side queries for occupancy calculations.

**File:** `src/lib/dashboard/occupancy-queries.ts`

```typescript
import { createClient } from '@/lib/supabase/server'

export interface OccupancyMetrics {
  totalUnits: number
  occupiedUnits: number
  unitOccupancyPercent: number

  totalParking: number
  occupiedParking: number
  parkingOccupancyPercent: number

  combinedOccupancyPercent: number
}

export async function fetchOccupancyMetrics(
  buildingId: string
): Promise<OccupancyMetrics> {
  const supabase = await createClient()

  // Fetch units
  const { data: units } = await supabase
    .from('units')
    .select('id, unit_type, tenant_name, parking_status')
    .eq('building_id', buildingId)

  const apartments = (units || []).filter(u => u.unit_type === 'apartment')
  const parking = (units || []).filter(u => u.unit_type === 'parking_spot')

  const occupiedUnits = apartments.filter(u => u.tenant_name).length
  const occupiedParking = parking.filter(u => u.parking_status === 'occupied').length

  const totalUnits = apartments.length
  const totalParking = parking.length

  const unitOccupancyPercent = totalUnits > 0
    ? Math.round((occupiedUnits / totalUnits) * 100)
    : 0

  const parkingOccupancyPercent = totalParking > 0
    ? Math.round((occupiedParking / totalParking) * 100)
    : 0

  // Combined: weighted average (apartments worth more than parking)
  const totalSlots = totalUnits + totalParking
  const occupiedSlots = occupiedUnits + occupiedParking
  const combinedOccupancyPercent = totalSlots > 0
    ? Math.round((occupiedSlots / totalSlots) * 100)
    : 0

  return {
    totalUnits,
    occupiedUnits,
    unitOccupancyPercent,
    totalParking,
    occupiedParking,
    parkingOccupancyPercent,
    combinedOccupancyPercent
  }
}

// Placeholder for historical data - implement later if needed
export async function fetchOccupancyHistory(
  buildingId: string,
  months: number = 6
): Promise<number[]> {
  // For MVP: return mock trend data
  // Future: query from occupancy_history table
  return [85, 88, 87, 91, 90, 92]
}
```
</task>

<task id="02" title="Create OccupancySparkline component" depends_on="01">
SVG-based mini sparkline chart.

**File:** `src/components/dashboard/OccupancySparkline.tsx`

```typescript
import { cn } from '@/lib/utils'

interface OccupancySparklineProps {
  data: number[]
  height?: number
  className?: string
}

export function OccupancySparkline({
  data,
  height = 32,
  className
}: OccupancySparklineProps) {
  if (data.length < 2) {
    return null
  }

  const width = data.length * 16
  const padding = 4
  const chartHeight = height - padding * 2
  const chartWidth = width - padding * 2

  const max = Math.max(...data)
  const min = Math.min(...data)
  const range = max - min || 1

  // Normalize values to chart coordinates
  const points = data.map((value, index) => {
    const x = padding + (index / (data.length - 1)) * chartWidth
    const y = padding + chartHeight - ((value - min) / range) * chartHeight
    return `${x},${y}`
  }).join(' ')

  // Current value for gradient coloring
  const currentValue = data[data.length - 1]
  const strokeColor = currentValue >= 90
    ? 'stroke-green-500'
    : currentValue >= 70
    ? 'stroke-amber-500'
    : 'stroke-red-500'

  return (
    <svg
      className={cn('flex-shrink-0', className)}
      width={width}
      height={height}
      viewBox={`0 0 ${width} ${height}`}
    >
      {/* Baseline */}
      <line
        x1={padding}
        y1={height - padding}
        x2={width - padding}
        y2={height - padding}
        className="stroke-gray-200 dark:stroke-gray-700"
        strokeWidth={1}
      />

      {/* Trend line */}
      <polyline
        fill="none"
        className={cn(strokeColor)}
        strokeWidth={2}
        strokeLinecap="round"
        strokeLinejoin="round"
        points={points}
      />

      {/* Current value dot */}
      <circle
        cx={width - padding}
        cy={padding + chartHeight - ((currentValue - min) / range) * chartHeight}
        r={3}
        className={cn(
          'fill-current',
          currentValue >= 90 ? 'text-green-500' :
          currentValue >= 70 ? 'text-amber-500' : 'text-red-500'
        )}
      />
    </svg>
  )
}
```
</task>

<task id="03" title="Create OccupancyGauge component" depends_on="01,02">
Combined occupancy meter with segments.

**File:** `src/components/dashboard/OccupancyGauge.tsx`

```typescript
import { fetchOccupancyMetrics, fetchOccupancyHistory } from '@/lib/dashboard/occupancy-queries'
import { OccupancySparkline } from './OccupancySparkline'
import { cn } from '@/lib/utils'

interface OccupancyGaugeProps {
  buildingId: string
  className?: string
}

export async function OccupancyGauge({ buildingId, className }: OccupancyGaugeProps) {
  const [metrics, history] = await Promise.all([
    fetchOccupancyMetrics(buildingId),
    fetchOccupancyHistory(buildingId, 6)
  ])

  const getColorClass = (percent: number) => {
    if (percent >= 90) return 'bg-green-500'
    if (percent >= 70) return 'bg-amber-500'
    return 'bg-red-500'
  }

  return (
    <div className={cn(
      'p-4 bg-white dark:bg-gray-900 rounded-lg border border-gray-200 dark:border-gray-700',
      className
    )}>
      <div className="flex items-center justify-between mb-4">
        <h3 className="text-sm font-medium text-gray-700 dark:text-gray-300">
          Auslastung
        </h3>
        <span className={cn(
          'text-2xl font-bold',
          metrics.combinedOccupancyPercent >= 90 ? 'text-green-600 dark:text-green-400' :
          metrics.combinedOccupancyPercent >= 70 ? 'text-amber-600 dark:text-amber-400' :
          'text-red-600 dark:text-red-400'
        )}>
          {metrics.combinedOccupancyPercent}%
        </span>
      </div>

      {/* Combined progress bar */}
      <div className="h-4 bg-gray-200 dark:bg-gray-700 rounded-full overflow-hidden mb-4">
        <div
          className={cn('h-full rounded-full transition-all duration-500', getColorClass(metrics.combinedOccupancyPercent))}
          style={{ width: `${metrics.combinedOccupancyPercent}%` }}
        />
      </div>

      {/* Breakdown */}
      <div className="grid grid-cols-2 gap-4 mb-4">
        {/* Units */}
        <div>
          <div className="flex items-center justify-between mb-1">
            <span className="text-xs text-gray-500 dark:text-gray-400">Wohnungen</span>
            <span className="text-xs font-medium text-gray-700 dark:text-gray-300">
              {metrics.occupiedUnits}/{metrics.totalUnits}
            </span>
          </div>
          <div className="h-2 bg-gray-200 dark:bg-gray-700 rounded-full overflow-hidden">
            <div
              className={cn('h-full rounded-full', getColorClass(metrics.unitOccupancyPercent))}
              style={{ width: `${metrics.unitOccupancyPercent}%` }}
            />
          </div>
        </div>

        {/* Parking */}
        <div>
          <div className="flex items-center justify-between mb-1">
            <span className="text-xs text-gray-500 dark:text-gray-400">Parkplaetze</span>
            <span className="text-xs font-medium text-gray-700 dark:text-gray-300">
              {metrics.occupiedParking}/{metrics.totalParking}
            </span>
          </div>
          <div className="h-2 bg-gray-200 dark:bg-gray-700 rounded-full overflow-hidden">
            <div
              className={cn('h-full rounded-full', getColorClass(metrics.parkingOccupancyPercent))}
              style={{ width: `${metrics.parkingOccupancyPercent}%` }}
            />
          </div>
        </div>
      </div>

      {/* Sparkline */}
      <div className="flex items-center gap-2">
        <span className="text-xs text-gray-500 dark:text-gray-400">Trend (6 Mt.)</span>
        <OccupancySparkline data={history} height={24} />
      </div>
    </div>
  )
}
```
</task>

<task id="04" title="Integrate into PropertyDashboard" depends_on="03">
Add OccupancyGauge to the dashboard layout.

**File:** `src/components/dashboard/PropertyDashboard.tsx`

Update the component to include OccupancyGauge:

```typescript
// Add import
import { OccupancyGauge } from './OccupancyGauge'

// In the JSX, add after summary stats and before building layout:
{/* Occupancy Gauge */}
<OccupancyGauge buildingId={buildingId} />
```

Place between summary stats and building layout.
</task>

## Verification

<verification>
- [ ] OccupancyGauge shows combined percentage prominently
- [ ] Progress bar colored by threshold (green/amber/red)
- [ ] Unit and parking breakdown displayed separately
- [ ] Sparkline renders with correct trend line
- [ ] Vacancy affects unit occupancy count
- [ ] Unoccupied parking reduces parking occupancy
- [ ] Combined occupancy includes both units and parking (PARK-05)
- [ ] No TypeScript errors
- [ ] Build succeeds: `npm run build`
</verification>

## must_haves

- Combined occupancy percentage displayed
- Unit occupancy shows vacant vs occupied
- Parking occupancy shows free vs occupied (PARK-05)
- Progress bar reflects occupancy level
- Sparkline shows trend over time
- Color coding by occupancy threshold
