# Plan 12-02: Property Dashboard & Heatmap

---
phase: 12
plan: 02
name: Property Dashboard & Heatmap
wave: 2
depends_on: ["12-01"]
scope: medium
autonomous: true
files_modified:
  - src/app/dashboard/liegenschaft/page.tsx
  - src/components/dashboard/PropertyDashboard.tsx
  - src/components/dashboard/BuildingHeatmap.tsx
  - src/components/dashboard/HeatmapUnitCell.tsx
  - src/lib/dashboard/dashboard-queries.ts
  - src/lib/dashboard/heatmap-queries.ts
requirements:
  - DASH-01
  - DASH-02
  - DASH-03
---

## Objective

Create property-level dashboard page with building heatmap showing units colored by room condition status. Users see at-a-glance renovation state of the entire building.

## Context

From 12-RESEARCH.md and 12-CONTEXT.md:
- Building floorplan representation, not grid matrix
- Traffic light colors: red (old) -> yellow (partial) -> green (new)
- Click on unit opens side panel (implemented in 12-04)
- Use existing BuildingGrid pattern from `src/components/building/BuildingGrid.tsx`
- Condition data from `unit_condition_summary` view

Existing code references:
- `src/components/building/BuildingGrid.tsx` - 5-floor layout
- `src/components/building/UnitCell.tsx` - Progress bar display
- `src/components/units/ConditionBadge.tsx` - Condition colors
- `supabase/migrations/027_condition_tracking.sql` - unit_condition_summary view

## Tasks

<task id="01" title="Create dashboard query module">
Server-side queries for dashboard data aggregation.

**File:** `src/lib/dashboard/dashboard-queries.ts`

```typescript
import { createClient } from '@/lib/supabase/server'

export interface DashboardSummary {
  totalUnits: number
  totalRooms: number
  renovatedRooms: number
  averageRenovationPercent: number
  unitsWithProjects: number
  activeProjects: number
}

export async function fetchDashboardSummary(
  buildingId: string
): Promise<DashboardSummary> {
  const supabase = await createClient()

  // Get unit condition summaries
  const { data: summaries } = await supabase
    .from('unit_condition_summary')
    .select('*')
    .eq('building_id', buildingId)

  // Get active projects count
  const { count: activeProjects } = await supabase
    .from('renovation_projects')
    .select('id', { count: 'exact', head: true })
    .in('unit_id', (summaries || []).map(s => s.unit_id))
    .in('status', ['planned', 'in_progress'])

  const units = summaries || []
  const totalRooms = units.reduce((sum, u) => sum + (u.total_rooms || 0), 0)
  const renovatedRooms = units.reduce((sum, u) => sum + (u.new_rooms || 0), 0)
  const avgPercent = units.length > 0
    ? units.reduce((sum, u) => sum + (u.renovation_percentage || 0), 0) / units.length
    : 0

  return {
    totalUnits: units.length,
    totalRooms,
    renovatedRooms,
    averageRenovationPercent: Math.round(avgPercent),
    unitsWithProjects: units.filter(u => u.new_rooms || u.partial_rooms).length,
    activeProjects: activeProjects || 0
  }
}
```
</task>

<task id="02" title="Create heatmap query module" depends_on="01">
Fetch unit data with room conditions for heatmap display.

**File:** `src/lib/dashboard/heatmap-queries.ts`

```typescript
import { createClient } from '@/lib/supabase/server'
import type { RoomCondition } from '@/types'

export interface HeatmapUnit {
  id: string
  name: string
  floor: number | null
  position: string | null
  unit_type: string
  tenant_name: string | null
  total_rooms: number
  new_rooms: number
  partial_rooms: number
  old_rooms: number
  renovation_percentage: number | null
  overall_condition: RoomCondition | null
  rooms: Array<{
    id: string
    name: string
    room_type: string
    condition: RoomCondition
  }>
}

export async function fetchHeatmapData(
  buildingId: string
): Promise<HeatmapUnit[]> {
  const supabase = await createClient()

  // Fetch units with condition summary
  const { data: summaries } = await supabase
    .from('unit_condition_summary')
    .select('*')
    .eq('building_id', buildingId)

  // Fetch units with details
  const { data: units } = await supabase
    .from('units')
    .select(`
      id, name, floor, position, unit_type, tenant_name,
      rooms (id, name, room_type, condition)
    `)
    .eq('building_id', buildingId)
    .eq('unit_type', 'apartment')
    .order('floor', { ascending: false })

  // Merge data
  return (units || []).map(unit => {
    const summary = (summaries || []).find(s => s.unit_id === unit.id)
    const rooms = (unit.rooms || []) as Array<{
      id: string
      name: string
      room_type: string
      condition: RoomCondition
    }>

    return {
      id: unit.id,
      name: unit.name,
      floor: unit.floor,
      position: unit.position,
      unit_type: unit.unit_type,
      tenant_name: unit.tenant_name,
      total_rooms: summary?.total_rooms || rooms.length,
      new_rooms: summary?.new_rooms || 0,
      partial_rooms: summary?.partial_rooms || 0,
      old_rooms: summary?.old_rooms || 0,
      renovation_percentage: summary?.renovation_percentage || 0,
      overall_condition: summary?.overall_condition || null,
      rooms
    }
  })
}
```
</task>

<task id="03" title="Create HeatmapUnitCell component" depends_on="02">
Unit cell showing mini room condition dots.

**File:** `src/components/dashboard/HeatmapUnitCell.tsx`

```typescript
'use client'

import { Card } from '@/components/ui/card'
import { cn } from '@/lib/utils'
import type { HeatmapUnit } from '@/lib/dashboard/heatmap-queries'
import type { RoomCondition } from '@/types'

const CONDITION_DOT_COLORS: Record<RoomCondition, string> = {
  old: 'bg-red-500',
  partial: 'bg-yellow-500',
  new: 'bg-green-500'
}

const OVERALL_BG_COLORS: Record<RoomCondition, string> = {
  old: 'bg-red-50 dark:bg-red-950/30',
  partial: 'bg-yellow-50 dark:bg-yellow-950/30',
  new: 'bg-green-50 dark:bg-green-950/30'
}

interface HeatmapUnitCellProps {
  unit: HeatmapUnit
  onClick: () => void
  compact?: boolean
}

export function HeatmapUnitCell({ unit, onClick, compact = false }: HeatmapUnitCellProps) {
  const bgColor = unit.overall_condition
    ? OVERALL_BG_COLORS[unit.overall_condition]
    : 'bg-gray-50 dark:bg-gray-800'

  // Show at most 6 room dots, aggregate if more
  const displayRooms = unit.rooms.slice(0, 6)
  const hasMoreRooms = unit.rooms.length > 6

  return (
    <Card
      onClick={onClick}
      className={cn(
        'cursor-pointer transition-all duration-200',
        'hover:shadow-md hover:scale-[1.02]',
        'active:scale-[0.98]',
        bgColor,
        compact ? 'min-h-[60px]' : 'min-h-[80px]'
      )}
    >
      <div className={cn(
        'flex flex-col justify-between h-full',
        compact ? 'p-2' : 'p-3'
      )}>
        {/* Unit info */}
        <div className="flex-1">
          <h3 className={cn(
            'font-medium text-gray-900 dark:text-gray-100 truncate',
            compact ? 'text-xs' : 'text-sm'
          )}>
            {unit.name}
          </h3>

          {unit.tenant_name && (
            <p className={cn(
              'text-gray-500 dark:text-gray-400 truncate',
              compact ? 'text-[10px]' : 'text-xs'
            )}>
              {unit.tenant_name}
            </p>
          )}
        </div>

        {/* Room condition dots */}
        <div className="mt-2 flex flex-wrap gap-1">
          {displayRooms.map((room) => (
            <span
              key={room.id}
              className={cn(
                'rounded-full',
                compact ? 'w-2 h-2' : 'w-2.5 h-2.5',
                CONDITION_DOT_COLORS[room.condition]
              )}
              title={`${room.name}: ${room.condition}`}
            />
          ))}
          {hasMoreRooms && (
            <span className={cn(
              'text-gray-400 dark:text-gray-500',
              compact ? 'text-[8px]' : 'text-[10px]'
            )}>
              +{unit.rooms.length - 6}
            </span>
          )}
        </div>

        {/* Renovation percentage */}
        <div className="mt-1 flex items-center justify-between">
          <span className={cn(
            'text-gray-500 dark:text-gray-400',
            compact ? 'text-[9px]' : 'text-xs'
          )}>
            {unit.renovation_percentage ?? 0}% renoviert
          </span>
        </div>
      </div>
    </Card>
  )
}
```
</task>

<task id="04" title="Create BuildingHeatmap component" depends_on="02,03">
Full building heatmap using floor layout pattern.

**File:** `src/components/dashboard/BuildingHeatmap.tsx`

```typescript
import { cn } from '@/lib/utils'
import { fetchHeatmapData, type HeatmapUnit } from '@/lib/dashboard/heatmap-queries'
import { HeatmapUnitCell } from './HeatmapUnitCell'

const FLOOR_CONFIG = [
  { label: 'Dach', floor: 4, cols: 1 },
  { label: '3.OG', floor: 3, cols: 3 },
  { label: '2.OG', floor: 2, cols: 3 },
  { label: '1.OG', floor: 1, cols: 3 },
  { label: 'EG', floor: 0, cols: 3 },
] as const

const POSITION_ORDER = ['links', 'mitte', 'rechts'] as const

function getUnitByFloorPosition(
  units: HeatmapUnit[],
  floor: number,
  position: string
): HeatmapUnit | null {
  return units.find(
    (u) => u.floor === floor && u.position?.toLowerCase() === position.toLowerCase()
  ) || null
}

function getUnitByFloor(units: HeatmapUnit[], floor: number): HeatmapUnit | null {
  return units.find((u) => u.floor === floor) || null
}

interface BuildingHeatmapProps {
  buildingId: string
  onUnitClick?: (unitId: string) => void
  className?: string
}

export async function BuildingHeatmap({
  buildingId,
  onUnitClick,
  className
}: BuildingHeatmapProps) {
  const units = await fetchHeatmapData(buildingId)

  return (
    <div className={cn('space-y-1', className)}>
      {FLOOR_CONFIG.map(({ label, floor, cols }) => (
        <div key={floor} className="flex items-center gap-2">
          {/* Floor label */}
          <div className="w-10 sm:w-12 flex-shrink-0">
            <span className="text-xs sm:text-sm font-medium text-gray-500 dark:text-gray-400">
              {label}
            </span>
          </div>

          {/* Floor units */}
          <div className={cn(
            'flex-1 grid gap-1 sm:gap-2',
            cols === 1 ? 'grid-cols-1' : 'grid-cols-3'
          )}>
            {cols === 1 ? (
              <DachCell units={units} floor={floor} onUnitClick={onUnitClick} />
            ) : (
              POSITION_ORDER.map((position) => {
                const unit = getUnitByFloorPosition(units, floor, position)
                return unit ? (
                  <HeatmapUnitCell
                    key={unit.id}
                    unit={unit}
                    onClick={() => onUnitClick?.(unit.id)}
                    compact
                  />
                ) : (
                  <EmptyCell key={`${floor}-${position}`} />
                )
              })
            )}
          </div>
        </div>
      ))}
    </div>
  )
}

function DachCell({
  units,
  floor,
  onUnitClick
}: {
  units: HeatmapUnit[]
  floor: number
  onUnitClick?: (id: string) => void
}) {
  const unit = getUnitByFloor(units, floor)

  if (!unit) return <EmptyCell />

  return (
    <HeatmapUnitCell
      unit={unit}
      onClick={() => onUnitClick?.(unit.id)}
      compact
    />
  )
}

function EmptyCell() {
  return (
    <div className={cn(
      'min-h-[60px] rounded-xl',
      'border border-dashed border-gray-200 dark:border-gray-700',
      'bg-gray-50 dark:bg-gray-900/50',
      'flex items-center justify-center'
    )}>
      <span className="text-xs text-gray-400 dark:text-gray-500">-</span>
    </div>
  )
}
```
</task>

<task id="05" title="Create PropertyDashboard container" depends_on="01,04">
Main dashboard container component.

**File:** `src/components/dashboard/PropertyDashboard.tsx`

```typescript
import { fetchDashboardSummary } from '@/lib/dashboard/dashboard-queries'
import { BuildingHeatmap } from './BuildingHeatmap'
import { ParkingSection } from '@/components/parking/ParkingSection'
import { cn } from '@/lib/utils'

interface PropertyDashboardProps {
  buildingId: string
  onUnitClick?: (unitId: string) => void
  className?: string
}

export async function PropertyDashboard({
  buildingId,
  onUnitClick,
  className
}: PropertyDashboardProps) {
  const summary = await fetchDashboardSummary(buildingId)

  return (
    <div className={cn('space-y-6', className)}>
      {/* Summary Stats */}
      <div className="grid grid-cols-2 sm:grid-cols-4 gap-4">
        <StatCard
          label="Wohnungen"
          value={summary.totalUnits}
        />
        <StatCard
          label="Renovierungsgrad"
          value={`${summary.averageRenovationPercent}%`}
          color="green"
        />
        <StatCard
          label="Aktive Projekte"
          value={summary.activeProjects}
          color="blue"
        />
        <StatCard
          label="Raeume renoviert"
          value={`${summary.renovatedRooms}/${summary.totalRooms}`}
        />
      </div>

      {/* Building + Parking Layout */}
      <div className="flex gap-4">
        {/* Building Heatmap */}
        <div className="flex-1">
          <h3 className="text-sm font-medium text-gray-700 dark:text-gray-300 mb-3">
            Gebaeude
          </h3>
          <BuildingHeatmap
            buildingId={buildingId}
            onUnitClick={onUnitClick}
          />
        </div>

        {/* Parking Section */}
        <div className="w-24 sm:w-32 flex-shrink-0">
          <ParkingSection buildingId={buildingId} />
        </div>
      </div>
    </div>
  )
}

function StatCard({
  label,
  value,
  color
}: {
  label: string
  value: string | number
  color?: 'green' | 'blue' | 'amber'
}) {
  const colorClasses = {
    green: 'text-green-600 dark:text-green-400',
    blue: 'text-blue-600 dark:text-blue-400',
    amber: 'text-amber-600 dark:text-amber-400'
  }

  return (
    <div className="p-4 bg-white dark:bg-gray-900 rounded-lg border border-gray-200 dark:border-gray-700">
      <p className="text-xs text-gray-500 dark:text-gray-400 mb-1">{label}</p>
      <p className={cn(
        'text-xl font-bold',
        color ? colorClasses[color] : 'text-gray-900 dark:text-gray-100'
      )}>
        {value}
      </p>
    </div>
  )
}
```
</task>

<task id="06" title="Create dashboard page" depends_on="05">
Main dashboard page route.

**File:** `src/app/dashboard/liegenschaft/page.tsx`

```typescript
import { cookies } from 'next/headers'
import { redirect } from 'next/navigation'
import { PropertyDashboard } from '@/components/dashboard/PropertyDashboard'
import { createClient } from '@/lib/supabase/server'
import type { Role } from '@/types'

export const metadata = {
  title: 'Liegenschaft - KEWA Dashboard',
  description: 'Property overview with building heatmap and parking status'
}

async function getDefaultBuilding(): Promise<string | null> {
  const supabase = await createClient()
  const { data } = await supabase
    .from('buildings')
    .select('id')
    .limit(1)
    .single()

  return data?.id ?? null
}

export default async function LiegenschaftPage() {
  // Auth check
  const cookieStore = await cookies()
  const sessionCookie = cookieStore.get('kewa-session')

  if (!sessionCookie?.value) {
    redirect('/login')
  }

  let role: Role
  try {
    const session = JSON.parse(sessionCookie.value)
    role = session.role
  } catch {
    redirect('/login')
  }

  // Only KEWA can see full dashboard
  if (role !== 'kewa') {
    redirect('/dashboard')
  }

  const buildingId = await getDefaultBuilding()

  if (!buildingId) {
    return (
      <div className="p-8 text-center text-gray-500">
        Kein Gebaeude konfiguriert.
      </div>
    )
  }

  return (
    <div className="space-y-6 pb-20">
      <div className="flex items-center justify-between">
        <h1 className="text-2xl font-bold text-gray-900 dark:text-gray-100">
          Liegenschaftsuebersicht
        </h1>
      </div>

      <PropertyDashboard buildingId={buildingId} />
    </div>
  )
}
```
</task>

## Verification

<verification>
- [ ] Dashboard page accessible at /dashboard/liegenschaft
- [ ] Summary stats show correct counts
- [ ] Building heatmap renders 5 floors correctly
- [ ] Unit cells show room condition dots
- [ ] Unit cell background reflects overall condition
- [ ] Parking section displays alongside building
- [ ] Click on unit cell triggers onUnitClick (for 12-04)
- [ ] Empty cells shown for missing units
- [ ] No TypeScript errors
- [ ] Build succeeds: `npm run build`
</verification>

## must_haves

- Property-level dashboard page exists
- Heatmap shows units colored by condition
- Units display room-level condition dots
- Traffic light colors: red=old, yellow=partial, green=new
- Renovation percentage visible per unit
- Parking section displayed alongside building
