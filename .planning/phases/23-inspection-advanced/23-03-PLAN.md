---
phase: 23-inspection-advanced
plan: 03
type: execute
wave: 2
depends_on: [23-01, 23-02]
files_modified:
  - src/app/dashboard/abnahmen/[id]/page.tsx
  - src/components/inspections/InspectionDetail.tsx
  - src/app/dashboard/liegenschaft/[id]/einheit/[unitId]/raum/[roomId]/page.tsx
autonomous: true

must_haves:
  truths:
    - "Room condition automatically updates when signed inspection completes"
    - "User can see which inspection updated a room's condition"
    - "User can access portal link and PDF from inspection detail page"
    - "Inspection detail shows acknowledgment status from contractor"
  artifacts:
    - path: "src/components/inspections/InspectionDetail.tsx"
      provides: "Comprehensive detail view with portal and PDF actions"
      min_lines: 100
    - path: "src/app/dashboard/liegenschaft/[id]/einheit/[unitId]/raum/[roomId]/page.tsx"
      provides: "Room detail showing condition source inspection"
      contains: "condition_source_project_id"
  key_links:
    - from: "src/components/inspections/InspectionDetail.tsx"
      to: "SendPortalDialog, ReInspectionButton"
      via: "component composition"
      pattern: "SendPortalDialog|ReInspectionButton"
---

<objective>
Integrate all Phase 23 components into inspection detail page and verify room condition automation.

Purpose: Provide unified inspection management experience with portal access, PDF download, re-inspection scheduling, and acknowledgment tracking. Verify room condition trigger works end-to-end.

Output:
- Enhanced inspection detail with all Phase 23 actions integrated
- Acknowledgment status display in inspection detail
- Room detail page showing condition source information
- Integration testing of room condition trigger
</objective>

<execution_context>
@C:\Users\Mario Giacchino\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\Mario Giacchino\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/23-inspection-advanced/23-01-PLAN.md
@.planning/phases/23-inspection-advanced/23-02-PLAN.md
@.planning/phases/23-inspection-advanced/23-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Integrate Phase 23 components into inspection detail</name>
  <files>
src/components/inspections/InspectionDetail.tsx
src/app/dashboard/abnahmen/[id]/page.tsx
  </files>
  <action>
**Update src/components/inspections/InspectionDetail.tsx** to include all Phase 23 features:

1. **Import new components:**
```typescript
import { ReInspectionButton } from './ReInspectionButton'
import { InspectionHistory } from './InspectionHistory'
import { SendPortalDialog } from './SendPortalDialog'
```

2. **Add state for portal dialog:**
```typescript
const [showPortalDialog, setShowPortalDialog] = useState(false)
```

3. **Add acknowledgment status section** (after signature section):
```typescript
{/* Acknowledgment Status */}
{inspection.acknowledged_at && (
  <div className="border-t pt-4 mt-4">
    <h4 className="text-sm font-semibold text-gray-500 mb-2">Handwerker-Bestaetigung</h4>
    <div className="bg-green-50 border border-green-200 rounded-lg p-3">
      <div className="flex items-center gap-2 text-green-800">
        <span className="text-lg">&#10003;</span>
        <div>
          <p className="font-medium">Kenntnisnahme bestaetigt</p>
          <p className="text-sm text-green-600">
            {new Date(inspection.acknowledged_at).toLocaleString('de-CH')}
            {inspection.acknowledged_by_email && ` von ${inspection.acknowledged_by_email}`}
          </p>
        </div>
      </div>
    </div>
  </div>
)}
```

4. **Add action buttons section** for signed inspections:
```typescript
{/* Actions for signed inspections */}
{inspection.status === 'signed' && (
  <div className="border-t pt-4 mt-4">
    <h4 className="text-sm font-semibold text-gray-500 mb-3">Aktionen</h4>
    <div className="flex flex-wrap gap-3">
      {/* PDF Download */}
      <a
        href={`/api/inspections/${inspection.id}/pdf`}
        download
        className="px-4 py-2 text-sm bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 flex items-center gap-2"
      >
        <span>&#128196;</span> PDF herunterladen
      </a>

      {/* Send Portal Link */}
      <button
        onClick={() => setShowPortalDialog(true)}
        className="px-4 py-2 text-sm bg-blue-100 text-blue-700 rounded-lg hover:bg-blue-200 flex items-center gap-2"
      >
        <span>&#9993;</span> Portal-Link senden
      </button>

      {/* Re-inspection */}
      <ReInspectionButton inspection={inspection} />
    </div>
  </div>
)}
```

5. **Add inspection history section** (at bottom):
```typescript
{/* Inspection History */}
{(inspection.parent_inspection_id || hasChildren) && (
  <div className="border-t pt-4 mt-4">
    <InspectionHistory
      inspectionId={inspection.id}
      currentInspectionId={inspection.id}
    />
  </div>
)}
```

6. **Add re-inspection badge** in header if parent exists:
```typescript
{inspection.parent_inspection_id && (
  <span className="ml-2 px-2 py-0.5 text-xs bg-purple-100 text-purple-700 rounded">
    Nachkontrolle
  </span>
)}
```

7. **Add portal dialog:**
```typescript
<SendPortalDialog
  inspection={inspection}
  isOpen={showPortalDialog}
  onClose={() => setShowPortalDialog(false)}
/>
```

**Update src/app/dashboard/abnahmen/[id]/page.tsx** to fetch acknowledgment data:
- Add `acknowledged_at, acknowledged_by_email` to select query
- Pass updated inspection object to InspectionDetail component
  </action>
  <verify>
Run `npm run build` to verify component compiles. Check all actions visible on signed inspection.
  </verify>
  <done>
Inspection detail shows acknowledgment status, PDF download, portal link, re-inspection button, and history timeline for signed inspections.
  </done>
</task>

<task type="auto">
  <name>Task 2: Room detail page with condition source display</name>
  <files>
src/app/dashboard/liegenschaft/[id]/einheit/[unitId]/raum/[roomId]/page.tsx
  </files>
  <action>
**Update room detail page** to show condition source information:

1. **Fetch room with condition fields:**
```typescript
const { data: room } = await supabase
  .from('rooms')
  .select(`
    *,
    condition_source_project:renovation_projects!condition_source_project_id(id, name)
  `)
  .eq('id', roomId)
  .single()
```

2. **Add condition section to room detail:**
```typescript
{/* Room Condition */}
<div className="bg-white rounded-lg shadow p-4">
  <h3 className="text-sm font-semibold text-gray-500 mb-3">Raumzustand</h3>

  <div className="flex items-center gap-3 mb-3">
    <span className={`px-3 py-1 rounded-full text-sm font-medium ${
      room.condition === 'new' ? 'bg-green-100 text-green-800' :
      room.condition === 'partial' ? 'bg-yellow-100 text-yellow-800' :
      'bg-gray-100 text-gray-800'
    }`}>
      {room.condition === 'new' ? 'Neu' :
       room.condition === 'partial' ? 'Teilsaniert' : 'Unsaniert'}
    </span>
  </div>

  {room.condition_updated_at && (
    <p className="text-sm text-gray-600">
      Aktualisiert am {new Date(room.condition_updated_at).toLocaleDateString('de-CH')}
    </p>
  )}

  {room.condition_source_project && (
    <p className="text-sm text-gray-500 mt-1">
      Quelle: <a href={`/dashboard/projekt/${room.condition_source_project.id}`} className="text-blue-600 hover:underline">
        {room.condition_source_project.name}
      </a>
    </p>
  )}
</div>
```

3. **Add helper text explaining automation:**
```typescript
<p className="text-xs text-gray-400 mt-2">
  Der Raumzustand wird automatisch aktualisiert, wenn eine Abnahme mit Ergebnis "Bestanden" oder "Bestanden mit Auflagen" abgeschlossen wird.
</p>
```
  </action>
  <verify>
Run `npm run build` to verify page compiles. Check condition source displays after inspection completion.
  </verify>
  <done>
Room detail shows current condition, last update date, and source project link when condition was updated by inspection.
  </done>
</task>

<task type="auto">
  <name>Task 3: Update inspection types and verify integration</name>
  <files>
src/types/inspections.ts
src/lib/inspections/queries.ts
  </files>
  <action>
**Update src/types/inspections.ts** to include acknowledgment and portal fields:

```typescript
// Add to Inspection interface
export interface Inspection {
  // ... existing fields ...

  // Phase 23 additions
  acknowledged_at?: string | null
  acknowledged_by_email?: string | null

  // Re-inspection tracking (already exists from 22-01)
  parent_inspection_id?: string | null
}

// Add portal token type
export interface InspectionPortalToken {
  id: string
  token: string
  inspection_id: string
  created_at: string
}
```

**Update src/lib/inspections/queries.ts** to include acknowledgment fields in select:

In `getInspection` and `listInspections` functions, ensure the select includes:
```typescript
.select(`
  *,
  acknowledged_at,
  acknowledged_by_email,
  // ... existing joins
`)
```

**Verify room condition trigger works:**

The trigger in 060_inspection_advanced.sql should:
1. Fire when inspection.status changes to 'signed'
2. Find room via work_order.room_id
3. Map overall_result to condition (passed→new, passed_with_conditions→partial)
4. Update room with new condition, timestamp, and source project

Test scenarios to verify (documented for manual testing):
- Inspection linked to work order with room_id → room condition updates
- Inspection linked to work order without room_id → trigger logs notice, no update
- Inspection with overall_result='failed' → no condition change
- Inspection with overall_result='passed' → condition becomes 'new'
- Inspection with overall_result='passed_with_conditions' → condition becomes 'partial'
  </action>
  <verify>
1. Run `npx tsc --noEmit` to verify types compile
2. Run `npm run build` to verify all files compile
3. Verify inspection query includes acknowledgment fields:
   ```bash
   grep -n "acknowledged_at" src/lib/inspections/queries.ts
   ```
4. Verify trigger function exists in migration:
   ```bash
   grep -n "update_room_condition_from_inspection" supabase/migrations/060_inspection_advanced.sql
   ```
5. Verify migration adds acknowledgment columns:
   ```bash
   grep -n "acknowledged_at" supabase/migrations/060_inspection_advanced.sql
   ```
  </verify>
  <done>
Types include acknowledgment fields. Queries fetch acknowledgment data in select. Migration contains trigger function and acknowledgment columns. Room condition automation verified via trigger grep.
  </done>
</task>

</tasks>

<verification>
1. TypeScript: `npx tsc --noEmit` passes
2. Build: `npm run build` completes without errors
3. Inspection detail shows:
   - Acknowledgment status (green box when acknowledged)
   - PDF download button for signed inspections
   - Portal link button for signed inspections
   - Re-inspection button for completed/signed inspections
   - History timeline when parent or children exist
   - "Nachkontrolle" badge for re-inspections
4. Room detail shows condition with source project link
5. Migration includes room condition trigger
</verification>

<success_criteria>
- Signed inspection shows all action buttons (PDF, portal, re-inspect)
- Acknowledged inspections show green confirmation with timestamp and email
- Room detail shows condition source when updated by inspection
- Re-inspections show "Nachkontrolle" badge and link to parent
- All four INSP requirements (09-12) satisfied
</success_criteria>

<output>
After completion, create `.planning/phases/23-inspection-advanced/23-03-SUMMARY.md`
</output>
