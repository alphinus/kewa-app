---
phase: 23-inspection-advanced
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/inspections/portal-tokens.ts
  - src/app/api/portal/inspections/[token]/route.ts
  - src/app/api/portal/inspections/[token]/acknowledge/route.ts
  - src/app/api/inspections/[id]/send-portal/route.ts
  - src/app/portal/inspections/[token]/page.tsx
  - src/components/inspections/ContractorInspectionView.tsx
  - src/components/inspections/SendPortalDialog.tsx
  - src/components/inspections/InspectionPDF.tsx
  - src/app/api/inspections/[id]/pdf/route.ts
autonomous: true

must_haves:
  truths:
    - "Contractor can view inspection results via magic link without login"
    - "Contractor can acknowledge receipt of inspection results"
    - "User can send inspection portal link to contractor email"
    - "Portal shows inspection details, defects, and overall result"
    - "User can generate and download PDF Abnahme-Protokoll"
  artifacts:
    - path: "src/lib/inspections/portal-tokens.ts"
      provides: "Token creation and validation for inspection portal"
      exports: ["createInspectionPortalToken", "validateInspectionPortalToken"]
    - path: "src/app/portal/inspections/[token]/page.tsx"
      provides: "Public contractor portal page"
      min_lines: 50
    - path: "src/components/inspections/ContractorInspectionView.tsx"
      provides: "Read-only inspection view for contractors"
      min_lines: 80
    - path: "src/components/inspections/InspectionPDF.tsx"
      provides: "PDF protocol template with embedded signature"
      min_lines: 100
  key_links:
    - from: "src/app/portal/inspections/[token]/page.tsx"
      to: "/api/portal/inspections/[token]"
      via: "fetch for inspection data"
      pattern: "fetch.*portal/inspections"
    - from: "src/app/api/portal/inspections/[token]/route.ts"
      to: "src/lib/inspections/portal-tokens.ts"
      via: "validateInspectionPortalToken call"
      pattern: "validateInspectionPortalToken"
---

<objective>
Create contractor portal for viewing and acknowledging inspection results via magic links, and enhance PDF generation for Abnahme-Protokoll.

Purpose: Enable contractors to view inspection results after completion without needing an account. Provides official Abnahme-Protokoll PDF with all details.

Output:
- Portal token creation and validation functions
- Public portal API endpoints (no auth required)
- Contractor-facing portal page with inspection details
- Send portal dialog for emailing magic links
- Enhanced PDF protocol with full inspection data
</objective>

<execution_context>
@C:\Users\Mario Giacchino\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\Mario Giacchino\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/22-inspection-core/22-03-SUMMARY.md
@.planning/phases/21-change-orders/21-04-SUMMARY.md
@.planning/phases/23-inspection-advanced/23-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Portal token library and API endpoints</name>
  <files>
src/lib/inspections/portal-tokens.ts
src/app/api/portal/inspections/[token]/route.ts
src/app/api/portal/inspections/[token]/acknowledge/route.ts
src/app/api/inspections/[id]/send-portal/route.ts
  </files>
  <action>
**src/lib/inspections/portal-tokens.ts** - Token creation and validation:

```typescript
import { createClient } from '@/lib/supabase/server'

export async function createInspectionPortalToken(
  inspectionId: string,
  contractorEmail: string,
  expiryHours: number = 168 // 7 days default
): Promise<string> {
  const supabase = await createClient()

  // Use existing magic link token RPC
  const { data: token, error: tokenError } = await supabase.rpc('create_magic_link_token', {
    p_email: contractorEmail,
    p_purpose: 'inspection_acknowledgment',
    p_expires_hours: expiryHours,
  })

  if (tokenError) throw tokenError

  // Link token to inspection via junction table
  const { error: linkError } = await supabase
    .from('inspection_portal_tokens')
    .insert({
      token,
      inspection_id: inspectionId,
    })

  if (linkError) throw linkError

  return token
}

export async function validateInspectionPortalToken(token: string): Promise<{
  valid: boolean
  inspectionId?: string
  email?: string
}> {
  const supabase = await createClient()

  // Validate token (read-only, DO NOT consume)
  const { data: tokenData } = await supabase
    .from('magic_link_tokens')
    .select('*')
    .eq('token', token)
    .is('used_at', null)
    .eq('is_revoked', false)
    .gt('expires_at', new Date().toISOString())
    .eq('purpose', 'inspection_acknowledgment')
    .single()

  if (!tokenData) return { valid: false }

  // Get linked inspection
  const { data: portalToken } = await supabase
    .from('inspection_portal_tokens')
    .select('inspection_id')
    .eq('token', token)
    .single()

  if (!portalToken) return { valid: false }

  return {
    valid: true,
    inspectionId: portalToken.inspection_id,
    email: tokenData.email,
  }
}

export async function consumeInspectionPortalToken(token: string): Promise<boolean> {
  const supabase = await createClient()

  const { error } = await supabase
    .from('magic_link_tokens')
    .update({ used_at: new Date().toISOString() })
    .eq('token', token)
    .is('used_at', null)

  return !error
}
```

**src/app/api/portal/inspections/[token]/route.ts** - Public GET (no auth):

```typescript
import { NextRequest, NextResponse } from 'next/server'
import { createClient } from '@/lib/supabase/server'
import { validateInspectionPortalToken } from '@/lib/inspections/portal-tokens'

export async function GET(
  request: NextRequest,
  { params }: { params: Promise<{ token: string }> }
) {
  const { token } = await params

  const validation = await validateInspectionPortalToken(token)
  if (!validation.valid || !validation.inspectionId) {
    return NextResponse.json({ valid: false, error: 'Token ungueltig oder abgelaufen' }, { status: 401 })
  }

  const supabase = await createClient()

  // Fetch inspection with defects (exclude internal fields)
  const { data: inspection } = await supabase
    .from('inspections')
    .select(`
      id, title, description, inspection_date, status, overall_result,
      checklist_items, signer_name, signer_role, signed_at,
      signature_refused, signature_refused_reason,
      work_order:work_orders(id, name),
      project:renovation_projects(id, name),
      defects:inspection_defects(id, title, description, severity, status, action)
    `)
    .eq('id', validation.inspectionId)
    .single()

  if (!inspection) {
    return NextResponse.json({ valid: false, error: 'Inspektion nicht gefunden' }, { status: 404 })
  }

  return NextResponse.json({
    valid: true,
    inspection,
    email: validation.email,
  })
}
```

**src/app/api/portal/inspections/[token]/acknowledge/route.ts** - POST (consumes token):

```typescript
import { NextRequest, NextResponse } from 'next/server'
import { createClient } from '@/lib/supabase/server'
import { validateInspectionPortalToken, consumeInspectionPortalToken } from '@/lib/inspections/portal-tokens'

export async function POST(
  request: NextRequest,
  { params }: { params: Promise<{ token: string }> }
) {
  const { token } = await params

  const validation = await validateInspectionPortalToken(token)
  if (!validation.valid || !validation.inspectionId) {
    return NextResponse.json({ error: 'Token ungueltig oder abgelaufen' }, { status: 401 })
  }

  const supabase = await createClient()

  // Update inspection with acknowledgment timestamp
  const { error: updateError } = await supabase
    .from('inspections')
    .update({
      acknowledged_at: new Date().toISOString(),
      acknowledged_by_email: validation.email,
    })
    .eq('id', validation.inspectionId)

  if (updateError) {
    return NextResponse.json({ error: 'Fehler beim Bestaetigen' }, { status: 500 })
  }

  // Consume token to prevent reuse
  await consumeInspectionPortalToken(token)

  return NextResponse.json({ success: true })
}
```

**src/app/api/inspections/[id]/send-portal/route.ts** - Internal API for sending link:

```typescript
import { NextRequest, NextResponse } from 'next/server'
import { getCurrentUser } from '@/lib/auth'
import { createInspectionPortalToken } from '@/lib/inspections/portal-tokens'

export async function POST(
  request: NextRequest,
  { params }: { params: Promise<{ id: string }> }
) {
  const { id } = await params
  const user = await getCurrentUser()
  if (!user) return NextResponse.json({ error: 'Unauthorized' }, { status: 401 })

  const body = await request.json()
  const { email } = body

  if (!email) {
    return NextResponse.json({ error: 'email required' }, { status: 400 })
  }

  try {
    const token = await createInspectionPortalToken(id, email)
    const portalUrl = `${process.env.NEXT_PUBLIC_APP_URL}/portal/inspections/${token}`

    // Note: Email sending would be integrated here in Phase 24
    // For now, return the URL for manual sharing

    return NextResponse.json({ portalUrl, token })
  } catch (error) {
    return NextResponse.json({ error: (error as Error).message }, { status: 400 })
  }
}
```
  </action>
  <verify>
Run `npx tsc --noEmit` to verify types. Check portal routes have no auth requirement.
  </verify>
  <done>
Portal token creation links token to inspection. Validation returns inspection ID. Acknowledge consumes token.
  </done>
</task>

<task type="auto">
  <name>Task 2: Contractor portal page and view components</name>
  <files>
src/app/portal/inspections/[token]/page.tsx
src/components/inspections/ContractorInspectionView.tsx
src/components/inspections/SendPortalDialog.tsx
  </files>
  <action>
**src/app/portal/inspections/[token]/page.tsx** - Public portal page:

```typescript
'use client'

import { useEffect, useState } from 'react'
import { useParams } from 'next/navigation'
import { ContractorInspectionView } from '@/components/inspections/ContractorInspectionView'

interface PortalData {
  valid: boolean
  inspection?: any
  email?: string
  error?: string
}

export default function InspectionPortalPage() {
  const params = useParams()
  const token = params.token as string

  const [data, setData] = useState<PortalData | null>(null)
  const [acknowledged, setAcknowledged] = useState(false)
  const [loading, setLoading] = useState(true)

  useEffect(() => {
    fetch(`/api/portal/inspections/${token}`)
      .then(res => res.json())
      .then(setData)
      .finally(() => setLoading(false))
  }, [token])

  async function handleAcknowledge() {
    const res = await fetch(`/api/portal/inspections/${token}/acknowledge`, {
      method: 'POST',
    })
    if (res.ok) {
      setAcknowledged(true)
    }
  }

  if (loading) {
    return (
      <div className="min-h-screen bg-gray-100 flex items-center justify-center">
        <div className="text-gray-500">Lade Abnahmeprotokoll...</div>
      </div>
    )
  }

  if (!data?.valid) {
    return (
      <div className="min-h-screen bg-gray-100 flex items-center justify-center">
        <div className="bg-white rounded-lg shadow-lg p-8 max-w-md text-center">
          <div className="text-red-500 text-4xl mb-4">!</div>
          <h1 className="text-xl font-semibold mb-2">Link ungueltig</h1>
          <p className="text-gray-600">
            {data?.error || 'Dieser Link ist abgelaufen oder wurde bereits verwendet.'}
          </p>
        </div>
      </div>
    )
  }

  if (acknowledged) {
    return (
      <div className="min-h-screen bg-gray-100 flex items-center justify-center">
        <div className="bg-white rounded-lg shadow-lg p-8 max-w-md text-center">
          <div className="text-green-500 text-4xl mb-4">&#10003;</div>
          <h1 className="text-xl font-semibold mb-2">Bestaetigt</h1>
          <p className="text-gray-600">
            Vielen Dank. Die Bestaetigung wurde erfolgreich uebermittelt.
          </p>
        </div>
      </div>
    )
  }

  return (
    <div className="min-h-screen bg-gray-100 py-8">
      <div className="max-w-3xl mx-auto px-4">
        {/* Header */}
        <div className="bg-blue-900 text-white rounded-t-lg p-6">
          <h1 className="text-xl font-semibold">KEWA AG</h1>
          <p className="text-blue-200 text-sm">Abnahmeprotokoll</p>
        </div>

        {/* Content */}
        <div className="bg-white rounded-b-lg shadow-lg">
          <ContractorInspectionView
            inspection={data.inspection}
            onAcknowledge={handleAcknowledge}
          />
        </div>
      </div>
    </div>
  )
}
```

**src/components/inspections/ContractorInspectionView.tsx** - Read-only view:

```typescript
'use client'

import { useState } from 'react'
import { InspectionStatusBadge } from './InspectionStatusBadge'
import { SeverityBadge } from './SeverityBadge'

interface ContractorInspectionViewProps {
  inspection: any
  onAcknowledge: () => void
}

export function ContractorInspectionView({
  inspection,
  onAcknowledge,
}: ContractorInspectionViewProps) {
  const [confirming, setConfirming] = useState(false)

  const resultLabels: Record<string, string> = {
    passed: 'Bestanden',
    passed_with_conditions: 'Bestanden mit Auflagen',
    failed: 'Nicht bestanden',
  }

  const resultColors: Record<string, string> = {
    passed: 'bg-green-100 text-green-800',
    passed_with_conditions: 'bg-yellow-100 text-yellow-800',
    failed: 'bg-red-100 text-red-800',
  }

  return (
    <div className="p-6 space-y-6">
      {/* Header Info */}
      <div className="grid grid-cols-2 gap-4">
        <div>
          <span className="text-sm text-gray-500">Titel</span>
          <p className="font-medium">{inspection.title}</p>
        </div>
        <div>
          <span className="text-sm text-gray-500">Datum</span>
          <p className="font-medium">
            {new Date(inspection.inspection_date).toLocaleDateString('de-CH')}
          </p>
        </div>
        {inspection.work_order && (
          <div>
            <span className="text-sm text-gray-500">Arbeitsauftrag</span>
            <p className="font-medium">{inspection.work_order.name}</p>
          </div>
        )}
        {inspection.project && (
          <div>
            <span className="text-sm text-gray-500">Projekt</span>
            <p className="font-medium">{inspection.project.name}</p>
          </div>
        )}
      </div>

      {/* Overall Result */}
      <div className="border-t pt-4">
        <span className="text-sm text-gray-500 block mb-2">Gesamtergebnis</span>
        <span className={`px-4 py-2 rounded-lg text-sm font-medium ${resultColors[inspection.overall_result] || 'bg-gray-100'}`}>
          {resultLabels[inspection.overall_result] || inspection.overall_result}
        </span>
      </div>

      {/* Defects */}
      {inspection.defects?.length > 0 && (
        <div className="border-t pt-4">
          <h3 className="font-semibold mb-3">Maengel ({inspection.defects.length})</h3>
          <div className="space-y-2">
            {inspection.defects.map((defect: any) => (
              <div key={defect.id} className="bg-gray-50 rounded-lg p-3">
                <div className="flex items-center justify-between mb-1">
                  <span className="font-medium">{defect.title}</span>
                  <SeverityBadge severity={defect.severity} />
                </div>
                {defect.description && (
                  <p className="text-sm text-gray-600">{defect.description}</p>
                )}
                {defect.action && (
                  <p className="text-xs text-gray-500 mt-1">
                    Massnahme: {defect.action === 'task_created' ? 'Aufgabe erstellt' :
                              defect.action === 'deferred' ? 'Aufgeschoben' : 'Abgelehnt'}
                  </p>
                )}
              </div>
            ))}
          </div>
        </div>
      )}

      {/* Signature Info */}
      {inspection.signed_at && (
        <div className="border-t pt-4">
          <h3 className="font-semibold mb-3">Unterschrift</h3>
          <div className="bg-gray-50 rounded-lg p-4">
            <p className="font-medium">{inspection.signer_name}</p>
            <p className="text-sm text-gray-600">{inspection.signer_role}</p>
            <p className="text-xs text-gray-500 mt-1">
              {new Date(inspection.signed_at).toLocaleString('de-CH')}
            </p>
          </div>
        </div>
      )}

      {inspection.signature_refused && (
        <div className="border-t pt-4">
          <div className="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
            <h3 className="font-semibold text-yellow-800 mb-1">Unterschrift verweigert</h3>
            <p className="text-sm text-yellow-700">{inspection.signature_refused_reason}</p>
          </div>
        </div>
      )}

      {/* Acknowledge Button */}
      <div className="border-t pt-6">
        {!confirming ? (
          <button
            onClick={() => setConfirming(true)}
            className="w-full py-3 bg-blue-600 text-white rounded-lg font-medium hover:bg-blue-700"
          >
            Kenntnisnahme bestaetigen
          </button>
        ) : (
          <div className="space-y-3">
            <p className="text-sm text-gray-600 text-center">
              Mit der Bestaetigung erklaeren Sie, dass Sie das Abnahmeprotokoll erhalten und zur Kenntnis genommen haben.
            </p>
            <div className="flex gap-3">
              <button
                onClick={() => setConfirming(false)}
                className="flex-1 py-3 border rounded-lg font-medium"
              >
                Abbrechen
              </button>
              <button
                onClick={onAcknowledge}
                className="flex-1 py-3 bg-green-600 text-white rounded-lg font-medium hover:bg-green-700"
              >
                Bestaetigen
              </button>
            </div>
          </div>
        )}
      </div>
    </div>
  )
}
```

**src/components/inspections/SendPortalDialog.tsx** - Internal UI for sending link:

```typescript
'use client'

import { useState } from 'react'
import { Inspection } from '@/types/inspections'

interface SendPortalDialogProps {
  inspection: Inspection
  isOpen: boolean
  onClose: () => void
}

export function SendPortalDialog({ inspection, isOpen, onClose }: SendPortalDialogProps) {
  const [email, setEmail] = useState('')
  const [portalUrl, setPortalUrl] = useState<string | null>(null)
  const [loading, setLoading] = useState(false)
  const [copied, setCopied] = useState(false)

  if (!isOpen) return null

  async function handleSend(e: React.FormEvent) {
    e.preventDefault()
    if (!email) return

    setLoading(true)
    try {
      const res = await fetch(`/api/inspections/${inspection.id}/send-portal`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email }),
      })

      if (res.ok) {
        const data = await res.json()
        setPortalUrl(data.portalUrl)
      }
    } finally {
      setLoading(false)
    }
  }

  function handleCopy() {
    if (portalUrl) {
      navigator.clipboard.writeText(portalUrl)
      setCopied(true)
      setTimeout(() => setCopied(false), 2000)
    }
  }

  return (
    <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
      <div className="bg-white rounded-lg p-6 w-full max-w-md">
        <h3 className="text-lg font-semibold mb-4">Portal-Link senden</h3>

        {!portalUrl ? (
          <form onSubmit={handleSend}>
            <label className="block mb-4">
              <span className="text-sm text-gray-600">E-Mail-Adresse des Handwerkers</span>
              <input
                type="email"
                value={email}
                onChange={e => setEmail(e.target.value)}
                placeholder="handwerker@firma.ch"
                className="w-full mt-1 px-3 py-2 border rounded-lg"
                required
              />
            </label>
            <p className="text-sm text-gray-500 mb-4">
              Der Handwerker erhaelt einen Link zum Ansehen und Bestaetigen des Abnahmeprotokolls. Der Link ist 7 Tage gueltig.
            </p>
            <div className="flex gap-3 justify-end">
              <button
                type="button"
                onClick={onClose}
                className="px-4 py-2 text-sm border rounded-lg"
              >
                Abbrechen
              </button>
              <button
                type="submit"
                disabled={loading || !email}
                className="px-4 py-2 text-sm bg-blue-600 text-white rounded-lg disabled:opacity-50"
              >
                {loading ? 'Erstelle...' : 'Link erstellen'}
              </button>
            </div>
          </form>
        ) : (
          <div>
            <p className="text-sm text-gray-600 mb-2">Portal-Link erstellt:</p>
            <div className="bg-gray-100 rounded-lg p-3 mb-4 break-all text-sm">
              {portalUrl}
            </div>
            <div className="flex gap-3 justify-end">
              <button
                onClick={handleCopy}
                className="px-4 py-2 text-sm border rounded-lg"
              >
                {copied ? 'Kopiert!' : 'Link kopieren'}
              </button>
              <button
                onClick={onClose}
                className="px-4 py-2 text-sm bg-blue-600 text-white rounded-lg"
              >
                Schliessen
              </button>
            </div>
          </div>
        )}
      </div>
    </div>
  )
}
```
  </action>
  <verify>
Run `npm run build` to verify portal page compiles. Check no auth middleware on /portal/* routes.
  </verify>
  <done>
Contractor can view inspection via token URL. Acknowledge button confirms receipt. Internal dialog generates portal links.
  </done>
</task>

<task type="auto">
  <name>Task 3: Enhance PDF protocol with full Abnahme-Protokoll format</name>
  <files>
src/components/inspections/InspectionPDF.tsx
src/app/api/inspections/[id]/pdf/route.ts
supabase/migrations/060_inspection_advanced.sql
  </files>
  <action>
**Update src/components/inspections/InspectionPDF.tsx** to be a comprehensive Abnahme-Protokoll:

```typescript
import { Document, Page, Text, View, Image, StyleSheet } from '@react-pdf/renderer'

const styles = StyleSheet.create({
  page: {
    padding: 40,
    fontFamily: 'Helvetica',
    fontSize: 10,
  },
  header: {
    marginBottom: 20,
    borderBottomWidth: 2,
    borderBottomColor: '#1a365d',
    paddingBottom: 15,
  },
  title: {
    fontSize: 20,
    fontWeight: 'bold',
    color: '#1a365d',
  },
  subtitle: {
    fontSize: 11,
    color: '#4a5568',
    marginTop: 5,
  },
  section: {
    marginTop: 15,
    marginBottom: 10,
  },
  sectionTitle: {
    fontSize: 12,
    fontWeight: 'bold',
    marginBottom: 8,
    color: '#2d3748',
    borderBottomWidth: 1,
    borderBottomColor: '#e2e8f0',
    paddingBottom: 4,
  },
  row: {
    flexDirection: 'row',
    marginBottom: 4,
  },
  label: {
    width: '35%',
    color: '#718096',
  },
  value: {
    width: '65%',
    fontWeight: 'bold',
  },
  resultBox: {
    padding: 10,
    borderRadius: 4,
    marginVertical: 10,
  },
  resultPassed: {
    backgroundColor: '#c6f6d5',
  },
  resultPartial: {
    backgroundColor: '#fefcbf',
  },
  resultFailed: {
    backgroundColor: '#fed7d7',
  },
  table: {
    marginTop: 10,
  },
  tableHeader: {
    flexDirection: 'row',
    backgroundColor: '#edf2f7',
    padding: 6,
    fontWeight: 'bold',
  },
  tableRow: {
    flexDirection: 'row',
    borderBottomWidth: 1,
    borderBottomColor: '#e2e8f0',
    padding: 6,
  },
  signatureSection: {
    marginTop: 30,
    borderTopWidth: 2,
    borderTopColor: '#1a365d',
    paddingTop: 15,
  },
  signatureImage: {
    width: 180,
    height: 80,
    marginVertical: 10,
  },
  footer: {
    position: 'absolute',
    bottom: 30,
    left: 40,
    right: 40,
    fontSize: 8,
    color: '#a0aec0',
    textAlign: 'center',
  },
})

interface InspectionPDFProps {
  inspection: any
  defects: any[]
  signatureDataUrl?: string
}

export function InspectionProtocolPDF({ inspection, defects, signatureDataUrl }: InspectionPDFProps) {
  const resultLabels: Record<string, string> = {
    passed: 'BESTANDEN',
    passed_with_conditions: 'BESTANDEN MIT AUFLAGEN',
    failed: 'NICHT BESTANDEN',
  }

  const resultStyles: Record<string, any> = {
    passed: styles.resultPassed,
    passed_with_conditions: styles.resultPartial,
    failed: styles.resultFailed,
  }

  const statusIcon = (status: string) => {
    switch (status) {
      case 'pass': return '(tick)'
      case 'fail': return 'X'
      default: return '-'
    }
  }

  const formatDate = (date: string) =>
    new Date(date).toLocaleDateString('de-CH', { day: '2-digit', month: '2-digit', year: 'numeric' })

  const formatDateTime = (date: string) =>
    new Date(date).toLocaleString('de-CH', {
      day: '2-digit', month: '2-digit', year: 'numeric',
      hour: '2-digit', minute: '2-digit'
    })

  return (
    <Document>
      <Page size="A4" style={styles.page}>
        {/* Header */}
        <View style={styles.header}>
          <Text style={styles.title}>Abnahmeprotokoll</Text>
          <Text style={styles.subtitle}>KEWA AG - Renovationsmanagement</Text>
        </View>

        {/* Meta Information */}
        <View style={styles.section}>
          <Text style={styles.sectionTitle}>Allgemeine Angaben</Text>
          <View style={styles.row}>
            <Text style={styles.label}>Protokoll-Nr.:</Text>
            <Text style={styles.value}>{inspection.id.substring(0, 8).toUpperCase()}</Text>
          </View>
          <View style={styles.row}>
            <Text style={styles.label}>Titel:</Text>
            <Text style={styles.value}>{inspection.title}</Text>
          </View>
          <View style={styles.row}>
            <Text style={styles.label}>Datum der Abnahme:</Text>
            <Text style={styles.value}>{formatDate(inspection.inspection_date)}</Text>
          </View>
          {inspection.work_order?.name && (
            <View style={styles.row}>
              <Text style={styles.label}>Arbeitsauftrag:</Text>
              <Text style={styles.value}>{inspection.work_order.name}</Text>
            </View>
          )}
          {inspection.project?.name && (
            <View style={styles.row}>
              <Text style={styles.label}>Projekt:</Text>
              <Text style={styles.value}>{inspection.project.name}</Text>
            </View>
          )}
          {inspection.inspector?.display_name && (
            <View style={styles.row}>
              <Text style={styles.label}>Inspektor:</Text>
              <Text style={styles.value}>{inspection.inspector.display_name}</Text>
            </View>
          )}
        </View>

        {/* Overall Result */}
        <View style={styles.section}>
          <Text style={styles.sectionTitle}>Gesamtergebnis</Text>
          <View style={[styles.resultBox, resultStyles[inspection.overall_result] || {}]}>
            <Text style={{ fontSize: 14, fontWeight: 'bold', textAlign: 'center' }}>
              {resultLabels[inspection.overall_result] || inspection.overall_result}
            </Text>
          </View>
        </View>

        {/* Checklist Results */}
        {inspection.checklist_items?.length > 0 && (
          <View style={styles.section}>
            <Text style={styles.sectionTitle}>Checkliste</Text>
            {inspection.checklist_items.map((section: any, i: number) => (
              <View key={i} style={{ marginBottom: 8 }}>
                <Text style={{ fontWeight: 'bold', marginBottom: 4 }}>{section.name || `Abschnitt ${i + 1}`}</Text>
                {section.items?.map((item: any, j: number) => (
                  <View key={j} style={styles.tableRow}>
                    <Text style={{ width: '60%' }}>{item.title || `Punkt ${j + 1}`}</Text>
                    <Text style={{ width: '20%', textAlign: 'center' }}>{statusIcon(item.status)}</Text>
                    <Text style={{ width: '20%', color: '#718096' }}>{item.notes || ''}</Text>
                  </View>
                ))}
              </View>
            ))}
          </View>
        )}

        {/* Defects */}
        {defects.length > 0 && (
          <View style={styles.section}>
            <Text style={styles.sectionTitle}>Maengelliste ({defects.length} Maengel)</Text>
            <View style={styles.table}>
              <View style={styles.tableHeader}>
                <Text style={{ width: '40%' }}>Beschreibung</Text>
                <Text style={{ width: '20%' }}>Schweregrad</Text>
                <Text style={{ width: '20%' }}>Status</Text>
                <Text style={{ width: '20%' }}>Massnahme</Text>
              </View>
              {defects.map((defect, i) => (
                <View key={i} style={styles.tableRow}>
                  <Text style={{ width: '40%' }}>{defect.title}</Text>
                  <Text style={{ width: '20%' }}>
                    {defect.severity === 'gering' ? 'Gering' :
                     defect.severity === 'mittel' ? 'Mittel' : 'Schwer'}
                  </Text>
                  <Text style={{ width: '20%' }}>
                    {defect.status === 'open' ? 'Offen' : 'Behoben'}
                  </Text>
                  <Text style={{ width: '20%' }}>
                    {defect.action === 'task_created' ? 'Aufgabe' :
                     defect.action === 'deferred' ? 'Aufgeschoben' :
                     defect.action === 'dismissed' ? 'Abgelehnt' : '-'}
                  </Text>
                </View>
              ))}
            </View>
          </View>
        )}

        {/* Signature Section */}
        <View style={styles.signatureSection}>
          <Text style={styles.sectionTitle}>Unterschrift</Text>

          {inspection.signed_at && signatureDataUrl && (
            <View>
              <Image src={signatureDataUrl} style={styles.signatureImage} />
              <View style={styles.row}>
                <Text style={styles.label}>Name:</Text>
                <Text style={styles.value}>{inspection.signer_name}</Text>
              </View>
              <View style={styles.row}>
                <Text style={styles.label}>Rolle:</Text>
                <Text style={styles.value}>{inspection.signer_role}</Text>
              </View>
              <View style={styles.row}>
                <Text style={styles.label}>Zeitpunkt:</Text>
                <Text style={styles.value}>{formatDateTime(inspection.signed_at)}</Text>
              </View>
            </View>
          )}

          {inspection.signature_refused && (
            <View style={{ backgroundColor: '#fefcbf', padding: 10, borderRadius: 4 }}>
              <Text style={{ fontWeight: 'bold', color: '#744210' }}>Unterschrift verweigert</Text>
              <Text style={{ color: '#744210', marginTop: 4 }}>
                Grund: {inspection.signature_refused_reason}
              </Text>
            </View>
          )}

          {!inspection.signed_at && !inspection.signature_refused && (
            <Text style={{ color: '#718096' }}>Noch nicht unterschrieben</Text>
          )}
        </View>

        {/* Footer */}
        <View style={styles.footer}>
          <Text>
            Erstellt am {formatDateTime(new Date().toISOString())} | KEWA AG Renovationsmanagement
          </Text>
          <Text>Dieses Dokument wurde automatisch generiert.</Text>
        </View>
      </Page>
    </Document>
  )
}

// Re-export for backward compatibility
export { InspectionProtocolPDF as InspectionPDF }
```

**Update src/app/api/inspections/[id]/pdf/route.ts** to use base64 signature:

Ensure signature is fetched as blob and converted to base64 data URL (not signed URL) to prevent expiry issues. Pattern from research:

```typescript
// Get signature as data URL for embedding (prevents URL expiry in PDF)
let signatureDataUrl: string | undefined
if (inspection.signature_storage_path) {
  const { data: signatureBlob } = await supabase.storage
    .from('inspections')
    .download(inspection.signature_storage_path)

  if (signatureBlob) {
    const arrayBuffer = await signatureBlob.arrayBuffer()
    const base64 = Buffer.from(arrayBuffer).toString('base64')
    signatureDataUrl = `data:image/png;base64,${base64}`
  }
}
```

**Add to migration 060_inspection_advanced.sql** - acknowledgment fields:

```sql
-- Add acknowledgment fields to inspections table
ALTER TABLE inspections
ADD COLUMN IF NOT EXISTS acknowledged_at TIMESTAMPTZ,
ADD COLUMN IF NOT EXISTS acknowledged_by_email VARCHAR(255);

COMMENT ON COLUMN inspections.acknowledged_at IS 'Timestamp when contractor acknowledged receipt via portal';
COMMENT ON COLUMN inspections.acknowledged_by_email IS 'Email of contractor who acknowledged via portal';
```
  </action>
  <verify>
Run `npm run build` to verify PDF component compiles. Download PDF and verify signature embedded correctly.
  </verify>
  <done>
PDF includes all inspection data, checklist results, defects table, and embedded signature. Acknowledgment fields added for portal tracking.
  </done>
</task>

</tasks>

<verification>
1. TypeScript: `npx tsc --noEmit` passes
2. Build: `npm run build` completes without errors
3. Portal page accessible at /portal/inspections/{token} without login
4. Invalid/expired tokens show error message
5. Acknowledge button consumes token (subsequent visits show "already used")
6. PDF downloads with embedded signature (not URL that expires)
7. SendPortalDialog generates valid portal URL
</verification>

<success_criteria>
- Contractor opens magic link and sees inspection details
- Contractor clicks acknowledge button and sees success message
- Token consumed after acknowledgment (link no longer works)
- User can generate portal link from inspection detail page
- PDF Abnahme-Protokoll downloads with all data and embedded signature
</success_criteria>

<output>
After completion, create `.planning/phases/23-inspection-advanced/23-02-SUMMARY.md`
</output>
