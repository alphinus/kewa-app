---
phase: 30-security-audit-cve-patching
plan: 03
subsystem: security
tags: [rate-limiting, upstash, redis, brute-force-protection, auth]

# Dependency graph
requires:
  - phase: 30-01
    provides: Next.js 16.1.6 with CVE patches
provides:
  - Upstash rate limiting infrastructure
  - checkRateLimit utility function
  - Rate limiting on all 13 auth endpoints (10 req/60s per IP)
affects: [any-new-auth-endpoints, api-security]

# Tech tracking
tech-stack:
  added: ["@upstash/ratelimit@2.0.8", "@upstash/redis@1.36.2"]
  patterns: [rate-limit-guard-at-handler-start, sliding-window-rate-limiting]

key-files:
  created: [src/lib/rate-limit.ts]
  modified: [
    package.json,
    package-lock.json,
    .env.example,
    src/app/api/auth/login/route.ts,
    src/app/api/auth/logout/route.ts,
    src/app/api/auth/register/route.ts,
    src/app/api/auth/session/route.ts,
    src/app/api/auth/magic-link/send/route.ts,
    src/app/api/auth/magic-link/verify/route.ts,
    src/app/api/portal/auth/login/route.ts,
    src/app/api/portal/auth/logout/route.ts,
    src/app/api/portal/auth/session/route.ts,
    src/app/api/portal/auth/register/[token]/route.ts,
    src/app/api/portal/auth/verify-invite/[token]/route.ts,
    src/app/api/portal/auth/qr-token/route.ts,
    src/app/api/portal/auth/qr-login/route.ts
  ]

key-decisions:
  - "Upstash Redis for serverless-compatible distributed rate limiting"
  - "Sliding window algorithm (10 requests per 60 seconds per IP)"
  - "Rate limit applied to all auth endpoints including session checks"

patterns-established:
  - "Rate limit check as first action in auth handlers: const rateLimitResponse = await checkRateLimit(request); if (rateLimitResponse) return rateLimitResponse;"
  - "X-RateLimit-* response headers for client rate limit awareness"

# Metrics
duration: 8min
completed: 2026-02-05
---

# Phase 30 Plan 03: Auth Rate Limiting Summary

**Upstash-based rate limiting on all 13 auth endpoints with sliding window (10 req/60s per IP)**

## Performance

- **Duration:** 8 min
- **Started:** 2026-02-05T06:36:54Z
- **Completed:** 2026-02-05T06:45:00Z
- **Tasks:** 2
- **Files modified:** 17

## Accomplishments
- Installed @upstash/ratelimit and @upstash/redis packages
- Created reusable checkRateLimit utility with Upstash Redis backend
- Applied rate limiting to all 13 auth endpoints (login, logout, register, session, magic-link, QR auth)
- Returns 429 with X-RateLimit-* headers when limit exceeded

## Task Commits

Each task was committed atomically:

1. **Task 1: Install Upstash packages and create rate limiter utility** - `0c8ee8d` (feat)
2. **Task 2: Apply rate limiting to all auth endpoints** - `ac36b38` (feat)

## Files Created/Modified
- `src/lib/rate-limit.ts` - Rate limiter utility with authRateLimiter config and checkRateLimit function
- `package.json` - Added @upstash/ratelimit and @upstash/redis dependencies
- `.env.example` - Added UPSTASH_REDIS_REST_URL and UPSTASH_REDIS_REST_TOKEN
- `src/app/api/auth/*/route.ts` - 6 main auth endpoints with rate limiting
- `src/app/api/portal/auth/*/route.ts` - 7 portal auth endpoints with rate limiting

## Decisions Made
- Used Upstash Redis for serverless-compatible distributed rate limiting (works across cold starts)
- Sliding window algorithm (10 requests per 60 seconds) for smoother rate limiting
- Applied rate limiting to session endpoints to prevent session enumeration attacks
- German error message "Zu viele Anfragen. Bitte warten Sie." for rate limit responses

## Deviations from Plan

None - plan executed exactly as written.

## User Setup Required

**External services require manual configuration.** Users must:

1. Create a free Upstash Redis database at console.upstash.com
2. Add to .env.local:
   - `UPSTASH_REDIS_REST_URL=https://your-redis.upstash.io`
   - `UPSTASH_REDIS_REST_TOKEN=your-token-here`

**Note:** Without Upstash credentials, rate limiting will fail on first request. This is intentional - auth endpoints should not work without rate limiting configured.

## Issues Encountered

None.

## Next Phase Readiness
- SEC-06 requirement satisfied (rate limiting on auth endpoints)
- Ready for Phase 30 completion or next plan execution
- Requires Upstash setup before production deployment

---
*Phase: 30-security-audit-cve-patching*
*Completed: 2026-02-05*
