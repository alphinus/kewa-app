---
phase: 30-security-audit-cve-patching
plan: 05
type: execute
wave: 2
depends_on: []
files_modified: []
autonomous: true

must_haves:
  truths:
    - "Service worker caching strategy reviewed and documented"
    - "Environment variables audited - no secrets in NEXT_PUBLIC_*"
    - "Server Actions authorization documented (N/A - none exist)"
  artifacts: []
  key_links: []
---

<objective>
Complete security review: audit service worker scope/caching, verify environment variables are properly segregated, and document Server Actions status.

Purpose: Satisfy SEC-05, SEC-08, SEC-09 requirements through verification and documentation.
Output: Security audit documentation confirming no issues found.
</objective>

<execution_context>
@C:\Users\Mario Giacchino\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\Mario Giacchino\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/30-security-audit-cve-patching/30-RESEARCH.md
@public/sw.js
@public/sw-cache.js
@.env.example
</context>

<tasks>

<task type="auto">
  <name>Task 1: Audit service worker security</name>
  <files>None (audit only)</files>
  <action>
Review public/sw.js and public/sw-cache.js for security concerns:

1. **Scope verification**: Confirm service worker scope is limited to application ('/')
   - Check for Service-Worker-Allowed header in next.config.ts (already configured)

2. **Caching strategy review**:
   - Verify sensitive routes (auth endpoints) are NOT cached
   - Confirm API requests use network-first or network-only
   - Check that no credentials/tokens are stored in cache

3. **Push notification security**:
   - Verify notification data doesn't leak sensitive information
   - Confirm subscription changes are properly authenticated

4. **Document findings** in the summary:
   - List any security concerns found
   - Or confirm "No security issues found" with specific checks performed
  </action>
  <verify>
Read both service worker files and document:
- What caching strategies are used
- Whether auth endpoints are excluded from caching
- Whether push handlers validate data properly
  </verify>
  <done>Service worker security audited and documented</done>
</task>

<task type="auto">
  <name>Task 2: Audit environment variables</name>
  <files>None (audit only)</files>
  <action>
Verify no secrets are exposed in NEXT_PUBLIC_* variables:

1. **Check .env.example** for all NEXT_PUBLIC_* variables:
   ```bash
   grep "NEXT_PUBLIC_" .env.example
   ```

2. **Validate each is appropriate for client exposure**:
   - NEXT_PUBLIC_SUPABASE_URL - OK (public API endpoint)
   - NEXT_PUBLIC_SUPABASE_ANON_KEY - OK (public anon key, designed for client)
   - NEXT_PUBLIC_APP_URL - OK (public application URL)
   - NEXT_PUBLIC_VAPID_PUBLIC_KEY - OK (public key for push subscriptions)

3. **Verify secrets are NOT prefixed with NEXT_PUBLIC_**:
   - SESSION_SECRET - OK (server only)
   - SUPABASE_SERVICE_ROLE_KEY - OK (server only)
   - VAPID_PRIVATE_KEY - OK (server only)
   - CRON_SECRET - OK (server only)

4. **Check codebase for accidental exposure**:
   ```bash
   grep -r "SUPABASE_SERVICE_ROLE_KEY\|SESSION_SECRET\|VAPID_PRIVATE_KEY" src/
   # Should only appear in server-side code
   ```
  </action>
  <verify>
- All NEXT_PUBLIC_* variables are safe for client exposure
- No secrets are prefixed with NEXT_PUBLIC_
- Secret access is limited to server-side code
  </verify>
  <done>Environment variables audited - no secrets exposed to client</done>
</task>

<task type="auto">
  <name>Task 3: Verify Server Actions status (SEC-05)</name>
  <files>None (audit only)</files>
  <action>
Confirm Server Actions are not used in the codebase:

1. **Search for 'use server' directive**:
   ```bash
   grep -r "'use server'" src/
   grep -r '"use server"' src/
   ```

2. **Expected result**: No matches (codebase uses API routes, not Server Actions)

3. **Document in summary**:
   - "SEC-05 N/A: No Server Actions exist in codebase"
   - "All mutations use API routes with explicit auth checks"

If Server Actions ARE found (unexpected):
- Verify each has authorization check at start
- Document any gaps for remediation
  </action>
  <verify>
grep commands return no results for 'use server' directive
  </verify>
  <done>Server Actions status documented - none exist, SEC-05 N/A</done>
</task>

</tasks>

<verification>
```bash
# Verify no Server Actions
grep -r "use server" src/ | grep -v node_modules

# Verify NEXT_PUBLIC vars
grep "NEXT_PUBLIC_" .env.example

# Verify secrets not exposed
grep -r "SERVICE_ROLE_KEY" src/ | grep -v ".d.ts"
# Should only show server-side files
```
</verification>

<success_criteria>
- Service worker caching strategy documented
- No secrets in NEXT_PUBLIC_* variables
- Server Actions status confirmed (none exist)
- Requirements SEC-05, SEC-08, SEC-09 satisfied
</success_criteria>

<output>
After completion, create `.planning/phases/30-security-audit-cve-patching/30-05-SUMMARY.md`
</output>
