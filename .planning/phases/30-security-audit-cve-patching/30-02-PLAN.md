---
phase: 30-security-audit-cve-patching
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - next.config.ts
  - src/lib/session.ts
autonomous: true

must_haves:
  truths:
    - "CSP and security headers return on all routes"
    - "JWT cookies use SameSite=Strict"
    - "X-Frame-Options DENY prevents clickjacking"
  artifacts:
    - path: "next.config.ts"
      provides: "Security headers configuration"
      contains: "Content-Security-Policy"
    - path: "src/lib/session.ts"
      provides: "Cookie options with sameSite strict"
      contains: "sameSite: 'strict'"
  key_links:
    - from: "next.config.ts"
      to: "all routes"
      via: "headers() function"
      pattern: "source: '/(.*)',"
---

<objective>
Configure Content-Security-Policy and other security headers in next.config.ts. Harden session cookies by changing sameSite from 'lax' to 'strict'.

Purpose: Prevent XSS, clickjacking, and CSRF attacks through proper security headers and cookie configuration.
Output: Security headers on all routes, cookies with sameSite strict.
</objective>

<execution_context>
@C:\Users\Mario Giacchino\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\Mario Giacchino\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/30-security-audit-cve-patching/30-RESEARCH.md
@next.config.ts
@src/lib/session.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add CSP and security headers to next.config.ts</name>
  <files>next.config.ts</files>
  <action>
Update next.config.ts to add security headers to all routes while preserving existing sw.js headers.

Add the following security headers to a new '/(.*)'  source:
1. **Content-Security-Policy** - Restrict resource loading:
   ```
   default-src 'self';
   script-src 'self' 'unsafe-inline' 'unsafe-eval';
   style-src 'self' 'unsafe-inline';
   img-src 'self' blob: data: https://*.supabase.co;
   font-src 'self';
   connect-src 'self' https://*.supabase.co wss://*.supabase.co;
   object-src 'none';
   base-uri 'self';
   form-action 'self';
   frame-ancestors 'none';
   upgrade-insecure-requests;
   ```
   Note: 'unsafe-inline' and 'unsafe-eval' needed for Next.js dev mode and some React patterns.

2. **X-Frame-Options: DENY** - Prevent clickjacking
3. **X-Content-Type-Options: nosniff** - Prevent MIME sniffing
4. **Referrer-Policy: strict-origin-when-cross-origin** - Control referrer info
5. **Permissions-Policy: camera=(), microphone=(), geolocation=()** - Disable unused APIs

Place the security headers BEFORE the sw.js headers so they apply globally first.
  </action>
  <verify>
Run dev server and use curl to check headers:
```bash
curl -I http://localhost:3000 2>/dev/null | grep -E "(Content-Security-Policy|X-Frame-Options|X-Content-Type-Options|Referrer-Policy|Permissions-Policy)"
```
All 5 headers should be present.
  </verify>
  <done>CSP and security headers configured, returning on all routes</done>
</task>

<task type="auto">
  <name>Task 2: Harden session cookie with SameSite strict</name>
  <files>src/lib/session.ts</files>
  <action>
In src/lib/session.ts, change the SESSION_COOKIE_OPTIONS:
- Change `sameSite: 'lax' as const` to `sameSite: 'strict' as const`

This prevents CSRF attacks via top-level navigations. The application uses POST for all mutations, so 'strict' is safe.

No other changes needed - httpOnly and secure are already correctly configured.
  </action>
  <verify>
Read src/lib/session.ts and confirm:
- `sameSite: 'strict'` is present in SESSION_COOKIE_OPTIONS
- `httpOnly: true` is still present
- `secure: process.env.NODE_ENV === 'production'` is still present
  </verify>
  <done>Session cookies use SameSite=Strict, SEC-04 satisfied</done>
</task>

</tasks>

<verification>
```bash
# Start dev server (in separate terminal)
npm run dev

# Check security headers on main route
curl -I http://localhost:3000 2>/dev/null | grep -E "(Content-Security-Policy|X-Frame-Options)"

# Verify session.ts has strict sameSite
grep -n "sameSite" src/lib/session.ts
# Expected: sameSite: 'strict'
```
</verification>

<success_criteria>
- Content-Security-Policy header present on all routes
- X-Frame-Options: DENY header present
- X-Content-Type-Options: nosniff header present
- Referrer-Policy header present
- Permissions-Policy header present
- SESSION_COOKIE_OPTIONS uses sameSite: 'strict'
- Requirements SEC-03 and SEC-04 satisfied
</success_criteria>

<output>
After completion, create `.planning/phases/30-security-audit-cve-patching/30-02-SUMMARY.md`
</output>
