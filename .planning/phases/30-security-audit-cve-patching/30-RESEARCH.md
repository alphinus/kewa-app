# Phase 30: Security Audit & CVE Patching - Research

**Researched:** 2026-02-04
**Domain:** Web Application Security (Next.js, Auth, Headers)
**Confidence:** HIGH

## Summary

Phase 30 addresses critical security vulnerabilities and hardening for a Next.js 16.1.2 application deployed on Vercel with Supabase authentication. The codebase currently has 1 high severity vulnerability in npm audit stemming from Next.js 16.1.2. The latest patched version is 16.1.6.

The security requirements span: CVE patching (Next.js upgrade), CSP headers, cookie security, rate limiting, Server Action protection, error boundaries, service worker security review, and environment variable auditing. The application uses custom JWT-based sessions (not Supabase Auth sessions) with proper HttpOnly cookies but uses `sameSite: 'lax'` instead of the recommended `'strict'`.

**Primary recommendation:** Upgrade Next.js to 16.1.6, add CSP headers via next.config.ts (static approach without nonces), implement rate limiting with @upstash/ratelimit, and add global-error.tsx for error boundary coverage.

## Standard Stack

The established libraries/tools for this domain:

### Core
| Library | Version | Purpose | Why Standard |
|---------|---------|---------|--------------|
| next | 16.1.6 | Framework (patched) | Fixes CVE-2025-29927, CVE-2025-55183, CVE-2025-55184 |
| @upstash/ratelimit | ^2.0.5 | Rate limiting | HTTP-based, serverless-native, no TCP connections |
| @upstash/redis | ^1.34.0 | Redis client for rate limiting | Required by @upstash/ratelimit |

### Supporting
| Library | Version | Purpose | When to Use |
|---------|---------|---------|-------------|
| server-only | ^0.0.1 | Prevent server code in client | Sensitive data access modules |

### Alternatives Considered
| Instead of | Could Use | Tradeoff |
|------------|-----------|----------|
| @upstash/ratelimit | In-memory Map | Only works single-instance, resets on deploy |
| Upstash Redis | Vercel KV | Vercel KV is Upstash under the hood, same API |

**Installation:**
```bash
npm install next@16.1.6
npm install @upstash/ratelimit @upstash/redis
npm install --save-dev server-only
```

## Architecture Patterns

### Recommended Security Structure
```
src/
├── middleware.ts              # CSP headers, rate limiting check
├── app/
│   ├── global-error.tsx       # Root error boundary (NEW)
│   ├── error.tsx              # App-level error boundary (NEW)
│   └── api/auth/*/route.ts    # Rate limiting applied here
├── lib/
│   ├── rate-limit.ts          # Upstash rate limiter config (NEW)
│   └── session.ts             # Cookie options (sameSite: 'strict')
└── next.config.ts             # CSP headers, security config
```

### Pattern 1: Static CSP Headers via next.config.ts
**What:** Configure Content-Security-Policy header statically without nonces
**When to use:** Apps without inline scripts requiring dynamic nonces
**Example:**
```typescript
// Source: https://nextjs.org/docs/app/guides/content-security-policy
// next.config.ts
import type { NextConfig } from "next";

const cspHeader = `
  default-src 'self';
  script-src 'self' 'unsafe-inline' 'unsafe-eval';
  style-src 'self' 'unsafe-inline';
  img-src 'self' blob: data: https://*.supabase.co;
  font-src 'self';
  connect-src 'self' https://*.supabase.co wss://*.supabase.co;
  object-src 'none';
  base-uri 'self';
  form-action 'self';
  frame-ancestors 'none';
  upgrade-insecure-requests;
`.replace(/\n/g, '');

const nextConfig: NextConfig = {
  // ... existing config
  async headers() {
    return [
      {
        source: '/(.*)',
        headers: [
          {
            key: 'Content-Security-Policy',
            value: cspHeader,
          },
          {
            key: 'X-Frame-Options',
            value: 'DENY',
          },
          {
            key: 'X-Content-Type-Options',
            value: 'nosniff',
          },
          {
            key: 'Referrer-Policy',
            value: 'strict-origin-when-cross-origin',
          },
          {
            key: 'Permissions-Policy',
            value: 'camera=(), microphone=(), geolocation=()',
          },
        ],
      },
      // Existing sw.js headers preserved
    ];
  },
};
```

### Pattern 2: Rate Limiting with Upstash
**What:** Per-IP rate limiting on auth endpoints
**When to use:** All authentication endpoints (/api/auth/*, /api/portal/auth/*)
**Example:**
```typescript
// Source: https://upstash.com/blog/nextjs-ratelimiting
// lib/rate-limit.ts
import { Ratelimit } from "@upstash/ratelimit";
import { Redis } from "@upstash/redis";

// Create rate limiter - 10 requests per 60 seconds
export const authRateLimiter = new Ratelimit({
  redis: Redis.fromEnv(),
  limiter: Ratelimit.slidingWindow(10, "60 s"),
  analytics: true,
  prefix: "kewa:ratelimit:auth",
});

// Usage in API route
export async function POST(request: NextRequest) {
  const ip = request.headers.get('x-forwarded-for')?.split(',')[0] || 'unknown';
  const { success, limit, remaining, reset } = await authRateLimiter.limit(ip);

  if (!success) {
    return NextResponse.json(
      { error: 'Zu viele Anfragen. Bitte warten Sie.' },
      {
        status: 429,
        headers: {
          'X-RateLimit-Limit': limit.toString(),
          'X-RateLimit-Remaining': remaining.toString(),
          'X-RateLimit-Reset': reset.toString(),
        }
      }
    );
  }
  // ... rest of handler
}
```

### Pattern 3: Global Error Boundary
**What:** Catch-all error UI for root layout errors
**When to use:** Required for every Next.js App Router application
**Example:**
```typescript
// Source: https://nextjs.org/docs/app/getting-started/error-handling
// app/global-error.tsx
'use client'

export default function GlobalError({
  error,
  reset,
}: {
  error: Error & { digest?: string }
  reset: () => void
}) {
  return (
    <html lang="de">
      <body>
        <div className="flex min-h-screen items-center justify-center">
          <div className="text-center">
            <h1 className="text-2xl font-bold">Ein Fehler ist aufgetreten</h1>
            <p className="mt-2 text-gray-600">
              {error.message || 'Unbekannter Fehler'}
            </p>
            <button
              onClick={reset}
              className="mt-4 rounded bg-blue-600 px-4 py-2 text-white"
            >
              Erneut versuchen
            </button>
          </div>
        </div>
      </body>
    </html>
  )
}
```

### Anti-Patterns to Avoid
- **Trusting client-provided data in Server Components:** Always re-verify authorization server-side
- **Using `sameSite: 'lax'` for session cookies:** Use `'strict'` unless cross-site POST is required
- **Exposing secrets in NEXT_PUBLIC_* variables:** Only public, non-sensitive data
- **Missing error boundaries:** Users see white screen on crash

## Don't Hand-Roll

Problems that look simple but have existing solutions:

| Problem | Don't Build | Use Instead | Why |
|---------|-------------|-------------|-----|
| Rate limiting | In-memory counters | @upstash/ratelimit | Survives serverless cold starts, works distributed |
| CSP headers | Manual string building | Next.js headers() | Framework handles escaping, merging |
| JWT validation | Custom crypto | jose library | Already in use, battle-tested |
| Error boundaries | try/catch in components | error.tsx / global-error.tsx | Next.js convention, automatic |

**Key insight:** Security primitives require correct implementation under all edge cases. Libraries handle timing attacks, race conditions, and encoding issues that manual implementations miss.

## Common Pitfalls

### Pitfall 1: Incomplete CSP Breaking Functionality
**What goes wrong:** CSP blocks Supabase connections, inline styles, or eval in dev
**Why it happens:** connect-src, style-src, script-src too restrictive
**How to avoid:** Test CSP in dev mode first with 'unsafe-inline' 'unsafe-eval', tighten for production
**Warning signs:** Console errors "Refused to load", "Refused to execute"

### Pitfall 2: Rate Limiting Without Redis in Vercel
**What goes wrong:** In-memory rate limiter resets on every cold start (every ~15 min on Vercel)
**Why it happens:** Serverless functions are ephemeral
**How to avoid:** Use Upstash Redis (or Vercel KV) for persistent counters
**Warning signs:** Brute force attacks succeed despite rate limiting code

### Pitfall 3: CVE-2025-29927 Middleware Bypass
**What goes wrong:** Attackers bypass middleware auth by adding `x-middleware-subrequest` header
**Why it happens:** Next.js < 15.2.3 / 16.1.x vulnerability
**How to avoid:** Upgrade to Next.js 16.1.6+
**Warning signs:** Protected routes accessible without authentication

### Pitfall 4: SameSite Lax Allows CSRF via GET
**What goes wrong:** CSRF attacks via GET requests that trigger state changes
**Why it happens:** `sameSite: 'lax'` allows cookies on top-level GET navigations
**How to avoid:** Use `sameSite: 'strict'` and ensure all mutations use POST
**Warning signs:** State-changing GET endpoints

### Pitfall 5: global-error.tsx Only Works in Production
**What goes wrong:** Error boundary not triggered during development
**Why it happens:** Next.js dev mode shows overlay instead of global-error
**How to avoid:** Test with `next build && next start` before deploying
**Warning signs:** Works in prod but not dev (expected behavior)

## Code Examples

Verified patterns from official sources:

### Cookie Security Configuration
```typescript
// Source: Current codebase + hardening
// lib/session.ts
export const SESSION_COOKIE_OPTIONS = {
  httpOnly: true,
  secure: process.env.NODE_ENV === 'production',
  sameSite: 'strict' as const,  // Changed from 'lax'
  maxAge: SESSION_EXPIRATION_SECONDS,
  path: '/'
}
```

### Security Headers Bundle
```typescript
// Source: https://nextjs.org/docs/app/guides/content-security-policy
// All recommended security headers
const securityHeaders = [
  {
    key: 'Content-Security-Policy',
    value: cspHeader,
  },
  {
    key: 'X-Frame-Options',
    value: 'DENY',
  },
  {
    key: 'X-Content-Type-Options',
    value: 'nosniff',
  },
  {
    key: 'Referrer-Policy',
    value: 'strict-origin-when-cross-origin',
  },
  {
    key: 'Permissions-Policy',
    value: 'camera=(), microphone=(), geolocation=()',
  },
];
```

### Environment Variable Audit Pattern
```typescript
// Audit checklist for NEXT_PUBLIC_* variables
// .env.example shows current public vars:
// - NEXT_PUBLIC_SUPABASE_URL - OK (public API endpoint)
// - NEXT_PUBLIC_SUPABASE_ANON_KEY - OK (public anon key)
// - NEXT_PUBLIC_APP_URL - OK (public URL)
// - NEXT_PUBLIC_VAPID_PUBLIC_KEY - OK (public VAPID key)

// Secrets that must NOT be NEXT_PUBLIC_:
// - SESSION_SECRET
// - SUPABASE_SERVICE_ROLE_KEY
// - RESEND_API_KEY
// - VAPID_PRIVATE_KEY
```

### Rate Limiter Wrapper Function
```typescript
// Source: https://github.com/upstash/ratelimit-js
// lib/rate-limit.ts
import { Ratelimit } from "@upstash/ratelimit";
import { Redis } from "@upstash/redis";
import { NextResponse } from "next/server";

const redis = Redis.fromEnv();

export const authRateLimiter = new Ratelimit({
  redis,
  limiter: Ratelimit.slidingWindow(10, "60 s"),
  prefix: "kewa:auth",
});

export async function checkRateLimit(identifier: string) {
  const { success, limit, remaining, reset } = await authRateLimiter.limit(identifier);

  if (!success) {
    return NextResponse.json(
      { error: 'Zu viele Anfragen. Bitte warten Sie.' },
      {
        status: 429,
        headers: {
          'X-RateLimit-Limit': String(limit),
          'X-RateLimit-Remaining': String(remaining),
          'X-RateLimit-Reset': String(reset),
        }
      }
    );
  }

  return null; // No rate limit hit
}
```

## State of the Art

| Old Approach | Current Approach | When Changed | Impact |
|--------------|------------------|--------------|--------|
| Middleware for all auth | Middleware + route-level auth | CVE-2025-29927 (Mar 2025) | Defense in depth required |
| sameSite: 'lax' default | sameSite: 'strict' for sessions | 2024 | Better CSRF protection |
| CSP via meta tags | CSP via HTTP headers | Always | Headers more secure |
| In-memory rate limiting | Redis-based distributed | Serverless adoption | Required for serverless |

**Deprecated/outdated:**
- Relying solely on middleware for authorization (CVE-2025-29927 showed bypass)
- Trusting Next.js versions < 15.2.3 / 16.1.6 for self-hosted deployments

## Open Questions

Things that couldn't be fully resolved:

1. **Vercel deployment vs self-hosted security**
   - What we know: CVE-2025-29927 doesn't affect Vercel-hosted apps (routing decoupled)
   - What's unclear: Whether other CVEs apply to Vercel deployments
   - Recommendation: Upgrade anyway for defense in depth

2. **Server Actions authorization (SEC-05)**
   - What we know: No Server Actions ('use server') exist in the codebase currently
   - What's unclear: Whether to add protective patterns now or wait
   - Recommendation: Document pattern, apply when Server Actions are added

3. **Upstash Redis requirement**
   - What we know: Rate limiting requires Upstash account and Redis database
   - What's unclear: Cost implications, whether existing Supabase can substitute
   - Recommendation: Upstash has generous free tier (10K requests/day), use it

## Sources

### Primary (HIGH confidence)
- [Next.js CSP Guide](https://nextjs.org/docs/app/guides/content-security-policy) - CSP configuration patterns
- [Next.js Security Update Dec 2025](https://nextjs.org/blog/security-update-2025-12-11) - CVE-2025-55183, CVE-2025-55184 details
- [Next.js Data Security Guide](https://nextjs.org/docs/app/guides/data-security) - Server Actions protection
- [Next.js Error Handling](https://nextjs.org/docs/app/getting-started/error-handling) - Error boundary patterns
- [Upstash Ratelimit GitHub](https://github.com/upstash/ratelimit-js) - Rate limiting API

### Secondary (MEDIUM confidence)
- [CVE-2025-29927 Postmortem](https://nextjs.org/blog/cve-2025-29927) - Middleware bypass details
- [Upstash Next.js Rate Limiting](https://upstash.com/blog/nextjs-ratelimiting) - Implementation patterns
- [NVD CVE-2025-29927](https://nvd.nist.gov/vuln/detail/CVE-2025-29927) - CVSS scoring

### Tertiary (LOW confidence)
- npm audit output - Current vulnerability status (verified against npm show)

## Metadata

**Confidence breakdown:**
- Standard stack: HIGH - Official docs, GitHub releases confirm versions
- Architecture: HIGH - Patterns from official Next.js documentation
- Pitfalls: HIGH - Well-documented CVEs with official advisories

**Research date:** 2026-02-04
**Valid until:** 2026-03-04 (30 days - security domain moves fast)

---

## Current State Summary

**Next.js version:** 16.1.2 (needs upgrade to 16.1.6)
**npm audit:** 1 high severity (Next.js related)
**Cookie security:** httpOnly=true, sameSite='lax' (should be 'strict')
**CSP headers:** Not configured
**Rate limiting:** Not implemented
**Error boundaries:** Missing global-error.tsx
**Server Actions:** Not used (no 'use server' directives)
**NEXT_PUBLIC_* audit:** 4 variables, all appropriate for public exposure
