---
phase: 30-security-audit-cve-patching
plan: 03
type: execute
wave: 2
depends_on: ["30-01"]
files_modified:
  - package.json
  - package-lock.json
  - src/lib/rate-limit.ts
  - src/app/api/auth/login/route.ts
  - src/app/api/auth/logout/route.ts
  - src/app/api/auth/register/route.ts
  - src/app/api/auth/session/route.ts
  - src/app/api/auth/magic-link/send/route.ts
  - src/app/api/auth/magic-link/verify/route.ts
  - src/app/api/portal/auth/login/route.ts
  - src/app/api/portal/auth/logout/route.ts
  - src/app/api/portal/auth/session/route.ts
  - src/app/api/portal/auth/register/[token]/route.ts
  - src/app/api/portal/auth/verify-invite/[token]/route.ts
  - src/app/api/portal/auth/qr-token/route.ts
  - src/app/api/portal/auth/qr-login/route.ts
autonomous: true

user_setup:
  - service: upstash
    why: "Rate limiting requires Upstash Redis for serverless-compatible distributed counters"
    env_vars:
      - name: UPSTASH_REDIS_REST_URL
        source: "Upstash Console -> Create Database -> REST API URL"
      - name: UPSTASH_REDIS_REST_TOKEN
        source: "Upstash Console -> Create Database -> REST API Token"
    dashboard_config:
      - task: "Create a free Redis database"
        location: "console.upstash.com -> Create Database -> Global (for lowest latency)"

must_haves:
  truths:
    - "Auth endpoints return 429 after 10+ rapid requests"
    - "Rate limit headers (X-RateLimit-*) included in responses"
    - "Rate limiting works across serverless cold starts"
  artifacts:
    - path: "src/lib/rate-limit.ts"
      provides: "Upstash rate limiter configuration"
      exports: ["authRateLimiter", "checkRateLimit"]
    - path: "src/app/api/auth/login/route.ts"
      provides: "Rate-limited login endpoint"
      contains: "checkRateLimit"
  key_links:
    - from: "src/app/api/auth/*/route.ts"
      to: "src/lib/rate-limit.ts"
      via: "import checkRateLimit"
      pattern: "import.*checkRateLimit.*rate-limit"
    - from: "src/lib/rate-limit.ts"
      to: "Upstash Redis"
      via: "Redis.fromEnv()"
      pattern: "Redis\\.fromEnv\\(\\)"
---

<objective>
Implement rate limiting on all authentication endpoints using @upstash/ratelimit. Create reusable rate limiter utility and apply to 13 auth endpoints.

Purpose: Prevent brute force attacks on login, registration, and magic link endpoints.
Output: All auth endpoints rate-limited at 10 requests per 60 seconds per IP.
</objective>

<execution_context>
@C:\Users\Mario Giacchino\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\Mario Giacchino\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/30-security-audit-cve-patching/30-RESEARCH.md
@src/app/api/auth/login/route.ts
@src/app/api/portal/auth/login/route.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install Upstash packages and create rate limiter utility</name>
  <files>package.json, package-lock.json, src/lib/rate-limit.ts</files>
  <action>
1. Install Upstash packages:
   ```bash
   npm install @upstash/ratelimit @upstash/redis
   ```

2. Create src/lib/rate-limit.ts with:
   ```typescript
   /**
    * Rate Limiting Utility
    * Uses Upstash Redis for serverless-compatible distributed rate limiting
    * Phase: 30-security-audit-cve-patching
    */
   import { Ratelimit } from "@upstash/ratelimit";
   import { Redis } from "@upstash/redis";
   import { NextResponse } from "next/server";
   import type { NextRequest } from "next/server";

   // Initialize Redis client from environment variables
   // Requires: UPSTASH_REDIS_REST_URL, UPSTASH_REDIS_REST_TOKEN
   const redis = Redis.fromEnv();

   // Auth rate limiter: 10 requests per 60 seconds sliding window
   export const authRateLimiter = new Ratelimit({
     redis,
     limiter: Ratelimit.slidingWindow(10, "60 s"),
     analytics: true,
     prefix: "kewa:ratelimit:auth",
   });

   /**
    * Check rate limit for an identifier (typically IP address)
    * Returns a 429 response if rate limited, null if allowed
    */
   export async function checkRateLimit(
     request: NextRequest
   ): Promise<NextResponse | null> {
     // Extract IP from x-forwarded-for or fallback to unknown
     const forwarded = request.headers.get("x-forwarded-for");
     const ip = forwarded?.split(",")[0]?.trim() || "unknown";

     const { success, limit, remaining, reset } = await authRateLimiter.limit(ip);

     if (!success) {
       return NextResponse.json(
         { error: "Zu viele Anfragen. Bitte warten Sie." },
         {
           status: 429,
           headers: {
             "X-RateLimit-Limit": String(limit),
             "X-RateLimit-Remaining": String(remaining),
             "X-RateLimit-Reset": String(reset),
           },
         }
       );
     }

     return null; // Not rate limited, proceed with request
   }
   ```

3. Add environment variables to .env.example (append to end):
   ```
   # Rate Limiting - Upstash Redis
   # Get these from: console.upstash.com -> Create Database
   UPSTASH_REDIS_REST_URL=https://your-redis.upstash.io
   UPSTASH_REDIS_REST_TOKEN=your-token-here
   ```
  </action>
  <verify>
- src/lib/rate-limit.ts exists and exports authRateLimiter and checkRateLimit
- package.json includes @upstash/ratelimit and @upstash/redis
- .env.example includes UPSTASH_REDIS_REST_URL and UPSTASH_REDIS_REST_TOKEN
  </verify>
  <done>Rate limiter utility created with Upstash Redis integration</done>
</task>

<task type="auto">
  <name>Task 2: Apply rate limiting to all auth endpoints</name>
  <files>
    src/app/api/auth/login/route.ts
    src/app/api/auth/logout/route.ts
    src/app/api/auth/register/route.ts
    src/app/api/auth/session/route.ts
    src/app/api/auth/magic-link/send/route.ts
    src/app/api/auth/magic-link/verify/route.ts
    src/app/api/portal/auth/login/route.ts
    src/app/api/portal/auth/logout/route.ts
    src/app/api/portal/auth/session/route.ts
    src/app/api/portal/auth/register/[token]/route.ts
    src/app/api/portal/auth/verify-invite/[token]/route.ts
    src/app/api/portal/auth/qr-token/route.ts
    src/app/api/portal/auth/qr-login/route.ts
  </files>
  <action>
For each auth endpoint, add rate limiting check at the START of the handler:

1. Add import at top of file:
   ```typescript
   import { checkRateLimit } from "@/lib/rate-limit";
   ```

2. Add rate limit check as first action in each POST/GET handler:
   ```typescript
   export async function POST(request: NextRequest) {
     // Rate limiting
     const rateLimitResponse = await checkRateLimit(request);
     if (rateLimitResponse) return rateLimitResponse;

     // ... rest of existing handler
   }
   ```

Apply to these endpoints (13 total):
- /api/auth/login (POST)
- /api/auth/logout (POST)
- /api/auth/register (POST)
- /api/auth/session (GET) - rate limit to prevent session enumeration
- /api/auth/magic-link/send (POST)
- /api/auth/magic-link/verify (POST)
- /api/portal/auth/login (POST)
- /api/portal/auth/logout (POST)
- /api/portal/auth/session (GET)
- /api/portal/auth/register/[token] (POST)
- /api/portal/auth/verify-invite/[token] (GET)
- /api/portal/auth/qr-token (POST)
- /api/portal/auth/qr-login (POST)
  </action>
  <verify>
For each modified file, confirm:
- Import statement for checkRateLimit exists
- Rate limit check is first operation in handler
- Handler returns rateLimitResponse if rate limited

Quick verification:
```bash
grep -l "checkRateLimit" src/app/api/auth/**/route.ts src/app/api/portal/auth/**/route.ts
# Should list all 13 files
```
  </verify>
  <done>All 13 auth endpoints have rate limiting applied</done>
</task>

</tasks>

<verification>
```bash
# Verify rate limit import in all auth routes
grep -r "checkRateLimit" src/app/api/auth/ src/app/api/portal/auth/

# Count files with rate limiting (should be 13)
grep -l "checkRateLimit" src/app/api/auth/**/route.ts src/app/api/portal/auth/**/route.ts | wc -l

# Verify package installation
npm list @upstash/ratelimit @upstash/redis
```

Manual test (requires Upstash credentials):
1. Start dev server
2. Send 11+ rapid requests to /api/auth/login
3. 11th request should return 429 with X-RateLimit-* headers
</verification>

<success_criteria>
- @upstash/ratelimit and @upstash/redis installed
- src/lib/rate-limit.ts exports checkRateLimit function
- All 13 auth endpoints import and use checkRateLimit
- Rate limit returns 429 after 10 requests per minute
- Requirement SEC-06 satisfied
</success_criteria>

<output>
After completion, create `.planning/phases/30-security-audit-cve-patching/30-03-SUMMARY.md`
</output>
