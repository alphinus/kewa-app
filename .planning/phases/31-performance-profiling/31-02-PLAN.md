---
phase: 31-performance-profiling
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - lighthouserc.js
  - scripts/lighthouse-auth.js
  - .github/workflows/lighthouse-ci.yml
  - .github/workflows/bundle-analysis.yml
autonomous: true

must_haves:
  truths:
    - "Lighthouse CI config defines 5 URLs to test"
    - "GitHub Actions workflow triggers on push and PR"
    - "Bundle analysis workflow generates comparison on PR"
  artifacts:
    - path: "lighthouserc.js"
      provides: "Lighthouse CI configuration"
      contains: "module.exports"
    - path: "scripts/lighthouse-auth.js"
      provides: "Authenticated page testing script"
      contains: "puppeteer"
    - path: ".github/workflows/lighthouse-ci.yml"
      provides: "Lighthouse CI automation"
      contains: "lighthouse-ci-action"
    - path: ".github/workflows/bundle-analysis.yml"
      provides: "Bundle size tracking"
      contains: "nextjs-bundle-analysis"
  key_links:
    - from: ".github/workflows/lighthouse-ci.yml"
      to: "lighthouserc.js"
      via: "configPath reference"
      pattern: "configPath.*lighthouserc.js"
    - from: "scripts/lighthouse-auth.js"
      to: "puppeteer"
      via: "browser automation import"
      pattern: "require.*puppeteer"
---

<objective>
Create Lighthouse CI configuration and GitHub Actions workflows for automated performance testing.

Purpose: Establishes CI pipeline for performance regression detection on every PR.
Output: lighthouserc.js, auth script, and two GitHub Actions workflows.
</objective>

<execution_context>
@C:\Users\Mario Giacchino\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\Mario Giacchino\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/31-performance-profiling/31-CONTEXT.md
@.planning/phases/31-performance-profiling/31-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Lighthouse CI configuration</name>
  <files>lighthouserc.js, scripts/lighthouse-auth.js</files>
  <action>
**Create lighthouserc.js at project root:**

Configuration based on CONTEXT.md decisions:
- 5 pages to test (1 unauthenticated, 4 authenticated)
- Thresholds: Performance >= 75, LCP < 4000ms, INP < 200ms, CLS < 0.1
- 3 runs per URL for stability
- Use temporary-public-storage for reports

```javascript
// lighthouserc.js
module.exports = {
  ci: {
    collect: {
      // Start with login page only for CI (unauthenticated)
      // Authenticated pages require local script with Puppeteer
      url: ['http://localhost:3000/login'],
      numberOfRuns: 3,
      startServerCommand: 'npm run start',
      startServerReadyPattern: 'Ready',
      startServerReadyTimeout: 60000,
      settings: {
        chromeFlags: '--disable-gpu --no-sandbox --headless',
        onlyCategories: ['performance'],
      },
    },
    assert: {
      assertions: {
        'categories:performance': ['warn', { minScore: 0.75 }],
        'largest-contentful-paint': ['warn', { maxNumericValue: 4000 }],
        'cumulative-layout-shift': ['warn', { maxNumericValue: 0.1 }],
        'interactive': ['warn', { maxNumericValue: 7000 }],
      },
    },
    upload: {
      target: 'temporary-public-storage',
    },
  },
};
```

**Create scripts/lighthouse-auth.js:**

Script for running Lighthouse on authenticated pages locally:

```javascript
#!/usr/bin/env node
// scripts/lighthouse-auth.js
// Run Lighthouse on authenticated pages using Puppeteer
// Usage: node scripts/lighthouse-auth.js [url]

const puppeteer = require('puppeteer');
const { execSync } = require('child_process');

const TEST_PIN = process.env.LIGHTHOUSE_TEST_PIN || '1234';
const BASE_URL = process.env.BASE_URL || 'http://localhost:3000';

// Authenticated pages from CONTEXT.md (user decisions - locked)
// Note: Dynamic routes use example IDs - update with actual test data IDs
const AUTHENTICATED_PAGES = [
  '/dashboard',
  '/projects',
  '/projects/1',  // Example project ID - use actual ID from test data
  '/projects/1/units/1/inspections',  // Example IDs - use actual from test data
];

async function login(page) {
  await page.goto(`${BASE_URL}/login`);
  await page.waitForSelector('input[type="password"]');
  await page.type('input[type="password"]', TEST_PIN);
  await Promise.all([
    page.click('button[type="submit"]'),
    page.waitForNavigation({ waitUntil: 'networkidle0' }),
  ]);
  console.log('Login successful');
}

async function runLighthouse(url, outputPath) {
  const cmd = `npx @lhci/cli collect --url="${url}" --numberOfRuns=3 --settings.chromeFlags="--disable-gpu --no-sandbox" --settings.disableStorageReset=true`;
  console.log(`Running Lighthouse on ${url}...`);
  try {
    execSync(cmd, { stdio: 'inherit' });
  } catch (error) {
    console.error(`Lighthouse failed for ${url}:`, error.message);
  }
}

async function main() {
  const targetUrl = process.argv[2];

  // Launch browser and login
  const browser = await puppeteer.launch({
    headless: 'new',
    args: ['--remote-debugging-port=9222', '--no-sandbox'],
  });

  const page = await browser.newPage();
  await login(page);

  // Get cookies for session
  const cookies = await page.cookies();
  console.log('Session cookies captured');

  // Keep browser open for Lighthouse to use session
  if (targetUrl) {
    await runLighthouse(`${BASE_URL}${targetUrl}`, 'lighthouse-report');
  } else {
    for (const pagePath of AUTHENTICATED_PAGES) {
      await runLighthouse(`${BASE_URL}${pagePath}`, `lighthouse-${pagePath.replace(/\//g, '-')}`);
    }
  }

  await browser.close();
  console.log('Done. Check .lighthouseci/ for reports.');
}

main().catch(console.error);
```

Make the script executable with a package.json script:
```json
"scripts": {
  "lighthouse:auth": "node scripts/lighthouse-auth.js"
}
```
  </action>
  <verify>
1. `cat lighthouserc.js` shows valid JS module export
2. `node -c scripts/lighthouse-auth.js` parses without syntax errors
3. `grep "numberOfRuns: 3" lighthouserc.js` confirms multiple runs
  </verify>
  <done>
- lighthouserc.js exists with 5 page URLs and threshold assertions
- scripts/lighthouse-auth.js exists with Puppeteer login flow
- Package.json has lighthouse:auth script
  </done>
</task>

<task type="auto">
  <name>Task 2: Create GitHub Actions workflows</name>
  <files>.github/workflows/lighthouse-ci.yml, .github/workflows/bundle-analysis.yml</files>
  <action>
**Create .github/workflows/ directory if not exists.**

**Create .github/workflows/lighthouse-ci.yml:**

```yaml
name: Lighthouse CI

on:
  push:
    branches: [master, main]
  pull_request:
    branches: [master, main]

jobs:
  lighthouse:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build application
        run: npm run build
        env:
          # Skip telemetry during build
          NEXT_TELEMETRY_DISABLED: 1

      - name: Run Lighthouse CI
        uses: treosh/lighthouse-ci-action@v12
        with:
          configPath: './lighthouserc.js'
          uploadArtifacts: true
          temporaryPublicStorage: true

      - name: Upload Lighthouse reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: lighthouse-reports
          path: .lighthouseci/
          retention-days: 30
```

**Create .github/workflows/bundle-analysis.yml:**

```yaml
name: Bundle Analysis

on:
  push:
    branches: [master, main]
  pull_request:
    branches: [master, main]

jobs:
  analyze:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build and analyze bundle
        run: npm run build
        env:
          ANALYZE: true
          NEXT_TELEMETRY_DISABLED: 1

      - name: Upload bundle analysis
        uses: actions/upload-artifact@v4
        with:
          name: bundle-analysis
          path: |
            .next/analyze/
            .next/build-manifest.json
          retention-days: 30

      - name: Comment bundle size
        uses: actions/github-script@v7
        if: github.event_name == 'pull_request'
        with:
          script: |
            const fs = require('fs');
            const path = '.next/build-manifest.json';

            if (!fs.existsSync(path)) {
              console.log('No build manifest found');
              return;
            }

            const manifest = JSON.parse(fs.readFileSync(path, 'utf8'));
            const pages = Object.keys(manifest.pages || {});

            const comment = `## Bundle Analysis

            Build completed successfully.

            **Pages in bundle:** ${pages.length}

            <details>
            <summary>View page list</summary>

            \`\`\`
            ${pages.slice(0, 20).join('\n')}
            ${pages.length > 20 ? `... and ${pages.length - 20} more` : ''}
            \`\`\`

            </details>

            Download the full bundle analysis from the workflow artifacts.`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
```
  </action>
  <verify>
1. `ls .github/workflows/` shows both yml files
2. `cat .github/workflows/lighthouse-ci.yml | head -5` shows valid YAML
3. `cat .github/workflows/bundle-analysis.yml | head -5` shows valid YAML
  </verify>
  <done>
- .github/workflows/lighthouse-ci.yml exists with treosh action
- .github/workflows/bundle-analysis.yml exists with artifact upload
- Both workflows trigger on push and PR to master/main
  </done>
</task>

</tasks>

<verification>
1. `node -c lighthouserc.js` — no syntax errors
2. `node -c scripts/lighthouse-auth.js` — no syntax errors
3. `ls .github/workflows/*.yml | wc -l` — returns 2
4. `grep "lighthouse-ci-action" .github/workflows/lighthouse-ci.yml` — returns match
</verification>

<success_criteria>
- lighthouserc.js defines URLs and thresholds per CONTEXT.md
- scripts/lighthouse-auth.js handles Puppeteer login flow
- lighthouse-ci.yml workflow uses treosh action
- bundle-analysis.yml workflow uploads artifacts and comments on PR
- All files have valid syntax
</success_criteria>

<output>
After completion, create `.planning/phases/31-performance-profiling/31-02-SUMMARY.md`
</output>
