---
phase: 31-performance-profiling
plan: 03
type: execute
wave: 2
depends_on: ["31-01", "31-02"]
files_modified:
  - .planning/baselines/v3.1-phase31-baseline.json
  - .planning/baselines/v3.1-phase31-baseline.md
  - .planning/baselines/.gitignore
autonomous: true

must_haves:
  truths:
    - "Baseline JSON contains LCP, INP, CLS scores for login page"
    - "Baseline Markdown table shows top 10 dependencies by size"
    - "Full Lighthouse HTML reports are gitignored"
  artifacts:
    - path: ".planning/baselines/v3.1-phase31-baseline.json"
      provides: "Machine-readable performance metrics"
      contains: "performance"
    - path: ".planning/baselines/v3.1-phase31-baseline.md"
      provides: "Human-readable baseline summary"
      contains: "Core Web Vitals"
    - path: ".planning/baselines/.gitignore"
      provides: "Excludes raw Lighthouse reports"
      contains: "*.lighthouse.json"
  key_links:
    - from: ".planning/baselines/v3.1-phase31-baseline.md"
      to: ".planning/baselines/v3.1-phase31-baseline.json"
      via: "references same metrics"
      pattern: "phase31-baseline"
---

<objective>
Run Lighthouse locally to establish baseline metrics and document results for future comparison.

Purpose: Creates the performance baseline that Phases 32-33 will improve upon.
Output: Baseline JSON and Markdown files in .planning/baselines/
</objective>

<execution_context>
@C:\Users\Mario Giacchino\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\Mario Giacchino\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/31-performance-profiling/31-CONTEXT.md
@.planning/phases/31-performance-profiling/31-RESEARCH.md
@.planning/phases/31-performance-profiling/31-01-SUMMARY.md
@.planning/phases/31-performance-profiling/31-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Run Lighthouse baseline collection</name>
  <files>.planning/baselines/.gitignore</files>
  <action>
**Create baselines directory:**
```bash
mkdir -p .planning/baselines
```

**Create .planning/baselines/.gitignore:**
```
# Exclude raw Lighthouse reports (large HTML/JSON files)
*.lighthouse.json
*.lighthouse.html
lhr-*.json
.lighthouseci/
```

**Build the application:**
```bash
npm run build
```

**Start the production server in background:**
```bash
npm run start &
# Wait for server to be ready
sleep 10
```

**Run Lighthouse CI on login page (unauthenticated):**
```bash
npx @lhci/cli collect --url="http://localhost:3000/login" --numberOfRuns=3 --settings.chromeFlags="--disable-gpu --no-sandbox --headless"
```

**Collect results:**
The results will be in `.lighthouseci/` directory. Parse the median run's JSON for metrics.

Extract key metrics:
- Performance score (0-100)
- LCP (ms)
- INP (ms) - may show as TBT in synthetic
- CLS (score)

**Note:** INP (Interaction to Next Paint) requires real user interaction. In synthetic testing, use TBT (Total Blocking Time) as proxy. CLS and LCP are directly measurable.

Stop the server after collection.
  </action>
  <verify>
1. `.lighthouseci/` directory exists with JSON files
2. At least 3 runs completed (3 JSON files)
3. Parsed metrics show valid numbers
  </verify>
  <done>
- Lighthouse ran 3 times on login page
- Results captured in .lighthouseci/
- Server stopped cleanly
  </done>
</task>

<task type="auto">
  <name>Task 2: Run bundle analysis and extract top dependencies</name>
  <files>None (reads build output)</files>
  <action>
**Run bundle analysis build:**
```bash
# Windows-compatible:
set ANALYZE=true && npm run build
# Or cross-platform:
npx cross-env ANALYZE=true npm run build
```

If cross-env not available, set environment variable manually before build.

**Extract bundle information:**

The bundle analyzer creates files in `.next/analyze/` or outputs to console.

Parse `.next/build-manifest.json` and `.next/app-build-manifest.json` to identify:
1. Total JS bundle size
2. Largest chunks
3. Page-specific bundles

**Identify top 10 dependencies:**

Check `node_modules` sizes or use the analyzer output to identify:
- react / react-dom
- @tiptap/* (rich text editor)
- recharts (charts)
- @react-pdf/renderer
- lucide-react (icons)
- date-fns
- @supabase/*
- dexie (IndexedDB)
- Other large deps

Calculate approximate sizes from bundle chunks or `package-lock.json`.
  </action>
  <verify>
1. Bundle analysis ran without error
2. Can identify at least 10 large dependencies
3. Have approximate sizes for each
  </verify>
  <done>
- Bundle analysis completed
- Top 10 dependencies identified with sizes
- Data ready for baseline documentation
  </done>
</task>

<task type="auto">
  <name>Task 3: Document baseline metrics</name>
  <files>.planning/baselines/v3.1-phase31-baseline.json, .planning/baselines/v3.1-phase31-baseline.md</files>
  <action>
**Create .planning/baselines/v3.1-phase31-baseline.json:**

```json
{
  "version": "v3.1-phase31",
  "date": "YYYY-MM-DD",
  "environment": {
    "node": "20.x",
    "nextjs": "16.1.6",
    "react": "19.2.3"
  },
  "lighthouse": {
    "runs": 3,
    "tool": "@lhci/cli",
    "pages": {
      "/login": {
        "performance": <median-score>,
        "lcp": <median-ms>,
        "tbt": <median-ms>,
        "cls": <median-score>,
        "fcp": <median-ms>,
        "si": <median-ms>
      }
    },
    "notes": "Authenticated pages require manual testing with scripts/lighthouse-auth.js"
  },
  "bundle": {
    "totalSize": <bytes>,
    "topDependencies": [
      { "name": "react-dom", "size": <bytes>, "reason": "React rendering" },
      { "name": "@tiptap/core", "size": <bytes>, "reason": "Rich text editor" },
      // ... 8 more
    ]
  },
  "thresholds": {
    "performance": { "target": 75, "status": "pass|warn|fail" },
    "lcp": { "target": 4000, "status": "pass|warn|fail" },
    "cls": { "target": 0.1, "status": "pass|warn|fail" }
  }
}
```

**Create .planning/baselines/v3.1-phase31-baseline.md:**

```markdown
# Performance Baseline: v3.1 Phase 31

**Date:** YYYY-MM-DD
**Phase:** 31 - Performance Profiling & Baseline

## Core Web Vitals (Login Page)

| Metric | Value | Target | Status |
|--------|-------|--------|--------|
| Performance Score | XX | >= 75 | PASS/WARN |
| LCP (Largest Contentful Paint) | XXXXms | < 4000ms | PASS/WARN |
| TBT (Total Blocking Time)* | XXXms | < 200ms | PASS/WARN |
| CLS (Cumulative Layout Shift) | X.XX | < 0.1 | PASS/WARN |

*TBT used as INP proxy in synthetic testing

## Bundle Analysis

### Top 10 Dependencies by Size

| Rank | Package | Size (KB) | Purpose |
|------|---------|-----------|---------|
| 1 | react-dom | XXX | React rendering |
| 2 | @tiptap/core | XXX | Rich text editor |
| 3 | recharts | XXX | Charts |
| 4 | @react-pdf/renderer | XXX | PDF generation |
| 5 | lucide-react | XXX | Icons |
| 6 | date-fns | XXX | Date utilities |
| 7 | @supabase/supabase-js | XXX | Database client |
| 8 | dexie | XXX | IndexedDB wrapper |
| 9 | ... | XXX | ... |
| 10 | ... | XXX | ... |

**Total JS Bundle:** XXX KB

## Notes

- Authenticated pages (dashboard, projects, inspections) require manual testing
- Run `npm run lighthouse:auth` for authenticated page metrics
- Full Lighthouse HTML reports in `.lighthouseci/` (gitignored)

## Comparison Targets

This baseline will be compared after:
- Phase 32: Database Optimization
- Phase 33: Bundle & Rendering Optimization

Expected improvements:
- LCP: 20%+ reduction
- Bundle size: 100+ KB reduction
```

Fill in actual values from Task 1 and Task 2 results.
  </action>
  <verify>
1. `cat .planning/baselines/v3.1-phase31-baseline.json | jq .` parses as valid JSON
2. `cat .planning/baselines/v3.1-phase31-baseline.md` shows complete table
3. All metrics have actual values (no placeholders)
  </verify>
  <done>
- JSON baseline contains all metrics with real values
- Markdown summary readable with complete tables
- Thresholds evaluated against targets
  </done>
</task>

</tasks>

<verification>
1. `.planning/baselines/` directory exists with 3 files
2. JSON parses correctly with `jq` or `node -e`
3. Markdown contains no placeholder text (XX or YYYY)
4. Top 10 dependencies listed with sizes
5. `.gitignore` excludes raw Lighthouse files
</verification>

<success_criteria>
- Lighthouse ran successfully on login page (3 runs)
- Bundle analysis identified top 10 largest dependencies
- v3.1-phase31-baseline.json has all metrics populated
- v3.1-phase31-baseline.md has human-readable summary
- Raw Lighthouse reports gitignored
- PERF-01 and PERF-02 requirements satisfied
</success_criteria>

<output>
After completion, create `.planning/phases/31-performance-profiling/31-03-SUMMARY.md`
</output>
