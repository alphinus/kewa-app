---
phase: 31-performance-profiling
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - src/app/layout.tsx
  - next.config.ts
autonomous: true

must_haves:
  truths:
    - "Speed Insights component renders in production builds"
    - "Bundle analyzer generates HTML report when ANALYZE=true"
    - "CSP allows Vercel Speed Insights script"
  artifacts:
    - path: "package.json"
      provides: "Performance dependencies"
      contains: "@vercel/speed-insights"
    - path: "src/app/layout.tsx"
      provides: "SpeedInsights component"
      contains: "SpeedInsights"
    - path: "next.config.ts"
      provides: "Bundle analyzer integration"
      contains: "withBundleAnalyzer"
  key_links:
    - from: "src/app/layout.tsx"
      to: "@vercel/speed-insights/next"
      via: "import and render"
      pattern: "import.*SpeedInsights.*from.*@vercel/speed-insights"
    - from: "next.config.ts"
      to: "@next/bundle-analyzer"
      via: "HOC wrapper"
      pattern: "withBundleAnalyzer"
---

<objective>
Install performance tooling dependencies and integrate Vercel Speed Insights for real user monitoring.

Purpose: Enables RUM data collection in production and bundle analysis for optimization insights.
Output: Updated package.json, layout.tsx with SpeedInsights, next.config.ts with bundle analyzer.
</objective>

<execution_context>
@C:\Users\Mario Giacchino\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\Mario Giacchino\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/31-performance-profiling/31-CONTEXT.md
@.planning/phases/31-performance-profiling/31-RESEARCH.md
@next.config.ts
@src/app/layout.tsx
@package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install performance dependencies</name>
  <files>package.json</files>
  <action>
Install the following packages:

Production dependencies:
- `@vercel/speed-insights` — Real User Monitoring for Vercel deployments

Dev dependencies:
- `@next/bundle-analyzer` — Interactive bundle visualization
- `@lhci/cli` — Lighthouse CI runner for local testing
- `puppeteer` — Browser automation for authenticated page testing

Run: `npm install @vercel/speed-insights && npm install --save-dev @next/bundle-analyzer @lhci/cli puppeteer`

Add npm script in package.json:
```json
"scripts": {
  "analyze": "ANALYZE=true next build"
}
```

Note: For Windows compatibility, the script uses ANALYZE env var which will be set via cross-platform method or npm run with env.
  </action>
  <verify>
Run `npm ls @vercel/speed-insights @next/bundle-analyzer @lhci/cli puppeteer` — all should show installed versions with no errors.
  </verify>
  <done>
package.json includes all 4 packages with correct dependency types (prod vs dev).
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate Speed Insights and Bundle Analyzer</name>
  <files>src/app/layout.tsx, next.config.ts</files>
  <action>
**Update src/app/layout.tsx:**

Add Vercel Speed Insights component at the end of body, after Toaster:

```tsx
import { SpeedInsights } from '@vercel/speed-insights/next';

// Inside body, after Toaster:
<SpeedInsights />
```

The component auto-detects Vercel environment and only loads in production deployments.

**Update next.config.ts:**

Wrap the config with bundle analyzer HOC:

```typescript
import withBundleAnalyzer from '@next/bundle-analyzer';

const bundleAnalyzer = withBundleAnalyzer({
  enabled: process.env.ANALYZE === 'true',
  openAnalyzer: false, // Don't auto-open in CI
});

// At the end, wrap export:
export default bundleAnalyzer(nextConfig);
```

**Update CSP in next.config.ts:**

Add Vercel Speed Insights domain to connect-src:
- Change: `connect-src 'self' https://*.supabase.co wss://*.supabase.co`
- To: `connect-src 'self' https://*.supabase.co wss://*.supabase.co https://vitals.vercel-insights.com`
  </action>
  <verify>
1. Run `npm run build` — build succeeds without errors
2. Check next.config.ts exports bundleAnalyzer wrapper
3. Check layout.tsx imports and renders SpeedInsights
  </verify>
  <done>
- SpeedInsights component renders in layout (visible in build output)
- Bundle analyzer configured with ANALYZE=true trigger
- CSP updated to allow vitals.vercel-insights.com
  </done>
</task>

</tasks>

<verification>
1. `npm run build` completes successfully
2. `npm ls @vercel/speed-insights` shows installed
3. `grep -n "SpeedInsights" src/app/layout.tsx` returns match
4. `grep -n "withBundleAnalyzer" next.config.ts` returns match
</verification>

<success_criteria>
- All 4 packages installed (speed-insights, bundle-analyzer, lhci/cli, puppeteer)
- SpeedInsights component in root layout
- Bundle analyzer HOC wrapping next config
- CSP allows Vercel insights endpoint
- Build passes without errors
</success_criteria>

<output>
After completion, create `.planning/phases/31-performance-profiling/31-01-SUMMARY.md`
</output>
