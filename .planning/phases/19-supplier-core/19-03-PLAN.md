---
phase: 19-supplier-core
plan: 03
type: execute
wave: 2
depends_on: ["19-01", "19-02"]
files_modified:
  - src/app/api/deliveries/route.ts
  - src/app/api/deliveries/[id]/route.ts
  - src/app/api/deliveries/[id]/link-invoice/route.ts
  - src/components/suppliers/DeliveryForm.tsx
  - src/components/suppliers/DeliveryList.tsx
  - src/components/suppliers/OrderHistoryTable.tsx
  - src/app/dashboard/lieferanten/page.tsx
  - src/app/dashboard/lieferanten/[id]/page.tsx
  - src/app/dashboard/lieferanten/bestellungen/page.tsx
  - src/app/dashboard/lieferanten/bestellungen/neu/page.tsx
  - src/app/dashboard/lieferanten/bestellungen/[id]/page.tsx
autonomous: true

must_haves:
  truths:
    - "User can record a delivery with actual quantities and property association"
    - "User can link a delivery to an existing invoice"
    - "User can view order history per supplier"
    - "User can view delivery history per property"
    - "Variance between ordered and received quantities is tracked"
  artifacts:
    - path: "src/app/api/deliveries/route.ts"
      provides: "Delivery list and create endpoints"
      exports: ["GET", "POST"]
    - path: "src/app/api/deliveries/[id]/link-invoice/route.ts"
      provides: "Invoice linking endpoint"
      exports: ["POST"]
    - path: "src/components/suppliers/DeliveryForm.tsx"
      provides: "Form for recording deliveries"
      min_lines: 80
    - path: "src/components/suppliers/OrderHistoryTable.tsx"
      provides: "Order history display per supplier or property"
      min_lines: 60
    - path: "src/app/dashboard/lieferanten/page.tsx"
      provides: "Supplier list page"
      min_lines: 40
    - path: "src/app/dashboard/lieferanten/bestellungen/[id]/page.tsx"
      provides: "Purchase order detail with delivery recording"
      min_lines: 80
  key_links:
    - from: "src/components/suppliers/DeliveryForm.tsx"
      to: "/api/deliveries"
      via: "fetch POST on submit"
      pattern: "fetch.*api/deliveries"
    - from: "src/app/api/deliveries/[id]/link-invoice/route.ts"
      to: "invoices table"
      via: "invoice_id validation"
      pattern: "invoices.*select"
    - from: "src/app/dashboard/lieferanten/bestellungen/[id]/page.tsx"
      to: "DeliveryForm component"
      via: "import and render"
      pattern: "import.*DeliveryForm"
---

<objective>
Implement delivery recording, invoice linking, and dashboard pages for supplier management.

Purpose: Complete the supplier workflow by enabling delivery tracking with property association, invoice linking for payment tracking, and providing UI pages for the entire supplier module.
Output: Delivery API and components, invoice linking, order history views, and dashboard pages.
</objective>

<execution_context>
@C:\Users\Mario Giacchino\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\Mario Giacchino\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/19-supplier-core/19-RESEARCH.md

# Dependencies from prior plans
@src/types/suppliers.ts
@src/lib/suppliers/status-utils.ts
@src/lib/suppliers/purchase-order-queries.ts
@src/components/suppliers/PurchaseOrderList.tsx
@src/components/suppliers/PurchaseOrderForm.tsx

# Existing patterns to follow
@src/app/dashboard/partners/page.tsx
@src/app/dashboard/partners/[id]/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create delivery API routes</name>
  <files>
    src/app/api/deliveries/route.ts
    src/app/api/deliveries/[id]/route.ts
    src/app/api/deliveries/[id]/link-invoice/route.ts
  </files>
  <action>
1. Create src/app/api/deliveries/route.ts:

GET endpoint:
- Accept query params: purchase_order_id, property_id, supplier_id, limit, offset
- If supplier_id provided: join through purchase_orders to filter by supplier
- Join with purchase_orders (order_number, supplier), properties (name), buildings (name), invoices (invoice_number)
- Order by delivery_date DESC
- Return { deliveries, total, limit, offset }

POST endpoint:
- Validate: purchase_order_id required, delivery_date required, quantity_ordered/received required, property_id required
- Verify purchase_order exists and is in 'confirmed' status (can only record delivery for confirmed orders)
- Verify property exists, and if building_id provided, verify it belongs to property
- Insert delivery
- Update purchase_order status to 'delivered' (trigger handles timestamp)
- Return { delivery } with 201 status

2. Create src/app/api/deliveries/[id]/route.ts:

GET: Return single delivery with all joins
PATCH: Update delivery_note_number, quantity_received, variance_note, notes
  - Recalculate has_variance if quantity_received changes
DELETE: Only if no invoice_id linked, otherwise return 400

3. Create src/app/api/deliveries/[id]/link-invoice/route.ts:

POST endpoint:
- Accept { invoice_id: string } in body
- Validate invoice exists and is in valid status ('received', 'under_review', 'approved', 'paid')
- Validate invoice belongs to same supplier as purchase order
- Update delivery.invoice_id
- Update purchase_order status to 'invoiced' if not already
- Return updated delivery

This enables SUPP-06: Deliveries can be linked to invoices for payment tracking.
  </action>
  <verify>
Start dev server: npm run dev
Test create delivery: curl -X POST /api/deliveries with valid body
Test list with filters: curl /api/deliveries?property_id=xxx
Test link invoice: curl -X POST /api/deliveries/{id}/link-invoice -d '{"invoice_id":"xxx"}'
  </verify>
  <done>
Delivery API supports CRUD with property association and invoice linking.
Recording delivery auto-transitions PO to 'delivered' status.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create delivery and history components</name>
  <files>
    src/components/suppliers/DeliveryForm.tsx
    src/components/suppliers/DeliveryList.tsx
    src/components/suppliers/OrderHistoryTable.tsx
    src/components/suppliers/SupplierDetail.tsx
  </files>
  <action>
1. Create src/components/suppliers/DeliveryForm.tsx (dialog/modal):
- Props: { purchaseOrder: PurchaseOrder, onSave: (delivery) => Promise<void>, onCancel: () => void }
- Fields:
  - Delivery date (date input, default today)
  - Delivery note number (Lieferschein-Nr., optional text)
  - Quantity received (number, pre-fill from PO total quantity)
  - Property selector (required, fetch from /api/properties)
  - Building selector (optional, fetch buildings for selected property)
  - Variance note (show only if quantity_received != quantity_ordered)
  - Notes (optional textarea)
- Display ordered quantity for reference
- Show variance warning if quantities differ
- Submit calls onSave with CreateDeliveryInput

2. Create src/components/suppliers/DeliveryList.tsx:
- Props: { purchaseOrderId?: string, propertyId?: string }
- Fetch from /api/deliveries with filters
- Display as table: Date, Lieferschein-Nr., Qty Ordered, Qty Received, Property, Invoice, Actions
- Variance indicator (icon/color) if has_variance
- Link invoice action (button to open invoice link dialog)
- Empty state if no deliveries

3. Create src/components/suppliers/OrderHistoryTable.tsx:
- Props: { supplierId?: string, propertyId?: string, limit?: number }
- Fetch purchase orders with deliveries for the given filter
- Display: Order #, Date, Supplier (if property view), Property (if supplier view), Total, Status, Delivery Date
- Expandable rows showing delivery details
- Used on both supplier detail and property detail pages

4. Create src/components/suppliers/SupplierDetail.tsx:
- Props: { supplierId: string }
- Fetch supplier from /api/partners/{id}
- Display supplier info (company name, contact, email, phone, address)
- Stats: Total orders, Total delivered, Open orders
- Include OrderHistoryTable for this supplier
- Action buttons: New Order, Edit Supplier

Follow existing component patterns from src/components/partners/ and src/components/costs/.
  </action>
  <verify>
TypeScript: npx tsc --noEmit
Visual: Import components in test page and verify rendering
  </verify>
  <done>
DeliveryForm captures all delivery details with property association.
OrderHistoryTable shows orders per supplier or per property.
SupplierDetail displays supplier info with order history.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create supplier dashboard pages</name>
  <files>
    src/app/dashboard/lieferanten/page.tsx
    src/app/dashboard/lieferanten/[id]/page.tsx
    src/app/dashboard/lieferanten/bestellungen/page.tsx
    src/app/dashboard/lieferanten/bestellungen/neu/page.tsx
    src/app/dashboard/lieferanten/bestellungen/[id]/page.tsx
  </files>
  <action>
1. Create src/app/dashboard/lieferanten/page.tsx:
- Server component fetching suppliers from /api/suppliers
- Display PartnerList filtered to suppliers (reuse existing component if possible)
- Or display simple table: Company, Contact, Email, Phone, Orders Count
- Link each row to /dashboard/lieferanten/[id]
- Action button: "Neuer Lieferant" -> /dashboard/partners/neu?type=supplier
- Page title: "Lieferanten"

2. Create src/app/dashboard/lieferanten/[id]/page.tsx:
- Server component fetching supplier details
- Render SupplierDetail component
- Breadcrumb: Dashboard > Lieferanten > {supplier name}
- Actions: Edit (link to partner edit), New Order (link to bestellungen/neu?supplier_id=xxx)

3. Create src/app/dashboard/lieferanten/bestellungen/page.tsx:
- Server component
- Render PurchaseOrderList component (all orders)
- Status filter tabs or dropdown
- Action button: "Neue Bestellung"
- Page title: "Bestellungen"

4. Create src/app/dashboard/lieferanten/bestellungen/neu/page.tsx:
- Client component
- Render PurchaseOrderForm
- Accept ?supplier_id query param to pre-select supplier
- On save: redirect to /dashboard/lieferanten/bestellungen/[id]
- On cancel: navigate back
- Page title: "Neue Bestellung"

5. Create src/app/dashboard/lieferanten/bestellungen/[id]/page.tsx:
- Server component fetching purchase order with deliveries
- Display order details: Order #, Supplier, Status, Expected Date, Line Items, Total
- Status badge and available actions (based on current status)
- Status transition buttons (e.g., "Als bestellt markieren", "Lieferung bestaetigen")
- Deliveries section: DeliveryList for this order
- "Lieferung erfassen" button (opens DeliveryForm dialog) - only if status is 'confirmed'
- Link invoice button for deliveries without invoice

Use existing dashboard layout patterns from src/app/dashboard/.
German UI labels throughout.
  </action>
  <verify>
Navigate to /dashboard/lieferanten - page loads with supplier list
Navigate to /dashboard/lieferanten/bestellungen/neu - form renders
Create test order and verify it appears in list
Record delivery and verify status changes
  </verify>
  <done>
Supplier module has complete UI navigation.
User can manage suppliers, create orders, record deliveries.
Order history visible per supplier and per property.
  </done>
</task>

</tasks>

<verification>
1. TypeScript: `npx tsc --noEmit` passes
2. Navigation: All pages accessible and render correctly
3. CRUD flow: Create supplier -> Create PO -> Confirm -> Record delivery -> Link invoice
4. History: Supplier detail shows order history, property pages show delivery history
5. Requirements coverage:
   - SUPP-01: Supplier CRUD via Partners (existing + filtered view)
   - SUPP-02: Purchase order create with line items
   - SUPP-03: Status workflow (draft -> ordered -> confirmed -> delivered -> invoiced)
   - SUPP-04: Delivery recording with actual date, quantity, note number
   - SUPP-05: Deliveries associated with properties/buildings
   - SUPP-06: Deliveries linked to invoices
   - SUPP-07: Order history per supplier and property
</verification>

<success_criteria>
- Delivery recording works with property association
- Invoice linking updates delivery and PO status
- Supplier list page shows all suppliers
- Supplier detail shows contact info and order history
- Purchase order detail allows recording deliveries
- All SUPP-01 through SUPP-07 requirements satisfied
</success_criteria>

<output>
After completion, create `.planning/phases/19-supplier-core/19-03-SUMMARY.md`
</output>
