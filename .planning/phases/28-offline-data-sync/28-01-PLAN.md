---
phase: 28-offline-data-sync
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/db/schema.ts
  - src/lib/db/operations.ts
  - src/hooks/useOfflineEntity.ts
  - src/components/StalenessIndicator.tsx
autonomous: true

must_haves:
  truths:
    - "Dexie database initializes with three tables (cachedEntities, syncQueue, photoQueue) without errors"
    - "Viewing an entity page caches its data and direct children in IndexedDB"
    - "Cached entities are readable from IndexedDB when the device is offline"
    - "Staleness indicator shows 'Zuletzt synchronisiert: vor X' timestamp only when offline"
    - "Eviction removes oldest unpinned entries beyond count/time limits"
  artifacts:
    - path: "src/lib/db/schema.ts"
      provides: "Dexie database with three tables: cachedEntities, syncQueue, photoQueue"
      contains: "db.version(1).stores"
    - path: "src/lib/db/operations.ts"
      provides: "CRUD helpers for cached entities (cache on view, read, evict, pin/unpin)"
      exports: ["cacheEntityOnView", "getCachedEntity", "getCachedChildren", "pinEntity", "unpinEntity", "evictStaleEntities"]
    - path: "src/hooks/useOfflineEntity.ts"
      provides: "React hook returning cached entity data with live reactivity"
      exports: ["useOfflineEntity"]
    - path: "src/components/StalenessIndicator.tsx"
      provides: "Timestamp display for offline-viewed cached data"
      contains: "Zuletzt synchronisiert"
  key_links:
    - from: "src/hooks/useOfflineEntity.ts"
      to: "src/lib/db/schema.ts"
      via: "useLiveQuery from dexie-react-hooks"
      pattern: "useLiveQuery.*db\\.cachedEntities"
    - from: "src/lib/db/operations.ts"
      to: "src/lib/db/schema.ts"
      via: "Dexie table operations"
      pattern: "db\\.cachedEntities\\."
    - from: "src/components/StalenessIndicator.tsx"
      to: "src/contexts/ConnectivityContext.tsx"
      via: "useConnectivity hook"
      pattern: "useConnectivity"
---

<objective>
Set up Dexie IndexedDB foundation with entity caching layer for offline reads.

Purpose: This is the data persistence foundation for all offline functionality. Without IndexedDB schema and caching operations, nothing else in Phase 28 works.
Output: Dexie database schema, entity CRUD operations, reactive hook for reading cached data, and staleness indicator component.
</objective>

<execution_context>
@C:\Users\Mario Giacchino\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\Mario Giacchino\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/28-offline-data-sync/28-CONTEXT.md
@.planning/phases/28-offline-data-sync/28-RESEARCH.md
@src/contexts/ConnectivityContext.tsx
@src/types/database.ts
@src/lib/imageCompression.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Dexie database schema and entity caching operations</name>
  <files>
    src/lib/db/schema.ts
    src/lib/db/operations.ts
  </files>
  <action>
Install dexie@4.2.1 and dexie-react-hooks@4.2.0 via npm.

Create `src/lib/db/schema.ts`:
- Import Dexie and EntityTable from 'dexie'
- Define TypeScript interfaces:
  - `CachedEntity`: id (auto-increment number), entityType ('property' | 'unit' | 'workOrder' | 'task' | 'note'), entityId (string, the Supabase UUID), parentType (string | null, for children), parentId (string | null, for children), data (any — the full entity JSON), cachedAt (number, Date.now()), viewedAt (number, Date.now()), pinned (boolean)
  - `SyncQueueItem`: id (auto-increment number), operation ('create' | 'update' | 'delete'), entityType (string), entityId (string), endpoint (string, the API route to call), method ('POST' | 'PUT' | 'PATCH' | 'DELETE'), payload (any), createdAt (number), retryCount (number), lastError (string | undefined), status ('pending' | 'processing' | 'failed')
  - `PhotoQueueItem`: id (auto-increment number), entityType (string), entityId (string), blob (Blob), fileName (string), createdAt (number), retryCount (number), lastError (string | undefined), status ('pending' | 'processing' | 'failed')
- Create and export `db` as typed Dexie instance named 'KeWaDB'
- Define `db.version(1).stores()` with indexes:
  - cachedEntities: '++id, entityType, entityId, [entityType+entityId], [parentType+parentId], viewedAt, pinned'
  - syncQueue: '++id, createdAt, status'
  - photoQueue: '++id, createdAt, status'
- CRITICAL: Do NOT index blob or data fields
- Export all interfaces and the db instance

Create `src/lib/db/operations.ts`:
- Import db and types from schema.ts
- `cacheEntityOnView(entityType, entityId, data)`: Upsert entity — if exists by [entityType+entityId], update data/viewedAt/cachedAt; if not, add new entry with pinned=false
- `cacheChildren(parentType, parentId, children: Array<{entityType, entityId, data}>)`: Cache an array of child entities with parentType/parentId set. Use db.transaction for atomicity.
- `getCachedEntity(entityType, entityId)`: Return cached entity data or null using compound index [entityType+entityId]
- `getCachedChildren(parentType, parentId)`: Return all cached children for a parent
- `pinEntity(entityType, entityId)`: Set pinned=true on matching entity
- `unpinEntity(entityType, entityId)`: Set pinned=false on matching entity
- `evictStaleEntities()`: Remove unpinned entities not viewed in 7 days AND trim to max count per type (50 properties, 200 units, 500 work orders, 1000 tasks/notes). Delete oldest viewedAt first. Run this after each cache write.
- `requestPersistentStorage()`: Call navigator.storage.persist() if available. Return boolean. Call this once on first pin action.
- `getStorageEstimate()`: Return navigator.storage.estimate() result for monitoring

All functions are async. Use try-catch with console.error for IndexedDB failures (never crash the app on cache failure).
  </action>
  <verify>
Run `npx tsc --noEmit` to confirm no type errors. Verify files exist at src/lib/db/schema.ts and src/lib/db/operations.ts.
  </verify>
  <done>
Dexie database initializes with three tables. CachedEntity CRUD operations are exported and type-safe. Compound index [entityType+entityId] enables efficient lookups. Eviction logic removes stale unpinned entries.
  </done>
</task>

<task type="auto">
  <name>Task 2: Offline entity hook and staleness indicator</name>
  <files>
    src/hooks/useOfflineEntity.ts
    src/components/StalenessIndicator.tsx
  </files>
  <action>
Create `src/hooks/useOfflineEntity.ts`:
- 'use client' directive
- Import useLiveQuery from 'dexie-react-hooks'
- Import db from '@/lib/db/schema'
- Import useConnectivity from '@/contexts/ConnectivityContext'
- Export `useOfflineEntity(entityType: string, entityId: string)` hook:
  - Use useLiveQuery to query db.cachedEntities.where({entityType, entityId}).first()
  - Dependencies array: [entityType, entityId]
  - Return object: { data: cachedEntity?.data ?? null, cachedAt: cachedEntity?.cachedAt ?? null, pinned: cachedEntity?.pinned ?? false, isLoading: cachedEntity === undefined }
  - SSR safety: useLiveQuery returns undefined during SSR and on first render (this is safe — the hook returns isLoading:true in that case)
- Export `useOfflineChildren(parentType: string, parentId: string)` hook:
  - Use useLiveQuery to query db.cachedEntities.where({parentType, parentId}).toArray()
  - Return { children: items?.map(i => i.data) ?? [], isLoading: items === undefined }

Create `src/components/StalenessIndicator.tsx`:
- 'use client' directive
- Import useConnectivity from '@/contexts/ConnectivityContext'
- Import formatDistanceToNow from 'date-fns'
- Import de locale from 'date-fns/locale/de'
- Props: cachedAt (number | null)
- Only render when isOnline is false AND cachedAt is not null
- Render: small text "Zuletzt synchronisiert: vor {relative time}" using formatDistanceToNow(cachedAt, { locale: de, addSuffix: false })
  - Format example: "Zuletzt synchronisiert: vor 3 Stunden"
- Use text-xs text-gray-500 styling, with a Clock icon from lucide-react (h-3 w-3)
- Return null when online or when cachedAt is null
  </action>
  <verify>
Run `npx tsc --noEmit` to confirm no type errors. Verify both files export correctly. Check that useOfflineEntity uses useLiveQuery with proper dependencies array.
  </verify>
  <done>
useOfflineEntity hook provides reactive IndexedDB reads that auto-update when data changes. useOfflineChildren returns cached child entities. StalenessIndicator shows relative timestamp only when offline.
  </done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes with no errors
- dexie@4.2.1 and dexie-react-hooks@4.2.0 are in package.json dependencies
- src/lib/db/schema.ts exports db instance, CachedEntity, SyncQueueItem, PhotoQueueItem
- src/lib/db/operations.ts exports cacheEntityOnView, getCachedEntity, getCachedChildren, pinEntity, unpinEntity, evictStaleEntities
- src/hooks/useOfflineEntity.ts exports useOfflineEntity and useOfflineChildren
- src/components/StalenessIndicator.tsx renders only when offline with cachedAt timestamp
</verification>

<success_criteria>
- Dexie database schema with three indexed tables compiles without errors
- Entity caching operations handle upsert, read, pin, unpin, and eviction
- Reactive hook provides live IndexedDB query results in React components
- Staleness indicator conditionally renders based on connectivity state
- No SSR hydration issues (useLiveQuery handles this natively)
</success_criteria>

<output>
After completion, create `.planning/phases/28-offline-data-sync/28-01-SUMMARY.md`
</output>
