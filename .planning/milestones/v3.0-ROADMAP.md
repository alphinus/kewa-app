# Milestone v3.0: Tenant & Offline

**Status:** SHIPPED 2026-02-03
**Phases:** 25-29
**Total Plans:** 17

## Overview

v3.0 delivers tenant self-service and offline capability: A complete tenant portal for maintenance ticket management with WhatsApp-style messaging and real-time updates, PWA infrastructure with installable app and offline shell navigation, offline data sync with IndexedDB caching and automatic background sync, and UX polish with skeleton loaders, empty states, and toast notifications. The milestone transforms KEWA from an operator-only desktop app to a dual-audience PWA serving both property managers and tenants.

## Phases

### Phase 25: UX Polish (Known Issues)

**Goal**: v2.2 UAT issues are resolved and toast notification feedback is available across the app.
**Depends on**: Nothing (v3.0 starts here)
**Requirements**: UXPL-01, UXPL-02, UXPL-03, UXPL-04
**Plans**: 2 plans

Plans:
- [x] 25-01-PLAN.md — Invoice modal, checklist titles, delivery history page
- [x] 25-02-PLAN.md — Sonner integration, toast notifications across CRUD operations

**Success Criteria:**
1. Invoice linking opens a search/select modal instead of browser prompt()
2. Checklist items display their template-defined title and description
3. Property detail page shows delivery history with dates, quantities, and linked orders
4. Action feedback (save, delete, error) displays as toast notification via Sonner
5. Toast notifications are German-language and appear consistently across all CRUD operations

**Completed:** 2026-01-29

### Phase 26: Tenant Portal Core

**Goal**: Tenants can register, log in, create maintenance tickets with category/urgency, communicate via message threads, and view a dashboard -- all within an isolated, German-language, mobile-first portal.
**Depends on**: Phase 25
**Requirements**: TPRT-01, TPRT-02, TPRT-03, TPRT-04, TPRT-05, TPRT-06, TPRT-07, TPRT-09, TPRT-10, TPRT-14, TPRT-15
**Plans**: 4 plans

Plans:
- [x] 26-01-PLAN.md — Database schema (tickets, ticket_messages, ticket_attachments, tenant_users), types, tenant API namespace
- [x] 26-02-PLAN.md — Tenant auth (registration, login, session validation, route protection, data isolation)
- [x] 26-03-PLAN.md — Ticket CRUD with category/urgency, status workflow, photo attachments, message threads
- [x] 26-04-PLAN.md — Tenant dashboard, ticket list view, mobile-responsive layout, German UI

**Success Criteria:**
1. Tenant can register with email/password and is scoped to their unit; cannot see other tenants' data
2. Tenant can create a ticket selecting category (Heizung, Wasser/Sanitaer, Elektrik, Allgemein) and urgency (Notfall, Dringend, Normal) with optional photo attachments
3. Tenant can view their ticket list with current status and send/receive messages on each ticket
4. Tenant sees a dashboard showing open ticket count, recent messages, and unit information
5. Tenant portal renders in German, is mobile-responsive, and works portrait-first on phone screens

**Completed:** 2026-01-29

### Phase 27: PWA Foundation

**Goal**: The app is installable as a standalone PWA with offline shell navigation and online/offline status awareness, without breaking existing push notification functionality.
**Depends on**: Phase 26
**Requirements**: OFFL-01, OFFL-02, OFFL-03, OFFL-04, OFFL-12
**Plans**: 3 plans

Plans:
- [x] 27-01-PLAN.md — PWA manifest with icons, display: standalone, install prompt / A2HS guidance
- [x] 27-02-PLAN.md — Service worker expansion (cache-first static, network-first API), preserve push handlers
- [x] 27-03-PLAN.md — Online/offline detection provider, header connectivity indicator

**Success Criteria:**
1. App can be installed to home screen via manifest and launches in standalone display mode
2. App shows install prompt or Add to Home Screen guidance on first eligible visit
3. App shell (HTML, CSS, JS, fonts) loads from cache when device is offline
4. Header displays a visual indicator showing current online/offline connectivity state
5. Existing push notification subscription, delivery, and click handling continue to work after service worker expansion

**Completed:** 2026-01-30

### Phase 28: Offline Data Sync

**Goal**: Users can read recently viewed data and submit forms while offline, with automatic background sync, conflict resolution, and retry on reconnect.
**Depends on**: Phase 27
**Requirements**: OFFL-05, OFFL-06, OFFL-07, OFFL-08, OFFL-09, OFFL-10, OFFL-11
**Plans**: 5 plans

Plans:
- [x] 28-01-PLAN.md — Dexie IndexedDB setup, entity caching layer for offline reads
- [x] 28-02-PLAN.md — Sync queue, background sync on reconnect, sync status indicator
- [x] 28-03-PLAN.md — Conflict detection (LWW), offline photo queue, exponential backoff retry
- [x] 28-04-PLAN.md — Entity caching integration (wire cacheEntityOnView + offline fallback into detail pages)
- [x] 28-05-PLAN.md — Form + photo integration (wire useOfflineSubmit + useOfflinePhoto into task forms and photo upload)

**Success Criteria:**
1. Recently viewed entities (properties, units, work orders) are readable from IndexedDB when offline
2. Form submissions made offline are queued and sync automatically when connectivity returns
3. Sync status indicator shows pending operation count and last successful sync time
4. Conflicts are detected via updated_at timestamp comparison and resolved with last-write-wins; user is notified of overwritten changes
5. Photos captured offline are queued and uploaded on reconnect; failed syncs retry with exponential backoff

**Completed:** 2026-01-31

### Phase 29: Tenant Extras & UX Improvements

**Goal**: Tenants receive email and push notifications for ticket updates, KEWA can convert tickets to work orders, tenants can manage their profile, and the app has consistent loading/empty/error states with form validation and breadcrumb navigation.
**Depends on**: Phase 28
**Requirements**: TPRT-08, TPRT-11, TPRT-12, TPRT-13, UXPL-05, UXPL-06, UXPL-07, UXPL-08, UXPL-09, UXPL-10
**Plans**: 3 plans

Plans:
- [x] 29-01-PLAN.md — Tenant email notifications (status change, reply), push notification integration
- [x] 29-02-PLAN.md — Ticket-to-work-order conversion, tenant profile management
- [x] 29-03-PLAN.md — Loading states, empty states, error handling, confirmation dialogs, form validation, breadcrumbs

**Success Criteria:**
1. Tenant receives email notification when ticket status changes or KEWA replies to a message
2. Tenant receives push notification for ticket updates using existing push infrastructure
3. KEWA operator can convert a tenant ticket to an internal work order with one click
4. Tenant can update their profile (phone, email, emergency contact) from the portal
5. App displays skeleton loaders during data fetching, meaningful empty states with CTAs, user-friendly error messages with retry, confirmation dialogs before destructive actions, inline form validation errors, and breadcrumb navigation in deep hierarchies

**Completed:** 2026-02-03

---

## Milestone Summary

**Key Decisions:**

- Application-layer tenant isolation only (RLS is dead code) — simpler maintenance
- Manual service worker expansion (no Serwist) — Turbopack conflict avoidance
- Only 3 new packages: dexie@4.2.1, dexie-react-hooks@4.2.0, sonner@2.0.7
- Last-Write-Wins conflict resolution with server timestamp authority
- Network-first for API, cache-first for static assets
- Operator app offline features only — portal users assumed on home Wi-Fi

**Issues Resolved:**

- Invoice linking with modal UI (v2.2 UAT issue)
- Checklist item titles from template (v2.2 UAT issue)
- Property-level delivery history page (v2.2 UAT issue)
- Blocking alert() dialogs replaced with toast notifications

**Technical Debt Incurred:**

- useInstallPrompt timer cleanup missing in PWA hook (warning severity)
- Emergency contact schema extension needed for full profile management (info severity)
- Resend API key required for email notifications (environment setup)

---

*For current project status, see .planning/ROADMAP.md*
