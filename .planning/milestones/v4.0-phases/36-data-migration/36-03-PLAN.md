---
phase: 36-data-migration
plan: 03
type: execute
wave: 3
depends_on: [36-02]
files_modified:
  - supabase/migrations/082_not_null_constraints.sql
autonomous: true
requirements: [MIGR-03]

must_haves:
  truths:
    - "ALTER TABLE ... ALTER COLUMN organization_id SET NOT NULL succeeds on all 56 non-template tables"
    - "ALTER TABLE properties ALTER COLUMN mandate_id SET NOT NULL succeeds"
    - "ALTER TABLE properties ALTER COLUMN property_type SET NOT NULL succeeds"
    - "No NULL organization_id values exist in any of the 56 tables after migration"
    - "Template tables (templates, template_phases, template_packages, template_tasks, template_dependencies, template_quality_gates) are excluded — NULL organization_id allowed"
    - "tenancies table is excluded from ALTER (already NOT NULL from 074)"
  artifacts:
    - path: "supabase/migrations/082_not_null_constraints.sql"
      provides: "Verification DO block + NOT NULL constraints on 56 tables + properties.mandate_id + properties.property_type"
      contains: "SET NOT NULL"
  key_links:
    - from: "082_not_null_constraints.sql"
      to: "all 56 tenant tables"
      via: "ALTER TABLE ... ALTER COLUMN organization_id SET NOT NULL"
      pattern: "SET NOT NULL"
    - from: "082_not_null_constraints.sql"
      to: "properties table"
      via: "ALTER TABLE properties ALTER COLUMN mandate_id/property_type SET NOT NULL"
      pattern: "properties ALTER COLUMN mandate_id SET NOT NULL"
---

<objective>
Verify zero NULL organization_id values across all tenant tables, then apply NOT NULL constraints to lock down the multi-tenant data model.

Purpose: The final step of the Phase 36 migration chain. After seeding (080) and backfilling (081), this migration verifies completeness and promotes all nullable organization_id columns to NOT NULL. This ensures no future data can be inserted without an organization context, which is the prerequisite for RLS policies in Phase 37.

Output: One migration file (082) with a verification DO block followed by ALTER TABLE SET NOT NULL statements.
</objective>

<execution_context>
@C:/Users/Mario Giacchino/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Mario Giacchino/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/36-data-migration/36-CONTEXT.md
@.planning/phases/36-data-migration/36-RESEARCH.md
@.planning/phases/36-data-migration/36-02-SUMMARY.md
@supabase/migrations/075_org_id_columns.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create 082_not_null_constraints.sql — verification + NOT NULL on all org_id columns</name>
  <files>supabase/migrations/082_not_null_constraints.sql</files>
  <action>
Create migration file `082_not_null_constraints.sql` with these operations in order.

Add standard migration header:
```
-- KEWA v4.0: Multi-Tenant Data Migration
-- Migration: 082_not_null_constraints.sql
-- Applies: NOT NULL constraints on organization_id across 56 tables + properties.mandate_id + properties.property_type
-- Requirements: MIGR-03
-- Phase 36: Data Migration & Backfill
-- IMPORTANT: This migration will FAIL if any table has NULL organization_id rows.
-- Run 081_seed_properties.sql first to ensure complete backfill.
```

**SECTION 1: Verification DO block**

Use the exact pattern from RESEARCH.md. The DO block iterates over an array of 56 table names and checks `SELECT count(*) FROM {table} WHERE organization_id IS NULL`. If any table has non-zero count, RAISE EXCEPTION with table name and count.

The 56 tables to verify (all tables from 075 EXCEPT the 6 template tables and tenancies):
```
properties, buildings, units, rooms, components,
renovation_projects, projects, project_phases, project_packages,
project_quality_gates, tasks, task_photos, task_audio,
task_dependencies, work_orders, work_order_events, offers,
invoices, expenses, payments, partners, purchase_orders,
deliveries, inventory_movements, purchase_order_allocations,
approval_thresholds, change_orders, change_order_versions,
change_order_photos, change_order_approval_tokens, inspections,
inspection_defects, inspection_portal_tokens, inspection_templates,
media, audit_logs, comments, magic_link_tokens, storage_metadata,
kb_categories, kb_articles, kb_articles_history, kb_workflow_transitions,
kb_dashboard_shortcuts, kb_attachments, notifications, user_notifications,
push_subscriptions, notification_preferences, tickets, ticket_messages,
ticket_attachments, ticket_work_orders, condition_history, app_settings,
tenant_users
```

Also verify properties-specific columns:
```sql
SELECT count(*) INTO null_count FROM properties WHERE mandate_id IS NULL;
IF null_count > 0 THEN RAISE EXCEPTION ...; END IF;

SELECT count(*) INTO null_count FROM properties WHERE property_type IS NULL;
IF null_count > 0 THEN RAISE EXCEPTION ...; END IF;
```

**SECTION 2: Apply NOT NULL constraints**

After verification passes, apply ALTER TABLE for each of the 56 tables:

```sql
ALTER TABLE properties ALTER COLUMN organization_id SET NOT NULL;
ALTER TABLE properties ALTER COLUMN mandate_id SET NOT NULL;
ALTER TABLE properties ALTER COLUMN property_type SET NOT NULL;
ALTER TABLE buildings ALTER COLUMN organization_id SET NOT NULL;
ALTER TABLE units ALTER COLUMN organization_id SET NOT NULL;
ALTER TABLE rooms ALTER COLUMN organization_id SET NOT NULL;
ALTER TABLE components ALTER COLUMN organization_id SET NOT NULL;
-- ... continue for all 56 tables
```

Write out every single ALTER TABLE statement explicitly — do NOT use dynamic SQL for the ALTER statements themselves (DDL should be visible and auditable).

**Excluded tables (do NOT apply NOT NULL):**
- `templates` — NULL = system template
- `template_phases` — NULL = system template
- `template_packages` — NULL = system template
- `template_tasks` — NULL = system template
- `template_dependencies` — NULL = system template
- `template_quality_gates` — NULL = system template
- `tenancies` — already NOT NULL from 074

Add a final comment:
```sql
-- Phase 36 complete: All organization_id columns are NOT NULL.
-- 6 template tables intentionally excluded (NULL = system template).
-- tenancies excluded (already NOT NULL from 074).
-- Next: Phase 37 (RLS policies on all tenant tables).
```
  </action>
  <verify>
Run `npx supabase db reset` and verify:
```sql
-- Verify NOT NULL is enforced by attempting a NULL insert (should fail)
INSERT INTO properties (name, organization_id) VALUES ('test', NULL);
-- Expected: ERROR: null value in column "organization_id" violates not-null constraint

-- Verify template tables still allow NULL
INSERT INTO templates (name, description, organization_id)
VALUES ('System Template', 'Test', NULL);
-- Expected: SUCCESS (NULL allowed)

-- Count of NOT NULL constraints applied
SELECT table_name, column_name, is_nullable
FROM information_schema.columns
WHERE column_name = 'organization_id'
  AND table_schema = 'public'
ORDER BY table_name;
-- Expected: 56 tables show 'NO' for is_nullable, 6 template tables show 'YES'
```
  </verify>
  <done>All 56 non-template tables have NOT NULL on organization_id. properties.mandate_id and properties.property_type are NOT NULL. Template tables retain nullable organization_id. The migration fails loudly if any NULL values remain (verification DO block). Phase 36 data model is sealed — no data can exist without an organization context.</done>
</task>

</tasks>

<verification>
```sql
-- Final phase-level verification
-- 1. NOT NULL enforcement
SELECT table_name, is_nullable
FROM information_schema.columns
WHERE column_name = 'organization_id'
  AND table_schema = 'public'
  AND table_name NOT IN ('templates', 'template_phases', 'template_packages',
                          'template_tasks', 'template_dependencies', 'template_quality_gates',
                          'organizations', 'organization_members', 'owners', 'mandates', 'tenancies')
ORDER BY table_name;
-- ALL should show 'NO'

-- 2. Properties additional NOT NULL
SELECT is_nullable FROM information_schema.columns
WHERE table_name = 'properties' AND column_name IN ('mandate_id', 'property_type')
AND table_schema = 'public';
-- Both should show 'NO'

-- 3. Phase 36 success criteria check
SELECT 'organizations' as check, count(*)::text as result FROM organizations
UNION ALL
SELECT 'owners', count(*)::text FROM owners
UNION ALL
SELECT 'mandates', count(*)::text FROM mandates
UNION ALL
SELECT 'properties', count(*)::text FROM properties
UNION ALL
SELECT 'org_members', count(*)::text FROM organization_members
UNION ALL
SELECT 'hauswart_perms', count(*)::text FROM role_permissions WHERE role_id = (SELECT id FROM roles WHERE name = 'hauswart');
-- Expected: 2, 4, 4, 7, 17, 13
```
</verification>

<success_criteria>
- 082_not_null_constraints.sql applies cleanly on `supabase db reset`
- All 56 non-template tables have NOT NULL on organization_id
- properties.mandate_id and properties.property_type are NOT NULL
- Template tables (6) retain nullable organization_id
- Verification DO block would fail loudly if any NULL values remained
- All 4 phase migration files (079-082) run cleanly in sequence
</success_criteria>

<output>
After completion, create `.planning/phases/36-data-migration/36-03-SUMMARY.md`
</output>
