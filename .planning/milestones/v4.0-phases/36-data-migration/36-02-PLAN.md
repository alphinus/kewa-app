---
phase: 36-data-migration
plan: 02
type: execute
wave: 2
depends_on: [36-01]
files_modified:
  - supabase/migrations/081_seed_properties.sql
autonomous: true
requirements: [MIGR-02]

must_haves:
  truths:
    - "Leweg 4 Buelach exists as property with 1 building, 10 units (3+3+3+1), organization_id = KEWA AG"
    - "Limmatstrasse 42 Zuerich, Wohnanlage Seefeld Zuerich, MFH Oerlikon Zuerich exist as new properties under KEWA AG"
    - "Neubau Zuerich West exists with property_type='stwe' and STWE Pensionskasse ZH mandate"
    - "Bundesplatz 8 Bern and Siedlung Wabern exist as properties under GIMBA AG"
    - "Existing 'Liegenschaft KEWA' property is assigned to Wohnanlage Seefeld mandate with organization_id = KEWA AG"
    - "All 7 properties have mandate_id and property_type set"
    - "SELECT count(*) FROM {table} WHERE organization_id IS NULL returns 0 for all 56 backfilled tables"
    - "Tenant user assignments: Mueller → Leweg 4 unit, Schmidt → Limmatstrasse unit, Weber → Seefeld unit"
  artifacts:
    - path: "supabase/migrations/081_seed_properties.sql"
      provides: "New property/building/unit hierarchy for 6 new properties, Leweg 4 full 10-unit detail, existing data backfill, tenant unit assignments"
      contains: "Leweg 4"
  key_links:
    - from: "081_seed_properties.sql"
      to: "properties table"
      via: "INSERT new + UPDATE existing with organization_id and mandate_id"
      pattern: "00000000-0000-0000-0013"
    - from: "081_seed_properties.sql"
      to: "all 56 tenant tables"
      via: "flat UPDATE SET organization_id WHERE organization_id IS NULL"
      pattern: "WHERE organization_id IS NULL"
    - from: "081_seed_properties.sql"
      to: "tenant_users table"
      via: "UPDATE unit_id assignments for Mueller, Schmidt, Weber"
      pattern: "tenant_users"
---

<objective>
Seed all property/building/unit hierarchies for both organizations and backfill organization_id across all existing data rows.

Purpose: After plan 01 seeded the master data (orgs, owners, mandates, users), this plan creates the complete property hierarchy for the multi-tenant showcase and ensures every existing row in every tenant table has organization_id = KEWA AG UUID. This is the prerequisite for the NOT NULL constraint application in plan 03.

Output: One migration file (081) that seeds 6 new properties with buildings/units, backfills the 2 existing properties, and flat-updates all 56 non-template tables.
</objective>

<execution_context>
@C:/Users/Mario Giacchino/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Mario Giacchino/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/36-data-migration/36-CONTEXT.md
@.planning/phases/36-data-migration/36-RESEARCH.md
@.planning/phases/36-data-migration/36-01-SUMMARY.md
@supabase/migrations/075_org_id_columns.sql
@supabase/migrations/008_property_building.sql
@supabase/migrations/047_seed_complete_workflow.sql
@supabase/migrations/001_initial_schema.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create 081_seed_properties.sql — property/building/unit hierarchy + backfill</name>
  <files>supabase/migrations/081_seed_properties.sql</files>
  <action>
Create migration file `081_seed_properties.sql` with these operations in order.

Add standard migration header:
```
-- KEWA v4.0: Multi-Tenant Data Migration
-- Migration: 081_seed_properties.sql
-- Creates: New property/building/unit hierarchies, backfills organization_id on all existing data
-- Requirements: MIGR-02
-- Phase 36: Data Migration & Backfill
```

**UUID Namespace (from RESEARCH.md):**
- `0013` = Properties (new)
- `0014` = Buildings (new)
- `0015` = Units (new Leweg 4)
- `0016` = Units (new other properties)

**SECTION 1: Backfill existing properties FIRST**

Two existing properties need org_id, mandate_id, property_type:

1. **"Neubau Zuerich West"** (known UUID `00000000-0000-0000-0002-000000000001` from 047):
```sql
UPDATE properties SET
  organization_id = '00000000-0000-0000-0010-000000000001',
  mandate_id = '00000000-0000-0000-0012-000000000003',  -- STWE Pensionskasse ZH
  property_type = 'stwe'
WHERE id = '00000000-0000-0000-0002-000000000001'
  AND organization_id IS NULL;
```

2. **"Liegenschaft KEWA"** (auto-UUID, lookup by name): Assign to Wohnanlage Seefeld property context. This existing building+units structure represents the Seefeld complex. Update the property name to "Wohnanlage Seefeld" and assign to Eigenverwaltung KEWA mandate:
```sql
UPDATE properties SET
  name = 'Wohnanlage Seefeld',
  address = 'Seefeldstrasse 120, 8008 Zuerich',
  organization_id = '00000000-0000-0000-0010-000000000001',
  mandate_id = '00000000-0000-0000-0012-000000000001',  -- Eigenverwaltung KEWA
  property_type = 'rental'
WHERE name = 'Liegenschaft KEWA'
  AND organization_id IS NULL;
```

**SECTION 2: New KEWA AG properties**

Insert new properties with buildings. For Leweg 4 create full 10-unit detail. For other new properties create property + 1 building + a few representative units.

**Property 1: Leweg 4, 8180 Buelach (D4 — detailed)**
- Property: id `00000000-0000-0000-0013-000000000001`, name "Leweg 4", address "Leweg 4, 8180 Buelach", org KEWA AG, mandate Eigenverwaltung KEWA, property_type "rental"
- Building: id `00000000-0000-0000-0014-000000000001`, name "Leweg 4", property_id = property above, org KEWA AG
- 10 Units (namespace `0015`):

| Unit UUID suffix | floor | unit_number | unit_type | name |
|---|---|---|---|---|
| `...0015-...001` | 0 | EG-01 | apartment | 2.5-Zimmer-Wohnung EG links |
| `...0015-...002` | 0 | EG-02 | apartment | 3.5-Zimmer-Wohnung EG mitte |
| `...0015-...003` | 0 | EG-03 | apartment | 4.5-Zimmer-Wohnung EG rechts |
| `...0015-...004` | 1 | OG1-01 | apartment | 2.5-Zimmer-Wohnung 1. OG links |
| `...0015-...005` | 1 | OG1-02 | apartment | 3.5-Zimmer-Wohnung 1. OG mitte |
| `...0015-...006` | 1 | OG1-03 | apartment | 4.5-Zimmer-Wohnung 1. OG rechts |
| `...0015-...007` | 2 | OG2-01 | apartment | 2.5-Zimmer-Wohnung 2. OG links |
| `...0015-...008` | 2 | OG2-02 | apartment | 3.5-Zimmer-Wohnung 2. OG mitte |
| `...0015-...009` | 2 | OG2-03 | apartment | 4.5-Zimmer-Wohnung 2. OG rechts |
| `...0015-...010` | 3 | DG-01 | apartment | Dachwohnung |

All units: building_id = Leweg 4 building, organization_id = KEWA AG. Use `ON CONFLICT (id) DO NOTHING`.

Check the units table schema in 001_initial_schema.sql for exact column names. The units table has: id, building_id, unit_number, floor, name, unit_type (CHECK includes apartment, commercial, parking, garage, storage from 078).

**Property 2: Limmatstrasse 42, 8005 Zuerich**
- Property: id `00000000-0000-0000-0013-000000000002`, name "Limmatstrasse 42", address "Limmatstrasse 42, 8005 Zuerich", org KEWA AG, mandate Eigenverwaltung KEWA, property_type "rental"
- Building: id `00000000-0000-0000-0014-000000000002`, name "Limmatstrasse 42", org KEWA AG
- 4 representative units (namespace `0016-...001` through `004`): apartment types on floors 0-3

**Property 3: MFH Oerlikon, 8050 Zuerich**
- Property: id `00000000-0000-0000-0013-000000000003`, name "MFH Oerlikon", address "Schwamendingenstrasse 28, 8050 Zuerich", org KEWA AG, mandate Mandat Brunner, property_type "rental"
- Building: id `00000000-0000-0000-0014-000000000003`, name "MFH Oerlikon", org KEWA AG
- 6 representative units (`0016-...005` through `010`): apartment types on floors 0-2

**SECTION 3: New GIMBA AG properties**

**Property 4: Bundesplatz 8, 3011 Bern**
- Property: id `00000000-0000-0000-0013-000000000004`, name "Bundesplatz 8", address "Bundesplatz 8, 3011 Bern", org GIMBA AG, mandate Verwaltung Graber, property_type "rental"
- Building: id `00000000-0000-0000-0014-000000000004`, name "Bundesplatz 8", org GIMBA AG
- 4 representative units (`0016-...011` through `014`)

**Property 5: Siedlung Wabern, 3084 Wabern**
- Property: id `00000000-0000-0000-0013-000000000005`, name "Siedlung Wabern", address "Eichholzstrasse 12, 3084 Wabern", org GIMBA AG, mandate Verwaltung Graber, property_type "rental"
- Building: id `00000000-0000-0000-0014-000000000005`, name "Siedlung Wabern", org GIMBA AG
- 4 representative units (`0016-...015` through `018`)

All new properties, buildings, and units use `ON CONFLICT (id) DO NOTHING`.

**SECTION 4: Flat backfill of all existing data (D6)**

Use a DO block with a KEWA AG UUID variable. Update ALL tables that received organization_id in 075 migration, EXCEPT the 6 template tables (templates, template_phases, template_packages, template_tasks, template_dependencies, template_quality_gates — NULL = system template).

The backfill covers 56 tables. Use the exact list from RESEARCH.md code example (the `DO $$ ... END $$` block with all UPDATE statements). Include `WHERE organization_id IS NULL` on every UPDATE for idempotency.

The full list of 56 tables to backfill:
properties, buildings, units, rooms, components, renovation_projects, projects, project_phases, project_packages, project_quality_gates, tasks, task_photos, task_audio, task_dependencies, work_orders, work_order_events, offers, invoices, expenses, payments, partners, purchase_orders, deliveries, inventory_movements, purchase_order_allocations, approval_thresholds, change_orders, change_order_versions, change_order_photos, change_order_approval_tokens, inspections, inspection_defects, inspection_portal_tokens, inspection_templates, media, audit_logs, comments, magic_link_tokens, storage_metadata, kb_categories, kb_articles, kb_articles_history, kb_workflow_transitions, kb_dashboard_shortcuts, kb_attachments, notifications, user_notifications, push_subscriptions, notification_preferences, tickets, ticket_messages, ticket_attachments, ticket_work_orders, condition_history, app_settings, tenant_users.

Note: properties were already handled in Section 1 with specific mandate_id assignments. The DO block UPDATE for properties will be a no-op since they already have organization_id set.

**SECTION 5: Tenant user unit assignments (D5)**

Update tenant_users to assign tenants to specific units per D5:
- Hans Mueller (lookup by email `mueller@example.com`) → unit in Leweg 4 (e.g., `00000000-0000-0000-0015-000000000002`, 3.5zi EG)
- Anna Schmidt (lookup by email `schmidt@example.com`) → unit in Limmatstrasse 42 (e.g., `00000000-0000-0000-0016-000000000001`)
- Peter Weber (lookup by email `weber@example.com`) → unit in Wohnanlage Seefeld (lookup existing unit in the renamed "Wohnanlage Seefeld" property by building_id = `00000000-0000-0000-0001-000000000001` LIMIT 1)
- Markus Huber (`00000000-0000-0000-0020-000000000007`) → unit in Bundesplatz 8 (e.g., `00000000-0000-0000-0016-000000000011`)

Also INSERT new tenant_users rows for new tenant users if they don't exist from 063:
```sql
INSERT INTO tenant_users (user_id, unit_id, organization_id)
VALUES (
  '00000000-0000-0000-0020-000000000007',
  '00000000-0000-0000-0016-000000000011',
  '00000000-0000-0000-0010-000000000002'
) ON CONFLICT DO NOTHING;
```

For existing tenant_users (Mueller, Schmidt, Weber), UPDATE the unit_id to the specific assignment.

**SECTION 6: Tenancy records**

Insert tenancy records for each tenant-unit relationship to establish the lease chain (tenancies table from 074):
- Hans Mueller → Leweg 4 unit, KEWA AG org, contract_type 'unlimited', base_rent 1450.00, ancillary_costs 220.00
- Anna Schmidt → Limmatstrasse unit, KEWA AG org, contract_type 'unlimited', base_rent 1680.00, ancillary_costs 280.00
- Peter Weber → Seefeld unit, KEWA AG org, contract_type 'unlimited', base_rent 1950.00, ancillary_costs 320.00
- Markus Huber → Bundesplatz unit, GIMBA AG org, contract_type 'unlimited', base_rent 1550.00, ancillary_costs 250.00

All tenancies: start_date = '2024-01-01', end_date = NULL, notice_period_months = 3, deposit_amount = 3x base_rent, reference_interest_rate = 1.50.

Use `ON CONFLICT DO NOTHING` with a unique check appropriate for the tenancies table.
  </action>
  <verify>
Run `npx supabase db reset` and verify:
```sql
-- Property count
SELECT count(*) FROM properties;
-- Expected: 7 (5 KEWA + 2 GIMBA)

-- Leweg 4 units
SELECT u.unit_number, u.name, u.floor
FROM units u
JOIN buildings b ON b.id = u.building_id
WHERE b.name = 'Leweg 4'
ORDER BY u.floor, u.unit_number;
-- Expected: 10 units

-- Zero NULL organization_id across all 56 tables
DO $$
DECLARE
  tables TEXT[] := ARRAY[
    'properties', 'buildings', 'units', 'rooms', 'components',
    'renovation_projects', 'projects', 'project_phases', 'project_packages',
    'project_quality_gates', 'tasks', 'task_photos', 'task_audio',
    'task_dependencies', 'work_orders', 'work_order_events', 'offers',
    'invoices', 'expenses', 'payments', 'partners', 'purchase_orders',
    'deliveries', 'inventory_movements', 'purchase_order_allocations',
    'approval_thresholds', 'change_orders', 'change_order_versions',
    'change_order_photos', 'change_order_approval_tokens', 'inspections',
    'inspection_defects', 'inspection_portal_tokens', 'inspection_templates',
    'media', 'audit_logs', 'comments', 'magic_link_tokens', 'storage_metadata',
    'kb_categories', 'kb_articles', 'kb_articles_history', 'kb_workflow_transitions',
    'kb_dashboard_shortcuts', 'kb_attachments', 'notifications', 'user_notifications',
    'push_subscriptions', 'notification_preferences', 'tickets', 'ticket_messages',
    'ticket_attachments', 'ticket_work_orders', 'condition_history', 'app_settings',
    'tenant_users'
  ];
  tbl TEXT;
  null_count BIGINT;
BEGIN
  FOREACH tbl IN ARRAY tables LOOP
    EXECUTE format('SELECT count(*) FROM %I WHERE organization_id IS NULL', tbl) INTO null_count;
    IF null_count > 0 THEN
      RAISE EXCEPTION 'FAIL: % has % NULL organization_id rows', tbl, null_count;
    END IF;
  END LOOP;
  RAISE NOTICE 'ALL 56 TABLES VERIFIED: zero NULL organization_id values';
END $$;

-- Verify tenancies
SELECT count(*) FROM tenancies; -- Expected: at least 4

-- Verify property-mandate mapping
SELECT p.name, m.name as mandate, p.property_type
FROM properties p JOIN mandates m ON m.id = p.mandate_id
ORDER BY p.name;
-- Expected: correct mandate assignments per D3/D4
```
  </verify>
  <done>7 properties exist across 2 organizations. Leweg 4 has 10 units in correct floor/room layout. All existing data backfilled to KEWA AG. Zero NULL organization_id values across all 56 non-template tables. Tenant unit assignments match D5. Tenancy records exist for all tenant-unit relationships.</done>
</task>

</tasks>

<verification>
```sql
-- Cross-check property distribution
SELECT org.name, count(*) as properties
FROM properties p
JOIN organizations org ON org.id = p.organization_id
GROUP BY org.name;
-- Expected: KeWa AG = 5, GIMBA AG = 2

-- Cross-check mandate chain
SELECT org.name, o.name as owner, m.name as mandate, p.name as property
FROM properties p
JOIN mandates m ON m.id = p.mandate_id
JOIN owners o ON o.id = m.owner_id
JOIN organizations org ON org.id = p.organization_id
ORDER BY org.name, m.name;
-- Expected: Full hierarchy chain matches D3/D4

-- Template tables should still have NULL org_ids (system templates)
SELECT count(*) FROM templates WHERE organization_id IS NULL;
-- Expected: > 0 (system templates preserved)
```
</verification>

<success_criteria>
- 081_seed_properties.sql applies cleanly on `supabase db reset`
- 7 properties (5 KEWA, 2 GIMBA) with correct mandate and property_type
- Leweg 4: 1 building, 10 units matching D4 layout (3+3+3+1)
- Zero NULL organization_id across all 56 non-template tenant tables
- Template tables retain NULL organization_id (system templates untouched)
- Existing "Liegenschaft KEWA" renamed to "Wohnanlage Seefeld" and assigned to Eigenverwaltung KEWA
- Tenancy records link tenants to units with Swiss rental law fields
- Migration is idempotent
</success_criteria>

<output>
After completion, create `.planning/phases/36-data-migration/36-02-SUMMARY.md`
</output>
