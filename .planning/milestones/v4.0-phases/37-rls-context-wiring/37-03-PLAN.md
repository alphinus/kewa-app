---
phase: 37-rls-context-wiring
plan: 03
type: execute
wave: 2
depends_on:
  - 37-02
files_modified:
  - src/app/api/**/*.ts
  - src/app/api/**/*.tsx
autonomous: true
requirements:
  - RLS-04
must_haves:
  truths:
    - "All ~98 tenant API route files import createOrgClient from @/lib/supabase/with-org instead of createClient from @/lib/supabase/server"
    - "All ~10 truly public route files (auth, portal auth, settings) import createPublicClient from @/lib/supabase/with-org"
    - "All ~15 portal/contractor route files that query tenant tables import createServiceClient from @/lib/supabase/with-org"
    - "Every route handler using createOrgClient wraps it in try/catch returning 401 on OrgContextMissingError"
    - "Zero API route files import createClient from @/lib/supabase/server"
  artifacts:
    - path: "src/app/api/**/route.ts"
      provides: "Org-scoped API routes"
      contains: "createOrgClient"
  key_links:
    - from: "src/app/api/**/route.ts (tenant routes)"
      to: "src/lib/supabase/with-org.ts"
      via: "import { createOrgClient }"
      pattern: "createOrgClient"
    - from: "src/app/api/**/route.ts (public routes)"
      to: "src/lib/supabase/with-org.ts"
      via: "import { createPublicClient }"
      pattern: "createPublicClient"
    - from: "src/app/api/portal/**/route.ts + src/app/api/contractor/**/route.ts (tenant-table-querying)"
      to: "src/lib/supabase/with-org.ts"
      via: "import { createServiceClient }"
      pattern: "createServiceClient"
---

<objective>
Migrate all 123 API route files from `createClient` (from `@/lib/supabase/server`) to the appropriate org-aware client (`createOrgClient`, `createPublicClient`, or `createServiceClient` from `@/lib/supabase/with-org`).

Purpose: Every tenant API query flows through createOrgClient, ensuring RLS context is set before any database operation.
Output: All 123 API route files updated.
</objective>

<execution_context>
@C:/Users/Mario Giacchino/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Mario Giacchino/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/37-rls-context-wiring/37-RESEARCH.md
@.planning/phases/37-rls-context-wiring/37-02-SUMMARY.md
@src/lib/supabase/with-org.ts
@src/app/api/buildings/route.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Migrate ~98 tenant API routes to createOrgClient</name>
  <files>src/app/api/**/route.ts, src/app/api/**/route.tsx</files>
  <action>
For each tenant API route file (list below), apply these mechanical transformations:

**Import change:**
```
// OLD:
import { createClient } from '@/lib/supabase/server'

// NEW:
import { createOrgClient } from '@/lib/supabase/with-org'
```

**Client instantiation change — in each handler function (GET, POST, PUT, PATCH, DELETE):**
```
// OLD:
const supabase = await createClient()

// NEW:
const supabase = await createOrgClient(request)
```

**Add error handling if not already in a try/catch:**
Every handler that uses createOrgClient MUST be inside a try/catch. Most handlers already have try/catch blocks. The `createOrgClient` call should be the first line inside the try block. If the function lacks try/catch, wrap the entire body.

**`request` parameter:** Most route handlers already accept `request: NextRequest`. Verify each handler has the `request` parameter. For handlers that don't use `request` yet (rare — some GET handlers may destructure differently), add `request: NextRequest` as the first parameter.

**Tenant route files (~98 files):**
All files in `src/app/api/` that are NOT in the public list below. Key directories:
- `src/app/api/buildings/**`
- `src/app/api/properties/**`
- `src/app/api/units/**`
- `src/app/api/rooms/**`
- `src/app/api/tasks/**`
- `src/app/api/projects/**`
- `src/app/api/renovation-projects/**`
- `src/app/api/work-orders/**`
- `src/app/api/expenses/**`
- `src/app/api/invoices/**`
- `src/app/api/payments/**`
- `src/app/api/partners/**`
- `src/app/api/purchase-orders/**`
- `src/app/api/deliveries/**`
- `src/app/api/inventory-movements/**`
- `src/app/api/suppliers/**`
- `src/app/api/change-orders/**`
- `src/app/api/inspections/**`
- `src/app/api/inspection-templates/**`
- `src/app/api/templates/**`
- `src/app/api/knowledge/**` (includes `knowledge/categories/` — queries `kb_categories` and `kb_articles`, both in 56-table RLS list)
- `src/app/api/comments/**`
- `src/app/api/photos/**`
- `src/app/api/audio/**`
- `src/app/api/notifications/**`
- `src/app/api/costs/**`
- `src/app/api/reports/**`
- `src/app/api/admin/tickets/**`
- `src/app/api/reorder-alerts/**`

Verify by running: `grep -rl "from '@/lib/supabase/server'" src/app/api/` — the only remaining files should be the public routes (see Task 2).
  </action>
  <verify>
`grep -rl "createClient.*from.*supabase/server" src/app/api/` returns ONLY the public/portal/contractor/auth route files (Task 2 list) — no tenant routes remain on old import.
`grep -rl "createOrgClient" src/app/api/` returns ~98 files.
  </verify>
  <done>All tenant API routes use createOrgClient(request) with proper try/catch error handling</done>
</task>

<task type="auto">
  <name>Task 2: Migrate public routes to createPublicClient and portal/contractor tenant-querying routes to createServiceClient</name>
  <files>src/app/api/auth/**/route.ts, src/app/api/portal/**/route.ts, src/app/api/contractor/**/route.ts, src/app/api/settings/categories/**/route.ts</files>
  <action>
Routes without org session context fall into TWO categories:

**Category A — createPublicClient (~10 files):** Routes that query ONLY global tables (users, roles, permissions, ticket_categories) or no DB at all. These tables are NOT in the 56-table RLS list. createPublicClient (anon key, no org context) works.

**Category B — createServiceClient (~15 files):** Portal and contractor routes that query TENANT tables (work_orders, partners, media, inspections, inspection_defects, change_orders, change_order_approval_tokens, magic_link_tokens, tickets, ticket_attachments, units, buildings, tenant_users, audit_logs — all in the 56-table RLS list). These routes have NO org session context (token-gated or portal-session-gated), so they CANNOT use createOrgClient. They MUST use createServiceClient (service_role key bypasses RLS). Token/session validation in these routes already provides application-layer access control.

---

**Category A — createPublicClient import and instantiation:**
```
import { createPublicClient } from '@/lib/supabase/with-org'
const supabase = await createPublicClient()
```

**Category A files:**

Auth routes (query global users/roles tables only):
- `src/app/api/auth/login/route.ts`
- `src/app/api/auth/register/route.ts`
- `src/app/api/auth/magic-link/send/route.ts`
- `src/app/api/auth/magic-link/verify/route.ts`

Portal auth routes (query global tables or no DB):
- `src/app/api/portal/auth/login/route.ts`
- `src/app/api/portal/auth/register/[token]/route.ts`
- `src/app/api/portal/auth/verify-invite/[token]/route.ts`
- `src/app/api/portal/auth/qr-login/route.ts`

Settings (global lookup tables, ticket_categories not in RLS list):
- `src/app/api/settings/categories/route.ts`
- `src/app/api/settings/categories/[id]/route.ts`

---

**Category B — createServiceClient import and instantiation:**
```
import { createServiceClient } from '@/lib/supabase/with-org'
const supabase = createServiceClient()
```

Note: createServiceClient is synchronous (no cookies, no RPC), returns client directly.

**Category B files — Portal routes querying tenant tables:**
- `src/app/api/portal/dashboard/route.ts` — queries `units`, `buildings` (+ delegates to lib files querying `tickets`, `ticket_messages`, `app_settings`, `tenant_users`)
- `src/app/api/portal/profile/route.ts` — queries `users` joined to `tenant_users`, `units`, `buildings`
- `src/app/api/portal/tickets/[id]/attachments/route.ts` — queries/inserts `ticket_attachments`
- `src/app/api/portal/inspections/[token]/route.ts` — queries `inspections`, `inspection_defects`, `work_orders`, `renovation_projects`
- `src/app/api/portal/inspections/[token]/acknowledge/route.ts` — updates `inspections`
- `src/app/api/portal/change-orders/[token]/route.ts` — queries `magic_link_tokens`, `change_order_approval_tokens`, `change_orders`, `work_orders`
- `src/app/api/portal/change-orders/[token]/approve/route.ts` — queries/updates `magic_link_tokens`, `change_order_approval_tokens`, `change_orders`; calls `create_audit_log` RPC
- `src/app/api/portal/change-orders/[token]/reject/route.ts` — queries/updates `magic_link_tokens`, `change_order_approval_tokens`, `change_orders`; calls `create_audit_log` RPC

**Category B files — Contractor routes querying tenant tables:**
- `src/app/api/contractor/request-link/route.ts` — inserts into `audit_log`
- `src/app/api/contractor/[token]/status/route.ts` — queries/updates `work_orders`, `partners`
- `src/app/api/contractor/[token]/mark-viewed/route.ts` — updates `work_orders`
- `src/app/api/contractor/[token]/[workOrderId]/respond/route.ts` — queries/updates `work_orders`, `partners`
- `src/app/api/contractor/[token]/[workOrderId]/upload/route.ts` — queries `work_orders`, `partners`; inserts `media`
- `src/app/api/contractor/[token]/[workOrderId]/media/route.ts` — queries `work_orders`, `partners`, `media`

**IMPORTANT:** Portal routes that do NOT directly call createClient and delegate entirely to lib files (e.g., `portal/tickets/route.ts`, `portal/tickets/[id]/route.ts`, `portal/tickets/[id]/messages/route.ts`, `portal/tickets/[id]/messages/read/route.ts`, `portal/tickets/[id]/cancel/route.ts`, `portal/categories/route.ts`) do NOT need changes in this task — their lib file dependencies are handled in Plan 37-04 Task 1. Only routes that directly instantiate `createClient()` in their own handler code need migration here.

**IMPORTANT:** Portal auth routes that do NOT import createClient at all (e.g., `portal/auth/logout/route.ts`, `portal/auth/session/route.ts`, `portal/auth/qr-token/route.ts`) need no changes — they already have no Supabase import.

After this task, `grep -rl "from '@/lib/supabase/server'" src/app/api/` should return ZERO results.
  </action>
  <verify>
`grep -rl "from '@/lib/supabase/server'" src/app/api/` returns ZERO files.
`grep -rl "createPublicClient" src/app/api/` returns ~10 files (auth + portal auth + settings).
`grep -rl "createServiceClient" src/app/api/` returns ~14 files (portal + contractor routes querying tenant tables).
No `createOrgClient` import in any auth/portal/contractor/settings route.
  </verify>
  <done>All truly-public routes use createPublicClient(), all portal/contractor routes querying tenant tables use createServiceClient(), zero files import from @/lib/supabase/server in src/app/api/</done>
</task>

</tasks>

<verification>
- `grep -rl "from '@/lib/supabase/server'" src/app/api/` returns 0 files
- `grep -rl "createOrgClient" src/app/api/` returns ~98 files
- `grep -rl "createPublicClient" src/app/api/` returns ~10 files
- `grep -rl "createServiceClient" src/app/api/` returns ~14 files
- Total: ~122 files migrated (some portal routes delegate entirely to lib files and have no direct supabase import)
- No file imports both createOrgClient and createPublicClient
- Portal/contractor routes that query tenant tables use createServiceClient (NOT createPublicClient)
- TypeScript compilation passes
</verification>

<success_criteria>
All API route files migrated from createClient to the appropriate client: createOrgClient for tenant routes, createPublicClient for truly public routes, createServiceClient for portal/contractor routes that query RLS-protected tenant tables. Zero remaining imports of createClient from @/lib/supabase/server in API routes.
</success_criteria>

<output>
After completion, create `.planning/phases/37-rls-context-wiring/37-03-SUMMARY.md`
</output>
