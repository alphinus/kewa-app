---
phase: 37-rls-context-wiring
plan: 04
type: execute
wave: 2
depends_on:
  - 37-02
files_modified:
  - src/lib/supabase/cached-queries.ts
  - src/lib/**/*.ts
  - src/app/dashboard/**/*.tsx
  - src/app/contractor/**/*.tsx
  - src/app/portal/**/*.tsx
  - src/app/admin/**/*.tsx
autonomous: true
requirements:
  - RLS-04
must_haves:
  truths:
    - "All 45 non-API files that import createClient from @/lib/supabase/server are migrated to the appropriate with-org client"
    - "cached-queries.ts uses createPublicClient — KNOWN REGRESSION: returns empty data for tenant tables after RLS enablement until Phase 38 threads org context through server components"
    - "Dashboard server components and lib utilities called from org-scoped API routes use createPublicClient (org context inherited from route-level RPC)"
    - "Portal/contractor lib files that query tenant tables use createServiceClient (service_role bypasses RLS; these callers have no org session)"
    - "Zero non-API files import createClient from @/lib/supabase/server"
  artifacts:
    - path: "src/lib/supabase/cached-queries.ts"
      provides: "Cached query wrappers using createPublicClient (regression-aware)"
      contains: "createPublicClient"
  key_links:
    - from: "src/lib/**/*.ts (tenant-context lib files)"
      to: "src/lib/supabase/with-org.ts"
      via: "import { createPublicClient }"
      pattern: "from '@/lib/supabase/with-org'"
    - from: "src/lib/portal/*.ts, src/lib/inspections/portal-tokens.ts, src/lib/contractor/queries.ts, src/lib/magic-link.ts"
      to: "src/lib/supabase/with-org.ts"
      via: "import { createServiceClient }"
      pattern: "createServiceClient"
---

<objective>
Migrate all 45 non-API files (lib utilities, server components, cached queries) from `createClient` (from `@/lib/supabase/server`) to the appropriate client from `with-org.ts`.

Purpose: Complete the migration so no file in the codebase uses the old createClient for data queries. Three client types are used:
- **createPublicClient** — lib files called from org-scoped API routes (inherit org context from route-level RPC), server components (Phase 38 concern), and cached queries
- **createServiceClient** — portal/contractor lib files that query tenant tables without org session (service_role bypasses RLS)

**KNOWN REGRESSION (accepted):** `cached-queries.ts` (getCachedUnitsWithRooms, getCachedUnitConditionSummary, getCachedActiveProjectCount) uses createPublicClient and will return empty results for tenant tables after RLS enablement. These functions are called from dashboard server components which have no request object and cannot set org context. This is explicitly deferred to Phase 38 (OrganizationProvider threads org context through React server components). SC5 ("Existing application functionality works identically for KEWA AG users") is scoped to API-route-driven views; server-component-only views regress until Phase 38.

Output: 45 files updated, zero remaining imports of createClient from server.ts outside of with-org.ts itself.
</objective>

<execution_context>
@C:/Users/Mario Giacchino/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Mario Giacchino/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/37-rls-context-wiring/37-RESEARCH.md
@.planning/phases/37-rls-context-wiring/37-02-SUMMARY.md
@src/lib/supabase/cached-queries.ts
@src/lib/supabase/with-org.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Migrate lib utility files to appropriate client</name>
  <files>src/lib/**/*.ts</files>
  <action>
Migrate all lib files that import from `@/lib/supabase/server`. Apply the appropriate client based on CALLER context:

**Group A — createPublicClient: Lib files called from org-scoped API routes**
These lib files are called by API routes which already set org context via createOrgClient. Each request gets a fresh Supabase client via cookies(), and the route has already called `set_org_context` RPC on that client's connection. When a lib file creates its own client via createPublicClient (same cookie-based approach), it gets the same authenticated connection where org context was set. The Postgres session variable persists for the connection's transaction scope.

```
import { createPublicClient } from '@/lib/supabase/with-org'
const supabase = await createPublicClient()
```

**Group A files (~22 files):**
- `src/lib/audit.ts`
- `src/lib/admin/ticket-to-work-order.ts`
- `src/lib/comments/comment-queries.ts`
- `src/lib/costs/invoice-queries.ts`
- `src/lib/costs/unit-cost-queries.ts`
- `src/lib/dashboard/occupancy-queries.ts`
- `src/lib/inspections/defect-actions.ts`
- `src/lib/inspections/queries.ts`
- `src/lib/inspections/re-inspection.ts`
- `src/lib/inspections/signature-utils.ts`
- `src/lib/knowledge/search.ts`
- `src/lib/notifications/preferences.ts`
- `src/lib/notifications/queries.ts`
- `src/lib/notifications/send.ts`
- `src/lib/notifications/tenant-triggers.ts`
- `src/lib/notifications/triggers.ts`
- `src/lib/parking/parking-queries.ts`
- `src/lib/settings/queries.ts`
- `src/lib/supabase/cached-queries.ts`
- `src/lib/units/condition-queries.ts`
- `src/lib/units/timeline-queries.ts`
- `src/lib/work-orders/events.ts`

**Group B — createServiceClient: Lib files called from portal/contractor routes (no org session)**
These lib files are called from portal/contractor API routes that use createServiceClient (Plan 37-03 Task 2). The callers have no org session context (token-gated or portal-session-gated). These lib files query tenant tables (tickets, ticket_messages, tenant_users, units, magic_link_tokens, inspection_portal_tokens, work_orders, partners, etc.) and MUST use createServiceClient to bypass RLS. Application-layer access control is handled by the calling routes (token validation, user ownership checks).

```
import { createServiceClient } from '@/lib/supabase/with-org'
const supabase = createServiceClient()
```

Note: createServiceClient is synchronous (no cookies/RPC needed).

**Group B files (~6 files):**
- `src/lib/magic-link.ts` — called from contractor routes, queries `magic_link_tokens` (tenant table)
- `src/lib/contractor/queries.ts` — called from contractor routes, queries `work_orders`, `partners`
- `src/lib/inspections/portal-tokens.ts` — called from portal inspection routes, queries `magic_link_tokens`, `inspection_portal_tokens` (both tenant tables)
- `src/lib/portal/message-queries.ts` — called from portal ticket routes, queries `ticket_messages` (tenant table)
- `src/lib/portal/tenant-isolation.ts` — called from portal routes, queries `tenant_users`, `tickets` (tenant tables)
- `src/lib/portal/ticket-queries.ts` — called from portal ticket routes, queries `tickets`, `ticket_messages`, `ticket_categories`

**IMPORTANT:** `src/lib/supabase/server.ts` itself is NOT migrated — it remains as-is. The `createPublicClient` in `with-org.ts` replicates its pattern. `server.ts` will be deprecated but not deleted (may have edge cases referencing it in Phase 38+).

**IMPORTANT:** `src/lib/supabase/with-org.ts` imports from server.ts internals (`@supabase/ssr`, `cookies`) — do NOT change with-org.ts itself.

**KNOWN REGRESSION:** `cached-queries.ts` functions (getCachedUnitsWithRooms, getCachedUnitConditionSummary, getCachedActiveProjectCount) query `units`, `rooms`, `unit_condition_summary`, `renovation_projects` — all tenant tables. Using createPublicClient means these return empty results after RLS enablement when called from server components (no org context on connection). This is ACCEPTED — server component org scoping is a Phase 38 concern. The cached queries CANNOT use createServiceClient because that would bypass RLS permanently; they need proper org context which requires Phase 38's OrganizationProvider.
  </action>
  <verify>
`grep -rl "from '@/lib/supabase/server'" src/lib/ --include='*.ts'` returns zero files (excluding server.ts itself since it doesn't import from itself).
`grep -rl "createServiceClient" src/lib/` returns the ~6 portal/contractor lib files.
`grep -rl "createPublicClient" src/lib/` returns the ~22 other lib files.
  </verify>
  <done>All lib utility files migrated: Group A (22 files) uses createPublicClient, Group B (6 files) uses createServiceClient, zero imports from @/lib/supabase/server remain in src/lib/</done>
</task>

<task type="auto">
  <name>Task 2: Migrate server components and page files</name>
  <files>src/app/dashboard/**/*.tsx, src/app/contractor/**/*.tsx, src/app/portal/**/*.tsx, src/app/admin/**/*.tsx</files>
  <action>
Migrate all server component/page files that import from `@/lib/supabase/server`:

**Import change (same for all):**
```
// OLD:
import { createClient } from '@/lib/supabase/server'

// NEW:
import { createPublicClient } from '@/lib/supabase/with-org'
```

**Client instantiation change:**
```
// OLD:
const supabase = await createClient()

// NEW:
const supabase = await createPublicClient()
```

**Server component files to migrate (14 files):**

Dashboard pages:
- `src/app/dashboard/wohnungen/[id]/page.tsx`
- `src/app/dashboard/projekte/[id]/page.tsx`
- `src/app/dashboard/projekte/[id]/aenderungsauftraege/page.tsx`
- `src/app/dashboard/kosten/wohnungen/[id]/page.tsx`
- `src/app/dashboard/kosten/rechnungen/page.tsx`
- `src/app/dashboard/kosten/projekte/[id]/page.tsx`
- `src/app/dashboard/kosten/page.tsx`
- `src/app/dashboard/kosten/export/page.tsx`
- `src/app/dashboard/knowledge/category/[id]/page.tsx`
- `src/app/dashboard/auftraege/page.tsx`
- `src/app/dashboard/vorlagen/abnahmen/page.tsx`
- `src/app/dashboard/aenderungsauftraege/[id]/page.tsx`

Contractor pages:
- `src/app/contractor/[token]/knowledge/[id]/page.tsx`
- `src/app/contractor/[token]/knowledge/page.tsx`

Portal pages:
- `src/app/portal/page.tsx`
- `src/app/portal/change-orders/[token]/page.tsx`

Admin page:
- `src/app/admin/page.tsx`

**Why createPublicClient for server components:** Server components run at request time but do NOT receive the NextRequest object. They cannot read the `x-organization-id` header. After RLS is enabled, these pages will show data for the org context set by the last RPC call on that connection (which is unreliable). Phase 38 (OrganizationProvider) will solve this by threading org context through React server components. For now, createPublicClient is the correct intermediate step — it makes the import migration complete while acknowledging that server component org scoping is a Phase 38 concern.

After both tasks, verify: `grep -rl "from '@/lib/supabase/server'" src/` should return ONLY `src/lib/supabase/server.ts` (the file itself) and `src/lib/supabase/with-org.ts` (if it imports from server.ts — actually it doesn't, it imports from @supabase/ssr directly).
  </action>
  <verify>
`grep -rl "from '@/lib/supabase/server'" src/` returns ONLY `src/lib/supabase/server.ts` itself (zero other files).
`grep -rl "createPublicClient" src/app/` returns the ~17 page files.
TypeScript compilation passes.
  </verify>
  <done>All server component and page files use createPublicClient, zero remaining createClient imports from server.ts anywhere in src/ except server.ts itself</done>
</task>

</tasks>

<verification>
- `grep -rl "from '@/lib/supabase/server'" src/ | grep -v 'src/lib/supabase/server.ts'` returns 0 files
- `grep -rl "createPublicClient\|createOrgClient\|createServiceClient" src/` returns 168+ files (123 API + 45 non-API)
- `grep -rl "createServiceClient" src/lib/` returns ~6 portal/contractor lib files
- TypeScript compilation passes: `npx tsc --noEmit` (or next build succeeds)
- `src/lib/supabase/server.ts` still exists (not deleted, kept for potential edge cases)
</verification>

<success_criteria>
All 45 non-API files migrated from createClient to the appropriate with-org.ts client: createPublicClient for lib files called from org-scoped routes and server components, createServiceClient for portal/contractor lib files that query tenant tables without org session. The entire codebase (except server.ts itself) uses with-org.ts clients exclusively. Zero remaining imports of createClient from @/lib/supabase/server. cached-queries.ts regression is accepted and documented (Phase 38 concern).
</success_criteria>

<output>
After completion, create `.planning/phases/37-rls-context-wiring/37-04-SUMMARY.md`
</output>
