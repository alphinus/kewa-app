---
phase: 37-rls-context-wiring
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/083_rls_policies.sql
autonomous: true
requirements:
  - RLS-01
  - RLS-05
must_haves:
  truths:
    - "All 62 tenant tables have RLS enabled with RESTRICTIVE SELECT/INSERT/UPDATE/DELETE policies"
    - "Old permissive policies from 029, 044, and 060 are dropped"
    - "Legacy RLS helper functions (is_internal_user, is_tenant_of_unit, is_contractor_for_work_order) are dropped"
    - "6 template tables allow NULL organization_id rows (system templates) via modified SELECT policy"
    - "Imeri Immobilien AG seeded as permanent test organization"
    - "Cross-tenant isolation verified: CRUD operations across org boundaries fail"
    - "Migration aborts (RAISE EXCEPTION) if any cross-tenant access succeeds"
  artifacts:
    - path: "supabase/migrations/083_rls_policies.sql"
      provides: "RLS teardown, new policies, test org seed, isolation verification"
      contains: "CREATE POLICY"
  key_links:
    - from: "083_rls_policies.sql"
      to: "076_rls_helpers.sql"
      via: "current_organization_id() function reference in USING clauses"
      pattern: "current_organization_id\\(\\)"
---

<objective>
Drop all existing RLS policies (from migrations 029, 044, 060), drop legacy helper functions, enable RLS on all 62 tenant tables with RESTRICTIVE org-scoped policies, seed Imeri Immobilien AG as permanent test organization, and verify cross-tenant isolation with a DO-block that aborts on failure.

Purpose: Database-level multi-tenant isolation — no application-layer bypass possible.
Output: `supabase/migrations/083_rls_policies.sql`
</objective>

<execution_context>
@C:/Users/Mario Giacchino/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Mario Giacchino/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/37-rls-context-wiring/37-RESEARCH.md
@.planning/phases/37-rls-context-wiring/37-CONTEXT.md
@supabase/migrations/076_rls_helpers.sql
@supabase/migrations/029_rls_policies.sql
@supabase/migrations/044_buildings_rls.sql
@supabase/migrations/060_inspection_advanced.sql
@supabase/migrations/082_not_null_constraints.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create 083_rls_policies.sql — teardown + new policies + test org + verification</name>
  <files>supabase/migrations/083_rls_policies.sql</files>
  <action>
Create a single migration file with 5 sections (use SQL comments to delimit):

**Section 1: Drop existing policies and functions**

Drop all named policies from these tables (use `DROP POLICY IF EXISTS`):

From 029_rls_policies.sql (7 tables, 13+ policies):
- `internal_full_access_units`, `tenant_own_units` ON units
- `internal_full_access_rooms`, `tenant_own_rooms` ON rooms
- `internal_full_access_tasks`, `tenant_own_tasks` ON tasks
- `internal_full_access_work_orders`, `contractor_own_work_orders`, `contractor_update_work_orders` ON work_orders
- `internal_full_access_renovation_projects`, `tenant_own_renovation_projects` ON renovation_projects
- `internal_full_access_media`, `tenant_own_media`, `contractor_work_order_media` ON media
- `internal_full_access_condition_history`, `tenant_own_condition_history` ON condition_history

From 044_buildings_rls.sql (1 table, 4 policies):
- `buildings_select_all`, `buildings_insert_all`, `buildings_update_all`, `buildings_delete_all` ON buildings

From 060_inspection_advanced.sql (1 table, 4 policies):
- `Authenticated users can view inspection portal tokens`, `Authenticated users can insert inspection portal tokens`, `Authenticated users can delete inspection portal tokens`, `Public can read via valid token` ON inspection_portal_tokens

Drop legacy functions (confirmed unreferenced in codebase):
- `DROP FUNCTION IF EXISTS is_internal_user(UUID);`
- `DROP FUNCTION IF EXISTS is_tenant_of_unit(UUID, UUID);`
- `DROP FUNCTION IF EXISTS is_contractor_for_work_order(UUID, UUID);`

**Section 2: Enable RLS on all 62 tenant tables**

`ALTER TABLE <table> ENABLE ROW LEVEL SECURITY;` for all 62 tables. Some tables already have RLS enabled (units, rooms, tasks, work_orders, renovation_projects, media, condition_history, buildings, inspection_portal_tokens) — `ENABLE ROW LEVEL SECURITY` is idempotent, safe to re-run.

**Section 3: Create standard RESTRICTIVE policies for 56 tables**

For each of the 56 standard tables, create 4 policies:

```sql
CREATE POLICY "<table>_org_select" ON <table>
  AS RESTRICTIVE FOR SELECT TO authenticated
  USING (organization_id = current_organization_id());

CREATE POLICY "<table>_org_insert" ON <table>
  AS RESTRICTIVE FOR INSERT TO authenticated
  WITH CHECK (organization_id = current_organization_id());

CREATE POLICY "<table>_org_update" ON <table>
  AS RESTRICTIVE FOR UPDATE TO authenticated
  USING (organization_id = current_organization_id())
  WITH CHECK (organization_id = current_organization_id());

CREATE POLICY "<table>_org_delete" ON <table>
  AS RESTRICTIVE FOR DELETE TO authenticated
  USING (organization_id = current_organization_id());
```

The 56 standard tables:
properties, buildings, units, rooms, components, renovation_projects, projects, project_phases, project_packages, project_quality_gates, tasks, task_photos, task_audio, task_dependencies, work_orders, work_order_events, offers, invoices, expenses, payments, partners, purchase_orders, deliveries, inventory_movements, purchase_order_allocations, approval_thresholds, change_orders, change_order_versions, change_order_photos, change_order_approval_tokens, inspections, inspection_defects, inspection_portal_tokens, inspection_templates, media, audit_logs, comments, magic_link_tokens, storage_metadata, kb_categories, kb_articles, kb_articles_history, kb_workflow_transitions, kb_dashboard_shortcuts, kb_attachments, notifications, user_notifications, push_subscriptions, notification_preferences, tickets, ticket_messages, ticket_attachments, ticket_work_orders, condition_history, app_settings, tenant_users

**Section 4: Create modified SELECT policies for 6 template tables**

For each template table, SELECT allows `organization_id = current_organization_id() OR organization_id IS NULL` (system templates visible to all orgs). INSERT/UPDATE/DELETE use strict org match only.

```sql
CREATE POLICY "<table>_org_select" ON <table>
  AS RESTRICTIVE FOR SELECT TO authenticated
  USING (organization_id = current_organization_id() OR organization_id IS NULL);

CREATE POLICY "<table>_org_insert" ON <table>
  AS RESTRICTIVE FOR INSERT TO authenticated
  WITH CHECK (organization_id = current_organization_id());

CREATE POLICY "<table>_org_update" ON <table>
  AS RESTRICTIVE FOR UPDATE TO authenticated
  USING (organization_id = current_organization_id())
  WITH CHECK (organization_id = current_organization_id());

CREATE POLICY "<table>_org_delete" ON <table>
  AS RESTRICTIVE FOR DELETE TO authenticated
  USING (organization_id = current_organization_id());
```

The 6 template tables: templates, template_phases, template_packages, template_tasks, template_dependencies, template_quality_gates

**Section 5: Seed Imeri Immobilien AG + cross-tenant isolation verification**

First, seed the test organization (idempotent with WHERE NOT EXISTS):
- Organization: id `00000000-0000-0000-0010-000000000003`, name "Imeri Immobilien AG", slug "imeri-immobilien-ag"

Then, a DO-block that verifies cross-tenant isolation. The DO-block MUST:

1. Set context to KeWa AG (`00000000-0000-0000-0010-000000000001`)
2. **SELECT test**: Verify `SELECT count(*) FROM properties WHERE organization_id != '00000000-0000-0000-0010-000000000001'` returns 0 (RLS hides other orgs)
3. **INSERT test**: Attempt to insert a row into `properties` with Imeri's org_id (`00000000-0000-0000-0010-000000000003`). Expect policy violation (catch in nested BEGIN/EXCEPTION block). RAISE EXCEPTION if insert succeeds.
4. Set context to Imeri AG (`00000000-0000-0000-0010-000000000003`)
5. **SELECT test (reverse)**: Verify Imeri context cannot see KeWa properties (count = 0)
6. **UPDATE test**: Attempt to update a KeWa property from Imeri context. Verify 0 rows affected (not an error, just no matching rows via RLS). If rows affected > 0, RAISE EXCEPTION.
7. **DELETE test**: Attempt to delete a KeWa property from Imeri context. Verify 0 rows affected. If rows affected > 0, RAISE EXCEPTION.
8. Reset context back to KeWa for safety: `PERFORM set_org_context('00000000-0000-0000-0010-000000000001');`
9. `RAISE NOTICE 'Cross-tenant isolation verified for all CRUD operations';`

If any test fails, `RAISE EXCEPTION` with descriptive message — migration aborts.

NOTE on quality_gates: Do NOT include `quality_gates` table (migration 072 may be skipped in production). Only `project_quality_gates` and `template_quality_gates` are in scope.
  </action>
  <verify>
Review the SQL file for:
1. All 21 old policies dropped (13 from 029 + 4 from 044 + 4 from 060)
2. 3 legacy functions dropped
3. 62 tables have ENABLE ROW LEVEL SECURITY
4. 56 tables × 4 policies = 224 standard policies created
5. 6 tables × 4 policies = 24 template policies created (SELECT has OR IS NULL)
6. Total: 248 new policies
7. Imeri org seeded
8. DO-block tests SELECT, INSERT, UPDATE, DELETE isolation and aborts on failure
  </verify>
  <done>Migration file exists with 248 RESTRICTIVE policies across 62 tables, old policies dropped, test org seeded, and cross-tenant CRUD verification DO-block that RAISE EXCEPTIONs on isolation failure</done>
</task>

</tasks>

<verification>
- `grep -c 'CREATE POLICY' supabase/migrations/083_rls_policies.sql` returns 248
- `grep -c 'DROP POLICY' supabase/migrations/083_rls_policies.sql` returns 21
- `grep -c 'DROP FUNCTION' supabase/migrations/083_rls_policies.sql` returns 3
- `grep -c 'ENABLE ROW LEVEL SECURITY' supabase/migrations/083_rls_policies.sql` returns 62
- `grep -c 'AS RESTRICTIVE' supabase/migrations/083_rls_policies.sql` returns 248
- `grep 'quality_gates' supabase/migrations/083_rls_policies.sql` shows only `project_quality_gates` and `template_quality_gates`, never bare `quality_gates`
- `grep 'RAISE EXCEPTION' supabase/migrations/083_rls_policies.sql` returns multiple lines (isolation failures)
</verification>

<success_criteria>
Migration file 083_rls_policies.sql contains complete RLS teardown, 248 RESTRICTIVE policies on 62 tables, Imeri test org, and self-verifying DO-block.
</success_criteria>

<output>
After completion, create `.planning/phases/37-rls-context-wiring/37-01-SUMMARY.md`
</output>
