---
phase: 39-navigation-redesign
plan: 04
type: execute
wave: 2
depends_on:
  - 39-02
  - 39-03
files_modified:
  - next.config.ts
  - src/app/dashboard/liegenschaft/page.tsx
  - src/app/dashboard/liegenschaft/[id]/page.tsx
  - src/app/dashboard/gebaude/page.tsx
  - src/app/dashboard/einheiten/page.tsx
  - src/app/dashboard/einheiten/[id]/page.tsx
  - src/app/dashboard/wohnungen/[id]/page.tsx
  - src/app/dashboard/liegenschaft/[id]/einheit/[unitId]/raum/[roomId]/page.tsx
  - src/app/dashboard/projekte/[id]/page.tsx
  - src/components/dashboard/BuildingSelector.tsx
autonomous: true
requirements:
  - NAV-04

must_haves:
  truths:
    - "/dashboard/liegenschaft redirects to /dashboard/objekte"
    - "/dashboard/gebaude redirects to /dashboard/objekte"
    - "/dashboard/liegenschaft/[buildingId] resolves building's property_id and redirects to /dashboard/objekte/[propertyId]/[buildingId]"
    - "/dashboard/einheiten/[unitId] resolves unit's building and property IDs and redirects to /dashboard/objekte/[propertyId]/[buildingId]/[unitId]"
    - "/dashboard/wohnungen/[unitId] resolves unit's building and property IDs and redirects to /dashboard/objekte/[propertyId]/[buildingId]/[unitId]"
    - "All internal links throughout the codebase use /objekte paths instead of old paths"
    - "No internal navigation relies on redirects — all hrefs point directly to /objekte paths"
  artifacts:
    - path: "next.config.ts"
      provides: "Static route redirects for liegenschaft, gebaude, einheiten list pages"
      contains: "redirects"
    - path: "src/app/dashboard/liegenschaft/[id]/page.tsx"
      provides: "Client redirect stub that resolves building ID to property + building path"
      contains: "router.replace"
    - path: "src/app/dashboard/einheiten/[id]/page.tsx"
      provides: "Client redirect stub that resolves unit ID to full objekte path"
      contains: "router.replace"
    - path: "src/app/dashboard/wohnungen/[id]/page.tsx"
      provides: "Client redirect stub that resolves unit ID to full objekte path"
      contains: "router.replace"
  key_links:
    - from: "next.config.ts"
      to: "/dashboard/objekte"
      via: "permanent redirect entries"
      pattern: "dashboard/objekte"
    - from: "src/app/dashboard/projekte/[id]/page.tsx"
      to: "/dashboard/objekte"
      via: "updated internal link"
      pattern: "dashboard/objekte"
---

<objective>
Set up URL redirects from old routes to new /objekte paths, and update all internal links throughout the codebase.

Purpose: Ensure old URLs (liegenschaft, gebaude, einheiten, wohnungen) redirect to corresponding /objekte paths (D7), and all internal navigation uses new paths directly without relying on redirects (D8).
Output: next.config.ts redirects, client redirect stub pages, and all internal links updated.
</objective>

<execution_context>
@C:/Users/Mario Giacchino/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Mario Giacchino/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/39-navigation-redesign/39-CONTEXT.md
@.planning/phases/39-navigation-redesign/39-RESEARCH.md
@.planning/phases/39-navigation-redesign/39-02-SUMMARY.md
@.planning/phases/39-navigation-redesign/39-03-SUMMARY.md
@next.config.ts
@src/app/dashboard/liegenschaft/[id]/page.tsx
@src/app/dashboard/einheiten/[id]/page.tsx
@src/app/dashboard/wohnungen/[id]/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add static redirects to next.config.ts and create client redirect stubs</name>
  <files>
    next.config.ts
    src/app/dashboard/liegenschaft/page.tsx
    src/app/dashboard/liegenschaft/[id]/page.tsx
    src/app/dashboard/gebaude/page.tsx
    src/app/dashboard/einheiten/page.tsx
    src/app/dashboard/einheiten/[id]/page.tsx
    src/app/dashboard/wohnungen/[id]/page.tsx
    src/app/dashboard/liegenschaft/[id]/einheit/[unitId]/raum/[roomId]/page.tsx
  </files>
  <action>
**1. Add `redirects()` to `next.config.ts`:**

Add an `async redirects()` method to the nextConfig object (alongside the existing `async headers()`):

```typescript
async redirects() {
  return [
    {
      source: '/dashboard/liegenschaft',
      destination: '/dashboard/objekte',
      permanent: true,
    },
    {
      source: '/dashboard/gebaude',
      destination: '/dashboard/objekte',
      permanent: true,
    },
    {
      source: '/dashboard/einheiten',
      destination: '/dashboard/objekte',
      permanent: true,
    },
  ]
},
```

These are static routes where no ID transformation is needed. `permanent: true` issues HTTP 308.

**2. Replace `liegenschaft/page.tsx` with a minimal redirect stub:**

Since the next.config.ts redirect handles `/dashboard/liegenschaft`, this file is only needed for the case where the config redirect somehow doesn't fire (edge case). Replace entire content with:

```tsx
import { redirect } from 'next/navigation'
export default function LiegenschaftRedirect() {
  redirect('/dashboard/objekte')
}
```

**3. Replace `liegenschaft/[id]/page.tsx` with a client redirect (Pitfall 1):**

The old `[id]` param is a BUILDING ID (confirmed: page calls `GET /api/buildings/${id}`). The new URL needs `/objekte/[propertyId]/[buildingId]`. Must resolve building → property_id.

Replace entire file with a client redirect page:
- 'use client', import `use`, `useEffect` from react, `useRouter` from next/navigation
- Params: `Promise<{ id: string }>`
- Unwrap `id` with `use(params)`
- In useEffect: fetch `GET /api/buildings/${id}`, extract `building.property_id`, call `router.replace(/dashboard/objekte/${building.property_id}/${id})`
- On error: `router.replace('/dashboard/objekte')`
- Render "Weiterleitung..." loading message

**4. Replace `gebaude/page.tsx` with redirect stub:**

Same pattern as liegenschaft/page.tsx. Replace with server redirect to `/dashboard/objekte`.

**5. Replace `einheiten/page.tsx` with redirect stub:**

Replace with server redirect to `/dashboard/objekte`. (next.config.ts handles it, this is fallback.)

**6. Replace `einheiten/[id]/page.tsx` with client redirect:**

Old `[id]` is a unit ID. New path needs `/objekte/[propertyId]/[buildingId]/[unitId]`. Must resolve unit → building_id → property_id.

Replace entire file with a client redirect:
- Fetch `GET /api/units/${id}` → get `unit.building_id`
- Fetch `GET /api/buildings/${unit.building_id}` → get `building.property_id`
- `router.replace(/dashboard/objekte/${building.property_id}/${unit.building_id}/${id})`
- On error: `router.replace('/dashboard/objekte')`
- Render "Weiterleitung..." loading message

**7. Replace `wohnungen/[id]/page.tsx` with client redirect:**

Same logic as einheiten/[id] — unit ID → building → property → redirect. Identical pattern.

**8. Replace `liegenschaft/[id]/einheit/[unitId]/raum/[roomId]/page.tsx` with client redirect:**

Params: `{ id: string, unitId: string, roomId: string }` where `id` is a building ID.

- Fetch `GET /api/buildings/${id}` → get `building.property_id`
- `router.replace(/dashboard/objekte/${building.property_id}/${id}/${unitId}/raum/${roomId})`
- On error: `router.replace('/dashboard/objekte')`
  </action>
  <verify>
Run `npx tsc --noEmit`. Verify `next.config.ts` has `redirects()`. Verify each old page file contains `router.replace` or `redirect` to `/dashboard/objekte`.
  </verify>
  <done>
Static routes redirect via next.config.ts (308). ID-dependent routes use client redirect pages that resolve the correct property + building path from the old IDs. No old page renders its original content — all redirect to /objekte.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update all internal links to use /objekte paths (D8)</name>
  <files>
    src/app/dashboard/projekte/[id]/page.tsx
    src/components/dashboard/BuildingSelector.tsx
    src/components/ui/breadcrumbs.tsx
    src/components/ui/empty-state.tsx
  </files>
  <action>
Grep the entire `src/` directory for all occurrences of `/dashboard/liegenschaft`, `/dashboard/gebaude`, `/dashboard/einheiten`, `/dashboard/wohnungen` in link targets and update to `/dashboard/objekte` equivalents.

**Known files from grep results (update each):**

1. **`src/app/dashboard/projekte/[id]/page.tsx` line 225:**
   - Old: `href={/dashboard/wohnungen/${unit.id}}`
   - This link needs the property + building context. The unit object on the projekte detail page has `unit.id` and likely `unit.building_id`. Check the data structure — if building_id and property context are available, build the full path. If not, use `/dashboard/objekte` as fallback and let the user navigate from there.
   - If unit object has `building_id` and building has `property_id` from a join, construct `/dashboard/objekte/${property_id}/${building_id}/${unit.id}`.
   - If the data doesn't include property_id at this point: the simplest correct approach is to link to `/dashboard/objekte` with a note, OR fetch the path. Since this is a server component reading from Supabase, extend the query to include `unit.building:buildings(property_id)` so we have the full path. Update the link accordingly.

2. **`src/components/dashboard/BuildingSelector.tsx` line 62:**
   - Old: `router.push(/dashboard/liegenschaft?building=${buildingId})`
   - New: This component pushes to liegenschaft when a building is selected. With the new navigation, building selection in CombinedSelector navigates nowhere (it just sets context). However, BuildingSelector is a legacy component. Check if it's still used anywhere. If only used in the old liegenschaft flow, update to `/dashboard/objekte`. If used elsewhere, update the target.
   - Update to: `router.push('/dashboard/objekte')` — the old "navigate to liegenschaft on building select" behavior no longer applies. The CombinedSelector from Phase 38 handles building context. This BuildingSelector is a legacy component from Phase 14.

3. **`src/components/ui/breadcrumbs.tsx` lines 23-24:**
   - These are JSDoc examples in comments. Update the example hrefs from `/dashboard/liegenschaft` to `/dashboard/objekte`.

4. **`src/components/ui/empty-state.tsx` line 15:**
   - This is a JSDoc example comment. Update `/dashboard/liegenschaften/neu` to `/dashboard/objekte`.

Run a final comprehensive grep after all updates to confirm zero remaining references to old paths in link targets (excluding redirect stub files which intentionally reference `/dashboard/objekte` as their redirect destination).
  </action>
  <verify>
Run `npx tsc --noEmit`. Grep for `/dashboard/liegenschaft`, `/dashboard/gebaude`, `/dashboard/einheiten`, `/dashboard/wohnungen` in all .tsx/.ts files EXCLUDING the redirect stub files (liegenschaft/page.tsx, liegenschaft/[id]/page.tsx, gebaude/page.tsx, einheiten/page.tsx, einheiten/[id]/page.tsx, wohnungen/[id]/page.tsx, liegenschaft/[id]/einheit/*/page.tsx). Result should be zero matches in non-redirect files.
  </verify>
  <done>
All internal navigation links point to /dashboard/objekte paths. No internal component relies on redirects for navigation. Grep confirms zero old-path references in non-redirect files.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes
2. `next.config.ts` has 3 static redirect entries (liegenschaft, gebaude, einheiten → objekte)
3. liegenschaft/[id], einheiten/[id], wohnungen/[id] are client redirect stubs
4. All internal links use /objekte paths (grep confirms)
5. Redirect stubs resolve IDs correctly (building → property, unit → building → property)
</verification>

<success_criteria>
- Old static URLs redirect via HTTP 308
- Old ID-parameterized URLs resolve to correct /objekte paths via client redirect
- All internal navigation uses new /objekte paths directly
- No 404 errors for previously valid routes
- No TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/39-navigation-redesign/39-04-SUMMARY.md`
</output>
