---
phase: 035-schema-foundation
plan: 02
type: execute
wave: 2
depends_on:
  - 35-01
files_modified:
  - supabase/migrations/075_org_id_columns.sql
autonomous: true
requirements:
  - SCHEMA-04

must_haves:
  truths:
    - "Every table in the D2 per-organization list has a nullable organization_id UUID column referencing organizations(id)"
    - "properties table has mandate_id UUID FK and property_type TEXT CHECK (rental, stwe, mixed) columns"
    - "properties table has Swiss Grundbuch fields: land_registry_nr, municipality, parcel_nr (all nullable)"
    - "Every organization_id column has a btree index named idx_{tablename}_org"
    - "No existing row is broken — all columns are nullable (NOT NULL comes in Phase 36)"
    - "CREATE INDEX uses CONCURRENTLY to avoid table locks on production tables"
  artifacts:
    - path: "supabase/migrations/075_org_id_columns.sql"
      provides: "organization_id on all 44 existing tenant tables"
      contains: "ALTER TABLE properties"
  key_links:
    - from: "properties.organization_id"
      to: "organizations(id)"
      via: "FK reference"
      pattern: "REFERENCES organizations\\(id\\)"
    - from: "properties.mandate_id"
      to: "mandates(id)"
      via: "FK reference"
      pattern: "REFERENCES mandates\\(id\\)"
---

<objective>
Add nullable `organization_id UUID` to all 44 existing per-organization tables, plus `mandate_id`, `property_type`, and Grundbuch fields to properties. Each column addition is paired with a `CREATE INDEX CONCURRENTLY` to ensure RLS queries are fast even before backfill.

Purpose: This is the largest single migration in Phase 35. Once done, every tenant table is structurally ready for RLS (Phase 37). Columns are nullable here — NOT NULL enforced after Phase 36 backfill.
Output: Migration file 075 — one comprehensive ALTER TABLE per tenant table, idempotent via IF NOT EXISTS.
</objective>

<execution_context>
@C:/Users/Mario Giacchino/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Mario Giacchino/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/035-schema-foundation/35-CONTEXT.md
@.planning/phases/035-schema-foundation/35-RESEARCH.md
@.planning/phases/035-schema-foundation/35-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create 075_org_id_columns.sql — organization_id on all 44 tenant tables</name>
  <files>supabase/migrations/075_org_id_columns.sql</files>
  <action>
Create `supabase/migrations/075_org_id_columns.sql`. This file adds `organization_id UUID REFERENCES organizations(id)` as a nullable column to every per-organization table listed in D2 (CONTEXT.md). Follow these rules:

**Critical rules:**
- Use `ADD COLUMN IF NOT EXISTS` — idempotent
- Use `CREATE INDEX CONCURRENTLY IF NOT EXISTS` — no table lock on production
- All columns NULLABLE — NOT NULL comes in Phase 36 after backfill
- Index naming: `idx_{tablename}_org`
- For tables with multiple related column additions (properties), group them in ONE ALTER TABLE statement

**Header:**
```sql
-- KEWA v4.0: Multi-Tenant Schema Foundation
-- Migration: 075_org_id_columns.sql
-- Adds organization_id (nullable) to all 44 per-organization tables
-- Requirements: SCHEMA-04
-- Phase 35: Schema Foundation
-- NOTE: All columns nullable — Phase 36 will backfill then add NOT NULL
```

**Section 1 — Core property hierarchy (properties gets extra columns per D3, D9):**
```sql
-- properties: gets organization_id + mandate_id + property_type + Grundbuch fields (D9)
ALTER TABLE properties
  ADD COLUMN IF NOT EXISTS organization_id UUID REFERENCES organizations(id),
  ADD COLUMN IF NOT EXISTS mandate_id UUID REFERENCES mandates(id),
  ADD COLUMN IF NOT EXISTS property_type TEXT DEFAULT 'rental'
    CHECK (property_type IN ('rental', 'stwe', 'mixed')),
  ADD COLUMN IF NOT EXISTS land_registry_nr TEXT,     -- Grundbuchnummer (D9)
  ADD COLUMN IF NOT EXISTS municipality TEXT,          -- Gemeinde (D9)
  ADD COLUMN IF NOT EXISTS parcel_nr TEXT;             -- Parzellennummer (D9)

CREATE INDEX CONCURRENTLY IF NOT EXISTS idx_properties_org ON properties(organization_id);
CREATE INDEX CONCURRENTLY IF NOT EXISTS idx_properties_mandate ON properties(mandate_id);

ALTER TABLE buildings
  ADD COLUMN IF NOT EXISTS organization_id UUID REFERENCES organizations(id);
CREATE INDEX CONCURRENTLY IF NOT EXISTS idx_buildings_org ON buildings(organization_id);

ALTER TABLE units
  ADD COLUMN IF NOT EXISTS organization_id UUID REFERENCES organizations(id);
CREATE INDEX CONCURRENTLY IF NOT EXISTS idx_units_org ON units(organization_id);

ALTER TABLE rooms
  ADD COLUMN IF NOT EXISTS organization_id UUID REFERENCES organizations(id);
CREATE INDEX CONCURRENTLY IF NOT EXISTS idx_rooms_org ON rooms(organization_id);
```

**Section 2 — Projects and tasks hierarchy:**
```sql
ALTER TABLE projects
  ADD COLUMN IF NOT EXISTS organization_id UUID REFERENCES organizations(id);
CREATE INDEX CONCURRENTLY IF NOT EXISTS idx_projects_org ON projects(organization_id);

ALTER TABLE tasks
  ADD COLUMN IF NOT EXISTS organization_id UUID REFERENCES organizations(id);
CREATE INDEX CONCURRENTLY IF NOT EXISTS idx_tasks_org ON tasks(organization_id);

ALTER TABLE task_dependencies
  ADD COLUMN IF NOT EXISTS organization_id UUID REFERENCES organizations(id);
CREATE INDEX CONCURRENTLY IF NOT EXISTS idx_task_dependencies_org ON task_dependencies(organization_id);

ALTER TABLE renovation_projects
  ADD COLUMN IF NOT EXISTS organization_id UUID REFERENCES organizations(id);
CREATE INDEX CONCURRENTLY IF NOT EXISTS idx_renovation_projects_org ON renovation_projects(organization_id);

ALTER TABLE work_orders
  ADD COLUMN IF NOT EXISTS organization_id UUID REFERENCES organizations(id);
CREATE INDEX CONCURRENTLY IF NOT EXISTS idx_work_orders_org ON work_orders(organization_id);

ALTER TABLE work_order_events
  ADD COLUMN IF NOT EXISTS organization_id UUID REFERENCES organizations(id);
CREATE INDEX CONCURRENTLY IF NOT EXISTS idx_work_order_events_org ON work_order_events(organization_id);
```

**Section 3 — Partners and financial tables:**
```sql
ALTER TABLE partners
  ADD COLUMN IF NOT EXISTS organization_id UUID REFERENCES organizations(id);
CREATE INDEX CONCURRENTLY IF NOT EXISTS idx_partners_org ON partners(organization_id);

ALTER TABLE offers
  ADD COLUMN IF NOT EXISTS organization_id UUID REFERENCES organizations(id);
CREATE INDEX CONCURRENTLY IF NOT EXISTS idx_offers_org ON offers(organization_id);

ALTER TABLE invoices
  ADD COLUMN IF NOT EXISTS organization_id UUID REFERENCES organizations(id);
CREATE INDEX CONCURRENTLY IF NOT EXISTS idx_invoices_org ON invoices(organization_id);

ALTER TABLE expenses
  ADD COLUMN IF NOT EXISTS organization_id UUID REFERENCES organizations(id);
CREATE INDEX CONCURRENTLY IF NOT EXISTS idx_expenses_org ON expenses(organization_id);

ALTER TABLE payments
  ADD COLUMN IF NOT EXISTS organization_id UUID REFERENCES organizations(id);
CREATE INDEX CONCURRENTLY IF NOT EXISTS idx_payments_org ON payments(organization_id);

ALTER TABLE purchase_orders
  ADD COLUMN IF NOT EXISTS organization_id UUID REFERENCES organizations(id);
CREATE INDEX CONCURRENTLY IF NOT EXISTS idx_purchase_orders_org ON purchase_orders(organization_id);

ALTER TABLE deliveries
  ADD COLUMN IF NOT EXISTS organization_id UUID REFERENCES organizations(id);
CREATE INDEX CONCURRENTLY IF NOT EXISTS idx_deliveries_org ON deliveries(organization_id);

ALTER TABLE inventory_movements
  ADD COLUMN IF NOT EXISTS organization_id UUID REFERENCES organizations(id);
CREATE INDEX CONCURRENTLY IF NOT EXISTS idx_inventory_movements_org ON inventory_movements(organization_id);

ALTER TABLE purchase_order_allocations
  ADD COLUMN IF NOT EXISTS organization_id UUID REFERENCES organizations(id);
CREATE INDEX CONCURRENTLY IF NOT EXISTS idx_purchase_order_allocations_org ON purchase_order_allocations(organization_id);

ALTER TABLE approval_thresholds
  ADD COLUMN IF NOT EXISTS organization_id UUID REFERENCES organizations(id);
CREATE INDEX CONCURRENTLY IF NOT EXISTS idx_approval_thresholds_org ON approval_thresholds(organization_id);
```

**Section 4 — Change orders and inspections:**
```sql
ALTER TABLE change_orders
  ADD COLUMN IF NOT EXISTS organization_id UUID REFERENCES organizations(id);
CREATE INDEX CONCURRENTLY IF NOT EXISTS idx_change_orders_org ON change_orders(organization_id);

ALTER TABLE change_order_versions
  ADD COLUMN IF NOT EXISTS organization_id UUID REFERENCES organizations(id);
CREATE INDEX CONCURRENTLY IF NOT EXISTS idx_change_order_versions_org ON change_order_versions(organization_id);

ALTER TABLE change_order_photos
  ADD COLUMN IF NOT EXISTS organization_id UUID REFERENCES organizations(id);
CREATE INDEX CONCURRENTLY IF NOT EXISTS idx_change_order_photos_org ON change_order_photos(organization_id);

ALTER TABLE change_order_approval_tokens
  ADD COLUMN IF NOT EXISTS organization_id UUID REFERENCES organizations(id);
CREATE INDEX CONCURRENTLY IF NOT EXISTS idx_change_order_approval_tokens_org ON change_order_approval_tokens(organization_id);

ALTER TABLE inspections
  ADD COLUMN IF NOT EXISTS organization_id UUID REFERENCES organizations(id);
CREATE INDEX CONCURRENTLY IF NOT EXISTS idx_inspections_org ON inspections(organization_id);

ALTER TABLE inspection_defects
  ADD COLUMN IF NOT EXISTS organization_id UUID REFERENCES organizations(id);
CREATE INDEX CONCURRENTLY IF NOT EXISTS idx_inspection_defects_org ON inspection_defects(organization_id);

ALTER TABLE inspection_portal_tokens
  ADD COLUMN IF NOT EXISTS organization_id UUID REFERENCES organizations(id);
CREATE INDEX CONCURRENTLY IF NOT EXISTS idx_inspection_portal_tokens_org ON inspection_portal_tokens(organization_id);

ALTER TABLE inspection_templates
  ADD COLUMN IF NOT EXISTS organization_id UUID REFERENCES organizations(id);
CREATE INDEX CONCURRENTLY IF NOT EXISTS idx_inspection_templates_org ON inspection_templates(organization_id);
```

**Section 5 — Media, audit, and communication:**
```sql
ALTER TABLE media
  ADD COLUMN IF NOT EXISTS organization_id UUID REFERENCES organizations(id);
CREATE INDEX CONCURRENTLY IF NOT EXISTS idx_media_org ON media(organization_id);

ALTER TABLE audit_logs
  ADD COLUMN IF NOT EXISTS organization_id UUID REFERENCES organizations(id);
CREATE INDEX CONCURRENTLY IF NOT EXISTS idx_audit_logs_org ON audit_logs(organization_id);

ALTER TABLE comments
  ADD COLUMN IF NOT EXISTS organization_id UUID REFERENCES organizations(id);
CREATE INDEX CONCURRENTLY IF NOT EXISTS idx_comments_org ON comments(organization_id);

ALTER TABLE magic_link_tokens
  ADD COLUMN IF NOT EXISTS organization_id UUID REFERENCES organizations(id);
CREATE INDEX CONCURRENTLY IF NOT EXISTS idx_magic_link_tokens_org ON magic_link_tokens(organization_id);

ALTER TABLE storage_metadata
  ADD COLUMN IF NOT EXISTS organization_id UUID REFERENCES organizations(id);
CREATE INDEX CONCURRENTLY IF NOT EXISTS idx_storage_metadata_org ON storage_metadata(organization_id);
```

**Section 6 — Knowledge base:**
```sql
ALTER TABLE kb_categories
  ADD COLUMN IF NOT EXISTS organization_id UUID REFERENCES organizations(id);
CREATE INDEX CONCURRENTLY IF NOT EXISTS idx_kb_categories_org ON kb_categories(organization_id);

ALTER TABLE kb_articles
  ADD COLUMN IF NOT EXISTS organization_id UUID REFERENCES organizations(id);
CREATE INDEX CONCURRENTLY IF NOT EXISTS idx_kb_articles_org ON kb_articles(organization_id);

ALTER TABLE kb_articles_history
  ADD COLUMN IF NOT EXISTS organization_id UUID REFERENCES organizations(id);
CREATE INDEX CONCURRENTLY IF NOT EXISTS idx_kb_articles_history_org ON kb_articles_history(organization_id);

ALTER TABLE kb_workflow_transitions
  ADD COLUMN IF NOT EXISTS organization_id UUID REFERENCES organizations(id);
CREATE INDEX CONCURRENTLY IF NOT EXISTS idx_kb_workflow_transitions_org ON kb_workflow_transitions(organization_id);

ALTER TABLE kb_dashboard_shortcuts
  ADD COLUMN IF NOT EXISTS organization_id UUID REFERENCES organizations(id);
CREATE INDEX CONCURRENTLY IF NOT EXISTS idx_kb_dashboard_shortcuts_org ON kb_dashboard_shortcuts(organization_id);

ALTER TABLE kb_attachments
  ADD COLUMN IF NOT EXISTS organization_id UUID REFERENCES organizations(id);
CREATE INDEX CONCURRENTLY IF NOT EXISTS idx_kb_attachments_org ON kb_attachments(organization_id);
```

**Section 7 — Notifications and tickets:**
```sql
ALTER TABLE notifications
  ADD COLUMN IF NOT EXISTS organization_id UUID REFERENCES organizations(id);
CREATE INDEX CONCURRENTLY IF NOT EXISTS idx_notifications_org ON notifications(organization_id);

ALTER TABLE user_notifications
  ADD COLUMN IF NOT EXISTS organization_id UUID REFERENCES organizations(id);
CREATE INDEX CONCURRENTLY IF NOT EXISTS idx_user_notifications_org ON user_notifications(organization_id);

ALTER TABLE push_subscriptions
  ADD COLUMN IF NOT EXISTS organization_id UUID REFERENCES organizations(id);
CREATE INDEX CONCURRENTLY IF NOT EXISTS idx_push_subscriptions_org ON push_subscriptions(organization_id);

ALTER TABLE notification_preferences
  ADD COLUMN IF NOT EXISTS organization_id UUID REFERENCES organizations(id);
CREATE INDEX CONCURRENTLY IF NOT EXISTS idx_notification_preferences_org ON notification_preferences(organization_id);

ALTER TABLE tickets
  ADD COLUMN IF NOT EXISTS organization_id UUID REFERENCES organizations(id);
CREATE INDEX CONCURRENTLY IF NOT EXISTS idx_tickets_org ON tickets(organization_id);

ALTER TABLE ticket_messages
  ADD COLUMN IF NOT EXISTS organization_id UUID REFERENCES organizations(id);
CREATE INDEX CONCURRENTLY IF NOT EXISTS idx_ticket_messages_org ON ticket_messages(organization_id);

ALTER TABLE ticket_attachments
  ADD COLUMN IF NOT EXISTS organization_id UUID REFERENCES organizations(id);
CREATE INDEX CONCURRENTLY IF NOT EXISTS idx_ticket_attachments_org ON ticket_attachments(organization_id);

ALTER TABLE ticket_work_orders
  ADD COLUMN IF NOT EXISTS organization_id UUID REFERENCES organizations(id);
CREATE INDEX CONCURRENTLY IF NOT EXISTS idx_ticket_work_orders_org ON ticket_work_orders(organization_id);
```

**Section 8 — Global+Org Extension tables (nullable org_id — NULL=system, UUID=org-specific):**
These tables follow the D2 "Global+Org Extension" pattern. organization_id nullable means NULL=system entry, UUID=org-specific entry.
```sql
-- templates and phases/packages/tasks/etc: NULL = system template, UUID = org copy
ALTER TABLE templates
  ADD COLUMN IF NOT EXISTS organization_id UUID REFERENCES organizations(id);
CREATE INDEX CONCURRENTLY IF NOT EXISTS idx_templates_org ON templates(organization_id);

ALTER TABLE template_phases
  ADD COLUMN IF NOT EXISTS organization_id UUID REFERENCES organizations(id);
CREATE INDEX CONCURRENTLY IF NOT EXISTS idx_template_phases_org ON template_phases(organization_id);

ALTER TABLE template_packages
  ADD COLUMN IF NOT EXISTS organization_id UUID REFERENCES organizations(id);
CREATE INDEX CONCURRENTLY IF NOT EXISTS idx_template_packages_org ON template_packages(organization_id);

ALTER TABLE template_tasks
  ADD COLUMN IF NOT EXISTS organization_id UUID REFERENCES organizations(id);
CREATE INDEX CONCURRENTLY IF NOT EXISTS idx_template_tasks_org ON template_tasks(organization_id);

ALTER TABLE template_dependencies
  ADD COLUMN IF NOT EXISTS organization_id UUID REFERENCES organizations(id);
CREATE INDEX CONCURRENTLY IF NOT EXISTS idx_template_dependencies_org ON template_dependencies(organization_id);

ALTER TABLE template_quality_gates
  ADD COLUMN IF NOT EXISTS organization_id UUID REFERENCES organizations(id);
CREATE INDEX CONCURRENTLY IF NOT EXISTS idx_template_quality_gates_org ON template_quality_gates(organization_id);

ALTER TABLE project_phases
  ADD COLUMN IF NOT EXISTS organization_id UUID REFERENCES organizations(id);
CREATE INDEX CONCURRENTLY IF NOT EXISTS idx_project_phases_org ON project_phases(organization_id);

ALTER TABLE project_packages
  ADD COLUMN IF NOT EXISTS organization_id UUID REFERENCES organizations(id);
CREATE INDEX CONCURRENTLY IF NOT EXISTS idx_project_packages_org ON project_packages(organization_id);

ALTER TABLE project_quality_gates
  ADD COLUMN IF NOT EXISTS organization_id UUID REFERENCES organizations(id);
CREATE INDEX CONCURRENTLY IF NOT EXISTS idx_project_quality_gates_org ON project_quality_gates(organization_id);
```

**Section 9 — Special handling tables (audit first which ones actually exist):**
Before adding to these tables, check if they exist (some may have been superseded):
- `components` (migration 010) — per-org
- `task_audio` (migration 005) — per-org via tasks
- `task_photos` (migration 003) — per-org via tasks
- `app_settings` (per-org: each org has their own company_name for tenant portal)
- `condition_history` (migration 027) — per-org
- `tenant_users` (migration 023 or 062) — per-org

Add to each IF the table exists. Use `ADD COLUMN IF NOT EXISTS` for safety. Check migration files 005, 010, 023 to confirm column names before adding.

```sql
-- components (010_component.sql) — per-org building/unit components
ALTER TABLE components
  ADD COLUMN IF NOT EXISTS organization_id UUID REFERENCES organizations(id);
CREATE INDEX CONCURRENTLY IF NOT EXISTS idx_components_org ON components(organization_id);

-- condition_history (027_condition_tracking.sql) — per-org
ALTER TABLE condition_history
  ADD COLUMN IF NOT EXISTS organization_id UUID REFERENCES organizations(id);
CREATE INDEX CONCURRENTLY IF NOT EXISTS idx_condition_history_org ON condition_history(organization_id);

-- task_photos (003_task_photos.sql) — check if superseded by media table
-- If task_photos table exists: add org_id
ALTER TABLE task_photos
  ADD COLUMN IF NOT EXISTS organization_id UUID REFERENCES organizations(id);
CREATE INDEX CONCURRENTLY IF NOT EXISTS idx_task_photos_org ON task_photos(organization_id);

-- task_audio (005_task_audio.sql) — check if superseded by media table
ALTER TABLE task_audio
  ADD COLUMN IF NOT EXISTS organization_id UUID REFERENCES organizations(id);
CREATE INDEX CONCURRENTLY IF NOT EXISTS idx_task_audio_org ON task_audio(organization_id);

-- app_settings — per-org (each org has their own company_name for tenant portal)
ALTER TABLE app_settings
  ADD COLUMN IF NOT EXISTS organization_id UUID REFERENCES organizations(id);
CREATE INDEX CONCURRENTLY IF NOT EXISTS idx_app_settings_org ON app_settings(organization_id);
```

**EXECUTOR NOTE:** Before writing this file, run a quick scan of migration files 003, 005, 010, 023, 027 to confirm the exact table names exist. If any table does not exist (e.g., task_photos was dropped or renamed to media), wrap that section in a DO $$ BEGIN ... EXCEPTION WHEN undefined_table THEN NULL; END $$; block, or simply omit it with a comment explaining why.

Also check migration 062_tenant_portal.sql for the `tenant_users` table structure — add org_id if that table exists.
  </action>
  <verify>
Count ALTER TABLE statements: `node -e "const sql=require('fs').readFileSync('supabase/migrations/075_org_id_columns.sql','utf8'); const count=(sql.match(/ALTER TABLE/g)||[]).length; console.log('ALTER TABLE count:',count,'(expect 40+)');"`

Verify CONCURRENTLY used on all indexes: `node -e "const sql=require('fs').readFileSync('supabase/migrations/075_org_id_columns.sql','utf8'); const idx=(sql.match(/CREATE INDEX/g)||[]).length; const conc=(sql.match(/CREATE INDEX CONCURRENTLY/g)||[]).length; if(idx!==conc) throw new Error('Non-CONCURRENTLY index found: '+idx+' total, '+conc+' concurrent'); console.log('All '+idx+' indexes use CONCURRENTLY');"`

Verify properties has mandate_id and property_type: `node -e "const sql=require('fs').readFileSync('supabase/migrations/075_org_id_columns.sql','utf8'); ['mandate_id','property_type','land_registry_nr','municipality','parcel_nr'].forEach(c=>{ if(!sql.includes(c)) throw new Error('Missing: '+c); }); console.log('properties columns OK');"`
  </verify>
  <done>
075_org_id_columns.sql exists with organization_id added to all per-organization tables, all indexes using CONCURRENTLY, properties has mandate_id + property_type + Grundbuch fields, and all columns are nullable.
  </done>
</task>

</tasks>

<verification>
1. 075_org_id_columns.sql exists
2. All 44 per-organization tables have organization_id added
3. properties has: organization_id, mandate_id, property_type (rental/stwe/mixed CHECK), land_registry_nr, municipality, parcel_nr
4. Every `CREATE INDEX` uses `CONCURRENTLY`
5. All `ADD COLUMN` uses `IF NOT EXISTS`
6. Zero columns have NOT NULL (that is Phase 36)
7. Index naming follows idx_{tablename}_org pattern
</verification>

<success_criteria>
- 075_org_id_columns.sql exists covering all per-org tables
- All 40+ tables have organization_id column added
- All 40+ indexes created with CONCURRENTLY
- properties uniquely gets mandate_id, property_type, land_registry_nr, municipality, parcel_nr
- File is idempotent (safe to run multiple times)
</success_criteria>

<output>
After completion, create `.planning/phases/035-schema-foundation/35-02-SUMMARY.md`
</output>
