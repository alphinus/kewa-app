---
phase: 035-schema-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/073_org_foundation.sql
  - supabase/migrations/074_tenancies.sql
autonomous: true
requirements:
  - SCHEMA-01
  - SCHEMA-02
  - SCHEMA-03

must_haves:
  truths:
    - "organizations table exists with slug, is_active, and Swiss legal fields (uid, vat_number, commercial_register, bank_account, country)"
    - "organization_members table exists with UNIQUE(organization_id, user_id) constraint and partial index on is_default"
    - "owners table exists with owner_type CHECK constraint (person, company, community, stwe_association) and nullable user_id FK"
    - "mandates table exists with mandate_type CHECK (rental, stwe, mixed), start_date, end_date, is_active"
    - "tenancies table exists with Swiss law fields (base_rent, ancillary_costs, deposit_amount, notice_period_months, reference_interest_rate, contract_type)"
    - "All new tables use English column names — no German column names (wertquote, eigentumsperiode etc.)"
  artifacts:
    - path: "supabase/migrations/073_org_foundation.sql"
      provides: "organizations, organization_members, owners, mandates tables"
      contains: "CREATE TABLE IF NOT EXISTS organizations"
    - path: "supabase/migrations/074_tenancies.sql"
      provides: "tenancies table with Swiss rental law fields"
      contains: "CREATE TABLE IF NOT EXISTS tenancies"
  key_links:
    - from: "organization_members"
      to: "organizations"
      via: "FK on organization_id ON DELETE CASCADE"
      pattern: "REFERENCES organizations\\(id\\) ON DELETE CASCADE"
    - from: "owners"
      to: "organizations"
      via: "FK on organization_id ON DELETE CASCADE"
      pattern: "REFERENCES organizations\\(id\\)"
    - from: "mandates"
      to: "owners"
      via: "FK on owner_id"
      pattern: "REFERENCES owners\\(id\\)"
    - from: "tenancies"
      to: "units"
      via: "FK on unit_id"
      pattern: "REFERENCES units\\(id\\)"
---

<objective>
Create the top-level tenant boundary tables: organizations, organization_members, owners, mandates, and tenancies. These are the new entities that define the multi-tenant data model hierarchy (Organization > Owner > Mandate > Property chain).

Purpose: Every subsequent migration in Phase 35 references organizations(id) via FK. These tables must exist first before any ALTER TABLE can add organization_id columns to existing tables.
Output: Migration files 073 and 074 — idempotent, deployable to production with no data changes to existing tables.
</objective>

<execution_context>
@C:/Users/Mario Giacchino/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Mario Giacchino/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/035-schema-foundation/35-CONTEXT.md
@.planning/phases/035-schema-foundation/35-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create 073_org_foundation.sql — organizations, organization_members, owners, mandates</name>
  <files>supabase/migrations/073_org_foundation.sql</files>
  <action>
Create `supabase/migrations/073_org_foundation.sql` with the following tables. All DDL must use `IF NOT EXISTS` for idempotency. All column names in English (D1 — locked decision).

**organizations table** (SCHEMA-01 + D5 Swiss legal fields):
```sql
CREATE TABLE IF NOT EXISTS organizations (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  name TEXT NOT NULL,
  slug TEXT UNIQUE NOT NULL,
  is_active BOOLEAN DEFAULT true,
  uid TEXT,                      -- Unternehmens-Identifikationsnummer CHE-xxx
  vat_number TEXT,               -- MwSt-Nummer
  commercial_register TEXT,      -- Handelsregister-Eintrag
  bank_account TEXT,             -- IBAN
  country TEXT DEFAULT 'CH',     -- D11 international extensibility
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);
CREATE INDEX IF NOT EXISTS idx_organizations_slug ON organizations(slug);
CREATE INDEX IF NOT EXISTS idx_organizations_active ON organizations(is_active);
```

**organization_members table** (SCHEMA-01):
```sql
CREATE TABLE IF NOT EXISTS organization_members (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  organization_id UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,
  user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  role_id UUID NOT NULL REFERENCES roles(id),
  is_default BOOLEAN DEFAULT false,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  UNIQUE(organization_id, user_id)
);
CREATE INDEX IF NOT EXISTS idx_org_members_org ON organization_members(organization_id);
CREATE INDEX IF NOT EXISTS idx_org_members_user ON organization_members(user_id);
-- Partial index: efficiently find user's default org
CREATE INDEX IF NOT EXISTS idx_org_members_user_default
  ON organization_members(user_id, is_default)
  WHERE is_default = true;
```

**owners table** (SCHEMA-02 + D4 owner model):
- owner_type uses text + CHECK (consistent with existing schema style — not CREATE TYPE enum)
- user_id FK nullable — owner portal deferred per CONTEXT.md Deferred Ideas
```sql
CREATE TABLE IF NOT EXISTS owners (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  organization_id UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,
  owner_type TEXT NOT NULL DEFAULT 'person'
    CHECK (owner_type IN ('person', 'company', 'community', 'stwe_association')),
  name TEXT NOT NULL,
  address TEXT,
  postal_code TEXT,
  city TEXT,
  country TEXT DEFAULT 'CH',
  phone TEXT,
  email TEXT,
  language TEXT DEFAULT 'de',
  user_id UUID REFERENCES users(id),   -- nullable: owner portal login (future)
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);
CREATE INDEX IF NOT EXISTS idx_owners_org ON owners(organization_id);
CREATE INDEX IF NOT EXISTS idx_owners_org_type ON owners(organization_id, owner_type);
```

**mandates table** (SCHEMA-02 + D3 temporal mandates):
- mandate_type uses text + CHECK (consistent with schema style)
- end_date NULL = ongoing contract
```sql
CREATE TABLE IF NOT EXISTS mandates (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  organization_id UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,
  owner_id UUID NOT NULL REFERENCES owners(id),
  name TEXT NOT NULL,
  mandate_type TEXT NOT NULL DEFAULT 'rental'
    CHECK (mandate_type IN ('rental', 'stwe', 'mixed')),
  start_date DATE NOT NULL,
  end_date DATE,          -- NULL = ongoing
  is_active BOOLEAN DEFAULT true,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);
CREATE INDEX IF NOT EXISTS idx_mandates_org ON mandates(organization_id);
CREATE INDEX IF NOT EXISTS idx_mandates_owner ON mandates(owner_id);
CREATE INDEX IF NOT EXISTS idx_mandates_org_active ON mandates(organization_id, is_active);
```

Add a header comment block at the top:
```sql
-- KEWA v4.0: Multi-Tenant Schema Foundation
-- Migration: 073_org_foundation.sql
-- Creates: organizations, organization_members, owners, mandates
-- Requirements: SCHEMA-01, SCHEMA-02
-- Phase 35: Schema Foundation
```
  </action>
  <verify>
Run: `node -e "const fs=require('fs'); const sql=fs.readFileSync('supabase/migrations/073_org_foundation.sql','utf8'); const checks=['CREATE TABLE IF NOT EXISTS organizations','CREATE TABLE IF NOT EXISTS organization_members','CREATE TABLE IF NOT EXISTS owners','CREATE TABLE IF NOT EXISTS mandates','UNIQUE(organization_id, user_id)','idx_org_members_user_default','owner_type IN','mandate_type IN','country TEXT DEFAULT']; checks.forEach(c=>{ if(!sql.includes(c)) throw new Error('MISSING: '+c); }); console.log('073 OK');"`

Also verify no German column names: `node -e "const sql=require('fs').readFileSync('supabase/migrations/073_org_foundation.sql','utf8'); ['wertquote','eigentumsperiode','erneuerungsfonds'].forEach(g=>{ if(sql.includes(g)) throw new Error('German name found: '+g); }); console.log('No German names');"`
  </verify>
  <done>
073_org_foundation.sql exists with all four tables, all indexes including partial index on is_default, UNIQUE constraint on organization_members, owner_type and mandate_type CHECK constraints using English values, Swiss legal fields on organizations, and zero German column names.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create 074_tenancies.sql — tenancies with Swiss rental law fields</name>
  <files>supabase/migrations/074_tenancies.sql</files>
  <action>
Create `supabase/migrations/074_tenancies.sql` with the tenancies table. This table represents rental agreements (Mietvertraege) and replaces the ad-hoc tenant_name columns that exist on some unit-related tables.

**Column naming: ALL English per D1.** Do NOT use: miete, nebenkosten, kaution, kuendigungsfrist — use the English equivalents defined in D8.

**ownership_period: use two DATE columns** per research recommendation (DATERANGE causes Supabase TypeScript generation issues — documented in RESEARCH.md Pitfall 6). Use `ownership_period_start DATE, ownership_period_end DATE` pattern (this applies to the STWE fields in plan 04, NOT tenancies — note for executor: this reminder is for plan 04, not this file).

**tenancies table** (SCHEMA-03 + D8 Swiss tenancy law):
```sql
-- KEWA v4.0: Multi-Tenant Schema Foundation
-- Migration: 074_tenancies.sql
-- Creates: tenancies (replaces ad-hoc tenant_name on units)
-- Requirements: SCHEMA-03
-- Phase 35: Schema Foundation

CREATE TABLE IF NOT EXISTS tenancies (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  organization_id UUID NOT NULL REFERENCES organizations(id),
  unit_id UUID NOT NULL REFERENCES units(id),
  -- Tenant contact info
  tenant_name TEXT NOT NULL,
  tenant_email TEXT,
  tenant_phone TEXT,
  -- Swiss rental law fields (D8, all nullable for flexibility)
  base_rent DECIMAL(10,2),              -- Nettomiete (OR 257a)
  ancillary_costs DECIMAL(10,2),        -- Nebenkosten-Akonto
  deposit_amount DECIMAL(10,2),         -- Mietkaution (max 3x Monatsmiete per OR 257e)
  notice_period_months INTEGER DEFAULT 3, -- Kuendigungsfrist
  reference_interest_rate DECIMAL(4,3), -- Referenzzinssatz (e.g. 1.750)
  contract_type TEXT DEFAULT 'residential'
    CHECK (contract_type IN ('residential', 'commercial', 'parking', 'storage')),
  -- Temporal fields
  start_date DATE NOT NULL,
  end_date DATE,                        -- NULL = ongoing
  is_active BOOLEAN DEFAULT true,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- Indexes
CREATE INDEX IF NOT EXISTS idx_tenancies_org ON tenancies(organization_id);
CREATE INDEX IF NOT EXISTS idx_tenancies_unit ON tenancies(unit_id);
CREATE INDEX IF NOT EXISTS idx_tenancies_unit_active ON tenancies(unit_id, is_active);
CREATE INDEX IF NOT EXISTS idx_tenancies_org_active ON tenancies(organization_id, is_active);
```
  </action>
  <verify>
Run: `node -e "const sql=require('fs').readFileSync('supabase/migrations/074_tenancies.sql','utf8'); const checks=['CREATE TABLE IF NOT EXISTS tenancies','base_rent','ancillary_costs','deposit_amount','notice_period_months','reference_interest_rate','contract_type','idx_tenancies_unit_active','idx_tenancies_org_active']; checks.forEach(c=>{ if(!sql.includes(c)) throw new Error('MISSING: '+c); }); console.log('074 OK');"`

Verify no German names: `node -e "const sql=require('fs').readFileSync('supabase/migrations/074_tenancies.sql','utf8'); ['miete','nebenkosten','kaution','kuendigungsfrist'].forEach(g=>{ if(sql.toLowerCase().includes(g)) throw new Error('German name: '+g); }); console.log('No German names');"`
  </verify>
  <done>
074_tenancies.sql exists with tenancies table, all 4 indexes (org, unit, unit_active, org_active), all Swiss rental law fields with English names, contract_type CHECK constraint with 4 values, and no German column names.
  </done>
</task>

</tasks>

<verification>
1. Both migration files exist: `supabase/migrations/073_org_foundation.sql` and `supabase/migrations/074_tenancies.sql`
2. File 073 contains all 4 tables: organizations, organization_members, owners, mandates
3. All column names are English (no German terms)
4. Swiss legal fields present on organizations: uid, vat_number, commercial_register, bank_account, country
5. owner_type CHECK: person, company, community, stwe_association
6. mandate_type CHECK: rental, stwe, mixed
7. UNIQUE(organization_id, user_id) on organization_members
8. Partial index on organization_members(user_id, is_default) WHERE is_default = true
9. tenancies has all Swiss law fields with English names
10. All DDL uses IF NOT EXISTS (idempotent)
</verification>

<success_criteria>
- 073_org_foundation.sql: 4 tables, 8 indexes, no German names, all IF NOT EXISTS
- 074_tenancies.sql: 1 table, 4 indexes, Swiss law fields with English names, no German names
- Files are self-contained and deployable in sequence (073 before 074, since 074 references units which already exists)
</success_criteria>

<output>
After completion, create `.planning/phases/035-schema-foundation/35-01-SUMMARY.md`
</output>
