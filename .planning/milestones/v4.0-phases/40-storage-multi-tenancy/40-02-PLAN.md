---
phase: 40-storage-multi-tenancy
plan: 02
type: execute
wave: 2
depends_on:
  - "40-01"
files_modified:
  - src/app/api/photos/route.ts
  - src/app/api/audio/route.ts
  - src/app/api/change-orders/[id]/photos/route.ts
  - src/app/api/knowledge/[id]/attachments/route.ts
  - src/app/api/inspections/[id]/photos/route.ts
  - src/app/api/inspections/[id]/defects/[defectId]/photos/route.ts
autonomous: true
requirements:
  - STOR-01
must_haves:
  truths:
    - "Task photo uploads store files at {orgId}/{taskId}/{photoType}/{uuid}.{ext}"
    - "Task audio uploads store files at {orgId}/{taskId}/{audioType}/{uuid}.{ext}"
    - "Change order photo uploads store files at {orgId}/change_orders/{coId}/photos/{ts}-{name}"
    - "KB attachment uploads store files at {orgId}/kb_articles/{articleId}/attachments/{uuid}.{ext}"
    - "Inspection item photo uploads store files at {orgId}/{inspectionId}/items/{uuid}.webp"
    - "Inspection defect photo uploads store files at {orgId}/{inspectionId}/defects/{uuid}.webp"
  artifacts:
    - path: "src/app/api/photos/route.ts"
      provides: "Org-prefixed task photo uploads"
      contains: "buildStoragePath\\|taskPhotoPath"
    - path: "src/app/api/audio/route.ts"
      provides: "Org-prefixed task audio uploads"
      contains: "buildStoragePath\\|taskAudioPath"
    - path: "src/app/api/change-orders/[id]/photos/route.ts"
      provides: "Org-prefixed change order photo uploads"
      contains: "changeOrderPhotoPath"
    - path: "src/app/api/knowledge/[id]/attachments/route.ts"
      provides: "Org-prefixed KB attachment uploads"
      contains: "kbAttachmentPath"
    - path: "src/app/api/inspections/[id]/photos/route.ts"
      provides: "Org-prefixed inspection item photo uploads"
      contains: "inspectionItemPhotoPath"
    - path: "src/app/api/inspections/[id]/defects/[defectId]/photos/route.ts"
      provides: "Org-prefixed inspection defect photo uploads"
      contains: "inspectionDefectPhotoPath"
  key_links:
    - from: "src/app/api/photos/route.ts"
      to: "src/lib/storage/paths.ts"
      via: "import taskPhotoPath"
      pattern: "import.*from.*storage/paths"
    - from: "src/app/api/inspections/[id]/photos/route.ts"
      to: "src/lib/storage/paths.ts"
      via: "import inspectionItemPhotoPath"
      pattern: "import.*from.*storage/paths"
---

<objective>
Update all internal API route upload sites to use org-prefixed storage paths.

Purpose: These 6 routes use `createOrgClient(request)` and have the org ID available via `x-organization-id` header. Each route's storage path generation must be updated to prepend the org ID as the first path segment, using the typed path builders from `src/lib/storage/paths.ts`.

Output: 6 updated route files with org-prefixed upload paths.
</objective>

<execution_context>
@C:/Users/Mario Giacchino/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Mario Giacchino/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/40-storage-multi-tenancy/40-RESEARCH.md
@.planning/phases/40-storage-multi-tenancy/40-01-SUMMARY.md
@src/lib/storage/paths.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update task photo and audio upload routes</name>
  <files>
    src/app/api/photos/route.ts
    src/app/api/audio/route.ts
  </files>
  <action>
**photos/route.ts:**

1. Add import: `import { taskPhotoPath } from '@/lib/storage/paths'`
2. In POST handler, after getting `userId` and before file upload, read the org ID from the header:
   ```typescript
   const orgId = request.headers.get('x-organization-id')
   if (!orgId) {
     return NextResponse.json({ error: 'Organization context required' }, { status: 401 })
   }
   ```
3. Replace the storagePath line:
   - OLD: `const storagePath = \`${taskId}/${photoType}/${fileId}.${extension}\``
   - NEW: `const storagePath = taskPhotoPath(orgId, taskId, photoType, fileId, extension)`

**audio/route.ts:**

1. Add import: `import { taskAudioPath } from '@/lib/storage/paths'`
2. In POST handler, same orgId extraction pattern as above.
3. Replace the storagePath line:
   - OLD: `const storagePath = \`${taskId}/${audioType}/${fileId}.${extension}\``
   - NEW: `const storagePath = taskAudioPath(orgId, taskId, audioType, fileId, extension)`

Both routes already call `createOrgClient(request)` which sets org context. The `x-organization-id` header is set by middleware on all `/api/*` routes. Reading it is just extracting a value already present.
  </action>
  <verify>Run `npx tsc --noEmit src/app/api/photos/route.ts src/app/api/audio/route.ts` — no type errors.</verify>
  <done>Task photo uploads generate paths like `{orgId}/{taskId}/{photoType}/{uuid}.webp`. Task audio uploads generate paths like `{orgId}/{taskId}/{audioType}/{uuid}.ext`.</done>
</task>

<task type="auto">
  <name>Task 2: Update change order, KB, and inspection upload routes</name>
  <files>
    src/app/api/change-orders/[id]/photos/route.ts
    src/app/api/knowledge/[id]/attachments/route.ts
    src/app/api/inspections/[id]/photos/route.ts
    src/app/api/inspections/[id]/defects/[defectId]/photos/route.ts
  </files>
  <action>
**change-orders/[id]/photos/route.ts:**

1. Add import: `import { changeOrderPhotoPath } from '@/lib/storage/paths'`
2. In POST handler, read orgId from header (same pattern as Task 1).
3. Replace storagePath:
   - OLD: `` const storagePath = `change_orders/${id}/photos/${timestamp}-${filename}` ``
   - NEW: `const storagePath = changeOrderPhotoPath(orgId, id, timestamp, filename)`

**knowledge/[id]/attachments/route.ts:**

1. Add import: `import { kbAttachmentPath } from '@/lib/storage/paths'`
2. In POST handler, read orgId from header.
3. Replace storagePath:
   - OLD: `` const storagePath = `kb_articles/${articleId}/attachments/${fileId}.${ext}` ``
   - NEW: `const storagePath = kbAttachmentPath(orgId, articleId, fileId, ext)`

**inspections/[id]/photos/route.ts:**

1. Add import: `import { inspectionItemPhotoPath } from '@/lib/storage/paths'`
2. In POST handler, read orgId from header.
3. Replace storagePath:
   - OLD: `` const storagePath = `${id}/items/${uuid}.webp` ``
   - NEW: `const storagePath = inspectionItemPhotoPath(orgId, id, uuid)`

**inspections/[id]/defects/[defectId]/photos/route.ts:**

1. Add import: `import { inspectionDefectPhotoPath } from '@/lib/storage/paths'`
2. In POST handler, read orgId from header.
3. Replace storagePath:
   - OLD: `` const storagePath = `${id}/defects/${uuid}.webp` ``
   - NEW: `const storagePath = inspectionDefectPhotoPath(orgId, id, uuid)`

All 4 routes already use `createOrgClient(request)`, so the `x-organization-id` header is guaranteed by middleware.
  </action>
  <verify>Run `npx tsc --noEmit` on all 4 files — no type errors.</verify>
  <done>Change order photos, KB attachments, inspection item photos, and inspection defect photos all use org-prefixed paths via the typed path builders.</done>
</task>

</tasks>

<verification>
1. All 6 route files import from `@/lib/storage/paths`
2. All 6 route files read `x-organization-id` from request headers in POST handlers
3. No route generates a storage path without the org prefix
4. TypeScript compilation succeeds for all modified files
</verification>

<success_criteria>
- All 6 internal upload routes generate org-prefixed storage paths
- Path builder imports from src/lib/storage/paths.ts
- No hardcoded path strings remain in upload logic
</success_criteria>

<output>
After completion, create `.planning/phases/40-storage-multi-tenancy/40-02-SUMMARY.md`
</output>
