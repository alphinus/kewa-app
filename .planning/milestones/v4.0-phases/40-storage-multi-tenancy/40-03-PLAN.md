---
phase: 40-storage-multi-tenancy
plan: 03
type: execute
wave: 2
depends_on:
  - "40-01"
files_modified:
  - src/lib/inspections/signature-utils.ts
  - src/app/api/contractor/[token]/[workOrderId]/upload/route.ts
  - src/lib/storage/contractor-upload.ts
  - src/lib/portal/attachment-upload.ts
  - src/app/api/portal/tickets/[id]/attachments/route.ts
  - src/lib/admin/ticket-to-work-order.ts
autonomous: true
requirements:
  - STOR-01
must_haves:
  truths:
    - "Contractor uploads store files at {orgId}/work_orders/{woId}/... path"
    - "Tenant portal ticket attachments store files at {orgId}/tickets/{ticketId}/... path"
    - "Inspection signatures store files at {orgId}/inspections/{inspectionId}/signature.png"
    - "Ticket-to-work-order file copy uses org-prefixed destination paths"
  artifacts:
    - path: "src/lib/storage/contractor-upload.ts"
      provides: "Org-prefixed path generation for contractor uploads"
      contains: "orgId"
    - path: "src/lib/portal/attachment-upload.ts"
      provides: "Org-prefixed path generation for tenant portal uploads"
      contains: "orgId"
    - path: "src/lib/inspections/signature-utils.ts"
      provides: "Org-prefixed signature upload path"
      contains: "orgId"
    - path: "src/lib/admin/ticket-to-work-order.ts"
      provides: "Org-prefixed destination path for copied attachments"
      contains: "orgId\\|organization_id"
  key_links:
    - from: "src/app/api/contractor/[token]/[workOrderId]/upload/route.ts"
      to: "src/lib/storage/contractor-upload.ts"
      via: "generateStoragePath with orgId"
      pattern: "generateStoragePath"
    - from: "src/lib/portal/attachment-upload.ts"
      to: "src/lib/storage/paths.ts"
      via: "import ticketPhotoPath or buildStoragePath"
      pattern: "import.*from.*storage/paths"
---

<objective>
Update non-standard upload sites (contractor portal, tenant portal, signature utils, ticket-to-WO copy) to use org-prefixed storage paths.

Purpose: These upload sites do NOT use createOrgClient — they use createServiceClient (contractor/portal routes) or createPublicClient (signature utils). The org ID must be obtained differently: from the work_order's organization_id, the ticket's organization_id, or passed as a parameter.

Output: 6 updated files with org-prefixed upload paths.
</objective>

<execution_context>
@C:/Users/Mario Giacchino/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Mario Giacchino/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/40-storage-multi-tenancy/40-RESEARCH.md
@.planning/phases/40-storage-multi-tenancy/40-01-SUMMARY.md
@src/lib/storage/contractor-upload.ts
@src/lib/portal/attachment-upload.ts
@src/lib/inspections/signature-utils.ts
@src/app/api/contractor/[token]/[workOrderId]/upload/route.ts
@src/app/api/portal/tickets/[id]/attachments/route.ts
@src/lib/admin/ticket-to-work-order.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update contractor upload + signature utils</name>
  <files>
    src/lib/storage/contractor-upload.ts
    src/app/api/contractor/[token]/[workOrderId]/upload/route.ts
    src/lib/inspections/signature-utils.ts
  </files>
  <action>
**contractor-upload.ts (generateStoragePath):**

1. Add `orgId: string` as the FIRST parameter to `generateStoragePath()`.
2. Update the StoragePath interface (no change needed, it returns `{bucket, path, filename}`).
3. Prepend `orgId/` to the generated path:
   - OLD: `` `work_orders/${workOrderId}/documents/${filename}` ``
   - NEW: `` `${orgId}/work_orders/${workOrderId}/documents/${filename}` ``
   - OLD: `` `work_orders/${workOrderId}/photos/${context}/${filename}` ``
   - NEW: `` `${orgId}/work_orders/${workOrderId}/photos/${context}/${filename}` ``

**contractor/[token]/[workOrderId]/upload/route.ts:**

1. The route already fetches the work order: `const { data: workOrder } = await supabase.from('work_orders').select(...)`. Add `organization_id` to the select fields:
   ```typescript
   .select(`id, status, organization_id, partner:partners!inner(email)`)
   ```
2. Extract orgId: `const orgId = (workOrder as any).organization_id as string`
3. Pass orgId to generateStoragePath:
   - OLD: `generateStoragePath(workOrderId, mediaType, context, file.type)`
   - NEW: `generateStoragePath(orgId, workOrderId, mediaType, context, file.type)`

This route uses `createServiceClient()` which bypasses RLS, so the org-prefix is for path consistency, not enforcement.

**signature-utils.ts (uploadSignature):**

1. Add `orgId: string` as the FIRST parameter to `uploadSignature()`.
2. Import `inspectionSignaturePath` from `@/lib/storage/paths`.
3. Replace the storagePath:
   - OLD: `` const storagePath = `inspections/${inspectionId}/signature.png` ``
   - NEW: `const storagePath = inspectionSignaturePath(orgId, inspectionId)`
4. Update `getSignatureUrl` — this function takes a `storagePath` string that is already stored in the DB, so it needs no change (it just creates a signed URL from whatever path is stored).

**Callers of uploadSignature:**
Find all callers with `grep -r "uploadSignature" src/` and update them to pass `orgId` as the first argument. The callers are in API routes that have access to the org ID from the `x-organization-id` header. If the caller is a route handler, read orgId from request headers. If the caller is a lib function, add orgId to its parameters.
  </action>
  <verify>Run `npx tsc --noEmit src/lib/storage/contractor-upload.ts src/app/api/contractor/*/[workOrderId]/upload/route.ts src/lib/inspections/signature-utils.ts` — no type errors. Grep for `uploadSignature(` to confirm all callers pass orgId.</verify>
  <done>Contractor uploads include org prefix from work_order.organization_id. Signature uploads include org prefix. All callers of modified functions updated.</done>
</task>

<task type="auto">
  <name>Task 2: Update portal attachment upload + ticket-to-WO copy</name>
  <files>
    src/lib/portal/attachment-upload.ts
    src/app/api/portal/tickets/[id]/attachments/route.ts
    src/lib/admin/ticket-to-work-order.ts
  </files>
  <action>
**portal/attachment-upload.ts (uploadTicketAttachment):**

1. Add `orgId: string` as the FIRST parameter to `uploadTicketAttachment()`.
2. Import `ticketPhotoPath, ticketMessageAttachmentPath` from `@/lib/storage/paths`.
3. Replace path generation:
   - OLD: `` `tickets/${ticketId}/messages/${messageId}/${fileName}` `` and `` `tickets/${ticketId}/photos/${fileName}` ``
   - NEW: Use `ticketMessageAttachmentPath(orgId, ticketId, messageId, uuid, ext)` and `ticketPhotoPath(orgId, ticketId, uuid, ext)` where uuid and ext are derived from the existing `fileName` variable (split on `.`). Alternatively, keep the uuid+ext variables from the current code and just prepend: `buildStoragePath(orgId, 'tickets', ticketId, messageId ? \`messages/${messageId}/${fileName}\` : \`photos/${fileName}\`)`.

   Simplest approach: import `buildStoragePath` from `@/lib/storage/paths` and prepend orgId:
   ```typescript
   const path = messageId
     ? buildStoragePath(orgId, 'tickets', ticketId, 'messages', messageId, fileName)
     : buildStoragePath(orgId, 'tickets', ticketId, 'photos', fileName)
   ```

**portal/tickets/[id]/attachments/route.ts:**

1. This route calls `uploadTicketAttachment(file, ticketId, messageId)`. It needs to pass orgId.
2. The route uses `createServiceClient()` to count existing attachments. To get orgId, query the ticket's organization_id:
   ```typescript
   const supabase = createServiceClient()
   const { data: ticket } = await supabase
     .from('tickets')
     .select('organization_id')
     .eq('id', ticketId)
     .single()
   const orgId = ticket?.organization_id
   if (!orgId) {
     return NextResponse.json({ error: 'Ticket not found' }, { status: 404 })
   }
   ```
3. Pass orgId to uploadTicketAttachment: `uploadTicketAttachment(file, orgId, ticketId, messageId)`

**admin/ticket-to-work-order.ts:**

1. In `convertTicketToWorkOrder`, the file copy destination path needs org prefix.
2. The function already fetches the ticket. After creating the work order, the work order inherits the org context from the `createPublicClient` session. For the storage copy (done via `createServiceClient`), the org ID should come from the ticket's or work order's organization_id.
3. Add org ID lookup: After creating the work order, add:
   ```typescript
   const { data: woData } = await supabase
     .from('work_orders')
     .select('organization_id')
     .eq('id', workOrder.id)
     .single()
   const orgId = woData?.organization_id || ''
   ```
   Or simpler: the ticket already has organization_id from the `tickets` select. Add `organization_id` to the ticket select fields and use `ticket.organization_id`.
4. Update destPath:
   - OLD: `` `work_order/${workOrder.id}/${attachment.file_name}` ``
   - NEW: `` `${orgId}/work_orders/${workOrder.id}/${attachment.file_name}` ``

   Note the old path used `work_order` (singular) — the new path uses `work_orders` (plural) to match the convention. This is fine because we're creating a new copy, not referencing an existing path.
  </action>
  <verify>Run `npx tsc --noEmit src/lib/portal/attachment-upload.ts src/app/api/portal/tickets/*/attachments/route.ts src/lib/admin/ticket-to-work-order.ts` — no type errors.</verify>
  <done>Portal ticket attachments include org prefix from ticket.organization_id. Ticket-to-work-order copy uses org-prefixed destination path. All external/special upload sites produce org-prefixed storage paths.</done>
</task>

</tasks>

<verification>
1. All 6 files import from `@/lib/storage/paths` or use org-prefixed path generation
2. `generateStoragePath` in contractor-upload.ts accepts orgId as first parameter
3. `uploadTicketAttachment` in attachment-upload.ts accepts orgId as first parameter
4. `uploadSignature` in signature-utils.ts accepts orgId as first parameter
5. All callers of modified functions updated to pass orgId
6. TypeScript compilation succeeds for all modified files
</verification>

<success_criteria>
- Contractor uploads, portal uploads, signature uploads, and ticket-to-WO copies all use org-prefixed paths
- Org ID sourced from work_order.organization_id or ticket.organization_id (not from headers, since these routes use service clients)
- No upload site generates a path without org prefix
</success_criteria>

<output>
After completion, create `.planning/phases/40-storage-multi-tenancy/40-03-SUMMARY.md`
</output>
