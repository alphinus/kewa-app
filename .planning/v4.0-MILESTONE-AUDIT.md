---
milestone: v4.0
audited: 2026-02-18
status: tech_debt
scores:
  requirements: 26/26
  phases: 7/7
  integration: 26/26
  flows: 5/5
gaps:
  requirements: []
  integration: []
  flows: []
tech_debt:
  - phase: 37-rls-context-wiring
    items:
      - "34 API routes retain ALLOWED_ROLES: ['kewa','imeri'] + x-user-role pattern (not migrated to isInternalRole). Currently works via role='kewa' placeholder. Will break when legacy users.role column is dropped."
      - "visible_to_imeri business logic in tasks/projects/photos/audio routes uses x-user-role === 'imeri'. Pre-existing pattern, not v4.0 regression."
      - "Legacy users.role column not dropped — deferred to future auth milestone. All new users receive role='kewa' as placeholder."
  - phase: 39-navigation-redesign
    items:
      - "liegenschaft/[id] redirect stub treats URL param as building ID but old route used property IDs. Silent fallback to /dashboard/objekte."
  - phase: 36-data-migration
    items:
      - "Runtime database verification deferred — Docker Desktop unavailable during execution; supabase db reset not run against full migration chain (073-084)."
  - phase: 40-storage-multi-tenancy
    items:
      - "migrate_storage_paths.ts must be run manually before 084_storage_rls.sql — deployment-order dependency."
human_verification:
  - "Deploy migration chain (073-084) to staging Supabase and verify clean apply"
  - "Run supabase db reset and validate seed row counts"
  - "Log in as KEWA AG user, verify dashboard loads with org-scoped data"
  - "Test cross-tenant isolation between KEWA AG and Imeri Immobilien AG"
  - "Switch organization as multi-org user, verify cookie cascade clears"
  - "Navigate /objekte drill-down end-to-end with live data"
  - "Upload a file and verify org-prefixed storage path"
  - "Complete inspection signature and verify storage RLS passes"
  - "Log in as hauswart, verify CombinedSelector loads without 403"
---

# v4.0 Multi-Tenant Data Model & Navigation — Milestone Audit

**Milestone Goal:** Branchenstandard-Datenmodell mit mandantenfaehiger Architektur (Organization > Mandat > Eigentuemer > Liegenschaft > Gebaeude > Einheit), Supabase RLS fuer Mandanten-Isolation, und Navigation-Redesign mit hierarchischem Drill-down.

**Audited:** 2026-02-18
**Status:** tech_debt (all requirements met, no critical blockers, accumulated tech debt for review)
**Scores:** 26/26 requirements | 7/7 phases | 26/26 integrations | 5/5 flows
**Plans:** 24/24 executed

## Requirements Coverage (3-Source Cross-Reference)

| REQ-ID | Phase | VERIFICATION | SUMMARY | Final Status |
|--------|-------|-------------|---------|--------------|
| SCHEMA-01 | 35 | SATISFIED | 35-01 | satisfied |
| SCHEMA-02 | 35 | SATISFIED | 35-01 | satisfied |
| SCHEMA-03 | 35 | SATISFIED | 35-01 | satisfied |
| SCHEMA-04 | 35 | SATISFIED | 35-02 | satisfied |
| SCHEMA-05 | 35 | SATISFIED | 35-03 | satisfied |
| SCHEMA-06 | 35 | SATISFIED | 35-04 | satisfied |
| SCHEMA-07 | 35 | SATISFIED | 35-03 | satisfied |
| MIGR-01 | 36 | SATISFIED | 36-01 | satisfied |
| MIGR-02 | 36 | SATISFIED | 36-02 | satisfied |
| MIGR-03 | 36 | SATISFIED | 36-03 | satisfied |
| RLS-01 | 37 | SATISFIED | 37-01 | satisfied |
| RLS-02 | 37 | SATISFIED | 37-02 | satisfied |
| RLS-03 | 37 | SATISFIED | 37-02 | satisfied |
| RLS-04 | 37 | SATISFIED | 37-03, 37-04 | satisfied |
| RLS-05 | 37 | SATISFIED | 37-01 | satisfied |
| CTX-01 | 38 | SATISFIED | 38-01, 38-03 | satisfied |
| CTX-02 | 38 | SATISFIED | 38-01, 38-03 | satisfied |
| CTX-03 | 38 | SATISFIED | 38-03 | satisfied |
| CTX-04 | 38 | SATISFIED | 38-01, 38-03 | satisfied |
| NAV-01 | 39 | SATISFIED | 39-05 | satisfied |
| NAV-02 | 39 | SATISFIED | 39-01 | satisfied |
| NAV-03 | 39+41 | SATISFIED | 39-02, 41-01 | satisfied |
| NAV-04 | 39 | SATISFIED | 39-04 | satisfied |
| STOR-01 | 40 | SATISFIED | 40-02, 40-03 | satisfied |
| STOR-02 | 40+41 | SATISFIED | 40-01, 41-01 | satisfied |
| STOR-03 | 40 | SATISFIED | 40-04 | satisfied |

**Orphaned requirements:** None. All 26 REQ-IDs are claimed, verified, and listed in summaries.

## Phase Verification Summary

| Phase | Score | Status | Key Caveat |
|-------|-------|--------|------------|
| 35 Schema Foundation | 13/13 | passed | PgBouncer scope validation deferred |
| 36 Data Migration | 9/9 | passed | Runtime DB verification deferred (Docker unavailable) |
| 37 RLS & Context Wiring | 12/12 | passed | cached-queries regression fixed in Phase 41 |
| 38 App Context & Switcher | 12/12 | passed | None |
| 39 Navigation Redesign | 4/4 | passed | Re-verified after 39-05 gap closure |
| 40 Storage Multi-Tenancy | 11/11 | passed | Re-verified after gap closure (MessageInput + signature) |
| 41 Bug Fixes & Cleanup | 5/5 | passed | Closed INT-01, INT-02, cached-queries regression |

All 7 phases passed verification. No unverified phases.

## Cross-Phase Integration

**Connected:** 28 key exports properly wired across phases
**Orphaned:** 0 exports created but unused
**E2E Flows:** 5/5 complete

### E2E Flow Results

| # | Flow | Status |
|---|------|--------|
| 1 | Login → org resolution → middleware header → API → RLS → data | Complete |
| 2 | Org switch → cookie clear → reload → new context → new data | Complete |
| 3 | File upload → org-prefixed path → storage RLS → accessible | Complete |
| 4 | Objekte drill-down → property → building → unit → room | Complete |
| 5 | Hauswart login → CombinedSelector loads → properties/buildings accessible | Complete |

### Previous Integration Bugs (Closed by Phase 41)

| ID | Issue | Fix | Status |
|----|-------|-----|--------|
| INT-01 | signature-utils.ts used createPublicClient — storage RLS INSERT failed | Injected SupabaseClient from route via createOrgClient(req) | RESOLVED |
| INT-02 | hauswart 403 on /api/properties and /api/buildings | Replaced ALLOWED_ROLES with isInternalRole(x-user-role-name) | RESOLVED |
| INT-03 | cached-queries.ts used createPublicClient — empty results in server components | Added createOrgScopedClient(orgId) with set_org_context RPC | RESOLVED |

## Tech Debt

### Phase 37 — RLS & Context Wiring (3 items)

1. **34 API routes retain ALLOWED_ROLES pattern** — Use `ALLOWED_ROLES: ['kewa','imeri']` + `x-user-role` header. Works today because hauswart users carry legacy `role='kewa'` placeholder. Will break when legacy `users.role` column is dropped. Affected routes: inspections, suppliers, purchase-orders, expenses, partners, units, rooms, buildings/[id], change-orders, knowledge, templates, renovation-projects, and others.

2. **visible_to_imeri business logic** — 4 routes (photos, audio, tasks, projects) use `x-user-role === 'imeri'` for visibility filtering. Pre-existing business logic tied to legacy column value.

3. **Legacy users.role column not dropped** — NOT NULL with CHECK ('kewa','imeri'). Deferred to future auth milestone. All new users receive 'kewa' as placeholder per D8.

### Phase 39 — Navigation Redesign (1 item)

4. **liegenschaft/[id] redirect ID mismatch** — Redirect stub treats param as building ID; old route used property IDs. Silent fallback to `/dashboard/objekte` if ID type mismatches.

### Phase 36 — Data Migration (1 item)

5. **Runtime DB verification deferred** — Docker Desktop unavailable during plan execution. All SQL verified statically. `supabase db reset` must be run to confirm full migration chain.

### Phase 40 — Storage Multi-Tenancy (1 item)

6. **Manual storage migration** — `migrate_storage_paths.ts` must be run before 084 storage RLS is applied, or pre-existing files at non-prefixed paths become inaccessible.

### Total: 6 items across 4 phases

None are blockers. Items 1-3 are deferred to a future auth milestone. Items 4-6 are operational tasks.

## Milestone Definition of Done

| Target Feature (from PROJECT.md) | Status |
|----------------------------------|--------|
| Mandantenfaehiges Datenmodell: Organizations, Owners, Mandates, Tenancies | Done (P35+P36) |
| Saubere Property→Building-Hierarchie mit konsistenter Terminologie | Done (P35+P39) |
| Supabase RLS fuer Mandanten-Isolation | Done (P37, 248 policies on 62 tables) |
| STWE-Vorbereitung (Wertquote, Eigentumsperiode als Felder) | Done (P35, schema only, UI deferred) |
| Navigation-Redesign: Footer vereinfacht, klares Drill-down | Done (P39, 5-item footer + /objekte) |
| Terminologie-Bereinigung im gesamten Code | Done (P39 routes) |
| KEWA AG als Seed-Mandant migriert | Done (P36, backfilled, NOT NULL) |

All 7 target features delivered.

---

*Audited: 2026-02-18*
*Auditor: Claude (gsd audit-milestone workflow)*
*Previous audit: 2026-02-18 (pre-Phase 41) — INT-01, INT-02 identified, now resolved*
